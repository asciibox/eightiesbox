/*BassoonTracker v0.3.8 by Steffest - build 2020-10-10 - Full source on https://github.com/steffest/BassoonTracker */
var BassoonTracker2=function(){function D(e){if(window.location.getParameter)return window.location.getParameter(e);if(location.search)for(var t=location.search.substring(1).split("&"),n=0;n<t.length;n++){var i=t[n].split("=");if(i[0]&&i[0]==e)return i[1]||!0}}function a(e){var t="k";return isNaN(e)&&(e=0),1e3<(e=Math.round(e/1e3))&&(e=Math.round(e/100)/10,t="MB"),e+t}function F(e,t){function o(e){(e=0===e?e:e||a.index)<0&&(e=0),a.length<=e&&(e=a.length-1),a.index=e}var a={index:0,litteEndian:!t,goto:function(e){o(e)},jump:function(e){this.goto(this.index+e)},readByte:function(e){o(e);var t=this.dataView.getInt8(this.index);return this.index++,t},writeByte:function(e,t){o(t),this.dataView.setInt8(this.index,e),this.index++},readUbyte:function(e){o(e);var t=this.dataView.getUint8(this.index);return this.index++,t},writeUByte:function(e,t){o(t),this.dataView.setUint8(this.index,e),this.index++},readUint:function(e){o(e);var t=this.dataView.getUint32(this.index,this.litteEndian);return this.index+=4,t},writeUint:function(e,t){o(t),this.dataView.setUint32(this.index,e,this.litteEndian),this.index+=4},readBytes:function(e,t){o(t);var n=new Uint8Array(e),i=this.index;(e+=i)>this.length&&(e=this.length);for(var r=0;i<e;++i)n.setUint8(r++,this.dataView.getUint8(i));return this.index=e,n},readString:function(e,t){o(t);var n=this.index,i=this.dataView,r="";for((e+=n)>this.length&&(e=this.length);n<e;++n){var a=i.getUint8(n);if(0==a)break;r+=String.fromCharCode(a)}return this.index=e,r},writeString:function(e,t){o(t);for(var n=this.dataView,i=e.length,r=0;r<i;r++)n.setUint8(this.index+r,e.charCodeAt(r));this.index+=i},writeStringSection:function(e,t,n,i){o(i),n=n||0;var r=(e=e||"").length;(t=t||1)<r&&(e=e.substr(0,t)),a.writeString(e),a.fill(n,t-r)},readWord:function(e){o(e);var t=this.dataView.getUint16(this.index,this.litteEndian);return this.index+=2,t},writeWord:function(e,t){o(t),this.dataView.setUint16(this.index,e,this.litteEndian),this.index+=2}};return a.readLong=a.readDWord=a.readUint,a.writeLong=a.writeDWord=a.writeUint,a.readShort=function(e,t){o(t);var n=this.dataView.getInt16(this.index,this.litteEndian);return this.index+=2,n},a.clear=function(e){a.fill(0,e)},a.fill=function(e,t){e=e||0,t=t||0;for(var n=0;n<t;n++)a.writeByte(e)},a.isEOF=function(e){return this.length-(e=e||0)<=this.index},e&&(a.buffer=e,a.dataView=new DataView(e),a.length=e.byteLength),a}function o(t,e){function n(){var e={};return e.name=t.readString(4),e.size=t.readDWord(),e}t.litteEndian=!1,t.goto(12);for(var i=n();"BODY"!=i.name&&!t.isEOF(10);)"NAME"==i.name?e.name=t.readString(i.size):t.jump(i.size),i=n();if("BODY"==i.name)for(var r=0;r<i.size;r++){var a=t.readByte();e.data.push(a/127)}}function s(e,t,n){Wt.context.decodeAudioData(e.buffer,function(e){e?(t.data=e.getChannelData(0),t.length=e.length,n&&n()):alert("error decoding file data: "+url)},function(e){n&&n()})}function l(e,t){e.goto(0);for(var n=0;n<t.length;n++){var i=e.readByte();t.data.push(i/127)}}function d(e,t,n){e.litteEndian=!0,e.goto(4);var i={};i.chunkSize=e.readDWord(),i.format=e.readString(4),i.subChunk=e.readString(4),i.subChuckSize=e.readDWord();var r=e.index+i.subChuckSize;if(i.audioFormat=e.readWord(),i.numberOfChannels=e.readWord(),i.sampleRate=e.readDWord(),i.byteRate=e.readDWord(),i.blockalign=e.readWord(),i.bits=e.readWord(),e.goto(r),i.dataChunk=e.readString(4),i.dataChuckSize=e.readDWord(),8===i.bits){t.length=i.dataChuckSize;for(var a=0;a<t.length;a++){var o=e.readUbyte();t.data.push((o-=128)/128)}}else s(e,t,n)}var c,le={images:{},audio:{},json:{},arrayBuffer:{}},de=void 0,I=1,M=2,G=1,L=2,ce=3,Y=4,q=5,v=6,b=7,K=8,Z=9,J=10,Q=12,z=13,U=14,A=15,$=16,ee=17,u=18,x=19,k=20,E=21,T=22,f=23,ue=24,w=25,fe=26,B=27,he=28,te=29,O=30,h=31,P=32,y=33,m=34,N=35,H=36,W=37,g=40,S=41,_=42,ge=43,R=44,V=45,X=46,C=50,ne=51,pe=52,ie=53,p=1,re=2,ae=3,oe=4,se=5,me=6,ve=7,be=8,we=9,xe=10,ke=11,Pe=12,ye=13,Se=14,_e=15,Ce=16,Te=17,Ie=18,Me=19,Ae=20,Ee=21,De=22,Fe=23,Le=24,Be=25,We=1,Re=2,Ue=1,Ve=2,ze=1,Oe=2,Ne={RAW_8BIT:1,WAVE_PCM:2,IFF_8SVX:3,MP3:4,RIFF_8BIT:5,RIFF_16BIT:6},He=1,Xe=2,Ge=3,je=1,Ye=2,qe=1,Ke=2,Ze=3,Je=4,Qe=5,$e=6,r=1,et=2,tt=3,nt={C1:{period:856,name:"C-1",tune:[907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814]},Cs1:{period:808,name:"C#1",tune:[856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768]},D1:{period:762,name:"D-1",tune:[808,802,796,791,785,779,774,768,762,757,752,746,741,736,730,725]},Ds1:{period:720,name:"D#1",tune:[762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684]},E1:{period:678,name:"E-1",tune:[720,715,709,704,699,694,689,684,678,674,670,665,660,655,651,646]},F1:{period:640,name:"F-1",tune:[678,675,670,665,660,655,651,646,640,637,632,628,623,619,614,610]},Fs1:{period:604,name:"F#1",tune:[640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575]},G1:{period:570,name:"G-1",tune:[604,601,597,592,588,584,580,575,570,567,563,559,555,551,547,543]},Gs1:{period:538,name:"G#1",tune:[570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513]},A1:{period:508,name:"A-1",tune:[538,535,532,528,524,520,516,513,508,505,502,498,495,491,487,484]},As1:{period:480,name:"A#1",tune:[508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457]},B1:{period:453,name:"B-1",tune:[480,477,474,470,467,463,460,457,453,450,447,444,441,437,434,431]},C2:{period:428,name:"C-2",tune:[453,450,447,444,441,437,434,431,428,425,422,419,416,413,410,407]},Cs2:{period:404,name:"C#2",tune:[428,425,422,419,416,413,410,407,404,401,398,395,392,390,387,384]},D2:{period:381,name:"D-2",tune:[404,401,398,395,392,390,387,384,381,379,376,373,370,368,365,363]},Ds2:{period:360,name:"D#2",tune:[381,379,376,373,370,368,365,363,360,357,355,352,350,347,345,342]},E2:{period:339,name:"E-2",tune:[360,357,355,352,350,347,345,342,339,337,335,332,330,328,325,323]},F2:{period:320,name:"F-2",tune:[339,337,335,332,330,328,325,323,320,318,316,314,312,309,307,305]},Fs2:{period:302,name:"F#2",tune:[320,318,316,314,312,309,307,305,302,300,298,296,294,292,290,288]},G2:{period:285,name:"G-2",tune:[302,300,298,296,294,292,290,288,285,284,282,280,278,276,274,272]},Gs2:{period:269,name:"G#2",tune:[285,284,282,280,278,276,274,272,269,268,266,264,262,260,258,256]},A2:{period:254,name:"A-2",tune:[269,268,266,264,262,260,258,256,254,253,251,249,247,245,244,242]},As2:{period:240,name:"A#2",tune:[254,253,251,249,247,245,244,242,240,239,237,235,233,232,230,228]},B2:{period:226,name:"B-2",tune:[240,238,237,235,233,232,230,228,226,225,224,222,220,219,217,216]},C3:{period:214,name:"C-3",tune:[226,225,223,222,220,219,217,216,214,213,211,209,208,206,205,204]},Cs3:{period:202,name:"C#3",tune:[214,212,211,209,208,206,205,203,202,201,199,198,196,195,193,192]},D3:{period:190,name:"D-3",tune:[202,200,199,198,196,195,193,192,190,189,188,187,185,184,183,181]},Ds3:{period:180,name:"D#3",tune:[190,189,188,187,185,184,183,181,180,179,177,176,175,174,172,171]},E3:{period:170,name:"E-3",tune:[180,179,177,176,175,174,172,171,170,169,167,166,165,164,163,161]},F3:{period:160,name:"F-3",tune:[170,169,167,166,165,164,163,161,160,159,158,157,156,155,154,152]},Fs3:{period:151,name:"F#3",tune:[160,159,158,157,156,155,154,152,151,150,149,148,147,146,145,144]},G3:{period:143,name:"G-3",tune:[151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136]},Gs3:{period:135,name:"G#3",tune:[143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128]},A3:{period:127,name:"A-3",tune:[135,134,133,132,131,130,129,128,127,126,125,125,124,123,122,121]},As3:{period:120,name:"A#3",tune:[127,126,125,125,123,123,122,121,120,119,118,118,117,116,115,114]},B3:{period:113,name:"B-3",tune:[120,119,118,118,117,116,115,114,113,113,112,111,110,109,109,108]}},it={None:{name:"---"},C0:{name:"C-0",period:6848},Cs0:{name:"C#0",period:6464},D0:{name:"D-0",period:6096},Ds0:{name:"D#0",period:5760},E0:{name:"E-0",period:5424},F0:{name:"F-0",period:5120},Fs0:{name:"F#0",period:4832},G0:{name:"G-0",period:4560},Gs0:{name:"G#0",period:4304},A0:{name:"A-0",period:4064},As0:{name:"A#0",period:3840},B0:{name:"B-0",period:3624},C1:{name:"C-1",period:3424},Cs1:{name:"C#1",period:3232},D1:{name:"D-1",period:3048},Ds1:{name:"D#1",period:2880},E1:{name:"E-1",period:2712},F1:{name:"F-1",period:2560},Fs1:{name:"F#1",period:2416},G1:{name:"G-1",period:2280},Gs1:{name:"G#1",period:2152},A1:{name:"A-1",period:2032},As1:{name:"A#1",period:1920},B1:{name:"B-1",period:1812},C2:{name:"C-2",period:1712},Cs2:{name:"C#2",period:1616},D2:{name:"D-2",period:1524},Ds2:{name:"D#2",period:1440},E2:{name:"E-2",period:1356},F2:{name:"F-2",period:1280},Fs2:{name:"F#2",period:1208},G2:{name:"G-2",period:1140},Gs2:{name:"G#2",period:1076},A2:{name:"A-2",period:1016},As2:{name:"A#2",period:960},B2:{name:"B-2",period:906},C3:{name:"C-3",period:856},Cs3:{name:"C#3",period:808},D3:{name:"D-3",period:762},Ds3:{name:"D#3",period:720},E3:{name:"E-3",period:678},F3:{name:"F-3",period:640},Fs3:{name:"F#3",period:604},G3:{name:"G-3",period:570},Gs3:{name:"G#3",period:538},A3:{name:"A-3",period:508},As3:{name:"A#3",period:480},B3:{name:"B-3",period:453},C4:{name:"C-4",period:428},Cs4:{name:"C#4",period:404},D4:{name:"D-4",period:381},Ds4:{name:"D#4",period:360},E4:{name:"E-4",period:339},F4:{name:"F-4",period:320},Fs4:{name:"F#4",period:302},G4:{name:"G-4",period:285},Gs4:{name:"G#4",period:269},A4:{name:"A-4",period:254},As4:{name:"A#4",period:240},B4:{name:"B-4",period:226.5,modPeriod:226},C5:{name:"C-5",period:214},Cs5:{name:"C#5",period:202},D5:{name:"D-5",period:190.5,modPeriod:190},Ds5:{name:"D#5",period:180},E5:{name:"E-5",period:169.5,modPeriod:170},F5:{name:"F-5",period:160},Fs5:{name:"F#5",period:151},G5:{name:"G-5",period:142.5,modPeriod:143},Gs5:{name:"G#5",period:134.5,modPeriod:135},A5:{name:"A-5",period:127},As5:{name:"A#5",period:120},B5:{name:"B-5",period:113.25,modPeriod:113},C6:{name:"C-6",period:107},Cs6:{name:"C#6",period:101},D6:{name:"D-6",period:95.25,modPeriod:95},Ds6:{name:"D#6",period:90},E6:{name:"E-6",period:84.75,modPeriod:85},F6:{name:"F-6",period:80},Fs6:{name:"F#6",period:75.5,modPeriod:75},G6:{name:"G-6",period:71.25,modPeriod:71},Gs6:{name:"G#6",period:67.25,modPeriod:67},A6:{name:"A-6",period:63.5,modPeriod:63},As6:{name:"A#6",period:60},B6:{name:"B-6",period:56.625,modPeriod:56},C7:{name:"C-7",period:53.5,modPeriod:53},Cs7:{name:"C#7",period:50.5,modPeriod:50},D7:{name:"D-7",period:47.625,modPeriod:47},Ds7:{name:"D#7",period:45},E7:{name:"E-7",period:42.375,modPeriod:42},F7:{name:"F-7",period:40},Fs7:{name:"F#7",period:37.75,modPeriod:37},G7:{name:"G-7",period:35.625,modPeriod:35},Gs7:{name:"G#7",period:33.625,modPeriod:33},A7:{name:"A-7",period:31.75,modPeriod:31},As7:{name:"A#7",period:30},B7:{name:"B-7",period:28.3125,modPeriod:28},C8:{name:"C-8",period:26.75},Cs8:{name:"C#8",period:25.25},D8:{name:"D-8",period:23.8125},Ds8:{name:"D#8",period:22.5},E8:{name:"E-8",period:21.1875},F8:{name:"F-8",period:20},Fs8:{name:"F#8",period:18.875},G8:{name:"G-8",period:17.8125},Gs8:{name:"G#8",period:16.8125},A8:{name:"A-8",period:15.875},As8:{name:"A#8",period:15},B8:{name:"B-8",period:14.15625},C9:{name:"C-9",period:13.375},Cs9:{name:"C#9",period:12.625},D9:{name:"D-9",period:11.90625},Ds9:{name:"D#9",period:11.25},E9:{name:"E-9",period:10.59375},F9:{name:"F-9",period:10},Fs9:{name:"F#9",period:9.4375},G9:{name:"G-9",period:8.90625},Gs9:{name:"G#9",period:8.40625},A9:{name:"A-9",period:7.9375},As9:{name:"A#9",period:7.5},B9:{name:"B-9",period:7.078125},C10:{name:"C-10",period:6.6875},Cs10:{name:"C#10",period:6.3125},D10:{name:"D-10",period:5.953125},Ds10:{name:"D#10",period:5.625},E10:{name:"E-10",period:5.296875},F10:{name:"F-10",period:5},Fs10:{name:"F#10",period:4.71875},G10:{name:"G-10",period:4.453125},Gs10:{name:"G#10",period:4.203125},A10:{name:"A-10",period:3.96875},As10:{name:"A#10",period:3.75},B10:{name:"B-10",period:3.5390625},C11:{name:"C-11",period:3.34375},Cs11:{name:"C#11",period:3.15625},D11:{name:"D-11",period:2.9765625},Ds11:{name:"D#11",period:2.8125},E11:{name:"E-11",period:2.6484375},F11:{name:"F-11",period:2.5},Fs11:{name:"F#11",period:2.359375},G11:{name:"G-11",period:2.2265625},Gs11:{name:"G#11",period:2.1015625},A11:{name:"A-11",period:1.984375},As11:{name:"A#11",period:1.875},B11:{name:"B-11",period:1.76953125},OFF:{name:"OFF",period:0}},rt=145,e=0,t=1,n=2,at=3,ot=4,st=5,lt=6,dt=7,ct=8,ut=9,ft=10,ht=11,gt=12,pt=13,mt=14,vt=15,bt=16,wt=17,xt=18,kt=19,Pt=20,yt=21,St=22,_t=23,Ct=24,Tt=25,It=26,Mt=27,At={0:{name:"OFF"},1:{name:"C"},2:{name:"Cs"},3:{name:"D"},4:{name:"Ds"},5:{name:"E"},6:{name:"F"},7:{name:"Fs"},8:{name:"G"},9:{name:"Gs"},10:{name:"A"},11:{name:"As"},12:{name:"B"}},Et={azerty:{a:pt,z:vt,e:wt,r:xt,t:Pt,y:St,u:Ct,i:Tt,o:Mt,"é":mt,'"':bt,"(":kt,"§":yt,"è":_t,"ç":It,w:t,x:at,c:st,v:lt,b:ct,n:ft,",":gt,";":pt,":":vt,s:n,d:ot,g:dt,h:ut,j:ht,"<":e},dvorak:{"'":pt,",":vt,".":wt,p:xt,y:Pt,f:St,g:Ct,c:Tt,r:Mt,2:mt,3:bt,5:kt,6:yt,7:_t,9:It,";":t,q:at,j:st,k:lt,x:ct,b:ft,m:gt,w:pt,v:vt,o:n,e:ot,i:dt,d:ut,h:ht,n:mt,"\\":e},qwerty:{q:pt,w:vt,e:wt,r:xt,t:Pt,y:St,u:Ct,i:Tt,o:Mt,2:mt,3:bt,5:kt,6:yt,7:_t,9:It,z:t,x:at,c:st,v:lt,b:ct,n:ft,m:gt,",":pt,".":vt,s:n,d:ot,g:dt,h:ut,j:ht,"\\":e},qwertz:{q:pt,w:vt,e:wt,r:xt,t:Pt,z:St,u:Ct,i:Tt,o:Mt,2:mt,3:bt,5:kt,6:yt,7:_t,9:It,y:t,x:at,c:st,v:lt,b:ct,n:ft,m:gt,",":pt,".":vt,s:n,d:ot,g:dt,h:ut,j:ht,"\\":e}},Dt=1,Ft=2,Lt={unrollLoops:!1,unrollShortLoops:!1,sustainKeyboardNotes:!1,useHover:!0,keyboardTable:"qwerty",vubars:!0,stereoSeparation:Xe,emulateProtracker1OffsetBug:!0,loadInitialFile:!0},Bt=(c={},{on:function(e,t){var n=c[e];n||(c[e]=n=[]),n.push(t)},trigger:function(e,t){var n=c[e];if(n){var i,r=n.length;for(i=0;i<r;i++)n[i](t,e)}}}),Wt=function(){function i(e){(t=e.createGain()).gain.setValueAtTime(1,0);t.connect(e.destination),(a=e.createGain()).connect(t),M.setMasterVolume(1),(r=e.createBiquadFilter()).type="lowpass",r.frequency.setValueAtTime(2e4,0),r.connect(a),M.masterVolume=a,M.cutOffVolume=t,M.lowPassfilter=r}var T,a,t,r,I,M={};window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var n,o,A,E,D,F=[],s=[],l=Xe,d=0,L=[[],[],[]],B=0,W=4143.569,c={volume:!0,panning:!0,high:!0,mid:!0,low:!0,lowPass:!0,reverb:!0,distortion:!1},R=!1;return AudioContext&&(T=new AudioContext),M.init=function(e){function t(){var e=FilterChain(c);e.output().connect(r),F.push(e)}if(e=e||T){E=!!Wt.context.createStereoPanner,D=void 0!==Jt,i(e);var n=mn.getTrackCount();for(F=[],I=0;I<n;I++)t();M.filterChains=F,M.usePanning=E,R||(Bt.on(b,function(e){void 0!==e.track&&F[e.track]&&F[e.track].volumeValue(e.mute?0:70)}),Bt.on(ue,function(e){for(I=F.length;I<e;I++)t();Bt.trigger(y,e),M.setStereoSeparation(l)}),Bt.on(he,function(e){M.setStereoSeparation()}))}},M.enable=function(){t.gain.setValueAtTime(1,0),M.cutOff=!1},M.disable=function(){t.gain.setValueAtTime(0,0),M.cutOff=!0;L.forEach(function(e,t){e.forEach(function(e){e.gain.cancelScheduledValues(0),e.gain.setValueAtTime(0,0)}),L[t]=[]})},M.checkState=function(){T&&"suspended"===T.state&&T.resume&&T.resume()},M.playSample=function(e,t,n,i,r,a,o){var s;R?s=A:(s=T,M.enable()),t=t||428,void 0===i&&(i=D?Jt.getCurrentTrack():0),a=a||T.currentTime,o===rt&&(n=0);var l,d,c,u=mn.getInstrument(e),f=t,h=0;if(u){var g,p,m=0,v=0;n=void 0===n?100*u.sample.volume/64:n,h=(u.sample.panning||0)/128,mn.inFTMode()?mn.useLinearFrequency?t-=u.getFineTune()/2:u.getFineTune()&&(t=M.getFineTuneForNote(o,u.getFineTune())):u.getFineTune()&&(t=M.getFineTuneForPeriod(t,u.getFineTune())),p=M.getSampleRateForPeriod(t);var b=1;u.sample.data.length?(v=u.sample.data.length,r&&r.offset&&(v<=r.offset.value&&(r.offset.value=v-1),m=r.offset.value/s.sampleRate),g=s.createBuffer(1,v,s.sampleRate),b=p/s.sampleRate):(g=s.createBuffer(1,1,s.sampleRate),m=0);var w=g.getChannelData(0);for(I=0;I<v;I++)w[I]=u.sample.data[I];W=p;var x=s.createBufferSource();x.buffer=g;var k=s.createGain();if(k.gain.value=n/100,k.gain.setValueAtTime(n/100,a),u.sample.loop.enabled&&2<u.sample.loop.length&&(Lt.unrollLoops||(x.loop=!0,x.loopStart=u.sample.loop.start/s.sampleRate,x.loopEnd=(u.sample.loop.start+u.sample.loop.length)/s.sampleRate)),u.volumeEnvelope.enabled||u.panningEnvelope.enabled||u.hasVibrato()){var P=u.noteOn(a),y=x;P.volume&&(x.connect(l=P.volume),y=l),P.panning&&(y.connect(d=P.panning),y=d),c=P.scheduled,y.connect(k)}else x.connect(k);var S=Wt.context.createGain();if(S.gain.setValueAtTime(0,a),S.gain.linearRampToValueAtTime(1,a+.01),k.connect(S),E){var _=Wt.context.createStereoPanner();_.pan.setValueAtTime(h,a),S.connect(_),_.connect(F[i].input())}else S.connect(F[i].input());x.playbackRate.value=b;x.start(a+0,m);var C={source:x,volume:k,panning:_,volumeEnvelope:l,panningEnvelope:d,volumeFadeOut:S,startVolume:n,currentVolume:n,startPeriod:t,basePeriod:f,noteIndex:o,startPlaybackRate:b,sampleRate:p,instrumentIndex:e,effects:r,track:i,time:a,scheduled:c};return L[B].push(k),R||Bt.trigger(z,C),C}return{}},M.playSilence=function(){if(T){var e=T.createBufferSource();e.connect(a),e.start()}},M.playRaw=function(e,t){if(T&&e&&e.length){var n;n=T.createBuffer(1,e.length,T.sampleRate);var i=t/audioContext.sampleRate,r=T.createBufferSource();r.buffer=n,r.loop=!0,r.playbackRate.value=i,r.connect(a),r.start()}},M.isRecording=function(){return n},M.startRecording=function(){if(!n&&T&&T.createMediaStreamDestination){var e=T.createMediaStreamDestination();(o=new MediaRecorder(e.stream)).ondataavailable=function(e){s.push(e.data)},o.onstop=function(e){var t=new Blob(s,{type:"audio/ogg; codecs=opus"});Rt(t,"recording.opus")},a.connect(e),o.start(),n=!0}},M.stopRecording=function(){n&&(n=!1,o.stop())},M.startRendering=function(e){R=!0,A=new OfflineAudioContext(2,44100*e,44100),M.context=A,M.init(A)},M.stopRendering=function(t){R=!1,A.startRendering().then(function(e){t&&t(e)}).catch(function(e){}),i(M.context=T),M.init(T)},M.setStereoSeparation=function(e){var t,n=mn.getTrackCount();if(mn.inFTMode())t=0;else switch(l=e=e||l){case Ge:t=0,Lt.stereoSeparation=Ge;break;case He:t=1,Lt.stereoSeparation=He;break;default:t=.5,Lt.stereoSeparation=Xe}for(I=0;I<n;I++){var i=F[I];i&&i.panningValue(I%2==0?-t:t)}},M.getPrevSampleRate=function(){return W},M.context=T,M.getSemiToneFrom=function(e,t,n){var i=e;if(n&&(e=(e=M.getFineTuneBasePeriod(e,n))||i),t){var r=cn[e];if(r){var a=hn.indexOf(r.name),o=hn[a+t];if(o){var s=fn[o];s&&(i=s.period,n&&(i=M.getFineTuneForPeriod(i,n)))}}}return i},M.getNearestSemiTone=function(e,t){var n=8;if(t){var i=mn.getInstrument(t);i&&i.sample.finetune&&(n+=i.sample.finetune)}var r=1e5,a=e;for(var o in nt)if(nt.hasOwnProperty(o)){var s=nt[o].tune[n],l=Math.abs(s-e);l<r&&(r=l,a=s)}return a},M.getFineTuneForPeriod=function(e,t){var n=e,i=cn[e];if(i&&i.tune){var r=8+t;0<=r&&r<i.tune.length&&(n=i.tune[r])}return n},M.getFineTuneForNote=function(e,t){if(e===rt)return 1;var n=gn[e],i=0<t?gn[e+1]:gn[e-1];if(n&&i){var r=Math.abs(i.period-n.period)/127;return n.period-r*t}return n?n.period:1e5},M.getFineTuneBasePeriod=function(e,t){var n=e,i=un[t];return i&&(n=i[e]),n},M.getSampleRateForPeriod=function(e){return mn.inFTMode()?mn.useLinearFrequency?8363*Math.pow(2,(4608-e)/768):3579364/e:3546895/e},M.limitAmigaPeriod=function(e){return e=Math.max(e,113),e=Math.min(e,856)},M.setAmigaLowPassFilter=function(e,t){r.frequency.setValueAtTime(e?2e3:2e4,t)},M.setMasterVolume=function(e,t){e*=.7,a.gain.setValueAtTime(d,t=t||T.currentTime),a.gain.linearRampToValueAtTime(e,t+.02),d=e},M.slideMasterVolume=function(e,t){a.gain.linearRampToValueAtTime(e*=.7,t=t||T.currentTime),d=e},M.getLastMasterVolume=function(){return d/.7},M.clearScheduledNotesCache=function(){2<++B&&(B=0),L[B]=[]},M.waveFormFunction={sine:function(e,t,n,i){return e+Math.sin(t*n*.8)*i*1.7},saw:function(e,t,n,i){var r=1-Math.abs(t*n/7%1);return e+(r=(r=2*r-1)*i*-2)},square:function(e,t,n,i){var r=Math.sin(t*n)<=0?-1:1;return e+(r=r*i*2)},sawInverse:function(e,t,n,i){var r=Math.abs(t*n/7%1);return e+(r=(r=2*r-1)*i*-2)}},M}();!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t():e[e.__dropbox_export||"dropboxService"]=t()}(this,function(){"use strict";function h(e){return"[object Function]"==g.call(e)}function e(n,e){var t=[].slice.call(arguments),i=v[n]||{},r=i.baseUri||"https://api.dropboxapi.com/2/",a=i.format||"rpc",o=i.contentType||null===i.contentType?null:b[a],s=t[t.length-1],l=2<t.length&&("[object Object]"==g.call(s)||h(s))?s:{};h(l)&&(l={onComplete:l});var d,c={};Promise&&(d=new Promise(function(e,t){c.resolve=e,c.reject=t}));var u=new XMLHttpRequest;u.open("POST",r+n,!0),u.setRequestHeader("Authorization","Bearer "+(p("__dbat")||"000000000000000000000000_00000-000000000000000000000000000000000")),"content-download"==a&&(u.responseType="blob"),e&&e.responseType&&(u.responseType=e.responseType,delete e.responseType),o&&u.setRequestHeader("Content-Type",o),!e||"content-upload"!=a&&"content-download"!=a||u.setRequestHeader("Dropbox-API-Arg",JSON.stringify(e)),l.onDownloadProgress&&u.addEventListener("progress",l.onDownloadProgress),l.onUploadProgress&&u.upload&&u.upload.addEventListener("progress",l.onUploadProgress),(l.onError||m)&&u.addEventListener("error",function(e){var t=l.onError&&l.onError(e.target);d&&c.reject&&c.reject(e.target),m&&m(e.target,t)}),u.onreadystatechange=function(){if(4==u.readyState)if(200==u.status){var e=JSON.parse(u.getResponseHeader("dropbox-api-result")||u.responseText);"auth/token/revoke"==n&&p("__dbat",""),l.onComplete&&l.onComplete(e,u.response,u),d&&c.resolve&&c.resolve(e,u.response,u)}else{var t=l.onError&&l.onError(u);d&&c.reject&&c.reject(u),m&&m(u,t)}};var f=2<t.length&&"content-upload"==a?t[2]:void 0;return(f=f||(e&&"rpc"==a?JSON.stringify(e):null))?u.send(f):u.send(),d}var g={}.toString,t="https://content.dropboxapi.com/2/",p=function(e,t){return 1<arguments.length?localStorage[e]=t:localStorage[e]},m=void 0,v={"auth/token/revoke":{contentType:null},"users/get_current_account":{contentType:"application/json"},"files/upload":{baseUri:t,format:"content-upload"},"files/get_thumbnail":{baseUri:t,format:"content-download"},"files/download":{baseUri:t,format:"content-download"},"files/get_preview":{baseUri:t,format:"content-download"},"files/upload_session/append":{baseUri:t,format:"content-upload"},"files/upload_session/append_v2":{baseUri:t,format:"content-upload"},"files/upload_session/finish":{baseUri:t,format:"content-upload"},"files/upload_session/start":{baseUri:t,format:"content-upload"},"files/get_shared_link_file":{baseUri:t,format:"content-download"}},b={rpc:"application/json","content-upload":"application/octet-stream"};return e.setGlobalErrorHandler=function(e){m=e},e.setTokenStore=function(e){p=e},e.authenticate=function(e,t){h(t=t||{})&&(t={onComplete:t}),"[object String]"==g.call(e=e||{})&&(e={client_id:e}),e.redirect_uri=e.redirect_uri||window.location.href;var n,i={};if(Promise&&(n=new Promise(function(e,t){i.resolve=e,i.reject=t})),p("__dbat"))return t.onComplete(),n&&n.resolve&&n.resolve(),n;var r=window.location.hash.replace(/^#/,"").split("&").reduce(function(e,t){return""==t||(t=t.split("="),e[decodeURIComponent(t[0])]=decodeURIComponent(t[1])),e},{}),a=p("__dbcsrf");if(r.state&&a&&r.state==a)if(r.access_token)p("__dbat",r.access_token),p("__dbcsrf",""),window.location.replace(window.location.href.replace(/#.*/,""));else{var o=t.onError&&t.onError(r);n&&n.reject&&n.reject(r),m&&m(r,o)}else a=""+Math.floor(1e5*Math.random()),p("__dbcsrf",a),window.location="https://www.dropbox.com/1/oauth2/authorize?response_type=token&client_id="+encodeURIComponent(e.client_id)+"&redirect_uri="+encodeURIComponent(e.redirect_uri)+"&state="+encodeURIComponent(a);return n},e.getAccessToken=function(){return p("__dbat")},e.clearAccessToken=function(){return p("__dbat","")},e});var Rt=Rt||function(s){"use strict";if(!(void 0===s||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var l=function(){return s.URL||s.webkitURL||s},d=s.document.createElementNS("http://www.w3.org/1999/xhtml","a"),c="download"in d,u=/constructor/i.test(s.HTMLElement)||s.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),h=function(e){(s.setImmediate||s.setTimeout)(function(){throw e},0)},g=function(e){setTimeout(function(){"string"==typeof e?l().revokeObjectURL(e):e.remove()},4e4)},p=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},i=function(e,n,t){t||(e=p(e));function i(){!function(e,t,n){for(var i=(t=[].concat(t)).length;i--;){var r=e["on"+t[i]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){h(e)}}}(a,"writestart progress write writeend".split(" "))}var r,a=this,o="application/octet-stream"===e.type;if(a.readyState=a.INIT,c)return r=l().createObjectURL(e),void setTimeout(function(){var e,t;d.href=r,d.download=n,e=d,t=new MouseEvent("click"),e.dispatchEvent(t),i(),g(r),a.readyState=a.DONE});!function(){if((f||o&&u)&&s.FileReader){var t=new FileReader;return t.onloadend=function(){var e=f?t.result:t.result.replace(/^data:[^;]*;/,"data:attachment/file;");s.open(e,"_blank")||(s.location.href=e),e=void 0,a.readyState=a.DONE,i()},t.readAsDataURL(e),a.readyState=a.INIT}(r=r||l().createObjectURL(e),o)?s.location.href=r:s.open(r,"_blank")||(s.location.href=r);a.readyState=a.DONE,i(),g(r)}()},e=i.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=p(e)),navigator.msSaveOrOpenBlob(e,t)}:(e.abort=function(){},e.readyState=e.INIT=0,e.WRITING=1,e.DONE=2,e.error=e.onwritestart=e.onprogress=e.onwrite=e.onabort=e.onerror=e.onwriteend=null,function(e,t,n){return new i(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=Rt:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return Rt}),function(r,a,e){function o(n,e){if(!a[n]){if(!r[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var i=a[n]={exports:{}};r[n][0].call(i.exports,function(e){var t=r[n][1][e];return o(t||e)},i,i.exports)}return a[n].exports}for(var s="function"==typeof require&&require,t=0;t<e.length;t++)o(e[t])}({1:[function(e,t,n){var i=e("./lib/WAAClock");t.exports=i,"undefined"!=typeof window&&(window.WAAClock=i)},{"./lib/WAAClock":2}],3:[function(e,t,n){var i=t.exports={};i.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;t!==window&&null!==t||"process-tick"!==e.data||(e.stopPropagation(),0<n.length&&n.shift()())},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),i.title="browser",i.browser=!0,i.env={},i.argv=[],i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")}},{}],2:[function(e,t,n){var i=e("__browserify_process");if("undefined"!=typeof window&&!AudioContext)throw new Error("This browser doesn't seem to support web audio API");function r(e,t,n){this.clock=e,this.func=n,this.repeatTime=null,this.toleranceLate=a,this.toleranceEarly=o,this._armed=!1,this._latestTime=null,this._earliestTime=null,this.schedule(t)}var a=.1,o=.001;r.prototype.clear=function(){return this.clock._removeEvent(this),this},r.prototype.repeat=function(e){if(0===e)throw new Error("delay cannot be 0");return this.repeatTime=e,this},r.prototype.tolerance=function(e){return"number"==typeof e.late&&(this.toleranceLate=e.late),"number"==typeof e.early&&(this.toleranceEarly=e.early),this._update(),this},r.prototype.isRepeated=function(){return null!==this.repeatTime},r.prototype.schedule=function(e){this._armed=!0,this.deadline=e,this._update(),this._earliestTime<=this.clock.context.currentTime&&(this.clock._removeEvent(this),this._execute())},r.prototype._execute=function(){this._armed=!1,this.clock.context.currentTime<this._latestTime?this.func(this):Bt&&Bt.trigger(X),!1===this._armed&&this.isRepeated()&&this.schedule(this.deadline+this.repeatTime)},r.prototype._update=function(){this._latestTime=this.deadline+this.toleranceLate,this._earliestTime=this.deadline-this.toleranceEarly,this.clock._removeEvent(this),this.clock._insertEvent(this)};var s=t.exports=function(e,t){this.toleranceEarly=(t=t||{}).toleranceEarly||o,this.toleranceLate=t.toleranceLate||a,this.context=e,this._events=[],this._started=!1};s.prototype.setTimeout=function(e,t){return this._createEvent(e,this._absTime(t))},s.prototype.callbackAtTime=function(e,t){return this._createEvent(e,t)},s.prototype.timeStretch=function(n,e,i){var r=this.context.currentTime;return e.forEach(function(e){e.isRepeated()&&e.repeat(e.repeatTime*i);var t=n+i*(e.deadline-n);if(e.isRepeated())for(;t-e.toleranceEarly<=r;)t+=e.repeatTime;e.schedule(t)}),e},s.prototype.start=function(){if(!1===this._started){var e=this;this._started=!0,this._events=[];this._clockNode=this.context.createScriptProcessor(256,1,1),this._clockNode.connect(this.context.destination),this._clockNode.onaudioprocess=function(){i.nextTick(function(){e._tick()})}}},s.prototype.stop=function(){!0===this._started&&(this._started=!1,this._clockNode.disconnect())},s.prototype._tick=function(){for(var e=this._events.shift();e&&e._earliestTime<=this.context.currentTime;)e._execute(),e=this._events.shift();e&&this._events.unshift(e)},s.prototype._createEvent=function(e,t){var n=new r(this,t,e);return n.tolerance({late:this.toleranceLate,early:this.toleranceEarly}),n},s.prototype._insertEvent=function(e){this._events.splice(this._indexByTime(e._earliestTime),0,e)},s.prototype._removeEvent=function(e){var t=this._events.indexOf(e);-1!==t&&this._events.splice(t,1)},s.prototype._indexByTime=function(e){for(var t,n=0,i=this._events.length;n<i;)t=Math.floor((n+i)/2),this._events[t]._earliestTime<e?n=t+1:i=t;return n},s.prototype._absTime=function(e){return e+this.context.currentTime},s.prototype._relTime=function(e){return e-this.context.currentTime}},{__browserify_process:3}]},{},[1]),function(P){"use strict";function n(){this.crc=-1}function u(){}function y(e,t){var n,i;return n=new ArrayBuffer(e),i=new Uint8Array(n),t&&i.set(t,0),{buffer:n,array:i,view:new DataView(n)}}function e(){}function t(i){var r,a=this;a.size=0,a.init=function(e,t){var n=new Blob([i],{type:L});(r=new o(n)).init(function(){a.size=r.size,e()},t)},a.readUint8Array=function(e,t,n,i){r.readUint8Array(e,t,n,i)}}function i(d){var c,n=this;n.size=0,n.init=function(e){for(var t=d.length;"="==d.charAt(t-1);)t--;c=d.indexOf(",")+1,n.size=Math.floor(.75*(t-c)),e()},n.readUint8Array=function(e,t,n){var i,r=y(t),a=4*Math.floor(e/3),o=4*Math.ceil((e+t)/3),s=P.atob(d.substring(a+c,o+c)),l=e-3*Math.floor(a/4);for(i=l;i<l+t;i++)r.array[i-l]=s.charCodeAt(i);n(r.array)}}function o(a){var t=this;t.size=0,t.init=function(e){t.size=a.size,e()},t.readUint8Array=function(e,t,n,i){var r=new FileReader;r.onload=function(e){n(new Uint8Array(e.target.result))},r.onerror=i;try{r.readAsArrayBuffer(function(e,t,n){if(t<0||n<0||e.size<t+n)throw new RangeError("offset:"+t+", length:"+n+", size:"+e.size);return e.slice?e.slice(t,t+n):e.webkitSlice?e.webkitSlice(t,t+n):e.mozSlice?e.mozSlice(t,t+n):e.msSlice?e.msSlice(t,t+n):void 0}(a,e,t))}catch(e){i(e)}}}function r(r){var n=this;n.size=0,n.init=function(e,t){n.size=r.byteLength,e()},n.readUint8Array=function(e,t,n,i){n(new Uint8Array(r.slice(e,e+t)))}}function a(){}function s(i){var r;this.init=function(e){r=new Blob([],{type:L}),e()},this.writeUint8Array=function(e,t){r=new Blob([r,b?e:e.buffer],{type:L}),t()},this.getData=function(t,e){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=e,n.readAsText(r,i)}}function l(t){var a="",o="";this.init=function(e){a+="data:"+(t||"")+";base64,",e()},this.writeUint8Array=function(e,t){var n,i=o.length,r=o;for(o="",n=0;n<3*Math.floor((i+e.length)/3)-i;n++)r+=String.fromCharCode(e[n]);for(;n<e.length;n++)o+=String.fromCharCode(e[n]);2<r.length?a+=P.btoa(r):o=r,t()},this.getData=function(e){e(a+P.btoa(o))}}function d(n){var i;this.init=function(e){i=new Blob([],{type:n}),e()},this.writeUint8Array=function(e,t){i=new Blob([i,b?e:e.buffer],{type:n}),t()},this.getData=function(e){e(i)}}function c(){var r;this.init=function(e,t){r=new Uint8Array,e()},this.writeUint8Array=function(e,t,n){var i=new Uint8Array(r.length+e.length);i.set(r),i.set(e,r.length),r=i,t()},this.getData=function(e){e(r.buffer)}}function S(r,n,e,a,t,o,s,i,l,d){function c(){r.removeEventListener("message",u,!1),i(g,p)}function u(e){var t=e.data,n=t.data,i=t.error;if(i)return i.toString=function(){return"Error: "+this.message},void l(i);if(t.sn===v)switch("number"==typeof t.codecTime&&(r.codecTime+=t.codecTime),"number"==typeof t.crcTime&&(r.crcTime+=t.crcTime),t.type){case"append":n?(g+=n.length,a.writeUint8Array(n,function(){f()},d)):f();break;case"flush":p=t.crc,n?(g+=n.length,a.writeUint8Array(n,function(){c()},d)):c();break;case"progress":s&&s(h+t.loaded,o)}}function f(){(h=m*F)<=o?e.readUint8Array(t+h,Math.min(F,o-h),function(e){s&&s(h,o);var t=0===h?n:{sn:v};t.type="append",t.data=e;try{r.postMessage(t,[e.buffer])}catch(e){r.postMessage(t)}m++},l):r.postMessage({sn:v,type:"flush"})}var h,g,p,m=0,v=n.sn;g=0,r.addEventListener("message",u,!1),f()}function _(i,t,r,a,o,e,s,l,d,c){var u,f=0,h=0,g="input"===e,p="output"===e,m=new n;!function n(){var e;if((u=f*F)<o)t.readUint8Array(a+u,Math.min(F,o-u),function(e){var t;try{t=i.append(e,function(e){s&&s(u+e,o)})}catch(e){return void d(e)}t?(h+=t.length,r.writeUint8Array(t,function(){f++,setTimeout(n,1)},c),p&&m.append(t)):(f++,setTimeout(n,1)),g&&m.append(e),s&&s(u,o)},d);else{try{e=i.flush()}catch(e){return void d(e)}e?(p&&m.append(e),h+=e.length,r.writeUint8Array(e,function(){l(h,m.get())},c)):l(h,m.get())}}()}function C(e,t,n,i,r,a,o,s,l,d,c){P.zip.useWebWorkers&&o?S(e,{sn:t,codecClass:"NOOP",crcType:"input"},n,i,r,a,l,s,d,c):_(new u,n,i,r,a,"input",l,s,d,c)}function f(e){var t,n,i="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)i+=127<(n=255&e.charCodeAt(t))?r[n-128]:String.fromCharCode(n);return i}function h(e){return decodeURIComponent(escape(e))}function g(e){var t,n="";for(t=0;t<e.length;t++)n+=String.fromCharCode(e[t]);return n}function T(e,t,n,i,r){e.version=t.view.getUint16(n,!0),e.bitFlag=t.view.getUint16(n+2,!0),e.compressionMethod=t.view.getUint16(n+4,!0),e.lastModDateRaw=t.view.getUint32(n+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,n=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&n)>>11,(2016&n)>>5,2*(31&n),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?(!i&&8==(8&e.bitFlag)||(e.crc32=t.view.getUint32(n+10,!0),e.compressedSize=t.view.getUint32(n+14,!0),e.uncompressedSize=t.view.getUint32(n+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(n+22,!0),e.extraFieldLength=t.view.getUint16(n+24,!0)):r(x)):r(w)}function p(w,t,x){function u(){}var k=0;u.prototype.getData=function(f,r,h,g){function p(e,t){var n,i;g&&(n=t,(i=y(4)).view.setUint32(0,n),b.crc32!=i.view.getUint32(0))?x("CRC failed."):f.getData(function(e){r(e)})}function m(e){x(e||D)}function v(e){x(e||"Error while writing file data.")}var b=this;w.readUint8Array(b.offset,30,function(e){var u,t=y(e.length,e);1347093252==t.view.getUint32(0)?(T(b,t,4,!1,x),u=b.offset+30+b.filenameLength+b.extraFieldLength,f.init(function(){var e,t,n,i,r,a,o,s,l,d,c;0===b.compressionMethod?C(b._worker,k++,w,f,u,b.compressedSize,g,p,h,m,v):(e=b._worker,t=k++,n=w,i=f,r=u,a=b.compressedSize,o=p,s=h,l=m,d=v,c=g?"output":"none",P.zip.useWebWorkers?S(e,{sn:t,codecClass:"Inflater",crcType:c},n,i,r,a,s,o,l,d):_(new P.zip.Inflater,n,i,r,a,c,s,o,l,d))},v)):x(A)},m)};var n={getEntries:function(d){var c=this._worker;!function(i){function e(e,n){w.readUint8Array(w.size-e,e,function(e){for(var t=e.length-r;0<=t;t--)if(80===e[t]&&75===e[t+1]&&5===e[t+2]&&6===e[t+3])return void i(new DataView(e.buffer,t,r));n()},function(){x(E)})}var r=22;if(w.size<r)x(A);else{var t=r+65536;e(r,function(){e(Math.min(t,w.size),function(){x(A)})})}}(function(e){var t,l;t=e.getUint32(16,!0),l=e.getUint16(8,!0),t<0||w.size<=t?x(A):w.readUint8Array(t,w.size-t,function(e){var t,n,i,r,a=0,o=[],s=y(e.length,e);for(t=0;t<l;t++){if((n=new u)._worker=c,1347092738!=s.view.getUint32(a))return void x(A);T(n,s,a+6,!0,x),n.commentLength=s.view.getUint16(a+32,!0),n.directory=16==(16&s.view.getUint8(a+38)),n.offset=s.view.getUint32(a+42,!0),i=g(s.array.subarray(a+46,a+46+n.filenameLength)),n.filename=(2048==(2048&n.bitFlag)?h:f)(i),n.directory||"/"!=n.filename.charAt(n.filename.length-1)||(n.directory=!0),r=g(s.array.subarray(a+46+n.filenameLength+n.extraFieldLength,a+46+n.filenameLength+n.extraFieldLength+n.commentLength)),n.comment=(2048==(2048&n.bitFlag)?h:f)(r),o.push(n),a+=46+n.filenameLength+n.extraFieldLength+n.commentLength}d(o)},function(){x(E)})})},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};P.zip.useWebWorkers?M("inflater",function(e){n._worker=e,t(n)},function(e){x(e)}):t(n)}function k(e){return unescape(encodeURIComponent(e))}function I(e){var t,n=[];for(t=0;t<e.length;t++)n.push(e.charCodeAt(t));return n}function m(g,t,s,p){function m(e){s(e||"Error while writing zip file.")}function v(e){s(e||D)}var l={},b=[],w=0,x=0,n={add:function(n,d,i,c,u){function f(e,t){var n=y(16);w+=e||0,n.view.setUint32(0,1347094280),void 0!==t&&(r.view.setUint32(10,t,!0),n.view.setUint32(4,t,!0)),d&&(n.view.setUint32(8,e,!0),r.view.setUint32(14,e,!0),n.view.setUint32(12,d.size,!0),r.view.setUint32(18,d.size,!0)),g.writeUint8Array(n.array,function(){w+=16,i()},m)}function e(){var e,t;(u=u||{},n=n.trim(),u.directory&&"/"!=n.charAt(n.length-1)&&(n+="/"),l.hasOwnProperty(n))?s("File already exists."):(a=I(k(n)),b.push(n),e=function(){var e,t,n,i,r,a,o,s,l;d?p||0===u.level?C(h,x++,d,g,0,d.size,!0,f,c,v,m):(e=h,t=x++,n=d,i=g,r=u.level,a=f,o=c,s=v,l=m,P.zip.useWebWorkers?S(e,{sn:t,options:{level:r},codecClass:"Deflater",crcType:"input"},n,i,0,n.size,o,a,s,l):_(new P.zip.Deflater,n,i,0,n.size,"input",o,a,s,l)):f()},o=u.lastModDate||new Date,r=y(26),l[n]={headerArray:r.array,directory:u.directory,filename:a,offset:w,comment:I(k(u.comment||""))},r.view.setUint32(0,335546376),u.version&&r.view.setUint8(0,u.version),p||0===u.level||u.directory||r.view.setUint16(4,2048),r.view.setUint16(6,(o.getHours()<<6|o.getMinutes())<<5|o.getSeconds()/2,!0),r.view.setUint16(8,(o.getFullYear()-1980<<4|o.getMonth()+1)<<5|o.getDate(),!0),r.view.setUint16(22,a.length,!0),(t=y(30+a.length)).view.setUint32(0,1347093252),t.array.set(r.array,4),t.array.set(a,30),w+=t.array.length,g.writeUint8Array(t.array,e,m))}var r,a,o,h=this._worker;d?d.init(e,v):e()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var t,n,i,r=0,a=0;for(n=0;n<b.length;n++)r+=46+(i=l[b[n]]).filename.length+i.comment.length;for(t=y(r+22),n=0;n<b.length;n++)i=l[b[n]],t.view.setUint32(a,1347092738),t.view.setUint16(a+4,5120),t.array.set(i.headerArray,a+6),t.view.setUint16(a+32,i.comment.length,!0),i.directory&&t.view.setUint8(a+38,16),t.view.setUint32(a+42,i.offset,!0),t.array.set(i.filename,a+46),t.array.set(i.comment,a+46+i.filename.length),a+=46+i.filename.length+i.comment.length;t.view.setUint32(a,1347093766),t.view.setUint16(a+8,b.length,!0),t.view.setUint16(a+10,b.length,!0),t.view.setUint32(a+12,r,!0),t.view.setUint32(a+16,w,!0),g.writeUint8Array(t.array,function(){g.getData(e)},m)},_worker:null};P.zip.useWebWorkers?M("deflater",function(e){n._worker=e,t(n)},function(e){s(e)}):t(n)}function M(e,i,r){function a(e){s.terminate(),r(e)}if(null===P.zip.workerScripts||null===P.zip.workerScriptsPath){var t,n,o;if(P.zip.workerScripts){if(t=P.zip.workerScripts[e],!Array.isArray(t))return void r(new Error("zip.workerScripts."+e+" is not an array!"));n=t,o=document.createElement("a"),t=n.map(function(e){return o.href=e,o.href})}else(t=B[e].slice(0))[0]=(P.zip.workerScriptsPath||"")+t[0];var s=new Worker(t[0]);s.codecTime=s.crcTime=0,s.postMessage({type:"importScripts",scripts:t.slice(1)}),s.addEventListener("message",function e(t){var n=t.data;if(n.error)return s.terminate(),void r(n.error);"importScripts"===n.type&&(s.removeEventListener("message",e),s.removeEventListener("error",a),i(s))}),s.addEventListener("error",a)}else r(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."))}function v(e){}var b,A="File format is not recognized.",w="File contains encrypted entry.",x="File is using Zip64 (4gb+ file size).",E="Error while reading zip file.",D="Error while reading file data.",F=524288,L="text/plain";try{b=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}n.prototype.append=function(e){for(var t=0|this.crc,n=this.table,i=0,r=0|e.length;i<r;i++)t=t>>>8^n[255&(t^e[i])];this.crc=t},n.prototype.get=function(){return~this.crc},n.prototype.table=function(){var e,t,n,i=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)1&n?n=n>>>1^3988292384:n>>>=1;i[e]=n}return i}(),u.prototype.append=function(e){return e},u.prototype.flush=function(){},(t.prototype=new e).constructor=t,(i.prototype=new e).constructor=i,(o.prototype=new e).constructor=o,(r.prototype=new e).constructor=r,a.prototype.getData=function(e){e(this.data)},(s.prototype=new a).constructor=s,(l.prototype=new a).constructor=l,(d.prototype=new a).constructor=d,c.prototype=new a;var B={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};P.zip={Reader:e,Writer:a,BlobReader:o,ArrayBufferReader:r,Data64URIReader:i,TextReader:t,BlobWriter:d,ArrayBufferWriter:c.prototype.constructor=c,Data64URIWriter:l,TextWriter:s,createReader:function(e,t,n){e.init(function(){p(e,t,n)},n=n||v)},createWriter:function(e,t,n,i){i=!!i,e.init(function(){m(e,t,n,i)},n=n||v)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(this);var Ut,Vt,zt,Ot,Nt,Ht,Xt,Gt,jt,Yt,qt,Kt,Zt=((Ut={}).buildNumber="undefined"==typeof buildNumber?"":buildNumber,Ut.init=function(){Bt.on(u,function(e){switch(window.focus(),e){case p:mn.new();break;case re:Bt.trigger(O,"diskop_modules_load");break;case ae:Bt.trigger(O,"diskop_modules_save");break;case oe:Jt.clearTrack();break;case se:Jt.clearPattern();break;case ve:mn.clearInstruments();break;case me:Jt.clearSong();break;case be:Bt.trigger(O,"main");break;case _e:Bt.trigger(O,"topmain");break;case Ce:Bt.trigger(O,"bottommain");break;case we:Bt.trigger(O,"options");break;case xe:Bt.trigger(O,"diskop_load");break;case ke:Bt.trigger(O,"sample");break;case Se:Bt.trigger(h,"piano");break;case Be:Bt.trigger(h,"sidebar");break;case Pe:var t=de.modalDialog();t.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0}),t.onClick=t.close;var n=$t.getVersionNumber();$t.getBuildNumber(),t.setText("BassoonTracker//Old School Amiga MOD and XM tracker/in plain javascript//©2017-2020 by Steffest//version "+n+"//Fork me on Github!"),de.setModalElement(t);break;case ye:window.open("https://www.stef.be/bassoontracker/docs/");break;case Te:de.diskOperations.playRandomSong();break;case Ie:de.diskOperations.playRandomSong("xm");break;case Me:window.open("https://github.com/steffest/bassoontracker");break;case Ae:if(document.getElementById("MrDStats"))break;var i=document.createElement("script");i.onload=function(){var t=new Stats;document.body.appendChild(t.dom),requestAnimationFrame(function e(){t.update(),requestAnimationFrame(e)})},i.src="script/plugins/stats.js",document.head.appendChild(i);break;case Ee:de.cutSelection(!0);break;case De:de.copySelection(!0);break;case Fe:de.pasteSelection(!0);break;case Le:Jt.renderTrackToBuffer()}})},Ut.doCommand=function(e){Bt.trigger(u,e)},Ut),Jt=(Gt=Xt=Ht=Nt=Ot=0,jt={},(zt={}).getStepsPerTrack=function(){return mn.inFTMode()?8:6},zt.setCurrentCursorPosition=function(e){Ht=e;var t=zt.getStepsPerTrack();Ot=Math.floor(Ht/t),Nt=Ht%t,Vt!==Ht&&Bt.trigger(v,Ht),Vt=Ht},zt.getCurrentCursorPosition=function(){return Ht},zt.moveCursorPosition=function(e){var t=zt.getStepsPerTrack(),n=Ht+e,i=mn.getTrackCount()*t-1;i<n&&(n=0),n<0&&(n=i),zt.setCurrentCursorPosition(n)},zt.getCurrentTrack=function(){return Ot},zt.setCurrentTrack=function(e){var t=zt.getStepsPerTrack();zt.setCurrentCursorPosition(e*t+Nt)},zt.getCurrentTrackPosition=function(){return Nt},zt.setCurrentTrackPosition=function(e){var t=zt.getStepsPerTrack();zt.setCurrentCursorPosition(Ot*t+e)},zt.putNote=function(e,t,n){var i=mn.getSong().patterns[Xt][Gt][Ot]||new jn,r=Bn.createNoteUndo(Xt,Ot,Gt,i);i&&(i.instrument=e,n?i.setIndex(n):i.setPeriod(t)),r.data[0].to=i.duplicate(),Bn.registerEdit(r),mn.getSong().patterns[Xt][Gt][Ot]=i,Bt.trigger(L,Xt)},zt.putNoteParam=function(e,t){var n,i,r=mn.getSong().patterns[Xt][Gt][Ot],a=Bn.createNoteUndo(Xt,Ot,Gt,r);if(r){if(1==e||2==e){var o=r.instrument;n=o>>4,i=15&o,1==e&&(n=t),2==e&&(i=t),r.instrument=(n<<4)+i}var s=0;if(mn.inFTMode()&&(s=2,3==e||4==e)){var l=r.volumeEffect;n=l>>4||1,i=15&l,3==e&&(n=t+1),4==e&&(i=t),r.volumeEffect=(n<<4)+i,r.volumeEffect<16&&(r.volumeEffect=0)}if(e==3+s&&(r.effect=t),e==4+s||e==5+s){var d=r.param;n=d>>4,i=15&d,e==4+s&&(n=t),e==5+s&&(i=t),r.param=(n<<4)+i}}a.data[0].to=r.duplicate(),Bn.registerEdit(a),mn.getSong().patterns[Xt][Gt][Ot]=r,Bt.trigger(L,Xt)},zt.clearTrack=function(){for(var e=mn.getCurrentPatternData().length,t=Bn.createTrackUndo(Xt),n=0;n<e;n++){var i=mn.getSong().patterns[Xt][n][Ot];i&&(Bn.addNote(t,Ot,n,i),i.clear())}Bn.registerEdit(t),Bt.trigger(L,Xt)},zt.clearPattern=function(){for(var e=mn.getCurrentPatternData().length,t=Bn.createPatternUndo(Xt),n=0;n<e;n++)for(var i=0;i<mn.getTrackCount();i++){var r=mn.getSong().patterns[Xt][n][i];r&&(Bn.addNote(t,i,n,r),r.clear())}Bn.registerEdit(t),Bt.trigger(L,Xt)},zt.clearSong=function(){var e=mn.getSong();mn.setCurrentPattern(0),zt.clearPattern(),e.patterns=[e.patterns[0]],e.length=1;for(var t=[],n=e.restartPosition=0;n<128;++n)t[n]=0;e.patternTable=t,mn.setAmigaSpeed(6),mn.setBPM(125),mn.setCurrentSongPosition(1),Bt.trigger($,e),Bt.trigger(Y)},zt.copyTrack=function(e){var t=void 0!==e;t||(e=Ot);for(var n=mn.getCurrentPatternData().length,i=[],r=0;r<n;r++){var a=mn.getSong().patterns[Xt][r][e];i.push(a.duplicate())}if(t)return i;jt.track=i},zt.copyPattern=function(){for(var e=[],t=0;t<mn.getTrackCount();t++){var n=zt.copyTrack(t);e.push(n)}jt.pattern=e},zt.getPasteData=function(){return jt},zt.pasteTrack=function(e,t){var n=void 0!==e,i=t;if(n||(e=Ot,i=jt.track),i){for(var r=Bn.createTrackUndo(Xt),a=mn.getCurrentPatternData().length,o=0;o<a;o++){var s=mn.getSong().patterns[Xt][o][e],l=i[o],d=Bn.addNote(r,e,o,s);s.populate(d.to=l)}return n||Bt.trigger(L,Xt),Bn.registerEdit(r),!0}return!1},zt.pastePattern=function(){var e=jt.pattern;if(e){for(var t=0;t<mn.getTrackCount();t++)zt.pasteTrack(t,e[t]);return Bt.trigger(L,Xt),!0}return!1},zt.insertNote=function(){for(var e=mn.getSong().patterns[Xt].length-2,t=Gt,n=e;t<=n;n--){var i=mn.getSong().patterns[Xt][n][Ot],r=mn.getSong().patterns[Xt][n+1][Ot];r.instrument=i.instrument,r.period=i.period,r.effect=i.effect,r.volumeEffect=i.volumeEffect,r.param=i.param,r.index=i.index}(i=mn.getSong().patterns[Xt][Gt][Ot])&&i.clear(),Bt.trigger(L,Xt)},zt.removeNote=function(e,t){if(void 0===e&&(e=Ot),void 0===t&&(t=Gt),0!==t){for(var n=t,i=mn.getSong().patterns[Xt].length-1,r=n;r<=i;r++){var a=mn.getSong().patterns[Xt][r][e],o=mn.getSong().patterns[Xt][r-1][e];o.instrument=a.instrument,o.period=a.period,o.effect=a.effect,o.volumeEffect=a.volumeEffect,o.param=a.param,o.index=a.index}(a=mn.getSong().patterns[Xt][i][e])&&a.clear(),Bt.trigger(L,Xt)}},zt.renderTrackToBuffer=function(e,t){var n=mn.getSong(),i=0,r=mn.getCurrentSongPosition(),a=mn.getCurrentPatternData().length,o=.1,s=mn.getProperties(),l=s.ticksPerStep,d=s.tickTime,c=1,u=(r=0)+c;for(u=Math.min(u,n.length),Wt.startRendering(l*d*a*(c=u-r)+.2);r<u;){var f=n.patterns[n.patternTable[r]];for(a=f.length;i<a;)mn.playPatternStep(i,o,f),o+=l*d,i++;i=0,r++}Wt.stopRendering(function(e){zt.buffer2Sample(e)})},zt.save=function(i,r){de.setStatus("Exporting ...",!0),zt.buildBinary(mn.inFTMode()?Oe:ze,function(e){var t=new Blob([e.buffer],{type:"application/octet-stream"}),n=i||zt.getFileName();"function"!=typeof r?"dropbox"===r?(en.info("save to dropbox "+n),ni.putFile("/"+n,t,function(e){de.setStatus(e?"":"Error while saving to Dropbox ...")})):(en.info("save "+n),Rt(t,n),de.setStatus("")):r(t)})},zt.importSample=function(e,t){var n=mn.getCurrentInstrument()||Gn();n.name=t,n.sample.length=e.length,n.sample.loop.start=0,n.sample.loop.length=0,n.setFineTune(0),n.sample.volume=64,n.sample.data=[],n.sample.name=t,function(e,t,n){var i=Ne.RAW_8BIT,r=l;e.goto(0);var a=e.readString(4);if("RIFF"==a&&(i=Ne.WAVE_PCM,r=d),"FORM"==a&&(e.goto(8),"8SVX"==e.readString(4)&&(i=Ne.IFF_8SVX,r=o)),t&&t.name&&".mp3"==t.name.toLowerCase().slice(-4)&&(i=Ne.MP3,r=s),t&&r)r(e,t,n);else{if(!n)return;n(i)}}(e,n.sample,function(){Bt.trigger(G,mn.getCurrentInstrumentIndex()),Bt.trigger(ee,mn.getCurrentInstrumentIndex()),function(){if(mn.getTrackerMode()===Dt&&131070<n.sample.length){var e=de.modalDialog();e.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0}),e.onClick=e.close,e.setText("Warning//The maximum sample lenght in .MOD format is 128kb//If you save in .MOD format/this sample will be truncated.//Please try downsampling or trimming the sample/to below 131072 bytes/or switch to .XM format"),de.setModalElement(e)}}()}),Bt.trigger(G,mn.getCurrentInstrumentIndex()),Bt.trigger(ee,mn.getCurrentInstrumentIndex())},zt.buffer2Sample=function(e){var t=mn.getCurrentInstrument()||Gn(),n="pattern "+mn.getCurrentPattern();t.name=n,t.sample.loop.start=0,t.sample.loop.length=0,t.setFineTune(0),t.sample.volume=64,t.sample.name=n;var r=e.getChannelData(0);t.sample.data=[];var a=Math.floor(Wt.context.sampleRate/10);for(i=a,len=r.length;i<len;i+=4)t.sample.data.push(r[i]);t.sample.length=t.sample.data.length,Bt.trigger(G,mn.getCurrentInstrumentIndex()),Bt.trigger(ee,mn.getCurrentInstrumentIndex())},zt.buildBinary=function(e,t){var n;(e=e||ze)===ze&&(n=zn()),e===Oe&&(n=Vn()),n&&n.write(t)},Bt.on(he,function(e){zt.setCurrentTrackPosition(0)}),Bt.on(L,function(e){Xt=e}),Bt.on(ce,function(e){Gt=e.current}),Bt.on(ue,function(e){e*zt.getStepsPerTrack()<=Ht&&zt.setCurrentTrack(e-1)}),zt),Qt=((Yt={}).get=function(e,t){Yt.ajax({url:e,success:function(e){t(e)},error:function(e){t(void 0,e)}})},Yt.post=function(e,t,n){var i=t;if("object"==typeof t){for(var r in i="",t)t.hasOwnProperty(r)&&(i+="&"+r+"="+encodeURIComponent(t[r]));i.length&&(i=i.substr(1))}Yt.ajax({method:"POST",url:e,data:i,datatype:"form",success:function(e){n(e)},error:function(e){n(void 0,e)}})},Yt.sendBinary=function(e,t,n){Yt.ajax({method:"POST",url:e,data:t,success:function(e){n(e)},error:function(e){n(void 0,e)}})},Yt.json=function(e,t){void 0===t&&(t=function(){}),Yt.ajax({url:e,cache:!1,datatype:"json",headers:[{key:"Accept",value:"application/json"}],success:function(e){t(e)},error:function(e){t(void 0,e)}})},Yt.html=function(e,t){Yt.ajax({url:e,cache:!1,datatype:"html",success:function(e){t(e)},error:function(e){t(void 0,e)}})},Yt.ajax=function(t){var n=new XMLHttpRequest;t.error=t.error||function(){t.success(!1)},"jsonp"===t.datatype&&t.error(n);var e=t.url;if("boolean"==typeof t.cache&&!t.cache&&$t.useUrlParams){var i=(new Date).getTime();e+=0<e.indexOf("?")?"&r="+i:"?r="+i}var r=t.method||"GET";n.onreadystatechange=function(){if(!(n.readyState<4)&&4===n.readyState)if(200!==n.status&&201!==n.status)t.error(n);else{var e=n.responseText;"json"===t.datatype&&(e=JSON.parse(e)),"html"===t.datatype&&((e=document.createElement("div")).innerHTML=n.responseText),t.success(e)}},n.ontimeout=function(e){},n.open(r,e,!0),n.timeout=t.timeout||3e4,t.headers&&t.headers.forEach(function(e){n.setRequestHeader(e.key,e.value)});var a=t.data||"";"POST"===r&&t.data&&"form"===t.datatype&&n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send(a)},Yt),$t=((Kt={}).useUrlParams=!0,Kt.useDropbox=!0,Kt.showInternalMenu=!0,Kt.useWebWorkers=!0,Kt.useInitialLoad=!0,Kt.init=function(){"object"==typeof HostBridge&&((qt=HostBridge).init(),"boolean"==typeof qt.useUrlParams&&(Kt.useUrlParams=qt.useUrlParams),"boolean"==typeof qt.useDropbox&&(Kt.useDropbox=qt.useDropboxs),"boolean"==typeof qt.showInternalMenu&&(Kt.showInternalMenu=qt.showInternalMenu),"boolean"==typeof qt.useWebWorkers&&(Kt.useWebWorkers=qt.useWebWorkers))},Kt.getBaseUrl=function(){return qt&&qt.getBaseUrl?qt.getBaseUrl():void 0!==rn&&rn.baseUrl||""},Kt.getRemoteUrl=function(){return qt&&qt.getRemoteUrl?qt.getRemoteUrl():""},Kt.getVersionNumber=function(){return"undefined"!=typeof versionNumber?versionNumber:qt&&qt.getVersionNumber?qt.getVersionNumber():"dev"},Kt.getBuildNumber=function(){return"undefined"!=typeof buildNumber?buildNumber:qt&&qt.getBuildNumber?qt.getBuildNumber():(new Date).getTime()},Kt.signalReady=function(){qt&&qt.signalReady&&qt.signalReady()},Kt.putFile=function(e,t){},Kt),en=function(){var e={};e.info=function(e){t("info",e)},e.warn=function(e){t("warn",e)},e.error=function(e){t("error",e)};var t=function(e,t){var n,i=de.stats(),r="undefined"==typeof versionNumber?"dev":versionNumber;n={"Á":"A","Ă":"A","Ắ":"A","Ặ":"A","Ằ":"A","Ẳ":"A","Ẵ":"A","Ǎ":"A","Â":"A","Ấ":"A","Ậ":"A","Ầ":"A","Ẩ":"A","Ẫ":"A","Ä":"A","Ǟ":"A","Ȧ":"A","Ǡ":"A","Ạ":"A","Ȁ":"A","À":"A","Ả":"A","Ȃ":"A","Ā":"A","Ą":"A","Å":"A","Ǻ":"A","Ḁ":"A","Ⱥ":"A","Ã":"A","Ꜳ":"AA","Æ":"AE","Ǽ":"AE","Ǣ":"AE","Ꜵ":"AO","Ꜷ":"AU","Ꜹ":"AV","Ꜻ":"AV","Ꜽ":"AY","Ḃ":"B","Ḅ":"B","Ɓ":"B","Ḇ":"B","Ƀ":"B","Ƃ":"B","Ć":"C","Č":"C","Ç":"C","Ḉ":"C","Ĉ":"C","Ċ":"C","Ƈ":"C","Ȼ":"C","Ď":"D","Ḑ":"D","Ḓ":"D","Ḋ":"D","Ḍ":"D","Ɗ":"D","Ḏ":"D","ǲ":"D","ǅ":"D","Đ":"D","Ƌ":"D","Ǳ":"DZ","Ǆ":"DZ","É":"E","Ĕ":"E","Ě":"E","Ȩ":"E","Ḝ":"E","Ê":"E","Ế":"E","Ệ":"E","Ề":"E","Ể":"E","Ễ":"E","Ḙ":"E","Ë":"E","Ė":"E","Ẹ":"E","Ȅ":"E","È":"E","Ẻ":"E","Ȇ":"E","Ē":"E","Ḗ":"E","Ḕ":"E","Ę":"E","Ɇ":"E","Ẽ":"E","Ḛ":"E","Ꝫ":"ET","Ḟ":"F","Ƒ":"F","Ǵ":"G","Ğ":"G","Ǧ":"G","Ģ":"G","Ĝ":"G","Ġ":"G","Ɠ":"G","Ḡ":"G","Ǥ":"G","Ḫ":"H","Ȟ":"H","Ḩ":"H","Ĥ":"H","Ⱨ":"H","Ḧ":"H","Ḣ":"H","Ḥ":"H","Ħ":"H","Í":"I","Ĭ":"I","Ǐ":"I","Î":"I","Ï":"I","Ḯ":"I","İ":"I","Ị":"I","Ȉ":"I","Ì":"I","Ỉ":"I","Ȋ":"I","Ī":"I","Į":"I","Ɨ":"I","Ĩ":"I","Ḭ":"I","Ꝺ":"D","Ꝼ":"F","Ᵹ":"G","Ꞃ":"R","Ꞅ":"S","Ꞇ":"T","Ꝭ":"IS","Ĵ":"J","Ɉ":"J","Ḱ":"K","Ǩ":"K","Ķ":"K","Ⱪ":"K","Ꝃ":"K","Ḳ":"K","Ƙ":"K","Ḵ":"K","Ꝁ":"K","Ꝅ":"K","Ĺ":"L","Ƚ":"L","Ľ":"L","Ļ":"L","Ḽ":"L","Ḷ":"L","Ḹ":"L","Ⱡ":"L","Ꝉ":"L","Ḻ":"L","Ŀ":"L","Ɫ":"L","ǈ":"L","Ł":"L","Ǉ":"LJ","Ḿ":"M","Ṁ":"M","Ṃ":"M","Ɱ":"M","Ń":"N","Ň":"N","Ņ":"N","Ṋ":"N","Ṅ":"N","Ṇ":"N","Ǹ":"N","Ɲ":"N","Ṉ":"N","Ƞ":"N","ǋ":"N","Ñ":"N","Ǌ":"NJ","Ó":"O","Ŏ":"O","Ǒ":"O","Ô":"O","Ố":"O","Ộ":"O","Ồ":"O","Ổ":"O","Ỗ":"O","Ö":"O","Ȫ":"O","Ȯ":"O","Ȱ":"O","Ọ":"O","Ő":"O","Ȍ":"O","Ò":"O","Ỏ":"O","Ơ":"O","Ớ":"O","Ợ":"O","Ờ":"O","Ở":"O","Ỡ":"O","Ȏ":"O","Ꝋ":"O","Ꝍ":"O","Ō":"O","Ṓ":"O","Ṑ":"O","Ɵ":"O","Ǫ":"O","Ǭ":"O","Ø":"O","Ǿ":"O","Õ":"O","Ṍ":"O","Ṏ":"O","Ȭ":"O","Ƣ":"OI","Ꝏ":"OO","Ɛ":"E","Ɔ":"O","Ȣ":"OU","Ṕ":"P","Ṗ":"P","Ꝓ":"P","Ƥ":"P","Ꝕ":"P","Ᵽ":"P","Ꝑ":"P","Ꝙ":"Q","Ꝗ":"Q","Ŕ":"R","Ř":"R","Ŗ":"R","Ṙ":"R","Ṛ":"R","Ṝ":"R","Ȑ":"R","Ȓ":"R","Ṟ":"R","Ɍ":"R","Ɽ":"R","Ꜿ":"C","Ǝ":"E","Ś":"S","Ṥ":"S","Š":"S","Ṧ":"S","Ş":"S","Ŝ":"S","Ș":"S","Ṡ":"S","Ṣ":"S","Ṩ":"S","Ť":"T","Ţ":"T","Ṱ":"T","Ț":"T","Ⱦ":"T","Ṫ":"T","Ṭ":"T","Ƭ":"T","Ṯ":"T","Ʈ":"T","Ŧ":"T","Ɐ":"A","Ꞁ":"L","Ɯ":"M","Ʌ":"V","Ꜩ":"TZ","Ú":"U","Ŭ":"U","Ǔ":"U","Û":"U","Ṷ":"U","Ü":"U","Ǘ":"U","Ǚ":"U","Ǜ":"U","Ǖ":"U","Ṳ":"U","Ụ":"U","Ű":"U","Ȕ":"U","Ù":"U","Ủ":"U","Ư":"U","Ứ":"U","Ự":"U","Ừ":"U","Ử":"U","Ữ":"U","Ȗ":"U","Ū":"U","Ṻ":"U","Ų":"U","Ů":"U","Ũ":"U","Ṹ":"U","Ṵ":"U","Ꝟ":"V","Ṿ":"V","Ʋ":"V","Ṽ":"V","Ꝡ":"VY","Ẃ":"W","Ŵ":"W","Ẅ":"W","Ẇ":"W","Ẉ":"W","Ẁ":"W","Ⱳ":"W","Ẍ":"X","Ẋ":"X","Ý":"Y","Ŷ":"Y","Ÿ":"Y","Ẏ":"Y","Ỵ":"Y","Ỳ":"Y","Ƴ":"Y","Ỷ":"Y","Ỿ":"Y","Ȳ":"Y","Ɏ":"Y","Ỹ":"Y","Ź":"Z","Ž":"Z","Ẑ":"Z","Ⱬ":"Z","Ż":"Z","Ẓ":"Z","Ȥ":"Z","Ẕ":"Z","Ƶ":"Z","Ĳ":"IJ","Œ":"OE","ᴀ":"A","ᴁ":"AE","ʙ":"B","ᴃ":"B","ᴄ":"C","ᴅ":"D","ᴇ":"E","ꜰ":"F","ɢ":"G","ʛ":"G","ʜ":"H","ɪ":"I","ʁ":"R","ᴊ":"J","ᴋ":"K","ʟ":"L","ᴌ":"L","ᴍ":"M","ɴ":"N","ᴏ":"O","ɶ":"OE","ᴐ":"O","ᴕ":"OU","ᴘ":"P","ʀ":"R","ᴎ":"N","ᴙ":"R","ꜱ":"S","ᴛ":"T","ⱻ":"E","ᴚ":"R","ᴜ":"U","ᴠ":"V","ᴡ":"W","ʏ":"Y","ᴢ":"Z","á":"a","ă":"a","ắ":"a","ặ":"a","ằ":"a","ẳ":"a","ẵ":"a","ǎ":"a","â":"a","ấ":"a","ậ":"a","ầ":"a","ẩ":"a","ẫ":"a","ä":"a","ǟ":"a","ȧ":"a","ǡ":"a","ạ":"a","ȁ":"a","à":"a","ả":"a","ȃ":"a","ā":"a","ą":"a","ᶏ":"a","ẚ":"a","å":"a","ǻ":"a","ḁ":"a","ⱥ":"a","ã":"a","ꜳ":"aa","æ":"ae","ǽ":"ae","ǣ":"ae","ꜵ":"ao","ꜷ":"au","ꜹ":"av","ꜻ":"av","ꜽ":"ay","ḃ":"b","ḅ":"b","ɓ":"b","ḇ":"b","ᵬ":"b","ᶀ":"b","ƀ":"b","ƃ":"b","ɵ":"o","ć":"c","č":"c","ç":"c","ḉ":"c","ĉ":"c","ɕ":"c","ċ":"c","ƈ":"c","ȼ":"c","ď":"d","ḑ":"d","ḓ":"d","ȡ":"d","ḋ":"d","ḍ":"d","ɗ":"d","ᶑ":"d","ḏ":"d","ᵭ":"d","ᶁ":"d","đ":"d","ɖ":"d","ƌ":"d","ı":"i","ȷ":"j","ɟ":"j","ʄ":"j","ǳ":"dz","ǆ":"dz","é":"e","ĕ":"e","ě":"e","ȩ":"e","ḝ":"e","ê":"e","ế":"e","ệ":"e","ề":"e","ể":"e","ễ":"e","ḙ":"e","ë":"e","ė":"e","ẹ":"e","ȅ":"e","è":"e","ẻ":"e","ȇ":"e","ē":"e","ḗ":"e","ḕ":"e","ⱸ":"e","ę":"e","ᶒ":"e","ɇ":"e","ẽ":"e","ḛ":"e","ꝫ":"et","ḟ":"f","ƒ":"f","ᵮ":"f","ᶂ":"f","ǵ":"g","ğ":"g","ǧ":"g","ģ":"g","ĝ":"g","ġ":"g","ɠ":"g","ḡ":"g","ᶃ":"g","ǥ":"g","ḫ":"h","ȟ":"h","ḩ":"h","ĥ":"h","ⱨ":"h","ḧ":"h","ḣ":"h","ḥ":"h","ɦ":"h","ẖ":"h","ħ":"h","ƕ":"hv","í":"i","ĭ":"i","ǐ":"i","î":"i","ï":"i","ḯ":"i","ị":"i","ȉ":"i","ì":"i","ỉ":"i","ȋ":"i","ī":"i","į":"i","ᶖ":"i","ɨ":"i","ĩ":"i","ḭ":"i","ꝺ":"d","ꝼ":"f","ᵹ":"g","ꞃ":"r","ꞅ":"s","ꞇ":"t","ꝭ":"is","ǰ":"j","ĵ":"j","ʝ":"j","ɉ":"j","ḱ":"k","ǩ":"k","ķ":"k","ⱪ":"k","ꝃ":"k","ḳ":"k","ƙ":"k","ḵ":"k","ᶄ":"k","ꝁ":"k","ꝅ":"k","ĺ":"l","ƚ":"l","ɬ":"l","ľ":"l","ļ":"l","ḽ":"l","ȴ":"l","ḷ":"l","ḹ":"l","ⱡ":"l","ꝉ":"l","ḻ":"l","ŀ":"l","ɫ":"l","ᶅ":"l","ɭ":"l","ł":"l","ǉ":"lj","ſ":"s","ẜ":"s","ẛ":"s","ẝ":"s","ḿ":"m","ṁ":"m","ṃ":"m","ɱ":"m","ᵯ":"m","ᶆ":"m","ń":"n","ň":"n","ņ":"n","ṋ":"n","ȵ":"n","ṅ":"n","ṇ":"n","ǹ":"n","ɲ":"n","ṉ":"n","ƞ":"n","ᵰ":"n","ᶇ":"n","ɳ":"n","ñ":"n","ǌ":"nj","ó":"o","ŏ":"o","ǒ":"o","ô":"o","ố":"o","ộ":"o","ồ":"o","ổ":"o","ỗ":"o","ö":"o","ȫ":"o","ȯ":"o","ȱ":"o","ọ":"o","ő":"o","ȍ":"o","ò":"o","ỏ":"o","ơ":"o","ớ":"o","ợ":"o","ờ":"o","ở":"o","ỡ":"o","ȏ":"o","ꝋ":"o","ꝍ":"o","ⱺ":"o","ō":"o","ṓ":"o","ṑ":"o","ǫ":"o","ǭ":"o","ø":"o","ǿ":"o","õ":"o","ṍ":"o","ṏ":"o","ȭ":"o","ƣ":"oi","ꝏ":"oo","ɛ":"e","ᶓ":"e","ɔ":"o","ᶗ":"o","ȣ":"ou","ṕ":"p","ṗ":"p","ꝓ":"p","ƥ":"p","ᵱ":"p","ᶈ":"p","ꝕ":"p","ᵽ":"p","ꝑ":"p","ꝙ":"q","ʠ":"q","ɋ":"q","ꝗ":"q","ŕ":"r","ř":"r","ŗ":"r","ṙ":"r","ṛ":"r","ṝ":"r","ȑ":"r","ɾ":"r","ᵳ":"r","ȓ":"r","ṟ":"r","ɼ":"r","ᵲ":"r","ᶉ":"r","ɍ":"r","ɽ":"r","ↄ":"c","ꜿ":"c","ɘ":"e","ɿ":"r","ś":"s","ṥ":"s","š":"s","ṧ":"s","ş":"s","ŝ":"s","ș":"s","ṡ":"s","ṣ":"s","ṩ":"s","ʂ":"s","ᵴ":"s","ᶊ":"s","ȿ":"s","ɡ":"g","ᴑ":"o","ᴓ":"o","ᴝ":"u","ť":"t","ţ":"t","ṱ":"t","ț":"t","ȶ":"t","ẗ":"t","ⱦ":"t","ṫ":"t","ṭ":"t","ƭ":"t","ṯ":"t","ᵵ":"t","ƫ":"t","ʈ":"t","ŧ":"t","ᵺ":"th","ɐ":"a","ᴂ":"ae","ǝ":"e","ᵷ":"g","ɥ":"h","ʮ":"h","ʯ":"h","ᴉ":"i","ʞ":"k","ꞁ":"l","ɯ":"m","ɰ":"m","ᴔ":"oe","ɹ":"r","ɻ":"r","ɺ":"r","ⱹ":"r","ʇ":"t","ʌ":"v","ʍ":"w","ʎ":"y","ꜩ":"tz","ú":"u","ŭ":"u","ǔ":"u","û":"u","ṷ":"u","ü":"u","ǘ":"u","ǚ":"u","ǜ":"u","ǖ":"u","ṳ":"u","ụ":"u","ű":"u","ȕ":"u","ù":"u","ủ":"u","ư":"u","ứ":"u","ự":"u","ừ":"u","ử":"u","ữ":"u","ȗ":"u","ū":"u","ṻ":"u","ų":"u","ᶙ":"u","ů":"u","ũ":"u","ṹ":"u","ṵ":"u","ᵫ":"ue","ꝸ":"um","ⱴ":"v","ꝟ":"v","ṿ":"v","ʋ":"v","ᶌ":"v","ⱱ":"v","ṽ":"v","ꝡ":"vy","ẃ":"w","ŵ":"w","ẅ":"w","ẇ":"w","ẉ":"w","ẁ":"w","ⱳ":"w","ẘ":"w","ẍ":"x","ẋ":"x","ᶍ":"x","ý":"y","ŷ":"y","ÿ":"y","ẏ":"y","ỵ":"y","ỳ":"y","ƴ":"y","ỷ":"y","ỿ":"y","ȳ":"y","ẙ":"y","ɏ":"y","ỹ":"y","ź":"z","ž":"z","ẑ":"z","ʑ":"z","ⱬ":"z","ż":"z","ẓ":"z","ȥ":"z","ẕ":"z","ᵶ":"z","ᶎ":"z","ʐ":"z","ƶ":"z","ɀ":"z","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ĳ":"ij","œ":"oe","ﬆ":"st","ₐ":"a","ₑ":"e","ᵢ":"i","ⱼ":"j","ₒ":"o","ᵣ":"r","ᵤ":"u","ᵥ":"v","ₓ":"x"},t=t.split(" ").join("-").replace(/[^A-Za-z0-9\[\] ]/g,function(e){return n[e]||e}).toLowerCase().replace(/[^a-z0-9\-]+/g,""),Qt.get("https://www.stef.be/bassoontracker/api/log/"+e+"/"+t+"/"+i.averageFps+"/"+i.skipRenderSteps+"/"+r+"/"+sn.width+"x"+sn.height+"/"+i.averageRenderFps,function(e){})};return e}(),tn={init:function(){$t.init(),mn.init(),Wt.init(),de.init(function(){if(window.focus(),Wt.context)rn.readSettings(),Zt.init(),$t.signalReady();else{var e=de.modalDialog();e.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0}),e.onDown=function(){window.location.href="https://www.google.com/chrome/"},e.setText("Sorry//Your browser does not support WebAudio//Supported browsers are/Chrome,Firefox,Safari and Edge"),de.setModalElement(e)}})}};document.addEventListener("DOMContentLoaded",tn.init);var nn,rn=nn={readSettings:function(){an();var e=dn.get("bassoonTrackerSettings");if(e){try{e=JSON.parse(e)}catch(e){return!1}for(var t in e)if(Lt.hasOwnProperty(t)&&e.hasOwnProperty(t)&&(Lt[t]=e[t],"skipFrame"===t)){var n=parseInt(Lt[t],10);isNaN(n)||de.skipFrame(n)}Lt.stereoSeparation&&Wt.setStereoSeparation(Lt.stereoSeparation)}},saveSettings:function(){var e={vubars:Lt.vubars,keyboardTable:Lt.keyboardTable,stereoSeparation:Lt.stereoSeparation,dropboxMode:Lt.dropboxMode,skipFrame:de.getSkipFrame()};dn.set("bassoonTrackerSettings",JSON.stringify(e))},reset:function(){an(),nn.saveSettings()}};function an(){Lt.keyboardTable="qwerty",Lt.vubars="colour",Lt.stereoSeparation=Xe,Lt.dropboxMode="rename",Lt.skipFrame=1,de.skipFrame(Lt.skipFrame)}var on,sn,ln,dn={get:function(e){return localStorage.getItem(e)},set:function(e,t){return localStorage.setItem(e,t)}},cn={},un={},fn={},hn=[],gn=[],pn=[],mn=function(){function e(s){s=s||0,(t=t||new WAAClock(Wt.context)).start(),Wt.enable(),de&&de.setStatus("Playing"),H=[],X=[];var l=(w=b.patterns[s]).length,d={},c=0,u=Wt.context.currentTime+.1,f=.2,h=w,g=k;M=[],x=t.setTimeout(function(e){1<c&&x.repeat(f=1);var t=e.deadline+f;for(Wt.clearScheduledNotesCache();u<t;){if(d.pause&&!mn.autoPlay){if(!d.pasuseHandled){var n=u-Wt.context.currentTime;0<n&&setTimeout(function(){U.pause(),U.setAmigaSpeed(6)},Math.round(1e3*n)+100),d.pasuseHandled=!0}return}if(U.setStateAtTime(u,{patternPos:c,songPos:g}),d.patternDelay){for(d.patternDelay--,A=0;A<S;A++)m(A,u);u+=V*z}else if(d=p(c,u,h,g),u+=V*z,l<=++c||d.patternBreak)if(d.positionBreak&&d.targetSongPosition==g||(H=[],X=[]),c=0,mn.getPlayType()==We){var i=d.positionBreak?d.targetSongPosition:++g;b.length<=i&&(i=b.restartPosition?b.restartPosition-1:0,Bt.trigger(ie)),b.length<=i&&(i=0),(h=b.patterns[s=b.patternTable[g=i]])||(h=v(),b.patterns[s]=h),l=h.length,d.patternBreak&&h.length<(c=d.targetPatternPosition||0)&&(c=0)}else d.patternBreak&&_<(c=d.targetPatternPosition||0)&&(c=0)}for(A=0;A<S;A++){var r=O[A];if(r&&r.time&&r.scheduled){var a=U.getInstrument(r.instrumentIndex);if(r.scheduled.volume&&r.scheduled.volume<=u+f){var o=a.scheduleEnvelopeLoop(r.volumeEnvelope,r.scheduled.volume,2);r.scheduled.volume+=o}r.scheduled.panning&&r.scheduled.panning<=u+f&&(o=a.scheduleEnvelopeLoop(r.panningEnvelope,r.scheduled.panning,2),r.scheduled.panning+=o)}}},.01).repeat(f).tolerance({early:.1})}function p(e,t,n,i){for(var r,a=(n=n||w)[e],o=S,s={},l=0;l<o;l++)(d=a[l])&&d.effect&&15===d.effect&&(d.param<32?(mn.setAmigaSpeed(d.param),0===d.param&&(s.pause=!0)):mn.setBPM(d.param));for(l=0;l<o;l++){var d=a[l];if(d){var c={position:i,step:e},u=t;if(I)u+=(Math.random()*I*2-I)/1e3;(r=f(d,l,u,c)).patternBreak&&(s.patternBreak=!0,s.targetPatternPosition=r.targetPatternPosition||0),r.positionBreak&&(s.positionBreak=!0,s.targetPatternPosition=r.targetPatternPosition||0,s.targetSongPosition=r.targetSongPosition||0),r.patternDelay&&(s.patternDelay=r.patternDelay)}}for(l=0;l<o;l++)m(l,t);return s}function f(e,t,n,i){var r=100,a={},o=e.instrument,s=e.period,l=e.index;s&&!o&&(o=O[t].currentInstrument,r="number"==typeof O[t].currentVolume?O[t].currentVolume:r,Lt.emulateProtracker1OffsetBug&&o&&N[t].offset&&N[t].offset.instrument===o&&(a.offset=N[t].offset)),"number"==typeof e.instrument&&(E=U.getInstrument(e.instrument))&&(r=E.sample.volume/64*100,Lt.emulateProtracker1OffsetBug&&(N[t].offset=N[t].offset||{},N[t].offset.value=0,N[t].offset.instrument=e.instrument));var d=r,c=!0;if("number"==typeof o&&(E=U.getInstrument(o)),l&&U.inFTMode())if(97===l&&(l=rt),l===rt){var u=E||U.getInstrument(O[t].currentInstrument);r=d=u?u.noteOff(n,O[t]):0,c=!1}else if(E&&(E.setSampleForNoteIndex(l),E.sample.relativeNote&&(l+=E.sample.relativeNote)),U.useLinearFrequency)s=7680-64*(l-1);else{var f=gn[l];f&&(s=f.period)}var h,g,p=e.param,m={};if(e.volumeEffect&&U.inFTMode()){var v=e.volumeEffect;if(h=v>>4,g=15&v,15<v&&v<=80)a.volume={value:r=d=(v-16)/64*100};else switch(h){case 6:a.fade={value:-1*g*100/64};break;case 7:a.fade={value:100*g/64};break;case 8:a.fade={value:100*-g/64,fine:!0};break;case 9:a.fade={value:100*g/64,fine:!0};break;case 10:case 11:break;case 12:a.panning={value:17*(v-192),slide:!1};break;case 13:a.panning={value:v,slide:!0}}}switch(e.effect){case 0:if(p){h=p>>4,g=15&p;var b=0;if(E=E||U.getInstrument(O[t].currentInstrument),U.inFTMode()){if(E){var w=l||O[t].noteIndex,x=E.getPeriodForNote(w,!0);l===rt?a.arpeggio=N[t].arpeggio:(a.arpeggio={root:x,interval1:x-E.getPeriodForNote(w+h,!0),interval2:x-E.getPeriodForNote(w+g,!0),step:1},N[t].arpeggio=a.arpeggio)}}else x=s||O[t].startPeriod,E&&(b=E.getFineTune())&&(x=Wt.getFineTuneForPeriod(x,b)),a.arpeggio={root:x,interval1:x-Wt.getSemiToneFrom(x,h,b),interval2:x-Wt.getSemiToneFrom(x,g,b),step:1}}e.instrument&&(a.volume={value:r});break;case 1:p*=-1,U.inFTMode()&&!p&&N[t].slideUp&&(p=N[t].slideUp.value),a.slide={value:p},N[t].slideUp=a.slide;break;case 2:U.inFTMode()&&!p&&N[t].slideDown&&(p=N[t].slideDown.value),a.slide={value:p},N[t].slideDown=a.slide;break;case 3:c=!1;var k=s;if(U.inFTMode()&&l===rt&&(k=0),O[t].currentInstrument&&(o=O[t].currentInstrument),k&&o)(E=U.getInstrument(o))&&E.getFineTune()&&(k=U.inFTMode()?E.getPeriodForNote(l,!0):Wt.getFineTuneForPeriod(k,E.getFineTune()));(S=N[t].slide)&&(p=p||S.value),a.slide={value:p,target:k=k||N[t].defaultSlideTarget,canUseGlissando:!0,resetVolume:!!e.instrument,volume:r},N[t].slide=a.slide,e.instrument&&(a.volume={value:r});break;case 4:e.instrument&&(O[t].startVolume&&(a.volume={value:d}),O[t].vibratoTimer=0);var P=(h=p>>4)*V/64,y=N[t].vibrato;0==h&&y&&(P=y.freq),0==(g=15&p)&&y&&(g=y.amplitude),a.vibrato={amplitude:g,freq:P},N[t].vibrato=a.vibrato;break;case 5:var S;c=!1,(k=s)&&o&&(E=U.getInstrument(o))&&E.getFineTune()&&(k=U.inFTMode()?Wt.getFineTuneForNote(l,E.getFineTune()):Wt.getFineTuneForPeriod(k,E.getFineTune())),p=1,(S=N[t].slide)&&(k=k||(S.target||0),p=S.value),a.slide={value:p,target:k},N[t].slide=a.slide,e.instrument&&(a.volume={value:r}),(p=e.param)&&(e.param<16?p*=-1:p=e.param>>4,a.fade={value:p=100*p/64,resetOnStep:!!e.instrument},N[t].fade=a.fade);break;case 6:e.instrument&&(O[t].startVolume&&(a.volume={value:d}),O[t].vibratoTimer=0),e.param?(e.param<16?p*=-1:p=15&e.param,a.fade={value:p=100*p/64},N[t].fade=a.fade):mn.inFTMode()&&N[t].fade&&(a.fade=N[t].fade),N[t].vibrato&&(a.vibrato=N[t].vibrato);break;case 7:s&&!e.instrument&&(O[t].startVolume&&(a.volume={value:d}),O[t].tremoloTimer=0);var _=g=15&p,C=(P=(h=p>>4)*V/64,N[t].tremolo);0==h&&C&&(P=C.freq),0==g&&C&&(_=C.amplitude),a.tremolo={amplitude:_,freq:P},N[t].tremolo=a.tremolo;break;case 8:a.panning={value:p,slide:!1};break;case 9:!(p<<=8)&&N[t].offset&&(p=N[t].offset.stepValue||N[t].offset.value||0);var T=p;Lt.emulateProtracker1OffsetBug&&!e.instrument&&N[t].offset&&(p+=N[t].offset.value),a.offset={value:p,stepValue:T},N[t].offset=N[t].offset||{},N[t].offset.value=a.offset.value,N[t].offset.stepValue=a.offset.stepValue,Lt.emulateProtracker1OffsetBug&&(e.instrument&&(N[t].offset.instrument=e.instrument),s&&(N[t].offset.value+=T)),e.instrument&&(a.volume={value:r});break;case 10:if(e.param<16?p*=-1:p=e.param>>4,p=100*p/64,!e.param){var I=N[t].fade;I&&(p=I.value)}a.fade={value:p,resetOnStep:!!e.instrument},U.inFTMode()&&(N[t].fade=a.fade);break;case 11:mn.autoPlay||(m.patternBreak=!0,m.positionBreak=!0,m.targetSongPosition=e.param,m.targetPatternPosition=0);break;case 12:a.volume={value:d=e.param/64*100};break;case 13:m.patternBreak=!0,m.targetPatternPosition=10*(h=p>>4)+(g=15&p);break;case 14:var M=p>>4,A=15&p;switch(M){case 0:U.inFTMode()||Wt.setAmigaLowPassFilter(!A,n);break;case 1:!(A*=-1)&&N[t].fineSlide&&(A=N[t].fineSlide.value),a.slide={value:A,fine:!0},N[t].fineSlide=a.slide;break;case 2:!A&&N[t].fineSlide&&(A=N[t].fineSlide.value),a.slide={value:A,fine:!0},N[t].fineSlide=a.slide;break;case 3:N[t].glissando=!!A;break;case 4:switch(A){case 1:W=Wt.waveFormFunction.saw;break;case 2:W=Wt.waveFormFunction.square;break;case 3:case 4:W=Wt.waveFormFunction.sine;break;case 5:W=Wt.waveFormFunction.saw;break;case 6:W=Wt.waveFormFunction.square;break;case 7:default:W=Wt.waveFormFunction.sine}break;case 5:if(o){var E=U.getInstrument(o);a.fineTune={original:E.getFineTune(),instrument:E},E.setFineTune(A)}break;case 6:A?(X[t]=X[t]||0,X[t]<A?(X[t]++,m.patternBreak=!0,m.positionBreak=!0,m.targetSongPosition=i.position,m.targetPatternPosition=H[t]||0):X[t]=0):H[t]=i.step;break;case 7:switch(A){case 1:R=Wt.waveFormFunction.saw;break;case 2:R=Wt.waveFormFunction.square;break;case 3:case 4:R=Wt.waveFormFunction.sine;break;case 5:R=Wt.waveFormFunction.saw;break;case 6:R=Wt.waveFormFunction.square;break;case 7:default:R=Wt.waveFormFunction.sine}break;case 8:break;case 9:A&&(a.reTrigger={value:A});break;case 10:a.fade={value:A=100*A/64,fine:!0};break;case 11:a.fade={value:-(A=100*A/64),fine:!0};break;case 12:A?A<V&&(a.cutNote={value:A}):c=!1;break;case 13:A&&(A<V?n+=z*A:c=!1);break;case 14:m.patternDelay=A}break;case 15:e.param<32?mn.setAmigaSpeed(e.param,n):mn.setBPM(e.param);break;case 16:p=Math.min(p,64),Wt.setMasterVolume(p/64,n);break;case 17:h=p>>4,g=15&p;var D=64*Wt.getLastMasterVolume(),F=0;if(h){var L=n+h*z;F=h*(V-1)}else g&&(L=n+g*z,F=-g*(V-1));F&&(p=(D+F)/64,p=Math.max(0,p),p=Math.min(1,p),Wt.slideMasterVolume(p,L));break;case 20:U.inFTMode()&&(r=d=(u=E||U.getInstrument(O[t].currentInstrument))?u.noteOff(n,O[t]):0,c=!1);break;case 21:case 25:break;case 27:a.reTrigger={value:e.param}}return c&&o&&s&&(B(t,n),O[t]={},E&&(O[t]=E.play(l,s,d,t,a,n)),N[t].defaultSlideTarget=O[t].startPeriod),o&&(O[t].currentInstrument=o,a.fineTune&&a.fineTune.instrument&&a.fineTune.instrument.setFineTune(a.fineTune.original||0)),E&&E.hasVibrato()&&(O[t].hasAutoVibrato=!0),O[t].effects=a,O[t].note=e,m}function B(e,t){try{if(O[e].source){var n=O[e].volume.gain;n.setValueAtTime(O[e].currentVolume/100,t-.002),n.linearRampToValueAtTime(0,t),O[e].source.stop(t+.02)}}catch(e){}}function C(e,t){var n=U.getInstrument(e.instrumentIndex);if(n){var i=-n.vibrato.rate/40,r=n.vibrato.depth/8;if(U.useLinearFrequency&&(r*=4),e.vibratoTimer=e.vibratoTimer||0,n.vibrato.sweep&&e.vibratoTimer<n.vibrato.sweep)r*=1-(n.vibrato.sweep-e.vibratoTimer)/n.vibrato.sweep;var a=n.getAutoVibratoFunction()(t,e.vibratoTimer,i,r);return e.vibratoTimer++,a}return t}function m(e,t){var n=O[e],i=n.effects;if(n&&i){var r,a=!1;if(n.startVibratoTimer=n.vibratoTimer||0,n.resetPeriodOnStep&&n.source)U.setPeriodAtTime(n,u=n.currentPeriod||n.startPeriod,t),n.resetPeriodOnStep=!1;if(i.volume){var o=i.volume.value;n.volume&&n.volume.gain.setValueAtTime(o/100,t),n.currentVolume=o}if(i.panning&&(255===(r=i.panning.value)&&(r=254),n.panning&&n.panning.pan.setValueAtTime((r-127)/127,t)),i.fade){var s;r=i.fade.value;var l=1;s=i.fade.resetOnStep?n.startVolume:n.currentVolume;var d=V;i.fade.fine&&(l=0,d=1);for(var c=l;c<d;c++)n.volume&&(n.volume.gain.setValueAtTime(s/100,t+c*z),s+=r,s=Math.max(s,0),s=Math.min(s,100));n.currentVolume=s}if(i.slide&&n.source){var u=p=n.currentPeriod||n.startPeriod;d=V;i.slide.fine&&(d=2);var f=i.slide.value;if(U.inFTMode()&&U.useLinearFrequency&&(f=4*i.slide.value),r=Math.abs(f),U.inFTMode()&&i.slide.resetVolume&&(n.volumeFadeOut||n.volumeEnvelope)){var h=U.getInstrument(n.instrumentIndex);h&&h.resetVolume(t,n)}n.vibratoTimer=n.startVibratoTimer;for(c=1;c<d;c++){i.slide.target?(N[e].defaultSlideTarget=i.slide.target,u<i.slide.target?i.slide.target<(u+=r)&&(u=i.slide.target):(u-=r)<i.slide.target&&(u=i.slide.target)):(u+=f,N[e].defaultSlideTarget&&(N[e].defaultSlideTarget+=f)),U.inFTMode()||(u=Wt.limitAmigaPeriod(u));var g=u;i.slide.canUseGlissando&&N[e].glissando&&(g=Wt.getNearestSemiTone(u,n.instrumentIndex)),g!==n.currentPeriod&&(n.currentPeriod=u,n.hasAutoVibrato&&U.inFTMode()&&(u=C(n,u),a=!0),U.setPeriodAtTime(n,g,t+c*z))}}if(i.arpeggio&&n.source){var p=n.currentPeriod||n.startPeriod;n.resetPeriodOnStep=!0,n.vibratoTimer=n.startVibratoTimer;for(c=0;c<V;c++){var m=c%3;0==m&&(u=p),1==m&&i.arpeggio.interval1&&(u=p-i.arpeggio.interval1),2==m&&i.arpeggio.interval2&&(u=p-i.arpeggio.interval2),n.hasAutoVibrato&&U.inFTMode()&&(u=C(n,u),a=!0),U.setPeriodAtTime(n,u,t+c*z)}}if(i.vibrato||n.hasAutoVibrato&&!a){i.vibrato=i.vibrato||{freq:0,amplitude:0};var v=i.vibrato.freq,b=i.vibrato.amplitude;if(U.inFTMode()&&U.useLinearFrequency&&(b*=4),n.vibratoTimer=n.vibratoTimer||0,n.source){n.resetPeriodOnStep=!0,p=n.currentPeriod||n.startPeriod,n.vibratoTimer=n.startVibratoTimer;for(c=0;c<V;c++)u=W(p,n.vibratoTimer,v,b),n.hasAutoVibrato&&U.inFTMode()?(u=C(n,u),a=!0):n.vibratoTimer++,U.setPeriodAtTime(n,u,t+c*z)}}if(i.tremolo){v=i.tremolo.freq,b=i.tremolo.amplitude;if(n.tremoloTimer=n.tremoloTimer||0,n.volume){var w=n.startVolume;for(c=0;c<V;c++)(w=R(w,n.tremoloTimer,v,b))<0&&(w=0),100<w&&(w=100),n.volume.gain.setValueAtTime(w/100,t+c*z),n.currentVolume=w,n.tremoloTimer++}}if(i.cutNote&&(n.volume&&n.volume.gain.setValueAtTime(0,t+i.cutNote.value*z),n.currentVolume=0),i.reTrigger){var x=n.instrumentIndex,k=n.startPeriod;o=n.startVolume;for(var P=n.noteIndex,y=i.reTrigger.value||1,S=y;S<V;){var _=t+S*z;B(e,_),O[e]=Wt.playSample(x,k,o,e,i,_,P),S+=y}}}}function o(){de&&de.setInfo(b.title),b.channels&&U.setTrackCount(b.channels),P=n=r=i=void 0,U.setCurrentSongPosition(0),U.setCurrentPatternPos(0),U.setCurrentInstrumentIndex(1),U.clearEffectCache(),Bt.trigger(fe,b),Bt.trigger($,b)}function s(){U.setAmigaSpeed(6),U.setBPM(125),R=W=Wt.waveFormFunction.sine,N=[],O=[];for(var e=0;e<S;e++)O.push({}),N.push({});U.useLinearFrequency=!1,U.setTrackerMode(Dt),Wt.setMasterVolume(1),Wt.setAmigaLowPassFilter(!1,0)}function v(){for(var e=[],t=0;t<_;t++){var n,i=[];for(n=0;n<S;n++)i.push(jn());e.push(i)}return e}for(var t,b,r,n,i,w,W,R,x,U={},a=!1,l=!1,d=[],c=1,u=0,h=0,g=We,k=0,P=0,y=125,V=6,z=2.5/y,S=4,_=64,T=Dt,I=0,O=[],N=[],M=[],H=[],X=[],A=0;A<S;A++)O.push({}),N.push({});U.init=function(e){for(var t=-8;t<8;t++)un[t]={};for(var n in nt)if(nt.hasOwnProperty(n)){var i=nt[n];if(hn.push((fn[(cn[i.period]=i).name]=i).name),i.tune)for(t=-8;t<8;t++){un[t][i.tune[t+8]]=i.period}}var r=0;for(n in it)if(it.hasOwnProperty(n)){var a=it[n];a.period||(a.period=1),gn.push(a),pn[a.period]=r,a.modPeriod&&(pn[a.modPeriod]=r),r++}e&&(Wt.init(),e.plugin&&de.initPlugin(e))},U.setCurrentInstrumentIndex=function(e){if(b.instruments[e])r!=(c=e)&&Bt.trigger(G,c),r=c;else if(e<=U.getMaxInstruments()){for(var t=b.instruments.length,n=e;t<=n;t++)U.setInstrument(t,Gn());var i=[];for(t=1;t<=n;t++){i.push({label:t+" "+(b.instruments[t]||{name:""}).name,data:t}),Bt.trigger(te,i)}r!=(c=e)&&Bt.trigger(G,c),r=c}},U.getCurrentInstrumentIndex=function(){return c},U.getCurrentInstrument=function(){return d[c]},U.getMaxInstruments=function(){return U.inFTMode()?128:31},U.setCurrentPattern=function(e){(w=b.patterns[u=e])||(w=v(),b.patterns[u]=w),_=w.length,n!=u&&Bt.trigger(L,u),n=u},U.getCurrentPattern=function(){return u},U.getCurrentPatternData=function(){return w},U.updatePatternTable=function(e,t){Bt.trigger(Y,b.patternTable[e]=t),e==k&&(n=void 0,mn.setCurrentPattern(t))},U.setCurrentPatternPos=function(e){i!=(h=e)&&Bt.trigger(ce,{current:h,prev:i}),i=h},U.getCurrentPatternPos=function(){return h},U.moveCurrentPatternPos=function(e){var t=h+e,n=_-1;t<0&&(t=n),n<t&&(t=0),U.setCurrentPatternPos(t)},U.getCurrentSongPosition=function(){return k},U.setCurrentSongPosition=function(e,t){(k=e)!=P&&(Bt.trigger(J,k),b.patternTable&&U.setCurrentPattern(b.patternTable[k]),P=k,t&&U.isPlaying()&&(U.stop(),U.togglePlay()))},U.addToPatternTable=function(e,t){void 0===e&&(e=b.length),t=t||0,e==b.length&&(b.patternTable[e]=t,b.length++),Bt.trigger($,b),Bt.trigger(Y)},U.removeFromPatternTable=function(e){b.length<2||(void 0===e&&(e=b.length-1),e==b.length-1&&(b.patternTable[e]=0,b.length--),k==b.length&&U.setCurrentSongPosition(k-1),Bt.trigger($,b),Bt.trigger(Y))},U.setPlayType=function(e){Bt.trigger(Z,g=e)},U.getPlayType=function(){return g},U.playSong=function(){U.stop(),Wt.checkState(),U.setPlayType(We),l=!0,e(u),Bt.trigger(K,l)},U.playPattern=function(){U.stop(),Wt.checkState(),h=0,U.setPlayType(Re),l=!0,e(u),Bt.trigger(K,l)},U.stop=function(){t&&t.stop(),Wt.disable(),Wt.setMasterVolume(1),de&&(de.setStatus("Ready"),Pn.clearInputNotes()),U.clearEffectCache();for(var e=0;e<S;e++)if(O[e].source)try{O[e].source.stop()}catch(e){}Bt.trigger(K,l=!1)},U.pause=function(){t&&t.stop(),Bt.trigger(K,l=!1)},U.togglePlay=function(){U.isPlaying()?U.stop():g==Re?U.playPattern():U.playSong()},U.getProperties=function(){return{ticksPerStep:V,tickTime:z}},U.playPatternStep=p,U.cutNote=B,U.setBPM=function(e){t&&t.timeStretch(Wt.context.currentTime,[x],y/e),z=2.5/(y=e),Bt.trigger(Q,y)},U.getBPM=function(){return y},U.setAmigaSpeed=function(e){V=e},U.getAmigaSpeed=function(){return V},U.getSwing=function(){return I},U.setSwing=function(e){I=e},U.getPatternLength=function(){return _},U.setPatternLength=function(e){var t=b.patterns[u].length;if(t!==(_=e)){if(t<_)for(var n=t;n<_;n++){var i,r=[];for(i=0;i<S;i++)r.push(jn());b.patterns[u].push(r)}else b.patterns[u]=b.patterns[u].splice(0,_),_<=h&&U.setCurrentPatternPos(_-1);Bt.trigger(L,u)}},U.getTrackCount=function(){return S},U.setTrackCount=function(e){S=e;for(var t=O.length;t<S;t++)O.push({});for(t=N.length;t<S;t++)N.push({});Bt.trigger(ue,S)},U.toggleRecord=function(){U.stop(),Bt.trigger(q,a=!a)},U.isPlaying=function(){return l},U.isRecording=function(){return a},U.setStateAtTime=function(e,t){M.push({time:e,state:t})},U.getStateAtTime=function(e){for(var t=void 0,n=0,i=M.length;n<i;n++){if(!(M[0].time<e))return t;t=M.shift().state}return t},U.getTimeStates=function(){return M},U.setPeriodAtTime=function(e,t,n){if(t=Math.max(t,1),U.inFTMode()&&U.useLinearFrequency)var i=8363*Math.pow(2,(4608-t)/768)/Wt.context.sampleRate;else i=e.startPeriod/t,i*=e.startPlaybackRate;e.source.playbackRate.setValueAtTime(i,n),e.source.playbackRate.setValueAtTime(i,n+.005)},U.load=function(o,s,l,t){(o=o||"demomods/StardustMemories.mod").indexOf("://")<0&&0!==o.indexOf("/")&&(o=$t.getBaseUrl()+o),de&&(de.setInfo(""),de.setLoading());function n(e){t&&!$t.useInitialLoad||U.processFile(e,d,function(e){if(de&&de.setStatus("Ready"),e){var t="",n="";if("string"==typeof o){if(0<o.indexOf("modarchive.org")){var i=o.split("moduleid=")[1];b.filename=i.split("#")[1]||i,n="modArchive",t="https://modarchive.org/index.php?request=view_by_moduleid&query="+(i=(i=i.split("#")[0]).split("&")[0]),Bt.trigger($,b)}0<o.indexOf("modules.pl")&&(i=o.split("modules.pl/")[1],b.filename=i.split("#")[1]||i,n="modules.pl",t="http://www.modules.pl/?id=module&mod="+(i=(i=i.split("#")[0]).split("&")[0]),Bt.trigger($,b))}de&&de.setInfo(b.title,n,t)}if(de&&e&&!s){var r=window.location.pathname,a=r.substring(r.lastIndexOf("/")+1);window.history.pushState&&window.history.pushState({},d,a+"?file="+encodeURIComponent(o))}e&&E(s),l&&l()})}var e,i,r,d="";"string"==typeof o?(d=o.substr(o.lastIndexOf("/")+1),e=o,i=function(e){n(e)},(r=new XMLHttpRequest).open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(e){var t=r.response;t&&200===r.status?i&&i(t):void 0!==Jt&&i&&i(!1)},r.send(null)):(d=o.name||"",s=!0,n(o.buffer||o))};var E=function(e){var t=D("autoplay");mn.autoPlay&&(t="1"),!de&&e&&(t="1"),"true"!=t&&"1"!=t||mn.playSong()};return U.handleUpload=function(e){if(e.length){var t=e[0],n=new FileReader;n.onload=function(){U.processFile(n.result,t.name,function(e){de&&de.setStatus("Ready")})},n.readAsArrayBuffer(t)}},U.processFile=function(e,i,r){var t=!1,n=new F(e,!0),a=Un.detect(n,i);a&&"ZIP"==a.name&&(de&&de.setStatus("Extracting Zip file",!0),zip.workerScriptsPath="script/src/lib/zip/",zip.useWebWorkers=$t.useWebWorkers,zip.createReader(new zip.ArrayBufferReader(e),function(e){var t,n=0;e.getEntries(function(e){e&&e.length&&e.forEach(function(e){n<e.uncompressedSize&&(n=e.uncompressedSize,t=e)}),t?t.getData(new zip.ArrayBufferWriter,function(e){e&&e.byteLength&&U.processFile(e,i,r)}):r&&r(!1)})},function(e){r&&r(!1)})),a.isMod&&a.loader&&(t=!0,U.isPlaying()&&U.stop(),s(),(b=a.loader().load(n,i)).filename=i,o()),a.isSample&&void 0!==Jt&&Jt.importSample(n,i),r&&r(t)},U.getSong=function(){return b},U.getInstruments=function(){return d},U.getInstrument=function(e){return d[e]},U.setInstrument=function(e,t){d[t.instrumentIndex=e]=t},U.clearEffectCache=function(){N=[];for(var e=0;e<S;e++)N.push({})},U.clearInstruments=function(e){if(b){var t=[],n=e||b.instruments.length-1;for(d=[],A=1;A<=n;A++)U.setInstrument(A,Gn()),t.push({label:A+" ",data:A});b.instruments=d,Bt.trigger(te,t),Bt.trigger(G,c)}},U.setTrackerMode=function(e){T=e,Lt.emulateProtracker1OffsetBug=!U.inFTMode(),Bt.trigger(he,e)},U.getTrackerMode=function(){return T},U.inFTMode=function(){return T===Ft},U.new=function(){s(),b={patterns:[],instruments:[]},U.clearInstruments(31),b.typeId="M.K.",b.title="new song",b.length=1,b.restartPosition=0,b.patterns.push(v());for(var e=[],t=0;t<128;++t)e[t]=0;b.patternTable=e,o()},U.clearInstrument=function(){d[c]=Gn(),Bt.trigger(G,c),Bt.trigger(ee,c)},U.getFileName=function(){return b.filename||(b.title?b.title.replace(/ /g,"-").replace(/\W/g,"")+".mod":"new.mod")},U.useLinearFrequency=!0,U}(),vn=on={sprites:{},getImage:function(e){return on.sprites[e]?on.sprites[e].canvas:void 0},loadImage:function(e,t){var n=new Image;n.onload=function(){t&&t(n)},n.onerror=function(){},n.src=e}},bn=vn;(de=function(){function e(e){if(!e.length)return 0;for(var t=0,n=0,i=e.length;n<i;n++)t+=e[n];return t/i}var a,o,s,l,d,c,u,t,n,i={},f=[],r=1200,h=!0,g=0,p=0,m=0,v=0,b=0,w=0,x=100,k=[],P=[],y=0,S=!1,_={},C=D("tracks");8==C&&(r=1200),16==C&&(r=1600),32<=C&&(r=3200),i.init=function(t){sn=document.getElementById("canvas2"),ln=sn.getContext("2d");var e=window.innerWidth;r<e&&(e=r),sn.width=e,sn.height=window.innerHeight,ln.fillStyle="black",ln.fillRect(0,0,sn.width,sn.height),de.Assets.preLoad(function(){T(),I();var e=D("file");e?"http://"===(e=decodeURIComponent(e)).substr(0,7).toLowerCase()&&"https:"===document.location.protocol&&(e=qn.proxyUrl(e)):Lt.loadInitialFile&&(e=$t.getBaseUrl()+"demomods/Tinytune.mod"),e&&mn.load(e,!0,void 0,!0),"undefined"!=typeof versionNumber&&Qt.json("package.json?ts="+(new Date).getTime(),function(e){if(e&&e.version&&e.version!==versionNumber){var t=localStorage.getItem("updatemessageshown")||0;if(t=parseInt(t,10),isNaN(t)&&(t=0),window.reload=function(){localStorage.setItem("updatemessageshown",(new Date).getTime()),window.location.reload(!0)},18e5<(new Date).getTime()-t){var n=document.createElement("div");n.className="message",n.innerHTML='A new version of BassoonTracker is available. Please <a href="#" onclick="reload()">refresh your browser</a>',document.body.appendChild(n)}}}),t&&t()})},i.initPlugin=function(e){if(e.canvas)sn=e.canvas;else{sn=document.getElementById("canvas2");var t=window.innerWidth;r<t&&(t=r),sn.width=t,sn.height=window.innerHeight}(ln=sn.getContext("2d")).fillStyle="black",ln.fillRect(0,0,sn.width,sn.height),rn.baseUrl=e.baseUrl,Zt.isPlugin=!0,buildNumber=Math.random(),de.Assets.preLoad(function(){T(),I(),rn.readSettings(),Zt.init(),e.callback&&e.callback()})},i.setSize=function(e,t){r<e&&(e=r),e==sn.width&&t==sn.height||(ln.clearRect(0,0,sn.width,sn.height),i.mainPanel.setSize(sn.width=e,sn.height=t),c&&c.setProperties({width:e,height:t}),h=!0)};var T=function(){var e=bn.getImage("font");(a=kn()).generate({image:e,startX:1,startY:1,charWidth:6,charHeight:6,spaceWidth:6,margin:0,charsPerLine:42,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.+-_#>",onlyUpperCase:!0}),window.fontSmall=a,(o=kn()).generate({image:e,startX:1,startY:110,charWidth:8,charHeight:8,spaceWidth:8,margin:1,charsPerLine:26,lineSpacing:1,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789↑↓-#:.!©_?;()=/+<>&[]{}\\*%$'\"`°,",onlyUpperCase:!0}),o.generateColor("green","rgba(80, 140, 0,0.9)"),o.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontMed=o,(s=kn()).generate({image:e,startX:1,startY:10,charWidth:11,charHeight:11,spaceWidth:11,margin:1,charsPerLine:20,onlyUpperCase:!0}),window.fontBig=s,(l=kn()).generate({image:e,startX:1,startY:145,charHeight:12,spaceWidth:4,margin:1,charsPerLine:[26,26,40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890#©_-&\"'()!.,?+=*$/\\;:[]{}",charWidth:"888888883888998888888899987777757735739777757578987777777777778868864553348767888435555",onlyUpperCase:!1,debug:!0}),window.fontFT=l,(d=kn()).generate({image:e,startX:1,startY:184,charHeight:10,spaceWidth:5,margin:0,charsPerLine:[26,26,10],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",charWidth:"6666556625656666666666666655555455245365555454566555",onlyUpperCase:!1}),window.fontCondensed=d;var t=kn();t.generate({image:e,startX:2,startY:208,charHeight:8,charWidth:4,spaceWidth:4,margin:0,charsPerLine:[45],lineSpacing:0,chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_.-#+><↑↓",onlyUpperCase:!0}),t.generateColor("green","rgba(80, 140, 0,0.9)"),t.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontSuperCondensed=t;var n=kn();n.generate({image:e,startX:107,startY:68,charWidth:8,charHeight:13,spaceWidth:8,margin:0,charsPerLine:20,chars:" 0123456789-"}),window.fontLed=n;var i=kn();i.generate({image:e,startX:9,startY:82,charWidth:14,charHeight:22,spaceWidth:8,margin:0,charsPerLine:11,chars:" 0123456789"}),window.fontLedBig=i;var r=kn();r.generate({image:e,startX:1,startY:216,charHeight:9,spaceWidth:5,margin:0,charsPerLine:[40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890():-",charWidth:"7777667736768777877778887746666666664434",onlyUpperCase:!0}),window.fontDark=r,de.Assets.init(),de.mainPanel=de.MainPanel(),f.push(de.mainPanel),Pn.init()},I=function(e){var t=!0;if(mn.isPlaying()){var n=mn.getStateAtTime(Wt.context.currentTime+.01);n&&(n.patternPos!=_.patternPos&&(mn.setCurrentPatternPos(n.patternPos),_.patternPos=n.patternPos),n.songPos!=_.songPos&&(mn.setCurrentSongPosition(n.songPos),_.songPos=n.songPos))}g&&(t=g<++p);var i=Wt.context?Wt.context.currentTime:0;if(t){var r=1e3/((v=(performance||Date).now())-b);P.push(r),20<P.length&&P.shift(),60<r&&(t=!1)}t&&(p=0,b=v,Bt.trigger(U),h&&(f.forEach(function(e){e.needsRendering&&e.render()}),Bt.trigger(A),c&&(c.render(),h=!1))),i&&(w++,(m=m||i)+1<i&&(u=w/(i-m),x=Math.min(x,u),m=i,w=0,k.push(u),20<k.length&&k.shift(),!S&&5<k.length&&(en.info("fps"),S=!0),Bt.trigger(W))),window.requestAnimationFrame(I)};return i.setModalElement=function(e){c=e},i.getModalElement=function(){return c},i.removeModalElement=function(){c=void 0,de.mainPanel.refresh(),h=!0,window.requestAnimationFrame(I)},i.setSelection=function(e){n=t=e},i.getSelection=function(){return t},i.clearSelection=function(){t&&t(qe)&&(t=void 0)},i.copySelection=function(e){t&&(t(Je),e&&t(qe)),t=void 0},i.cutSelection=function(e){t&&(t(Ze),e&&t(qe)),t=void 0},i.pasteSelection=function(e){!t&&n&&(t=n)($e),t&&(t(Qe),e&&t(qe)),t=void 0},i.showContextMenu=function(e){Bt.trigger(R,e)},i.hideContextMenu=function(){Bt.trigger(V)},i.getChildren=function(){return f},i.getEventElement=function(e,t){for(var n=void 0,i=0,r=f.length;i<r;i++){var a=f[i];if(a.isVisible()&&a.containsPoint(e,t)){n=a;break}}return n&&n.children&&n.children.length&&(n=n.getElementAtPoint(e,t)),n},i.getInternalPoint=function(e,t,n){for(var i={left:0,top:0};n.parent;)i.left+=n.left,i.top+=n.top,n=n.parent;return{x:e-i.left,y:t-i.top}},i.setLoading=function(){i.setStatus("Loading",!0),Bt.trigger(B)},i.setStatus=function(e,t){Bt.trigger(E,{status:e,showSpinner:!!t})},i.setInfo=function(e,t,n){Bt.trigger(E,{info:e,source:t,url:n})},i.stats=function(){return{fps:u,minFps:x,averageFps:e(k),averageRenderFps:e(P),fpsList:k,skipRenderSteps:g}},i.children=f,i.getAverageFps=function(){return 2<k.length?e(k):60},i.resetAverageFps=function(){var e=k.pop();k=e?[e]:[]},i.skipFrame=function(e){Lt.skipFrame=g=e,Bt.trigger(ge,g)},i.getSkipFrame=function(){return g},Bt.on(X,function(){var e=(new Date).getTime();2e3<e-y&&(en.warn("throttling back"),g<4?i.skipFrame(g+1):en.warn("Browser can't keep up"),y=e)}),i}()).app_sidebar=function(){function t(e){var t=c[e];t&&(d.setSelectedIndex(e),u=e,mn.autoPlay=f=!0,mn.load(t.url))}function e(){f&&(c.length<=++u&&(u=0),mn.stop(),t(u))}var n=de.panel(0,0,200,200);n.setProperties({name:"sideBar"});var i=de.scale9Panel(0,0,n.width,n.height,{img:bn.getImage("background"),left:3,top:3,right:4,bottom:4});i.ignoreEvents=!0,n.addChild(i);var r=de.label();r.setProperties({label:"Playlist:",font:fontFT}),n.addChild(r);var a=de.Assets.generate("buttonKey");n.addChild(a),a.onClick=function(){Zt.doCommand(Be)};var o=de.Assets.generate("buttonKey");o.setLabel("Next"),o.onClick=function(){e()};var s=de.Assets.generate("buttonKey");s.setLabel("Toggle UI"),s.onClick=function(){};var l=de.scale9Panel(0,0,n.width,n.height,{img:bn.getImage("background"),left:3,top:3,right:4,bottom:4});l.ignoreEvents=!0,n.addChild(l),n.addChild(o),n.addChild(s);var d=de.listbox(2,50,100,100);d.setProperties({font:window.fontFT}),n.addChild(d);var c=[{label:"Demomusic",url:"demomods/demomusic.mod"},{label:"Stardust Memories",url:"demomods/StardustMemories.mod"},{label:"Space Debry",url:"demomods/spacedeb.mod"}],u=0,f=!1;d.onChange=function(e){},d.onClick=function(){var e=d.getItemAtPosition(d.eventX,d.eventY);e&&e.url&&t(e.index)},n.onResize=function(){i.setSize(n.width,n.height),a.setPosition(n.width-22,2),r.setSize(n.width,xn.trackControlHeight),l.setPosition(2,32),l.setSize(n.width-4,54),o.setPosition(8,36),o.setProperties({width:n.width<50?20:100}),o.setLabel(n.width<50?">":"Next"),s.setPosition(8,56),s.setProperties({width:n.width<50?20:100}),s.setLabel(n.width<50?"-":"Toggle UI");d.setProperties({left:2,top:88,width:n.width-4,height:n.height-88-xn.defaultMargin}),n.width<50?(r.hide(),l.hide(),d.hide(),o.setPosition(2,36)):(r.show(),l.show(),d.show())},Bt.on(ie,function(){e()}),n.onResize();var h="demomods/Playlist/";return Qt.get(h+"list.txt",function(e){(e=e.split("\n")).forEach(function(e){e&&c.push({label:e,url:h+e})}),c.forEach(function(e,t){e.index=t}),u=0,f=!1,d.setItems(c)}),n},de.buttonGroup=function(e,t){var o=de.panel();o.hide();var s=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);s.ignoreEvents=!0,o.addChild(s);var n=de.label({label:e,font:fontSmall,width:60,top:1});o.addChild(n);var l=[];return t.forEach(function(t){if("number"===t.type){var n=de.numberDisplay();n.setValue(t.value)}else(n=de.Assets.generate("buttonLight")).setLabel(t.label),n.onClick=t.onClick;n.widthParam=t.width||100,o.addChild(n),l.push(n),t.onSamplePropertyChange&&Bt.on(N,function(e){t.onSamplePropertyChange(n,e)})}),o.onResize=function(){s.setSize(o.width,18);var n=20,i=(o.height-n-2)/4,r=o.width,a=0;l.forEach(function(e,t){e.setProperties({width:Math.floor(r*e.widthParam/100),height:i,left:Math.floor(a*r/100),top:n}),95<(a+=e.widthParam)&&(a=0,n+=i)})},o},de.pattern_sidebar=function(){var i=de.panel();i.setProperties({name:"sideButtonPanel"});var r=de.label();r.setProperties({label:"DEMOSONGS:",font:fontFT}),i.addChild(r);for(var a=[],o=[{label:"Demomusic",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/demomusic.mod")}},{label:"Stardust",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/StardustMemories.mod")}},{label:"Space Debris",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/spacedeb.mod")}},{label:"Tinytune",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/Tinytune.mod")}},{label:"Lotus 2",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/lotus20.mod")}},{label:"Professionaltracker",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/hoffman_and_daytripper_-_professional_tracker.mod")}},{label:"XM: Ambrozia",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/Ambrozia.xm")}},{label:"8CHN: AceMan",onClick:function(){mn.load($t.getRemoteUrl()+"demomods/AceMan.mod")}},{label:"Random MOD",onClick:function(){Zt.doCommand(Te)}},{label:"Random XM",onClick:function(){Zt.doCommand(Ie)}}],s=0;s<o.length;s++){var e=o[s],t=de.button();t.info=e,t.onClick=e.onClick,i.addChild(a[s]=t)}var l=de.button();return l.setProperties({label:"",textAlign:"center",background:de.Assets.buttonLightScale9,hoverBackground:de.Assets.buttonLightHoverScale9,image:bn.getImage("piano"),font:window.fontMed}),l.onClick=function(){Zt.doCommand(Se)},i.addChild(l),i.onResize=function(){r.setSize(i.width,xn.trackControlHeight);for(l.setProperties({left:0,top:i.height-30,width:i.width,height:30}),s=0;s<o.length;s++){var e=a[s],t=30*s+r.height,n=0;l.top-30<t&&(n=-500),e.setProperties({left:n,top:t,width:i.width,height:30,label:e.info.label,textAlign:"left",background:de.Assets.buttonLightScale9,hoverBackground:de.Assets.buttonLightHoverScale9,font:window.fontFT})}},i.onResize(),i},de.app_patternView=function(e,t,n,u){function B(e,t,n){if(mn.inFTMode())var i="i"+e.index+"."+N.charWidth;else i="p"+e.period+"."+N.charWidth;if(!d[i]){var r=document.createElement("canvas");r.height=Z,r.width=3*N.charWidth+2;var a=r.getContext("2d");if(mn.inFTMode())if(e.index){var o=gn[e.index];97===e.index&&(o=gn[rt]);var s=o?o.name:"???"}else{s="---";var l=pn[e.period];l&&(o=gn[l])&&(s=o.name)}else s=(l=cn[e.period])?l.name:"---";N.write(a,s,0,0,0),d[i]=r}Y.ctx.drawImage(d[i],t,n)}function W(e,t,n){t+=3*N.charWidth+4;var i="n"+e.instrument+"."+(H?e.volumeEffect:"")+"."+e.effect+"."+e.param+"."+N.charWidth;if(!h[i]){var r=document.createElement("canvas");r.height=Z,r.width=7*N.charWidth+10;var a=r.getContext("2d"),o=f(e.instrument,2,"0");"00"==o&&(o="..");var s=0;if(N.write(a,o,s,0,0,"green"),H){s+=2*N.charWidth+4;var l=e.volumeEffect||0;if(l&&(l-=16),l<80)o=f(l,2,"0");else{var d=(l>>4).toString(16).toUpperCase(),c=(15&l).toString(16).toUpperCase();o=(d={5:"-",6:"+",7:"↓",8:"↑",9:"S",A:"V",B:"P",C:"<",D:">",E:"M"}[d]||d)+c}e.volumeEffect||(o=".."),N.write(a,o,s,0,0)}s+=2*N.charWidth+4,o=(15<e.effect?function(e,t,n){if(u=e.toString(36).toUpperCase(),t&&u.length<t)for(n=n||"0";u.length<t;)u=n+u;return u}:f)(e.effect),"000"===(o+=f(e.param,2,"0"))&&(o="..."),N.write(a,o,s,0,0,"orange"),h[i]=r}Y.ctx.drawImage(h[i],t,n)}function R(e,t,n,i,r){if(mn.isPlaying()&&e&&e.period&&p[i]!==r){var a=100;if(12===e.effect)a=100*e.param/64;else{var o=mn.getInstrument(e.instrument);o&&(a=100*o.sample.volume/64)}ae[i]=a,p[i]=r}if(ae[i]){X=!0;var s=ae[i]*se/100,l=100*s/se;if("colour"===Lt.vubars){var d=bn.getImage("vubar");Y.ctx.drawImage(d,0,100-l,26,l,t,n-s,10,s)}else"trans"===Lt.vubars&&(Y.ctx.fillStyle="rgba(120,190,255,0.3)",Y.ctx.fillRect(t,n-s,10,s));ae[i]-=oe,ae[i]<0&&(ae[i]=0)}}function U(e,t,n){var i=""+e;e<10&&(i="0"+i);var r=i+"."+N.charWidth;if(!l[r]){var a=document.createElement("canvas");a.height=Z,a.width=3*N.charWidth;var o=a.getContext("2d"),s=!1;e%4==0&&(s="orange"),N.write(o,i,0,0,0,s),l[r]=a}Y.ctx.drawImage(l[r],t,n)}function f(e,t,n){if(u=e.toString(16).toUpperCase(),t&&u.length<t)for(n=n||"0";u.length<t;)u=n+u;return u}function V(){var e=mn.getCurrentPatternPos()||0;if(q){var t=1,n=Y.height-2,i=n;r=0,1<O&&((i=Math.floor(q/O*n))<12&&(i=12),r=(n-i)/(O-1)),e&&r&&(t=Math.floor(1+r*e)),ne.setProperties({left:Y.width-16,top:t,width:16,height:i})}}function z(){var e=Y.width,t=Math.floor(e/mn.getTrackCount()*K),n=(e-t)/(mn.getTrackCount()-K),i=Y.height-20;K>=mn.getTrackCount()&&(i=-200),ie.setProperties({top:i,width:t,left:0+Math.floor(Q*n)})}function s(){ee={start:[$.start[0],$.start[1]],end:[$.end[0],$.end[1]]};for(var e=0;e<2;e++)$.end[e]<$.start[e]&&(ee.start[e]=$.end[e],ee.end[e]=$.start[e])}function i(e){te?($.end=[mn.getCurrentPatternPos(),Jt.getCurrentTrack()],s()):($.start=[e.prev||0,Jt.getCurrentTrack()],$.end=[e.current,Jt.getCurrentTrack()],$.top=$.left=1e5,s(),te=!0,Y.showSelectionUI()),Y.refresh()}var O,N,H,X,G,j,Y=de.panel(e,t,n,u),q=0,K=8,Z=13,J=0,r=0,Q=0,d={},h={},l={},$={},ee={},c=[],te=!1,ne=de.scale9Panel(n-28,18,16,u-3,{img:bn.getImage("bar"),left:2,top:2,right:3,bottom:3});ne.onDragStart=function(){mn.isPlaying()||(ne.startDragIndex=mn.getCurrentPatternPos())},ne.onDrag=function(e){if(!mn.isPlaying()&&q&&r){var t=Math.floor(ne.startDragIndex+e.deltaY/r);t=Math.min(t,O-1),t=Math.max(t,0),mn.setCurrentPatternPos(t)}},Y.addChild(ne),V();var ie=de.scale9Panel(n-28,18,16,16,{img:bn.getImage("bar"),left:2,top:2,right:3,bottom:3});ie.onDragStart=function(){ie.startDragIndex=Q},ie.onDrag=function(e){var t=mn.getTrackCount()-K,n=Math.floor(e.deltaX/((Y.width-ie.width)/t));Y.setHorizontalScroll(ie.startDragIndex+n),Y.onResize()},Y.addChild(ie);for(var re=[],a=0,o=mn.getTrackCount();a<o;a++){var g=de.fxPanel(a);re.push(g),Y.addChild(g)}var ae=[],p=[],oe=5,se=70;return Y.setHorizontalScroll=function(e){var t=mn.getTrackCount()-K;e!=Q&&0<=e&&e<=t&&(Bt.trigger(w,Q=e),z())},Y.onResize=function(){G=xn.firstTrackOffsetLeft,j=xn.trackMargin;var e=Y.height;(K=xn.visibleTracks)<mn.getTrackCount()&&(e-=24);for(var t=0;t<K;t++){if((g=re[Q+t])&&g.visible)g.setPosition(G+t*(xn.trackWidth+j),0),g.setSize(xn.trackWidth,e),g.setLayout(),g.show()}},Y.render=function(){if(Y.isVisible()){if(this.needsRendering){Y.clearCanvas();var e=mn.getCurrentPattern()||0,t=mn.getCurrentPatternPos()||0,n=mn.getSong();if(!n)return;N=xn.trackFont,O=mn.getPatternLength();var i=K<mn.getTrackCount(),r=Y.height-30,a=(H=mn.inFTMode())?92:72,o=9,s=28;xn.useCondensedTrackFont&&(a=H?46:36,o=5,s=15);var l=10,d=Math.floor((xn.trackWidth-a)/2)+l,c=!1;G&&(c=!(d=l=0)),i&&(r-=24),(q=Math.ceil(r/Z))%2==0&&q--;var u=Math.floor(q/2),f=t-u,h=f+q,g=Z+2,p=(J=Math.floor((r+g)/2))-u*Z+4,m=J,v=J+g,b=le.darkPanel;if(!b&&bn.getImage("panel_dark")){var w=de.scale9Panel(0,0,xn.trackWidth,m,{img:bn.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});le.darkPanel=w.render(!0),b=le.darkPanel}var x=[];X=!1,m<se&&(oe=(se=m)/10);for(var k=0;k<K;k++){var P=Q+k;if(x[P]=!(re[P]&&re[P].visible),x[P]){var y=G+k*(xn.trackWidth+j);Y.ctx.drawImage(b,y,0,xn.trackWidth,m),Y.ctx.drawImage(b,y,v,xn.trackWidth,m),re[P]&&(re[P].left=y)}}var S=n.patterns[e];if(S){mn.isRecording()?Y.ctx.fillStyle="#A50B0F":Y.ctx.fillStyle="#202E58",Y.ctx.fillRect(0,J,+Y.width,g);var _,C=Jt.getCurrentTrackPosition(),T=o;_=c?(y=G+(Jt.getCurrentTrack()-Q)*(xn.trackWidth+j))+Math.floor((xn.trackWidth-a)/2)+C*T-1:G+d+(Jt.getCurrentTrack()-Q)*xn.trackWidth+C*T-1,0<C?(_+=2*T+1,2<C&&(_+=2),4<C&&H&&(_+=2)):T=s,Y.ctx.fillStyle="rgba(220,220,220,.3)",Y.ctx.fillRect(_,J,T,Z+2),Y.ctx.fillStyle="rgba(200,150,70,.3)";var I=8*N.charWidth+14;H&&(I+=2*N.charWidth+2);for(k=f;k<h;k++)if(0<=k&&k<mn.getPatternLength()){var M=S[k],A=p+(k-f)*Z,E=!0;A<J&&(A-=3,E=!1),J+Z<A&&(A+=3,E=!1),U(k,l,A),E&&(U(k,l,A),U(k,l,A));for(var D=0;D<K;D++)if(x[P=D+Q]&&P<mn.getTrackCount()){var F,L=M[P]||jn();F=c?(y=G+D*(xn.trackWidth+j))+(xn.trackWidth-a>>1):G+d+D*xn.trackWidth,te&&ee.start[0]<=k&&k<=ee.end[0]&&ee.start[1]<=P&&P<=ee.end[1]&&($.top=Math.min($.top,A-2),$.left=Math.min($.left,F-2),Y.ctx.fillRect(F-2,A-2,I,Z)),E&&(B(L,F,A),B(L,F,A),(mn.isPlaying()||ae[D]&&"none"!==Lt.vubars)&&R(L,F-12,J,D,e+"."+t)),B(L,F,A),W(L,F,A)}X&&setTimeout(function(){Y.refresh()},20)}}for(D=0;D<K;D++)x[P=D+Q]||re[P].render();for(V(),ne.render(),i&&(z(),ie.render()),D=0;D<K;D++)x[P=D+Q]&&N.write(Y.ctx,""+(P+1),y=G+D*(xn.trackWidth+j)+2,2,0,void 0)}this.needsRendering=!1,Y.parentCtx.drawImage(Y.canvas,Y.left,Y.top,Y.width,Y.height)}},Y.onMouseWheel=function(e){if(!mn.isPlaying()){var t=mn.getCurrentPatternPos();0<e.mouseWheels[0]?t&&mn.moveCurrentPatternPos(-1):t<O-1&&mn.moveCurrentPatternPos(1)}},Y.onDragStart=function(e){if(ie.startDragIndex=Q,!mn.isPlaying()&&(Y.startDragPos=mn.getCurrentPatternPos(),e.isMeta||mn.isRecording())){var t=Math.floor((e.x-xn.firstTrackOffsetLeft)/(xn.trackWidth+xn.trackMargin)),n=Jt.getStepsPerTrack();Jt.setCurrentCursorPosition((Q+t)*n),de.clearSelection(),Y.startDragTrackX=t*(xn.trackWidth+xn.trackMargin)+xn.firstTrackOffsetLeft;var i=Math.floor((e.y-J)/Z);$.start=[mn.getCurrentPatternPos()+i,Jt.getCurrentTrack()],$.end=$.start,$.top=$.left=1e5,Y.refresh()}},Y.onDrag=function(e){if(K<mn.getTrackCount()&&!e.isMeta&&!mn.isRecording()){var t=mn.getTrackCount()-K,n=e.deltaX,i=Math.floor(n/((Y.width-ie.width)/t));Y.setHorizontalScroll(ie.startDragIndex-i)}if(!mn.isPlaying()){n=Math.round(e.deltaY/Z);var r=Y.startDragPos-n;if(r=Math.max(r,0),r=Math.min(r,O-1),e.isMeta||mn.isRecording()){te=!0,n=Math.floor(e.deltaY/Z);var a=Math.floor(e.deltaX/xn.trackWidth);$.end=[$.start[0]+n,Jt.getCurrentTrack()+a],s(),Y.refresh()}else mn.setCurrentPatternPos(r)}},Y.onTouchUp=function(){te&&Y.showSelectionUI()},Y.onClick=function(e){var t=Math.floor((e.x-xn.firstTrackOffsetLeft)/(xn.trackWidth+xn.trackMargin)),n=Jt.getStepsPerTrack();Jt.setCurrentCursorPosition((Q+t)*n)},Y.getStartTrack=function(){return Q},Y.processSelection=function(e){if(Y.isVisible())switch(e){case qe:return te=!1,de.hideContextMenu(),Y.refresh(),!0;case Ke:if((a=mn.getCurrentPatternData())&&te)for(var t=ee.start[0];t<=ee.end[0];t++)for(var n=a[t],i=ee.start[1];i<=ee.end[1];i++){(o=n[i])&&o.clear()}Y.refresh();break;case Je:case Ze:if(c=[],(a=mn.getCurrentPatternData())&&te)for(t=ee.start[0];t<=ee.end[0];t++){if(n=a[t]){var r=[];for(i=ee.start[1];i<=ee.end[1];i++){(o=n[i])&&r.push(o.duplicate())}c.push(r)}}if(e===Ze&&te)for(t=ee.start[0];t<=ee.end[0];t++){if(n=a[t])for(i=ee.start[1];i<=ee.end[1];i++){(o=n[i])&&o.clear()}}Y.refresh();break;case Qe:var a;if((a=mn.getCurrentPatternData())&&te&&c.length)for(t=0;t<c.length;t++){r=c[t];if(n=a[ee.start[0]+t])for(i=0;i<r.length;i++){var o;(o=n[ee.start[1]+i])&&o.populate(r[i])}}Y.refresh();break;case $e:$.start=$.end=[mn.getCurrentPatternPos(),Jt.getCurrentTrack()],s(),te=!0,Y.refresh()}},Y.showSelectionUI=function(){de.setSelection(Y.processSelection),de.showContextMenu({name:"patternActions",items:[{label:"Clear",onClick:function(){Y.processSelection(Ke)}},{label:"Cut",onClick:function(){Y.processSelection(Ze)}},{label:"Copy",onClick:function(){Y.processSelection(Je)}},{label:"Paste",onClick:function(){Y.processSelection(Qe)}}],x:$.left+Y.left+Y.parent.left,y:$.top+Y.top+Y.parent.top})},Bt.on(ce,function(e){!Pn.isMetaKeyDown()||mn.isRecording()||mn.isPlaying()||i(e)}),Bt.on(v,function(e){!Pn.isMetaKeyDown()||mn.isRecording()||mn.isPlaying()||i({current:mn.getCurrentPatternPos(),prev:mn.getCurrentPatternPos()})}),Bt.on(ue,function(e){K<e&&(K=e),Q=Math.min(Q,e-K),Q=Math.max(Q,0);for(var t=re.length,n=e;t<n;t++){var i=de.fxPanel(t);re.push(i),Y.addChild(i)}Y.onResize(),Y.refresh()}),Bt.on(fe,function(){Y.setHorizontalScroll(0)}),Bt.on(P,function(){Q=0,Y.onResize(),Y.refresh()}),Bt.on(he,function(){Y.refresh()}),Bt.on(m,function(e){if((g=re[e]).visible)g.hide();else{var t=Y.height;K<mn.getTrackCount()&&(t-=24),g.setPosition(g.left,0),g.setSize(xn.trackWidth,t),g.setLayout(),g.show()}Y.refresh()}),Bt.on(ge,function(e){oe=5*(e+1)}),Bt.on(pe,function(){Y.isVisible()&&(de.clearSelection(),$.start=[0,Jt.getCurrentTrack()],$.end=[mn.getCurrentPatternData().length-1,Jt.getCurrentTrack()],s(),te=!0,$.top=$.left=1e5,Y.showSelectionUI(),Y.refresh())}),Y},de.app_songControl=function(e,t,n,i,r){var a=de.element(e,t,n,i,r);a.type="songControl";var o=de.radioGroup();o.setItems([{label:"song",active:!0},{label:"pattern",labels:[{width:10,label:"p"},{width:20,label:"pat"}],active:!1}]),o.onChange=function(e){mn.setPlayType(0==e?We:Re)},a.addChild(o);var s={};s.play=de.Assets.generate("buttonDarkGreen"),s.play.setProperties({image:bn.getImage("play_green"),hoverImage:bn.getImage("play_green_hover"),activeImage:bn.getImage("play_active_red"),activeBackground:de.Assets.buttonDarkRedActiveScale9}),s.play.onClick=function(){s.play.toggleActive(),mn.isPlaying()?mn.stop():mn.getPlayType()==We?mn.playSong():mn.playPattern()},s.play.setProperties({name:"buttonPlay"}),a.addChild(s.play),s.record=de.Assets.generate("buttonDarkRed"),s.record.setProperties({image:bn.getImage("record"),hoverImage:bn.getImage("record_hover"),activeImage:bn.getImage("record_active")}),s.record.onClick=function(){mn.toggleRecord()},s.record.setProperties({name:"buttonRecord"}),a.addChild(s.record),s.song=de.Assets.generate("buttonDark"),s.song.onClick=function(){mn.playSong()},s.song.setProperties({label:"Song"}),a.addChild(s.song),s.pattern=de.Assets.generate("buttonDark"),s.pattern.onClick=function(){mn.playPattern()},s.pattern.setProperties({label:"Pattern"}),a.addChild(s.pattern),Bt.on(q,function(e){s.record.setActive(e)}),Bt.on(K,function(e){s.play.setActive(e)}),Bt.on(Z,function(e){o.setSelectedIndex(e==We?0:1,!0)});var l=["left","top","width","height","name","type","songPatternSelector"];return a.setProperties=function(t){l.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top);var e=Math.floor(a.width/3);o.setProperties({left:0,width:e,top:0,height:a.height,align:"right"}),s.play.setProperties({left:e,width:e,top:0,height:a.height}),s.record.setProperties({left:2*e,width:e,top:0,height:a.height}),"big"==a.songPatternSelector&&(o.left=-500,e=Math.floor(a.width/4)+1,s.play.setProperties({left:0,width:e}),s.record.setProperties({left:e,width:e}),s.song.setProperties({left:2*e,width:e,top:0,height:a.height}),s.pattern.setProperties({left:3*e,width:e,top:0,height:a.height}))},a.render=function(e){if(e=!!e,a.needsRendering&&(a.clearCanvas(),"small"==a.songPatternSelector&&o.render(),s.play.render(),s.record.render(),"big"==a.songPatternSelector&&(s.song.render(),s.pattern.render())),a.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)},a},de.app_songPatternList=function(e){function a(e){return(e=""+e).length<2&&(e="0"+e),e}var t=de.panel(),n=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);t.addChild(n);var o=de.listbox();o.setItems([{label:"01:00",data:1}]),o.onClick=function(){var e=o.getItemAtPosition(o.eventX,o.eventY);if(e){var t=e.index;e!==o.getSelectedIndex()&&o.setSelectedIndex(t)}},t.addChild(o);var i=de.Assets.generate("button20_20");i.setLabel("↑"),i.onDown=function(){var e=o.getSelectedIndex(),t=mn.getSong().patternTable[e];mn.updatePatternTable(e,++t),de.ticker.onEachTick4(function(){var e=o.getSelectedIndex(),t=mn.getSong().patternTable[e];mn.updatePatternTable(e,++t)},5)},i.onTouchUp=function(){de.ticker.onEachTick4()},t.addChild(i);var r=de.Assets.generate("button20_20");return r.setLabel("↓"),r.onDown=function(){var e=o.getSelectedIndex(),t=mn.getSong().patternTable[e];0<t&&t--,mn.updatePatternTable(e,t),de.ticker.onEachTick4(function(){var e=o.getSelectedIndex(),t=mn.getSong().patternTable[e];0<t&&t--,mn.updatePatternTable(e,t)},5)},r.onTouchUp=function(){de.ticker.onEachTick4()},t.addChild(r),t.onResize=function(){n.setSize(t.width,t.height),o.setProperties({left:0,top:0,width:t.width-42,height:t.height,centerSelection:!0,onChange:function(){mn.setCurrentSongPosition(o.getSelectedIndex(),!0)}}),r.setPosition(t.width-22,Math.floor(t.height/2)-10),i.setPosition(t.width-42,r.top)},Bt.on(Y,function(e){t.setPatternTable(mn.getSong().patternTable)}),t.setPatternTable=function(e){for(var t=[],n=0,i=mn.getSong().length;n<i;n++){var r=e[n];t.push({label:a(n+1)+":"+a(r),data:r,index:n})}o.setItems(t)},Bt.on(fe,function(e){t.setPatternTable(e.patternTable)}),Bt.on(J,function(e){o.setSelectedIndex(e,!0)}),t},de.trackControl=function(e,t,n,i,r){function a(e){Bt.trigger(b,{track:o.track,solo:s.solo.isActive,mute:s.mute.isActive,wasSolo:e})}var o=de.element(e,t,n,i,r);o.type="trackControl",o.track=0;var s={};s.solo=de.Assets.generate("buttonDark"),s.solo.setProperties({activeImage:bn.getImage("solo.png"),activeBackground:de.Assets.buttonDarkGreenActiveScale9}),s.solo.onClick=function(){var e=s.solo.isActive;s.solo.toggleActive(),s.mute.isActive&&s.mute.toggleActive(),a(e)},s.solo.setProperties({name:"buttonSolo",label:"S"}),o.addChild(s.solo),s.mute=de.Assets.generate("buttonDark"),s.mute.setProperties({activeImage:bn.getImage("mute"),activeBackground:de.Assets.buttonDarkRedActiveScale9}),s.mute.onClick=function(){s.mute.toggleActive(),s.solo.isActive&&s.solo.toggleActive(),a()},s.mute.setProperties({name:"buttonMute",label:"M"}),o.addChild(s.mute),s.fx=de.Assets.generate("buttonDark"),s.fx.onClick=function(){s.fx.toggleActive(),Bt.trigger(m,o.track)},s.fx.setProperties({name:"buttonFX",label:"FX"}),o.addChild(s.fx);var l=["left","top","width","height","name","type","track","solo","mute","visible"];return o.setProperties=function(t){l.forEach(function(e){if(void 0!==t[e])switch(e){case"solo":s.mute.isActive&&s.mute.setActive(!1),s.solo.setActive(t[e]),a();break;case"mute":s.solo.isActive&&s.solo.setActive(!1),s.mute.setActive(t[e]),a();break;default:o[e]=t[e]}}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top);var e=Math.floor(o.width/3)+1;s.solo.setProperties({left:0,width:e,top:0,height:o.height}),s.mute.setProperties({left:e-1,width:e,top:0,height:o.height}),s.fx.setProperties({left:2*e-2,width:e,top:0,height:o.height})},o.render=function(e){if(o.isVisible()){if(e=!!e,o.needsRendering&&(o.clearCanvas(),o.ctx.fillStyle="white",o.ctx.fillText("",10,10),s.solo.render(),s.mute.render(),s.fx.render()),o.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)}},Bt.on(S,function(e){e===o.track&&s.mute.onClick()}),o},de.visualiser=function(){function i(){m=[];var e=mn.getTrackCount(),t=h.height;4<mn.getTrackCount()&&(e=Math.ceil(mn.getTrackCount()/2),t=h.height/2);for(var n=h.width/e,i=0;i<mn.getTrackCount();i++){var r=i*n,a=0;e<=i&&(r=(i-e)*n,a=h.height-t),m[i]={left:Math.floor(r),top:Math.floor(a),width:Math.floor(n),height:Math.floor(t),lineLeft:Math.ceil(r+n/70),lineWidth:Math.floor(n-n/30)}}}var r,f,h=de.panel(),e=["wave","spectrum","tracks"],t=2,a=e[t],g=[],p=[],m=[],v=256;h.ctx.fillStyle="black",h.ctx.lineWidth=2,h.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",h.init=function(){function n(){var e=Wt.context.createAnalyser();e.smoothingTimeConstant=0,e.fftSize=v,g.push(e)}if(Wt.context){(r=Wt.context.createAnalyser()).minDecibels=-90,r.maxDecibels=-10,r.smoothingTimeConstant=.85;for(var e=0;e<mn.getTrackCount();e++)n();i()}f=bn.getImage("oscilloscope"),Bt.on(y,function(e){for(var t=g.length;t<e;t++)n();i(),h.connect()}),Bt.on(b,function(e){void 0!==e.track&&(p[e.track]=e.mute)}),h.needsRendering=!0},h.connect=function(e){if(Wt.context){e&&e.connect(r);for(var t=0;t<mn.getTrackCount();t++)Wt.filterChains[t].output().connect(g[t])}},h.nextMode=function(){e.length<=++t&&(t=0),a=e[t]};return h.render=function(){Wt.context&&h.isVisible()&&function(){h.ctx.clearRect(0,0,h.width,h.height),h.ctx.lineWidth=2,h.ctx.strokeStyle="rgba(120, 255, 50, 0.5)";for(var e,t,n=!Wt.cutOff,i=0;i<mn.getTrackCount();i++){var r=g[i],a=m[i],o=p[i];if(h.ctx.drawImage(f,a.left,a.top,a.width,a.height),r){var s;h.ctx.beginPath();var l=a.lineLeft,d=a.lineWidth;if(n&&!o){r.fftSize=v,e=r.fftSize,t=new Uint8Array(e),r.getByteTimeDomainData(t);for(var c=d/e,u=0;u<e;u++){s=t[u]/128*a.height/2+a.top,0===u?h.ctx.moveTo(l,s):h.ctx.lineTo(l,s),l+=c}}else h.ctx.moveTo(l,s=a.height/2+a.top),h.ctx.lineTo(l+d-1,s);h.ctx.stroke(),o&&(h.ctx.fillStyle="rgba(34, 49, 85, 0.5)",h.ctx.fillRect(a.left,a.top,a.width,a.height))}}ln.drawImage(h.canvas,h.left,h.top)}()},h.init(),h.onResize=function(){i()},Bt.on(A,function(){h.render()}),Bt.on(W,function(){mn.isPlaying()&&de.getAverageFps()<32&&32<v&&(v>>=1,v=Math.max(v,32),de.resetAverageFps())}),h.onClick=function(e){if("tracks"===a)for(var t=0;t<mn.getTrackCount();t++){var n=m[t],i=e.x,r=e.y;if(n.left<i&&i<n.left+n.width&&n.top<r&&r<n.top+n.height){Bt.trigger(S,t);break}}},h},de.vumeter=function(){function t(){u.width=f.width=c,u.height=f.height=6;var e=Math.floor(c/12);h.clearRect(0,0,u.width,u.height),g.clearRect(0,0,f.width,f.height);for(var t=0;t<e;t++){var n=p,i=m;e/3<=t&&(n=v,i=b),e/1.5<=t&&(n=w,i=x),h.drawImage(n,12*t,0,10,6),g.drawImage(i,12*t,0,10,6)}d.ctx.fillStyle="#253352"}function r(e){for(var t=e.length,n=128,i=128,r=0;r<t;r++){var a=e[r];a<n?n=a:i<a&&(i=a)}return(i-n)/255}var a,o,s,l,d=de.panel();d.left=400,d.top=7,Wt.context&&((a=Wt.context.createAnalyser()).minDecibels=-90,a.maxDecibels=-10,a.smoothingTimeConstant=.85,(o=Wt.context.createAnalyser()).minDecibels=-90,o.maxDecibels=-10,o.smoothingTimeConstant=.85,o.fftSize=a.fftSize=32,l=new Uint8Array(a.fftSize));var c=500,u=document.createElement("canvas"),f=document.createElement("canvas"),h=u.getContext("2d"),g=f.getContext("2d"),p=bn.getImage("vu_green"),m=bn.getImage("vu_green_active"),v=bn.getImage("vu_yellow"),b=bn.getImage("vu_yellow_active"),w=bn.getImage("vu_red"),x=bn.getImage("vu_red_active");return d.setSize(c,16),t(),d.needsRendering=!0,d.connect=function(e){if(Wt.context){var t=Wt.context.createChannelSplitter(2);e.connect(t),t.connect(a,0),t.connect(o,1),s=!0}},d.setProperties=function(e){c=e.width,d.left=e.left,d.setSize(c,16),t()},d.render=function(){if(s){a.getByteTimeDomainData(l);var e=r(l)*(Math.E-1);o.getByteTimeDomainData(l);var t=r(l)*(Math.E-1);d.ctx.fillRect(0,0,d.width,d.height),d.ctx.drawImage(u,0,0),d.ctx.drawImage(u,0,10);var n=Math.min(Math.floor(e*c),c),i=Math.min(Math.floor(t*c),c);n&&d.ctx.drawImage(f,0,0,n,6,0,0,n,6),i&&d.ctx.drawImage(f,0,0,i,6,0,10,i,6),ln.drawImage(d.canvas,d.left,d.top)}},Bt.on(A,function(){d.render()}),d};var wn,xn=wn={defaultMargin:4,showAppSideBar:!(de.app_controlPanel=function(){var d=de.app_panelContainer(40),c=de.app_songControl();d.addChild(c);var u=de.checkboxbutton({label:"File",onDown:function(){Bt.trigger(O,this.isActive?"diskop_load":"topmain")}}),f=de.checkboxbutton({label:"Options",onDown:function(){Bt.trigger(O,this.isActive?"options":"topmain")}}),h=de.checkboxbutton({label:"Sample Edit",onDown:function(){Bt.trigger(O,this.isActive?"sample":"bottommain")}});d.addChild(u),d.addChild(f),d.addChild(h);var n={background:de.Assets.buttonKeyScale9,hoverBackground:de.Assets.buttonKeyHoverScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},g=de.button(),p=de.button();g.setProperties(n),g.setLabel("mod"),g.onDown=function(){mn.setTrackerMode(Dt)},d.addChild(g),p.setProperties(n),p.setLabel("XM"),p.onDown=function(){mn.setTrackerMode(Ft)},d.addChild(p);var m=[4,8,12,16],v=[];m.forEach(function(e){v.push(de.button())}),v.forEach(function(e,t){e.setProperties(n),e.setLabel(""+m[t]),e.index=t,e.onDown=function(){if(!this.isDisabled){var n=this.index;v.forEach(function(e,t){e.setActive(t===n)}),xn.setVisibleTracks(m[n])}},d.addChild(e)});var b=de.label();b.setProperties({label:"Mode",labels:[{width:20,label:""},{width:78,label:"M"},{width:84,label:"Md"},{width:100,label:"Mode"}],font:fontSmall,width:100,height:20,textAlign:"right"}),d.addChild(b);var w=de.label();w.setProperties({label:"Display",labels:[{width:10,label:""},{width:78,label:"t"},{width:84,label:"tr"},{width:100,label:"trck"},{width:120,label:"Display"}],font:fontSmall,width:100,height:20,textAlign:"right"}),d.addChild(w);var x=de.spinBox();return x.setProperties({name:"Pattern",value:mn.getTrackCount(),max:32,min:2,size:"big",onChange:function(e){mn.setTrackCount(e)}}),d.addChild(x),d.onPanelResize=function(){d.innerHeight=d.height-2*xn.defaultMargin;var e=xn.defaultMargin,t=xn.defaultMargin;if("2row"===xn.controlPanelButtonLayout){var n=Math.floor((d.innerHeight-xn.defaultMargin)/2);t=d.height-n-xn.defaultMargin,d.innerHeight=n}c.setProperties({left:xn.col1X,top:e,width:xn.songControlWidth,height:d.innerHeight,songPatternSelector:"small"});var i=xn.col1W-60;i=Math.max(i,120);var r=Math.floor((xn.col1W-i)/2),a=xn.col4X+r,o="Sample Edit";"1row"!==xn.controlPanelButtonLayout&&(i=Math.floor(xn.controlPanelButtonsWidth/3),r=0,a=xn.controlPanelButtonsLeft+2*i,o="Sample");var s=d.innerHeight;u.setProperties({left:xn.controlPanelButtonsLeft+1.5*r,top:t,width:i,height:s}),f.setProperties({left:u.left+i+r,top:t,width:i,height:s}),h.setProperties({left:a,top:t,width:i,height:s,label:o}),g.setProperties({left:xn.modeButtonsLeft+(xn.modeButtonsWidth-101),top:e,width:51,height:16}),p.setProperties({left:g.left+g.width-1,top:g.top,width:g.width,height:g.height});var l=g.left;v.forEach(function(e,t){e.setProperties({left:l,top:g.top+g.height,width:26,height:g.height}),l+=e.width-1,e.setActive(m[t]===xn.visibleTracks),e.setDisabled(xn.maxVisibleTracks<m[t])}),b.setProperties({left:xn.modeButtonsLeft,top:e+1,width:xn.modeButtonsWidth-94,height:20}),w.setProperties({left:b.left,top:b.top+g.height,width:b.width,height:b.height}),x.setProperties({left:xn.modeButtonsLeft,top:e,width:xn.TrackCountSpinboxWidth,height:d.innerHeight})},d.onPanelResize(),d.renderInternal=function(){"2row"!==xn.controlPanelButtonLayout&&(d.ctx.drawImage(bn.getImage("line_ver"),xn.controlPanelButtonsLeft-2,0,2,d.height-1),d.ctx.drawImage(bn.getImage("line_ver"),xn.modeButtonsLeft-2,0,2,d.height-1),"condensed"!==xn.controlPanelButtonLayout&&(d.ctx.drawImage(bn.getImage("line_ver"),xn.col4X-2,0,2,d.height-1),d.ctx.translate(.5,.5),d.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",d.ctx.lineWidth=1,d.ctx.beginPath(),d.ctx.moveTo(xn.col2X+10,10),d.ctx.lineTo(xn.col2X+10,20),d.ctx.lineTo(xn.col4X-14,20),d.ctx.lineTo(xn.col4X-14,10),d.ctx.moveTo(xn.col4X+10,30),d.ctx.lineTo(xn.col4X+10,20),d.ctx.lineTo(xn.col5X-14,20),d.ctx.lineTo(xn.col5X-14,30),d.ctx.stroke(),d.ctx.setTransform(1,0,0,1,0,0),u.render(),f.render(),h.render()))},Bt.on(O,function(e){switch(e){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":u.setActive(!0),f.setActive(!1);break;case"options":u.setActive(!1),f.setActive(!0);break;case"topmain":u.setActive(!1),f.setActive(!1);break;case"main":u.setActive(!1),f.setActive(!1),h.setActive(!1);break;case"bottommain":h.setActive(!1);break;case"sample":h.setActive(!0)}}),Bt.on(he,function(e){g.setActive(e===Dt),p.setActive(e===Ft),xn.setLayout()}),Bt.on(ue,function(e){x.setValue(e,!0)}),Bt.on(fe,function(e){var t=e.channels;12<t&&t<16&&(t=16),8<t&&t<12&&(t=12),4<t&&t<8&&(t=8),t=Math.min(t,xn.maxVisibleTracks),xn.setVisibleTracks(t),d.onPanelResize()}),d}),setLayout:function(e,t){wn.width=e||wn.width,wn.height=t||wn.height;var n=wn.width;if(wn.sidebarWidth=wn.showAppSideBar?200:0,n-=wn.sidebarWidth,wn.col1W=Math.floor((n-6*wn.defaultMargin-3)/5),wn.col2W=2*wn.col1W+wn.defaultMargin,wn.col3W=3*wn.col1W+2*wn.defaultMargin,wn.col4W=4*wn.col1W+3*wn.defaultMargin,wn.col5W=5*wn.col1W+4*wn.defaultMargin,wn.marginLeft=Math.floor((n-wn.col5W)/2),wn.marginRight=n-wn.marginLeft-wn.col5W,wn.mainLeft=wn.sidebarWidth,wn.mainWidth=n,wn.col1X=wn.marginLeft,wn.col2X=wn.col1X+wn.defaultMargin+wn.col1W,wn.col3X=wn.col2X+wn.defaultMargin+wn.col1W,wn.col4X=wn.col3X+wn.defaultMargin+wn.col1W,wn.col5X=wn.col4X+wn.defaultMargin+wn.col1W,wn.colHalfW=Math.floor(wn.col1W/2),wn.col31W=Math.floor((n-4*wn.defaultMargin-5)/3),wn.col32W=2*wn.col31W+wn.defaultMargin,wn.col31X=wn.col1X,wn.col32X=wn.col31X+wn.defaultMargin+wn.col31W,wn.col33X=wn.col32X+wn.defaultMargin+wn.col31W,wn.prefered="col5",wn.controlPanelHeight=40,wn.controlPanelLayout="full",wn.controlPanelButtonLayout="1row",wn.controlPanelButtonsLeft=wn.col2X,wn.controlPanelButtonsWidth=wn.col3W,wn.modeButtonsWidth=wn.col1W,wn.modeButtonsLeft=wn.col5X,wn.songControlWidth=wn.col1W,wn.TrackCountSpinboxWidth=60,wn.trackWidth=wn.col1W,wn.trackMargin=wn.defaultMargin,wn.visibleTracks=wn.visibleTracks||4,wn.infoPanelHeight=24,wn.trackControlHeight=32,wn.analyserHeight=66,wn.pianoHeight=200,wn.trackFont=fontMed,wn.useCondensedTrackFont=!1,wn.maxVisibleTracks=16,n<945&&(wn.maxVisibleTracks=12),n<725&&(wn.maxVisibleTracks=8),n<512&&(wn.maxVisibleTracks=4),wn.maxVisibleTracks<wn.visibleTracks)wn.setVisibleTracks(wn.maxVisibleTracks);else{n<820&&(wn.controlPanelButtonLayout="condensed",wn.modeButtonsWidth=wn.col1W+wn.colHalfW,wn.modeButtonsLeft=wn.col5X-wn.colHalfW,wn.songControlWidth=wn.modeButtonsWidth,wn.controlPanelButtonsLeft=wn.col2X+wn.colHalfW,wn.controlPanelButtonsWidth=wn.col2W),n<650&&(wn.controlPanelButtonLayout="2row",wn.controlPanelHeight=80,wn.controlPanelButtonsLeft=wn.col1X,wn.controlPanelButtonsWidth=wn.col5W,wn.controlPanelButtonsButton=Math.floor(wn.controlPanelButtonsWidth/3),wn.modeButtonsLeft=2*wn.controlPanelButtonsButton-wn.TrackCountSpinboxWidth,wn.modeButtonsWidth=wn.controlPanelButtonsButton+wn.TrackCountSpinboxWidth+wn.defaultMargin,wn.songControlWidth=wn.col2W+wn.colHalfW+wn.defaultMargin),n<620&&(wn.prefered="col3"),wn.height<800&&(wn.pianoHeight=150),wn.height<650&&(wn.pianoHeight=100);var i=wn.defaultMargin*(wn.visibleTracks-1);wn.showSideBar=wn.visibleTracks<5&&620<n;var r=wn.showSideBar?wn.col4W:wn.col5W;wn.trackWidth=Math.floor((r-i)/wn.visibleTracks),wn.firstTrackOffsetLeft=0,wn.trackWidth<125&&(wn.firstTrackOffsetLeft=18,wn.trackWidth=Math.floor((r-i-wn.firstTrackOffsetLeft)/wn.visibleTracks));var a=mn.inFTMode()?100:78;wn.trackWidth<a&&(wn.trackFont=fontSuperCondensed,wn.useCondensedTrackFont=!0)}},setVisibleTracks:function(e){wn.visibleTracks=e,wn.setLayout(),Bt.trigger(P,e)}};de.app_mainPanel=function(){var l,d=de.app_panelContainer(160),t="",c="",u=de.button();u.setProperties({background:de.Assets.panelInsetScale9,activeBackground:de.Assets.buttonDarkScale9,image:bn.getImage("logo_grey_70"),activeImage:bn.getImage("logo_colour_70")}),u.onDown=function(){u.toggleActive()},d.addChild(u);var f=de.button();f.setProperties({background:de.Assets.panelInsetScale9,activeBackground:de.Assets.panelInsetScale9,image:bn.getImage("tracker"),activeImage:function(){var e=bn.getImage("steffest"),t="undefined"==typeof versionNumber?"dev":versionNumber;if(0<t.indexOf(".")){var n=t.split(".");t=n[0]+"."+n[1]}t="Version "+t;var i=e.getContext("2d");return fontSmall.write(i,t,44,4),fontSmall.write(i,"By",44,13),e}()}),f.onDown=function(){f.toggleActive()},d.addChild(f);var h=de.inputbox({name:"modName",onChange:function(e){mn.getSong().title=e,de.setInfo(e)}});d.addChild(h);var g=de.listbox();g.setItems([{label:"loading ...",data:1}]),d.addChild(g),g.onClick=function(e){Pn.setFocusElement(g);var t=g.getItemAtPosition(g.eventX,g.eventY);t&&mn.setCurrentInstrumentIndex(t.data)};var p=de.app_songPatternList();d.addChild(p);var e=window.fontFT,m=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);d.addChild(m);var v=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);d.addChild(v);var b=de.spinBox();b.setProperties({name:"Pattern",label:"Pattern",labels:[{width:10,label:"Pat."},{width:140,label:"Pattern"}],value:0,max:100,min:0,font:e,onChange:function(e){mn.setCurrentPattern(e)}}),d.addChild(b);var w=de.spinBox({name:"Instrument",label:"Instrument",labels:[{width:10,label:"Ins."},{width:123,label:"Instr"},{width:160,label:"Instrument"}],value:1,max:31,min:1,font:e,onChange:function(e){mn.setCurrentInstrumentIndex(e)}});d.addChild(w);var x=de.spinBox({name:"SongLength",label:"Song length",labels:[{width:10,label:"Len."},{width:138,label:"Length"},{width:156,label:"Song len"},{width:178,label:"Song length"}],value:1,max:200,min:1,font:e,onChange:function(e){var t=mn.getSong().length;e<t?mn.removeFromPatternTable():t<e&&mn.addToPatternTable()}});d.addChild(x);var k=de.spinBox({name:"SongRepeat",label:"Song repeat",labels:[{width:10,label:"Rep."},{width:138,label:"Repeat"},{width:156,label:"Song rep"},{width:178,label:"Song repeat"}],value:1,max:200,min:1,font:e,onChange:function(e){mn.getSong().restartPosition=e}});d.addChild(k);var P=de.spinBox({name:"PatternLength",label:"Pattern length",labels:[{width:10,label:"Plen"},{width:138,label:"Pat len"},{width:166,label:"Pattern len"},{width:188,label:"Pattern length"}],value:64,max:128,min:1,font:e,onChange:function(e){mn.setPatternLength(e)}});d.addChild(P);var y=de.spinBox({name:"BPMLength",label:"BPM",value:1,max:400,min:1,font:e,onChange:function(e){mn.setBPM(e)}});d.addChild(y);var S=de.DiskOperations();S.setProperties({name:"diskoperations",zIndex:100}),d.addChild(S),de.diskOperations=S;var _=de.OptionsPanel();return _.setProperties({name:"options",zIndex:100}),d.addChild(_),d.onPanelResize=function(){var e=xn.defaultMargin,t=20+2*e,n=50+e+e,i=d.height-50-4*e,r=28,a=xn.col1W-2;if("col3"===xn.prefered){l||(c="patterndata",(l=de.radioGroup()).setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0,zIndex:1}),l.setItems([{label:"About",active:!1},{label:"Song data",labels:[{width:30,label:"song"}],active:!1},{label:"Pattern data",labels:[{width:40,label:"pattern"}],active:!0},{label:"Instruments",labels:[{width:30,label:"Instr"}],active:!1}]),l.onChange=function(e){c="about",1===e&&(c="songdata"),2===e&&(c="patterndata"),3===e&&(c="instruments"),d.onPanelResize()},d.addChild(l),d.sortZIndex()),i=d.height-2*e,n=e,a=xn.col32W-2,r=28,l.show(),l.setDimensions({left:xn.col31X,width:xn.col31W,top:e,height:i,visible:!0}),h.setDimensions({left:xn.col32X,width:xn.col32W,top:e,height:20}),g.setDimensions({left:xn.col32X,width:xn.col32W,top:t,height:d.height-t-2*e});var o={left:xn.col32X,width:xn.col32W,top:n,height:i};p.setDimensions(o),m.setDimensions(o),v.setDimensions(o),u.setDimensions({left:xn.col32X,width:xn.col32W,top:n,height:Math.floor(i/2)}),f.setDimensions({left:xn.col32X,width:xn.col32W,top:Math.floor(i/2)+1,height:Math.floor(i/2)});var s=xn.col32X;y.setDimensions({left:s,top:m.top+3,width:a,height:r}),x.setDimensions({left:s,top:m.top+3+r,width:a,height:r}),k.setDimensions({left:s,top:m.top+3+2*r,width:a,height:r}),k.hide(),b.setDimensions({left:s,top:m.top+3+2*r,width:a,height:r}),P.setDimensions({left:s,top:m.top+3+3*r,width:a,height:r}),w.setDimensions({left:s,top:m.top+3+4*r,width:a,height:r}),u.toggle("about"===c),f.toggle("about"===c),h.toggle("instruments"===c),g.toggle("instruments"===c),p.toggle("songdata"===c),m.toggle("patterndata"===c),y.toggle("patterndata"===c),x.toggle("patterndata"===c),b.toggle("patterndata"===c),P.toggle("patterndata"===c),w.toggle("patterndata"===c),v.hide()}else l&&l.hide(),u.show(),f.show(),h.show(),g.show(),p.show(),m.show(),v.show(),y.show(),x.show(),b.show(),P.show(),w.show(),k.show(),u.setDimensions({left:xn.col1X,top:e,width:xn.col2W,height:50}),f.setDimensions({left:xn.col3X,top:e,width:xn.col1W,height:50}),h.setDimensions({left:xn.col4X,width:xn.col2W,top:e,height:20}),g.setDimensions({left:xn.col4X,width:xn.col2W,top:t,height:d.height-t-2*e}),p.setDimensions({left:xn.col1X,width:xn.col1W,top:n,height:i}),m.setDimensions({left:xn.col2X,width:xn.col1W,top:n,height:i}),v.setDimensions({left:xn.col3X,width:xn.col1W,top:n,height:i}),y.setDimensions({left:xn.col2X,top:m.top+3,width:a,height:r}),x.setDimensions({left:xn.col2X,top:m.top+3+r,width:a,height:r}),k.setDimensions({left:xn.col2X,top:m.top+3+2*r,width:a,height:r}),b.setDimensions({left:xn.col3X,top:m.top+3,width:a,height:r}),P.setDimensions({left:xn.col3X,top:m.top+3+r,width:a,height:r}),w.setDimensions({left:xn.col3X,top:m.top+3+2*r,width:a,height:r});S.setSize(d.width,d.height),_.setSize(d.width,d.height)},d.onPanelResize(),d.getCurrentView=function(){return t},Bt.on(B,function(){h.setValue("Loading ...",!0)}),Bt.on($,function(e){h.setValue(e.title,!0),x.setValue(e.length,!0),w.setMax(mn.getMaxInstruments()),k.setMax(e.length),e.restartPosition&&e.length<e.restartPosition&&(e.restartPosition=e.length),k.setValue(e.restartPosition||1)}),Bt.on(Q,function(e){y.setValue(e,!0)}),Bt.on(G,function(e){g.setSelectedIndex(e-1),w.setValue(e,!0)}),Bt.on(ee,function(e){var t=mn.getInstrument(e);if(t)for(var n=g.getItems(),i=0,r=n.length;i<r;i++)if(n[i].data==e){n[i].label=e+" "+t.name,Bt.trigger(te,n);break}}),Bt.on(te,function(e){g.setItems(e)}),Bt.on(L,function(e){b.setValue(e,!0),P.setValue(mn.getPatternLength(),!0)}),Bt.on(he,function(e){P.setDisabled(e===Dt),w.setMax(mn.getMaxInstruments())}),Bt.on(O,function(e){switch(e){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":S.setView(e),S.show(),_.hide(),t=e,d.refresh();break;case"options":S.hide(),_.show(!0),t=e,d.refresh();break;case"topmain":case"main":S.hide(),_.hide(),t="",d.refresh()}}),d.benchmark=function(){performance.now();for(var e=[],t=1;t<=1e6;t++)e.push({label:"Item "+t,data:t});g.setItems(e);performance.now()},d},de.app_menu=function(e){var i=de.app_panelContainer(32),r=de.scale9Panel(5,0,20,26,{img:bn.getImage("menu"),left:4,top:0,right:40,bottom:0});i.addChild(r);var t=de.menu(5,0,i.width,26,e);i.addChild(t),t.setItems([{label:"File",subItems:[{label:"New",command:p},{label:"Load Module",command:re},{label:"Save Module",command:ae},{label:"Open Random MOD Song",command:Te},{label:"Open Random XM Song",command:Ie}]},{label:"Edit",subItems:[{label:"Cut",command:Ee},{label:"Copy",command:De},{label:"Paste",command:Fe},{label:"Clear Track",command:oe},{label:"Clear Pattern",command:se},{label:"Clear Song",command:me},{label:"Clear Instruments",command:ve},{label:"Render Pattern 2 Sample",command:Le}]},{label:"View",subItems:[{label:"Main",command:be},{label:"Options",command:we},{label:"File Operations",command:xe},{label:"Sample Editor",command:ke},{label:"Piano",command:Se},{label:"Performance stats",command:Ae}]},{label:"Help",subItems:[{label:"About",command:Pe},{label:"Documentation",command:ye},{label:"Sourcecode on Github",command:Me}]}]);var a=de.vumeter();return a.connect(Wt.cutOffVolume),window.vumeter=a,i.onPanelResize=function(){var e=Math.max(xn.col2W,250);$t.showInternalMenu||(r.hide(),e=0);var t=xn.col5W-e,n=xn.marginLeft+e+xn.defaultMargin+xn.mainLeft;i.left=xn.mainLeft,e&&r.setDimensions({left:xn.marginLeft,top:0,height:26,width:e}),a.setProperties({width:t,left:n})},i.onPanelResize(),i},de.app_panelContainer=function(e){var t=de.panel(0,0,sn.width,e,!0),n=de.scale9Panel(0,0,t.width,t.height,de.Assets.panelMainScale9);return n.ignoreEvents=!0,t.addChild(n),t.onResize=function(){n.setSize(t.width,t.height),t.onPanelResize&&t.onPanelResize()},t},de.app_patternPanel=function(){function i(){var e=p.getStartTrack(),t=Math.min(e+xn.visibleTracks,mn.getTrackCount()),n=!(xn.expandSampleViewHeight&&"sample"===d);for(r=0;r<l.length;r++)l[r].setProperties(e<=r&&r<t?{track:r,left:o+(xn.trackWidth+xn.trackMargin)*(r-e),top:xn.defaultMargin+xn.infoPanelHeight+xn.analyserHeight,width:xn.trackWidth,height:xn.trackControlHeight,visible:n}:{track:r,top:-100,visible:!1})}var r,a,o,s=de.app_panelContainer(80),l=[],d="main",c=de.editPanel();s.addChild(c);var u=de.InfoPanel();for(s.addChild(u),r=0;r<mn.getTrackCount();r++)l[r]=de.trackControl(),s.addChild(l[r]);var f=de.visualiser();f.connect(Wt.cutOffVolume),f.name="mainAnalyser";var h=de.element();h.render=function(){},h.onClick=function(e){f.onClick(e)},s.addChild(h);var g=de.pattern_sidebar();s.addChild(g);var p=de.app_patternView();p.setProperties({name:"patternViewPanel"}),s.addChild(p);var m=de.SampleView();return m.setProperties({name:"sampleViewPanel"}),s.addChild(m),s.onPanelResize=function(){xn.showSideBar?"main"===d&&(g.show(),c.show()):(g.hide(),c.hide());var e=xn.infoPanelHeight+xn.trackControlHeight+xn.analyserHeight+2*xn.defaultMargin,t=s.height-e-xn.defaultMargin;xn.expandSampleViewHeight=t<280,xn.expandSampleViewHeight&&"sample"===d?(f.hide(),c.hide()):(f.show(),xn.showSideBar&&c.show());var n=xn.showSideBar?xn.col4W:xn.col5W;o=(a=xn.showSideBar?xn.col2X:xn.col1X)+xn.firstTrackOffsetLeft,c.setDimensions({left:xn.col1X,top:xn.defaultMargin,width:xn.col1W,height:xn.infoPanelHeight+xn.analyserHeight}),u.setDimensions({left:xn.showSideBar?xn.col2X:xn.col1X,top:0,width:xn.showSideBar?xn.col4W:xn.col5W,height:xn.infoPanelHeight}),p.setDimensions({left:a,top:e,width:n,height:t}),g.setDimensions({left:xn.col1X,top:p.top-xn.trackControlHeight,width:xn.col1W,height:t+xn.trackControlHeight}),f.setProperties({left:o+xn.mainLeft,top:s.top+xn.infoPanelHeight+3,width:n-xn.firstTrackOffsetLeft,height:xn.analyserHeight}),h.setDimensions({left:f.left-xn.mainLeft,top:xn.infoPanelHeight+3,width:f.width,height:f.height}),m.setProperties({left:0,top:xn.expandSampleViewHeight?xn.infoPanelHeight:e,width:s.width,height:xn.expandSampleViewHeight?s.height-xn.infoPanelHeight-xn.defaultMargin-3:t}),i()},s.onPanelResize(),Bt.on(L,function(){p.refresh()}),Bt.on(ce,function(){p.refresh()}),Bt.on(v,function(){p.refresh()}),Bt.on(q,function(){p.refresh()}),Bt.on(b,function(e){if(void 0!==e.track)if(e.solo)for(r=0;r<mn.getTrackCount();r++)r!=e.track&&l[r].setProperties({mute:!0});else if(e.wasSolo)for(r=0;r<mn.getTrackCount();r++)r!=e.track&&l[r].setProperties({mute:!1})}),Bt.on(ue,function(e){for(s.visibleTracks=Math.min(4,e),r=l.length;r<e;r++)l[r]=de.trackControl(),l[r].setProperties({track:r,top:-200}),s.addChild(l[r]);i(),s.refresh()}),Bt.on(w,function(){i()}),Bt.on(O,function(e){switch(e){case"sample":m.show(),p.hide(),g.hide(),xn.expandSampleViewHeight&&(f.hide(),c.hide()),d=e,s.onPanelResize(),s.refresh();break;case"bottommain":case"main":m.hide(),p.show(),f.show(),xn.showSideBar&&(g.show(),c.show()),d="main",s.onPanelResize(),s.refresh()}}),Bt.on(P,function(e){xn.showSideBar?"main"===d&&(g.show(),c.show()):(g.hide(),c.hide()),s.onResize()}),s},de.app_pianoView=function(){var l=de.app_panelContainer(200);l.name="pianoViewPanel";var n,d,c=[],u=[0,2,4,5,7,9,11],f=[-1,1,0,3,0,-1,0,6,0,8,0,10,0,-1],h=bn.getImage("pianokey_white"),g=bn.getImage("pianokey_white_down"),p=bn.getImage("pianokey_black"),m=bn.getImage("pianokey_black_down"),v=0,t=3,i=1,e=de.Assets.generate("button20_20");e.setLabel("x"),e.onClick=function(){Zt.doCommand(Se)},l.addChild(e);var r=de.spinBox();r.setProperties({name:"Octave",label:"Octave",value:1,max:t,min:i,left:4,top:2,height:28,width:150,font:window.fontMed,onChange:function(e){Pn.setCurrentOctave(e)}}),l.addChild(r),l.onShow=function(){l.onPanelResize()},l.onPanelResize=function(){l.innerHeight=l.height-2*xn.defaultMargin,e.setProperties({top:4,left:l.width-24})},l.onPanelResize(),Bt.on(x,function(e){l.isVisible()&&(c[e]=!0,l.refresh())}),Bt.on(k,function(e){l.isVisible()&&(c[e]=!1,l.refresh())});function a(e,t){var n=-1,i=e%420,r=Math.floor(e/420);if(0<=t)if(v+30<t){var a=Math.floor(i/60);n=u[a]+12*r}else{var o=Math.floor((i-15)/30);o<0&&(o=0),12<o&&(o=12),o%2==0?n=u[a=o/2]:(n=f[o])<0&&(a=Math.floor(i/60),n=u[a]),n+=12*r}return n+1}return l.onDown=function(e){var t=a(e.x,e.y);t&&t!==n&&(Pn.handleNoteOn(t+12*d),n&&Pn.handleNoteOff(n+12*d),n=t)},l.onTouchUp=function(e){var t=a(e.x,e.y);(t=t||n)&&(Pn.handleNoteOff(t+12*d),n=void 0),n&&Pn.handleNoteOff(n+12*d),n=void 0},l.onDrag=function(e){var t=a(e.x,e.y);t&&t!==n&&(Pn.handleNoteOn(t+12*d),n&&Pn.handleNoteOff(n+12*d),n=t)},l.renderInternal=function(e){if(l.isVisible()){if(e=!!e,this.needsRendering){for(var t=l.height-30,n=0,i=0;n<l.width;){var r=Math.floor(i/7),a=i%7,o=12*(d+r)+u[a]+1;l.ctx.drawImage(c[o]?g:h,n,30,64,t),i++,n+=60}v=Math.floor(t/1.7);var s=38;for(i=0;s<l.width;){if(r=Math.floor(i/7),2!==(a=i%7)&&6!==a)l.ctx.drawImage(c[o=12*(d+r)+f[2*a+1]+1]?m:p,s,30,48,v),0;i++,s+=60}}if(this.needsRendering=!1,e)return l.canvas;l.parentCtx.drawImage(l.canvas,l.left,l.top,l.width,l.height)}},Bt.on(_,function(e){r.setValue(d=e,!0)}),Bt.on(he,function(e){t=mn.inFTMode()?7:3,i=mn.inFTMode()?0:1,r.setMax(t,!0),r.setMin(i,!0)}),l},de.Assets=function(){var i={},r={};i.preLoad=function(e){function t(e){return e=a+e,o&&(e+="?v="+Zt.buildNumber),e}function n(){i&&r&&(i.forEach(function(e){e.img=r,bn.sprites[e.name]=bn.sprite(e)}),e&&e())}var i,r,a=$t.getBaseUrl(),o=$t.useUrlParams;Qt.json(t("skin/spritemap_v2.json"),function(e){i=e,n()}),bn.loadImage(t("skin/spritesheet_v2.png"),function(e){r=e,n()})},i.buttonLightScale9={left:2,top:2,right:4,bottom:4},i.buttonLightHoverScale9={left:2,top:2,right:4,bottom:4},i.buttonDarkScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkBlueScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkRedScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkRedHoverScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkGreenScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkActiveBlueScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkGreenHoverScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkGreenActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkRedActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkBlueActiveScale9={left:5,top:5,right:5,bottom:5},i.buttonDarkYellowActiveScale9={left:5,top:5,right:5,bottom:5},i.panelMainScale9={left:2,top:2,right:3,bottom:3},i.panelDarkScale9={left:3,top:3,right:3,bottom:2},i.panelDarkHoverScale9={left:3,top:3,right:3,bottom:2},i.panelDarkGreyScale9={left:3,top:3,right:3,bottom:2},i.panelDarkGreyBlueScale9={left:3,top:3,right:3,bottom:2},i.panelTransScale9={left:3,top:3,right:3,bottom:2},i.panelInsetScale9={left:2,top:2,right:2,bottom:2},i.panelDarkInsetScale9={left:2,top:2,right:2,bottom:2},i.buttonKeyScale9={left:5,top:5,right:5,bottom:5},i.buttonKeyHoverScale9={left:5,top:5,right:5,bottom:5},i.buttonKeyActiveScale9={left:5,top:5,right:5,bottom:5};var a={button20_20:{generate:function(e){var t,n=i.panelDarkScale9;if((t=de.button(0,0,20,20)).setProperties({background:n,hoverBackground:i.panelDarkHoverScale9,textAlign:"center",font:window.fontMed,paddingTop:2}),!e)return t;r.buttonUp20_20=t}},button30_30:{generate:function(e){var t;if(t=de.scale9Panel(0,0,30,30,i.buttonLightScale9),!e)return t;r.buttonUp30_30=t}},buttonLight:{generate:function(e){var t,n=i.buttonLightScale9;if((t=de.button()).setProperties({background:n,hoverBackground:i.buttonLightHoverScale9,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonLight=t}},buttonDark:{generate:function(e){var t,n=i.buttonDarkScale9;if((t=de.button(0,0,20,20)).setProperties({background:n,hoverBackground:de.Assets.buttonDarkBlueActiveScale9,activeBackground:de.Assets.buttonDarkActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDark=t}},buttonDarkBlue:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonDarkBlueScale9,activeBackground:de.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDarkBlue=t}},buttonDarkRed:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonDarkRedScale9,hoverBackground:de.Assets.buttonDarkRedHoverScale9,activeBackground:de.Assets.buttonDarkRedActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDarkRed=t}},buttonDarkGreen:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonDarkGreenScale9,hoverBackground:de.Assets.buttonDarkGreenHoverScale9,activeBackground:de.Assets.buttonDarkGreenActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDarkGreen=t}},buttonKey:{generate:function(e){var t;if((t=de.button(0,0,20,20)).setProperties({background:i.buttonKeyScale9,hoverBackground:de.Assets.buttonKeyHoverScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark}),!e)return t;r.buttonKey=t}}};return i.init=function(){i.buttonLightScale9.img=bn.getImage("button_light"),i.buttonLightHoverScale9.img=bn.getImage("button_light_hover"),i.buttonDarkScale9.img=bn.getImage("button_inlay"),i.buttonDarkBlueScale9.img=bn.getImage("button_inlay_blue"),i.buttonDarkRedScale9.img=bn.getImage("button_inlay_red"),i.buttonDarkRedHoverScale9.img=bn.getImage("button_inlay_red_hover"),i.buttonDarkGreenScale9.img=bn.getImage("button_inlay_green"),i.buttonDarkGreenHoverScale9.img=bn.getImage("button_hover_green"),i.buttonDarkActiveScale9.img=bn.getImage("button_inlay_active"),i.buttonDarkGreenActiveScale9.img=bn.getImage("button_inlay_green_active"),i.buttonDarkRedActiveScale9.img=bn.getImage("button_inlay_red_active"),i.buttonDarkBlueActiveScale9.img=bn.getImage("button_inlay_blue_active"),i.buttonDarkYellowActiveScale9.img=bn.getImage("button_inlay_yellow_active"),i.panelMainScale9.img=bn.getImage("background"),i.panelDarkScale9.img=bn.getImage("bar"),i.panelDarkHoverScale9.img=bn.getImage("bar_hover"),i.panelDarkGreyScale9.img=bn.getImage("panel_dark_greyish"),i.panelDarkGreyBlueScale9.img=bn.getImage("panel_dark_blueish"),i.panelTransScale9.img=bn.getImage("panel_trans"),i.panelInsetScale9.img=bn.getImage("panel_inset"),i.panelDarkInsetScale9.img=bn.getImage("panel_dark"),i.buttonKeyScale9.img=bn.getImage("keybutton"),i.buttonKeyHoverScale9.img=bn.getImage("keybutton_hover"),i.buttonKeyActiveScale9.img=bn.getImage("keybutton_highlight3")},i.get=function(e){var t=r[e];if(t)return t;var n=a[e];n&&(n.isLoading||(n.isLoading=!0,n.generate(!0)))},i.put=function(e,t){r[e]=t},i.generate=function(e){return a[e]?a[e].generate():void 0},i}(),de.animsprite=function(e,t,n,i,r,a){var o=de.element(e,t,n=n||14,i=i||14,!0),s=["left","top","width","height","name"];o.setProperties=function(t){s.forEach(function(e){void 0!==t[e]&&(o[e]=t[e])}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top)};var l=bn.getImage(r),d=0;return o.onShow=function(){de.ticker.onEachTick2(function(){a<=++d&&(d=0),o.refresh()},0)},o.onHide=function(){de.ticker.onEachTick2()},o.render=function(e){if(e=!!e,this.needsRendering&&(o.clearCanvas(),o.ctx.drawImage(l,d*n,0,n,i,0,0,n,i)),this.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)},o};var kn=function(){var P,y,S,_,C={},T=[],I=!1;return C.generate=function(e){var t=e.image,n=e.startX,i=e.startY;P=e.charWidth;var r=e.charHeight;_=e.spaceWidth||8;var a=e.margin,o=e.lineSpacing||0,s=e.charsPerLine,l=e.chars||"ABCDEFGHIJKLMNOPQRSTUVWXYZ";I=e.onlyUpperCase,C.fontArray=[],C.colors={},S=a,y=r,C.fixedWidth=!0,C.charHeight=r,"number"!=typeof P&&(C.fixedWidth=!1,"string"==typeof P&&(P=P.split("")).forEach(function(e,t){P[t]=parseInt(e)})),C.charWidth=P;for(var d,c=n,u=i,f=0,h=0,g=0,p=l.length;g<=p;g++){var m=document.createElement("canvas"),v=(d=g,(C.fixedWidth?P:P[d])||1);m.width=v,m.height=r;var b=m.getContext("2d");if(C.fixedWidth)var w=n+g%s*(v+a),x=i+Math.floor(g/s)*(r+o);else w=c,x=u,c+=v+a,s[f]<=++h&&(f++,h=0,c=n,u+=y+o);b.drawImage(t,w,x,v,r,0,0,v,r);var k=l.charCodeAt(g);C.fontArray[k]=m,T[k]=v}},C.generateColor=function(e,o){e=e||"green",o=o||"rgba(107, 161, 65,0.9)";var s=[];C.fontArray.forEach(function(e,t){var n=document.createElement("canvas"),i=document.createElement("canvas");n.width=e.width,n.height=e.height,i.width=e.width,i.height=e.height;var r=n.getContext("2d"),a=i.getContext("2d");a.fillStyle=o,a.fillRect(0,0,16,16),a.globalCompositeOperation="destination-atop",a.drawImage(e,0,0),r.drawImage(i,0,0),r.globalCompositeOperation="darken",r.drawImage(e,0,0),s[t]=n}),C.colors[e]=s},C.getTextWidth=function(e,t){I&&(e=e.toUpperCase()),t=t||S;for(var n=0,i=0,r=e.length;i<r;i++){var a=e.charCodeAt(i);n+=(T[a]||_)+t}return n},C.write=function(e,t,n,i,r,a){I&&(t=t.toUpperCase());var o=C.colors[a]||C.fontArray;r=r||S,i=i||0;for(var s=n=n||0,l=0,d=t.length;l<d;l++){var c=t.charCodeAt(l),u=o[c],f=T[c];f=f||_,u&&e.drawImage(u,s,i,f,y),s+=f+r}},C};de.button=function(e,t,n,i,r){var s=de.element(e,t,n,i);s.type="button";var l,d,c,u,f,h,g,p,m=r||"",v="left",b=0,w=0,x=10,a=!(s.isActive=!1),o=["left","top","width","height","name","type","image","backgroundImage","background","active","hoverBackground","hoverImage","activeBackground","activeImage","font","label","textAlign","paddingTop","paddingTopActive","paddingLeft"];return s.setProperties=function(t){o.forEach(function(e){if(void 0!==t[e])switch(e){case"label":m=t[e];break;case"font":p=t[e];break;case"textAlign":v=t[e];break;case"paddingTop":b=parseInt(t[e]);break;case"paddingTopActive":w=parseInt(t[e]);break;case"paddingLeft":x=parseInt(t[e]);break;case"image":l=t[e];break;case"backgroundImage":d=t[e];break;case"activeImage":h=t[e];break;case"hoverImage":g=t[e],a=!0;break;case"background":t[e].img&&(d=void 0,(c=de.scale9Panel(0,0,0,0,t[e])).setParent(s));break;case"activeBackground":t[e].img&&(u=de.scale9Panel(0,0,0,0,t[e])).setParent(s);break;case"hoverBackground":t[e].img&&(f=de.scale9Panel(0,0,0,0,t[e])).setParent(s),a=!0;break;default:s[e]=t[e]}}),c&&c.setSize(s.width,s.height),u&&u.setSize(s.width,s.height),f&&f.setSize(s.width,s.height),s.setSize(s.width,s.height),s.setPosition(s.left,s.top)},s.setBackgroundImage=function(e){d=e,s.refresh()},s.setFont=function(e){p=e,s.refresh()},s.setLabel=function(e){m=e,s.refresh()},s.toggleActive=function(){s.isActive=!s.isActive,s.refresh()},s.setActive=function(e){void 0===e&&(e=!0),s.isActive=!!e,s.refresh()},s.setDisabled=function(e){void 0===e&&(e=!0),(s.isDisabled=e)&&(s.isActive=!1),s.refresh()},s.onHover=function(e){a&&(s.isActive||(s.isHover=!0,s.refresh()))},s.onHoverExit=function(){a&&s.isHover&&(s.isHover=!1,s.refresh())},s.render=function(e){if(s.isVisible()){if(s.needsRendering){e=!!e;if(d)s.ctx.drawImage(d,0,0,s.width,s.height);else if(c)if(s.isActive&&u){if(u.render(),h){var t=Math.floor((s.height-h.height)/2),n=Math.floor((s.width-h.width)/2);s.ctx.drawImage(h,n,t)}}else{var i=l;if(s.isHover&&g&&(i=g),s.isHover&&f?f.render():c.render(),i){t=Math.floor((s.height-i.height)/2),n=Math.floor((s.width-i.width)/2);s.ctx.drawImage(i,n,t)}}else s.ctx.fillStyle="grey",s.ctx.fillRect(0,0,s.width,s.height),s.ctx.fillStyle="black",s.ctx.rect(0,0,s.width,s.height),s.ctx.stroke();if(m){var r=Math.floor((s.height-10)/2)+(s.isActive?w:b),a=x;if(p){if("center"===v){var o=8*m.length;p.fixedWidth||(o=p.getTextWidth(m,0)),a=Math.floor((s.width-o)/2)}"right"===v&&(o=8*m.length,p.fixedWidth||(o=p.getTextWidth(m,0)),a=s.width-o-5),p.write(s.ctx,m,a,r,0)}else s.ctx.fillStyle="white",s.ctx.fillText(m,a,r)}s.isDisabled&&(s.ctx.fillStyle="rgba(34, 49, 85, 0.6)",s.ctx.fillRect(0,0,s.width,s.height)),s.renderInternal&&s.renderInternal()}if(s.needsRendering=!1,e)return s.canvas;s.parentCtx.drawImage(s.canvas,s.left,s.top,s.width,s.height)}},s},de.checkbox=function(e,t,n,i){var r=de.element(e,t,n=n||14,i=i||14,!0),a=["left","top","width","height","name","type","checked"];return r.setProperties=function(t){a.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top)},r.setState=function(e,t){r.checked=e,r.refresh(),r.onToggle&&!t&&r.onToggle(r.checked)},r.onClick=function(e){r.setState(!r.checked)},r.check=function(){r.setState(!0)},r.unCheck=function(){r.setState(!1)},r.toggle=function(){r.setState(!r.checked)},r.render=function(e){if(e=!!e,this.needsRendering){r.clearCanvas();var t=bn.getImage(r.checked?"checkbox_on":"checkbox_off");r.ctx.drawImage(t,0,0)}if(this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)},r},de.checkboxbutton=function(e){var t=de.button(0,0,20,20);return e=e||{},t.setProperties({background:de.Assets.buttonDarkBlueScale9,hoverBackground:de.Assets.buttonDarkBlueActiveScale9,activeBackground:de.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"left",paddingLeft:30,font:window.fontFT,label:e.label||""}),t.renderInternal=function(){var e=bn.getImage(t.isActive?"radio_active":"radio_inactive");t.ctx.drawImage(e,8,Math.floor(t.height/2)-5)},t.onDown=function(){t.toggleActive(),e.onDown&&e.onDown.bind(t).call()},t},de.collapsePanel=function(e){var t=de.panel(0,0,20,20);return e=e||{},t.setProperties({background:de.Assets.buttonDarkBlueScale9,font:window.fontFT,label:e.label||""}),t},de.element=function(e,t,n,i){var o={};return o.left=e||0,o.top=t||0,o.width=n||20,o.height=i||20,o.visible=!0,o.needsRendering=!0,o.parentCtx=ln,o.canvas=document.createElement("canvas"),o.canvas.width=n,o.canvas.height=i,o.ctx=o.canvas.getContext("2d"),o.children=[],o.hide=function(){o.visible=!1,o.onHide&&o.onHide()},o.show=function(e,t){o.visible=!0,e&&o.refresh(t),o.onShow&&o.onShow()},o.toggle=function(e){"boolean"==typeof e?e?o.show():o.hide():o.visible?o.hide():o.show()},o.isVisible=function(){for(var e=o.visible,t=o.parent;e&&t;)e=t.visible,t=t.parent;return e},o.containsPoint=function(e,t){return this.left<=e&&e<=this.left+this.width&&this.top<=t&&t<=this.top+this.height},o.getElementAtPoint=function(e,t){var n;e-=o.left+(o.scrollOffsetX||0),t-=o.top+(o.scrollOffsetY||0),o.scaleX&&(e/=o.scaleX),o.scaleY&&(t/=o.scaleY);for(var i=o.children.length-1;0<=i;i--){var r=o.children[i];if(r.isVisible()&&!r.ignoreEvents&&r.containsPoint(e,t)){n=r;break}}if(n){var a=n.getElementAtPoint(e,t);a?n=a:(n.eventX=e,n.eventY=t)}else(n=o).eventX=e,n.eventY=t;return n},o.setParent=function(e){(o.parent=e)&&(o.parentCtx=e.ctx)},o.addChild=function(e){e.setParent(o),e.zIndex=e.zIndex||o.children.length,o.children.push(e)},o.getChild=function(e){for(var t,n=o.children.length;n;){if((t=o.children[n])&&t.name&&t.name==e)return t;n--}},o.refresh=function(e){if(o.needsRendering=!0,e)for(var t,n=o.children.length;n;)(t=o.children[n])&&t.refresh(),n--;this.visible&&o.parent&&o.parent.refresh&&o.parent.refresh()},o.setSize=function(e,t){o.width=Math.max(e,1),o.height=Math.max(t,1),o.canvas.width=o.width,o.canvas.height=o.height,o.onResize&&o.onResize(),o.refresh()},o.setPosition=function(e,t){o.left=e,o.top=t,o.refresh()},o.setDimensions=function(e){"boolean"==typeof e.visible&&!e.visible||(o.setProperties?o.setProperties(e):(o.setPosition(e.left,e.top),o.setSize(e.width,e.height)))},o.clearCanvas=function(){o.ctx.clearRect(0,0,o.width,o.height)},o},de.inputbox=function(e){var t,n,r,a=de.element(),i=["left","top","width","height","name","type","onChange","backgroundImage"],o="",s="panel_dark";a.setProperties=function(t){i.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top),l&&l.setSize(a.width,a.height),t.value&&(o=t.value),t.backgroundImage&&(s=t.backgroundImage)},e&&a.setProperties(e);var l=de.scale9Panel(0,0,a.width,a.height,{img:bn.getImage(s),left:3,top:3,right:2,bottom:2});l.ignoreEvents=!0,a.addChild(l),a.render=function(e){if(e=!!e,a.isVisible()){if(this.needsRendering){l.render();var t=0;if(o&&fontMed){t=10;fontMed.write(a.ctx,o,t,6,0)}if(n){a.ctx.fillStyle="rgba(255,255,255,0.7)";a.ctx.fillRect(t+9*r+8,4,2,a.height-8)}}if(this.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}},a.setValue=function(e,t){o=e,a.refresh(),!t&&a.onChange&&a.onChange(o)},a.getValue=function(){return o},a.getItemAtPosition=function(e,t){t-=startY;var n=Math.floor(t/lineHeight)+visibleIndex;return 0<=n&&n<items.length?items[n]:void 0},a.onClick=function(){t||a.activate()},a.activate=function(){r=-1,!t&&o&&(r=o.length-1),t=!0,Pn.setFocusElement(a),d()},a.deActivate=function(){t&&(t=n=!1,a.refresh(),Pn.clearFocusElement())},a.onKeyDown=function(e,t){var n=!1;switch(e){case 8:o&&0<=r&&(o=o.substr(0,r)+o.substr(r+1),r--,a.onChange&&a.onChange(o)),n=!0;break;case 13:a.deActivate(),n=!0;break;case 37:0<=r&&r--,a.refresh(),n=!0;break;case 39:o&&(r++,r=Math.min(r,o.length-1),a.refresh()),n=!0;break;case 46:n=!0}if(!n&&31<e){var i=t.key;1==i.length&&i.match(/[a-z0-9\._:\-\ #]/i)&&(o=o.substr(0,r+1)+i+o.substr(r+1),a.onChange&&a.onChange(o),r++,a.refresh()),n=!0}return n};var d=function(){t&&(n=!n,a.refresh(),setTimeout(d,200))};return a},de.knob=function(e){var l=de.element();l.type="knob";var d="",c=50,t=c,n=["left","top","width","height","name","font","label","textAlign","paddingTop","disabled"],u=bn.getImage("knob_back"),f=bn.getImage("knob_back_inactive"),h=bn.getImage("knob_front");return l.width=u.width+32,l.height=u.height+32,l.setSize(l.width,l.height),l.setProperties=function(t){n.forEach(function(e){if(void 0!==t[e])switch(e){case"label":d=t[e];break;case"font":0;break;case"textAlign":0;break;case"paddingTop":parseInt(t[e]);break;case"disabled":l.isDisabled=!!t[e];default:l[e]=t[e]}}),l.setSize(l.width,l.height),l.setPosition(l.left,l.top)},l.setFont=function(e){l.refresh()},l.setLabel=function(e){d=e,l.refresh()},l.getLabel=function(){return d},l.setValue=function(e){l.refresh()},l.render=function(e){if(l.needsRendering){e=!!e,l.clearCanvas();var t=.8*u.width,n=.8*u.height,i=t/2,r=n/2;l.ctx.save(),l.ctx.translate(16+i,16+r),l.ctx.drawImage(l.isDisabled?f:u,-i,-r,t,n);var a=Math.abs(-230)+50,o=-230*Math.PI/180,s=(c/100*a-230)*Math.PI/180;if(l.ctx.fillStyle=l.isDisabled?"rgba(170,170,170,0.5)":"rgba(130,200,255,0.5)",l.ctx.beginPath(),l.ctx.arc(0,0,30,o,s,!1),l.ctx.arc(0,0,25,s,o,!0),l.ctx.fill(),l.ctx.rotate((c/100*320-160)*Math.PI/180),l.ctx.drawImage(h,-i,-r,t,n),l.ctx.restore(),d){fontSmall.write(l.ctx,d,16+i-3*d.length,16+n+4)}}if(l.needsRendering=!1,e)return l.canvas;l.parentCtx.drawImage(l.canvas,l.left,l.top,l.width,l.height)},l.onDragStart=function(){t=c},l.onDrag=function(e){l.isDisabled||(c=t+e.deltaY,c=Math.max(c,0),c=Math.min(c,100),l.refresh(),l.onChange&&l.onChange(c))},l.onClick=function(e){Math.abs(e.x-e.startX)<3&&Math.abs(e.y-e.startY)<3&&l.toggleDisabled()},l.toggleDisabled=function(){l.isDisabled=!l.isDisabled,l.onToggle&&l.onToggle(!l.isDisabled),l.refresh()},l},de.label=function(e){var r,a=de.element(),o="",s="left",l=0,n=["left","top","width","height","name","font",a.type="label","textAlign","paddingTop"];return a.setProperties=function(t){n.forEach(function(e){if(void 0!==t[e])switch(e){case"label":o=t[e];break;case"font":r=t[e];break;case"textAlign":s=t[e];break;case"paddingTop":l=parseInt(t[e]);break;default:a[e]=t[e]}}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top),t.labels&&(a.onResize=function(){var e=o;t.labels.forEach(function(e){e.width<=a.width&&(o=e.label)}),e!==o&&a.refresh()})},a.setFont=function(e){r=e,a.refresh()},a.setLabel=function(e){o=e,a.refresh()},a.render=function(e){if(a.isVisible()){if(a.needsRendering&&(e=!!e,a.clearCanvas(),o)){var t,n=Math.floor((a.height-10)/2)+l,i=10;if(r)"center"==s&&(t=r.getTextWidth(o,0),i=Math.floor((a.width-t)/2)),"right"==s&&(t=r.getTextWidth(o,0),i=Math.floor(a.width-t)-10),r.write(a.ctx,o,i,n,0);else a.ctx.fillStyle="white",a.ctx.fillText(o,i,n)}if(a.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}},e&&a.setProperties(e),a},de.listbox=function(e,t,n,i){function r(){var e=w.length;l=Math.floor(m.height/18),m.centerSelection&&(l=1);var t=18,n=m.height-4-32,i=n;d=0,l<e&&((i=Math.floor(l/e*n))<12&&(i=12),d=(n-i)/(e-l)),x&&d&&(t=Math.floor(18+d*x)),_.setProperties({left:m.width-18,top:t,width:16,height:i})}function a(){var e=w.length-1;return m.centerSelection||(e=w.length-l),e<0&&(e=0),e}var p,o,m=de.element(e,t,n,i,!0),s=m.selectedIndex=0,v=window.fontMed,b=window.fontSmall,w=[],x=0,l=0,k=10,d=0,c=["left","top","width","height","name","type","onChange","selectedIndex","centerSelection"];m.setProperties=function(t){c.forEach(function(e){void 0!==t[e]&&(m[e]=t[e])}),void 0!==t.font&&(v=t.font),m.setSize(m.width,m.height),m.setPosition(m.left,m.top),P.setSize(m.width,m.height),r(),y.setProperties({left:m.width-18,top:2,width:16,height:16,label:"↑"}),S.setProperties({left:m.width-18,top:m.height-19,width:16,height:16,label:"↓"}),m.centerSelection&&(k=Math.ceil((m.height-18)/2))},m.setSelectedIndex=function(e,t){m.selectedIndex=e,m.centerSelection&&(x=m.selectedIndex),r(),m.refresh(),!t&&m.onChange&&s!=m.selectedIndex&&m.onChange(),s=m.selectedIndex},m.getSelectedIndex=function(){return m.selectedIndex};var P=de.scale9Panel(0,0,m.width,m.height,{img:bn.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});P.ignoreEvents=!0,m.addChild(P);var y=de.Assets.generate("button20_20");m.addChild(y),y.onClick=function(){m.navigateUp()};var S=de.Assets.generate("button20_20");m.addChild(S),S.onClick=function(){m.navigateDown()};var _=de.scale9Panel(n-28,18,16,i-3,{img:bn.getImage("bar"),left:2,top:2,right:3,bottom:3});return _.onDragStart=function(){_.startDragIndex=x},_.onDrag=function(e){l<w.length&&d&&(x=Math.floor(_.startDragIndex+e.deltaY/d),x=Math.min(x,a()),x=Math.max(x,0),m.centerSelection?m.setSelectedIndex(x):r())},m.addChild(_),m.navigateUp=function(){0<x&&(x--,r()),m.centerSelection?m.setSelectedIndex(x):m.refresh()},m.navigateDown=function(){x<a()&&(x++,r()),m.centerSelection?m.setSelectedIndex(x):m.refresh()},m.render=function(e){if(e=!!e,m.isVisible()){if(this.needsRendering){P.render();for(var t=bn.getImage("line_hor"),n=0,i=w.length;n<i;n++){var r=w[n],a=10,o=6,s=k+18*(n-x);if(0<s&&s<m.height){var l,d=m.ctx,c=s,u=m.height-18<=s;if(u){var f=m.height-s+1;1<f?((l=document.createElement("canvas")).width=m.width-2,l.height=f,d=l.getContext("2d"),c=4,o=6):d=void 0}if(d){p+x===n&&(d.fillStyle="rgba(110,130,220,0.07)",d.fillRect(0,c-o,m.width-2,18)),m.selectedIndex===n&&(d.fillStyle="rgba(110,130,220,0.15)",d.fillRect(0,c-o,m.width-2,18)),r.level&&(a+=10*r.level),r.icon&&(d.drawImage(r.icon,a,c-2),a+=r.icon.width+4);var h=r.label;if(v){if(r.info){var g=6*r.info.length+20;b.write(d,r.info,m.width-g,c,0),h=h.substr(0,Math.floor((m.width-g-a-26)/v.charWidth))}v.write(d,h,a,c,0)}s+=11,c+=11,t&&d.drawImage(t,0,c,m.width-2,2),u&&m.ctx.drawImage(l,0,s-11-4)}}}_.render(),y.render(),S.render()}if(this.needsRendering=!1,e)return m.canvas;m.parentCtx.drawImage(m.canvas,m.left,m.top,m.width,m.height)}},m.setItems=function(e){w=e,x=Math.min(x,a()),r(),m.refresh()},m.getItems=function(){return w},m.getItemAtPosition=function(e,t){t-=k;var n=Math.floor(t/18)+x;return 0<=n&&n<w.length?w[n]:void 0},m.insertItemAfterIndex=function(e,t,n){},m.onMouseWheel=function(e){0<e.mouseWheels[0]?m.navigateUp():m.navigateDown()},m.onDragStart=function(e){m.startDragIndex=x},m.onDrag=function(e){if(l<w.length){var t=Math.round(e.deltaY/18);x=m.startDragIndex-t,x=Math.max(x,0),x=Math.min(x,a()),m.centerSelection?m.setSelectedIndex(x):r()}},m.onHover=function(e){var t=Math.floor((m.eventY-k)/18);t!==o&&(o=p=t,m.refresh())},m.onHoverExit=function(){p&&(o=p=void 0,m.refresh())},m},de.menu=function(e,t,n,i,s){var l,d=de.element(e,t,n,i);d.keepSelection=!0;var r,a=["left","top","width","height","name","type","background","layout"],c=[];return d.setProperties=function(t){a.forEach(function(e){void 0!==t[e]&&(d[e]=t[e])}),t.background&&((r=de.scale9Panel(0,0,d.width,d.height,t.background)).ignoreEvents=!0,d.addChild(r)),d.setSize(d.width,d.height),d.setPosition(d.left,d.top)},d.onClick=function(e){if(l&&l.length){var t,n=e.x,i=0,r=l.length;for(t=0;t<r&&!(n<l[t].startX);t++)i=t;var a=l[i];for(t=0;t<r;t++)t!==i&&l[t].subMenu&&l[t].subMenu.hide();if(a){if(a.subMenu)a.subMenu.setPosition((a.startX||0)+(e.globalX-e.x),d.height),a.subMenu.toggle(),a.subMenu.parent.refresh();a.command&&Bt.trigger(u,a.command)}}},d.render=function(e){if(d.isVisible()){if(e=!!e,this.needsRendering){var t=10;d.clearCanvas(),r&&r.render(),c.length?c.forEach(function(e){e.render()}):l&&l.forEach(function(e){e.startX=t,fontMed.write(d.ctx,e.label,t,10),t+=9*e.label.length+24})}if(this.needsRendering=!1,e)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top,d.width,d.height)}},d.setItems=function(e){l=e,s=s||d.parent;var r={background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!(c=[]),textAlign:"center",font:window.fontDark,paddingTopActive:1},a=3,o=3;l.forEach(function(e,t){if("buttons"===d.layout){var n=de.button(a,o,60,18);a+=60,1===t&&(a=3,o+=18),n.setProperties(r),n.setLabel(e.label),e.onClick&&(n.onClick=function(){e.onClick()}),c.push(n),d.addChild(n)}if(e.subItems){var i=de.submenu();i.setProperties({background:de.Assets.buttonLightScale9}),i.hide(),i.setItems(e.subItems),i.zIndex=200,s.addChild(i),e.subMenu=i}}),d.zIndex=9,d.refresh()},d.getItems=function(){return l},d.getItemAtPosition=function(e,t){t-=startY;var n=Math.floor(t/lineHeight)+visibleIndex;return 0<=n&&n<l.length?l[n]:void 0},d},de.modalDialog=function(e){var a=de.element(),n="",i=["left","top","width","height","name","ok","cancel"];a.setProperties=function(t){i.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top);var e=200;a.height<e&&(e=a.height-20);var n=Math.max(Math.floor(a.width/2),380);o.setSize(n,e),o.setPosition(Math.floor((a.width-n)/2),Math.floor((a.height-e)/2)),a.cancel?(s.setPosition(o.left+Math.floor(o.width/2)-110,o.top+o.height-40),l.setPosition(o.left+Math.floor(o.width/2)+10,o.top+o.height-40)):s.setPosition(o.left+Math.floor(o.width/2)-50,o.top+o.height-40)};var o=de.scale9Panel(0,0,Math.floor(a.width/2),200,de.Assets.panelMainScale9);o.ignoreEvents=!0,a.addChild(o);var s=de.Assets.generate("buttonLight");s.setProperties({name:"okbutton",label:"OK",width:100,height:28}),a.addChild(s);var l=de.Assets.generate("buttonLight");return l.setProperties({name:"cancelbutton",label:"Cancel",width:100,height:28}),a.addChild(l),a.render=function(e){if(e=!!e,this.needsRendering){if(a.ctx.fillStyle="rgba(0,0,0,0.6)",a.ctx.fillRect(0,0,a.width,a.height),o.render(),n){var t=n.split("/"),i=o.top+20,r=o.width-20;t.forEach(function(e){var t=10;if(fontFT){var n=fontFT.getTextWidth(e,0);t=o.left+10+Math.floor((r-n)/2),fontFT.write(a.ctx,e,t,i,0)}i+=12})}a.ok&&s.render(),a.cancel&&l.render()}if(this.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)},a.setText=function(e){n=e},a.getText=function(){return n},a.close=function(){a.hide(),a.onClose&&a.onClose(),de.removeModalElement(),delete a},a},de.numberDisplay=function(e,t,n,i,a){var o=de.element(e,t,n,i);o.type="numberDisplay",o.isActive=!1;a=a||0;var s=4,r=["left","top","width","height","name","value"];return o.setProperties=function(t){r.forEach(function(e){if(void 0!==t[e])switch(e){case"value":a=t[e];break;default:o[e]=t[e]}}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top)},o.setValue=function(e){a=e,o.refresh()},o.setDisabled=function(e){void 0===e&&(e=!0),(o.isDisabled=e)&&(o.isActive=!1),o.refresh()},o.onResize=function(){s=Math.floor(o.width/9)-1},o.render=function(e){if(o.isVisible()){if(o.needsRendering){e=!!e,o.ctx.clearRect(0,0,o.width,o.height);var t=2,n=2,i=o.width-4,r=o.height-4;o.ctx.drawImage(bn.getImage("panel_inset_dark"),t,n,i,r),t+=4,n=7,window.fontLed.write(o.ctx,function(){for(var e=""+a;e.length<s;)e=" "+e;return e}(),t,n,0),o.isDisabled&&(o.ctx.fillStyle="rgba(34, 49, 85, 0.6)",o.ctx.fillRect(0,0,o.width,o.height)),o.renderInternal&&o.renderInternal()}if(o.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)}},o},de.panel=function(e,t,n,i){var r=de.element(e,t,n,i);r.type="panel";var a=["left","top","width","height","name","type","zIndex","backgroundColor","borderColor"];return r.setProperties=function(t){a.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),r.setLayout&&r.setLayout(r.left,r.top,r.width,r.height)},r.render=function(e){if(r.isVisible()){if(e=!!e,this.needsRendering&&(r.clearCanvas(),r.backgroundColor&&(r.ctx.fillStyle=r.backgroundColor,r.ctx.fillRect(0,0,r.width,r.height)),r.borderColor&&(r.ctx.fillStyle=r.borderColor,r.ctx.rect(0,0,r.width,r.height),r.ctx.stroke()),this.children.forEach(function(e){e.render()}),r.renderInternal&&r.renderInternal()),this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},r.onClick=function(){},r.sortZIndex=function(){this.children.sort(function(e,t){return e.zIndex==t.zIndex?0:t.zIndex<e.zIndex||-1})},r},de.radioGroup=function(e,t,n,i){var r,p,m,v=de.element(e,t,n,i,!0),b=[],w="small",x="right",k=-3,P=13,a=["left","top","width","height","name"];return v.setProperties=function(t){a.forEach(function(e){void 0!==t[e]&&(v[e]=t[e])}),v.setSize(v.width,v.height),v.setPosition(v.left,v.top),t.align&&(x=t.align),t.size&&(w=t.size),t.divider&&(p=t.divider),t.type&&0,t.highLightSelection&&(m=!0)},v.onClick=function(e){v.setSelectedIndex(Math.floor((+v.eventY+k)/P))},v.setSelectedIndex=function(e,t){e=Math.min(e,b.length-1);for(var n=0,i=b.length;n<i;n++)b[n].active=n==e;v.selectedIndex=e,v.refresh(),!t&&v.onChange&&r!=v.selectedIndex&&v.onChange(v.selectedIndex),r=v.selectedIndex},v.getSelectedIndex=function(){return v.selectedIndex},v.getSelectedItem=function(){return b[v.selectedIndex]},v.render=function(e){if(e=!!e,v.isVisible()){if(this.needsRendering){v.clearCanvas();var t=bn.getImage("radio_active"),n=bn.getImage("radio_inactive");P=Math.floor(v.height/b.length);var i=fontSmall,r=5,a=v.width-15;k=-3,"med"===w&&(t=bn.getImage("radio_big_active"),n=bn.getImage("radio_big_inactive"),k=-2,a=v.width-20,i=fontMed);var o=Math.floor((P-i.charHeight)/2);"left"===x&&(r=30,a=5);for(var s=bn.getImage("line_hor"),l=0,d=b.length;l<d;l++){var c=b[l],u=0+l*P,f=u+o;if("line"==p&&0<l&&v.ctx.drawImage(s,0,u,v.width,2),i){if("right"===x){var h=c.label;if((r=a-i.getTextWidth(c.label,0)-4)<0&&c.labels){var g=a-4;c.labels.forEach(function(e){e.width<=g&&(h=e.label)}),r=a-i.getTextWidth(h,0)-4}}i.write(v.ctx,h,r,f,0)}c.active?(m&&(v.ctx.fillStyle="rgba(100,100,255,0.1",v.ctx.fillRect(0,u,v.width-2,P)),v.ctx.drawImage(t,a,f+k)):v.ctx.drawImage(n,a,f+k)}}if(this.needsRendering=!1,e)return v.canvas;v.parentCtx.drawImage(v.canvas,v.left,v.top,v.width,v.height)}},v.setItems=function(e){v.selectedIndex=void 0;for(var t=0,n=(b=e).length;t<n;t++)b[t].active&&(v.selectedIndex=t);v.refresh()},v.getItemAtPosition=function(e,t){t=+t;var n=Math.floor(t/P)+visibleIndex;return 0<=n&&n<b.length?(b[n].index=n,b[n]):void 0},v},de.rangeSlider=function(e){var a=de.element();a.type="rangeslider";var n=["left","top","width","height","name","onChange"],o=bn.getImage("slider_knob"),i=bn.getImage("slider_knob_vert"),t=bn.getImage("slider_back"),r=bn.getImage("slider_back_vert"),s=!1,l=0,d=de.scale9Panel(0,0,0,0,{img:t,left:4,right:4,top:0,bottom:0,scale:"repeatX"});a.addChild(d),d.ignoreEvents=!0;var c=0,u=0,f=0,h=0,g=0,p=100,m=0;return a.setProperties=function(t){n.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top),void 0!==t.min&&(g=t.min),void 0!==t.max&&(p=t.max),void 0!==t.value&&a.setValue(t.value,!0),void 0!==t.vertical&&(s=!!t.vertical,d.setProperties({img:r,imgLeft:0,imgRight:0,imgTop:4,imgBottom:4,scale:"repeatY"}))},a.getValue=function(){return m},a.setValue=function(e,t){p<e&&(e=p),e<g&&(e=g);var n=!t&&m!==e;(m=e,s)?u=l*(1-(e-g)/(p-g)):c=(a.width-o.width)*e/p;a.refresh(),n&&!t&&a.onChange&&a.onChange(m)},a.setMax=function(e,t){p=e,!t&&p<m&&a.setValue(p)},a.setMin=function(e,t){g=e,!t&&m<g&&a.setValue(g)},a.render=function(e){if(a.needsRendering){e=!!e,a.clearCanvas();var t=Math.floor(a.width/2)+3,n=a.height;g<0&&(n=Math.floor(n/2)),a.ctx.fillStyle="rgba(255,255,255,0.1",a.ctx.beginPath(),a.ctx.moveTo(t,n),a.ctx.lineTo(t,2),a.ctx.lineTo(t+6,2),a.ctx.fill(),g<0?(a.ctx.beginPath(),a.ctx.moveTo(t-6,n),a.ctx.lineTo(t-6,a.height),a.ctx.lineTo(t-6-6,a.height)):(a.ctx.beginPath(),a.ctx.moveTo(t-6,n),a.ctx.lineTo(t-6,2),a.ctx.lineTo(t-6-6,2)),a.ctx.fill(),d.render(),s?a.ctx.drawImage(i,-1,u,i.width,i.height):a.ctx.drawImage(o,c,-1,o.width,o.height)}if(a.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)},a.onResize=function(){l=a.height-i.height+3,d.setSize(a.width,a.height),a.setValue(m,!0)},a.onDragStart=function(){f=c,h=u},a.onDrag=function(e){if(s){var t=e.deltaY;if((u=h+t)<0&&(u=0),l<u&&(u=l),o.height<l){var n=p-g,i=n-Math.round(n*u/l);m=i+g}else m=p}else{(c=f+(t=e.deltaX))<0&&(c=0);var r=a.width-o.width;r<c&&(c=r),m=o.width<r?Math.round(p*c/r):0}a.refresh(),a.onChange&&a.onChange(m)},e&&a.setProperties(e),a},de.scale9Panel=function(e,t,n,i,c){var u=de.element(e,t,n,i,!0);u.type="scale9",c.scale=c.scale||"stretch",u.setProperties=function(t){var e=["left","top","width","height","name","type"];if(!t){var n={};return e.forEach(function(e){n[e]=u[e]}),n}e.forEach(function(e){void 0!==t[e]&&(u[e]=t[e])}),void 0!==t.img&&(c.img=t.img),void 0!==t.scale&&(c.scale=t.scale),void 0!==t.imgTop&&(c.top=t.imgTop),void 0!==t.imgBottom&&(c.bottom=t.imgBottom),void 0!==t.imgLeft&&(c.left=t.imgLeft),void 0!==t.imgRight&&(c.right=t.imgRight),u.setSize(u.width,u.height),u.setPosition(u.left,u.top)};return u.render=function(e){if(e=!!e,u.isVisible()){if(u.needsRendering&&function(){var e=c.img;if(e){var t=e.width-c.left-c.right,n=e.height-c.top-c.bottom,i=u.width-c.left-c.right,r=u.height-c.top-c.bottom;if(u.clearCanvas(),c.top&&c.left&&u.ctx.drawImage(e,0,0,c.left,c.top,0,0,c.left,c.top),c.top&&u.ctx.drawImage(e,c.left,0,t,c.top,c.left,0,i,c.top),c.top&&c.right&&u.ctx.drawImage(e,c.left+t,0,c.right,c.top,c.left+i,0,c.right,c.top),c.left&&u.ctx.drawImage(e,0,c.top,c.left,n,0,c.top,c.left,r),"stretch"===c.scale&&u.ctx.drawImage(e,c.left,c.top,t,n,c.left,c.top,i,r),"repeatX"===c.scale)for(var a,o=c.left,s=c.left+i;o<s;)s<o+(a=t)&&(a=s-o),u.ctx.drawImage(e,c.left,c.top,a,n,o,c.top,a,n),o+=a;if("repeatY"===c.scale){var l,d=c.top;for(s=c.top+r;d<s;)s<d+(l=n)&&(l=s-d),u.ctx.drawImage(e,c.left,c.top,t,l,c.left,d,t,l),d+=l}c.right&&u.ctx.drawImage(e,c.left+t,c.top,c.right,n,c.left+i,c.top,c.right,r),c.bottom&&c.left&&u.ctx.drawImage(e,0,c.top+n,c.left,c.bottom,0,c.top+r,c.left,c.bottom),c.bottom&&u.ctx.drawImage(e,c.left,c.top+n,t,c.bottom,c.left,c.top+r,i,c.bottom),c.bottom&&c.right&&u.ctx.drawImage(e,c.left+t,c.top+n,c.right,c.bottom,c.left+i,c.top+r,c.right,c.bottom)}}(),u.needsRendering=!1,e)return u.canvas;u.parentCtx.drawImage(u.canvas,u.left,u.top)}},u},de.submenu=function(e,t,n,i){var s,l,d,r,c=de.element(e,t,n,i),a=["left","top","width","height","name","type"];return c.setProperties=function(t){a.forEach(function(e){void 0!==t[e]&&(c[e]=t[e])}),t.background&&((l=de.scale9Panel(0,0,c.width,c.height,t.background)).ignoreEvents=!0,c.addChild(l)),c.setSize(c.width,c.height),c.setPosition(c.left,c.top)},c.onHover=function(e){var t=Math.floor(c.eventY/26);t!=r&&(r=d=t,c.refresh())},c.onHoverExit=function(){d&&(r=d=void 0,c.refresh())},c.onClick=function(e){if(s&&s.length){var t=s[Math.floor(c.eventY/26)];t&&t.command&&(c.hide(),c.parent.refresh(),Bt.trigger(u,t.command))}},c.render=function(e){if(c.isVisible()){if(e=!!e,this.needsRendering){c.clearCanvas(),l&&l.render();for(var t=bn.getImage("line_hor"),n=0,i=c.width-3,r=s.length-1,a=0;a<=r;a++){var o=s[a];a==d&&(c.ctx.fillStyle="rgba(255,255,255,0.2)",c.ctx.fillRect(0,n,i,26)),o.label&&fontFT.write(c.ctx,o.label,9,n+9),n+=26,a<r&&c.ctx.drawImage(t,0,n,i,2)}}if(this.needsRendering=!1,e)return c.canvas;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)}},c.setItems=function(e){var n=50;(s=e).forEach(function(e){var t=e.label?9*e.label.length:0;t+=24,n=Math.max(n,t)}),c.setSize(n,26*s.length+4),l&&l.setSize(c.width,c.height),c.refresh()},c.getItems=function(){return s},c},de.DiskOperationActions=function(){var n=de.panel(),i=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);i.ignoreEvents=!0,n.addChild(i);var r=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);r.ignoreEvents=!0,n.addChild(r);var a=de.label({label:"Action",font:fontSmall});n.addChild(a);var o=de.radioGroup();return o.setProperties({align:"right",size:"med",divider:"line",type:"buttons",highLightSelection:!0}),o.setItems([{label:"load",active:!0},{label:"save",active:!1}]),o.onChange=function(e){Bt.trigger(f,this.getSelectedItem())},n.addChild(o),n.setLayout=function(){var e=n.width-2,t=70;n.height<100&&(t=n.height-20),de.mainPanel&&(n.clearCanvas(),i.setProperties({left:0,top:0,height:n.height,width:n.width}),r.setProperties({left:1,top:1,height:16,width:e}),a.setProperties({left:-1,top:3,height:16,width:e}),o.setProperties({left:4,width:e-4,height:t,top:18}))},n.getAction=function(){var e="load";return 1==o.getSelectedIndex()&&(e="save"),e},n.setSelectedIndex=function(e){o.setSelectedIndex(e)},n},de.DiskOperationSave=function(){function n(){var e=a,t=a.lastIndexOf("."),n="";0<=t&&(e=a.substr(0,t),n=a.substr(t));var i=u.getSelectedItem();i&&i.extention&&(n=i.extention),".mod"===n&&mn.inFTMode()&&(n=".xm"),h.setValue(e+n)}var a,t=de.panel(),o=Ue,s=Ue,l=ze,d="local",r=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);r.ignoreEvents=!0,t.addChild(r);var c={};c[Ue]=[{label:"module",active:!0,extention:".mod",fileType:Ue},{label:"wav",active:!1,extention:".wav",fileType:Ve,fileFormat:Ne.WAVE_PCM},{label:"mp3",active:!1,extention:".mp3",fileType:Ve,fileFormat:Ne.MP3}],c[Ve]=[{label:"wav 16 bit",active:!1,extention:".wav",fileType:Ve,fileFormat:Ne.RIFF_16BIT},{label:"wav 8 bit",active:!0,extention:".wav",fileType:Ve,fileFormat:Ne.RIFF_8BIT},{label:"RAW 8 bit",active:!1,extention:".sample",fileType:Ve,fileFormat:Ne.RAW_8BIT}];var u=de.radioGroup();u.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),u.setItems(c[Ue]),u.onChange=function(e){var t=this.getSelectedItem();o=t&&t.fileType?t.fileType:Ue,l=t&&t.fileFormat?t.fileFormat:ze,n()},t.addChild(u);var f=de.button();f.setProperties({label:"Export",textAlign:"center",background:de.Assets.buttonLightScale9,font:window.fontMed}),f.onClick=function(){if(s==Ue&&(o==Ue&&Jt.save(a,d),o==Ve&&qn.renderFile(a,l===Ne.MP3)),s==Ve){var e=mn.getCurrentInstrument().sample;if(e){if(l===Ne.RAW_8BIT){var t,n=new F(new ArrayBuffer(e.length),!0);for(n.clear(2),i=0;i<e.length-2;i++)t=e.data[i]||0,n.writeByte(Math.round(127*t))}else n=function(e,t){var n=e.length,i=8e3;16===t&&(n=2*e.length,i=16e3);var r=n;r%2==1&&r++;var a=new F(new ArrayBuffer(46+r),!1);if(a.goto(0),a.writeString("RIFF"),a.writeDWord(38+r),a.writeString("WAVE"),a.writeString("fmt "),a.writeDWord(18),a.writeWord(1),a.writeWord(1),a.writeDWord(8e3),a.writeDWord(i),a.writeWord(Math.floor(t/8)),a.writeWord(t),a.writeWord(0),a.writeString("data"),a.writeDWord(n),16===t)for(var o=0;o<e.length;o++)a.writeWord(32767*e[o]);else for(o=0;o<e.length;o++)a.writeUByte(Math.round(127*e[o])+127);return n<r&&a.writeUByte(0),a}(e.data,l===Ne.RIFF_16BIT?16:8);var r=new Blob([n.buffer],{type:"application/octet-stream"});"dropbox"===d?ni.putFile("/"+a,r):Rt(r,a)}}},t.addChild(f);var h=de.inputbox({name:"fileNameInput",height:20,onChange:function(e){a=e},backgroundImage:"panel_mid"});return t.addChild(h),t.setLayout=function(){var e=t.width-2;de.mainPanel&&(t.clearCanvas(),r.setProperties({left:0,top:0,height:t.height,width:t.width}),h.setProperties({left:4,width:e-6,top:4}),f.setProperties({left:2,width:e,height:28,top:t.height-27}),u.setProperties({left:4,width:e-4,height:t.height-f.height-30,top:30}))},Bt.on($,function(e){a=e.filename||"",n()}),Bt.on(T,function(e){(d=e).target&&(d=d.target),e&&e.fileType&&((s=e.fileType)==Ve&&(a=mn.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")),s==Ue&&(a=mn.getFileName()),c[s]&&(u.setItems(c[s]),u.onChange()))}),Bt.on(G,function(e){t.isVisible()&&s==Ve&&(a=mn.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")||"Sample-"+mn.getCurrentInstrumentIndex(),n())}),Bt.on(he,function(e){t.isVisible()&&s==Ue&&(a=mn.getSong().filename||"",n())}),t},de.DiskOperationTargets=function(){function e(e,t){var n=e.findIndex(function(e){return e.target===t});0<=n&&e.splice(n,1)}var t=de.panel(),n=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);n.ignoreEvents=!0,t.addChild(n);var i=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);i.ignoreEvents=!0,t.addChild(i);var r=de.label({label:"From",font:fontSmall});t.addChild(r);var a=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Modarchive:",target:"modarchive"},{label:"Modules.pl:",target:"modulespl"},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],o=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],s=[{label:"local:",target:"local",active:!0},{label:"Dropbox:",target:"dropbox"}];$t.useDropbox||(e(a,"dropbox"),e(o,"dropbox"),e(s,"dropbox"));var l=a,d="load",c=de.radioGroup();return c.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),c.setItems(a),c.onChange=function(e){Bt.trigger(T,this.getSelectedItem())},t.addChild(c),t.setLayout=function(){var e=t.width-3;if(de.mainPanel){t.clearCanvas(),n.setProperties({left:0,top:0,height:t.height,width:t.width}),i.setProperties({left:2,top:1,height:16,width:e}),r.setProperties({left:-1,top:3,height:16,width:e});c.setProperties({width:e,height:t.height-18-2,left:2,top:18})}},t.getTarget=function(){return"bassoon"},Bt.on(T,function(e){e&&e.fileType&&("save"===d?c.setItems(s):(e.fileType===Ue&&(l=a),e.fileType===Ve&&(l=o),c.setItems(l)),c.setSelectedIndex(0))}),Bt.on(f,function(e){"save"===e.label?(r.setLabel("To"),d="save",c.setItems(s)):(r.setLabel("From"),d="load",c.setItems(l)),Bt.trigger(T,c.getSelectedItem())}),Bt.on(g,function(){c.setSelectedIndex(0)}),t},de.DiskOperationType=function(){var n=de.panel(),i=de.scale9Panel(0,0,20,20,de.Assets.panelDarkInsetScale9);i.ignoreEvents=!0,n.addChild(i);var r=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);r.ignoreEvents=!0,n.addChild(r);var a=de.label({label:"Type",font:fontSmall});n.addChild(a);var o=de.radioGroup();return o.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),o.setItems([{label:"module",active:!0,fileType:Ue},{label:"sample",active:!1,fileType:Ve}]),o.onChange=function(e){Bt.trigger(T,this.getSelectedItem())},n.addChild(o),n.setLayout=function(){var e=n.width-2,t=70;n.height<100&&(t=n.height-20),de.mainPanel&&(n.clearCanvas(),i.setProperties({left:0,top:0,height:n.height,width:n.width}),r.setProperties({left:1,top:1,height:16,width:e}),a.setProperties({left:-1,top:3,height:16,width:e}),o.setProperties({left:4,width:e-4,height:t,top:18}))},n.getType=function(){var e=o.getSelectedIndex(),t="modules";return 1==e&&(t="samples"),2==e&&(t="patterns"),t},n.setType=function(e){o.setSelectedIndex(e)},n},de.DiskOperations=function(){function i(t,e){_.setSelectedIndex(e),m=e,t.isExpanded?(t.isExpanded=!1,o.refreshList()):(t.isExpanded=!0,t.children.length?o.refreshList():(t.children=[{title:"loading ..."}],o.refreshList(),n?n.get(t.url,function(e){v(t,e)}):Qt.json(t.url,function(e){v(t,e)})))}var o=de.panel();o.hide();var n,s="load",l="modules",d=[],c=[],u=[],f=[],h=[],g=[],p=0,m=0,v=function(){},e=de.scale9Panel(0,0,20,20,de.Assets.panelMainScale9);e.ignoreEvents=!0,o.addChild(e);var r=de.DiskOperationActions();o.addChild(r);var b=de.DiskOperationType();o.addChild(b);var a=de.DiskOperationTargets();o.addChild(a);var t=de.DiskOperationSave();o.addChild(t);var w={background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1,height:18,width:50},x=de.button(),k=de.button();k.setActive(!0),x.setProperties(w),x.setLabel("Save"),x.onDown=function(){r.setSelectedIndex(1)},o.addChild(x),k.setProperties(w),k.setLabel("Load"),k.onDown=function(){r.setSelectedIndex(0)},o.addChild(k);var P=de.label({label:"Load module",font:fontMed});o.addChild(P);var y=de.Assets.generate("button20_20");y.setLabel("x"),y.onClick=function(){Zt.doCommand(_e)},o.addChild(y);var S=de.Assets.generate("buttonKey");S.setLabel("browse"),S.onClick=function(){var e=document.createElement("input");e.type="file",e.onchange=function(e){mn.handleUpload(e.target.files)},e.click()},o.addChild(S),S.hide();var _=de.listbox();o.addChild(_);var C=de.button();return C.setProperties({background:de.Assets.buttonDarkActiveScale9,image:bn.getImage("dropzone"),font:fontSmall,textAlign:"center"}),C.onClick=S.onClick,o.addChild(C),C.hide(),o.onShow=function(){o.onResize()},o.onResize=function(){if(o.isVisible()){o.clearCanvas(),e.setProperties({left:0,top:0,height:o.height,width:o.width});y.setProperties({top:3,width:20,heigth:18,left:o.width-30}),S.setProperties({top:y.top+2,width:55,height:18,left:y.left-60}),730<=o.width?(r.show(),P.show(),k.hide(),x.hide(),r.setProperties({top:5,left:xn.col1X,width:xn.col1W,height:o.height-10}),b.setProperties({top:5,left:xn.col2X,width:xn.col1W,height:o.height-10}),a.setProperties({top:5,left:xn.col3X,width:xn.col1W,height:o.height-10}),P.setProperties({left:xn.col4X,top:5,height:20,width:xn.col2W}),_.setProperties({left:xn.col4X,width:xn.col2W,top:24,height:o.height-24-5})):(r.hide(),P.hide(),k.show(),x.show(),k.setProperties({top:5,left:xn.col3X}),x.setProperties({top:5,left:xn.col3X+50}),b.setProperties({top:5,left:xn.defaultMargin,width:xn.col2W,height:o.height/2-5-16}),a.setProperties({top:o.height/2-16,left:xn.defaultMargin,width:xn.col2W,height:o.height/2+16}),_.setProperties({left:xn.col3X,width:xn.col3W,top:24,height:o.height-24-5})),"save"===s?(t.setProperties({left:_.left,width:_.width,top:_.top,height:_.height}),_.hide(),t.show()):(_.show(),t.hide()),C.setProperties({left:_.left,width:_.width,top:_.top,height:_.height})}},o.setView=function(e){o.refreshList("samples"===e?"samples":""),0<e.indexOf("_save")&&r.setSelectedIndex(1),0<e.indexOf("_load")&&r.setSelectedIndex(0),0<e.indexOf("_samples")&&b.setType(1),0<e.indexOf("_modules")&&b.setType(0)},o.refreshList=function(e){function t(e,t){d=[],a=0,t=t||0,function n(e,i){e.forEach(function(e){var t;e.icon&&(t=bn.getImage(e.icon)),t=t||bn.getImage("modules"===l?"module":"sample"),e.children&&(t=bn.getImage("disk")),r.push({label:e.title,data:e,level:i,index:a,icon:t,info:e.info}),d[a]=e,a++,e.children&&e.children.length&&e.isExpanded&&n(e.children,i+1)})}(e,0),_.setItems(r),_.setSelectedIndex(t)}if("save"!==s){var r=[],a=0;switch(l!==e&&_.setSelectedIndex(0,!0),"local"==(l=e||l)?(_.hide(),C.show(),S.show()):(_.show(),C.hide(),S.hide(),"bassoon"==l&&(l=b.getType())),l){case"modules":n=!1,P.setLabel("Load Module"),_.onClick=function(e){var t=_.getItemAtPosition(_.eventX,_.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?i(t,n):(_.setSelectedIndex(n),mn.load(t.url),Zt.doCommand(_e))}},c.length?t(c,m):Qt.json($t.getBaseUrl()+"data/modules.json",function(e){e&&e.modules&&t(c=e.modules,m)});break;case"modarchive":n=ii,P.setLabel("Browse Modarchive"),_.onClick=function(e){var t=_.getItemAtPosition(_.eventX,_.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?i(t,n):(_.setSelectedIndex(n),mn.load(t.url),Zt.doCommand(_e))}},v=function(t,e){e&&e.length?"... load more ..."==t.title&&t.parent?(t=t.parent,e.forEach(function(e){e.parent=t}),t.children.pop(),t.children=t.children.concat(e)):(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},f.length?t(f,0):(_.setItems([{label:"loading ..."}]),Qt.json($t.getBaseUrl()+"data/modarchive.json",function(e){e&&e.modarchive&&t(f=e.modarchive,0)}));break;case"modulespl":n=ri,P.setLabel("Browse Modules.pl"),_.onClick=function(e){var t=_.getItemAtPosition(_.eventX,_.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?i(t,n):(_.setSelectedIndex(n),mn.load(t.url),Zt.doCommand(_e))}},v=function(t,e){e&&e.length?"... load more ..."==t.title&&t.parent?(t=t.parent,e.forEach(function(e){e.parent=t}),t.children.pop(),t.children=t.children.concat(e)):(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},h.length?t(h,0):(_.setItems([{label:"loading ..."}]),Qt.json($t.getBaseUrl()+"data/modulespl.json",function(e){e&&e.modulespl&&t(h=e.modulespl,0)}));break;case"dropbox":n=ni,P.setLabel("Browse Your Dropbox"),de.setStatus("Contacting Dropbox",!0),_.setItems([{label:"loading ..."}]),_.onClick=function(e){var n=_.getItemAtPosition(_.eventX,_.eventY);if(n&&n.data){var t=n.index;(n=d[t]).children?i(n,t):(_.setSelectedIndex(t),de.setInfo(n.title),de.setStatus("Loading from Dropbox",!0),ni.getFile(n,function(e){var t=new FileReader;t.onload=function(){mn.processFile(t.result,n.title,function(e){de.setStatus("Ready")})},t.readAsArrayBuffer(e)}))}},v=function(t,e){e&&e.length?(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},g.length?t(g,0):ni.checkConnected(function(e){e?ni.list("",function(e){de.setStatus(""),t(g=e,0)}):ni.showConnectDialog()});break;case"samples":n=!1,P.setLabel("Load Sample to slot "+mn.getCurrentInstrumentIndex()),_.onClick=function(e){var t=_.getItemAtPosition(_.eventX,_.eventY);if(t&&t.data){var n=t.index;(t=d[n]).children?(_.setSelectedIndex(n),p=n,t.isExpanded?(t.isExpanded=!1,o.refreshList()):(t.isExpanded=!0,t.children.length?o.refreshList():Qt.json(t.url,function(e){e&&e.samples&&(t.children=e.samples,o.refreshList())}))):(_.setSelectedIndex(n),mn.load(t.url))}},v=function(e,t){t&&t.samples&&(e.children=t.samples,o.refreshList())},u.length?t(u,p):Qt.json($t.getBaseUrl()+"data/samples.json",function(e){e&&e.samples&&t(u=e.samples,p)});break;case"local":n=!1,P.setLabel("Upload files")}}},o.playRandomSong=function(e){de.setStatus("Fetching random song",!0),de.setInfo(""),Qt.json("https://www.stef.be/bassoontracker/api/random"+(e||""),function(e){e&&e.modarchive&&e.modarchive.module&&mn.load(e.modarchive.module.url)})},Bt.on(T,function(e){var t=r.getAction();if(e&&e.target&&(e=e.target),e&&e.fileType&&(e.fileType===Ue&&(e="modules"),e.fileType===Ve&&(e="samples")),void 0===e&&(e=a.getTarget()),"save"===t){s="save";var n="Export Module";"samples"===(l=b.getType())&&(n="Export Sample"),P.setLabel(n),k.isActive&&k.setActive(!1),x.isActive||x.setActive(!0),C.hide(),S.hide(),o.onResize(),"dropbox"===e&&ni.checkConnected(function(e){e||ni.showConnectDialog()})}else s="load",o.refreshList(e),k.isActive||k.setActive(!0),x.isActive&&x.setActive(!1)}),Bt.on(G,function(e){o.isVisible()&&"samples"==l&&P.setLabel("Load Sample to slot "+mn.getCurrentInstrumentIndex())}),o},de.editPanel=function(e,t,n,i,r){var a=de.element(e,t,n,i,r);a.type="EditPanel";var o=de.scale9Panel(0,0,0,0,de.Assets.panelInsetScale9);a.addChild(o);function s(e){switch(e.index){case 0:Jt.clearTrack(),de.setStatus("Track cleared");break;case 1:Jt.clearPattern(),de.setStatus("Pattern cleared");break;case 2:Jt.copyTrack(),de.setStatus("Track copied");break;case 3:Jt.copyPattern(),de.setStatus("Pattern copied");break;case 4:de.setStatus(Jt.pasteTrack()?"Track pasted":"Nothing to paste!");break;case 5:de.setStatus(Jt.pastePattern()?"Pattern pasted":"Nothing to paste!")}}for(var l=["clear","copy","paste"],d=[],c=0;c<6;c++){var u;(u=de.Assets.generate("buttonDark")).index=c,u.onClick=function(){s(this)},u.setProperties({label:"  "+l[Math.floor(c/2)],font:fontSmall,textAlign:"center",paddingTop:3}),a.addChild(u),d.push(u)}var f=["left","top","width","height","name","type"];return a.setProperties=function(t){f.forEach(function(e){void 0!==t[e]&&(a[e]=t[e])}),a.setSize(a.width,a.height),a.setPosition(a.left,a.top),o.setSize(a.width,a.height);for(var e=Math.floor(a.width/2)-2,n=0;n<6;n++){var i=n%2,r=Math.floor(n/2);d[n].setProperties({left:i*e+2,width:e,top:25+21*r,height:21})}},a.render=function(e){if(e=!!e,a.needsRendering){if(!a.isVisible())return;a.clearCanvas(),o.render(),window.fontMed.write(a.ctx,"↓Track",6,11,0),window.fontMed.write(a.ctx,"↓Pattern",d[1].left+6,11,0);for(var t=0;t<6;t++)d[t].render()}if(a.needsRendering=!1,e)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)},a},de.Envelope=function(e){var c=de.element();c.type=e;var u,o,i,s,f=de.scale9Panel(0,0,c.width,c.height,{img:bn.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});f.ignoreEvents=!0;var l,d,h,g=-1;return c.onResize=function(){d=c.width/324,h=c.height/64},c.onHover=function(e){if(!o&&(g=-1,s=void 0,u&&u.enabled)){for(var t=Math.round(c.eventX/d),n=Math.round((c.height-c.eventY)/h),i=0,r=u.count;i<r;i++){var a=u.points[i]||[0,0];if(Math.abs(t-a[0])<6&&Math.abs(n-a[1])<6){s={p:u.points[g=i],minY:0,maxY:64},0===i?(s.minX=0,s.maxX=0):(s.minX=u.points[i-1][0],s.maxX=324,i<u.count-1&&(s.maxX=u.points[i+1][0]));break}}l!==g&&(l=g,c.refresh())}},c.onDragStart=function(e){s&&(i={startX:e.startX,startY:e.startY,pX:s.p[0],pY:s.p[1]},o=!0)},c.onDrag=function(e){if(o){i.deltaX=e.deltaX/d,i.deltaY=e.deltaY/h;var t=i.pX+i.deltaX;t=Math.min(s.maxX,t),t=Math.max(s.minX,t);var n=i.pY-i.deltaY;n=Math.min(s.maxY,n),n=Math.max(s.minY,n),s.p[0]=t,s.p[1]=n,c.refresh()}},c.onTouchUp=function(e){o=!1},c.setInstrument=function(e){u=e?e[c.type+"Envelope"]:void 0,c.refresh()},c.render=function(){if(this.needsRendering&&(f.width!==c.width&&f.setSize(c.width,c.height),c.ctx.drawImage(f.render(!0),0,0,c.width,c.height),c.ctx.lineWidth=1,"panning"===c.type&&(c.ctx.strokeStyle="#4a7c92",c.ctx.setLineDash([1,2]),a=Math.floor(c.height/2),c.ctx.beginPath(),c.ctx.moveTo(0,a),c.ctx.lineTo(c.width,a),c.ctx.stroke()),u&&u.count)){var e=c.width/324,t=c.height/64;c.ctx.strokeStyle=u.enabled?"rgba(120, 255, 50, 0.5)":"rgba(120, 120, 180, 0.5)",c.ctx.beginPath(),c.ctx.setLineDash([]);for(var n=0;n<u.count;n++){var i=u.points[n];if(i){var r=i[0]*e,a=c.height-i[1]*t,o=4,s=u.enabled?"#D2861B":"#546888";n===g&&(o=6,s="#FFFFFF"),c.ctx.fillStyle=s,0===n?c.ctx.moveTo(r,a):c.ctx.lineTo(r,a);var l=o/2;c.ctx.fillRect(r-l,a-l,o,o)}}if(c.ctx.stroke(),u.enabled){var d=u.points[u.loopStartPoint];d&&(u.sustain&&(c.ctx.strokeStyle="#67b6d2",c.ctx.setLineDash([1,2]),r=d[0]*e,c.ctx.beginPath(),c.ctx.moveTo(r,0),c.ctx.lineTo(r,c.height),c.ctx.stroke()),u.loop&&(c.ctx.strokeStyle="#d2b637",c.ctx.setLineDash([1,2]),r=d[0]*e,c.ctx.beginPath(),c.ctx.moveTo(r,0),c.ctx.lineTo(r,c.height),c.ctx.moveTo(r=d[0]*e,0),c.ctx.lineTo(r,c.height),c.ctx.stroke()))}}this.needsRendering=!1,c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)},c},de.EnvelopePanel=function(t){var i,n=de.panel();n.type=t;var r=!1,a=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);a.ignoreEvents=!0,n.addChild(a);var o=de.label({label:t+" Envelope",font:fontSmall});o.onClick=function(){s.toggle()},n.addChild(o);var s=de.checkbox();s.onToggle=function(e){i&&(i.enabled=e,c.refresh())},n.addChild(s);var l=de.Assets.generate("button20_20");l.onDown=function(){if(i.enabled){if(i.count<i.points.length){var e=i.points[i.count-1]||[0,0],t=i.points[i.count];e[0]+10<320&&(t[0]<=e[0]&&(t[0]=e[0]+10),i.count++)}else{var n=i.points[i.points.length-1];if(n[0]+10<320)i.points.push([n[0]+10,32]),i.count=i.points.length}c.refresh()}},l.setProperties({label:"+",width:18,height:18}),n.addChild(l);var d=de.Assets.generate("button20_20");d.onDown=function(){i.enabled&&(2<i.points.length&&(i.count--,n.checkMax()),c.refresh())},d.setProperties({label:"-",width:18,height:18}),n.addChild(d);var c=de.Envelope(t);n.addChild(c);var u=de.panel(0,0,20,20),f=de.checkbox(),h=de.checkbox(),g=de.spinBox(),p=de.spinBox(),m=de.spinBox();f.onToggle=function(e){g.setDisabled(!e),i.sustain=e,c.refresh()},h.onToggle=function(e){p.setDisabled(!e),m.setDisabled(!e),i.loop=e,c.refresh()},g.setProperties({label:" ",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontFT,onChange:function(e){i.sustainPoint=e,n.checkMax(),c.refresh()}}),p.setProperties({label:"From",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,onChange:function(e){i.loopStartPoint=e,n.checkMax(),c.refresh()}}),m.setProperties({label:"To",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,onChange:function(e){i.loopEndPoint=e,n.checkMax(),c.refresh()}});var v=de.scale9Panel(0,0,u.width,u.height,de.Assets.panelMainScale9);v.ignoreEvents=!0,u.addChild(v),u.addChild(g),u.addChild(p),u.addChild(m);var b=de.label({label:"Sustain",font:fontSmall,width:60});u.addChild(b);var w=de.label({label:"Loop",font:fontSmall,width:60});return u.addChild(w),u.addChild(f),u.addChild(h),n.addChild(u),n.setInstrument=function(e){e&&(i=e[t+"Envelope"],c.setInstrument(e),s.setState(i&&i.enabled),f.setState(i&&i.sustain),h.setState(i&&i.loop),g.setValue(i.sustainPoint||0),p.setValue(i.loopStartPoint||0),m.setValue(i.loopEndPoint||0))},n.setDisabled=function(e){n.ignoreEvents=r=e,n.refresh()},n.onResize=function(){u.setSize(120,n.height);var e=u.width;a.setSize(n.width-e-36,18),o.setSize(n.width-e,20),s.setPosition(2,2),o.setPosition(12,2),c.setPosition(0,20),c.setSize(n.width-e+1,n.height-22),v.setSize(u.width,u.height),u.setPosition(n.width-u.width,0),f.setPosition(4,4),b.setPosition(14,4),g.setProperties({left:10,top:20,width:100,height:28}),h.setPosition(5,50),w.setPosition(14,50),p.setProperties({left:10,top:70,width:100,height:28}),m.setProperties({left:10,top:98,width:100,height:28}),l.setPosition(a.width,a.top),d.setPosition(a.width+18,a.top)},n.renderInternal=function(){r&&(n.ctx.fillStyle="rgba(34, 49, 85, 0.4)",n.ctx.fillRect(0,0,n.width,n.height))},n.checkMax=function(){i.count&&(i.count<=i.sustainPoint&&g.setValue(i.count-1),i.count<=i.loopStartPoint&&p.setValue(i.count-1),i.count<=i.loopEndPoint&&m.setValue(i.count-1))},n},de.fxPanel=function(e){function t(e,t){if(i&&!e.isDisabled)switch(e.getLabel()){case"volume":i.volumeValue(t);break;case"panning":i.panningValue((t-50)/50);break;case"high":i.highValue(t/100);break;case"mid":i.midValue(t/100);break;case"low":i.lowValue(t/100);break;case"lowPass":i.lowPassFrequencyValue(t/100);break;case"reverb":i.reverbValue(t)}}function n(e,t){if(i){var n=e.getLabel();i.setState(n,t)}}var s=de.panel();s.hide(),e=e||0;var l=de.scale9Panel(0,0,20,20,de.Assets.buttonDarkScale9);l.ignoreEvents=!0,s.addChild(l);for(var i,r=["volume","panning","high","mid","low","lowPass","reverb"],a=0,o=10,d=[],c=0,u=r.length;c<u;c++){var f=de.knob();f.setProperties({top:a,left:o,label:r[c],disabled:1<c}),f.onChange=function(e){t(this,e)},f.onToggle=function(e){n(this,e)},s.addChild(f),d.push(f),c%2==0?o+=70:(o=10,a+=70)}return Wt.filterChains&&(i=Wt.filterChains[e]),s.setLayout=function(){if(de.mainPanel){l.setSize(s.width,s.height);var i=Math.max(1,Math.floor(s.width/70)),r=Math.floor((s.width-70*i)/2),a=Math.floor((s.width-2*r)/i),o=0;d.forEach(function(e,t){var n=t%i;e.setPosition(n*a+r,o),n==i-1&&(o+=70)})}},s},de.InfoPanel=function(){var i,r=de.element(),a="",o="",s=de.Assets.generate("buttonDark");s.setLabel("More info "),s.onClick=function(){i&&window.open(i)},r.addChild(s);var l=de.animsprite(5,7,20,18,"boing",11);r.addChild(l),l.hide(),Bt.on(E,function(e){e&&(void 0!==e.status&&(o=e.status),void 0!==e.info&&(a=e.info,i=e.url),void 0!==e.showSpinner&&l.toggle(!!e.showSpinner)),r.refresh()});var e=["left","top","width","height","name","type","zIndex"];return r.setProperties=function(t){e.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),r.setLayout&&r.setLayout(r.left,r.top,r.width,r.height)},r.setLayout=function(){var e=xn.col1W,t="More Info";e<100&&(t="info"),e<45&&(t="i"),s.setProperties({width:xn.col1W,height:24,top:2,left:xn.col5X-2-r.left,label:t,font:fontFT})},r.render=function(e){if(r.isVisible()){if(e=!!e,this.needsRendering){r.clearCanvas(),i&&s.render();var t=a;o&&(t=o+": "+t);var n=6;l.isVisible()&&(l.render(),n+=20),window.fontFT.write(r.ctx,t,n,11,0)}if(this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},r};var Pn=function(){function g(){if(p.length){var e=p.shift();if(e.source)try{e.source.stop()}catch(e){}}}var c,l,u={},d={};d.touches=[];var f,a=0,o=!(d.mouseWheels=[]),p=[],m={},h=!1,v=2,t=3,n=1,b=13;u.init=function(){function e(s){function e(e,t,n){d.isTouchDown=!0;var i=sn.getBoundingClientRect();t-=i.left+window.pageXOffset,n-=i.top+window.pageYOffset,(l=de.getModalElement())?(l.eventX=t,l.eventY=n):l=de.getEventElement(t,n),l&&c&&c.deActivate&&c.name!==l.name&&c.deActivate();var r=l?l.eventX:t,a=l?l.eventY:n,o={id:e,x:r,y:a,startX:r,startY:a,globalX:t,globalY:n,globalStartX:t,globalStartY:n,UIobject:l,isMeta:s.shiftKey||s.metaKey||s.ctrlKey||s.altKey};d.touches.push(o),o.UIobject&&(o.UIobject.onDragStart&&o.UIobject.onDragStart(o),o.UIobject.onDown&&o.UIobject.onDown(o))}if(s.preventDefault(),window.focus(),o||void 0!==Wt&&Wt.playSilence&&Wt.context&&"suspended"!==Wt.context.state&&(Wt.playSilence(),o=!0),s.touches&&0<s.touches.length)for(var t=s.changedTouches,n=0;n<t.length;n++){var i=t[n];e(i.identifier,i.pageX,i.pageY)}else{var r=w("notouch");0<=r&&d.touches.splice(r,1),e("notouch",s.pageX,s.pageY)}}function t(e){function t(e,t,n){if(0<=e){var i=d.touches[e];i.globalX=t-window.pageXOffset,i.globalY=n-window.pageYOffset,i.deltaX=i.globalX-i.globalStartX,i.deltaY=i.globalY-i.globalStartY,i.x=i.startX+i.deltaX,i.y=i.startY+i.deltaY,d.touches.splice(e,1,i),d.isTouchDown&&i.UIobject&&i.UIobject.onDrag&&(i.dragX=t,i.dragY=n,i.UIobject.onDrag(i))}}e.preventDefault();var n=sn.getBoundingClientRect();if(e.touches&&0<e.touches.length)for(var i=e.changedTouches,r=0;r<i.length;r++){var a=i[r];t(w(a.identifier),a.pageX-n.left,a.pageY-n.top)}else{var o=e.pageX-n.left,s=e.pageY-n.top;if(t(w("notouch"),o,s),d.currentMouseX=o,d.currentMouseY=s,d.mouseMoved=(new Date).getTime(),Lt.useHover){var l=de.getEventElement(o,s);l&&l.onHover&&l.onHover(d),f&&f!=l&&f.onHoverExit&&f.onHoverExit(d,l),f=l}}}function n(e){function t(e){if(0<=e){var t=d.touches[e],n=t.startX-t.x,i=t.startY-t.y,r=Math.sqrt(n*n+i*i),a=!0;if(t.UIobject){var o=t.UIobject;o.keepSelection&&(a=!1),r<8&&o.onClick&&o.onClick(t),o.onTouchUp&&o.onTouchUp(t)}a&&r<8&&de.clearSelection(),d.touches.splice(e,1)}}if(o||Wt&&Wt.checkState&&Wt.checkState(),d.isTouchDown=!1,e&&e.touches)for(var n=e.changedTouches,i=0;i<n.length;i++){t(w(n[i].identifier))}else t(w("notouch"))}function i(e){if(d.currentMouseX){var t=de.getEventElement(d.currentMouseX,d.currentMouseY);if(t&&t.onMouseWheel){d.mouseWheels.unshift(e.wheelDeltaY||e.wheelDelta||-e.detail),10<d.mouseWheels.length&&d.mouseWheels.pop(),t.onMouseWheel(d)}}}function r(){Zt.isPlugin||(clearTimeout(a),a=setTimeout(function(){de.setSize(window.innerWidth,window.innerHeight)},100))}sn.addEventListener("mousedown",e,!1),sn.addEventListener("mousemove",t,!1),sn.addEventListener("mouseup",n,!1),sn.addEventListener("touchstart",e,!1),sn.addEventListener("touchmove",t,!1),sn.addEventListener("touchend",n,!1),window.navigator.msPointerEnabled&&(sn.addEventListener("MSPointerDown",e,!1),sn.addEventListener("MSPointerMove",t,!1),sn.addEventListener("MSPointerEnd",n,!1)),sn.addEventListener("mousewheel",i,!1),sn.addEventListener("DOMMouseScroll",i,!1),window.addEventListener("keydown",function(e){e.preventDefault();var t=Et[Lt.keyboardTable]||Et.azerty,n=e.keyCode,i=e.key,r={shift:e.shiftKey,control:e.ctrlKey,alt:e.altKey,command:e.metaKey};if(h=r.command||r.control||r.alt||r.shift,!i&&e.keyIdentifier){var a=e.keyIdentifier;a=a.replace("U+",""),i=String.fromCharCode(parseInt(a,16)).toLowerCase()}if(c&&c.onKeyDown&&c.onKeyDown(n,e))return;switch(n){case 8:return mn.isRecording()?void(h?(Jt.removeNote(),mn.moveCurrentPatternPos(-1)):(0===(s=Jt.getCurrentTrackPosition())?Jt.putNote(0,0):!mn.inFTMode()||3!==s&&4!==s?Jt.putNoteParam(s,0):Jt.putNoteParam(s,-1),mn.moveCurrentPatternPos(1))):(mn.playPatternStep(Jt.getCurrentTrackPosition()),void mn.moveCurrentPatternPos(-1));case 9:return e.stopPropagation(),e.preventDefault(),void Jt.moveCursorPosition(h?-Jt.getStepsPerTrack():Jt.getStepsPerTrack());case 13:return void(mn.isRecording()&&h?(Jt.insertNote(),mn.moveCurrentPatternPos(1)):mn.togglePlay());case 16:break;case 27:de.clearSelection();break;case 32:return void mn.toggleRecord();case 33:var o=Math.floor(mn.getPatternLength()/4);0===o&&(o=1);var s=Math.floor(mn.getCurrentPatternPos()/o)*o;return mn.getCurrentPatternPos()===s&&(s-=o),s<0&&(s=0),void mn.setCurrentPatternPos(s);case 34:return 0===(o=Math.floor(mn.getPatternLength()/4))&&(o=1),s=Math.ceil(mn.getCurrentPatternPos()/o)*o,mn.getCurrentPatternPos()===s&&(s+=o),s>=mn.getPatternLength()-1&&(s=mn.getPatternLength()-1),void mn.setCurrentPatternPos(s);case 35:return void mn.setCurrentPatternPos(mn.getPatternLength()-1);case 36:return void mn.setCurrentPatternPos(0);case 37:return void Jt.moveCursorPosition(-1);case 38:return void mn.moveCurrentPatternPos(-1);case 39:return void Jt.moveCursorPosition(1);case 40:return void mn.moveCurrentPatternPos(1);case 46:return void(mn.isRecording()&&(0===(s=Jt.getCurrentTrackPosition())?Jt.putNote(0,0):Jt.putNoteParam(s,0),mn.moveCurrentPatternPos(1)));case 112:case 113:case 114:case 115:case 116:case 117:case 118:return void u.setCurrentOctave(n-111);case 119:case 120:case 121:case 122:case 123:case 221:return}if(i&&40<n&&n<230){if(h&&65<=n&&n<=90){switch(e.stopPropagation(),e.preventDefault(),n){case 65:return void Bt.trigger(pe);case 67:return void de.copySelection(!0);case 86:return void de.pasteSelection(!0);case 88:return void de.cutSelection(!0);case 89:return void Bt.trigger(ne);case 90:return void Bt.trigger(C)}return}var l=-1,d=t[i];"number"==typeof d&&(l=12*v+d,0===d&&(l=0)),u.handleNoteOn(l,i)}},!1),window.addEventListener("keyup",function(e){var t=e.key;if(!t&&e.keyIdentifier){var n=e.keyIdentifier;n=n.replace("U+",""),t=String.fromCharCode(parseInt(n,16)).toLowerCase()}var i,r=e.keyCode;if(16!==(i=r)&&17!==i&&18!==i&&91!==i&&93!==i||(h=!1),t&&40<r&&r<200){var a=(Et[Lt.keyboardTable]||Et.azerty)[t];if("number"==typeof a)return u.handleNoteOff(12*v+a)}},!1),sn.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),sn.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),sn.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),mn.handleUpload(e.dataTransfer.files)},!1),window.addEventListener("paste",function(e){de.pasteSelection(!0)},!1),window.addEventListener("copy",function(e){de.copySelection(!0)},!1),window.addEventListener("cut",function(e){de.cutSelection(!0)},!1),window.addEventListener("delete",function(e){},!1),Zt.isPlugin||window.addEventListener("resize",r,!1),r()};var w=function(e){for(var t=0;t<d.touches.length;t++)if(d.touches[t].id===e)return t;return-1};return u.setFocusElement=function(e){c&&c.deActivate&&c.deActivate();c=e},u.clearFocusElement=function(){c&&c.deActivate&&c.deActivate(),c=void 0},u.clearInputNotes=function(){for(;p.length;)g()},u.getCurrentOctave=function(){return v},u.setCurrentOctave=function(e){e<=t&&n<=e&&Bt.trigger(_,v=e)},u.handleNoteOn=function(e,t,n){var i,r,a=!0;if(0<=e&&(b=e,de.clearSelection(),i=Math.floor((e-1)/12)+1,r=At[(e-1)%12+1]))if(mn.inFTMode())if("OFF"===r.name)a=!(u={period:1,index:0});else{var o=gn[e];o&&(u={period:o.period,index:e})}else u=nt[r.name+(i-1)];if(mn.isRecording())if(0<Jt.getCurrentTrackPosition()){a=!1;var s=/[0-9A-Fa-f]/g,l=-1;if(s.test(t=t||"")?l=parseInt(t,16):mn.inFTMode()&&5===Jt.getCurrentTrackPosition()&&(s=/[0-9A-Za-z]/g).test(t)&&(l=parseInt(t,36)),mn.inFTMode()&&3===Jt.getCurrentTrackPosition())switch(l=-1,t){case"0":l=0;break;case"1":l=1;break;case"2":l=2;break;case"3":l=3;break;case"4":l=4;break;case"-":l=5;break;case"+":l=6;break;case"d":case"D":l=7;break;case"u":case"U":l=8;break;case"s":case"S":l=9;break;case"v":case"V":l=10;break;case"p":case"P":l=11;break;case"<":l=12;break;case">":l=13;break;case"M":l=14}255<l&&(l=-1),0<=l&&(Jt.putNoteParam(Jt.getCurrentTrackPosition(),l),mn.moveCurrentPatternPos(1))}else{if(m[e])return;u&&(Jt.putNote(mn.getCurrentInstrumentIndex(),u.period,u.index),mn.isPlaying()||mn.moveCurrentPatternPos(1))}if(a&&u){if(m[e])return;var d=mn.getCurrentInstrument();if(d){if(u.index&&(d.setSampleForNoteIndex(u.index),d.sample.relativeNote)){u.index+=d.sample.relativeNote;var c=gn[u.index];c&&(u.period=c.period)}Wt.checkState();var u,f=void 0;if(n&&(f={offset:{value:n}}),m[e]=d.play(u.index,u.period,void 0,void 0,f),m[e].instrument=d,m[e].isKey=!0,p.push(m[e]),(u=m[e]).scheduled&&u.scheduled.vibrato){var h=d.scheduleAutoVibrato(u,2);u.scheduled.vibrato+=h}64<p.length&&g(),Bt.trigger(x,e)}}},u.handleNoteOff=function(e){if(!Lt.sustainKeyboardNotes&&m[e]&&m[e].source&&Wt.context){Bt.trigger(k,e);try{m[e].instrument?m[e].instrument.noteOff(Wt.context.currentTime,m[e]):m[e].source.stop()}catch(e){}}m[e]=!1},u.isMetaKeyDown=function(){return h},u.getPrevIndex=function(){return b},Bt.on(W,function(){if(Wt.context){var n=Wt.context.currentTime;p.forEach(function(e){if(e&&e.time&&e.scheduled){if(e.scheduled.volume&&e.scheduled.volume<=n+2&&e.instrument){var t=e.instrument.scheduleEnvelopeLoop(e.volumeEnvelope,e.scheduled.volume,2);e.scheduled.volume+=t}e.scheduled.panning&&e.scheduled.panning<=n+2&&e.instrument&&(t=e.instrument.scheduleEnvelopeLoop(e.panningEnvelope,e.scheduled.panning,2),e.scheduled.panning+=t),e.scheduled.vibrato&&e.scheduled.vibrato<=n+2&&e.instrument&&(t=e.instrument.scheduleAutoVibrato(e,2),e.scheduled.vibrato+=t)}})}}),Bt.on(he,function(e){mn.inFTMode()?(t=7,n=0,u.setCurrentOctave(v+2)):(t=3,n=1,u.setCurrentOctave(Math.min(Math.max(v-2,n),t)))}),u}();de.MainPanel=function(){var i=de.panel(0,0,sn.width,sn.height,!0);i.setProperties({backgroundColor:"#071028"}),i.name="mainPanel";var n={},r=de.app_menu(i);i.addChild(r);var a=de.app_mainPanel();i.addChild(a);var o=de.app_controlPanel();i.addChild(o);var s=de.app_patternPanel();i.addChild(s);var l=de.app_sidebar();xn.showAppSideBar&&i.addChild(l);var d=de.app_pianoView();return d.hide(),i.addChild(d),i.createContextMenu=function(e){var t=n[e.name];return t||((t=de.menu(100,100,128,42,i)).zIndex=100,t.setProperties({background:de.Assets.panelMainScale9,layout:"buttons"}),t.setItems(e.items),t.hide(),i.addChild(t),n[e.name]=t),t},i.onResize=function(){xn.setLayout(i.width,i.height),r.setSize(xn.mainWidth,r.height);var e=r.height;a.setSize(xn.mainWidth,a.height),a.setPosition(xn.mainLeft,e),e+=a.height,o.setSize(xn.mainWidth,xn.controlPanelHeight),o.setPosition(xn.mainLeft,e);var t=i.height-(e+=o.height);d.isVisible()&&(d.setSize(xn.mainWidth,xn.pianoHeight),d.setPosition(xn.mainLeft,i.height-d.height),t-=d.height),s.setPosition(xn.mainLeft,e),s.setSize(xn.mainWidth,t),l.setPosition(0,0),l.setSize(xn.sidebarWidth,i.height)},i.sortZIndex(),i.onResize(),Bt.on(h,function(e){if("piano"===e){d.toggle();var t=i.height-s.top;d.isVisible()&&(d.setSize(xn.mainWidth,xn.pianoHeight),d.setPosition(xn.mainLeft,i.height-d.height),t-=d.height),s.setSize(xn.mainWidth,t)}"sidebar"===e&&(xn.showAppSideBar=!xn.showAppSideBar,xn.setLayout(),i.onResize())}),Bt.on(R,function(e){var t=i.createContextMenu(e),n=e.x;xn.mainWidth<n+t.width&&(n=xn.mainWidth-t.width),t.setPosition(n,e.y-t.height-2),t.show(),i.refresh()}),Bt.on(V,function(){for(var e in n)n[e].hide();i.refresh()}),i},de.OptionsPanel=function(){var p=de.panel();p.hide();var t=de.scale9Panel(0,0,20,20,de.Assets.panelMainScale9);t.ignoreEvents=!0,p.addChild(t);var e=de.label({label:"Options:",font:fontMed,left:5,height:18,top:9,width:200});p.addChild(e);var n=de.Assets.generate("button20_20");n.setLabel("x"),n.onClick=function(){Zt.doCommand(_e)},p.addChild(n);var i=[{label:"VU bars",values:["NONE","COLOURS: AMIGA","TRANSPARENT"],setValue:function(e){Lt.vubars=0===e?"none":2===e?"trans":"colour",rn.saveSettings()},getValue:function(){var e=1;return"none"===Lt.vubars&&(e=0),"trans"===Lt.vubars&&(e=2),e}},{label:"Stereo",values:["Hard: Amiga","Balanced","None: mono"],setValue:function(e){Wt.setStereoSeparation(0===e?He:2===e?Ge:Xe),rn.saveSettings()},getValue:function(){var e=1;return Lt.stereoSeparation===Ge&&(e=2),Lt.stereoSeparation===He&&(e=0),e}},{label:"Keyboard Layout",labels:[{width:56,label:"Keyboard"},{width:110,label:"Keyboard Layout"}],values:["QWERTY","AZERTY","QWERTZ","Dvorak"],setValue:function(e){Lt.keyboardTable=0===e?"qwerty":1===e?"azerty":2===e?"qwertz":"dvorak",rn.saveSettings()},getValue:function(){var e=0;return"azerty"===Lt.keyboardTable&&(e=1),"qwertz"===Lt.keyboardTable&&(e=2),"dvorak"===Lt.keyboardTable&&(e=3),e}},{label:"Screen refresh",labels:[{width:56,label:"Screen"},{width:100,label:"Screen refresh"}],values:["Smooth","Normal","Economical","Low CPU"],setValue:function(e){de.skipFrame(e),rn.saveSettings()},getValue:function(){return de.getSkipFrame()}},{label:"Frequency table",labels:[{width:56,label:"Frequency"},{width:110,label:"Frequency table"}],values:["Linear","Amiga periods"],setValue:function(e){mn.useLinearFrequency=0===e},getValue:function(){return mn.useLinearFrequency?0:1}},{label:"Dropbox: existing file",labels:[{width:20,label:"Dropbox"},{width:80,label:"Dropbox save"},{width:160,label:"Dropbox existing file"}],values:["Rename","Overwrite"],setValue:function(e){Lt.dropboxMode=0===e?"rename":"overwrite",rn.saveSettings()},getValue:function(){var e=0;return"overwrite"===Lt.dropboxMode&&(e=1),e}}];return i.forEach(function(e){var t=de.scale9Panel(0,0,20,20,de.Assets.panelDarkGreyScale9);t.ignoreEvents=!0,p.addChild(t);var n=de.label();n.setProperties({label:e.label,labels:e.labels,font:fontSmall,textAlign:"center"}),p.addChild(n),e.labelBox=t,e.label=n;for(var i=[],r=e.getValue(),a=0;a<e.values.length;a++){var o,s=e.values[a];s&&((o=de.Assets.generate("buttonKey")).setProperties({label:s}),o.setActive(a===r),o.index=a,o.option=e,o.onClick=function(){this.isDisabled||activateOption(this)}),p.addChild(o),i.push(o)}e.buttons=i}),activateOption=function(e){var t=e.option;t.buttons.forEach(function(e){e.setActive(!1)}),e.setActive(!0),t.setValue(e.index)},p.onShow=function(){p.onResize()},p.onResize=function(){if(p.isVisible()){p.clearCanvas(),t.setProperties({left:0,top:0,height:p.height,width:p.width});n.setProperties({top:5,left:p.width-30});var s=[27,103],l=26,d=20,c=0,u=0,f=!1,h=i.length,e=i.length;p.width<600&&(f=!0,s=[27,103],d=l=18,e=4);var g=Math.floor((p.width-xn.defaultMargin*(e+1))/e);i.forEach(function(e,t){var n=xn.defaultMargin+c*(g+xn.defaultMargin),i=s[u];h<=t&&(n=p.width+100),e.labelBox.setProperties({top:i,width:g,height:l,left:n}),e.label.setProperties({top:i+3,_width:xn.col31W,width:g,height:l,left:n+2});for(var r=e.getValue(),a=0;a<e.buttons.length;a++){var o=e.buttons[a];o.setProperties({top:i+a*d+l,height:d,width:g,left:n}),o.setActive(a===r)}c++,f&&4<=c&&(c=0,u++)})}},Bt.on($,function(){p.isVisible()&&p.onResize()}),Bt.on(he,function(){var e=i[4];e.buttons&&e.buttons.length&&e.buttons.forEach(function(e){e.setDisabled(!mn.inFTMode())});var t=i[1];t.buttons&&t.buttons.length&&t.buttons.forEach(function(e){e.setDisabled(mn.inFTMode())}),p.isVisible()&&p.onResize()}),p},de.SampleView=function(){function e(e){var t=mn.getCurrentInstrument();if(t)if(16===e)g.setActive(!(t.sample.bits=16)),p.setActive(!0);else{for(var n=0,i=t.sample.data.length;n<i;n++)t.sample.data[n]=Math.round(127*t.sample.data[n])/127;t.sample.bits=8,g.setActive(!0),p.setActive(!1)}}function n(e){"loop"===e?(T.show(),_.show(),S.show(),I.hide(),M.hide(),A.hide(),R.setActive(),V.setActive(!1),E.forEach(function(e){e.hide()})):(T.hide(),_.hide(),S.hide(),I.show(),M.show(),A.show(),R.setActive(!1),V.setActive(),E.forEach(function(e){e.show()})),u.onResize()}function i(n){E.forEach(function(e,t){e.setActive(n===t)});var e=mn.getCurrentInstrument();e&&(e.vibrato.type=n)}var r,u=de.panel();u.hide();var t=window;t=window.fontCondensed;var f=de.inputbox({name:"instrumentName",height:20,onChange:function(e){if(r){var t=mn.getInstrument(r);t&&(t.name=e),Bt.trigger(ee,r)}}});u.addChild(f);var h=de.Assets.generate("button20_20");h.setLabel("x"),h.onClick=function(){Zt.doCommand(Ce)},u.addChild(h);var a={background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},g=de.button(),p=de.button();g.setProperties(a),g.setLabel("8"),g.setActive(!0),g.onDown=function(){e(8)},u.addChild(g),p.setProperties(a),p.setLabel("16"),p.onDown=function(){e(16)},u.addChild(p);var m=de.WaveForm();u.addChild(m);var v=de.EnvelopePanel("volume");u.addChild(v);var b=de.EnvelopePanel("panning");u.addChild(b);var w=new de.panel;w.setProperties({name:"instrumentSideButtonPanel"});var x=de.spinBox({name:"Instrument",label:"",value:1,max:64,padLength:2,min:1,font:t,onChange:function(e){mn.setCurrentInstrumentIndex(e)}});u.addChild(x);var k=de.sliderBox({label:"Volume",font:t,height:200,width:40,value:64,max:64,min:0,step:1,vertical:!0,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.sample.volume=e)}});w.addChild(k);var P=de.sliderBox({name:"Finetune",label:"Finetune",font:t,value:0,max:7,min:-8,step:1,vertical:!0,onChange:function(e){var t=mn.getCurrentInstrument();t&&t.setFineTune(e)}});w.addChild(P);var y=de.sliderBox({name:"Panning",label:"Panning",font:t,value:0,max:127,min:-127,vertical:!0,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.panning=e,t.sample.panning=e)}});w.addChild(y);var S=de.spinBox({name:"Repeat",label:"Start",value:0,max:65535,min:0,step:2,font:t,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.sample.length<t.sample.loop.length+e&&S.setValue(e=t.sample.length-t.sample.loop.length,!0),t.sample.loop.start=e),m.refresh()}});w.addChild(S);var _=de.spinBox({name:"Repeat Length",label:"Length",value:0,max:65535,min:0,step:2,font:t,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.sample.length<t.sample.loop.start+e&&_.setValue(e=t.sample.length-t.sample.loop.start,!0),t.sample.loop.length=e),Bt.trigger(N,{interal_loopLength:e}),m.refresh()}});w.addChild(_);var C=de.sliderBox({name:"Fadeout",label:"Fadeout",value:0,max:4095,min:0,step:1,font:t,vertical:!0,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.fadeout=e)}});w.addChild(C);var T=de.spinBox({name:"relativeNote",label:"RelativeNote",value:0,max:128,min:-127,step:1,font:t,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.sample.relativeNote=e)}});w.addChild(T);var I=de.spinBox({name:"vibratoSpeed",label:"Vib Speed",value:0,max:63,min:0,step:1,font:t,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.vibrato.rate=e)}});w.addChild(I),I.hide();var M=de.spinBox({name:"vibratoDepth",label:"Vib Depth",value:0,max:15,min:0,step:1,font:t,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.vibrato.depth=e)}});w.addChild(M),M.hide();var A=de.spinBox({name:"vibratoSweep",label:"Vib Sweep",value:0,max:255,min:0,step:1,font:t,onChange:function(e){var t=mn.getCurrentInstrument();t&&(t.vibrato.sweep=e)}});w.addChild(A),A.hide();var E=[];["sin","square","saw","saw_inverse"].forEach(function(e,t){var n=de.button();n.setProperties({background:de.Assets.buttonKeyScale9,activeBackground:de.Assets.buttonKeyActiveScale9,image:bn.getImage("wave_"+e),activeImage:bn.getImage("wave_"+e),isActive:!1}),n.onDown=function(){i(t)},n.hide(),w.addChild(n),E.push(n)}),i(0),u.addChild(w);var D=[],o=[{label:"Zoom In",width:62,onClick:function(){m.zoom(2)}},{label:"Out",width:38,onClick:function(){m.zoom(.5)}},{label:"All",width:50,onClick:function(){m.zoom(1)}},{value:0,width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.sampleLength&&e.setValue(t.sampleLength)}},{label:"Loop",width:50,onClick:function(){m.zoom("loop")}},{value:0,width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.loopLength&&e.setValue(t.loopLength),void 0!==t.interal_loopLength&&e.setValue(t.interal_loopLength)}},{label:"Range",width:50,onClick:function(){m.zoom("range")}},{value:"0",width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.rangeLength&&e.setValue(t.rangeLength)}}],s=[{label:"Reverse",onClick:function(){m.reverse()}},{label:"Invert",onClick:function(){m.invert()}},{label:"Upsample",onClick:function(){m.resample("up")}},{label:"DownSample",onClick:function(){m.resample("down")}}],l=[{label:"Maximize",onClick:function(){m.adjustVolume("max")}},{label:"Fade In",width:62,onClick:function(){m.adjustVolume("fadein")}},{label:"Out",width:38,onClick:function(){m.adjustVolume("fadeout")}},{label:"-5%",width:50,onClick:function(){m.adjustVolume(-5)}},{label:"+5%",width:50,onClick:function(){m.adjustVolume(5)}},{label:"-10%",width:50,onClick:function(){m.adjustVolume(-10)}},{label:"+10%",width:50,onClick:function(){m.adjustVolume(10)}}],d=[{label:"[",width:15,onClick:function(){m.select("start")}},{label:"All",width:70,onClick:function(){m.select("all")}},{label:"]",width:15,onClick:function(){m.select("end")}},{label:"None",width:50,onClick:function(){m.select("none")}},{label:"Loop",width:50,onClick:function(){m.select("loop")}},{label:"Cut",width:50,onClick:function(){de.cutSelection()}},{label:"Copy",width:50,onClick:function(){de.copySelection()}},{label:"Paste",onClick:function(){de.pasteSelection()}}];[{label:"Load",onClick:function(){Bt.trigger(O,"diskop_samples_load")}},{label:"Play",onDown:function(){Pn.handleNoteOn(Pn.getPrevIndex())},onUp:function(){Pn.handleNoteOff(Pn.getPrevIndex()),Pn.clearInputNotes(),m.stop()}},{label:"Range",onDown:function(){m.playSection("range")},onUp:function(){Pn.handleNoteOff(Pn.getPrevIndex()),Pn.clearInputNotes(),m.stop()}},{label:"Loop",onDown:function(){m.playSection("loop")},onUp:function(){Pn.handleNoteOff(Pn.getPrevIndex()),Pn.clearInputNotes(),m.stop()}},{label:"Stop",onClick:function(){Pn.clearInputNotes(),m.stop()}},{label:"More",onClick:function(){F.toggle(),L.toggle(),B.toggle(),W.toggle(),v.toggle(),b.toggle(),u.refresh()}}].forEach(function(e){var t=de.Assets.generate("buttonLight");t.setLabel(e.label),t.onClick=e.onClick,t.onDown=e.onDown,t.onTouchUp=e.onUp,u.addChild(t),D.push(t)});var F=de.buttonGroup("Display",o),L=de.buttonGroup("Select",d),B=de.buttonGroup("Edit",s),W=de.buttonGroup("Volume",l);u.addChild(F),u.addChild(L),u.addChild(B),u.addChild(W);var R=de.button();R.setProperties({background:de.Assets.panelDarkGreyScale9,activeBackground:de.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Loop",font:fontSmall,paddingTop:2,paddingTopActive:2,paddingLeft:20}),R.onDown=function(){n("loop")},u.addChild(R);var U=de.checkbox();U.onToggle=function(e){var t=mn.getInstrument(r);t&&(t.sample.loop.enabled=e),S.setDisabled(!e),_.setDisabled(!e),m.refresh()},u.addChild(U);var V=de.button();return V.setProperties({background:de.Assets.panelDarkGreyScale9,activeBackground:de.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Vibrato",font:fontSmall,paddingTop:2,paddingTopActive:2}),V.onDown=function(){n("vibrato")},u.addChild(V),u.onShow=function(){u.onResize()},u.onResize=function(){if(u.isVisible()){u.clearCanvas();var e=130,t=w.height-e-10,n=Math.ceil(w.width/4),i=0,r=2*n;w.width<170&&(n=Math.ceil(w.width/2),i=t=Math.floor(t/2),r=0),m.setPosition(xn.col2X,20+xn.defaultMargin+8),m.setSize(xn.col4W,u.height-m.top-e-28-8),v.setPosition(xn.col2X,m.top+m.height+xn.defaultMargin+30),v.setSize(xn.col2W,e),b.setPosition(xn.col4X,v.top),b.setSize(xn.col2W,e),B.setSize(xn.col1W,e),F.setSize(xn.col1W,e),L.setSize(xn.col1W,e),W.setSize(xn.col1W,e),F.setPosition(xn.col2X,m.top+m.height+xn.defaultMargin+30),L.setPosition(xn.col3X,F.top),B.setPosition(xn.col4X,F.top),W.setPosition(xn.col5X,F.top);var a=0,o=100;mn.inFTMode()&&(a=40,o=0),f.setProperties({top:xn.defaultMargin,left:xn.col2X+71,width:xn.col4W-71-25-xn.defaultMargin-a}),h.setProperties({top:xn.defaultMargin,left:f.left+f.width+xn.defaultMargin+a}),g.setProperties({top:xn.defaultMargin,width:20,height:20,left:f.left+f.width+xn.defaultMargin-2+o}),p.setProperties({top:xn.defaultMargin,width:20,height:20,left:f.left+f.width+xn.defaultMargin+18+o}),w.setProperties({left:0,top:0,width:xn.col1W,height:u.height}),x.setProperties({left:xn.col2X,top:1,width:68,height:28}),k.setProperties({left:0,top:0,width:n,height:t}),P.setProperties({left:n,top:0,width:n,height:t}),C.setProperties({left:r,top:i,width:n,height:t}),y.setProperties({left:r+n,top:i,width:n,height:t});var s=m.top+m.height+xn.defaultMargin,l=xn.col4W/D.length;D.forEach(function(e,t){e.setProperties({width:l,height:28,left:xn.col2X+l*t,top:s})}),R.setProperties({width:xn.col1W/2,height:18,left:2,top:v.top}),U.setPosition(R.left+2,R.top+2),V.setProperties({width:R.width,height:R.height,left:R.left+R.width,top:R.top});S.setProperties({left:0,top:R.top+24,width:xn.col1W,height:34}),_.setProperties({left:0,top:R.top+24+34,width:xn.col1W,height:34}),T.setProperties({left:0,top:R.top+24+68,width:xn.col1W,height:34}),I.setProperties({left:0,top:V.top+22,width:xn.col1W,height:30}),M.setProperties({left:0,top:V.top+22+30,width:xn.col1W,height:30}),A.setProperties({left:0,top:V.top+22+60,width:xn.col1W,height:30});var d=Math.floor((xn.col1W-4)/4),c=xn.col1W-4*d;E.forEach(function(e,t){e.setProperties({left:c+t*d,top:V.top+22+90,width:d,height:17})})}},Bt.on(G,function(e){x.setValue(r=e,!0);var t=mn.getInstrument(e);t?(f.setValue(t.name,!0),P.setValue(t.getFineTune()),C.setValue(t.fadeout||0),I.setValue(t.vibrato.rate||0),M.setValue(t.vibrato.depth||0),A.setValue(t.vibrato.sweep||0),i(t.vibrato.type||0),t.sample&&(S.setMax(t.sample.length,!0),_.setMax(t.sample.length,!0),k.setValue(t.sample.volume),y.setValue(t.sample.panning||0),S.setValue(t.sample.loop.start,!0),_.setValue(t.sample.loop.length,!0),T.setValue(t.sample.relativeNote),U.setState(t.sample.loop.enabled),8===t.sample.bits?(g.setActive(!0),p.setActive(!1)):(g.setActive(!1),p.setActive(!0))),m.setInstrument(t),v.setInstrument(t),b.setInstrument(t)):(m.setInstrument(),v.setInstrument(),b.setInstrument(),f.setValue("",!0),k.setValue(0),y.setValue(0),P.setValue(0),S.setValue(0),_.setValue(0),T.setValue(0),C.setValue(0))}),Bt.on(z,function(e){u.visible&&e&&e.instrumentIndex===r&&m.play(e.startPeriod,e.effects&&e.effects.offset?e.effects.offset.value:0)}),Bt.on($,function(e){x.setMax(e.instruments.length-1)}),Bt.on(he,function(e){P.setMax(e===Dt?7:127,!0),P.setMin(e===Dt?-8:-128,!0);var t=mn.getInstrument(r);t&&P.setValue(t.getFineTune(),!0),v.setDisabled(!mn.inFTMode()),b.setDisabled(!mn.inFTMode()),T.setDisabled(!mn.inFTMode()),I.setDisabled(!mn.inFTMode()),M.setDisabled(!mn.inFTMode()),A.setDisabled(!mn.inFTMode()),C.setDisabled(!mn.inFTMode()),y.setDisabled(!mn.inFTMode()),x.setMax(mn.getMaxInstruments()),e===Dt?(S.setProperties({step:2}),_.setProperties({step:2}),t&&(t.sample.loop.start=2*Math.floor(t.sample.loop.start/2),t.sample.loop.length=2*Math.floor(t.sample.loop.length/2),S.setValue(t.sample.loop.start,!0),_.setValue(t.sample.loop.length,!0)),n("loop")):(S.setProperties({step:1}),_.setProperties({step:1})),u.onResize()}),Bt.on(N,function(e){mn.getInstrument(r)&&(void 0!==e.loopStart&&S.setValue(e.loopStart),void 0!==e.loopLength&&_.setValue(e.loopLength))}),Bt.on(H,function(e){if(u.visible&&e===r){mn.getInstrument(r);Bt.trigger(G,r)}}),u},de.sliderBox=function(e){function t(e){void 0!==e.name&&(o.name=e.name),void 0!==e.left&&(o.left=e.left),void 0!==e.top&&(o.top=e.top),void 0!==e.width&&(o.width=e.width),void 0!==e.height&&(o.height=e.height),void 0!==e.label&&(s=e.label),void 0!==e.value&&(l=e.value),void 0!==e.font&&(n=e.font),void 0!==e.min&&(d=e.min),void 0!==e.max&&(c=e.max),void 0!==e.step&&0,void 0!==e.onChange&&(r=e.onChange),void 0!==e.vertical&&(a=!!e.vertical,x&&x.setProperties({vertical:a}))}var n,i,r,a,o=de.element(),s="",l=0,d=0,c=100,u=4,f=0,h=0,g=0,p=0,m=10,v=10,b=!(o.type="sliderBox"),w=bn.getImage("line_ver");e&&t(e),9999<c&&(u=5);var x=de.rangeSlider({min:d,max:c,height:20,width:20,vertical:!!a,onChange:function(e){l=e,r&&r(e)}});return o.addChild(x),o.setProperties=function(e){if(!e)return i;t(i=e||{}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top)},o.setValue=function(e,t){x.setValue(l=e,t),o.refresh(),!t&&r&&r(l)},o.getValue=function(){return l},o.setMax=function(e,t){c=e,!t&&c<l&&o.setValue(c),x.setMax(c,t)},o.setMin=function(e,t){d=e,!t&&l<d&&o.setValue(d),x.setMin(d,t)},o.setDisabled=function(e){b=e,o.refresh(),o.ignoreEvents=b},o.render=function(e){if(e=!!e,o.needsRendering&&(o.clearCanvas(),o.ctx.drawImage(bn.getImage("panel_inset_dark"),g,p,m,v),window.fontLed.write(o.ctx,function(){for(var e=""+l;e.length<u;)e=" "+e;return e}(),g+4,p+2,0),x.render(),n?n.write(o.ctx,s,f,h,0):(o.ctx.fillStyle="white",o.ctx.fillText(s,f,h)),a&&o.ctx.drawImage(w,o.width-2,0,2,o.height),b&&(o.ctx.fillStyle="rgba(34, 49, 85, 0.6)",o.ctx.fillRect(1,0,o.width-1,o.height))),o.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)},o.onMouseWheel=function(e){0<e.mouseWheels[0]?c<++l&&(l=c):--l<d&&(l=d),o.setValue(l)},x.onMouseWheel=o.onMouseWheel,o.onResize=function(){m=40,v=19,5==u&&(m=48,g-=8),a?(x.setSize(20,o.height-36),x.setPosition(Math.floor((o.width-20)/2),0),g=Math.floor((o.width-40)/2),p=o.height-32,f=Math.floor((o.width-n.getTextWidth(s,0))/2),h=o.height-10):(x.setSize(o.width,20),x.setPosition(0,o.height-20),g=o.width-40,p=2)},o},de.spinBox=function(e){function r(){for(var e=""+c;e.length<g;)e=" "+e;return e}function t(e){void 0!==e.size&&(l=e.size),void 0!==e.name&&(s.name=e.name),void 0!==e.left&&(s.left=e.left),void 0!==e.top&&(s.top=e.top),void 0!==e.width&&(s.width=e.width),void 0!==e.height&&(s.height=e.height),void 0!==e.label&&(d=e.label),void 0!==e.labels&&(n=e.labels),void 0!==e.value&&(c=e.value),void 0!==e.font&&(a=e.font),void 0!==e.min&&(u=e.min),void 0!==e.max&&(f=e.max),void 0!==e.step&&(h=e.step),void 0!==e.onChange&&(o=e.onChange),void 0!==e.padLength&&(g=e.padLength),void 0!==e.disabled&&(p=!!e.disabled)}var n,a,i,o,s=de.element(),l="medium",d="",c=0,u=0,f=100,h=1,g=4,p=!(s.type="spinBox");e&&t(e),9999<f&&(g=5);var m=de.Assets.generate("button20_20");m.onDown=function(){p||((c-=h)<u&&(c=u),s.setValue(c),de.ticker.onEachTick4(function(){(c-=h)<u&&(c=u),s.setValue(c)},10))},m.onTouchUp=function(){de.ticker.onEachTick4()},m.setProperties({name:"buttonDown",label:"↓"}),s.addChild(m);var v=de.Assets.generate("button20_20");return v.onDown=function(){p||(f<(c+=h)&&(c=f),s.setValue(c),de.ticker.onEachTick4(function(){f<(c+=h)&&(c=f),s.setValue(c)},10))},v.onTouchUp=function(){de.ticker.onEachTick4()},v.setProperties({name:"buttonUp",label:"↑"}),s.addChild(v),s.setProperties=function(e){if(!e)return i;t(i=e||{}),s.setSize(s.width,s.height),s.setPosition(s.left,s.top),"big"===l?(g=2,v.setProperties({left:s.width-m.width,height:Math.floor(s.height/2),top:0}),m.setProperties({left:v.left,height:v.height,top:s.height-v.height})):(m.setProperties({left:s.width-m.width,top:3}),v.setProperties({left:s.width-v.width-m.width,top:3}))},s.setValue=function(e,t){c=e,s.refresh(),!t&&o&&o(c)},s.getValue=function(){return c},s.setMax=function(e,t){f=e,!t&&f<c&&s.setValue(f)},s.setMin=function(e){c<(u=e)&&s.setValue(u)},s.setDisabled=function(e){p=e,s.refresh()},s.render=function(e){if(e=!!e,s.isVisible()){if(s.needsRendering){if(s.clearCanvas(),d&&(a?a.write(s.ctx,d,6,11,0):(s.ctx.fillStyle="white",s.ctx.fillText(d,10,10))),v.render(),m.render(),"big"===l)s.ctx.drawImage(bn.getImage("panel_inset_dark"),v.left-36,1,34,s.height-2),window.fontLedBig.write(s.ctx,r(),v.left-31,4,0);else{var t=v.left-32-10,n=2,i=40;2===g&&(i=24,t+=16),3===g&&(i=32,t+=8),5===g&&(i=48,t-=8),s.ctx.drawImage(bn.getImage("panel_inset_dark"),t,n,i,24),t+=4,n=7,window.fontLed.write(s.ctx,r(),t,n,0)}p&&(s.ctx.fillStyle="rgba(34, 49, 85, 0.6)",s.ctx.fillRect(1,0,s.width-1,s.height))}if(s.needsRendering=!1,e)return s.canvas;s.parentCtx.drawImage(s.canvas,s.left,s.top,s.width,s.height)}},s.onMouseWheel=function(e){p||(0<e.mouseWheels[0]?f<++c&&(c=f):--c<u&&(c=u),s.setValue(c))},s.onResize=function(){var e=d;n&&n.forEach(function(e){e.width<=s.width&&(d=e.label)}),e!==d&&s.refresh()},s};var yn,Sn,_n,Cn,Tn,In,Mn,An,En,Dn,Fn,Ln,Bn=(Sn={},(yn={}).registerEdit=function(e){var t=e.target+"_"+e.id,n=Sn[t]||{undo:[],redo:[]};n.undo.push(e),50<n.undo.length&&n.undo.shift(),n.redo=[],Sn[t]=n},yn.undo=function(){var e=mn.getCurrentPattern(),t=Sn[r+"_"+e];if(t&&t.undo&&t.undo.length){var n=t.undo.pop(),i=mn.getSong().patterns[e];switch(n.type){case tt:case et:case r:n.data.forEach(function(e){i&&(i[e.position.row][e.position.track]||new jn).populate(e.from)}),Bt.trigger(L,e)}t.redo.push(n)}},yn.redo=function(){var e=mn.getCurrentPattern(),t=Sn[r+"_"+e];if(t&&t.redo&&t.redo.length){var n=t.redo.pop(),i=mn.getSong().patterns[e];switch(n.type){case tt:case et:case r:n.data.forEach(function(e){if(i){var t=i[e.position.row][e.position.track]||new jn;e.to?t.populate(e.to):t.clear()}}),Bt.trigger(L,e)}t.undo.push(n)}},yn.createNoteUndo=function(e,t,n,i){return{target:r,type:tt,id:e,data:[{position:{track:t,row:n},from:i.duplicate()}]}},yn.createTrackUndo=function(e){return{target:r,type:et,id:e,data:[]}},yn.createPatternUndo=function(e){return{target:r,type:r,id:e,data:[]}},yn.addNote=function(e,t,n,i){var r={position:{track:t,row:n},from:i.duplicate()};return e.data.push(r),r},yn);de.ticker=(Fn=Dn=0,Ln=!(En={}),En.onEachTick2=function(e,t){Mn=0,Tn=t||0,Ln=(_n=e)||Cn},En.onEachTick4=function(e,t){An=0,In=t||0,Cn=e,Ln=_n||Cn},Bt.on(U,function(){Ln&&(Dn=1-Dn)&&(Fn=1-Fn,_n&&Tn<++Mn&&_n(),Fn&&Cn&&In<++An&&Cn())}),En),de.WaveForm=function(){function f(e){var t,n=p.sample.loop.start||0;if(e===E)return n<T||I<n?-10:(M=I-T,t=Math.floor((n-T)/M*k.width),Math.max(5<T?0:5,t));var i=n+p.sample.loop.length;return i<T||I<i?-10:(t=Math.floor((i-T)/M*k.width),Math.min(t,k.width-(w-6<I?6:0)))}function h(e){var t;if(e===F)return P<T||I<P?-10:(M=I-T,t=Math.floor((P-T)/M*k.width),Math.max(5<T?0:5,t));var n=P+S;return n<T||I<n?-10:(t=Math.floor((n-T)/M*k.width),Math.min(t,k.width-(w-6<I?6:0)))}function l(e){var t={};return S?(t.tail=g.slice(P+S),t.range=g.slice(P,P+S),t.head=g.slice(0,P)):e?(t.range=[],t.tail=g.slice(P),t.head=g.slice(0,P)):(t.tail=[],t.range=g.slice(0,g.length),t.head=[]),t}function d(e){g=e.head.concat(e.range).concat(e.tail),p.sample.data=g,p.sample.length=g.length,t=!0,Bt.trigger(G,mn.getCurrentInstrumentIndex()),t=!1,B.refresh(),k.refresh()}var g,p,m,r,v,b,w,i,a,x,t,k=de.element(),P=0,y=0,S=0,o=0,_=0,s=0,c=!1,C=1,T=0,I=0,M=0,n=[],A=0,E=1,D=2,F=3,L=4,B=de.element(),W=de.scale9Panel(0,0,k.width,k.height,{img:bn.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});W.ignoreEvents=!0;var R=de.scale9Panel(1,0,100,18,{img:bn.getImage("bar"),left:2,top:2,right:3,bottom:3});return R.onDragStart=function(){R.startDragIndex=T,R.startLeft=R.left},R.onDrag=function(e){var t=R.startLeft+e.deltaX,n=k.width-R.width-1;t=Math.max(t,1),t=Math.min(t,n),R.setPosition(t,R.top),M=I-T,T=Math.floor((w-M)*(t/(n-1))),I=T+M,B.refresh()},k.addChild(R),Bt.on(U,function(){(m||r)&&k.isVisible()&&k.refresh()}),k.onDragStart=function(e){var t=e.startX;if(p.sample.loop.enabled){var n=f(D);if(Math.abs(t-n)<5)return o=D,void(s=p.sample.loop.length);if(n=f(E),Math.abs(t-n)<5)return o=E,void(s=p.sample.loop.start)}return S&&(n=h(L),Math.abs(t-n)<5)?(o=L,void(s=S)):P&&(n=h(F),Math.abs(t-n)<5)?(o=F,void(s=P)):(r=!0,i=a=e.startX,P=y=Math.round(T+i*(p.sample.length/k.width/C)),void Bt.trigger(N,{rangeLength:S=0}))},k.onDrag=function(e){var t=p.sample.length/k.width/C;if(o&&(o===E||o===D)){_=o;var n=e.deltaX,i=s+Math.round(t*n);mn.inFTMode()||(i-=i%2);var r={};return o===E?(i=Math.min(i,w-2),i=Math.max(i,0),r.loopStart=i,w<r.loopStart+p.sample.loop.length&&(r.loopLength=w-r.loopStart)):(i=Math.max(i,2),i=Math.min(i,w-p.sample.loop.start),r.loopLength=i),void Bt.trigger(N,r)}if(o&&(o===F||o===L))return _=o,n=e.deltaX,i=s+Math.round(t*n),o===F?(i=Math.min(i,w-2),i=Math.max(i,0),w<(P=i)+S&&(S=w-P)):(i=Math.max(i,2),i=Math.min(i,w-P),S=i),Bt.trigger(N,{rangeLength:S}),void k.refresh();a=e.x,y=Math.round(T+a*t),S=y-P,Bt.trigger(N,{rangeLength:Math.abs(S)})},k.onTouchUp=function(e){r&&y<P&&(S=P-y,y=(P=y)+S,k.refresh()),o=0,c=r=!1,S&&de.setSelection(k.processSelection)},k.onDown=function(e){c=!0},k.onHover=function(e){if(!r&&!o&&!c){var t=_;c||(_=0);var n=k.eventX;if(P&&(i=h(F),Math.abs(n-i)<5))return void(t!==(_=F)&&k.refresh());if(y){var i=h(L);if(Math.abs(n-i)<5)return void(t!==(_=L)&&k.refresh())}if(p.sample.loop.enabled){if(i=f(D),Math.abs(n-i)<5)return void(t!==(_=D)&&k.refresh());if(i=f(E),Math.abs(n-i)<5)return void(t!==(_=E)&&k.refresh())}t!==_&&k.refresh()}},k.onResize=function(){B.setPosition(0,0),B.setSize(k.width,k.height),R.setPosition(R.left,k.height-18),1<C&&R.setSize(Math.floor(k.width/C),18)},k.setInstrument=function(e){w=(p=e)?(g=p.sample.data).length:(g=void 0,0),Bt.trigger(N,{sampleLength:w,loopLength:e?e.sample.loop.length:0}),t||(m=!1,k.zoom(1),S=y=P=0,k.refresh())},k.play=function(e,t){1<C||(A=t=t||0,m=!0,v=(new Date).getTime(),b=Wt.getSampleRateForPeriod(e),k.refresh())},k.playSection=function(e){"range"===e&&Pn.handleNoteOn(Pn.getPrevIndex(),void 0,P),"loop"===e&&Pn.handleNoteOn(Pn.getPrevIndex(),void 0,p.sample.loop.start)},k.stop=function(){m=!1,k.refresh()},k.zoom=function(e){var t=!1;if("range"===e)if(S){I=(T=P)+(M=S);var n=k.width/(C=w/M),i=k.width-n-2;R.setPosition(Math.floor(T/(w-M)*i),R.top),t=!0}else e=1;"loop"===e&&(p.sample.loop.enabled&&(I=(T=p.sample.loop.start)+(M=p.sample.loop.length),i=k.width-(n=k.width/(C=w/M))-2,R.setPosition(Math.floor(T/(w-M)*i),R.top)),t=!0),1!==e&&1!==C||(C=1,T=0),t||(C*=e,C=Math.max(C,1),M=Math.floor(w/C),I=T+M),R.setSize(Math.floor(k.width/C),18),(x=1<C)&&w<I&&(T=w-M,I=w,R.setPosition(k.width-R.width-1,R.top)),B.refresh(),k.refresh()},k.select=function(e){"all"===e&&(P=0,S=y=g.length,k.refresh()),"none"===e&&(S=y=P=0,k.refresh()),"loop"===e&&2<p.sample.loop.length&&(y=(P=p.sample.loop.start)+(S=p.sample.loop.length),k.refresh()),"start"===e&&(S=y-(P=0),k.refresh()),"end"===e&&(S=(y=g.length)-P,k.refresh()),Bt.trigger(N,{rangeLength:S}),de.setSelection(k.processSelection)},k.render=function(){if(this.needsRendering){if(B.needsRendering){if(B.clearCanvas(),B.ctx.fillStyle="rgb(13, 19, 27)",B.ctx.fillRect(0,0,k.width,k.height),B.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",W.width!==k.width&&W.setSize(k.width,k.height),B.ctx.drawImage(W.render(!0),0,0,k.width,k.height),g&&g.length&&k.width){1===C&&(T=0,I=w);var e=(M=I-T)/k.width,t=k.height/2;B.ctx.beginPath();for(var n=k.height/2-2,i=0;i<k.width;i++){var r=Math.floor(i*e),a=g[T+r]*n;0===i?B.ctx.moveTo(i,t+a):B.ctx.lineTo(i,t+a)}B.ctx.stroke()}B.needsRendering=!1}if(k.ctx.drawImage(B.canvas,0,0),m&&w){var o=(new Date).getTime();r=A+b*(o-v)/1e3;if(p.sample.loop.enabled&&p.sample.loop.start<r){var s=(r=p.sample.loop.start+(r-p.sample.loop.start)%p.sample.loop.length)/w*k.width;k.ctx.fillStyle="rgb(241, 162, 71)",k.ctx.fillRect(s,0,1,k.height)}else if(w<r)m=!1;else{s=r/w*k.width;k.ctx.fillStyle="rgb(241, 162, 71)",k.ctx.fillRect(s,0,1,k.height)}}if(2<p.sample.loop.length||p.sample.loop.enabled){var l=p.sample.loop.enabled?"rgb(241, 220, 71)":"rgba(150, 150, 150,0.7)";k.ctx.fillStyle=l,_===E&&(k.ctx.fillStyle="white");var d=f(E);k.ctx.fillRect(d,0,1,k.height-1),k.ctx.fillRect(d-4,0,4,10),k.ctx.fillStyle=l,_===D&&(k.ctx.fillStyle="white"),d=f(D),k.ctx.fillRect(d,0,1,k.height-1),k.ctx.fillRect(d+1,0,4,10)}var c=-1,u=-1;y&&(k.ctx.fillStyle=l="rgb(241, 131, 71)",_===L&&(k.ctx.fillStyle="white"),u=h(L),k.ctx.fillRect(u,0,1,k.height-1),k.ctx.fillRect(u+1,11,4,10)),P&&(P<T?c=0:(k.ctx.fillStyle=l="rgb(241, 131, 71)",_===F&&(k.ctx.fillStyle="white"),c=h(F),k.ctx.fillRect(c,0,1,k.height-1),k.ctx.fillRect(c-4,11,4,10)),P+S<T&&(c=u=-1)),c!==u&&(0<=c&&(u=Math.min(u,k.width))<=0&&(u=k.width),k.ctx.fillStyle="rgba(241, 162, 71,0.1)",k.ctx.fillRect(c,0,u-c,k.height)),x&&R.render()}this.needsRendering=!1,k.parentCtx.drawImage(k.canvas,k.left,k.top,k.width,k.height)},k.adjustVolume=function(e){var t,n,i,r=l(),a=!1;if("max"===e){var o=0,s=0;for(n=0,i=r.range.length;n<i;n++)o=Math.min(o,r.range[n]),s=Math.max(s,r.range[n]);if(1<(t=1/Math.max(s,-o))){for(n=0,i=r.range.length;n<i;n++)r.range[n]=r.range[n]*t;a=!0}}if("fadein"===e){for(n=0,i=r.range.length-1;n<=i;n++)r.range[n]=r.range[n]*(t=n/i);a=!0}if("fadeout"===e){for(n=0,i=r.range.length-1;n<=i;n++)r.range[n]=r.range[n]*(t=1-n/i);a=!0}if(!a){if("number"==typeof e)for(t=1+1/e,n=0,i=r.range.length-1;n<=i;n++)r.range[n]=Math.min(Math.max(r.range[n]*t,-1),1);a=!0}a&&d(r)},k.reverse=function(){var e=l();e.range=e.range.reverse(),d(e)},k.invert=function(){for(var e=l(),t=0,n=e.range.length-1;t<=n;t++)e.range[t]=-e.range[t];d(e)},k.resample=function(e){var t=l(),n=[];if("up"===e){for(var i=0,r=t.range.length;i<r;i++)n.push(t.range[i]),n.push(t.range[i]);p.sample.loop.start=Math.floor(2*p.sample.loop.start),p.sample.loop.length=Math.floor(2*p.sample.loop.length),y=(P*=2)+(S*=2)}else{for(i=0,r=t.range.length;i<r;i+=2)n.push(t.range[i]);p.sample.loop.start=Math.floor(p.sample.loop.start/2),p.sample.loop.length=Math.floor(p.sample.loop.length/2),P=Math.floor(P/2),S=Math.floor(S/2),y=P+S}mn.inFTMode()||(p.sample.loop.start=p.sample.loop.start-p.sample.loop.start%2,p.sample.loop.length=p.sample.loop.length-p.sample.loop.length%2),t.range=n,d(t)},k.processSelection=function(e){if(k.isVisible())switch(e){case qe:return!1;case Ke:k.adjustVolume(0);break;case Je:case Ze:if(0<S){var t=l();n=t.range.slice(0),e===Ze&&(t.range=[],d(t),y=P+(S=0),Bt.trigger(N,{rangeLength:S}),k.refresh())}break;case Qe:t=l(!0),P?t.range=t.range.concat(n):t.tail=t.tail.concat(n),d(t)}},Bt.on(pe,function(){k.isVisible()&&k.select("all")}),k},vn.sprite=function(e){var t={};if(t.canvas=document.createElement("canvas"),t.ctx=t.canvas.getContext("2d"),e&&(e.width&&(t.canvas.width=e.width,t.canvas.height=e.height||e.width),e.img)){var n=t.canvas.width,i=t.canvas.height;t.ctx.drawImage(e.img,e.x||0,e.y||0,n,i,0,0,n,i)}return t},FilterChain=function(e){function n(){var e,t,n,i;if(o=a,v&&(d=d||((e=T.createBiquadFilter()).type="highshelf",e.frequency.value=3200,e.gain.value=_,e),o.connect(d),o=d),b&&(c=c||((t=T.createBiquadFilter()).type="peaking",t.frequency.value=1e3,t.Q.value=.5,t.gain.value=S,t),o.connect(c),o=c),w&&(u=u||((n=T.createBiquadFilter()).type="lowshelf",n.frequency.value=320,n.gain.value=y,n),o.connect(u),o=u),x&&(f=f||((i=T.createBiquadFilter()).type="lowpass",i.frequency.value=5e3,i),o.connect(f),o=f),k&&(h=h||T.createConvolver(),(g=g||T.createGain()).gain.value=0,o.connect(g),g.connect(h),s=h),P){var r=T.createWaveShaper();r.curve=function(e){for(var t,n="number"==typeof e?e:50,i=new Float32Array(44100),r=Math.PI/180,a=0;a<44100;++a)i[a]=(3+n)*(t=2*a/44100-1)*20*r/(Math.PI+n*Math.abs(t));return i}(400),r.oversample="4x"}m&&(p=p||Wt.context.createStereoPanner(),o.connect(p),o=p),l=l||T.createGain(),o.connect(l),s&&s.connect(l),o=l}var t={};e=e||{volume:!0,panning:!0};var a,o,s,l,d,c,u,f,h,g,p,i=(e={volume:!0,panning:!0}).volume,m=e.panning&&Wt.context.createStereoPanner,v=e.high,b=e.mid,w=e.low,x=e.lowPass,k=e.reverb,P=e.distortion,y=0,S=0,_=0,r=70,C=0,T=Wt.context;return(a=T.createGain()).gain.value=1,o=a,t.lowValue=function(e){if(w){if(void 0!==e){u.gain.value=20*(y=e)}return y}},t.midValue=function(e){if(b){if(void 0!==e){c.gain.value=20*(S=e)}return S}},t.highValue=function(e){if(v){if(void 0!==e){d.gain.value=20*(_=e)}return _}},t.lowPassFrequencyValue=function(e){if(x){var t=Wt.context.sampleRate/2,n=Math.log(t/40)/Math.LN2,i=Math.pow(2,n*(e-1));f.frequency.value=t*i}},t.lowPassQualityValue=function(e){x&&(f.Q.value=30*e)},t.reverbValue=function(e){if(k){if(!h.buffer){var t=le.audio["data/reverb/sportcentre.m4a"];if(t)h.buffer=t;else(a={load:function(e,t,n){a.type=t||I,a.loadCount=0,a.max=e.length,a.next=n;for(var i=0,r=e.length;i<r;i++)o(e[i])}},o=function(t){if(a.type==I){var e=new Image;e.onload=function(){le.images[t]=this,++a.loadCount==a.max&&a.next&&a.next()},e.onerror=function(){alert("BufferLoader: XHR error")},e.src=t}if(a.type==M){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",t,!0),n.onload=function(){Wt.context.decodeAudioData(n.response,function(e){e?(le.audio[t]=e,++a.loadCount==a.max&&a.next&&a.next()):alert("error decoding file data: "+t)},function(e){})},n.onerror=function(){alert("BufferLoader: XHR error")},n.send()}},a).load(["data/reverb/sportcentre.m4a"],M,function(){h.buffer=le.audio["data/reverb/sportcentre.m4a"]})}var a,o,n=parseInt(e)/100;g.gain.value=n*n}},t.volumeValue=function(e){if(i){if(void 0!==e){var t=(r=e)/100;l.gain.value=t*t}return r}},t.panningValue=function(e,t){if(m)return void 0!==e&&p.pan.setValueAtTime(C=e,t||Wt.context.currentTime),C},t.setState=function(e,t){a.disconnect(),d&&d.disconnect(),c&&c.disconnect(),u&&u.disconnect(),f&&f.disconnect(),g&&g.disconnect(),p&&p.disconnect(),s=void 0,"high"===e&&(v=!!t),"mid"===e&&(b=!!t),"low"===e&&(w=!!t),"lowPass"===e&&(x=!!t),"reverb"===e&&(k=!!t),"panning"===e&&(m=!!t&&Wt.context.createStereoPanner),n()},t.input=function(){return a},t.output=function(){return o},n(),t.volumeValue(r),t};var Wn,Rn,Un=(Rn={unknown:{name:"UNKNOWN"},unsupported:{name:"UNSUPPORTED"},mod_ProTracker:{name:"PROTRACKER",isMod:!0,loader:function(){return zn()}},mod_SoundTracker:{name:"SOUNDTRACKER",isMod:!0,loader:function(){return On()}},mod_FastTracker:{name:"FASTTRACKER",isMod:!0,loader:function(){return Vn()}},sample:{name:"SAMPLE",isSample:!0},zip:{name:"ZIP"}},(Wn={}).detect=function(r,e){function a(e){return e<128}var o=r.length,t="";if("Extended Module: "==(t=r.readString(17,0)))return Rn.mod_FastTracker;if(1100<o&&(t=r.readString(4,1080)),"M.K."==t)return Rn.mod_ProTracker;if("M!K!"==t)return Rn.mod_ProTracker;if("M&K!"==t)return Rn.mod_ProTracker;if("FLT4"==t)return Rn.mod_ProTracker;if("2CHN"==t)return Rn.mod_ProTracker;if("6CHN"==t)return Rn.mod_ProTracker;if("8CHN"==t)return Rn.mod_ProTracker;if("10CH"==t)return Rn.mod_ProTracker;if("12CH"==t)return Rn.mod_ProTracker;if("14CH"==t)return Rn.mod_ProTracker;if("16CH"==t)return Rn.mod_ProTracker;if("18CH"==t)return Rn.mod_ProTracker;if("20CH"==t)return Rn.mod_ProTracker;if("22CH"==t)return Rn.mod_ProTracker;if("24CH"==t)return Rn.mod_ProTracker;if("26CH"==t)return Rn.mod_ProTracker;if("28CH"==t)return Rn.mod_ProTracker;if("30CH"==t)return Rn.mod_ProTracker;if("32CH"==t)return Rn.mod_ProTracker;var n="";return e&&4<e.length&&(n=e.substr(e.length-4)),".wav"==(n=n.toLowerCase())||".mp3"==n||".iff"==n?Rn.sample:".zip"==n||"PK"==r.readString(2,0)?Rn.zip:e&&0<=e.indexOf(".")&&1624<o&&function(){r.goto(0);for(var e=0;e<20;e++)if(!a(r.readByte()))return;for(var t=0,n=0,i=0;i<15;i++){for(e=0;e<22;e++)if(!a(r.readByte()))return;if(r.jump(-22),"st-"==r.readString(22).toLowerCase().substr(0,3)&&(n+=10),20<n)return 1;t+=r.readWord(),r.jump(6)}return!(o<2*t+1624)}()?Rn.mod_SoundTracker:Rn.sample},Wn),Vn=function(){var C={load:function(e,t){function n(e){for(e.points=[],b=0;b<12;b++)e.points.push(e.raw.slice(2*b,2*b+2));return 1&e.type&&(e.enabled=!0),2&e.type&&(e.sustain=!0),4&e.type&&(e.loop=!0),e}mn.setTrackerMode(Ft),mn.clearInstruments(1);var i={},r={patterns:[],instruments:[]};e.litteEndian=!0,e.goto(17),r.title=e.readString(20),e.jump(1),i.trackerName=e.readString(20),i.trackerVersion=e.readByte(),i.trackerVersion=e.readByte()+"."+i.trackerVersion,i.headerSize=e.readDWord(),i.songlength=e.readWord(),i.restartPosition=e.readWord(),i.numberOfChannels=e.readWord(),i.numberOfPatterns=e.readWord(),i.numberOfInstruments=e.readWord(),i.flags=e.readWord(),mn.useLinearFrequency=i.flags%2==1,i.defaultTempo=e.readWord(),i.defaultBPM=e.readWord();for(var a=[],o=0,s=0;s<i.songlength;++s)a[s]=e.readUbyte(),o<a[s]&&(o=a[s]);r.patternTable=a,r.length=i.songlength,r.channels=i.numberOfChannels,r.restartPosition=i.restartPosition+1;var l=60+i.headerSize;for(e.goto(l),s=0;s<i.numberOfPatterns;s++){var d=[],c={};c.headerSize=e.readDWord(),c.packingType=e.readUbyte(),c.patternLength=e.readWord(),c.patternSize=e.readWord(),e.goto(l+=c.headerSize);for(var u=0;u<c.patternLength;u++){var f,h=[];for(f=0;f<i.numberOfChannels;f++){var g=jn(),p=e.readUbyte();128&p?(1&p&&g.setIndex(e.readUbyte()),2&p&&(g.instrument=e.readUbyte()),4&p&&(g.volumeEffect=e.readUbyte()),8&p&&(g.effect=e.readUbyte()),16&p&&(g.param=e.readUbyte())):(g.setIndex(p),g.instrument=e.readUbyte(),g.volumeEffect=e.readUbyte(),g.effect=e.readUbyte(),g.param=e.readUbyte()),h.push(g)}d.push(h)}e.goto(l+=c.patternSize),r.patterns.push(d)}var m=[];for(s=1;s<=i.numberOfInstruments;++s){var v=Gn();try{if(v.filePosition=e.index,v.headerSize=e.readDWord(),v.name=e.readString(22),v.type=e.readUbyte(),v.numberOfSamples=e.readWord(),v.samples=[],(v.sampleHeaderSize=0)<v.numberOfSamples){v.sampleHeaderSize=e.readDWord(),v.sampleHeaderSize=Math.max(v.sampleHeaderSize,40),200<v.sampleHeaderSize&&(v.sampleHeaderSize=40);for(var b=0;b<96;b++)v.sampleNumberForNotes.push(e.readUbyte());for(b=0;b<24;b++)v.volumeEnvelope.raw.push(e.readWord());for(b=0;b<24;b++)v.panningEnvelope.raw.push(e.readWord());v.volumeEnvelope.count=e.readUbyte(),v.panningEnvelope.count=e.readUbyte(),v.volumeEnvelope.sustainPoint=e.readUbyte(),v.volumeEnvelope.loopStartPoint=e.readUbyte(),v.volumeEnvelope.loopEndPoint=e.readUbyte(),v.panningEnvelope.sustainPoint=e.readUbyte(),v.panningEnvelope.loopStartPoint=e.readUbyte(),v.panningEnvelope.loopEndPoint=e.readUbyte(),v.volumeEnvelope.type=e.readUbyte(),v.panningEnvelope.type=e.readUbyte(),v.vibrato.type=e.readUbyte(),v.vibrato.sweep=e.readUbyte(),v.vibrato.depth=Math.min(e.readUbyte(),15),v.vibrato.rate=e.readUbyte(),v.fadeout=e.readWord(),v.reserved=e.readWord(),v.volumeEnvelope=n(v.volumeEnvelope),v.panningEnvelope=n(v.panningEnvelope)}}catch(e){}if(e.goto(l+=v.headerSize),0===v.numberOfSamples){var w=Yn();v.samples.push(w)}else{if(e.isEOF(1))break;for(var x=0;x<v.numberOfSamples;x++)(w=Yn()).length=e.readDWord(),w.loop.start=e.readDWord(),w.loop.length=e.readDWord(),w.volume=e.readUbyte(),w.finetuneX=e.readByte(),w.type=e.readUbyte(),w.panning=e.readUbyte()-128,w.relativeNote=e.readByte(),w.reserved=e.readByte(),w.name=e.readString(22),w.bits=8,v.samples.push(w),e.goto(l+=v.sampleHeaderSize);for(x=0;x<v.numberOfSamples;x++)if((w=v.samples[x]).length){l+=w.length,16&w.type&&(w.bits=16,w.type^=16,w.length>>=1,w.loop.start>>=1,w.loop.length>>=1),w.loop.type=w.type||0,w.loop.enabled=!!w.loop.type;var k=w.length,P=0;if(16===w.bits)for(var y=0;y<k;y++){var S=e.readShort()+P;S<-32768?S+=65536:32767<S&&(S-=65536),w.data.push((P=S)/32768)}else for(y=0;y<k;y++)(S=e.readByte()+P)<-128?S+=256:127<S&&(S-=256),w.data.push((P=S)/127);if(w.loop.type===Ye){var _=w.data.slice(w.loop.start,w.loop.start+w.loop.length);w.data=w.data.slice(0,w.loop.start+w.loop.length),w.data=w.data.concat(_.reverse()),w.loop.length=2*w.loop.length,w.length=w.loop.start+w.loop.length}e.goto(l)}}v.setSampleIndex(0),mn.setInstrument(s,v),m.push({label:s+" "+v.name,data:s})}return Bt.trigger(te,m),r.instruments=mn.getInstruments(),mn.setBPM(i.defaultBPM),mn.setAmigaSpeed(i.defaultTempo),C.validate(r),r},write:function(e){var t=mn.getSong(),n=mn.getInstruments(),i=mn.getTrackCount(),r="undefined"==typeof versionNumber?"dev":versionNumber,a=0;for(o=0;o<128;o++){a=Math.max(a,t.patternTable[o]||0)}var o,s=336;for(o=0;o<=a;o++)t.patterns[o]&&(s+=9+t.patterns[o].length*i*5);for(o=1;o<n.length;o++){var l=n[o];l&&l.hasSamples()?l.samples.forEach(function(e){var t=e.length;16===e.bits&&(t*=2),s+=283+t}):s+=29}var d=new F(new ArrayBuffer(s),!1);for(d.writeStringSection("Extended Module: ",17),d.writeStringSection(t.title,20),d.writeByte(26),d.writeStringSection("BassoonTracker "+r,20),d.writeByte(4),d.writeByte(1),d.writeDWord(276),d.writeWord(t.length),d.writeWord(0),d.writeWord(mn.getTrackCount()),d.writeWord(a+1),d.writeWord(n.length-1),d.writeWord(mn.useLinearFrequency?1:0),d.writeWord(mn.getAmigaSpeed()),d.writeWord(mn.getBPM()),o=0;o<256;o++)d.writeUByte(t.patternTable[o]||0);for(o=0;o<=a;o++){var c=t.patterns[o],u=0,f=0;if(c&&(f=(u=c.length)*i*5),d.writeDWord(9),d.writeUByte(0),d.writeWord(u),d.writeWord(f),c)for(var h=0,g=c.length;h<g;h++)for(var p=c[h],m=0;m<i;m++){var v=p[m]||{};d.writeUByte(v.index||0),d.writeUByte(v.instrument||0),d.writeUByte(v.volumeEffect||0),d.writeUByte(v.effect||0),d.writeUByte(v.param||0)}}for(o=1;o<n.length;o++)if((l=n[o])&&l.hasSamples()){l.numberOfSamples=l.samples.length,d.writeDWord(243),d.writeStringSection(l.name,22),d.writeUByte(0),d.writeWord(l.numberOfSamples);var b=(l.volumeEnvelope.enabled?1:0)+(l.volumeEnvelope.sustain?2:0)+(l.volumeEnvelope.loop?4:0),w=(l.panningEnvelope.enabled?1:0)+(l.panningEnvelope.sustain?2:0)+(l.panningEnvelope.loop?4:0);d.writeDWord(40);for(var x=0;x<96;x++)d.writeUByte(l.sampleNumberForNotes[x]||0);for(x=0;x<12;x++){var k=l.volumeEnvelope.points[x]||[0,0];d.writeWord(k[0]),d.writeWord(k[1])}for(x=0;x<12;x++)d.writeWord((k=l.panningEnvelope.points[x]||[0,0])[0]),d.writeWord(k[1]);d.writeUByte(l.volumeEnvelope.count||0),d.writeUByte(l.panningEnvelope.count||0),d.writeUByte(l.volumeEnvelope.sustainPoint||0),d.writeUByte(l.volumeEnvelope.loopStartPoint||0),d.writeUByte(l.volumeEnvelope.loopEndPoint||0),d.writeUByte(l.panningEnvelope.sustainPoint||0),d.writeUByte(l.panningEnvelope.loopStartPoint||0),d.writeUByte(l.panningEnvelope.loopEndPoint||0),d.writeUByte(b),d.writeUByte(w),d.writeUByte(l.vibrato.type||0),d.writeUByte(l.vibrato.sweep||0),d.writeUByte(l.vibrato.depth||0),d.writeUByte(l.vibrato.rate||0),d.writeWord(l.fadeout||0),d.writeWord(0);for(var P=0;P<l.numberOfSamples;P++){var y=l.samples[P],S=0;2<y.loop.length&&y.loop.enabled&&(S=1);var _=y.length,C=y.loop.start,T=y.loop.length;16===y.bits&&(S+=16,_*=2,C*=2,T*=2),d.writeDWord(_),d.writeDWord(C),d.writeDWord(T),d.writeUByte(y.volume),d.writeByte(y.finetuneX),d.writeUByte(S),d.writeUByte((y.panning||0)+128),d.writeUByte(y.relativeNote||0),d.writeUByte(0),d.writeStringSection(y.name||"",22)}for(P=0;P<l.numberOfSamples;P++){var I,M=0,A=0;if(16===(y=l.samples[P]).bits)for(x=0,g=y.length;x<g;x++)M=(I=Math.round(32768*y.data[x]))-A,A=I,M<-32768?M+=65536:32767<M&&(M-=65536),d.writeWord(M);else for(x=0,g=y.length;x<g;x++)M=(I=Math.round(127*y.data[x]))-A,A=I,M<-128?M+=256:127<M&&(M-=256),d.writeByte(M)}}else d.writeDWord(29),d.writeStringSection(l?l.name:"",22),d.writeUByte(0),d.writeWord(0);e&&e(d)},validate:function(e){function r(e,t){var n=!0;if(e.points&&e.points[0])if(0===e.points[0][0])for(var i=0,r=1;r<e.count;r++){var a=e.points[r];a&&i<a[0]?i=a[0]:n=!1}else n=!1;else n=!1;return n?e:"volume"===t?{raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6}:{raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5}}e.instruments.forEach(function(e){e.volumeEnvelope=r(e.volumeEnvelope,"volume"),e.panningEnvelope=r(e.panningEnvelope,"panning");for(var t=e.samples.length-1,n=0,i=e.sampleNumberForNotes.length;n<i;n++)e.sampleNumberForNotes[n]=Math.min(e.sampleNumberForNotes[n],t)})}};return C},zn=function(){var e={load:function(e,t){mn.setTrackerMode(Dt),mn.useLinearFrequency=!1,mn.clearInstruments(31);var n={patterns:[],restartPosition:1},i=4;n.typeId=e.readString(4,1080),n.title=e.readString(20,0),"2CHN"===n.typeId&&(i=2),"6CHN"===n.typeId&&(i=6),"8CHN"===n.typeId&&(i=8),"10CH"===n.typeId&&(i=10),"12CH"===n.typeId&&(i=12),"14CH"===n.typeId&&(i=14),"16CH"===n.typeId&&(i=16),"18CH"===n.typeId&&(i=18),"20CH"===n.typeId&&(i=20),"22CH"===n.typeId&&(i=22),"24CH"===n.typeId&&(i=24),"26CH"===n.typeId&&(i=26),"28CH"===n.typeId&&(i=28),"30CH"===n.typeId&&(i=30),"32CH"===n.typeId&&(i=32),n.channels=i;var r=0;for(u=1;u<=31;++u){var a=e.readString(22),o=e.readWord(),s=Gn();s.name=a,s.sample.length=s.sample.realLen=o<<1;var l=e.readUbyte();7<l&&(l-=16),s.setFineTune(l),s.sample.volume=e.readUbyte(),s.sample.loop.start=e.readWord()<<1,s.sample.loop.length=e.readWord()<<1,s.sample.loop.enabled=2<s.sample.loop.length,s.sample.loop.type=je,s.pointer=r,r+=s.sample.length,s.setSampleIndex(0),mn.setInstrument(u,s)}n.instruments=mn.getInstruments(),e.goto(950),n.length=e.readUbyte(),e.jump(1);for(var d=[],c=0,u=0;u<128;++u)d[u]=e.readUbyte(),c<d[u]&&(c=d[u]);for(n.patternTable=d,e.goto(1084),u=0;u<=c;++u){for(var f=[],h=0;h<64;h++){var g,p=[];for(g=0;g<i;g++){var m=jn(),v=e.readUint();m.setPeriod(v>>16&4095),m.effect=v>>8&15,m.instrument=v>>24&240|v>>12&15,m.param=255&v,p.push(m)}for(g=i;g<mn.getTrackCount();g++)p.push(jn());f.push(p)}n.patterns.push(f)}var b=[];for(u=1;u<=31;u++)if(s=mn.getInstrument(u)){var w=s.sample.length;for(2<s.sample.loop.length&&Lt.unrollShortLoops&&s.sample.loop.length<1e3&&(w=Math.min(w,s.sample.loop.start+s.sample.loop.length),s.sample.length=w),j=0;j<w;j++){var x=e.readByte();j<2&&(x=0),s.sample.data.push(x/127)}if((Lt.unrollShortLoops||Lt.unrollLoops)&&2<s.sample.loop.length){var k=Math.ceil(4e4/s.sample.loop.length)+1;Lt.unrollLoops||(k=0);var P=!1,y=0;Lt.unrollShortLoops&&s.sample.loop.length<1600&&(k=Math.floor(1e3/s.sample.loop.length),P=!0);for(var S=0;S<k;S++){var _=s.sample.loop.start,C=_+s.sample.loop.length;for(j=_;j<C;j++)s.sample.data.push(s.sample.data[j]);y+=s.sample.loop.length}P&&y&&(s.sample.loop.length+=y,s.sample.length+=y)}b.push({label:u+" "+s.name,data:u})}return Bt.trigger(te,b),n},write:function(e){var t,n=mn.getSong(),i=mn.getInstruments(),r=mn.getTrackCount(),a=mn.getPatternLength(),o=1084,s=0;for(t=0;t<128;t++){var l=n.patternTable[t]||0;s=Math.max(s,l)}o+=(s+1)*(256*r),i.forEach(function(e){e&&(e.setSampleIndex(0),o+=e.sample.length)});var d=new F(new ArrayBuffer(o),!0);for(d.writeStringSection(n.title,20),i.forEach(function(e){e?(e.sample.length=Math.min(e.sample.length,131070),d.writeStringSection(e.name,22),d.writeWord(e.sample.length>>1),d.writeUByte(e.sample.finetune),d.writeUByte(e.sample.volume),d.writeWord(e.sample.loop.start>>1),d.writeWord(e.sample.loop.length>>1)):d.clear(30)}),d.writeUByte(n.length),d.writeUByte(127),t=0;t<128;t++){d.writeUByte(l=n.patternTable[t]||0)}for(d.writeString(8==r?"8CHN":"M.K."),t=0;t<=s;t++)for(var c=n.patterns[t],u=0;u<a;u++)for(var f=c[u],h=0;h<r;h++){var g=f[h],p=0,m=g.instrument;15<m&&(m=g.instrument-(p=16)),d.writeUint((p<<24)+(g.period<<16)+(m<<12)+(g.effect<<8)+g.param)}i.forEach(function(e){if(e&&e.sample.data&&e.sample.length)for(d.clear(2),t=0;t<e.sample.length-2;t++)d.writeByte(Math.round(127*(e.sample.data[t]||0)))}),e&&e(d)}};return e},On=function(){var e={load:function(e,t){mn.setTrackerMode(Dt),mn.useLinearFrequency=!1,mn.clearInstruments(15);var n={patterns:[],restartPosition:1};n.typeId="ST",n.channels=4,n.title=e.readString(20,0);var i=0;for(d=1;d<=15;++d){var r=e.readString(22),a=e.readWord(),o=Gn();o.name=r,o.sample.length=o.realLen=a<<1,o.sample.volume=e.readWord(),o.setFineTune(0),o.sample.loop.start=e.readWord(),o.sample.loop.length=e.readWord()<<1,o.sample.loop.enabled=2<o.sample.loop.length,o.sample.loop.type=je,o.pointer=i,i+=o.sample.length,o.setSampleIndex(0),mn.setInstrument(d,o)}n.instruments=mn.getInstruments(),e.goto(470),n.length=e.readUbyte(),n.speed=e.readUbyte();for(var s=[],l=0,d=0;d<128;++d)s[d]=e.readUbyte(),l<s[d]&&(l=s[d]);for(n.patternTable=s,e.goto(600),d=0;d<=l;++d){for(var c=[],u=0;u<64;u++){var f,h=[];for(f=0;f<4;f++){var g={},p=e.readUint();g.period=p>>16&4095,g.effect=p>>8&15,g.instrument=p>>24&240|p>>12&15,g.param=255&p,h.push(g)}for(f=4;f<mn.getTrackCount();f++)h.push({note:0,effect:0,instrument:0,param:0});c.push(h)}n.patterns.push(c)}var m=[];for(d=1;d<=15;d++)if(o=mn.getInstrument(d)){var v=o.sample.length;for(j=0;j<v;j++){var b=e.readByte();j<2&&(b=0),o.sample.data.push(b/127)}m.push({label:d+" "+o.name,data:d})}return Bt.trigger(te,m),n}};return e};!function(e){"use strict";function ue(){function l(e,t){for(var n=0;n|=1&e,e>>>=1,n<<=1,0<--t;);return n>>>1}var h=this;h.build_tree=function(e){var t,n,i,r=h.dyn_tree,a=h.stat_desc.static_tree,o=h.stat_desc.elems,s=-1;for(e.heap_len=0,e.heap_max=p,t=0;t<o;t++)0!==r[2*t]?(e.heap[++e.heap_len]=s=t,e.depth[t]=0):r[2*t+1]=0;for(;e.heap_len<2;)r[2*(i=e.heap[++e.heap_len]=s<2?++s:0)]=1,e.depth[i]=0,e.opt_len--,a&&(e.static_len-=a[2*i+1]);for(h.max_code=s,t=Math.floor(e.heap_len/2);1<=t;t--)e.pqdownheap(r,t);for(i=o;t=e.heap[1],e.heap[1]=e.heap[e.heap_len--],e.pqdownheap(r,1),n=e.heap[1],e.heap[--e.heap_max]=t,e.heap[--e.heap_max]=n,r[2*i]=r[2*t]+r[2*n],e.depth[i]=Math.max(e.depth[t],e.depth[n])+1,r[2*t+1]=r[2*n+1]=i,e.heap[1]=i++,e.pqdownheap(r,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e){var t,n,i,r,a,o,s=h.dyn_tree,l=h.stat_desc.static_tree,d=h.stat_desc.extra_bits,c=h.stat_desc.extra_base,u=h.stat_desc.max_length,f=0;for(r=0;r<=g;r++)e.bl_count[r]=0;for(s[2*e.heap[e.heap_max]+1]=0,t=e.heap_max+1;t<p;t++)u<(r=s[2*s[2*(n=e.heap[t])+1]+1]+1)&&(r=u,f++),s[2*n+1]=r,h.max_code<n||(e.bl_count[r]++,a=0,c<=n&&(a=d[n-c]),e.opt_len+=(o=s[2*n])*(r+a),l&&(e.static_len+=o*(l[2*n+1]+a)));if(0!==f){do{for(r=u-1;0===e.bl_count[r];)r--;e.bl_count[r]--,e.bl_count[r+1]+=2,e.bl_count[u]--,f-=2}while(0<f);for(r=u;0!==r;r--)for(n=e.bl_count[r];0!==n;)i=e.heap[--t],h.max_code<i||(s[2*i+1]!=r&&(e.opt_len+=(r-s[2*i+1])*s[2*i],s[2*i+1]=r),n--)}}(e),function(e,t,n){var i,r,a,o=[],s=0;for(i=1;i<=g;i++)o[i]=s=s+n[i-1]<<1;for(r=0;r<=t;r++)0!==(a=e[2*r+1])&&(e[2*r]=l(o[a]++,a))}(r,h.max_code,e.bl_count)}}function fe(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r}function t(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}function he(e,t,n,i){var r=e[2*t],a=e[2*n];return r<a||r==a&&i[t]<=i[n]}function n(){function o(){var e;for(e=0;e<286;e++)J[2*e]=0;for(e=0;e<30;e++)Q[2*e]=0;for(e=0;e<19;e++)$[2*e]=0;J[512]=1,se.opt_len=se.static_len=0,ne=a=0}function s(e,t){var n,i,r=-1,a=e[1],o=0,s=7,l=4;for(0===a&&(s=138,l=3),e[2*(t+1)+1]=65535,n=0;n<=t;n++)i=a,a=e[2*(n+1)+1],++o<s&&i==a||(o<l?$[2*i]+=o:0!==i?(i!=r&&$[2*i]++,$[32]++):o<=10?$[34]++:$[36]++,r=i,l=(o=0)===a?(s=138,3):i==a?(s=6,3):(s=7,4))}function l(e){se.pending_buf[se.pending++]=e}function d(e){l(255&e),l(e>>>8&255)}function c(e,t){var n,i=t;16-i<oe?(d(ae|=(n=e)<<oe&65535),ae=n>>>16-oe,oe+=i-16):(ae|=e<<oe&65535,oe+=i)}function u(e,t){var n=2*e;c(65535&t[n],65535&t[1+n])}function f(e,t){var n,i,r=-1,a=e[1],o=0,s=7,l=4;for(0===a&&(s=138,l=3),n=0;n<=t;n++)if(i=a,a=e[2*(n+1)+1],!(++o<s&&i==a)){if(o<l)for(;u(i,$),0!=--o;);else 0!==i?(i!=r&&(u(i,$),o--),u(16,$),c(o-3,2)):o<=10?(u(17,$),c(o-3,3)):(u(18,$),c(o-11,7));r=i,l=(o=0)===a?(s=138,3):i==a?(s=6,3):(s=7,4)}}function h(){16==oe?(d(ae),oe=ae=0):8<=oe&&(l(255&ae),ae>>>=8,oe-=8)}function g(e,t){var n,i,r;if(se.pending_buf[ie+2*ne]=e>>>8&255,se.pending_buf[ie+2*ne+1]=255&e,se.pending_buf[ee+ne]=255&t,ne++,0===e?J[2*t]++:(a++,e--,J[2*(ue._length_code[t]+256+1)]++,Q[2*ue.d_code(e)]++),0==(8191&ne)&&2<Y){for(n=8*ne,i=O-R,r=0;r<30;r++)n+=Q[2*r]*(5+ue.extra_dbits[r]);if(n>>>=3,a<Math.floor(ne/2)&&n<Math.floor(i/2))return!0}return ne==te-1}function p(e,t){var n,i,r,a,o=0;if(0!==ne)for(;n=se.pending_buf[ie+2*o]<<8&65280|255&se.pending_buf[ie+2*o+1],i=255&se.pending_buf[ee+o],o++,0===n?u(i,e):(u((r=ue._length_code[i])+256+1,e),0!==(a=ue.extra_lbits[r])&&c(i-=ue.base_length[r],a),u(r=ue.d_code(--n),t),0!==(a=ue.extra_dbits[r])&&c(n-=ue.base_dist[r],a)),o<ne;);u(256,e),re=e[513]}function m(){8<oe?d(ae):0<oe&&l(255&ae),oe=ae=0}function v(e,t,n){var i,r,a;c(0+(n?1:0),3),i=e,r=t,a=!0,m(),re=8,a&&(d(r),d(~r)),se.pending_buf.set(M.subarray(i,i+r),se.pending),se.pending+=r}function t(e,t,n){var i,r,a=0;0<Y?(le.build_tree(se),de.build_tree(se),a=function(){var e;for(s(J,le.max_code),s(Q,de.max_code),ce.build_tree(se),e=18;3<=e&&0===$[2*ue.bl_order[e]+1];e--);return se.opt_len+=3*(e+1)+5+5+4,e}(),(r=se.static_len+3+7>>>3)<=(i=se.opt_len+3+7>>>3)&&(i=r)):i=r=t+5,t+4<=i&&-1!=e?v(e,t,n):r==i?(c(2+(n?1:0),3),p(fe.static_ltree,fe.static_dtree)):(c(4+(n?1:0),3),function(e,t,n){var i;for(c(e-257,5),c(t-1,5),c(n-4,4),i=0;i<n;i++)c($[2*ue.bl_order[i]+1],3);f(J,e-1),f(Q,t-1)}(le.max_code+1,de.max_code+1,a+1),p(J,Q)),o(),n&&m()}function b(e){t(0<=R?R:-1,O-R,e),R=O,P.flush_pending()}function w(){var e,t,n,i;do{if(0===(i=r-H-O)&&0===O&&0===H)i=C;else if(-1==i)i--;else if(C+C-262<=O){for(M.set(M.subarray(C,C+C),0),N-=C,O-=C,R-=C,n=e=F;t=65535&E[--n],E[n]=C<=t?t-C:0,0!=--e;);for(n=e=C;t=65535&A[--n],A[n]=C<=t?t-C:0,0!=--e;);i+=C}if(0===P.avail_in)return;e=P.read_buf(M,O+H,i),3<=(H+=e)&&(D=((D=255&M[O])<<W^255&M[O+1])&B)}while(H<262&&0!==P.avail_in)}function x(e){var t,n,i=G,r=O,a=X,o=C-262<O?O-(C-262):0,s=Z,l=I,d=O+258,c=M[r+a-1],u=M[r+a];K<=X&&(i>>=2),H<s&&(s=H);do{if(M[(t=e)+a]==u&&M[t+a-1]==c&&M[t]==M[r]&&M[++t]==M[r+1]){r+=2,t++;do{}while(M[++r]==M[++t]&&M[++r]==M[++t]&&M[++r]==M[++t]&&M[++r]==M[++t]&&M[++r]==M[++t]&&M[++r]==M[++t]&&M[++r]==M[++t]&&M[++r]==M[++t]&&r<d);if(n=258-(d-r),r=d-258,a<n){if(N=e,s<=(a=n))break;c=M[r+a-1],u=M[r+a]}}}while((e=65535&A[e&l])>o&&0!=--i);return a<=H?a:H}function k(e){return e.total_in=e.total_out=0,e.msg=null,se.pending=0,y=113,_=se.pending_out=0,le.dyn_tree=J,le.stat_desc=fe.static_l_desc,de.dyn_tree=Q,de.stat_desc=fe.static_d_desc,ce.dyn_tree=$,ce.stat_desc=fe.static_bl_desc,oe=ae=0,re=8,o(),function(){var e;for(r=2*C,e=E[F-1]=0;e<F-1;e++)E[e]=0;j=ge[Y].max_lazy,K=ge[Y].good_length,Z=ge[Y].nice_length,G=ge[Y].max_chain,U=X=2,D=z=H=R=O=0}(),0}var P,y,S,_,C,T,I,M,r,A,E,D,F,L,B,W,R,U,V,z,O,N,H,X,G,j,Y,q,K,Z,J,Q,$,ee,te,ne,ie,a,re,ae,oe,se=this,le=new ue,de=new ue,ce=new ue;se.depth=[],se.bl_count=[],se.heap=[],J=[],Q=[],$=[],se.pqdownheap=function(e,t){for(var n=se.heap,i=n[t],r=t<<1;r<=se.heap_len&&(r<se.heap_len&&he(e,n[r+1],n[r],se.depth)&&r++,!he(e,i,n[r],se.depth));)n[t]=n[r],t=r,r<<=1;n[t]=i},se.deflateInit=function(e,t,n,i,r,a){return i=i||8,r=r||8,a=a||0,e.msg=null,-1==t&&(t=6),r<1||9<r||8!=i||n<9||15<n||t<0||9<t||a<0||2<a?-2:(e.dstate=se,I=(C=1<<(T=n))-1,B=(F=1<<(L=r+7))-1,W=Math.floor((L+3-1)/3),M=new Uint8Array(2*C),A=[],E=[],te=1<<r+6,se.pending_buf=new Uint8Array(4*te),S=4*te,ie=Math.floor(te/2),ee=3*te,Y=t,q=a,k(e))},se.deflateEnd=function(){return 42!=y&&113!=y&&666!=y?-2:(se.pending_buf=null,se.dstate=M=A=E=null,113==y?-3:0)},se.deflateParams=function(e,t,n){var i=0;return-1==t&&(t=6),t<0||9<t||n<0||2<n?-2:(ge[Y].func!=ge[t].func&&0!==e.total_in&&(i=e.deflate(1)),Y!=t&&(j=ge[Y=t].max_lazy,K=ge[Y].good_length,Z=ge[Y].nice_length,G=ge[Y].max_chain),q=n,i)},se.deflateSetDictionary=function(e,t,n){var i,r=n,a=0;if(!t||42!=y)return-2;if(r<3)return 0;for(C-262<r&&(a=n-(r=C-262)),M.set(t.subarray(a,a+r),0),R=O=r,D=((D=255&M[0])<<W^255&M[1])&B,i=0;i<=r-3;i++)A[i&I]=E[D=(D<<W^255&M[i+2])&B],E[D]=i;return 0},se.deflate=function(e,t){var n,i,r,a,o,s;if(4<t||t<0)return-2;if(!e.next_out||!e.next_in&&0!==e.avail_in||666==y&&4!=t)return e.msg=pe[4],-2;if(0===e.avail_out)return e.msg=pe[7],-5;if(P=e,a=_,_=t,42==y&&(i=8+(T-8<<4)<<8,3<(r=(Y-1&255)>>1)&&(r=3),i|=r<<6,0!==O&&(i|=32),y=113,l((s=i+=31-i%31)>>8&255),l(255&s)),0!==se.pending){if(P.flush_pending(),0===P.avail_out)return _=-1,0}else if(0===P.avail_in&&t<=a&&4!=t)return P.msg=pe[7],-5;if(666==y&&0!==P.avail_in)return e.msg=pe[7],-5;if(0!==P.avail_in||0!==H||0!=t&&666!=y){switch(o=-1,ge[Y].func){case 0:o=function(e){var t,n=65535;for(S-5<n&&(n=S-5);;){if(H<=1){if(w(),0===H&&0==e)return 0;if(0===H)break}if(O+=H,t=R+n,((H=0)===O||t<=O)&&(H=O-t,O=t,b(!1),0===P.avail_out))return 0;if(C-262<=O-R&&(b(!1),0===P.avail_out))return 0}return b(4==e),0===P.avail_out?4==e?2:0:4==e?3:1}(t);break;case 1:o=function(e){for(var t,n=0;;){if(H<262){if(w(),H<262&&0==e)return 0;if(0===H)break}if(3<=H&&(n=65535&E[D=(D<<W^255&M[O+2])&B],A[O&I]=E[D],E[D]=O),0!==n&&(O-n&65535)<=C-262&&2!=q&&(U=x(n)),3<=U)if(t=g(O-N,U-3),H-=U,U<=j&&3<=H){for(U--;n=65535&E[D=(D<<W^255&M[++O+2])&B],A[O&I]=E[D],E[D]=O,0!=--U;);O++}else O+=U,U=0,D=((D=255&M[O])<<W^255&M[O+1])&B;else t=g(0,255&M[O]),H--,O++;if(t&&(b(!1),0===P.avail_out))return 0}return b(4==e),0===P.avail_out?4==e?2:0:4==e?3:1}(t);break;case 2:o=function(e){for(var t,n,i=0;;){if(H<262){if(w(),H<262&&0==e)return 0;if(0===H)break}if(3<=H&&(i=65535&E[D=(D<<W^255&M[O+2])&B],A[O&I]=E[D],E[D]=O),X=U,V=N,U=2,0!==i&&X<j&&(O-i&65535)<=C-262&&(2!=q&&(U=x(i)),U<=5&&(1==q||3==U&&4096<O-N)&&(U=2)),3<=X&&U<=X){for(n=O+H-3,t=g(O-1-V,X-3),H-=X-1,X-=2;++O<=n&&(i=65535&E[D=(D<<W^255&M[O+2])&B],A[O&I]=E[D],E[D]=O),0!=--X;);if(z=0,U=2,O++,t&&(b(!1),0===P.avail_out))return 0}else if(0!==z){if((t=g(0,255&M[O-1]))&&b(!1),O++,H--,0===P.avail_out)return 0}else z=1,O++,H--}return 0!==z&&(t=g(0,255&M[O-1]),z=0),b(4==e),0===P.avail_out?4==e?2:0:4==e?3:1}(t)}if(2!=o&&3!=o||(y=666),0==o||2==o)return 0===P.avail_out&&(_=-1),0;if(1==o){if(1==t)c(2,3),u(256,fe.static_ltree),h(),1+re+10-oe<9&&(c(2,3),u(256,fe.static_ltree),h()),re=7;else if(v(0,0,!1),3==t)for(n=0;n<F;n++)E[n]=0;if(P.flush_pending(),0===P.avail_out)return _=-1,0}}return 4!=t?0:1}}function i(){this.next_in_index=0,this.next_out_index=0,this.avail_in=0,this.total_in=0,this.avail_out=0,this.total_out=0}var g=15,p=573,r=[0,1,2,3,4,4,5,5,6,6,6,6,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,0,0,16,17,18,18,19,19,20,20,20,20,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29];ue._length_code=[0,1,2,3,4,5,6,7,8,8,9,9,10,10,11,11,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28],ue.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],ue.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],ue.d_code=function(e){return e<256?r[e]:r[256+(e>>>7)]},ue.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ue.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],ue.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],ue.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],fe.static_ltree=[12,8,140,8,76,8,204,8,44,8,172,8,108,8,236,8,28,8,156,8,92,8,220,8,60,8,188,8,124,8,252,8,2,8,130,8,66,8,194,8,34,8,162,8,98,8,226,8,18,8,146,8,82,8,210,8,50,8,178,8,114,8,242,8,10,8,138,8,74,8,202,8,42,8,170,8,106,8,234,8,26,8,154,8,90,8,218,8,58,8,186,8,122,8,250,8,6,8,134,8,70,8,198,8,38,8,166,8,102,8,230,8,22,8,150,8,86,8,214,8,54,8,182,8,118,8,246,8,14,8,142,8,78,8,206,8,46,8,174,8,110,8,238,8,30,8,158,8,94,8,222,8,62,8,190,8,126,8,254,8,1,8,129,8,65,8,193,8,33,8,161,8,97,8,225,8,17,8,145,8,81,8,209,8,49,8,177,8,113,8,241,8,9,8,137,8,73,8,201,8,41,8,169,8,105,8,233,8,25,8,153,8,89,8,217,8,57,8,185,8,121,8,249,8,5,8,133,8,69,8,197,8,37,8,165,8,101,8,229,8,21,8,149,8,85,8,213,8,53,8,181,8,117,8,245,8,13,8,141,8,77,8,205,8,45,8,173,8,109,8,237,8,29,8,157,8,93,8,221,8,61,8,189,8,125,8,253,8,19,9,275,9,147,9,403,9,83,9,339,9,211,9,467,9,51,9,307,9,179,9,435,9,115,9,371,9,243,9,499,9,11,9,267,9,139,9,395,9,75,9,331,9,203,9,459,9,43,9,299,9,171,9,427,9,107,9,363,9,235,9,491,9,27,9,283,9,155,9,411,9,91,9,347,9,219,9,475,9,59,9,315,9,187,9,443,9,123,9,379,9,251,9,507,9,7,9,263,9,135,9,391,9,71,9,327,9,199,9,455,9,39,9,295,9,167,9,423,9,103,9,359,9,231,9,487,9,23,9,279,9,151,9,407,9,87,9,343,9,215,9,471,9,55,9,311,9,183,9,439,9,119,9,375,9,247,9,503,9,15,9,271,9,143,9,399,9,79,9,335,9,207,9,463,9,47,9,303,9,175,9,431,9,111,9,367,9,239,9,495,9,31,9,287,9,159,9,415,9,95,9,351,9,223,9,479,9,63,9,319,9,191,9,447,9,127,9,383,9,255,9,511,9,0,7,64,7,32,7,96,7,16,7,80,7,48,7,112,7,8,7,72,7,40,7,104,7,24,7,88,7,56,7,120,7,4,7,68,7,36,7,100,7,20,7,84,7,52,7,116,7,3,8,131,8,67,8,195,8,35,8,163,8,99,8,227,8],fe.static_dtree=[0,5,16,5,8,5,24,5,4,5,20,5,12,5,28,5,2,5,18,5,10,5,26,5,6,5,22,5,14,5,30,5,1,5,17,5,9,5,25,5,5,5,21,5,13,5,29,5,3,5,19,5,11,5,27,5,7,5,23,5],fe.static_l_desc=new fe(fe.static_ltree,ue.extra_lbits,257,286,g),fe.static_d_desc=new fe(fe.static_dtree,ue.extra_dbits,0,30,g),fe.static_bl_desc=new fe(null,ue.extra_blbits,0,19,7);var ge=[new t(0,0,0,0,0),new t(4,4,8,4,1),new t(4,5,16,8,1),new t(4,6,32,32,1),new t(4,4,16,16,2),new t(8,16,32,32,2),new t(8,16,128,128,2),new t(8,32,128,256,2),new t(32,128,258,1024,2),new t(32,258,258,4096,2)],pe=["need dictionary","stream end","","","stream error","data error","","buffer error","",""];i.prototype={deflateInit:function(e,t){return this.dstate=new n,this.dstate.deflateInit(this,e,t=t||g)},deflate:function(e){return this.dstate?this.dstate.deflate(this,e):-2},deflateEnd:function(){if(!this.dstate)return-2;var e=this.dstate.deflateEnd();return this.dstate=null,e},deflateParams:function(e,t){return this.dstate?this.dstate.deflateParams(this,e,t):-2},deflateSetDictionary:function(e,t){return this.dstate?this.dstate.deflateSetDictionary(this,e,t):-2},read_buf:function(e,t,n){var i=this.avail_in;return n<i&&(i=n),0===i?0:(this.avail_in-=i,e.set(this.next_in.subarray(this.next_in_index,this.next_in_index+i),t),this.next_in_index+=i,this.total_in+=i,i)},flush_pending:function(){var e=this,t=e.dstate.pending;e.avail_out<t&&(t=e.avail_out),0!==t&&(e.next_out.set(e.dstate.pending_buf.subarray(e.dstate.pending_out,e.dstate.pending_out+t),e.next_out_index),e.next_out_index+=t,e.dstate.pending_out+=t,e.total_out+=t,e.avail_out-=t,e.dstate.pending-=t,0===e.dstate.pending&&(e.dstate.pending_out=0))}};var a=e.zip||e;a.Deflater=a._jzlib_Deflater=function(e){var s=new i,l=new Uint8Array(512),t=e?e.level:-1;void 0===t&&(t=-1),s.deflateInit(t),s.next_out=l,this.append=function(e,t){var n,i=[],r=0,a=0,o=0;if(e.length){s.next_in_index=0,s.next_in=e,s.avail_in=e.length;do{if(s.next_out_index=0,s.avail_out=512,0!=s.deflate(0))throw new Error("deflating: "+s.msg);s.next_out_index&&i.push(512==s.next_out_index?new Uint8Array(l):new Uint8Array(l.subarray(0,s.next_out_index))),o+=s.next_out_index,t&&0<s.next_in_index&&s.next_in_index!=r&&(t(s.next_in_index),r=s.next_in_index)}while(0<s.avail_in||0===s.avail_out);return n=new Uint8Array(o),i.forEach(function(e){n.set(e,a),a+=e.length}),n}},this.flush=function(){var e,t,n=[],i=0,r=0;do{if(s.next_out_index=0,s.avail_out=512,1!=(e=s.deflate(4))&&0!=e)throw new Error("deflating: "+s.msg);0<512-s.avail_out&&n.push(new Uint8Array(l.subarray(0,s.next_out_index))),r+=s.next_out_index}while(0<s.avail_in||0===s.avail_out);return s.deflateEnd(),t=new Uint8Array(r),n.forEach(function(e){t.set(e,i),i+=e.length}),t}}}(this),function(e){"use strict";function D(){function c(e,t,n,i,r,a,o,s,l,d,c){var u,f,h,g,p,m,v,b,w,x,k,P,y,S,_;for(x=0,p=n;C[e[t+x]]++,x++,0!==--p;);if(C[0]==n)return o[0]=-1,s[0]=0,F;for(b=s[0],m=1;m<=A&&0===C[m];m++);for(b<(v=m)&&(b=m),p=A;0!==p&&0===C[p];p--);for((h=p)<b&&(b=p),s[0]=b,S=1<<m;m<p;m++,S<<=1)if((S-=C[m])<0)return W;if((S-=C[p])<0)return W;for(C[p]+=S,M[1]=m=0,x=1,y=2;0!=--p;)M[y]=m+=C[x],y++,x++;for(x=p=0;0!==(m=e[t+x])&&(c[M[m]++]=p),x++,++p<n;);for(n=M[h],M[0]=p=0,g=-1,P=-b,_=k=I[x=0]=0;v<=h;v++)for(u=C[v];0!=u--;){for(;P+b<v;){if(g++,_=b<(_=h-(P+=b))?b:_,(f=1<<(m=v-P))>u+1&&(f-=u+1,y=v,m<_))for(;++m<_&&!((f<<=1)<=C[++y]);)f-=C[y];if(V<d[0]+(_=1<<m))return W;I[g]=k=d[0],d[0]+=_,0!==g?(M[g]=p,T[0]=m,T[1]=b,T[2]=k-I[g-1]-(m=p>>>P-b),l.set(T,3*(I[g-1]+m))):o[0]=k}for(T[1]=v-P,n<=x?T[0]=192:c[x]<i?(T[0]=c[x]<256?0:96,T[2]=c[x++]):(T[0]=a[c[x]-i]+16+64,T[2]=r[c[x++]-i]),f=1<<v-P,m=p>>>P;m<_;m+=f)l.set(T,3*(k+m));for(m=1<<v-1;0!=(p&m);m>>>=1)p^=m;for(p^=m,w=(1<<P)-1;(p&w)!=M[g];)g--,w=(1<<(P-=b))-1}return 0!==S&&1!=h?R:F}function u(e){var t;for(f||(f=[],h=[],C=new Int32Array(A+1),T=[],I=new Int32Array(A),M=new Int32Array(A+1)),h.length<e&&(h=[]),t=0;t<e;t++)h[t]=0;for(t=0;t<A+1;t++)C[t]=0;for(t=0;t<3;t++)T[t]=0;I.set(C.subarray(0,A),0),M.set(C.subarray(0,A+1),0)}var f,h,C,T,I,M;this.inflate_trees_bits=function(e,t,n,i,r){var a;return u(19),(a=c(e,f[0]=0,19,19,null,null,n,t,i,f,h))==W?r.msg="oversubscribed dynamic bit lengths tree":a!=R&&0!==t[0]||(r.msg="incomplete dynamic bit lengths tree",a=W),a},this.inflate_trees_dynamic=function(e,t,n,i,r,a,o,s,l){var d;return u(288),(d=c(n,f[0]=0,e,257,p,m,a,i,s,f,h))!=F||0===i[0]?(d==W?l.msg="oversubscribed literal/length tree":d!=g&&(l.msg="incomplete literal/length tree",d=W),d):(u(288),(d=c(n,e,t,0,v,b,o,r,s,f,h))!=F||0===r[0]&&257<e?(d==W?l.msg="oversubscribed distance tree":d==R?(l.msg="incomplete distance tree",d=W):d!=g&&(l.msg="empty distance tree with lengths",d=W),d):F)}}function n(){function h(e,t,n,i,r,a,o,s){var l,d,c,u,f,h,g,p,m,v,b,w,x,k,P,y;g=s.next_in_index,p=s.avail_in,f=o.bitb,h=o.bitk,v=(m=o.write)<o.read?o.read-m-1:o.end-m,b=U[e],w=U[t];do{for(;h<20;)p--,f|=(255&s.read_byte(g++))<<h,h+=8;if(0!==(u=(d=n)[y=3*((c=i)+(l=f&b))]))for(;;){if(f>>=d[y+1],h-=d[y+1],0!=(16&u)){for(x=d[y+2]+(f&U[u&=15]),f>>=u,h-=u;h<15;)p--,f|=(255&s.read_byte(g++))<<h,h+=8;for(u=(d=r)[y=3*((c=a)+(l=f&w))];;){if(f>>=d[y+1],h-=d[y+1],0!=(16&u)){for(u&=15;h<u;)p--,f|=(255&s.read_byte(g++))<<h,h+=8;if(k=d[y+2]+(f&U[u]),f>>=u,h-=u,v-=x,k<=m)0<m-(P=m-k)&&m-P<2?(o.window[m++]=o.window[P++],o.window[m++]=o.window[P++]):(o.window.set(o.window.subarray(P,P+2),m),m+=2,P+=2),x-=2;else{for(P=m-k;(P+=o.end)<0;);if((u=o.end-P)<x){if(x-=u,0<m-P&&m-P<u)for(;o.window[m++]=o.window[P++],0!=--u;);else o.window.set(o.window.subarray(P,P+u),m),m+=u,P+=u,u=0;P=0}}if(0<m-P&&m-P<x)for(;o.window[m++]=o.window[P++],0!=--x;);else o.window.set(o.window.subarray(P,P+x),m),m+=x,P+=x,x=0;break}if(0!=(64&u))return s.msg="invalid distance code",p+=x=h>>3<(x=s.avail_in-p)?h>>3:x,g-=x,h-=x<<3,o.bitb=f,o.bitk=h,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,W;l+=d[y+2],u=d[y=3*(c+(l+=f&U[u]))]}break}if(0!=(64&u))return 0!=(32&u)?(p+=x=h>>3<(x=s.avail_in-p)?h>>3:x,g-=x,h-=x<<3,o.bitb=f,o.bitk=h,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,L):(s.msg="invalid literal/length code",p+=x=h>>3<(x=s.avail_in-p)?h>>3:x,g-=x,h-=x<<3,o.bitb=f,o.bitk=h,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,W);if(l+=d[y+2],0===(u=d[y=3*(c+(l+=f&U[u]))])){f>>=d[y+1],h-=d[y+1],o.window[m++]=d[y+2],v--;break}}else f>>=d[y+1],h-=d[y+1],o.window[m++]=d[y+2],v--}while(258<=v&&10<=p);return p+=x=h>>3<(x=s.avail_in-p)?h>>3:x,g-=x,h-=x<<3,o.bitb=f,o.bitk=h,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,F}var g,p,m,v,b=0,w=0,x=0,k=0,P=0,y=0,S=0,_=0,C=0,T=0;this.init=function(e,t,n,i,r,a){g=I,S=e,_=t,m=n,C=i,v=r,T=a,p=null},this.proc=function(e,t,n){var i,r,a,o,s,l,d,c=0,u=0,f=0;for(f=t.next_in_index,o=t.avail_in,c=e.bitb,u=e.bitk,l=(s=e.write)<e.read?e.read-s-1:e.end-s;;)switch(g){case I:if(258<=l&&10<=o&&(e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,n=h(S,_,m,C,v,T,e,t),f=t.next_in_index,o=t.avail_in,c=e.bitb,u=e.bitk,l=(s=e.write)<e.read?e.read-s-1:e.end-s,n!=F)){g=n==L?X:j;break}x=S,p=m,w=C,g=M;case M:for(i=x;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(f++))<<u,u+=8}if(c>>>=p[(r=3*(w+(c&U[i])))+1],u-=p[r+1],0===(a=p[r])){k=p[r+2],g=H;break}if(0!=(16&a)){P=15&a,b=p[r+2],g=E;break}if(0==(64&a)){x=a,w=r/3+p[r+2];break}if(0==(32&a))return g=j,t.msg="invalid literal/length code",n=W,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);g=X;break;case E:for(i=P;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(f++))<<u,u+=8}b+=c&U[i],c>>=i,u-=i,x=_,p=v,w=T,g=z;case z:for(i=x;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(f++))<<u,u+=8}if(c>>=p[(r=3*(w+(c&U[i])))+1],u-=p[r+1],0!=(16&(a=p[r]))){P=15&a,y=p[r+2],g=O;break}if(0!=(64&a))return g=j,t.msg="invalid distance code",n=W,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);x=a,w=r/3+p[r+2];break;case O:for(i=P;u<i;){if(0===o)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);n=F,o--,c|=(255&t.read_byte(f++))<<u,u+=8}y+=c&U[i],c>>=i,u-=i,g=N;case N:for(d=s-y;d<0;)d+=e.end;for(;0!==b;){if(0===l&&(s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l&&(e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l)))return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);e.window[s++]=e.window[d++],l--,d==e.end&&(d=0),b--}g=I;break;case H:if(0===l&&(s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l&&(e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l)))return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);n=F,e.window[s++]=k,l--,g=I;break;case X:if(7<u&&(u-=8,o++,f--),e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,e.read!=e.write)return e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);g=G;case G:return n=L,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);case j:return n=W,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n);default:return n=B,e.bitb=c,e.bitk=u,t.avail_in=o,t.total_in+=f-t.next_in_index,t.next_in_index=f,e.write=s,e.inflate_flush(t,n)}},this.free=function(){}}function i(e,t){var x,k=this,P=q,y=0,S=0,_=0,C=[0],T=[0],I=new n,M=0,A=new Int32Array(3*V),E=new D;k.bitk=0,k.bitb=0,k.window=new Uint8Array(t),k.end=t,k.read=0,k.write=0,k.reset=function(e,t){t&&(t[0]=0),P==ee&&I.free(e),P=q,k.bitk=0,k.bitb=0,k.read=k.write=0},k.reset(e,null),k.inflate_flush=function(e,t){var n,i,r;return i=e.next_out_index,e.avail_out<(n=((r=k.read)<=k.write?k.write:k.end)-r)&&(n=e.avail_out),0!==n&&t==R&&(t=F),e.avail_out-=n,e.total_out+=n,e.next_out.set(k.window.subarray(r,r+n),i),i+=n,(r+=n)==k.end&&(r=0,k.write==k.end&&(k.write=0),e.avail_out<(n=k.write-r)&&(n=e.avail_out),0!==n&&t==R&&(t=F),e.avail_out-=n,e.total_out+=n,e.next_out.set(k.window.subarray(r,r+n),i),i+=n,r+=n),e.next_out_index=i,k.read=r,t},k.proc=function(e,t){var n,i,r,a,o,s,l,d;for(a=e.next_in_index,o=e.avail_in,i=k.bitb,r=k.bitk,l=(s=k.write)<k.read?k.read-s-1:k.end-s;;)switch(P){case q:for(;r<3;){if(0===o)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(a++))<<r,r+=8}switch(M=1&(n=7&i),n>>>1){case 0:i>>>=3,i>>>=n=7&(r-=3),r-=n,P=K;break;case 1:var c=[],u=[],f=[[]],h=[[]];D.inflate_trees_fixed(c,u,f,h),I.init(c[0],u[0],f[0],0,h[0],0),i>>>=3,r-=3,P=ee;break;case 2:i>>>=3,r-=3,P=J;break;case 3:return i>>>=3,r-=3,P=ie,e.msg="invalid block type",t=W,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t)}break;case K:for(;r<32;){if(0===o)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(a++))<<r,r+=8}if((~i>>>16&65535)!=(65535&i))return P=ie,e.msg="invalid stored block lengths",t=W,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);y=65535&i,i=r=0,P=0!==y?Z:0!==M?te:q;break;case Z:if(0===o)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);if(0===l&&(s==k.end&&0!==k.read&&(l=(s=0)<k.read?k.read-s-1:k.end-s),0===l&&(k.write=s,t=k.inflate_flush(e,t),l=(s=k.write)<k.read?k.read-s-1:k.end-s,s==k.end&&0!==k.read&&(l=(s=0)<k.read?k.read-s-1:k.end-s),0===l)))return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);if(t=F,o<(n=y)&&(n=o),l<n&&(n=l),k.window.set(e.read_buf(a,n),s),a+=n,o-=n,s+=n,l-=n,0!=(y-=n))break;P=0!==M?te:q;break;case J:for(;r<14;){if(0===o)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(a++))<<r,r+=8}if(S=n=16383&i,29<(31&n)||29<(n>>5&31))return P=ie,e.msg="too many length or distance symbols",t=W,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);if(n=258+(31&n)+(n>>5&31),!x||x.length<n)x=[];else for(d=0;d<n;d++)x[d]=0;i>>>=14,r-=14,_=0,P=Q;case Q:for(;_<4+(S>>>10);){for(;r<3;){if(0===o)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(a++))<<r,r+=8}x[Y[_++]]=7&i,i>>>=3,r-=3}for(;_<19;)x[Y[_++]]=0;if(C[0]=7,(n=E.inflate_trees_bits(x,C,T,A,e))!=F)return(t=n)==W&&(x=null,P=ie),k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);_=0,P=$;case $:for(;!(258+(31&(n=S))+(n>>5&31)<=_);){var g,p;for(n=C[0];r<n;){if(0===o)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(a++))<<r,r+=8}if((p=A[3*(T[0]+(i&U[n=A[3*(T[0]+(i&U[n]))+1]]))+2])<16)i>>>=n,r-=n,x[_++]=p;else{for(d=18==p?7:p-14,g=18==p?11:3;r<n+d;){if(0===o)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);t=F,o--,i|=(255&e.read_byte(a++))<<r,r+=8}if(r-=n,g+=(i>>>=n)&U[d],i>>>=d,r-=d,258+(31&(n=S))+(n>>5&31)<(d=_)+g||16==p&&d<1)return x=null,P=ie,e.msg="invalid bit length repeat",t=W,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);for(p=16==p?x[d-1]:0;x[d++]=p,0!=--g;);_=d}}T[0]=-1;var m=[],v=[],b=[],w=[];if(m[0]=9,v[0]=6,(n=E.inflate_trees_dynamic(257+(31&(n=S)),1+(n>>5&31),x,m,v,b,w,A,e))!=F)return n==W&&(x=null,P=ie),t=n,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);I.init(m[0],v[0],A,b[0],A,w[0]),P=ee;case ee:if(k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,(t=I.proc(k,e,t))!=L)return k.inflate_flush(e,t);if(t=F,I.free(e),a=e.next_in_index,o=e.avail_in,i=k.bitb,r=k.bitk,l=(s=k.write)<k.read?k.read-s-1:k.end-s,0===M){P=q;break}P=te;case te:if(k.write=s,t=k.inflate_flush(e,t),l=(s=k.write)<k.read?k.read-s-1:k.end-s,k.read!=k.write)return k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);P=ne;case ne:return t=L,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);case ie:return t=W,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t);default:return t=B,k.bitb=i,k.bitk=r,e.avail_in=o,e.total_in+=a-e.next_in_index,e.next_in_index=a,k.write=s,k.inflate_flush(e,t)}},k.free=function(e){k.reset(e,null),A=k.window=null},k.set_dictionary=function(e,t,n){k.window.set(e.subarray(t,t+n),0),k.read=k.write=n},k.sync_point=function(){return P==K?1:0}}function t(){function o(e){return e&&e.istate?(e.total_in=e.total_out=0,e.msg=null,e.istate.mode=7,e.istate.blocks.reset(e,null),F):B}var n=this;n.mode=0,n.method=0,n.was=[0],n.need=0,n.marker=0,n.wbits=0,n.inflateEnd=function(e){return n.blocks&&n.blocks.free(e),n.blocks=null,F},n.inflateInit=function(e,t){return n.blocks=e.msg=null,t<8||15<t?(n.inflateEnd(e),B):(e.istate.blocks=new i(e,1<<(n.wbits=t)),o(e),F)},n.inflate=function(e,t){var n,i;if(!e||!e.istate||!e.next_in)return B;for(t=4==t?R:F,n=R;;)switch(e.istate.mode){case 0:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,8!=(15&(e.istate.method=e.read_byte(e.next_in_index++)))){e.istate.mode=13,e.msg="unknown compression method",e.istate.marker=5;break}if(e.istate.wbits<8+(e.istate.method>>4)){e.istate.mode=13,e.msg="invalid window size",e.istate.marker=5;break}e.istate.mode=1;case 1:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,i=255&e.read_byte(e.next_in_index++),((e.istate.method<<8)+i)%31!=0){e.istate.mode=13,e.msg="incorrect header check",e.istate.marker=5;break}if(0==(32&i)){e.istate.mode=7;break}e.istate.mode=2;case 2:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need=(255&e.read_byte(e.next_in_index++))<<24&4278190080,e.istate.mode=3;case 3:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<16&16711680,e.istate.mode=4;case 4:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<8&65280,e.istate.mode=5;case 5:return 0===e.avail_in?n:(n=t,e.avail_in--,e.total_in++,e.istate.need+=255&e.read_byte(e.next_in_index++),e.istate.mode=6,2);case 6:return e.istate.mode=13,e.msg="need dictionary",e.istate.marker=0,B;case 7:if((n=e.istate.blocks.proc(e,n))==W){e.istate.mode=13,e.istate.marker=0;break}if(n==F&&(n=t),n!=L)return n;n=t,e.istate.blocks.reset(e,e.istate.was),e.istate.mode=12;case 12:return L;case 13:return W;default:return B}},n.inflateSetDictionary=function(e,t,n){var i=0,r=n;return e&&e.istate&&6==e.istate.mode?(1<<e.istate.wbits<=r&&(i=n-(r=(1<<e.istate.wbits)-1)),e.istate.blocks.set_dictionary(t,i,r),e.istate.mode=7,F):B},n.inflateSync=function(e){var t,n,i,r,a;if(!e||!e.istate)return B;if(13!=e.istate.mode&&(e.istate.mode=13,e.istate.marker=0),0===(t=e.avail_in))return R;for(n=e.next_in_index,i=e.istate.marker;0!==t&&i<4;)e.read_byte(n)==s[i]?i++:i=0!==e.read_byte(n)?0:4-i,n++,t--;return e.total_in+=n-e.next_in_index,e.next_in_index=n,e.avail_in=t,4!=(e.istate.marker=i)?W:(r=e.total_in,a=e.total_out,o(e),e.total_in=r,e.total_out=a,e.istate.mode=7,F)},n.inflateSyncPoint=function(e){return e&&e.istate&&e.istate.blocks?e.istate.blocks.sync_point():B}}function r(){}var F=0,L=1,B=-2,W=-3,g=-4,R=-5,U=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],V=1440,a=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],o=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],p=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],m=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],v=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],b=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],A=15;D.inflate_trees_fixed=function(e,t,n,i){return e[0]=9,t[0]=5,n[0]=a,i[0]=o,F};var I=0,M=1,E=2,z=3,O=4,N=5,H=6,X=7,G=8,j=9,Y=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=0,K=1,Z=2,J=3,Q=4,$=5,ee=6,te=7,ne=8,ie=9,s=[0,0,255,255];r.prototype={inflateInit:function(e){return this.istate=new t,this.istate.inflateInit(this,e=e||15)},inflate:function(e){return this.istate?this.istate.inflate(this,e):B},inflateEnd:function(){if(!this.istate)return B;var e=this.istate.inflateEnd(this);return this.istate=null,e},inflateSync:function(){return this.istate?this.istate.inflateSync(this):B},inflateSetDictionary:function(e,t){return this.istate?this.istate.inflateSetDictionary(this,e,t):B},read_byte:function(e){return this.next_in.subarray(e,e+1)[0]},read_buf:function(e,t){return this.next_in.subarray(e,e+t)}};var l=e.zip||e;l.Inflater=l._jzlib_Inflater=function(){var l=new r,d=new Uint8Array(512),c=!1;l.inflateInit(),l.next_out=d,this.append=function(e,t){var n,i,r=[],a=0,o=0,s=0;if(0!==e.length){l.next_in_index=0,l.next_in=e,l.avail_in=e.length;do{if(l.next_out_index=0,l.avail_out=512,0!==l.avail_in||c||(c=!(l.next_in_index=0)),n=l.inflate(0),c&&n===R){if(0!==l.avail_in)throw new Error("inflating: bad input")}else if(n!==F&&n!==L)throw new Error("inflating: "+l.msg);if((c||n===L)&&l.avail_in===e.length)throw new Error("inflating: bad input");l.next_out_index&&r.push(512===l.next_out_index?new Uint8Array(d):new Uint8Array(d.subarray(0,l.next_out_index))),s+=l.next_out_index,t&&0<l.next_in_index&&l.next_in_index!=a&&(t(l.next_in_index),a=l.next_in_index)}while(0<l.avail_in||0===l.avail_out);return i=new Uint8Array(s),r.forEach(function(e){i.set(e,o),o+=e.length}),i}},this.flush=function(){l.inflateEnd()}}}(this),function(i){"use strict";function f(e){var t=i[e.codecClass],n=e.sn;if(h[n])throw Error("duplicated sn");h[n]={codec:new t(e.options),crcInput:"input"===e.crcType,crcOutput:"output"===e.crcType,crc:new r},postMessage({type:"newTask",sn:n})}function e(e){var t=e.sn,n=e.type,i=e.data,r=h[t];!r&&e.codecClass&&(f(e),r=h[t]);var a,o="append"===n,s=g();if(o)try{a=r.codec.append(i,function(e){postMessage({type:"progress",sn:t,loaded:e})})}catch(e){throw delete h[t],e}else delete h[t],a=r.codec.flush();var l=g()-s;s=g(),i&&r.crcInput&&r.crc.append(i),a&&r.crcOutput&&r.crc.append(a);var d=g()-s,c={type:n,sn:t,codecTime:l,crcTime:d},u=[];a&&u.push((c.data=a).buffer),o||!r.crcInput&&!r.crcOutput||(c.crc=r.crc.get());try{postMessage(c,u)}catch(e){postMessage(c)}}function r(){this.crc=-1}function t(){}if(i.zWorkerInitialized)throw new Error("z-worker.js should be run only once");i.zWorkerInitialized=!0,addEventListener("message",function(e){var t=e.data,n=t.type,i=t.sn,r=a[n];if(r)try{r(t)}catch(e){!function(e,t,n){var i,r={type:e,sn:t,error:{message:(i=n).message,stack:i.stack}};postMessage(r)}(n,i,e)}});var a={importScripts:function(e){e.scripts&&0<e.scripts.length&&importScripts.apply(void 0,e.scripts),postMessage({type:"importScripts"})},newTask:f,append:e,flush:e},h={},g=i.performance?i.performance.now.bind(i.performance):Date.now;r.prototype.append=function(e){for(var t=0|this.crc,n=this.table,i=0,r=0|e.length;i<r;i++)t=t>>>8^n[255&(t^e[i])];this.crc=t},r.prototype.get=function(){return~this.crc},r.prototype.table=function(){var e,t,n,i=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)1&n?n=n>>>1^3988292384:n>>>=1;i[e]=n}return i}(),(i.NOOP=t).prototype.append=function(e){return e},t.prototype.flush=function(){}}(this);var Nn,Hn,Xn,Gn=function(){function o(e,t,n){var i=mn.getProperties().tickTime,r=e.sustain?e.sustainPoint+1:e.count;e.loopStartPoint=Math.min(e.loopStartPoint,e.count-1),e.loopEndPoint=Math.min(e.loopEndPoint,e.count-1);var a=e.loop&&e.loopStartPoint<e.loopEndPoint;e.sustain&&e.sustainPoint<=e.loopStartPoint&&(a=!1),a&&(r=e.loopEndPoint+1);var o=0;if(t.gain)var s=t.gain,l=0,d=64;else s=t.pan,d=l=32;s.setValueAtTime((e.points[0][1]-l)/d,n);for(var c=1;c<r;c++){var u=e.points[c];s.linearRampToValueAtTime((u[1]-l)/d,n+(o=u[0]*i))}return!!a&&h.scheduleEnvelopeLoop(t,n,2,o)}var h={type:"sample",name:"",instrumentIndex:0,sampleIndex:-1,fadeout:128,data:[]};return h.samples=[Yn()],h.sample=h.samples[0],h.volumeEnvelope={raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6},h.panningEnvelope={raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5},h.vibrato={},h.sampleNumberForNotes=[],h.play=function(e,t,n,i,r,a){return mn.inFTMode()&&(t=h.getPeriodForNote(e)),Wt.playSample(h.instrumentIndex,t,n,i,r,a,e)},h.noteOn=function(e){var t,n,i={};if(h.volumeEnvelope.enabled){t=Wt.context.createGain();var r=h.volumeEnvelope,a=o(r,t,e);a&&(i.volume=e+a)}return h.panningEnvelope.enabled&&Wt.usePanning&&(n=Wt.context.createStereoPanner(),(a=o(r=h.panningEnvelope,n,e))&&(i.panning=e+a)),h.vibrato.rate&&h.vibrato.depth&&(i.ticks=0,i.vibrato=e,i.vibratoFunction=h.getAutoVibratoFunction()),{volume:t,panning:n,scheduled:i}},h.noteOff=function(e,t){function n(){t.volume.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeEnvelope&&t.volumeEnvelope.gain.cancelScheduledValues(e),t.panningEnvelope&&t.panningEnvelope.pan.cancelScheduledValues(e),t.scheduled=void 0}if(t&&t.volume){if(mn.inFTMode()){var i=mn.getProperties().tickTime;if(h.volumeEnvelope.enabled){if(h.volumeEnvelope.sustain&&t.volumeEnvelope){n();var r=0,a=h.volumeEnvelope.points[h.volumeEnvelope.sustainPoint];a&&(r=a[0]*i);for(var o=h.volumeEnvelope.sustainPoint;o<h.volumeEnvelope.count;o++){var s=h.volumeEnvelope.points[o];s&&t.volumeEnvelope.gain.linearRampToValueAtTime(s[1]/64,e+s[0]*i-r)}}if(h.fadeout)t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+65536/h.fadeout*i/2)}else n(),t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+.1);if(h.panningEnvelope.enabled&&Wt.usePanning&&t.panningEnvelope)for(r=0,(a=h.panningEnvelope.points[h.panningEnvelope.sustainPoint])&&(r=a[0]*i),o=h.panningEnvelope.sustainPoint;o<h.panningEnvelope.count;o++)(s=h.panningEnvelope.points[o])&&t.panningEnvelope.pan.linearRampToValueAtTime((s[1]-32)/32,e+s[0]*i-r);return 100}if(n(),!t.isKey||!t.volume)return 0;t.volume.gain.linearRampToValueAtTime(0,e+.5)}},h.scheduleEnvelopeLoop=function(e,t,n,i){i=i||0;var r=mn.getProperties().tickTime;if(e.gain)var a=h.volumeEnvelope,o=e.gain,s=0,l=64;else a=h.panningEnvelope,o=e.pan,l=s=32;var d=a.points[a.loopStartPoint],c=d[0];if(a.loop&&a.loopStartPoint<a.loopEndPoint)for(;i<n;)for(var u=i,f=a.loopStartPoint;f<=a.loopEndPoint;f++)o.linearRampToValueAtTime(((d=a.points[f])[1]-s)/l,t+(i=u+(d[0]-c)*r));return i},h.scheduleAutoVibrato=function(e,t){var n=0;e.scheduled.ticks=e.scheduled.ticks||0;var i,r,a,o,s=mn.getProperties().tickTime,l=-h.vibrato.rate/40,d=h.vibrato.depth/8;for(mn.useLinearFrequency&&(d*=4),e.source&&(i=e.startPeriod,r=e.scheduled.vibratoFunction||Wt.waveFormFunction.sine,a=e.scheduled.vibrato||Wt.context.currentTime,o=0);n<t;){if(n+=s,i){var c=1;h.vibrato.sweep&&e.scheduled.ticks<h.vibrato.sweep&&(c=1-(h.vibrato.sweep-e.scheduled.ticks)/h.vibrato.sweep);var u=r(i,e.scheduled.ticks,l,d*c);mn.setPeriodAtTime(e,u,a+o*s),o++}e.scheduled.ticks++}return n},h.getAutoVibratoFunction=function(){switch(h.vibrato.type){case 1:return Wt.waveFormFunction.square;case 2:return Wt.waveFormFunction.saw;case 3:return Wt.waveFormFunction.sawInverse}return Wt.waveFormFunction.sine},h.resetVolume=function(e,t){if(t.volumeFadeOut&&(t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.setValueAtTime(1,e)),t.volumeEnvelope){t.volumeEnvelope.gain.cancelScheduledValues(e);var n=mn.getProperties().tickTime,i=h.volumeEnvelope.sustain?h.volumeEnvelope.sustainPoint+1:h.volumeEnvelope.count;t.volumeEnvelope.gain.setValueAtTime(h.volumeEnvelope.points[0][1]/64,e);for(var r=1;r<i;r++){var a=h.volumeEnvelope.points[r];t.volumeEnvelope.gain.linearRampToValueAtTime(a[1]/64,e+a[0]*n)}}},h.getFineTune=function(){return mn.inFTMode()?h.sample.finetuneX:h.sample.finetune},h.setFineTune=function(e){mn.inFTMode()?(h.sample.finetuneX=e,h.sample.finetune=e>>4):(7<e&&(e-=15),h.sample.finetune=e,h.sample.finetuneX=e<<4)},h.getPeriodForNote=function(e,t){var n=0;return mn.useLinearFrequency?(n=7680-64*(e-1),t&&(n-=h.getFineTune()/2)):(n=gn[e].period,t&&h.getFineTune()&&(n=Wt.getFineTuneForNote(e,h.getFineTune()))),n},h.setSampleForNoteIndex=function(e){var t=h.sampleNumberForNotes[e-1];t!==h.sampleIndex&&"number"==typeof t&&h.setSampleIndex(t)},h.setSampleIndex=function(e){h.sampleIndex!==e&&(h.sample=h.samples[e],h.sampleIndex=e,Bt.trigger(H,h.instrumentIndex))},h.hasSamples=function(){for(var e=0,t=h.samples.length;e<t;e++)if(h.samples[e].length)return!0},h.hasVibrato=function(){return h.vibrato.rate&&h.vibrato.depth},h},jn=function(){var n={period:0,index:0,effect:0,instrument:0,param:0,volumeEffect:0,setPeriod:function(e){n.period=e,n.index=pn[e]||0},setIndex:function(e){var t=gn[n.index=e];t?(n.period=t.modPeriod||t.period,1===n.period&&(n.period=0)):n.period=0},clear:function(){n.instrument=0,n.period=0,n.effect=0,n.param=0,n.index=0,n.volumeEffect=0},duplicate:function(){return{instrument:n.instrument,period:n.period,effect:n.effect,param:n.param,volumeEffect:n.volumeEffect,note:n.index}},populate:function(e){n.instrument=e.instrument||0,n.period=e.period||0,n.effect=e.effect||0,n.param=e.param||0,n.volumeEffect=e.volumeEffect||0,n.index=e.note||e.index||0}};return n},Yn=function(){var r={data:[],length:0,name:"",bits:8,volume:64,finetune:0,finetuneX:0,panning:0,relativeNote:0,loop:{enabled:!1,start:0,length:0,type:0},check:function(){for(var e=0,t=0,n=0,i=r.data.length;n<i;n++)e=Math.min(e,r.data[n]),t=Math.max(t,r.data[n]);return{min:e,max:t}}};return r},qn=(Xn=!(Hn="https://www.stef.be/bassoontracker/api/"),(Nn={}).putFile=function(){Jt.buildBinary(mn.inFTMode()?Oe:ze,function(e){mn.getFileName(),Qt.sendBinary("https://www.stef.be/bassoontracker/api/storage/put/",e.buffer,function(e){})})},Nn.renderFile=function(i,r){if(!Xn){Xn=!0;var a=Hn+"storage/render/"+(mn.inFTMode()?"xm":"mod");i=i||mn.getFileName(),de.setStatus("saving file ...",!0),Jt.buildBinary(mn.inFTMode()?Oe:ze,function(n){Qt.sendBinary(a,n.buffer,function(e){if("error"===e)de.setStatus("error saving file"),Xn=!1;else{var t=e;de.setStatus("rendering file ...",!0),Qt.sendBinary(a=Hn+"storage/convert/"+t,n.buffer,function(e){"error"===e?(de.setStatus("Error rendering file ..."),Xn=!1):(t=e,r?(de.setStatus("Converting file to mp3...",!0),Qt.sendBinary(a=Hn+"storage/wavtomp3/"+t,n.buffer,function(e){"error"===e?(de.setStatus("Error converting file to mp3..."),Xn=!1):Kn(e,i,"mp3")})):Kn(t,i,"wav"))})}})})}},Nn.proxyUrl=function(e){return Hn+"proxy?"+encodeURIComponent(e)},Nn);function Kn(e,t,n){if(n){var i=!1,r=t.lastIndexOf(".");0<=r&&(i=t.substr(r+1).toLowerCase()===n.toLowerCase()),i||(t+="."+n)}de.setStatus("Downloading ..."),Xn=!1,setTimeout(function(){de.setStatus("")},3e3),document.location.href=Hn+"storage/"+e+"?dl=1&name="+t}var Zn,Jn,Qn,$n,ei,ti,ni=((Zn={}).isConnected=!1,Zn.checkConnected=function(t){Zn.isConnected&&t&&t(!0),dropboxService.getAccessToken()?dropboxService("users/get_current_account",void 0,{onComplete:function(e){e&&e.account_id&&(Zn.isConnected=!0,t&&t(!0))},onError:function(){t&&t(!1)}}):t&&t(!1)},Zn.showConnectDialog=function(){var n=de.modalDialog();n.setProperties({width:de.mainPanel.width,height:de.mainPanel.height,top:0,left:0,ok:!0,cancel:!0}),n.onClick=function(e){var t=n.getElementAtPoint(e.x,e.y);t&&t.name&&(de.setStatus(""),"okbutton"===t.name?ni.authenticate():(n.close(),Bt.trigger(g)))},n.setText("DROPBOX ://BassoonTracker is not yet connected to DropBox//Do you want to do that now?//(BassoonTracker will only have access/to its own BassoonTracker folder)"),de.setModalElement(n)},Zn.authenticate=function(){dropboxService.clearAccessToken(),dropboxService.authenticate({client_id:"ukk9z4f0nd1xa13",redirect_uri:"https://www.stef.be/bassoontracker/auth/dropbox.html"},{onComplete:function(e){},onError:function(e){}})},Zn.list=function(e,t){dropboxService("files/list_folder",{path:e},function(e){var n=[];e.entries.forEach(function(e){if(e[".tag"]&&"folder"===e[".tag"])n.push({title:e.name,url:e.path_lower,children:[]});else{var t=Math.floor(e.size/1e3)+"kb";n.push({title:e.name+" ("+t+")"||"---",url:e.id,path:e.path_display})}}),t(n)})},Zn.get=function(e,t){Zn.list(e,t)},Zn.getFile=function(e,i){dropboxService("files/download",{path:e.url},function(e,t,n){i(t)})},Zn.putFile=function(e,t,i){var n={path:e};"overwrite"===Lt.dropboxMode?n.mode="overwrite":(n.mode="add",n.autorename=!0),dropboxService("files/upload",n,t,{onComplete:function(e,t,n){i&&i(e)},onError:function(e,t,n){i&&i(!1)}})},Zn),ii=function(){function l(e,t){Qt.json(n+e,function(e){t(e)})}function d(e,t){Qt.json("https://www.stef.be/bassoontracker/api/"+e,function(e){e&&e.modarchive&&(e=e.modarchive),t(e)})}function c(e){var t=[];return e&&e.forEach(function(e){t.push({title:e.title||"---",url:"https://api.modarchive.org/downloads.php?moduleid="+e.id,icon:e.format,info:a(e.size)})}),t}function u(e,t){var n=[];if(e){if(e.module){var i=e.module;i.forEach?i.forEach(function(e){n.push({title:e.songtitle||"---",url:e.url,icon:"mod"})}):n.push({title:i.songtitle||"---",url:i.url,icon:"mod"})}if(e.totalpages){var r=parseInt(e.totalpages);if(1<r){var a=t[0]+"/",o=parseInt(t[1]||1);isNaN(o)&&(o=1),"artist/"!=a&&"genre/"!=a||(a+=t[1]+"/",o=parseInt(t[2]||1),isNaN(o)&&(o=1)),o<r&&n.push({title:"... load more ...",children:[],url:a+=o+1})}}}return n}var e={},n="http://localhost:3000/";n="https://www.stef.be/bassoontracker/api/ma/";var f=[],h=[];return e.get=function(e,t){var n,r,i=e.split("/"),a=i[1]||"",o=i[2]||"";switch(e=i[0]){case"genres":r=t,f.length?r&&r(f):l("genres",function(e){if(e){var i={};e.forEach(function(e){if(e.parent){var t={title:e.name,count:e.count,info:e.count+" >",children:[],url:"genre/"+e.id};i[e.parent]||(i[e.parent]=[]),i[e.parent].push(t)}}),e.forEach(function(e){if(!e.parent){var t={title:e.name,children:i[e.id]||[]},n=0;t.children.forEach(function(e){n+=e.count}),t.info=n+" >",f.push(t)}})}r&&r(f)});break;case"artists":n=t,h.length?n&&n(h):l("artists",function(e){e&&e.forEach(function(e){h.push({title:e.handle,children:[],info:e.count+" >",url:"artist/"+e.id})}),n&&n(h)});break;case"genre":l("genre/"+a,function(e){t(c(e))});break;case"toprating":d("toprating/"+(o=a||1),function(e){t(u(e,i))});break;case"topreview":d("topreview/"+(o=a||1),function(e){t(u(e,i))});break;case"artist":var s="artist/"+a;o&&(s+="/"+o),l(s,function(e){t(c(e))});break;default:t([])}},e}(),ri=(Qn="https://www.stef.be/bassoontracker/api/mpl/",$n="https://www.stef.be/bassoontracker/api/modules.pl/",ei=[],ti=[],(Jn={}).get=function(e,t){var n,i,r,a,o,s=e.split("/"),l=s[1]||"",d=s[2]||"";switch(e=s[0]){case"genres":o=t,ei.length?o&&o(ei):ai("genres",function(e){e&&e.forEach(function(e){ei.push({title:e.name,url:"genre/"+e.name,children:[],info:e.count+" >"})}),o&&o(ei)});break;case"genre":r=t,a="genre/"+l,(i=d)&&(a+="/"+(i=parseInt(i))),ai(a,function(e){r(oi(e))});break;case"toprating":ai("toprating/"+(d=l||1),function(e){t(oi(e,"rate"))});break;case"topscore":ai("topscore/"+(d=l||1),function(e){t(oi(e,"score"))});break;case"artists":n=t,ti.length?n&&n(ti):ai("artists",function(e){e&&e.forEach(function(e){ti.push({title:e.handle,info:e.count+" >",url:"artist/"+e.id,children:[]})}),n&&n(ti)});break;case"artist":var c="artist/"+l;d&&(c+="/"+d),ai(c,function(e){t(oi(e))});break;default:t([])}},Jn);function ai(e,t){Qt.json(Qn+e,function(e){t(e)})}function oi(e,i){var r=[];return e&&e.forEach(function(e){var t=a(e.size),n=e.title||"---";i&&(n=e[i]+": "+n),r.push({title:n,url:$n+e.id,info:t,icon:e.format})}),r}return{init:mn.init,load:mn.load,playSong:mn.playSong,stop:mn.stop,togglePlay:mn.togglePlay,isPlaying:mn.isPlaying,getTrackCount:mn.getTrackCount,getSong:mn.getSong,getStateAtTime:mn.getStateAtTime,setCurrentSongPosition:mn.setCurrentSongPosition,audio:Wt}}();