var Host=function(){var d={},a;d.useUrlParams=!0;d.useDropbox=!0;d.showInternalMenu=!0;d.useWebWorkers=!0;d.useInitialLoad=!0;d.init=function(){"object"===typeof HostBridge&&(a=HostBridge,a.init(),"boolean"===typeof a.useUrlParams&&(d.useUrlParams=a.useUrlParams),"boolean"===typeof a.useDropbox&&(d.useDropbox=a.useDropboxs),"boolean"===typeof a.showInternalMenu&&(d.showInternalMenu=a.showInternalMenu),"boolean"===typeof a.useWebWorkers&&(d.useWebWorkers=a.useWebWorkers))};d.getBaseUrl=function(){return a&&
a.getBaseUrl?a.getBaseUrl():"undefined"===typeof Settings?"":Settings.baseUrl||""};d.getRemoteUrl=function(){return a&&a.getRemoteUrl?a.getRemoteUrl():""};d.getVersionNumber=function(){return"undefined"!==typeof versionNumber?versionNumber:a&&a.getVersionNumber?a.getVersionNumber():"dev"};d.getBuildNumber=function(){return"undefined"!==typeof buildNumber?buildNumber:a&&a.getBuildNumber?a.getBuildNumber():(new Date).getTime()};d.signalReady=function(){a&&a.signalReady&&a.signalReady()};d.putFile=function(f,
h){};return d}();var AmiBase=function(){var d={isAmiBased:!1},a,f,h;d.init=function(e){if(window.self!==window.top&&window.parent){window.parent.postMessage({command:"register",url:window.location.href},"*");var b=setTimeout(function(){e&&e(!1)},500)}else e&&e(!1);window.addEventListener("message",function(c){c&&c.data&&(c.data.registered?(clearTimeout(b),a=c.data.id,d.isAmiBased=!0,e&&e(!0),f&&d.setMenu(f)):h&&h(c.data,c))},!1)};d.iAmReady=function(){d.isAmiBased&&window.parent.postMessage({command:"ready",windowId:a},
"*")};d.focus=function(){d.isAmiBased&&window.parent.postMessage({command:"focus",windowId:a},"*")};d.setMenu=function(e){f=e;d.isAmiBased&&window.parent.postMessage({command:"setMenu",windowId:a,data:f},"*")};d.setMessageHandler=function(e){h=e};return d}();var HostBridge=function(){return{useDropbox:!1,showInternalMenu:!1,init:function(){AmiBase.init(function(d){console.log("Amibased: "+d);d&&(AmiBase.setMessageHandler(function(a){console.error(a);var f=a.message;if(f)switch(0<=f.indexOf("bsn_")&&(f=f.replace("bsn_","")),f){case "setMessageHandler":break;case "loadFile":break;case "openfile":case "dropfile":Host.useInitialLoad=!1;f=a.data.data;a=a.data.filename||"file";console.log("opening file",a);Tracker.processFile(f,a,function(h){UI&&UI.setStatus("Ready")});
AmiBase.focus();break;case "getFileName":Tracker.getFileName();break;case "saveFile":break;default:(f=COMMAND[f])?App.doCommand(f):console.warn("Unhandled message: "+f)}}),AmiBase.setMenu([{label:"Bassoon Tracker",items:[{label:"About",message:"bsn_showAbout"}]},{label:"File",items:[{label:"New",message:"bsn_newFile"},{label:"Load Module",message:"loadmodule"},{label:"Save Module",message:"savemodule"},{label:"Open Random Mod",message:"bsn_randomSong"},{label:"Open Random XM",message:"bsn_randomSongXM"}]},
{label:"Edit",items:[{label:"Cut",message:"bsn_ut"},{label:"Copy",message:"bsn_copy"},{label:"Paste",message:"bsn_paste"},{label:"Clear",items:[{label:"Track",message:"bsn_clearTrack"},{label:"Pattern",message:"bsn_clearPattern"},{label:"Song",message:"bsn_clearSong"},{label:"Instruments",message:"bsn_clearInstruments"}]},{label:"Render Pattner 2 sample",message:"bsn_pattern2Sample"}]},{label:"View",items:[{label:"Main",message:"bsn_showMain"},{label:"Options",message:"bsn_showOptions"},{label:"File Operations",
message:"bsn_showFileOperations"},{label:"Sample Editor",message:"bsn_showSampleEditor"},{label:"Piano",message:"bsn_togglePiano"}]},{label:"Help",items:[{label:"About",message:"bsn_showAbout"},{label:"Documentation",message:"bsn_showHelp"},{label:"Sourcecode on Github",message:"bsn_showGithub"}]}]))})},signalReady:function(){AmiBase.iAmReady()},sendMessage:function(d){}}}();var cachedAssets={images:{},audio:{},json:{},arrayBuffer:{}},sprites={},UI=void 0,PRELOADTYPE={image:1,audio:2,json:3,binary:4},EVENT={instrumentChange:1,patternChange:2,patternPosChange:3,patternTableChange:4,recordingChange:5,cursorPositionChange:6,trackStateChange:7,playingChange:8,playTypeChange:9,songPositionChange:10,songSpeedChange:11,songBPMChange:12,samplePlay:13,screenRefresh:14,screenRender:15,songPropertyChange:16,instrumentNameChange:17,command:18,pianoNoteOn:19,pianoNoteOff:20,statusChange:21,
diskOperationTargetChange:22,diskOperationActionChange:23,trackCountChange:24,patternHorizontalScrollChange:25,songLoaded:26,songLoading:27,trackerModeChanged:28,instrumentListChange:29,showView:30,toggleView:31,visibleTracksCountChange:32,filterChainCountChange:33,fxPanelToggle:34,samplePropertyChange:35,sampleIndexChange:36,second:37,minute:38,dropboxConnect:39,dropboxConnectCancel:40,trackScopeClick:41,octaveChanged:42,skipFrameChanged:43,showContextMenu:44,hideContextMenu:45,clockEventExpired:46,
commandUndo:50,commandRedo:51,commandSelectAll:52,songEnd:53,patternEnd:54,songSpeedChangeIgnored:55,songBPMChangeIgnored:56,commandProcessSample:57,pluginRenderHook:58,menuLayoutChanged:59,midiIn:60},COMMAND={newFile:1,openFile:2,saveFile:3,clearTrack:4,clearPattern:5,clearSong:6,clearInstruments:7,showMain:8,showOptions:9,showFileOperations:10,showSampleEditor:11,showAbout:12,showHelp:13,togglePiano:14,showTopMain:15,showBottomMain:16,randomSong:17,randomSongXM:18,showGithub:19,showStats:20,cut:21,
copy:22,paste:23,pattern2Sample:24,toggleAppSideBar:25,undo:26,redo:27,nibbles:28,generator:29},PLAYTYPE={song:1,pattern:2},FILETYPE={module:1,sample:2,pattern:3,track:4},MODULETYPE={mod:1,xm:2},SAMPLETYPE={RAW_8BIT:1,WAVE_PCM:2,IFF_8SVX:3,MP3:4,RIFF_8BIT:5,RIFF_16BIT:6,FLAC:5,OGG:9,OPUS:10},STEREOSEPARATION={FULL:1,BALANCED:2,NONE:3},FREQUENCYTABLE={AMIGA:1,LINEAR:2},LOOPTYPE={NONE:0,FORWARD:1,PINGPONG:2},SELECTION={RESET:1,CLEAR:2,CUT:3,COPY:4,PASTE:5,POSITION:6,DELETE:7,REPLACE:8},EDITACTION={PATTERN:1,
TRACK:2,NOTE:3,RANGE:4,VALUE:5,DATA:6,SAMPLE:7},AMIGA_PALFREQUENCY=7093790,PC_FREQUENCY=7158728,AMIGA_PALFREQUENCY_HALF=AMIGA_PALFREQUENCY/2,PC_FREQUENCY_HALF=PC_FREQUENCY/2,LAYOUTS={column4:4,column5:5,column5Full:6,column6:7},NOTEPERIOD={C1:{period:856,name:"C-1",tune:[907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814]},Cs1:{period:808,name:"C#1",tune:[856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768]},D1:{period:762,name:"D-1",tune:[808,802,796,791,785,779,774,768,
762,757,752,746,741,736,730,725]},Ds1:{period:720,name:"D#1",tune:[762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684]},E1:{period:678,name:"E-1",tune:[720,715,709,704,699,694,689,684,678,674,670,665,660,655,651,646]},F1:{period:640,name:"F-1",tune:[678,675,670,665,660,655,651,646,640,637,632,628,623,619,614,610]},Fs1:{period:604,name:"F#1",tune:[640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575]},G1:{period:570,name:"G-1",tune:[604,601,597,592,588,584,580,575,570,567,563,
559,555,551,547,543]},Gs1:{period:538,name:"G#1",tune:[570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513]},A1:{period:508,name:"A-1",tune:[538,535,532,528,524,520,516,513,508,505,502,498,495,491,487,484]},As1:{period:480,name:"A#1",tune:[508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457]},B1:{period:453,name:"B-1",tune:[480,477,474,470,467,463,460,457,453,450,447,444,441,437,434,431]},C2:{period:428,name:"C-2",tune:[453,450,447,444,441,437,434,431,428,425,422,419,416,413,
410,407]},Cs2:{period:404,name:"C#2",tune:[428,425,422,419,416,413,410,407,404,401,398,395,392,390,387,384]},D2:{period:381,name:"D-2",tune:[404,401,398,395,392,390,387,384,381,379,376,373,370,368,365,363]},Ds2:{period:360,name:"D#2",tune:[381,379,376,373,370,368,365,363,360,357,355,352,350,347,345,342]},E2:{period:339,name:"E-2",tune:[360,357,355,352,350,347,345,342,339,337,335,332,330,328,325,323]},F2:{period:320,name:"F-2",tune:[339,337,335,332,330,328,325,323,320,318,316,314,312,309,307,305]},
Fs2:{period:302,name:"F#2",tune:[320,318,316,314,312,309,307,305,302,300,298,296,294,292,290,288]},G2:{period:285,name:"G-2",tune:[302,300,298,296,294,292,290,288,285,284,282,280,278,276,274,272]},Gs2:{period:269,name:"G#2",tune:[285,284,282,280,278,276,274,272,269,268,266,264,262,260,258,256]},A2:{period:254,name:"A-2",tune:[269,268,266,264,262,260,258,256,254,253,251,249,247,245,244,242]},As2:{period:240,name:"A#2",tune:[254,253,251,249,247,245,244,242,240,239,237,235,233,232,230,228]},B2:{period:226,
name:"B-2",tune:[240,238,237,235,233,232,230,228,226,225,224,222,220,219,217,216]},C3:{period:214,name:"C-3",tune:[226,225,223,222,220,219,217,216,214,213,211,209,208,206,205,204]},Cs3:{period:202,name:"C#3",tune:[214,212,211,209,208,206,205,203,202,201,199,198,196,195,193,192]},D3:{period:190,name:"D-3",tune:[202,200,199,198,196,195,193,192,190,189,188,187,185,184,183,181]},Ds3:{period:180,name:"D#3",tune:[190,189,188,187,185,184,183,181,180,179,177,176,175,174,172,171]},E3:{period:170,name:"E-3",
tune:[180,179,177,176,175,174,172,171,170,169,167,166,165,164,163,161]},F3:{period:160,name:"F-3",tune:[170,169,167,166,165,164,163,161,160,159,158,157,156,155,154,152]},Fs3:{period:151,name:"F#3",tune:[160,159,158,157,156,155,154,152,151,150,149,148,147,146,145,144]},G3:{period:143,name:"G-3",tune:[151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136]},Gs3:{period:135,name:"G#3",tune:[143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128]},A3:{period:127,name:"A-3",tune:[135,
134,133,132,131,130,129,128,127,126,125,125,124,123,122,121]},As3:{period:120,name:"A#3",tune:[127,126,125,125,123,123,122,121,120,119,118,118,117,116,115,114]},B3:{period:113,name:"B-3",tune:[120,119,118,118,117,116,115,114,113,113,112,111,110,109,109,108]}},FTNOTEPERIOD={None:{name:"---"},C0:{name:"C-0",period:6848},Cs0:{name:"C#0",period:6464},D0:{name:"D-0",period:6096},Ds0:{name:"D#0",period:5760},E0:{name:"E-0",period:5424},F0:{name:"F-0",period:5120},Fs0:{name:"F#0",period:4832},G0:{name:"G-0",
period:4560},Gs0:{name:"G#0",period:4304},A0:{name:"A-0",period:4064},As0:{name:"A#0",period:3840},B0:{name:"B-0",period:3624},C1:{name:"C-1",period:3424},Cs1:{name:"C#1",period:3232},D1:{name:"D-1",period:3048},Ds1:{name:"D#1",period:2880},E1:{name:"E-1",period:2712},F1:{name:"F-1",period:2560},Fs1:{name:"F#1",period:2416},G1:{name:"G-1",period:2280},Gs1:{name:"G#1",period:2152},A1:{name:"A-1",period:2032},As1:{name:"A#1",period:1920},B1:{name:"B-1",period:1812},C2:{name:"C-2",period:1712},Cs2:{name:"C#2",
period:1616},D2:{name:"D-2",period:1524},Ds2:{name:"D#2",period:1440},E2:{name:"E-2",period:1356},F2:{name:"F-2",period:1280},Fs2:{name:"F#2",period:1208},G2:{name:"G-2",period:1140},Gs2:{name:"G#2",period:1076},A2:{name:"A-2",period:1016},As2:{name:"A#2",period:960},B2:{name:"B-2",period:906},C3:{name:"C-3",period:856},Cs3:{name:"C#3",period:808},D3:{name:"D-3",period:762},Ds3:{name:"D#3",period:720},E3:{name:"E-3",period:678},F3:{name:"F-3",period:640},Fs3:{name:"F#3",period:604},G3:{name:"G-3",
period:570},Gs3:{name:"G#3",period:538},A3:{name:"A-3",period:508},As3:{name:"A#3",period:480},B3:{name:"B-3",period:453},C4:{name:"C-4",period:428},Cs4:{name:"C#4",period:404},D4:{name:"D-4",period:381},Ds4:{name:"D#4",period:360},E4:{name:"E-4",period:339},F4:{name:"F-4",period:320},Fs4:{name:"F#4",period:302},G4:{name:"G-4",period:285},Gs4:{name:"G#4",period:269},A4:{name:"A-4",period:254},As4:{name:"A#4",period:240},B4:{name:"B-4",period:226.5,modPeriod:226},C5:{name:"C-5",period:214},Cs5:{name:"C#5",
period:202},D5:{name:"D-5",period:190.5,modPeriod:190},Ds5:{name:"D#5",period:180},E5:{name:"E-5",period:169.5,modPeriod:170},F5:{name:"F-5",period:160},Fs5:{name:"F#5",period:151},G5:{name:"G-5",period:142.5,modPeriod:143},Gs5:{name:"G#5",period:134.5,modPeriod:135},A5:{name:"A-5",period:127},As5:{name:"A#5",period:120},B5:{name:"B-5",period:113.25,modPeriod:113},C6:{name:"C-6",period:107},Cs6:{name:"C#6",period:101},D6:{name:"D-6",period:95.25,modPeriod:95},Ds6:{name:"D#6",period:90},E6:{name:"E-6",
period:84.75,modPeriod:85},F6:{name:"F-6",period:80},Fs6:{name:"F#6",period:75.5,modPeriod:75},G6:{name:"G-6",period:71.25,modPeriod:71},Gs6:{name:"G#6",period:67.25,modPeriod:67},A6:{name:"A-6",period:63.5,modPeriod:63},As6:{name:"A#6",period:60},B6:{name:"B-6",period:56.625,modPeriod:56},C7:{name:"C-7",period:53.5,modPeriod:53},Cs7:{name:"C#7",period:50.5,modPeriod:50},D7:{name:"D-7",period:47.625,modPeriod:47},Ds7:{name:"D#7",period:45},E7:{name:"E-7",period:42.375,modPeriod:42},F7:{name:"F-7",
period:40},Fs7:{name:"F#7",period:37.75,modPeriod:37},G7:{name:"G-7",period:35.625,modPeriod:35},Gs7:{name:"G#7",period:33.625,modPeriod:33},A7:{name:"A-7",period:31.75,modPeriod:31},As7:{name:"A#7",period:30},B7:{name:"B-7",period:28.3125,modPeriod:28},C8:{name:"C-8",period:26.75},Cs8:{name:"C#8",period:25.25},D8:{name:"D-8",period:23.8125},Ds8:{name:"D#8",period:22.5},E8:{name:"E-8",period:21.1875},F8:{name:"F-8",period:20},Fs8:{name:"F#8",period:18.875},G8:{name:"G-8",period:17.8125},Gs8:{name:"G#8",
period:16.8125},A8:{name:"A-8",period:15.875},As8:{name:"A#8",period:15},B8:{name:"B-8",period:14.15625},C9:{name:"C-9",period:13.375},Cs9:{name:"C#9",period:12.625},D9:{name:"D-9",period:11.90625},Ds9:{name:"D#9",period:11.25},E9:{name:"E-9",period:10.59375},F9:{name:"F-9",period:10},Fs9:{name:"F#9",period:9.4375},G9:{name:"G-9",period:8.90625},Gs9:{name:"G#9",period:8.40625},A9:{name:"A-9",period:7.9375},As9:{name:"A#9",period:7.5},B9:{name:"B-9",period:7.078125},C10:{name:"C-10",period:6.6875},
Cs10:{name:"C#10",period:6.3125},D10:{name:"D-10",period:5.953125},Ds10:{name:"D#10",period:5.625},E10:{name:"E-10",period:5.296875},F10:{name:"F-10",period:5},Fs10:{name:"F#10",period:4.71875},G10:{name:"G-10",period:4.453125},Gs10:{name:"G#10",period:4.203125},A10:{name:"A-10",period:3.96875},As10:{name:"A#10",period:3.75},B10:{name:"B-10",period:3.5390625},C11:{name:"C-11",period:3.34375},Cs11:{name:"C#11",period:3.15625},D11:{name:"D-11",period:2.9765625},Ds11:{name:"D#11",period:2.8125},E11:{name:"E-11",
period:2.6484375},F11:{name:"F-11",period:2.5},Fs11:{name:"F#11",period:2.359375},G11:{name:"G-11",period:2.2265625},Gs11:{name:"G#11",period:2.1015625},A11:{name:"A-11",period:1.984375},As11:{name:"A#11",period:1.875},B11:{name:"B-11",period:1.76953125},OFF:{name:"OFF",period:0}},NOTEOFF=145,KEYBOARDKEYS={OFF:0,C:1,Csharp:2,D:3,Dsharp:4,E:5,F:6,Fsharp:7,G:8,Gsharp:9,A:10,Asharp:11,B:12,COctaveUp:13,CsharpOctaveUp:14,DOctaveUp:15,DsharpOctaveUp:16,EOctaveUp:17,FOctaveUp:18,FsharpOctaveUp:19,GOctaveUp:20,
GsharpOctaveUp:21,AOctaveUp:22,AsharpOctaveUp:23,BOctaveUp:24,COctaveUp2:25,CsharpOctaveUp2:26,DOctaveUp2:27},OCTAVENOTES={0:{name:"OFF"},1:{name:"C"},2:{name:"Cs"},3:{name:"D"},4:{name:"Ds"},5:{name:"E"},6:{name:"F"},7:{name:"Fs"},8:{name:"G"},9:{name:"Gs"},10:{name:"A"},11:{name:"As"},12:{name:"B"}},KEYBOARDTABLE={azerty:{a:KEYBOARDKEYS.COctaveUp,z:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,y:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,
i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,"\u00e9":KEYBOARDKEYS.CsharpOctaveUp,'"':KEYBOARDKEYS.DsharpOctaveUp,"(":KEYBOARDKEYS.FsharpOctaveUp,"\u00a7":KEYBOARDKEYS.GsharpOctaveUp,"\u00e8":KEYBOARDKEYS.AsharpOctaveUp,"\u00e7":KEYBOARDKEYS.CsharpOctaveUp2,w:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,",":KEYBOARDKEYS.B,";":KEYBOARDKEYS.COctaveUp,":":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,
h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"<":KEYBOARDKEYS.OFF},dvorak:{"'":KEYBOARDKEYS.COctaveUp,",":KEYBOARDKEYS.DOctaveUp,".":KEYBOARDKEYS.EOctaveUp,p:KEYBOARDKEYS.FOctaveUp,y:KEYBOARDKEYS.GOctaveUp,f:KEYBOARDKEYS.AOctaveUp,g:KEYBOARDKEYS.BOctaveUp,c:KEYBOARDKEYS.COctaveUp2,r:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,";":KEYBOARDKEYS.C,
q:KEYBOARDKEYS.D,j:KEYBOARDKEYS.E,k:KEYBOARDKEYS.F,x:KEYBOARDKEYS.G,b:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,w:KEYBOARDKEYS.COctaveUp,v:KEYBOARDKEYS.DOctaveUp,o:KEYBOARDKEYS.Csharp,e:KEYBOARDKEYS.Dsharp,i:KEYBOARDKEYS.Fsharp,d:KEYBOARDKEYS.Gsharp,h:KEYBOARDKEYS.Asharp,n:KEYBOARDKEYS.CsharpOctaveUp,"\\":KEYBOARDKEYS.OFF},qwerty:{q:KEYBOARDKEYS.COctaveUp,w:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,y:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,
o:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,z:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,",":KEYBOARDKEYS.COctaveUp,".":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"\\":KEYBOARDKEYS.OFF},
qwertz:{q:KEYBOARDKEYS.COctaveUp,w:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,z:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,y:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,
n:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,",":KEYBOARDKEYS.COctaveUp,".":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"\\":KEYBOARDKEYS.OFF}},TRACKERMODE={PROTRACKER:1,FASTTRACKER:2},SETTINGS={unrollLoops:!1,unrollShortLoops:!1,sustainKeyboardNotes:!1,useHover:!0,keyboardTable:"qwerty",vubars:!0,stereoSeparation:STEREOSEPARATION.BALANCED,emulateProtracker1OffsetBug:!0,loadInitialFile:!0};var EventBus=function(){var d={};return{on:function(a,f){var h=d[a];h||(h=[],d[a]=h);h.push(f);return h.length},off:function(a,f){(a=d[a])&&(a[f-1]=void 0)},trigger:function(a,f){var h=d[a];if(h){var e,b=h.length;for(e=0;e<b;e++)if(h[e])h[e](f,a)}}}}();function loadFile(d,a){var f=new XMLHttpRequest;f.open("GET",d,!0);f.responseType="arraybuffer";f.onload=function(h){(h=f.response)&&200===f.status?a&&a(h):(console.error("unable to load",d),"undefined"!==typeof Editor&&a&&a(!1))};f.send(null)}function saveFile(d,a){var f=document.createElement("a");document.body.appendChild(f);f.style="display: none";url=window.URL.createObjectURL(d);f.href=url;f.download=a;f.click();window.URL.revokeObjectURL(url)}
function BinaryStream(d,a){function f(e){e=0===e?e:e||h.index;0>e&&(e=0);e>=h.length&&(e=h.length-1);h.index=e}var h={index:0,litteEndian:!a,goto:function(e){f(e)},jump:function(e){this.goto(this.index+e)},readByte:function(e){f(e);e=this.dataView.getInt8(this.index);this.index++;return e},writeByte:function(e,b){f(b);this.dataView.setInt8(this.index,e);this.index++},readUbyte:function(e){f(e);e=this.dataView.getUint8(this.index);this.index++;return e},writeUByte:function(e,b){f(b);this.dataView.setUint8(this.index,
e);this.index++},readUint:function(e){f(e);e=this.dataView.getUint32(this.index,this.litteEndian);this.index+=4;return e},writeUint:function(e,b){f(b);this.dataView.setUint32(this.index,e,this.litteEndian);this.index+=4},readBytes:function(e,b){f(b);b=new Uint8Array(e);var c=this.index;(e+=c)>this.length&&(e=this.length);for(var m=0;c<e;++c)b.setUint8(m++,this.dataView.getUint8(c));this.index=e;return b},readString:function(e,b){f(b);b=this.index;var c=this.dataView,m="";(e+=b)>this.length&&(e=this.length);
for(;b<e;++b){var g=c.getUint8(b);if(0==g)break;m+=String.fromCharCode(g)}this.index=e;return m},writeString:function(e,b){f(b);b=this.dataView;for(var c=e.length,m=0;m<c;m++)b.setUint8(this.index+m,e.charCodeAt(m));this.index+=c},writeStringSection:function(e,b,c,m){f(m);b=b||1;e=e||"";c=c||0;m=e.length;m>b&&(e=e.substr(0,b));h.writeString(e);h.fill(c,b-m)},readWord:function(e){f(e);e=this.dataView.getUint16(this.index,this.litteEndian);this.index+=2;return e},writeWord:function(e,b){f(b);this.dataView.setUint16(this.index,
e,this.litteEndian);this.index+=2}};h.readLong=h.readDWord=h.readUint;h.writeLong=h.writeDWord=h.writeUint;h.readShort=function(e,b){f(b);e=this.dataView.getInt16(this.index,this.litteEndian);this.index+=2;return e};h.clear=function(e){h.fill(0,e)};h.fill=function(e,b){e=e||0;b=b||0;for(var c=0;c<b;c++)h.writeByte(e)};h.isEOF=function(e){return this.index>=this.length-(e||0)};d&&(h.buffer=d,h.dataView=new DataView(d),h.length=d.byteLength);return h};var Audio=function(){function d(u,w){e=u.createGain();e.gain.setValueAtTime(1,0);e.connect(w||u.destination);h=u.createGain();h.connect(e);a.setMasterVolume(1);b=u.createBiquadFilter();b.type="lowpass";b.frequency.setValueAtTime(2E4,0);b.connect(h);a.masterVolume=h;a.cutOffVolume=e;a.lowPassfilter=b}var a={};window.AudioContext=window.AudioContext||window.webkitAudioContext;window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var f,h,e,b,c,m=[],g,k,l=[],n,r,t=STEREOSEPARATION.BALANCED,
p=0,z,y,B=[[],[],[]],A=0,E=4143.569,U={volume:!0,panning:!0,high:!0,mid:!0,low:!0,lowPass:!0,reverb:!0,distortion:!1,delay:!1},Q=!1;AudioContext&&(f=new AudioContext);a.init=function(u,w){function D(){var N=FilterChain(U);N.output().connect(b);m.push(N)}f=u=u||f;a.context=f;if(u){(z=!!Audio.context.createStereoPanner)||console.warn("Warning: Your browser does not support StereoPanners ... all mods will be played in mono!");y="undefined"!==typeof Editor;d(u,w);u=Tracker.getTrackCount();m=[];for(c=
0;c<u;c++)D();a.filterChains=m;a.usePanning=z;Q||(EventBus.on(EVENT.trackStateChange,function(N){"undefined"!=typeof N.track&&m[N.track]&&m[N.track].volumeValue(N.mute?0:70)}),EventBus.on(EVENT.trackCountChange,function(N){for(c=m.length;c<N;c++)D();EventBus.trigger(EVENT.filterChainCountChange,N);a.setStereoSeparation(t)}),EventBus.on(EVENT.trackerModeChanged,function(N){a.setStereoSeparation()}))}};a.enable=function(){e.gain.setValueAtTime(1,0);a.cutOff=!1};a.disable=function(){e.gain.setValueAtTime(0,
0);a.cutOff=!0;var u=0;B.forEach(function(w,D){u+=w.length;w.forEach(function(N){N.gain.cancelScheduledValues(0);N.gain.setValueAtTime(0,0)});B[D]=[]});u&&console.log(u+" cleared")};a.checkState=function(){f&&"suspended"===f.state&&f.resume&&(console.warn("Audio context is suspended - trying to resume"),f.resume())};a.playSample=function(u,w,D,N,R,S,W){if(Q)var G=n;else G=f,a.enable();w=w||428;"undefined"===typeof N&&(N=y?Editor.getCurrentTrack():0);S=S||f.currentTime;W===NOTEOFF&&(D=0);var F=Tracker.getInstrument(u),
J=w;if(F){var V=0,O=0;D="undefined"===typeof D?100*F.sample.volume/64:D;var I=(F.sample.panning||0)/128;Tracker.inFTMode()?Tracker.useLinearFrequency?w-=F.getFineTune()/2:F.getFineTune()&&(w=a.getFineTuneForNote(W,F.getFineTune())):F.getFineTune()&&(w=a.getFineTuneForPeriod(w,F.getFineTune()));var q=a.getSampleRateForPeriod(w);var v=1;if(F.sample.data.length){O=F.sample.data.length;R&&R.offset&&(R.offset.value>=O&&(R.offset.value=O-1),V=R.offset.value/G.sampleRate);var K=G.createBuffer(1,O,G.sampleRate);
v=q/G.sampleRate}else K=G.createBuffer(1,1,G.sampleRate),V=0;var X=K.getChannelData(0);for(c=0;c<O;c++)X[c]=F.sample.data[c];E=q;O=G.createBufferSource();O.buffer=K;K=G.createGain();K.gain.value=D/100;K.gain.setValueAtTime(D/100,S);F.sample.loop.enabled&&2<F.sample.loop.length&&!SETTINGS.unrollLoops&&(O.loop=!0,O.loopStart=F.sample.loop.start/G.sampleRate,O.loopEnd=(F.sample.loop.start+F.sample.loop.length)/G.sampleRate);if(F.volumeEnvelope.enabled||F.panningEnvelope.enabled||F.hasVibrato()){var C=
F.noteOn(S);G=O;if(C.volume){var L=C.volume;O.connect(L);G=L}if(C.panning){var x=C.panning;G.connect(x);G=x}C=C.scheduled;G.connect(K)}else O.connect(K);G=Audio.context.createGain();G.gain.setValueAtTime(0,S);G.gain.linearRampToValueAtTime(1,S+.01);K.connect(G);if(z){var H=Audio.context.createStereoPanner();H.pan.setValueAtTime(I,S);G.connect(H);H.connect(m[N].input())}else G.connect(m[N].input());O.playbackRate.value=v;O.start(S+0,V);u={source:O,volume:K,panning:H,volumeEnvelope:L,panningEnvelope:x,
volumeFadeOut:G,startVolume:D,currentVolume:D,startPeriod:w,basePeriod:J,noteIndex:W,startPlaybackRate:v,sampleRate:q,instrumentIndex:u,effects:R,track:N,time:S,scheduled:C};B[A].push(K);Q||EventBus.trigger(EVENT.samplePlay,u);return u}return{}};a.playSilence=function(){if(f){var u=f.createBufferSource();u.connect(h);try{u.start()}catch(w){console.error(w)}}};a.playRaw=function(u,w){if(f&&u&&u.length){u=f.createBuffer(1,u.length,f.sampleRate);w/=audioContext.sampleRate;var D=f.createBufferSource();
D.buffer=u;D.loop=!0;D.playbackRate.value=w;D.connect(h);D.start()}};a.isRecording=function(){return g};a.startRecording=function(){if(!g)if(f&&f.createMediaStreamDestination){var u=f.createMediaStreamDestination();k=new MediaRecorder(u.stream);k.ondataavailable=function(w){l.push(w.data)};k.onstop=function(w){w=new Blob(l,{type:"audio/ogg; codecs=opus"});saveAs(w,"recording.opus")};h.connect(u);k.start();g=!0}else console.error("recording is not supported on this browser")};a.stopRecording=function(){g&&
(g=!1,k.stop())};a.startRendering=function(u){Q=!0;console.log("startRendering "+u);n=new OfflineAudioContext(2,44100*u,44100);r=f;a.context=n;a.init(n)};a.stopRendering=function(u){Q=!1;n.startRendering().then(function(w){console.log("Rendering completed successfully");u&&u(w)}).catch(function(w){console.log("Rendering failed: "+w)});a.context=r;d(r);a.init(r)};a.setStereoSeparation=function(u){var w=Tracker.getTrackCount();if(Tracker.inFTMode())u=0;else switch(t=u=u||t,u){case STEREOSEPARATION.NONE:u=
0;SETTINGS.stereoSeparation=STEREOSEPARATION.NONE;break;case STEREOSEPARATION.FULL:u=1;SETTINGS.stereoSeparation=STEREOSEPARATION.FULL;break;default:u=.5,SETTINGS.stereoSeparation=STEREOSEPARATION.BALANCED}for(c=0;c<w;c++){var D=m[c];D&&D.panningValue(0===c%4||3===c%4?-u:u)}};a.getPrevSampleRate=function(){return E};a.context=f;a.getSemiToneFrom=function(u,w,D){var N=u;D&&(u=a.getFineTuneBasePeriod(u,D),u||(u=N,console.error("ERROR: base period for finetuned "+D+" period "+u+" not found")));if(w){var R=
periodNoteTable[u];if(R){if(u=noteNames.indexOf(R.name),w=noteNames[u+w])if(w=nameNoteTable[w])N=w.period,D&&(N=a.getFineTuneForPeriod(N,D))}else console.error("ERROR: note for period "+u+" not found")}return N};a.getNearestSemiTone=function(u,w){var D=u,N=1E5,R=Tracker.getInstrument(w),S;if(Tracker.inFTMode()){var W=0;FTNotes.forEach(function(V,O){if(F=V.period)J=Math.abs(F-u),J<N&&(N=J,D=F,W=O)});W&&R&&R.getFineTune()&&(D=Tracker.useLinearFrequency?D-R.getFineTune()/2:a.getFineTuneForNote(W,R.getFineTune()))}else{var G=
8;w&&R&&R.sample.finetune&&(G+=R.sample.finetune);for(S in NOTEPERIOD)if(NOTEPERIOD.hasOwnProperty(S)){var F=NOTEPERIOD[S].tune[G];var J=Math.abs(F-u);J<N&&(N=J,D=F)}}return D};a.getFineTuneForPeriod=function(u,w){var D=u;(u=periodNoteTable[u])&&u.tune&&(w=8+w,0<=w&&w<u.tune.length&&(D=u.tune[w]));return D};a.getFineTuneForNote=function(u,w){if(u===NOTEOFF)return 1;var D=FTNotes[u],N=0<w?FTNotes[u+1]:FTNotes[u-1];if(D&&N)return D.period-Math.abs(N.period-D.period)/127*w;console.warn("unable to find finetune for note "+
u,D);return D?D.period:1E5};a.getFineTuneBasePeriod=function(u,w){var D=u;(w=periodFinetuneTable[w])&&(D=w[u]);return D};a.getSampleRateForPeriod=function(u){return Tracker.inFTMode()?Tracker.useLinearFrequency?8363*Math.pow(2,(4608-u)/768):PC_FREQUENCY_HALF/u:AMIGA_PALFREQUENCY_HALF/u};a.limitAmigaPeriod=function(u){u=Math.max(u,113);return u=Math.min(u,856)};a.setAmigaLowPassFilter=function(u,w){b.frequency.setValueAtTime(u?2E3:2E4,w)};a.setMasterVolume=function(u,w){w=w||f.currentTime;u*=.7;h.gain.setValueAtTime(p,
w);h.gain.linearRampToValueAtTime(u,w+.02);p=u};a.slideMasterVolume=function(u,w){w=w||f.currentTime;u*=.7;h.gain.linearRampToValueAtTime(u,w);p=u};a.getLastMasterVolume=function(){return p/.7};a.clearScheduledNotesCache=function(){A++;2<A&&(A=0);B[A]=[]};a.waveFormFunction={sine:function(u,w,D,N){return u+Math.sin(w*D*.8)*N*1.7},saw:function(u,w,D,N){return u+(2*(1-Math.abs(w*D/7%1))-1)*N*-2},square:function(u,w,D,N){return u+(0>=Math.sin(w*D)?-1:1)*N*2},sawInverse:function(u,w,D,N){return u+(2*
Math.abs(w*D/7%1)-1)*N*-2}};return a}();var Note=function(){var d={period:0,index:0,effect:0,instrument:0,param:0,volumeEffect:0,setPeriod:function(a){d.period=a;d.index=FTPeriods[a]||0},setIndex:function(a){d.index=a;var f=FTNotes[a];f?(d.period=f.modPeriod||f.period,1===d.period&&(d.period=0)):(console.warn("No note for index "+a),d.period=0)},clear:function(){d.instrument=0;d.period=0;d.effect=0;d.param=0;d.index=0;d.volumeEffect=0},duplicate:function(){return{instrument:d.instrument,period:d.period,effect:d.effect,param:d.param,volumeEffect:d.volumeEffect,
note:d.index}},populate:function(a){d.instrument=a.instrument||0;d.period=a.period||0;d.effect=a.effect||0;d.param=a.param||0;d.volumeEffect=a.volumeEffect||0;d.index=a.note||a.index||0}};return d};var Instrument=function(){function d(f,h,e){var b=Tracker.getProperties().tickTime,c=f.sustain?f.sustainPoint+1:f.count;f.loopStartPoint=Math.min(f.loopStartPoint,f.count-1);f.loopEndPoint=Math.min(f.loopEndPoint,f.count-1);var m=f.loop&&f.loopStartPoint<f.loopEndPoint;f.sustain&&f.sustainPoint<=f.loopStartPoint&&(m=!1);m&&(c=f.loopEndPoint+1);var g=0;if(h.gain)var k=h.gain,l=0,n=64;else k=h.pan,n=l=32;k.setValueAtTime((f.points[0][1]-l)/n,e);for(var r=1;r<c;r++){var t=f.points[r];g=t[0];g*=b;k.linearRampToValueAtTime((t[1]-
l)/n,e+g)}return m?a.scheduleEnvelopeLoop(h,e,2,g):!1}var a={type:"sample",name:"",instrumentIndex:0,sampleIndex:-1,fadeout:128,data:[]};a.samples=[Sample()];a.sample=a.samples[0];a.volumeEnvelope={raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6};a.panningEnvelope={raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5};a.vibrato={};a.sampleNumberForNotes=[];a.play=function(f,h,e,b,c,m){Tracker.inFTMode()&&(h=a.getPeriodForNote(f));return Audio.playSample(a.instrumentIndex,
h,e,b,c,m,f)};a.noteOn=function(f){var h={};if(a.volumeEnvelope.enabled){var e=Audio.context.createGain();var b=a.volumeEnvelope;if(b=d(b,e,f))h.volume=f+b}if(a.panningEnvelope.enabled&&Audio.usePanning){var c=Audio.context.createStereoPanner();b=a.panningEnvelope;if(b=d(b,c,f))h.panning=f+b}a.vibrato.rate&&a.vibrato.depth&&(h.ticks=0,h.vibrato=f,h.vibratoFunction=a.getAutoVibratoFunction());return{volume:e,panning:c,scheduled:h}};a.noteOff=function(f,h){function e(){h.volume.gain.cancelScheduledValues(f);
h.volumeFadeOut.gain.cancelScheduledValues(f);h.volumeEnvelope&&h.volumeEnvelope.gain.cancelScheduledValues(f);h.panningEnvelope&&h.panningEnvelope.pan.cancelScheduledValues(f);h.scheduled=void 0}if(h&&h.volume){if(Tracker.inFTMode()){var b=Tracker.getProperties().tickTime;if(a.volumeEnvelope.enabled){if(a.volumeEnvelope.sustain&&h.volumeEnvelope){e();var c=0,m=a.volumeEnvelope.points[a.volumeEnvelope.sustainPoint];m&&(c=m[0]*b);for(m=a.volumeEnvelope.sustainPoint;m<a.volumeEnvelope.count;m++){var g=
a.volumeEnvelope.points[m];g&&h.volumeEnvelope.gain.linearRampToValueAtTime(g[1]/64,f+g[0]*b-c)}}a.fadeout&&h.volumeFadeOut.gain.linearRampToValueAtTime(0,f+65536/a.fadeout*b/2)}else e(),h.volumeFadeOut.gain.linearRampToValueAtTime(0,f+.1);if(a.panningEnvelope.enabled&&Audio.usePanning&&h.panningEnvelope)for(c=0,(m=a.panningEnvelope.points[a.panningEnvelope.sustainPoint])&&(c=m[0]*b),m=a.panningEnvelope.sustainPoint;m<a.panningEnvelope.count;m++)(g=a.panningEnvelope.points[m])&&h.panningEnvelope.pan.linearRampToValueAtTime((g[1]-
32)/32,f+g[0]*b-c);return 100}e();if(h.isKey&&h.volume)h.volume.gain.linearRampToValueAtTime(0,f+.5);else return 0}};a.scheduleEnvelopeLoop=function(f,h,e,b){b=b||0;var c=Tracker.getProperties().tickTime;if(f.gain){var m=a.volumeEnvelope;f=f.gain;var g=0,k=64}else m=a.panningEnvelope,f=f.pan,k=g=32;var l=m.points[m.loopStartPoint],n=l[0];if(m.loop&&m.loopStartPoint<m.loopEndPoint)for(;b<e;)for(var r=b,t=m.loopStartPoint;t<=m.loopEndPoint;t++)l=m.points[t],b=r+(l[0]-n)*c,f.linearRampToValueAtTime((l[1]-
g)/k,h+b);return b};a.scheduleAutoVibrato=function(f,h){var e=0;f.scheduled.ticks=f.scheduled.ticks||0;var b=Tracker.getProperties().tickTime,c=-a.vibrato.rate/40,m=a.vibrato.depth/8;Tracker.useLinearFrequency&&(m*=4);if(f.source){var g=f.startPeriod;var k=f.scheduled.vibratoFunction||Audio.waveFormFunction.sine;var l=f.scheduled.vibrato||Audio.context.currentTime;var n=0}for(;e<h;){e+=b;if(g){var r=1;a.vibrato.sweep&&f.scheduled.ticks<a.vibrato.sweep&&(r=1-(a.vibrato.sweep-f.scheduled.ticks)/a.vibrato.sweep);
r=k(g,f.scheduled.ticks,c,m*r);Tracker.setPeriodAtTime(f,r,l+n*b);n++}f.scheduled.ticks++}return e};a.getAutoVibratoFunction=function(){switch(a.vibrato.type){case 1:return Audio.waveFormFunction.square;case 2:return Audio.waveFormFunction.saw;case 3:return Audio.waveFormFunction.sawInverse}return Audio.waveFormFunction.sine};a.resetVolume=function(f,h){h.volumeFadeOut&&(h.volumeFadeOut.gain.cancelScheduledValues(f),h.volumeFadeOut.gain.setValueAtTime(1,f));if(h.volumeEnvelope){h.volumeEnvelope.gain.cancelScheduledValues(f);
var e=Tracker.getProperties().tickTime,b=a.volumeEnvelope.sustain?a.volumeEnvelope.sustainPoint+1:a.volumeEnvelope.count;h.volumeEnvelope.gain.setValueAtTime(a.volumeEnvelope.points[0][1]/64,f);for(var c=1;c<b;c++){var m=a.volumeEnvelope.points[c];h.volumeEnvelope.gain.linearRampToValueAtTime(m[1]/64,f+m[0]*e)}}};a.getFineTune=function(){return Tracker.inFTMode()?a.sample.finetuneX:a.sample.finetune};a.setFineTune=function(f){Tracker.inFTMode()?(a.sample.finetuneX=f,a.sample.finetune=f>>4):(7<f&&
(f-=16),a.sample.finetune=f,a.sample.finetuneX=f<<4)};a.getPeriodForNote=function(f,h){if(Tracker.useLinearFrequency){var e=7680-64*(f-1);h&&(e-=a.getFineTune()/2)}else e=FTNotes[f].period,h&&a.getFineTune()&&(e=Audio.getFineTuneForNote(f,a.getFineTune()));return e};a.setSampleForNoteIndex=function(f){f=a.sampleNumberForNotes[f-1];f!==a.sampleIndex&&"number"===typeof f&&a.setSampleIndex(f)};a.setSampleIndex=function(f){a.sampleIndex!==f&&(a.sample=a.samples[f],a.sampleIndex=f,EventBus.trigger(EVENT.sampleIndexChange,
a.instrumentIndex))};a.hasSamples=function(){for(var f=0,h=a.samples.length;f<h;f++)if(a.samples[f].length)return!0};a.hasVibrato=function(){return a.vibrato.rate&&a.vibrato.depth};return a};var Sample=function(){var d={data:[],length:0,name:"",bits:8,volume:64,finetune:0,finetuneX:0,panning:0,relativeNote:0,loop:{enabled:!1,start:0,length:0,type:0},check:function(){for(var a=0,f=0,h=0,e=d.data.length;h<e;h++)a=Math.min(a,d.data[h]),f=Math.max(f,d.data[h]);return{min:a,max:f}}};return d};function getUrlParameter(d){if(window.location.getParameter)return window.location.getParameter(d);if(location.search)for(var a=location.search.substring(1).split("&"),f=0;f<a.length;f++){var h=a[f].split("=");if(h[0]&&h[0]==d)return h[1]||!0}}function formatFileSize(d){var a="k";isNaN(d)&&(d=0);d=Math.round(d/1E3);1E3<d&&(d=Math.round(d/100)/10,a="MB");return d+a}
function createSlug(d){var a={"\u00c1":"A","\u0102":"A","\u1eae":"A","\u1eb6":"A","\u1eb0":"A","\u1eb2":"A","\u1eb4":"A","\u01cd":"A","\u00c2":"A","\u1ea4":"A","\u1eac":"A","\u1ea6":"A","\u1ea8":"A","\u1eaa":"A","\u00c4":"A","\u01de":"A","\u0226":"A","\u01e0":"A","\u1ea0":"A","\u0200":"A","\u00c0":"A","\u1ea2":"A","\u0202":"A","\u0100":"A","\u0104":"A","\u00c5":"A","\u01fa":"A","\u1e00":"A","\u023a":"A","\u00c3":"A","\ua732":"AA","\u00c6":"AE","\u01fc":"AE","\u01e2":"AE","\ua734":"AO","\ua736":"AU",
"\ua738":"AV","\ua73a":"AV","\ua73c":"AY","\u1e02":"B","\u1e04":"B","\u0181":"B","\u1e06":"B","\u0243":"B","\u0182":"B","\u0106":"C","\u010c":"C","\u00c7":"C","\u1e08":"C","\u0108":"C","\u010a":"C","\u0187":"C","\u023b":"C","\u010e":"D","\u1e10":"D","\u1e12":"D","\u1e0a":"D","\u1e0c":"D","\u018a":"D","\u1e0e":"D","\u01f2":"D","\u01c5":"D","\u0110":"D","\u018b":"D","\u01f1":"DZ","\u01c4":"DZ","\u00c9":"E","\u0114":"E","\u011a":"E","\u0228":"E","\u1e1c":"E","\u00ca":"E","\u1ebe":"E","\u1ec6":"E","\u1ec0":"E",
"\u1ec2":"E","\u1ec4":"E","\u1e18":"E","\u00cb":"E","\u0116":"E","\u1eb8":"E","\u0204":"E","\u00c8":"E","\u1eba":"E","\u0206":"E","\u0112":"E","\u1e16":"E","\u1e14":"E","\u0118":"E","\u0246":"E","\u1ebc":"E","\u1e1a":"E","\ua76a":"ET","\u1e1e":"F","\u0191":"F","\u01f4":"G","\u011e":"G","\u01e6":"G","\u0122":"G","\u011c":"G","\u0120":"G","\u0193":"G","\u1e20":"G","\u01e4":"G","\u1e2a":"H","\u021e":"H","\u1e28":"H","\u0124":"H","\u2c67":"H","\u1e26":"H","\u1e22":"H","\u1e24":"H","\u0126":"H","\u00cd":"I",
"\u012c":"I","\u01cf":"I","\u00ce":"I","\u00cf":"I","\u1e2e":"I","\u0130":"I","\u1eca":"I","\u0208":"I","\u00cc":"I","\u1ec8":"I","\u020a":"I","\u012a":"I","\u012e":"I","\u0197":"I","\u0128":"I","\u1e2c":"I","\ua779":"D","\ua77b":"F","\ua77d":"G","\ua782":"R","\ua784":"S","\ua786":"T","\ua76c":"IS","\u0134":"J","\u0248":"J","\u1e30":"K","\u01e8":"K","\u0136":"K","\u2c69":"K","\ua742":"K","\u1e32":"K","\u0198":"K","\u1e34":"K","\ua740":"K","\ua744":"K","\u0139":"L","\u023d":"L","\u013d":"L","\u013b":"L",
"\u1e3c":"L","\u1e36":"L","\u1e38":"L","\u2c60":"L","\ua748":"L","\u1e3a":"L","\u013f":"L","\u2c62":"L","\u01c8":"L","\u0141":"L","\u01c7":"LJ","\u1e3e":"M","\u1e40":"M","\u1e42":"M","\u2c6e":"M","\u0143":"N","\u0147":"N","\u0145":"N","\u1e4a":"N","\u1e44":"N","\u1e46":"N","\u01f8":"N","\u019d":"N","\u1e48":"N","\u0220":"N","\u01cb":"N","\u00d1":"N","\u01ca":"NJ","\u00d3":"O","\u014e":"O","\u01d1":"O","\u00d4":"O","\u1ed0":"O","\u1ed8":"O","\u1ed2":"O","\u1ed4":"O","\u1ed6":"O","\u00d6":"O","\u022a":"O",
"\u022e":"O","\u0230":"O","\u1ecc":"O","\u0150":"O","\u020c":"O","\u00d2":"O","\u1ece":"O","\u01a0":"O","\u1eda":"O","\u1ee2":"O","\u1edc":"O","\u1ede":"O","\u1ee0":"O","\u020e":"O","\ua74a":"O","\ua74c":"O","\u014c":"O","\u1e52":"O","\u1e50":"O","\u019f":"O","\u01ea":"O","\u01ec":"O","\u00d8":"O","\u01fe":"O","\u00d5":"O","\u1e4c":"O","\u1e4e":"O","\u022c":"O","\u01a2":"OI","\ua74e":"OO","\u0190":"E","\u0186":"O","\u0222":"OU","\u1e54":"P","\u1e56":"P","\ua752":"P","\u01a4":"P","\ua754":"P","\u2c63":"P",
"\ua750":"P","\ua758":"Q","\ua756":"Q","\u0154":"R","\u0158":"R","\u0156":"R","\u1e58":"R","\u1e5a":"R","\u1e5c":"R","\u0210":"R","\u0212":"R","\u1e5e":"R","\u024c":"R","\u2c64":"R","\ua73e":"C","\u018e":"E","\u015a":"S","\u1e64":"S","\u0160":"S","\u1e66":"S","\u015e":"S","\u015c":"S","\u0218":"S","\u1e60":"S","\u1e62":"S","\u1e68":"S","\u0164":"T","\u0162":"T","\u1e70":"T","\u021a":"T","\u023e":"T","\u1e6a":"T","\u1e6c":"T","\u01ac":"T","\u1e6e":"T","\u01ae":"T","\u0166":"T","\u2c6f":"A","\ua780":"L",
"\u019c":"M","\u0245":"V","\ua728":"TZ","\u00da":"U","\u016c":"U","\u01d3":"U","\u00db":"U","\u1e76":"U","\u00dc":"U","\u01d7":"U","\u01d9":"U","\u01db":"U","\u01d5":"U","\u1e72":"U","\u1ee4":"U","\u0170":"U","\u0214":"U","\u00d9":"U","\u1ee6":"U","\u01af":"U","\u1ee8":"U","\u1ef0":"U","\u1eea":"U","\u1eec":"U","\u1eee":"U","\u0216":"U","\u016a":"U","\u1e7a":"U","\u0172":"U","\u016e":"U","\u0168":"U","\u1e78":"U","\u1e74":"U","\ua75e":"V","\u1e7e":"V","\u01b2":"V","\u1e7c":"V","\ua760":"VY","\u1e82":"W",
"\u0174":"W","\u1e84":"W","\u1e86":"W","\u1e88":"W","\u1e80":"W","\u2c72":"W","\u1e8c":"X","\u1e8a":"X","\u00dd":"Y","\u0176":"Y","\u0178":"Y","\u1e8e":"Y","\u1ef4":"Y","\u1ef2":"Y","\u01b3":"Y","\u1ef6":"Y","\u1efe":"Y","\u0232":"Y","\u024e":"Y","\u1ef8":"Y","\u0179":"Z","\u017d":"Z","\u1e90":"Z","\u2c6b":"Z","\u017b":"Z","\u1e92":"Z","\u0224":"Z","\u1e94":"Z","\u01b5":"Z","\u0132":"IJ","\u0152":"OE","\u1d00":"A","\u1d01":"AE","\u0299":"B","\u1d03":"B","\u1d04":"C","\u1d05":"D","\u1d07":"E","\ua730":"F",
"\u0262":"G","\u029b":"G","\u029c":"H","\u026a":"I","\u0281":"R","\u1d0a":"J","\u1d0b":"K","\u029f":"L","\u1d0c":"L","\u1d0d":"M","\u0274":"N","\u1d0f":"O","\u0276":"OE","\u1d10":"O","\u1d15":"OU","\u1d18":"P","\u0280":"R","\u1d0e":"N","\u1d19":"R","\ua731":"S","\u1d1b":"T","\u2c7b":"E","\u1d1a":"R","\u1d1c":"U","\u1d20":"V","\u1d21":"W","\u028f":"Y","\u1d22":"Z","\u00e1":"a","\u0103":"a","\u1eaf":"a","\u1eb7":"a","\u1eb1":"a","\u1eb3":"a","\u1eb5":"a","\u01ce":"a","\u00e2":"a","\u1ea5":"a","\u1ead":"a",
"\u1ea7":"a","\u1ea9":"a","\u1eab":"a","\u00e4":"a","\u01df":"a","\u0227":"a","\u01e1":"a","\u1ea1":"a","\u0201":"a","\u00e0":"a","\u1ea3":"a","\u0203":"a","\u0101":"a","\u0105":"a","\u1d8f":"a","\u1e9a":"a","\u00e5":"a","\u01fb":"a","\u1e01":"a","\u2c65":"a","\u00e3":"a","\ua733":"aa","\u00e6":"ae","\u01fd":"ae","\u01e3":"ae","\ua735":"ao","\ua737":"au","\ua739":"av","\ua73b":"av","\ua73d":"ay","\u1e03":"b","\u1e05":"b","\u0253":"b","\u1e07":"b","\u1d6c":"b","\u1d80":"b","\u0180":"b","\u0183":"b",
"\u0275":"o","\u0107":"c","\u010d":"c","\u00e7":"c","\u1e09":"c","\u0109":"c","\u0255":"c","\u010b":"c","\u0188":"c","\u023c":"c","\u010f":"d","\u1e11":"d","\u1e13":"d","\u0221":"d","\u1e0b":"d","\u1e0d":"d","\u0257":"d","\u1d91":"d","\u1e0f":"d","\u1d6d":"d","\u1d81":"d","\u0111":"d","\u0256":"d","\u018c":"d","\u0131":"i","\u0237":"j","\u025f":"j","\u0284":"j","\u01f3":"dz","\u01c6":"dz","\u00e9":"e","\u0115":"e","\u011b":"e","\u0229":"e","\u1e1d":"e","\u00ea":"e","\u1ebf":"e","\u1ec7":"e","\u1ec1":"e",
"\u1ec3":"e","\u1ec5":"e","\u1e19":"e","\u00eb":"e","\u0117":"e","\u1eb9":"e","\u0205":"e","\u00e8":"e","\u1ebb":"e","\u0207":"e","\u0113":"e","\u1e17":"e","\u1e15":"e","\u2c78":"e","\u0119":"e","\u1d92":"e","\u0247":"e","\u1ebd":"e","\u1e1b":"e","\ua76b":"et","\u1e1f":"f","\u0192":"f","\u1d6e":"f","\u1d82":"f","\u01f5":"g","\u011f":"g","\u01e7":"g","\u0123":"g","\u011d":"g","\u0121":"g","\u0260":"g","\u1e21":"g","\u1d83":"g","\u01e5":"g","\u1e2b":"h","\u021f":"h","\u1e29":"h","\u0125":"h","\u2c68":"h",
"\u1e27":"h","\u1e23":"h","\u1e25":"h","\u0266":"h","\u1e96":"h","\u0127":"h","\u0195":"hv","\u00ed":"i","\u012d":"i","\u01d0":"i","\u00ee":"i","\u00ef":"i","\u1e2f":"i","\u1ecb":"i","\u0209":"i","\u00ec":"i","\u1ec9":"i","\u020b":"i","\u012b":"i","\u012f":"i","\u1d96":"i","\u0268":"i","\u0129":"i","\u1e2d":"i","\ua77a":"d","\ua77c":"f","\u1d79":"g","\ua783":"r","\ua785":"s","\ua787":"t","\ua76d":"is","\u01f0":"j","\u0135":"j","\u029d":"j","\u0249":"j","\u1e31":"k","\u01e9":"k","\u0137":"k","\u2c6a":"k",
"\ua743":"k","\u1e33":"k","\u0199":"k","\u1e35":"k","\u1d84":"k","\ua741":"k","\ua745":"k","\u013a":"l","\u019a":"l","\u026c":"l","\u013e":"l","\u013c":"l","\u1e3d":"l","\u0234":"l","\u1e37":"l","\u1e39":"l","\u2c61":"l","\ua749":"l","\u1e3b":"l","\u0140":"l","\u026b":"l","\u1d85":"l","\u026d":"l","\u0142":"l","\u01c9":"lj","\u017f":"s","\u1e9c":"s","\u1e9b":"s","\u1e9d":"s","\u1e3f":"m","\u1e41":"m","\u1e43":"m","\u0271":"m","\u1d6f":"m","\u1d86":"m","\u0144":"n","\u0148":"n","\u0146":"n","\u1e4b":"n",
"\u0235":"n","\u1e45":"n","\u1e47":"n","\u01f9":"n","\u0272":"n","\u1e49":"n","\u019e":"n","\u1d70":"n","\u1d87":"n","\u0273":"n","\u00f1":"n","\u01cc":"nj","\u00f3":"o","\u014f":"o","\u01d2":"o","\u00f4":"o","\u1ed1":"o","\u1ed9":"o","\u1ed3":"o","\u1ed5":"o","\u1ed7":"o","\u00f6":"o","\u022b":"o","\u022f":"o","\u0231":"o","\u1ecd":"o","\u0151":"o","\u020d":"o","\u00f2":"o","\u1ecf":"o","\u01a1":"o","\u1edb":"o","\u1ee3":"o","\u1edd":"o","\u1edf":"o","\u1ee1":"o","\u020f":"o","\ua74b":"o","\ua74d":"o",
"\u2c7a":"o","\u014d":"o","\u1e53":"o","\u1e51":"o","\u01eb":"o","\u01ed":"o","\u00f8":"o","\u01ff":"o","\u00f5":"o","\u1e4d":"o","\u1e4f":"o","\u022d":"o","\u01a3":"oi","\ua74f":"oo","\u025b":"e","\u1d93":"e","\u0254":"o","\u1d97":"o","\u0223":"ou","\u1e55":"p","\u1e57":"p","\ua753":"p","\u01a5":"p","\u1d71":"p","\u1d88":"p","\ua755":"p","\u1d7d":"p","\ua751":"p","\ua759":"q","\u02a0":"q","\u024b":"q","\ua757":"q","\u0155":"r","\u0159":"r","\u0157":"r","\u1e59":"r","\u1e5b":"r","\u1e5d":"r","\u0211":"r",
"\u027e":"r","\u1d73":"r","\u0213":"r","\u1e5f":"r","\u027c":"r","\u1d72":"r","\u1d89":"r","\u024d":"r","\u027d":"r","\u2184":"c","\ua73f":"c","\u0258":"e","\u027f":"r","\u015b":"s","\u1e65":"s","\u0161":"s","\u1e67":"s","\u015f":"s","\u015d":"s","\u0219":"s","\u1e61":"s","\u1e63":"s","\u1e69":"s","\u0282":"s","\u1d74":"s","\u1d8a":"s","\u023f":"s","\u0261":"g","\u1d11":"o","\u1d13":"o","\u1d1d":"u","\u0165":"t","\u0163":"t","\u1e71":"t","\u021b":"t","\u0236":"t","\u1e97":"t","\u2c66":"t","\u1e6b":"t",
"\u1e6d":"t","\u01ad":"t","\u1e6f":"t","\u1d75":"t","\u01ab":"t","\u0288":"t","\u0167":"t","\u1d7a":"th","\u0250":"a","\u1d02":"ae","\u01dd":"e","\u1d77":"g","\u0265":"h","\u02ae":"h","\u02af":"h","\u1d09":"i","\u029e":"k","\ua781":"l","\u026f":"m","\u0270":"m","\u1d14":"oe","\u0279":"r","\u027b":"r","\u027a":"r","\u2c79":"r","\u0287":"t","\u028c":"v","\u028d":"w","\u028e":"y","\ua729":"tz","\u00fa":"u","\u016d":"u","\u01d4":"u","\u00fb":"u","\u1e77":"u","\u00fc":"u","\u01d8":"u","\u01da":"u","\u01dc":"u",
"\u01d6":"u","\u1e73":"u","\u1ee5":"u","\u0171":"u","\u0215":"u","\u00f9":"u","\u1ee7":"u","\u01b0":"u","\u1ee9":"u","\u1ef1":"u","\u1eeb":"u","\u1eed":"u","\u1eef":"u","\u0217":"u","\u016b":"u","\u1e7b":"u","\u0173":"u","\u1d99":"u","\u016f":"u","\u0169":"u","\u1e79":"u","\u1e75":"u","\u1d6b":"ue","\ua778":"um","\u2c74":"v","\ua75f":"v","\u1e7f":"v","\u028b":"v","\u1d8c":"v","\u2c71":"v","\u1e7d":"v","\ua761":"vy","\u1e83":"w","\u0175":"w","\u1e85":"w","\u1e87":"w","\u1e89":"w","\u1e81":"w","\u2c73":"w",
"\u1e98":"w","\u1e8d":"x","\u1e8b":"x","\u1d8d":"x","\u00fd":"y","\u0177":"y","\u00ff":"y","\u1e8f":"y","\u1ef5":"y","\u1ef3":"y","\u01b4":"y","\u1ef7":"y","\u1eff":"y","\u0233":"y","\u1e99":"y","\u024f":"y","\u1ef9":"y","\u017a":"z","\u017e":"z","\u1e91":"z","\u0291":"z","\u2c6c":"z","\u017c":"z","\u1e93":"z","\u0225":"z","\u1e95":"z","\u1d76":"z","\u1d8e":"z","\u0290":"z","\u01b6":"z","\u0240":"z","\ufb00":"ff","\ufb03":"ffi","\ufb04":"ffl","\ufb01":"fi","\ufb02":"fl","\u0133":"ij","\u0153":"oe",
"\ufb06":"st","\u2090":"a","\u2091":"e","\u1d62":"i","\u2c7c":"j","\u2092":"o","\u1d63":"r","\u1d64":"u","\u1d65":"v","\u2093":"x"};d=d.split(" ").join("-");d=d.replace(/[^A-Za-z0-9\[\] ]/g,function(f){return a[f]||f});d=d.toLowerCase();return d=d.replace(/[^a-z0-9\-]+/g,"")};(function(d,a,f){function h(c,m){if(!a[c]){if(!d[c]){var g="function"==typeof require&&require;if(!m&&g)return g(c,!0);if(e)return e(c,!0);throw Error("Cannot find module '"+c+"'");}m=a[c]={exports:{}};d[c][0].call(m.exports,function(k){var l=d[c][1][k];return h(l?l:k)},m,m.exports)}return a[c].exports}for(var e="function"==typeof require&&require,b=0;b<f.length;b++)h(f[b]);return h})({1:[function(d,a,f){d=d("./lib/WAAClock");a.exports=d;"undefined"!==typeof window&&(window.WAAClock=d)},{"./lib/WAAClock":2}],
3:[function(d,a,f){d=a.exports={};d.nextTick=function(){if("undefined"!==typeof window&&window.setImmediate)return function(e){return window.setImmediate(e)};if("undefined"!==typeof window&&window.postMessage&&window.addEventListener){var h=[];window.addEventListener("message",function(e){var b=e.source;b!==window&&null!==b||"process-tick"!==e.data||(e.stopPropagation(),0<h.length&&h.shift()())},!0);return function(e){h.push(e);window.postMessage("process-tick","*")}}return function(e){setTimeout(e,
0)}}();d.title="browser";d.browser=!0;d.env={};d.argv=[];d.binding=function(h){throw Error("process.binding is not supported");};d.cwd=function(){return"/"};d.chdir=function(h){throw Error("process.chdir is not supported");}},{}],2:[function(d,a,f){var h=d("__browserify_process");if("undefined"!==typeof window&&!AudioContext)throw Error("This browser doesn't seem to support web audio API");var e=function(b,c,m){this.clock=b;this.func=m;this.repeatTime=null;this.toleranceLate=.1;this.toleranceEarly=
.001;this._armed=!1;this._earliestTime=this._latestTime=null;this.schedule(c)};e.prototype.clear=function(){this.clock._removeEvent(this);return this};e.prototype.repeat=function(b){if(0===b)throw Error("delay cannot be 0");this.repeatTime=b;return this};e.prototype.tolerance=function(b){"number"===typeof b.late&&(this.toleranceLate=b.late);"number"===typeof b.early&&(this.toleranceEarly=b.early);this._update();return this};e.prototype.isRepeated=function(){return null!==this.repeatTime};e.prototype.schedule=
function(b){this._armed=!0;this.deadline=b;this._update();this.clock.context.currentTime>=this._earliestTime&&(this.clock._removeEvent(this),this._execute())};e.prototype._execute=function(){this._armed=!1;this.clock.context.currentTime<this._latestTime?this.func(this):(console.warn("event expired"),EventBus&&EventBus.trigger(EVENT.clockEventExpired));!1===this._armed&&this.isRepeated()&&this.schedule(this.deadline+this.repeatTime)};e.prototype._update=function(){this._latestTime=this.deadline+this.toleranceLate;
this._earliestTime=this.deadline-this.toleranceEarly;this.clock._removeEvent(this);this.clock._insertEvent(this)};d=a.exports=function(b,c){c=c||{};this.toleranceEarly=c.toleranceEarly||.001;this.toleranceLate=c.toleranceLate||.1;this.context=b;this._events=[];this._started=!1};d.prototype.setTimeout=function(b,c){return this._createEvent(b,this._absTime(c))};d.prototype.callbackAtTime=function(b,c){return this._createEvent(b,c)};d.prototype.timeStretch=function(b,c,m){var g=this.context.currentTime;
c.forEach(function(k){k.isRepeated()&&k.repeat(k.repeatTime*m);var l=b+m*(k.deadline-b);if(k.isRepeated())for(;g>=l-k.toleranceEarly;)l+=k.repeatTime;k.schedule(l)});return c};d.prototype.start=function(){if(!1===this._started){var b=this;this._started=!0;this._events=[];this._clockNode=this.context.createScriptProcessor(256,1,1);this._clockNode.connect(this.context.destination);this._clockNode.onaudioprocess=function(){h.nextTick(function(){b._tick()})}}};d.prototype.stop=function(){!0===this._started&&
(this._started=!1,this._clockNode.disconnect())};d.prototype._tick=function(){for(var b=this._events.shift();b&&b._earliestTime<=this.context.currentTime;)b._execute(),b=this._events.shift();b&&this._events.unshift(b)};d.prototype._createEvent=function(b,c){b=new e(this,c,b);b.tolerance({late:this.toleranceLate,early:this.toleranceEarly});return b};d.prototype._insertEvent=function(b){this._events.splice(this._indexByTime(b._earliestTime),0,b)};d.prototype._removeEvent=function(b){b=this._events.indexOf(b);
-1!==b&&this._events.splice(b,1)};d.prototype._indexByTime=function(b){for(var c=0,m=this._events.length,g;c<m;)g=Math.floor((c+m)/2),this._events[g]._earliestTime<b?c=g+1:m=g;return c};d.prototype._absTime=function(b){return b+this.context.currentTime};d.prototype._relTime=function(b){return b-this.context.currentTime}},{__browserify_process:3}]},{},[1]);/*
 @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(d){if(!("undefined"===typeof d||"undefined"!==typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var a=d.document.createElementNS("http://www.w3.org/1999/xhtml","a"),f="download"in a,h=/constructor/i.test(d.HTMLElement)||d.safari,e=/CriOS\/[\d]+/.test(navigator.userAgent),b=function(l){(d.setImmediate||d.setTimeout)(function(){throw l;},0)},c=function(l){setTimeout(function(){"string"===typeof l?(d.URL||d.webkitURL||d).revokeObjectURL(l):l.remove()},4E4)},m=function(l){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(l.type)?
new Blob([String.fromCharCode(65279),l],{type:l.type}):l},g=function(l,n,r){r||(l=m(l));var t=this,p="application/octet-stream"===l.type,z=function(){var B=["writestart","progress","write","writeend"];B=[].concat(B);for(var A=B.length;A--;){var E=t["on"+B[A]];if("function"===typeof E)try{E.call(t,t)}catch(U){b(U)}}};t.readyState=t.INIT;if(f){var y=(d.URL||d.webkitURL||d).createObjectURL(l);setTimeout(function(){a.href=y;a.download=n;var B=new MouseEvent("click");a.dispatchEvent(B);z();c(y);t.readyState=
t.DONE})}else(function(){if((e||p&&h)&&d.FileReader){var B=new FileReader;B.onloadend=function(){var A=e?B.result:B.result.replace(/^data:[^;]*;/,"data:attachment/file;");d.open(A,"_blank")||(d.location.href=A);t.readyState=t.DONE;z()};B.readAsDataURL(l);t.readyState=t.INIT}else y||=(d.URL||d.webkitURL||d).createObjectURL(l),p?d.location.href=y:d.open(y,"_blank")||(d.location.href=y),t.readyState=t.DONE,z(),c(y)})()},k=g.prototype;if("undefined"!==typeof navigator&&navigator.msSaveOrOpenBlob)return function(l,
n,r){n=n||l.name||"download";r||(l=m(l));return navigator.msSaveOrOpenBlob(l,n)};k.abort=function(){};k.readyState=k.INIT=0;k.WRITING=1;k.DONE=2;k.error=k.onwritestart=k.onprogress=k.onwrite=k.onabort=k.onerror=k.onwriteend=null;return function(l,n,r){return new g(l,n||l.name||"download",r)}}}("undefined"!==typeof self&&self||"undefined"!==typeof window&&window||this.content);
"undefined"!==typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!==typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});function audioBufferToWav(d,a){a=a||{};var f=d.numberOfChannels,h=d.sampleRate;a=a.float32?3:1;var e=3===a?32:16;if(2===f){var b=d.getChannelData(0);d=d.getChannelData(1);for(var c=b.length+d.length,m=new Float32Array(c),g=0,k=0;g<c;)m[g++]=b[k],m[g++]=d[k],k++;b=m}else b=d.getChannelData(0);return encodeWAV(b,a,h,f,e)}
function encodeWAV(d,a,f,h,e){function b(l,n,r){for(var t=0;t<r.length;t++)l.setUint8(n+t,r.charCodeAt(t))}var c=e/8,m=h*c,g=new ArrayBuffer(44+d.length*c),k=new DataView(g);b(k,0,"RIFF");k.setUint32(4,36+d.length*c,!0);b(k,8,"WAVE");b(k,12,"fmt ");k.setUint32(16,16,!0);k.setUint16(20,a,!0);k.setUint16(22,h,!0);k.setUint32(24,f,!0);k.setUint32(28,f*m,!0);k.setUint16(32,m,!0);k.setUint16(34,e,!0);b(k,36,"data");k.setUint32(40,d.length*c,!0);f=44;if(1===a)for(a=0;a<d.length;a++,f+=2)h=Math.max(-1,Math.min(1,
d[a])),k.setInt16(f,0>h?32768*h:32767*h,!0);else for(a=0;a<d.length;a++,f+=4)k.setFloat32(f,d[a],!0);return g};(function(d,a){"function"===typeof define&&define.amd?define(a):"object"===typeof exports?module.exports=a():d[d.__dropbox_export||"dropboxService"]=a()})(this,function(){function d(g,k){return"[object Function]"==f.call(g)}function a(){return window.location.hash.replace(/^#/,"").split("&").reduce(function(g,k){if(""==k)return g;k=k.split("=");g[decodeURIComponent(k[0])]=decodeURIComponent(k[1]);return g},{})}var f={}.toString,h=function(g,k){return 1<arguments.length?localStorage[g]=k:localStorage[g]},
e=void 0,b={"auth/token/revoke":{contentType:null},"users/get_current_account":{contentType:"application/json"},"files/upload":{baseUri:"https://content.dropboxapi.com/2/",format:"content-upload"},"files/get_thumbnail":{baseUri:"https://content.dropboxapi.com/2/",format:"content-download"},"files/download":{baseUri:"https://content.dropboxapi.com/2/",format:"content-download"},"files/get_preview":{baseUri:"https://content.dropboxapi.com/2/",format:"content-download"},"files/upload_session/append":{baseUri:"https://content.dropboxapi.com/2/",
format:"content-upload"},"files/upload_session/append_v2":{baseUri:"https://content.dropboxapi.com/2/",format:"content-upload"},"files/upload_session/finish":{baseUri:"https://content.dropboxapi.com/2/",format:"content-upload"},"files/upload_session/start":{baseUri:"https://content.dropboxapi.com/2/",format:"content-upload"},"files/get_shared_link_file":{baseUri:"https://content.dropboxapi.com/2/",format:"content-download"}},c={rpc:"application/json","content-upload":"application/octet-stream"},m=
function(g,k){var l=[].slice.call(arguments),n=b[g]||{},r=n.baseUri||"https://api.dropboxapi.com/2/",t=n.format||"rpc";n=n.contentType||null===n.contentType?null:c[t];var p=l[l.length-1],z=2<l.length&&("[object Object]"==f.call(p)||d(p))?p:{};d(z)&&(z={onComplete:z});var y,B={};Promise&&(y=new Promise(function(E,U){B.resolve=E;B.reject=U}));var A=new XMLHttpRequest;A.open("POST",r+g,!0);A.setRequestHeader("Authorization","Bearer "+(h("__dbat")||"000000000000000000000000_00000-000000000000000000000000000000000"));
"content-download"==t&&(A.responseType="blob");k&&k.responseType&&(A.responseType=k.responseType,delete k.responseType);n&&A.setRequestHeader("Content-Type",n);!k||"content-upload"!=t&&"content-download"!=t||A.setRequestHeader("Dropbox-API-Arg",JSON.stringify(k));z.onDownloadProgress&&A.addEventListener("progress",z.onDownloadProgress);z.onUploadProgress&&A.upload&&A.upload.addEventListener("progress",z.onUploadProgress);(z.onError||e)&&A.addEventListener("error",function(E){var U=z.onError&&z.onError(E.target);
y&&B.reject&&B.reject(E.target);e&&e(E.target,U)});A.onreadystatechange=function(){if(4==A.readyState)if(200==A.status){var E=JSON.parse(A.getResponseHeader("dropbox-api-result")||A.responseText);"auth/token/revoke"==g&&h("__dbat","");z.onComplete&&z.onComplete(E,A.response,A);y&&B.resolve&&B.resolve(E,A.response,A)}else E=z.onError&&z.onError(A),y&&B.reject&&B.reject(A),e&&e(A,E)};(l=(l=2<l.length&&"content-upload"==t?l[2]:void 0)||(k&&"rpc"==t?JSON.stringify(k):null))?A.send(l):A.send();return y};
m.setGlobalErrorHandler=function(g){e=g};m.setTokenStore=function(g){h=g};m.authenticate=function(g,k){k=k||{};d(k)&&(k={onComplete:k});g=g||{};"[object String]"==f.call(g)&&(g={client_id:g});g.redirect_uri=g.redirect_uri||window.location.href;var l;Promise&&(l=new Promise(function(t,p){}));if(h("__dbat"))return k.onComplete(),l&&l.resolve&&l.resolve(),l;var n=a(),r=h("__dbcsrf");n.state&&r&&n.state==r?n.access_token?(h("__dbat",n.access_token),h("__dbcsrf",""),window.location.replace(window.location.href.replace(/#.*/,
""))):(g=k.onError&&k.onError(n),l&&l.reject&&l.reject(n),e&&e(n,g)):(r=""+Math.floor(1E5*Math.random()),h("__dbcsrf",r),window.location="https://www.dropbox.com/1/oauth2/authorize?response_type=token&client_id="+encodeURIComponent(g.client_id)+"&redirect_uri="+encodeURIComponent(g.redirect_uri)+"&state="+encodeURIComponent(r));return l};m.getAccessToken=function(){return h("__dbat")};m.clearAccessToken=function(){return h("__dbat","")};return m});function getSamplerate(d,a){function f(b){for(var c=[],m=Math.min(b.length,1048576),g=0;g<m;g++)c.push(String.fromCharCode(b[g]));return c.join("")}function h(b){for(var c=500;c<b.length-1;c++)if(255===b[c]&&224===(b[c+1]&224)){var m=[4,0,2,1],g=[44100,48E3,32E3],k=(b[c+1]&24)>>3,l=(b[c+1]&6)>>1,n=(b[c+2]&12)>>2;b=(b[c+3]&192)>>6;return{ID:k,Layer:l,srate:n,type:"MP3",info:["MPEG Version 2.5","reserved","MPEG Version 2","MPEG Version 1"][k]+" "+["reserved","Layer III","Layer II","Layer I"][l],sampleRate:isNaN(g[n]/
m[k])?Audio.context.sampleRate:g[n]/m[k],numberOfChannels:[2,2,2,1][b]}}return!1}var e={};d=new Uint8Array(d.buffer);e.type=String.fromCharCode(d[0])+String.fromCharCode(d[1])+String.fromCharCode(d[2])+String.fromCharCode(d[3]);"RIFF"===e.type?(e.type="WAVE_PCM",e.chunkSize=d[4]+(d[5]<<8)+(d[6]<<16)+(d[7]<<24),a=f(d),a=a.indexOf("fmt "),e.audioFormat=d[a+8]+(d[a+9]<<8),e.numberOfChannels=d[a+10]+(d[a+11]<<8),e.sampleRate=d[a+12]+(d[a+13]<<8)+(d[a+14]<<16)+(d[a+15]<<24),e.bits=d[a+22]+(d[a+23]<<8)):
"fLaC"===e.type?(e.type="FLAC",e.sampleRate=(d[18]<<12)+(d[19]<<4)+((d[20]&240)>>4),e.numberOfChannels=((d[20]&14)>>1)+1,e.bits=((d[20]&1)<<4)+((d[21]&240)>>4)+1):"OggS"===e.type?(a=f(d),a=a.indexOf("OpusHead"),-1!=a?(a+=8,e.type="OPUS",e.version=d[a],e.numberOfChannels=d[a+1],e.preSkip=d[a+2]+(d[a+3]<<8),e.sampleRate=d[a+4]+(d[a+5]<<8)+(d[a+6]<<16)+(d[a+7]<<24)):(e.type="OGG",e.numberOfChannels=d[39],e.sampleRate=d[40]+(d[41]<<8)+(d[42]<<16)+(d[43]<<24)+(d[44]<<32)+(d[45]<<40)+(d[46]<<48)+(d[47]<<
56),e.bits=d[48]+(d[49]<<8)+(d[50]<<16)+(d[51]<<24))):"ftyp"===String.fromCharCode(d[4])+String.fromCharCode(d[5])+String.fromCharCode(d[6])+String.fromCharCode(d[7])?(e.type="MP4",a=f(d),a=a.indexOf("mdhd"),e.sampleRate=1===d[a+4]?(d[a+16+8]<<24)+(d[a+17+8]<<16)+(d[a+18+8]<<8)+d[a+19+8]:(d[a+16]<<24)+(d[a+17]<<16)+(d[a+18]<<8)+d[a+19]):"ID3"===e.type.substring(0,3)?e=h(d):("mp3"===a&&(e=h(d)),e||console.error("getSamplerate found unknown format",e.type));return e};function readRAWsample(d,a){d.goto(0);for(var f=0;f<a.length;f++){var h=d.readByte();a.data.push(h/127)}};function read8SVXsample(d,a){function f(){var c={};c.name=d.readString(4);c.size=d.readDWord();return c}console.error("reading 8SVX sample");d.litteEndian=!1;d.goto(12);for(var h=f();"BODY"!=h.name&&!d.isEOF(10);)"NAME"==h.name?a.name=d.readString(h.size):d.jump(h.size),h=f();if("BODY"==h.name)for(var e=0;e<h.size;e++){var b=d.readByte();a.data.push(b/127)}};function encodeRIFFsample(d,a){var f=d.length,h=8E3;16===a&&(f=2*d.length,h=16E3);var e=f;1===e%2&&e++;var b=new ArrayBuffer(46+e);b=new BinaryStream(b,!1);b.goto(0);b.writeString("RIFF");b.writeDWord(38+e);b.writeString("WAVE");b.writeString("fmt ");b.writeDWord(18);b.writeWord(1);b.writeWord(1);b.writeDWord(8E3);b.writeDWord(h);b.writeWord(Math.floor(a/8));b.writeWord(a);b.writeWord(0);b.writeString("data");b.writeDWord(f);if(16===a)for(a=0;a<d.length;a++)b.writeWord(32767*d[a]);else for(a=0;a<
d.length;a++)b.writeUByte(Math.round(127*d[a])+127);f<e&&b.writeUByte(0);return b};function detectSampleType(d,a,f){var h=SAMPLETYPE.RAW_8BIT,e=readRAWsample,b="";a&&a.name&&(b=a.name.split(".").pop().toLowerCase());a.info=getSamplerate(d,b);switch(a.info.type){case "WAVE_PCM":case "RIFF":case "MP3":case "FLAC":case "OGG":case "OPUS":h=SAMPLETYPE[a.info.type];e=decodeFileWithAudioContext;break;case "FORM":d.goto(8);"8SVX"==d.readString(4)&&(h=SAMPLETYPE.IFF_8SVX,e=read8SVXsample);break;default:console.log("Unknown sample format, expect RAW_8BIT:",a.info)}if(a&&e)e(d,a,f);else if(f)f(h);
else return h}
function decodeFileWithAudioContext(d,a,f){Audio.converter=new AudioContext({sampleRate:a.info.sampleRate});Audio.converter.sampleRate!==a.info.sampleRate&&console.log("Could not initiate desired sampleRate of "+a.info.sampleRate+" instead got "+Audio.converter.sampleRate);Audio.converter.decodeAudioData(d.buffer,function(h){h?(a.data=h.getChannelData(0),a.data&&!a.data.concat&&(a.data=Array.from(a.data)),a.length=h.length,f&&f()):alert("error decoding file data: "+url)},function(h){console.error("decodeAudioData error",h);
f&&f()})};FilterChain=function(d){function a(){q=I;if(b){var v;(v=N)||(v=w.createBiquadFilter(),v.type="highshelf",v.frequency.value=3200,v.gain.value=B);N=v;q.connect(N);q=N}c&&((v=R)||(v=w.createBiquadFilter(),v.type="peaking",v.frequency.value=1E3,v.Q.value=.5,v.gain.value=y),R=v,q.connect(R),q=R);m&&((v=S)||(v=w.createBiquadFilter(),v.type="lowshelf",v.frequency.value=320,v.gain.value=z),S=v,q.connect(S),q=S);g&&((v=W)||(v=w.createBiquadFilter(),v.type="lowpass",v.frequency.value=5E3),W=v,q.connect(W),
q=W);if(l){J=J||w.createWaveShaper();Q=Q||w.createGain();v=J;for(var K="number"===typeof Q?Q:50,X=new Float32Array(44100),C=Math.PI/180,L=0,x;44100>L;++L)x=2*L/44100-1,X[L]=(3+K)*x*20*C/(Math.PI+K*Math.abs(x));v.curve=X;J.oversample="4x";q.connect(Q);Q.connect(J);q=J}r&&(V=V||w.createDynamicsCompressor(),V.threshold.setValueAtTime(-25,w.currentTime),V.attack.setValueAtTime(0,w.currentTime),V.release.setValueAtTime(12,w.currentTime),q.connect(V),q=V);n&&((v=F)||(v=w.createChannelMerger(2),K=w.createDelay(),
X=w.createDelay(),C=w.createGain(),L=w.createGain(),x=w.createChannelSplitter(2),x.connect(K,0),x.connect(X,1),K.delayTime.value=.12,X.delayTime.value=.12,C.gain.value=.4,L.gain.value=.4,K.connect(C),C.connect(X),X.connect(L),L.connect(K),C.connect(v,0,0),L.connect(v,0,1),v={splitter:x,merger:v}),F=v,u=u||w.createGain(),u.gain.value=0,q.connect(u),u.connect(F.splitter),p=F.merger);k&&(G=G||w.createConvolver(),U=U||w.createGain(),U.gain.value=0,q.connect(U),U.connect(G),t=G);e&&(O=O||Audio.context.createStereoPanner(),
q.connect(O),q=O);D=D||w.createGain();q.connect(D);t&&t.connect(D);p&&p.connect(D);q=D}var f={};d=d||{volume:!0,panning:!0,high:!1,mid:!1,low:!1,lowPass:!1,reverb:!1,distortion:!1,delay:!1,compression:!1};d={volume:!0,panning:!0,high:!1,mid:!1,low:!1,lowPass:!1,reverb:!1,distortion:!1,delay:!1,compression:!1};var h=d.volume,e=d.panning&&Audio.context.createStereoPanner,b=d.high,c=d.mid,m=d.low,g=d.lowPass,k=d.reverb,l=d.distortion,n=d.delay,r=d.compression,t,p,z=0,y=0,B=0,A=70,E=0,U=0,Q=0,u=0,w=Audio.context,
D,N,R,S,W,G,F,J,V,O;var I=w.createGain();I.gain.value=1;var q=I;f.lowValue=function(v){if(m)return"undefined"!==typeof v&&(z=v,S.gain.value=20*z),z};f.midValue=function(v){if(c)return"undefined"!==typeof v&&(y=v,R.gain.value=20*y),y};f.highValue=function(v){if(b)return"undefined"!==typeof v&&(B=v,N.gain.value=20*B),B};f.lowPassFrequencyValue=function(v){if(g){var K=Audio.context.sampleRate/2;W.frequency.value=K*Math.pow(2,Math.log(K/40)/Math.LN2*(v-1))}};f.lowPassQualityValue=function(v){g&&(W.Q.value=
30*v)};f.compressionValue=function(v){V.ratio.setValueAtTime(4*v/100+1,w.currentTime);console.log(v,V.threshold,V.ratio,V.attack,V.release)};f.reverbValue=function(v){if(k){if(!G.buffer){var K=cachedAssets.audio["data/reverb/sportcentre.m4a"];K?G.buffer=K:PreLoader().load(["data/reverb/sportcentre.m4a"],PRELOADTYPE.audio,function(){console.error("reverb buffer loaded");G.buffer=cachedAssets.audio["data/reverb/sportcentre.m4a"]})}v=parseInt(v)/100;U.gain.value=v*v}};f.distortionValue=function(v){l&&
(v=parseInt(v)/100,Q.gain.value=10*v)};f.delayValue=function(v){n&&(v=parseInt(v)/100,u.gain.value=v*v)};f.delayValue=function(v){n&&(v=parseInt(v)/100,u.gain.value=v*v)};f.volumeValue=function(v){if(h)return"undefined"!==typeof v&&(A=v,v/=100,D.gain.value=v*v),A};f.panningValue=function(v,K){if(e)return"undefined"!==typeof v&&(E=v,K?O.pan.setValueAtTime(E,K):O.pan.setValueAtTime(E,Audio.context.currentTime)),E};f.setState=function(v,K){I.disconnect();N&&N.disconnect();R&&R.disconnect();S&&S.disconnect();
W&&W.disconnect();U&&U.disconnect();O&&O.disconnect();J&&J.disconnect();u&&u.disconnect();V&&V.disconnect();p=t=void 0;"high"===v&&(b=!!K);"mid"===v&&(c=!!K);"low"===v&&(m=!!K);"lowPass"===v&&(g=!!K);"reverb"===v&&(k=!!K);"panning"===v&&(e=!!K&&Audio.context.createStereoPanner);"distortion"===v&&(l=!!K);"delay"===v&&(n=!!K);"compression"===v&&(r=!!K);a()};f.input=function(){return I};f.output=function(){return q};a();f.volumeValue(A);return f};var Midi=function(){function d(e){if(h){e=e.data;switch(e[0]){case 128:case 129:a(e[1],e[2]);break;case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:if(e[2]){var b=e[1];e=e[2];console.log("note on",b,e);b-=47;var c=Input.getCurrentOctave(),m;"enabled"===SETTINGS.midi&&(m=e+1>>1);Input.handleNoteOn(b+12*c,void 0,void 0,m)}else a(e[1],e[2]);break;case 176:console.log("Midi: set effect",e[1],e[2]);break;case 192:Tracker.setCurrentInstrumentIndex(e[1]+
1);break;case 224:console.log("Modulator",e[1],e[2])}EventBus.trigger(EVENT.midiIn)}}function a(e,b){console.log("note off",e,b);e-=47;b=Input.getCurrentOctave();Input.handleNoteOff(e+12*b,"enabled"===SETTINGS.midi)}var f={},h;f.init=function(){if(navigator.requestMIDIAccess){navigator.requestMIDIAccess().then(e,b);function e(c){console.log("Midi enabled");h=!0;c=Array.from(c.inputs.values());c.forEach(function(m){m.onmidimessage=d});c.length&&EventBus.trigger(EVENT.midiIn)}function b(){console.log("Could not access your MIDI devices.")}
}else return console.warn("Midi not supported"),!1};f.enable=function(){Midi.init()};f.disable=function(){h=!1;EventBus.trigger(EVENT.midiIn)};f.isEnabled=function(){return!!h};return f}();var debug=!1,Main=function(){var d={init:function(){console.log("initialising");Host.init();Tracker.init();Audio.init();UI.startMeasure();UI.init(function(){window.focus();d.isBrowserSupported=Audio.context&&window.requestAnimationFrame;if(d.isBrowserSupported)Settings.readSettings(),debug&&UI.measure("Read & Apply Settings"),App.init(),Host.signalReady(),Editor.loadInitialFile(),debug&&UI.endMeasure();else{console.error("Browser not supported");var a=UI.modalDialog();a.setProperties({width:UI.mainPanel.width,
height:UI.mainPanel.height,top:0,left:0,ok:!0});a.onDown=function(){window.location.href="https://www.google.com/chrome/"};a.setText("Sorry//Your browser does not support WebAudio//Supported browsers are/Chrome,Firefox,Safari and Edge");UI.setModalElement(a)}})}};return d}();!Host.customConfig&&document.addEventListener&&document.addEventListener("DOMContentLoaded",Main.init);var App=function(){var d={};d.buildNumber="undefined"===typeof buildNumber?"":buildNumber;d.init=function(){"object"===typeof Midi&&SETTINGS&&SETTINGS.midi&&"disabled"!==SETTINGS.midi&&Midi.init();EventBus.on(EVENT.command,function(a){window.focus();switch(a){case COMMAND.newFile:Tracker.new();break;case COMMAND.openFile:EventBus.trigger(EVENT.showView,"diskop_modules_load");break;case COMMAND.saveFile:EventBus.trigger(EVENT.showView,"diskop_modules_save");break;case COMMAND.clearTrack:Editor.clearTrack();
break;case COMMAND.clearPattern:Editor.clearPattern();break;case COMMAND.clearInstruments:Tracker.clearInstruments();break;case COMMAND.clearSong:Editor.clearSong();break;case COMMAND.showMain:EventBus.trigger(EVENT.showView,"main");break;case COMMAND.showTopMain:EventBus.trigger(EVENT.showView,"topmain");break;case COMMAND.showBottomMain:EventBus.trigger(EVENT.showView,"bottommain");break;case COMMAND.showOptions:EventBus.trigger(EVENT.showView,"options");break;case COMMAND.showFileOperations:EventBus.trigger(EVENT.showView,
"diskop_load");break;case COMMAND.showSampleEditor:EventBus.trigger(EVENT.showView,"sample");break;case COMMAND.togglePiano:EventBus.trigger(EVENT.toggleView,"piano");break;case COMMAND.toggleAppSideBar:EventBus.trigger(EVENT.toggleView,"sidebar");break;case COMMAND.showAbout:a=UI.modalDialog();a.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0});a.onClick=a.close;var f=Host.getVersionNumber();Host.getBuildNumber();a.setText("BassoonTracker//Old School Amiga MOD and XM tracker/in plain javascript//\u00a92017-2023 by Steffest//version "+
f+"//Fork me on Github!");UI.setModalElement(a);break;case COMMAND.showHelp:window.open("https://www.stef.be/bassoontracker/docs/");break;case COMMAND.randomSong:UI.diskOperations.playRandomSong();break;case COMMAND.randomSongXM:UI.diskOperations.playRandomSong("xm");break;case COMMAND.showGithub:window.open("https://github.com/steffest/bassoontracker");break;case COMMAND.showStats:document.getElementById("MrDStats")||(a=document.createElement("script"),a.onload=function(){var h=new Stats;document.body.appendChild(h.dom);
requestAnimationFrame(function b(){h.update();requestAnimationFrame(b)})},a.src="script/plugins/stats.js",document.head.appendChild(a));break;case COMMAND.cut:UI.cutSelection(!0);break;case COMMAND.copy:UI.copySelection(!0);break;case COMMAND.paste:UI.pasteSelection(!0);break;case COMMAND.pattern2Sample:Editor.renderTrackToBuffer();break;case COMMAND.undo:EventBus.trigger(EVENT.commandUndo);break;case COMMAND.redo:EventBus.trigger(EVENT.commandRedo);break;case COMMAND.nibbles:Plugin.load("Nibbles",
function(){Nibbles.init({UI,Input,Y,EventBus,EVENT,COMMAND,Layout})});break;case COMMAND.generator:Plugin.load("Generator",function(){Generator.init({UI,Input,Y,EventBus,EVENT,COMMAND,Layout})})}})};d.doCommand=function(a){EventBus.trigger(EVENT.command,a)};return d}();var periodNoteTable={},periodFinetuneTable={},nameNoteTable={},noteNames=[],FTNotes=[],FTPeriods=[],Tracker=function(){function d(C){C=C||0;k=k||new WAAClock(Audio.context);k.start();Audio.enable();UI&&UI.setStatus("Playing");K=[];X=[];Q=r.patterns[C];var L=Q.length,x={},H=0,Z=Audio.context.currentTime+.1,T=.2,M=Q,aa=u;v=[];G=k.setTimeout(function(P){1<H&&(T=1,G.repeat(T));P=P.deadline+T;for(Audio.clearScheduledNotesCache();Z<P;){if(x.pause&&!Tracker.autoPlay){x.pasuseHandled||(P=Z-Audio.context.currentTime,
0<P&&setTimeout(function(){g.pause();g.setAmigaSpeed(6)},Math.round(1E3*P)+100),x.pasuseHandled=!0);return}g.setStateAtTime(Z,{patternPos:H,songPos:aa});UI||g.setCurrentSongPosition(aa);if(x.patternDelay){x.patternDelay--;for(i=0;i<F;i++)e(i,Z);Z+=S*W}else if(x=a(H,Z,M,aa),Z+=S*W,H++,H>=L||x.patternBreak){x.positionBreak&&x.targetSongPosition==aa||(K=[],X=[]);H=0;if(Tracker.getPlayType()==PLAYTYPE.song){var ca=x.positionBreak?x.targetSongPosition:++aa;ca>=r.length&&(ca=r.restartPosition?r.restartPosition-
1:0,EventBus.trigger(EVENT.songEnd));ca>=r.length&&(ca=0);aa=ca;C=r.patternTable[aa];M=r.patterns[C];M||(M=m(),r.patterns[C]=M);L=M.length;x.patternBreak&&(H=x.targetPatternPosition||0,H>M.length&&(H=0))}else x.patternBreak&&(H=x.targetPatternPosition||0,H>J&&(H=0));EventBus.trigger(EVENT.patternEnd,Z-S*W)}}for(i=0;i<F;i++)if((P=I[i])&&P.time&&P.scheduled){ca=g.getInstrument(P.instrumentIndex);if(P.scheduled.volume&&Z+T>=P.scheduled.volume){var ba=ca.scheduleEnvelopeLoop(P.volumeEnvelope,P.scheduled.volume,
2);P.scheduled.volume+=ba}P.scheduled.panning&&Z+T>=P.scheduled.panning&&(ba=ca.scheduleEnvelopeLoop(P.panningEnvelope,P.scheduled.panning,2),P.scheduled.panning+=ba)}},.01).repeat(T).tolerance({early:.1})}function a(C,L,x,H){x=x||Q;x=x[C];for(var Z=F,T={},M,aa=0;aa<Z;aa++)(M=x[aa])&&M.effect&&15===M.effect&&(32>M.param?(Tracker.setAmigaSpeed(M.param),0===M.param&&(T.pause=!0)):Tracker.setBPM(M.param));for(aa=0;aa<Z;aa++)if(M=x[aa]){var P={position:H,step:C},ca=L;O&&(ca+=(Math.random()*O*2-O)/1E3);
var ba,da=aa,oa=P,ia=100;P={};var la=M.instrument,qa=M.period,ja=M.index;qa&&!la&&(la=I[da].currentInstrument,ia="number"===typeof I[da].currentVolume?I[da].currentVolume:ia,SETTINGS.emulateProtracker1OffsetBug&&la&&q[da].offset&&q[da].offset.instrument===la&&(console.log("applying instrument offset cache to instrument "+la),P.offset=q[da].offset));"number"===typeof M.instrument&&(ka=g.getInstrument(M.instrument))&&(ia=ka.sample.volume/64*100,SETTINGS.emulateProtracker1OffsetBug&&(q[da].offset=q[da].offset||
{},q[da].offset.value=0,q[da].offset.instrument=M.instrument));var pa=ia,na=!0;"number"===typeof la&&(ka=g.getInstrument(la));if(ja&&g.inFTMode())if(97===ja&&(ja=NOTEOFF),ja===NOTEOFF)(ba=ka||g.getInstrument(I[da].currentInstrument))?pa=ba.noteOff(ca,I[da]):(console.log("no instrument on track "+da),pa=0),ia=pa,na=!1;else if(ka&&(ka.setSampleForNoteIndex(ja),ka.sample.relativeNote&&(ja+=ka.sample.relativeNote)),g.useLinearFrequency)qa=7680-64*(ja-1);else{var ha=FTNotes[ja];ha&&(qa=ha.period)}var ea=
M.param;ha={};if(M.volumeEffect&&g.inFTMode()){var ma=M.volumeEffect;var fa=ma>>4;ba=ma&15;if(15<ma&&80>=ma)ia=pa=(ma-16)/64*100,P.volume={value:pa};else switch(fa){case 6:P.fade={value:-100*ba/64};break;case 7:P.fade={value:100*ba/64};break;case 8:P.fade={value:100*-ba/64,fine:!0};break;case 9:P.fade={value:100*ba/64,fine:!0};break;case 10:console.warn("set vibrato speed not implemented");break;case 11:console.warn("Vibrato not implemented");break;case 12:P.panning={value:17*(ma-192),slide:!1};break;
case 13:console.warn("Panning slide left not implemented - track "+da);P.panning={value:ma,slide:!0};break;case 14:console.warn("Panning slide right not implemented - track "+da);break;case 15:console.warn("Tone Porta not implemented")}}switch(M.effect){case 0:ea&&(fa=ea>>4,ba=ea&15,oa=0,ka=ka||g.getInstrument(I[da].currentInstrument),g.inFTMode()?ka&&(oa=ja||I[da].noteIndex,ea=ka.getPeriodForNote(oa,!0),ja===NOTEOFF?P.arpeggio=q[da].arpeggio:(P.arpeggio={root:ea,interval1:ea-ka.getPeriodForNote(oa+
fa,!0),interval2:ea-ka.getPeriodForNote(oa+ba,!0),step:1},q[da].arpeggio=P.arpeggio)):(ea=qa||I[da].startPeriod,ka&&(oa=ka.getFineTune())&&(ea=Audio.getFineTuneForPeriod(ea,oa)),P.arpeggio={root:ea,interval1:ea-Audio.getSemiToneFrom(ea,fa,oa),interval2:ea-Audio.getSemiToneFrom(ea,ba,oa),step:1}));M.instrument&&(P.volume={value:ia});break;case 1:ea*=-1;g.inFTMode()&&!ea&&q[da].slideUp&&(ea=q[da].slideUp.value);P.slide={value:ea};q[da].slideUp=P.slide;break;case 2:g.inFTMode()&&!ea&&q[da].slideDown&&
(ea=q[da].slideDown.value);P.slide={value:ea};q[da].slideDown=P.slide;break;case 3:na=!1;ba=qa;g.inFTMode()&&ja===NOTEOFF&&(ba=0);I[da].currentInstrument&&(la=I[da].currentInstrument);if(ba&&la){var ka=g.getInstrument(la);ka&&ka.getFineTune()&&(ba=g.inFTMode()?ka.getPeriodForNote(ja,!0):Audio.getFineTuneForPeriod(ba,ka.getFineTune()))}(fa=q[da].slide)&&!ea&&(ea=fa.value);ba||(ba=q[da].defaultSlideTarget);P.slide={value:ea,target:ba,canUseGlissando:!0,resetVolume:!!M.instrument,volume:ia};q[da].slide=
P.slide;M.instrument&&(P.volume={value:ia});break;case 4:M.instrument&&(I[da].startVolume&&(P.volume={value:pa}),I[da].vibratoTimer=0);fa=ea>>4;ba=ea&15;ia=fa*S/64;ea=q[da].vibrato;0==fa&&ea&&(ia=ea.freq);0==ba&&ea&&(ba=ea.amplitude);P.vibrato={amplitude:ba,freq:ia};q[da].vibrato=P.vibrato;break;case 5:na=!1;(ba=qa)&&la&&(ka=g.getInstrument(la))&&ka.getFineTune()&&(ba=g.inFTMode()?Audio.getFineTuneForNote(ja,ka.getFineTune()):Audio.getFineTuneForPeriod(ba,ka.getFineTune()));ea=1;if(fa=q[da].slide)ba||=
fa.target||0,ea=fa.value;P.slide={value:ea,target:ba};q[da].slide=P.slide;M.instrument&&(P.volume={value:ia});if(ea=M.param)ea=16>M.param?-1*ea:M.param>>4,P.fade={value:100*ea/64,resetOnStep:!!M.instrument},q[da].fade=P.fade;break;case 6:M.instrument&&(I[da].startVolume&&(P.volume={value:pa}),I[da].vibratoTimer=0);M.param?(ea=16>M.param?-1*ea:M.param&15,P.fade={value:100*ea/64},q[da].fade=P.fade):Tracker.inFTMode()&&q[da].fade&&(P.fade=q[da].fade);q[da].vibrato&&(P.vibrato=q[da].vibrato);break;case 7:qa&&
!M.instrument&&(I[da].startVolume&&(P.volume={value:pa}),I[da].tremoloTimer=0);fa=ea>>4;ea=ba=ea&15;ia=fa*S/64;oa=q[da].tremolo;0==fa&&oa&&(ia=oa.freq);0==ba&&oa&&(ea=oa.amplitude);P.tremolo={amplitude:ea,freq:ia};q[da].tremolo=P.tremolo;break;case 8:P.panning={value:ea,slide:!1};break;case 9:ea<<=8;!ea&&q[da].offset&&(ea=q[da].offset.stepValue||q[da].offset.value||0);ba=ea;SETTINGS.emulateProtracker1OffsetBug&&!M.instrument&&q[da].offset&&(ea+=q[da].offset.value);P.offset={value:ea,stepValue:ba};
q[da].offset=q[da].offset||{};q[da].offset.value=P.offset.value;q[da].offset.stepValue=P.offset.stepValue;SETTINGS.emulateProtracker1OffsetBug&&(M.instrument&&(q[da].offset.instrument=M.instrument),qa&&(q[da].offset.value+=ba));M.instrument&&(P.volume={value:ia});break;case 10:ea=16>M.param?-1*ea:M.param>>4;ea=100*ea/64;!M.param&&(ba=q[da].fade)&&(ea=ba.value);P.fade={value:ea,resetOnStep:!!M.instrument};g.inFTMode()&&(q[da].fade=P.fade);break;case 11:Tracker.autoPlay||(ha.patternBreak=!0,ha.positionBreak=
!0,ha.targetSongPosition=M.param,ha.targetPatternPosition=0);break;case 12:pa=M.param/64*100;P.volume={value:pa};break;case 13:ha.patternBreak=!0;ha.targetPatternPosition=10*(ea>>4)+(ea&15);break;case 14:ba=ea>>4;fa=ea&15;switch(ba){case 0:g.inFTMode()||Audio.setAmigaLowPassFilter(!fa,ca);break;case 1:fa*=-1;!fa&&q[da].fineSlide&&(fa=q[da].fineSlide.value);P.slide={value:fa,fine:!0};q[da].fineSlide=P.slide;break;case 2:!fa&&q[da].fineSlide&&(fa=q[da].fineSlide.value);P.slide={value:fa,fine:!0};q[da].fineSlide=
P.slide;break;case 3:q[da].glissando=!!fa;break;case 4:switch(fa){case 1:D=Audio.waveFormFunction.saw;break;case 2:D=Audio.waveFormFunction.square;break;case 3:D=Audio.waveFormFunction.sine;break;case 4:D=Audio.waveFormFunction.sine;break;case 5:D=Audio.waveFormFunction.saw;break;case 6:D=Audio.waveFormFunction.square;break;case 7:D=Audio.waveFormFunction.sine;break;default:D=Audio.waveFormFunction.sine}break;case 5:la&&(ka=g.getInstrument(la),P.fineTune={original:ka.getFineTune(),instrument:ka},
ka.setFineTune(fa));break;case 6:fa?(X[da]=X[da]||0,X[da]<fa?(X[da]++,ha.patternBreak=!0,ha.positionBreak=!0,ha.targetSongPosition=oa.position,ha.targetPatternPosition=K[da]||0,console.log("looping to "+ha.targetPatternPosition+" for "+X[da]+"/"+fa)):X[da]=0):(console.log("setting loop start to "+oa.step+" on track "+da),K[da]=oa.step);break;case 7:switch(fa){case 1:N=Audio.waveFormFunction.saw;break;case 2:N=Audio.waveFormFunction.square;break;case 3:N=Audio.waveFormFunction.sine;break;case 4:N=
Audio.waveFormFunction.sine;break;case 5:N=Audio.waveFormFunction.saw;break;case 6:N=Audio.waveFormFunction.square;break;case 7:N=Audio.waveFormFunction.sine;break;default:N=Audio.waveFormFunction.sine}break;case 8:console.warn("Set Panning - not implemented");break;case 9:fa&&(P.reTrigger={value:fa});break;case 10:P.fade={value:100*fa/64,fine:!0};break;case 11:P.fade={value:-(100*fa/64),fine:!0};break;case 12:fa?fa<S&&(P.cutNote={value:fa}):na=!1;break;case 13:fa&&(fa<S?ca+=W*fa:na=!1);break;case 14:ha.patternDelay=
fa;break;case 15:break;default:console.warn("Subeffect "+ba+" not implemented")}break;case 15:break;case 16:ea=Math.min(ea,64);g.isPlugin||Audio.setMasterVolume(ea/64,ca);break;case 17:fa=ea>>4;ba=ea&15;ia=64*Audio.getLastMasterVolume();ea=0;if(fa){var ra=ca+fa*W;ea=fa*(S-1)}else ba&&(ra=ca+ba*W,ea=-ba*(S-1));ea&&(ea=Math.max(0,(ia+ea)/64),ea=Math.min(1,ea),Audio.slideMasterVolume(ea,ra));break;case 20:g.inFTMode()&&(ba=ka||g.getInstrument(I[da].currentInstrument),M.param&&M.param>=S||(na=!1,ba?M.param?
(P.noteOff={value:M.param},na=!0):pa=ba.noteOff(ca,I[da]):console.log("no instrument on track "+da)));break;case 21:console.warn("Set envelope position not implemented");break;case 25:console.warn("Panning slide not implemented - track "+da);break;case 27:P.reTrigger={value:M.param};break;case 29:console.warn("Tremor not implemented");break;case 33:console.warn("Extra fine porta not implemented");break;default:console.warn("unhandled effect: "+M.effect)}na&&la&&qa&&(f(da,ca),I[da]={},ka&&(I[da]=ka.play(ja,
qa,pa,da,P,ca)),q[da].defaultSlideTarget=I[da].startPeriod);la&&(I[da].currentInstrument=la,P.fineTune&&P.fineTune.instrument&&P.fineTune.instrument.setFineTune(P.fineTune.original||0));ka&&ka.hasVibrato()&&(I[da].hasAutoVibrato=!0);I[da].effects=P;I[da].note=M;M=ha;M.patternBreak&&(T.patternBreak=!0,T.targetPatternPosition=M.targetPatternPosition||0);M.positionBreak&&(T.positionBreak=!0,T.targetPatternPosition=M.targetPatternPosition||0,T.targetSongPosition=M.targetSongPosition||0);M.patternDelay&&
(T.patternDelay=M.patternDelay)}for(aa=0;aa<Z;aa++)e(aa,L);return T}function f(C,L){try{if(I[C].source){var x=I[C].volume.gain;x.setValueAtTime(I[C].currentVolume/100,L-.002);x.linearRampToValueAtTime(0,L);I[C].source.stop(L+.02)}}catch(H){}}function h(C,L){var x=g.getInstrument(C.instrumentIndex);if(x){var H=-x.vibrato.rate/40,Z=x.vibrato.depth/8;g.useLinearFrequency&&(Z*=4);C.vibratoTimer=C.vibratoTimer||0;x.vibrato.sweep&&C.vibratoTimer<x.vibrato.sweep&&(Z*=1-(x.vibrato.sweep-C.vibratoTimer)/x.vibrato.sweep);
L=x.getAutoVibratoFunction()(L,C.vibratoTimer,H,Z);C.vibratoTimer++;return L}return L}function e(C,L){var x=I[C],H=x.effects;if(x&&H){var Z=!1;x.startVibratoTimer=x.vibratoTimer||0;if(x.resetPeriodOnStep&&x.source){var T=x.currentPeriod||x.startPeriod;g.setPeriodAtTime(x,T,L);x.resetPeriodOnStep=!1}if(H.volume){var M=H.volume.value;x.volume&&x.volume.gain.setValueAtTime(M/100,L);x.currentVolume=M}if(H.panning){var aa=H.panning.value;255===aa&&(aa=254);x.panning&&x.panning.pan.setValueAtTime((aa-127)/
127,L)}if(H.fade){aa=H.fade.value;M=1;var P=H.fade.resetOnStep?x.startVolume:x.currentVolume;var ca=S;H.fade.fine&&(M=0,ca=1);for(;M<ca;M++)x.volume&&(x.volume.gain.setValueAtTime(P/100,L+M*W),P+=aa,P=Math.max(P,0),P=Math.min(P,100));x.currentVolume=P}if(H.slide&&x.source)for(T=aa=x.currentPeriod||x.startPeriod,ca=S,H.slide.fine&&(ca=2),P=H.slide.value,g.inFTMode()&&g.useLinearFrequency&&(P=4*H.slide.value),aa=Math.abs(P),g.inFTMode()&&H.slide.resetVolume&&(x.volumeFadeOut||x.volumeEnvelope)&&(M=
g.getInstrument(x.instrumentIndex))&&M.resetVolume(L,x),x.vibratoTimer=x.startVibratoTimer,M=1;M<ca;M++){H.slide.target?(q[C].defaultSlideTarget=H.slide.target,T<H.slide.target?(T+=aa,T>H.slide.target&&(T=H.slide.target)):(T-=aa,T<H.slide.target&&(T=H.slide.target))):(T+=P,q[C].defaultSlideTarget&&(q[C].defaultSlideTarget+=P));g.inFTMode()||(T=Audio.limitAmigaPeriod(T));var ba=T;H.slide.canUseGlissando&&q[C].glissando&&(ba=Audio.getNearestSemiTone(T,x.instrumentIndex));T!==x.currentPeriod&&(x.currentPeriod=
T,x.hasAutoVibrato&&g.inFTMode()&&(T=h(x,ba),Z=!0),g.setPeriodAtTime(x,ba,L+M*W))}if(H.arpeggio&&x.source)for(aa=x.currentPeriod||x.startPeriod,x.resetPeriodOnStep=!0,x.vibratoTimer=x.startVibratoTimer,M=0;M<S;M++)ca=M%3,0==ca&&(T=aa),1==ca&&H.arpeggio.interval1&&(T=aa-H.arpeggio.interval1),2==ca&&H.arpeggio.interval2&&(T=aa-H.arpeggio.interval2),x.hasAutoVibrato&&g.inFTMode()&&(T=h(x,T),Z=!0),g.setPeriodAtTime(x,T,L+M*W);if(H.vibrato||x.hasAutoVibrato&&!Z)if(H.vibrato=H.vibrato||{freq:0,amplitude:0},
Z=H.vibrato.freq,ca=H.vibrato.amplitude,g.inFTMode()&&g.useLinearFrequency&&(ca*=4),x.vibratoTimer=x.vibratoTimer||0,x.source)for(x.resetPeriodOnStep=!0,aa=x.currentPeriod||x.startPeriod,x.vibratoTimer=x.startVibratoTimer,M=0;M<S;M++)T=D(aa,x.vibratoTimer,Z,ca),x.hasAutoVibrato&&g.inFTMode()?T=h(x,T):x.vibratoTimer++,g.setPeriodAtTime(x,T,L+M*W);if(H.tremolo&&(Z=H.tremolo.freq,ca=H.tremolo.amplitude,x.tremoloTimer=x.tremoloTimer||0,x.volume))for(T=x.startVolume,M=0;M<S;M++)T=N(T,x.tremoloTimer,Z,
ca),0>T&&(T=0),100<T&&(T=100),x.volume.gain.setValueAtTime(T/100,L+M*W),x.currentVolume=T,x.tremoloTimer++;H.cutNote&&(x.volume&&x.volume.gain.setValueAtTime(0,L+H.cutNote.value*W),x.currentVolume=0);H.noteOff&&(M=g.getInstrument(x.instrumentIndex))&&(x.currentVolume=M.noteOff(L+H.noteOff.value*W,x));if(H.reTrigger)for(T=x.instrumentIndex,Z=x.startPeriod,M=x.startVolume,x=x.noteIndex,ca=aa=H.reTrigger.value||1;ca<S;)P=L+ca*W,f(C,P),I[C]=Audio.playSample(T,Z,M,C,H,P,x),ca+=aa}}function b(){UI&&UI.setInfo(r.title);
r.channels&&g.setTrackCount(r.channels);w=B=z=E=void 0;g.setCurrentSongPosition(0);g.setCurrentPatternPos(0);g.setCurrentInstrumentIndex(1);g.clearEffectCache();EventBus.trigger(EVENT.songLoaded,r);EventBus.trigger(EVENT.songPropertyChange,r)}function c(){EventBus.trigger(EVENT.songBPMChangeIgnored,0);EventBus.trigger(EVENT.songSpeedChangeIgnored,0);g.setAmigaSpeed(6);g.setBPM(125);N=D=Audio.waveFormFunction.sine;q=[];I=[];for(var C=0;C<F;C++)I.push({}),q.push({});g.useLinearFrequency=!1;g.setTrackerMode(TRACKERMODE.PROTRACKER,
!0);g.isPlugin||Audio.setMasterVolume(1);Audio.setAmigaLowPassFilter(!1,0);"undefined"!==typeof StateManager&&StateManager.clear()}function m(){for(var C=[],L=0;L<J;L++){var x=[],H;for(H=0;H<F;H++)x.push(Note());C.push(x)}return C}var g={isMaster:!0},k,l=!1,n=!1,r,t=[],p=1,z,y=0,B,A=0,E,U=PLAYTYPE.song,Q,u=0,w=0,D,N,R=125,S=6,W=2.5/R,G,F=4,J=64,V=TRACKERMODE.PROTRACKER,O=0,I=[],q=[],v=[],K=[],X=[];g.init=function(C){for(var L=0;L<F;L++)I.push({}),q.push({});for(L=-8;8>L;L++)periodFinetuneTable[L]=
{};for(var x in NOTEPERIOD)if(NOTEPERIOD.hasOwnProperty(x)){var H=NOTEPERIOD[x];periodNoteTable[H.period]=H;nameNoteTable[H.name]=H;noteNames.push(H.name);if(H.tune)for(L=-8;8>L;L++)periodFinetuneTable[L][H.tune[L+8]]=H.period}L=0;for(x in FTNOTEPERIOD)FTNOTEPERIOD.hasOwnProperty(x)&&(H=FTNOTEPERIOD[x],H.period||(H.period=1),FTNotes.push(H),FTPeriods[H.period]=L,H.modPeriod&&(FTPeriods[H.modPeriod]=L),L++);C&&(Host.init(),Audio.init(C.audioContext,C.audioDestination),C.plugin&&(g.isPlugin=!0,UI.initPlugin(C),
"boolean"===typeof C.isMaster&&(g.isMaster=C.isMaster),C.handler&&(EventBus.on(EVENT.songBPMChange,function(Z){C.handler(EVENT.songBPMChange,Z)}),EventBus.on(EVENT.songBPMChangeIgnored,function(Z){C.handler(EVENT.songBPMChangeIgnored,Z)}),EventBus.on(EVENT.songSpeedChange,function(Z){C.handler(EVENT.songSpeedChange,Z)}),EventBus.on(EVENT.songSpeedChangeIgnored,function(Z){C.handler(EVENT.songSpeedChangeIgnored,Z)}),EventBus.on(EVENT.patternEnd,function(Z){C.handler(EVENT.patternEnd,Z)}))))};g.setMaster=
function(C){g.isMaster=C};g.isMaster=function(){return!!g.isMaster};g.setCurrentInstrumentIndex=function(C){if(r.instruments[C])p=C,z!=p&&EventBus.trigger(EVENT.instrumentChange,p),z=p;else if(C<=g.getMaxInstruments()){for(var L=r.instruments.length;L<=C;L++)g.setInstrument(L,Instrument());var x=[];for(L=1;L<=C;L++)x.push({label:L+" "+(r.instruments[L]||{name:""}).name,data:L}),EventBus.trigger(EVENT.instrumentListChange,x);p=C;z!=p&&EventBus.trigger(EVENT.instrumentChange,p);z=p}};g.getCurrentInstrumentIndex=
function(){return p};g.getCurrentInstrument=function(){return t[p]};g.getMaxInstruments=function(){return g.inFTMode()?128:31};g.setCurrentPattern=function(C){y=C;Q=r.patterns[y];Q||(Q=m(),r.patterns[y]=Q);J=Q.length;B!=y&&EventBus.trigger(EVENT.patternChange,y);B=y};g.getCurrentPattern=function(){return y};g.getCurrentPatternData=function(){return Q};g.updatePatternTable=function(C,L){r.patternTable[C]=L;EventBus.trigger(EVENT.patternTableChange,L);C==u&&(B=void 0,Tracker.setCurrentPattern(L))};
g.setCurrentPatternPos=function(C){A=C;E!=A&&EventBus.trigger(EVENT.patternPosChange,{current:A,prev:E});E=A};g.getCurrentPatternPos=function(){return A};g.moveCurrentPatternPos=function(C){C=A+C;var L=J-1;0>C&&(C=L);C>L&&(C=0);g.setCurrentPatternPos(C)};g.getCurrentSongPosition=function(){return u};g.setCurrentSongPosition=function(C,L){u=C;u!=w&&(EventBus.trigger(EVENT.songPositionChange,u),r.patternTable&&g.setCurrentPattern(r.patternTable[u]),w=u,L&&g.isPlaying()&&(g.stop(),g.togglePlay()))};
g.setPlayType=function(C){U=C;EventBus.trigger(EVENT.playTypeChange,U)};g.getPlayType=function(){return U};g.playSong=function(){g.stop();Audio.checkState();g.setPlayType(PLAYTYPE.song);n=!0;d(y);EventBus.trigger(EVENT.playingChange,n)};g.playPattern=function(){g.stop();Audio.checkState();A=0;g.setPlayType(PLAYTYPE.pattern);n=!0;d(y);EventBus.trigger(EVENT.playingChange,n)};g.stop=function(){k&&k.stop();Audio.disable();g.isPlugin||Audio.setMasterVolume(1);UI&&(UI.setStatus("Ready"),Input.clearInputNotes());
g.clearEffectCache();for(var C=0;C<F;C++)if(I[C].source)try{I[C].source.stop()}catch(L){}n=!1;EventBus.trigger(EVENT.playingChange,n)};g.pause=function(){k&&k.stop();n=!1;EventBus.trigger(EVENT.playingChange,n)};g.togglePlay=function(){g.isPlaying()?g.stop():U==PLAYTYPE.pattern?g.playPattern():g.playSong()};g.getProperties=function(){return{ticksPerStep:S,tickTime:W}};g.playPatternStep=a;g.cutNote=f;g.setBPM=function(C,L){L=L&&L.isMaster;g.isMaster||L?(console.log("set BPM: "+R+" to "+C),k&&k.timeStretch(Audio.context.currentTime,
[G],R/C),L||EventBus.trigger(EVENT.songBPMChangeIgnored,R),R=C,W=2.5/R,EventBus.trigger(EVENT.songBPMChange,R)):EventBus.trigger(EVENT.songBPMChangeIgnored,C)};g.getBPM=function(){return R};g.setAmigaSpeed=function(C,L){L=L&&L.isMaster;g.isMaster||L?(S=C,EventBus.trigger(EVENT.songSpeedChange,C)):EventBus.trigger(EVENT.songSpeedChangeIgnored,C)};g.getAmigaSpeed=function(){return S};g.getSwing=function(){return O};g.setSwing=function(C){O=C};g.getPatternLength=function(){return J};g.setPatternLength=
function(C){J=C;C=r.patterns[y].length;if(C!==J){if(C<J)for(;C<J;C++){var L=[],x;for(x=0;x<F;x++)L.push(Note());r.patterns[y].push(L)}else r.patterns[y]=r.patterns[y].splice(0,J),A>=J&&g.setCurrentPatternPos(J-1);EventBus.trigger(EVENT.patternChange,y)}};g.getTrackCount=function(){return F};g.setTrackCount=function(C){F=C;for(C=I.length;C<F;C++)I.push({});for(C=q.length;C<F;C++)q.push({});EventBus.trigger(EVENT.trackCountChange,F)};g.toggleRecord=function(){g.stop();l=!l;EventBus.trigger(EVENT.recordingChange,
l)};g.isPlaying=function(){return n};g.isRecording=function(){return l};g.setStateAtTime=function(C,L){v.push({time:C,state:L})};g.getStateAtTime=function(C){for(var L=void 0,x=0,H=v.length;x<H;x++)if(v[0].time<C)L=v.shift().state;else break;return L};g.getTimeStates=function(){return v};g.setPeriodAtTime=function(C,L,x){L=Math.max(L,1);g.inFTMode()&&g.useLinearFrequency?L=8363*Math.pow(2,(4608-L)/768)/Audio.context.sampleRate:(L=C.startPeriod/L,L*=C.startPlaybackRate);C.source.playbackRate.setValueAtTime(L,
x);C.source.playbackRate.setValueAtTime(L,x+.005)};g.load=function(C,L,x,H){C=C||"demomods/StardustMemories.mod";0>C.indexOf("://")&&0!==C.indexOf("/")&&(C=Host.getBaseUrl()+C);UI&&(UI.setInfo(""),UI.setLoading());var Z=function(M){H&&!Host.useInitialLoad||g.processFile(M,T,function(aa){UI&&UI.setStatus("Ready");if(aa){var P="",ca="";if("string"===typeof C){if(0<C.indexOf("modarchive.org")){var ba=C.split("moduleid=")[1];r.filename=ba.split("#")[1]||ba;ba=ba.split("#")[0];ba=ba.split("&")[0];ca="modArchive";
P="https://modarchive.org/index.php?request=view_by_moduleid&query="+ba;EventBus.trigger(EVENT.songPropertyChange,r)}0<C.indexOf("modules.pl")&&(ba=C.split("modules.pl/")[1],r.filename=ba.split("#")[1]||ba,ba=ba.split("#")[0],ba=ba.split("&")[0],ca="modules.pl",P="http://www.modules.pl/?id=module&mod="+ba,EventBus.trigger(EVENT.songPropertyChange,r));0<C.indexOf("&path=")&&(ba=C.split("&path=")[1],ba=ba.split(":")[1]||ba,ba=ba.split("#")[0],ba=ba.split("&")[0],r.filename=ba,EventBus.trigger(EVENT.songPropertyChange,
r))}UI&&UI.setInfo(r.title,ca,P)}UI&&aa&&!L&&(P=window.location.pathname,P=P.substring(P.lastIndexOf("/")+1),window.history.pushState&&window.history.pushState({},T,P+"?file="+encodeURIComponent(C)));aa&&(aa=L,P=getUrlParameter("autoplay"),Tracker.autoPlay&&(P="1"),!UI&&aa&&(P="1"),"true"!=P&&"1"!=P||Tracker.playSong());x&&x()})},T="";"string"===typeof C?(T=C.substr(C.lastIndexOf("/")+1),loadFile(C,function(M){Z(M)})):(T=C.name||"",L=!0,Z(C.buffer||C))};g.handleUpload=function(C){console.log("file uploaded");
if(C.length){var L=C[0],x=new FileReader;x.onload=function(){g.processFile(x.result,L.name,function(H){UI&&UI.setStatus("Ready")})};x.readAsArrayBuffer(L)}};g.processFile=function(C,L,x){var H=!1,Z=new BinaryStream(C,!0),T=FileDetector.detect(Z,L);if(T&&"ZIP"==T.name)if(console.log("extracting zip file"),UI&&UI.setStatus("Extracting Zip file",!0),"undefined"!==typeof UZIP)for(L in C=UZIP.parse(C),console.log(C),C){g.processFile(C[L].buffer,L,x);break}else zip.workerScriptsPath="script/src/lib/zip/",
zip.useWebWorkers=Host.useWebWorkers,zip.createReader(new zip.ArrayBufferReader(C),function(M){var aa,P=0;M.getEntries(function(ca){ca&&ca.length&&ca.forEach(function(ba){ba.uncompressedSize>P&&(P=ba.uncompressedSize,aa=ba)});aa?aa.getData(new zip.ArrayBufferWriter,function(ba){ba&&ba.byteLength&&g.processFile(ba,L,x)}):(console.error("Zip file could not be read ..."),x&&x(!1))})},function(M){console.error("Zip file could not be read ...");x&&x(!1)});T.isMod&&T.loader&&(H=!0,g.isPlaying()&&g.stop(),
c(),r=T.loader().load(Z,L),r.filename=L,b());T.isSample&&"undefined"!==typeof Editor&&Editor.importSample(Z,L);x&&x(H)};g.getSong=function(){return r};g.getInstruments=function(){return t};g.getInstrument=function(C){return t[C]};g.setInstrument=function(C,L){L.instrumentIndex=C;t[C]=L};g.clearEffectCache=function(){q=[];for(var C=0;C<F;C++)q.push({})};g.clearInstruments=function(C){if(r){var L=[];C=C||r.instruments.length-1;t=[];for(i=1;i<=C;i++)g.setInstrument(i,Instrument()),L.push({label:i+" ",
data:i});r.instruments=t;EventBus.trigger(EVENT.instrumentListChange,L);EventBus.trigger(EVENT.instrumentChange,p)}};g.setTrackerMode=function(C,L){var x=function(){V=C;SETTINGS.emulateProtracker1OffsetBug=!g.inFTMode();EventBus.trigger(EVENT.trackerModeChanged,C)};C!==TRACKERMODE.PROTRACKER||L?x():32<Tracker.getInstruments().length?UI.showDialog("WARNING !!!//This file has more than 31 instruments./If you save this file as .MOD, only the first 31 instruments will be included.//Are you sure you want to continue?",
function(){x()},function(){}):x()};g.getTrackerMode=function(){return V};g.inFTMode=function(){return V===TRACKERMODE.FASTTRACKER};g.new=function(){c();r={patterns:[],instruments:[]};g.clearInstruments(31);r.typeId="M.K.";r.title="new song";r.length=1;r.restartPosition=0;r.patterns.push(m());for(var C=[],L=0;128>L;++L)C[L]=0;r.patternTable=C;b()};g.clearInstrument=function(){t[p]=Instrument();EventBus.trigger(EVENT.instrumentChange,p);EventBus.trigger(EVENT.instrumentNameChange,p)};g.getFileName=
function(){return r.filename||(r.title?r.title.replace(/ /g,"-").replace(/\W/g,"")+".mod":"new.mod")};g.useLinearFrequency=!0;return g}();var Editor=function(){var d={},a=0,f=0,h=0,e,b=0,c=0,m={};d.getStepsPerTrack=function(){return Tracker.inFTMode()?8:6};d.setCurrentCursorPosition=function(g){h=g;g=d.getStepsPerTrack();a=Math.floor(h/g);f=h%g;e!==h&&EventBus.trigger(EVENT.cursorPositionChange,h);e=h};d.getCurrentCursorPosition=function(){return h};d.moveCursorPosition=function(g){var k=d.getStepsPerTrack();g=h+g;k=Tracker.getTrackCount()*k-1;g>k&&(g=0);0>g&&(g=k);d.setCurrentCursorPosition(g)};d.getCurrentTrack=function(){return a};
d.setCurrentTrack=function(g){var k=d.getStepsPerTrack();d.setCurrentCursorPosition(g*k+f)};d.getCurrentTrackPosition=function(){return f};d.setCurrentTrackPosition=function(g){var k=d.getStepsPerTrack();d.setCurrentCursorPosition(a*k+g)};d.putNote=function(g,k,l,n){var r=Tracker.getSong().patterns[b][c][a]||new Note,t=StateManager.createNoteUndo(b,a,c,r);r&&(r.instrument=g,l?r.setIndex(l):r.setPeriod(k),"number"===typeof n&&(Tracker.inFTMode()?r.volumeEffect=n+16:(r.effect=12,r.param=n)));t.data[0].to=
r.duplicate();StateManager.registerEdit(t);Tracker.getSong().patterns[b][c][a]=r;EventBus.trigger(EVENT.patternChange,b)};d.putNoteParam=function(g,k){var l=Tracker.getSong().patterns[b][c][a],n=StateManager.createNoteUndo(b,a,c,l);if(l){if(1==g||2==g){var r=l.instrument;var t=r>>4;var p=r&15;1==g&&(t=k);2==g&&(p=k);l.instrument=(t<<4)+p}r=0;Tracker.inFTMode()&&(r=2,3==g||4==g)&&(p=l.volumeEffect,t=p>>4||1,p&=15,3==g&&(t=k+1),4==g&&(p=k),l.volumeEffect=(t<<4)+p,16>l.volumeEffect&&(l.volumeEffect=
0));g==3+r&&(l.effect=k);if(g==4+r||g==5+r)p=l.param,t=p>>4,p&=15,g==4+r&&(t=k),g==5+r&&(p=k),l.param=(t<<4)+p}n.data[0].to=l.duplicate();StateManager.registerEdit(n);Tracker.getSong().patterns[b][c][a]=l;EventBus.trigger(EVENT.patternChange,b)};d.clearTrack=function(){var g=Tracker.getCurrentPatternData().length,k=StateManager.createTrackUndo(b);k.name="Clear Track";for(var l=0;l<g;l++){var n=Tracker.getSong().patterns[b][l][a];n&&(StateManager.addNote(k,a,l,n),n.clear())}StateManager.registerEdit(k);
EventBus.trigger(EVENT.patternChange,b)};d.clearPattern=function(){var g=Tracker.getCurrentPatternData().length,k=StateManager.createPatternUndo(b);k.name="Clear Pattern";for(var l=0;l<g;l++)for(var n=0;n<Tracker.getTrackCount();n++){var r=Tracker.getSong().patterns[b][l][n];r&&(StateManager.addNote(k,n,l,r),r.clear())}StateManager.registerEdit(k);EventBus.trigger(EVENT.patternChange,b)};d.clearSong=function(){var g=Tracker.getSong();Tracker.setCurrentPattern(0);d.clearPattern();g.patterns=[g.patterns[0]];
g.length=1;g.restartPosition=0;for(var k=[],l=0;128>l;++l)k[l]=0;g.patternTable=k;Tracker.setAmigaSpeed(6);Tracker.setBPM(125);Tracker.setCurrentSongPosition(1);EventBus.trigger(EVENT.songPropertyChange,g);EventBus.trigger(EVENT.patternTableChange)};d.copyTrack=function(g){var k="undefined"!=typeof g;k||(g=a);for(var l=Tracker.getCurrentPatternData().length,n=[],r=0;r<l;r++){var t=Tracker.getSong().patterns[b][r][g]||new Note;n.push(t.duplicate())}if(k)return n;m.track=n};d.copyPattern=function(){for(var g=
[],k=0;k<Tracker.getTrackCount();k++){var l=d.copyTrack(k);g.push(l)}m.pattern=g};d.getPasteData=function(){return m};d.pasteTrack=function(g,k,l){var n="undefined"!=typeof g;n||(g=a,k=m.track);if(k){if(l)var r=l;else r=StateManager.createTrackUndo(b),r.name="Paste Track";for(var t=Tracker.getCurrentPatternData().length,p=Tracker.getSong().patterns[b],z=0;z<t;z++){var y=p[z][g];y||(y=new Note,p[z][g]=y);var B=k[z];StateManager.addNote(r,g,z,y).to=B;y.populate(B)}n||EventBus.trigger(EVENT.patternChange,
b);l||StateManager.registerEdit(r);return!0}return!1};d.pastePattern=function(){var g=m.pattern;if(g){var k=StateManager.createPatternUndo(b);k.name="Paste Pattern";for(var l=0;l<Tracker.getTrackCount();l++)d.pasteTrack(l,g[l],k);StateManager.registerEdit(k);EventBus.trigger(EVENT.patternChange,b);return!0}return!1};d.insertNote=function(){for(var g=Tracker.getSong().patterns[b].length-2,k=c;g>=k;g--){var l=Tracker.getSong().patterns[b][g][a],n=Tracker.getSong().patterns[b][g+1][a];n.instrument=l.instrument;
n.period=l.period;n.effect=l.effect;n.volumeEffect=l.volumeEffect;n.param=l.param;n.index=l.index}(l=Tracker.getSong().patterns[b][c][a])&&l.clear();EventBus.trigger(EVENT.patternChange,b)};d.removeNote=function(g,k){"undefined"===typeof g&&(g=a);"undefined"===typeof k&&(k=c);if(0!==k){var l=k;for(k=Tracker.getSong().patterns[b].length-1;l<=k;l++){var n=Tracker.getSong().patterns[b][l][g],r=Tracker.getSong().patterns[b][l-1][g];r.instrument=n.instrument;r.period=n.period;r.effect=n.effect;r.volumeEffect=
n.volumeEffect;r.param=n.param;r.index=n.index}(n=Tracker.getSong().patterns[b][k][g])&&n.clear();EventBus.trigger(EVENT.patternChange,b)}};d.addToPatternTable=function(g,k){var l=Tracker.getSong();"undefined"==typeof g&&(g=l.length);if(g!==l.length)for(var n=l.length;n>g;n--)l.patternTable[n]=l.patternTable[n-1];l.patternTable[g]=k||0;l.length++;EventBus.trigger(EVENT.songPropertyChange,l);EventBus.trigger(EVENT.patternTableChange)};d.removeFromPatternTable=function(g){var k=Tracker.getSong();if(!(2>
k.length)){"undefined"==typeof g&&(g=k.length-1);if(g===k.length-1)k.patternTable[g]=0;else for(;g<k.length;g++)k.patternTable[g]=k.patternTable[g+1];k.length--;g=Tracker.getCurrentSongPosition();g===k.length&&Tracker.setCurrentSongPosition(g-1);EventBus.trigger(EVENT.songPropertyChange,k);EventBus.trigger(EVENT.patternTableChange)}};d.renderTrackToBuffer=function(g,k){g=Tracker.getSong();k=0;var l=Tracker.getCurrentSongPosition(),n=Tracker.getCurrentPatternData().length,r=.1;l=Tracker.getProperties();
var t=l.ticksPerStep,p=l.tickTime;l=0;var z=Math.min(l+1,g.length);for(Audio.startRendering(t*p*n*(z-l)+.2);l<z;){console.log("rendering step "+l);var y=g.patterns[g.patternTable[l]];for(n=y.length;k<n;)Tracker.playPatternStep(k,r,y),r+=t*p,k++;k=0;l++}Audio.stopRendering(function(B){d.buffer2Sample(B)})};d.save=function(g,k){UI.setStatus("Exporting ...",!0);d.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(l){l=new Blob([l.buffer],{type:"application/octet-stream"});var n=g||
Tracker.getFileName();"function"===typeof k?k(l):"dropbox"===k?(Logger.info("save to dropbox "+n),Dropbox.putFile("/"+n,l,function(r){r?UI.setStatus(""):UI.setStatus("Error while saving to Dropbox ...")})):(Logger.info("save "+n),saveAs(l,n),UI.setStatus(""))})};d.importSample=function(g,k){console.log("Reading instrument "+k+" with length of "+g.length+" bytes to index "+Tracker.getCurrentInstrumentIndex());var l=Tracker.getCurrentInstrument()||Instrument();l.name=k;l.sample.length=g.length;l.sample.loop.start=
0;l.sample.loop.length=0;l.setFineTune(0);l.sample.volume=64;l.sample.data=[];l.sample.name=k;detectSampleType(g,l.sample,function(){EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex());EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex());if(Tracker.getTrackerMode()===TRACKERMODE.PROTRACKER&&131070<l.sample.length){var n=UI.modalDialog();n.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0});n.onClick=n.close;n.setText("Warning//The maximum sample lenght in .MOD format is 128kb//If you save in .MOD format/this sample will be truncated.//Please try downsampling or trimming the sample/to below 131072 bytes/or switch to .XM format");
UI.setModalElement(n)}});EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex());EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex())};d.buffer2Sample=function(g){var k=Tracker.getCurrentInstrument()||Instrument(),l="pattern "+Tracker.getCurrentPattern();k.name=l;k.sample.loop.start=0;k.sample.loop.length=0;k.setFineTune(0);k.sample.volume=64;k.sample.name=l;g=g.getChannelData(0);k.sample.data=[];i=Math.floor(Audio.context.sampleRate/10);for(len=g.length;i<
len;i+=4)k.sample.data.push(g[i]);k.sample.length=k.sample.data.length;EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex());EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex())};d.buildBinary=function(g,k){g=g||MODULETYPE.mod;var l;g===MODULETYPE.mod&&(l=ProTracker());g===MODULETYPE.xm&&(l=FastTracker());l&&l.write(k)};d.loadInitialFile=function(){var g=getUrlParameter("file");g?(g=decodeURIComponent(g),"http://"===g.substr(0,7).toLowerCase()&&"https:"===
document.location.protocol?g=BassoonProvider.proxyUrl(g):"proxy/"===g.substr(0,6).toLowerCase()&&(g=BassoonProvider.proxyUrl(g.substr(6)))):SETTINGS.loadInitialFile&&(g=Host.initialFile||Host.getBaseUrl()+"/static/bassoontracker/demomods/Tinytune.mod");g&&Tracker.load(g,!0,void 0,!0)};EventBus.on(EVENT.trackerModeChanged,function(g){d.setCurrentTrackPosition(0)});EventBus.on(EVENT.patternChange,function(g){b=g});EventBus.on(EVENT.patternPosChange,function(g){c=g.current});EventBus.on(EVENT.trackCountChange,
function(g){var k=g*d.getStepsPerTrack();h>=k&&d.setCurrentTrack(g-1)});return d}();var PreLoader=function(){var d={load:function(f,h,e){d.type=h||PRELOADTYPE.image;d.loadCount=0;d.max=f.length;d.next=e;h=0;for(e=f.length;h<e;h++)a(f[h])}},a=function(f){if(d.type==PRELOADTYPE.image){var h=new Image;h.onload=function(){cachedAssets.images[f]=this;++d.loadCount==d.max&&d.next&&d.next()};h.onerror=function(){alert("BufferLoader: XHR error")};h.src=f}if(d.type==PRELOADTYPE.audio){var e=new XMLHttpRequest;e.responseType="arraybuffer";e.open("GET",f,!0);e.onload=function(){Audio.context.decodeAudioData(e.response,
function(b){b?(cachedAssets.audio[f]=b,++d.loadCount==d.max&&d.next&&d.next()):alert("error decoding file data: "+f)},function(b){console.error("decodeAudioData error",b)})};e.onerror=function(){alert("BufferLoader: XHR error")};e.send()}};return d};var FetchService=function(){var d={get:function(a,f){d.ajax({url:a,success:function(h){f(h)},error:function(h){f(void 0,h)}})},post:function(a,f,h){var e=f;if("object"===typeof f){e="";for(var b in f)f.hasOwnProperty(b)&&(e+="&"+b+"="+encodeURIComponent(f[b]));e.length&&(e=e.substr(1))}d.ajax({method:"POST",url:a,data:e,datatype:"form",success:function(c){h(c)},error:function(c){h(void 0,c)}})},sendBinary:function(a,f,h){d.ajax({method:"POST",url:a,data:f,success:function(e){h(e)},error:function(e){h(void 0,
e)}})},json:function(a,f){"undefined"==typeof f&&(f=function(){});d.ajax({url:a,cache:!1,datatype:"json",headers:[{key:"Accept",value:"application/json"}],success:function(h){f(h)},error:function(h){f(void 0,h)}})},html:function(a,f){d.ajax({url:a,cache:!1,datatype:"html",success:function(h){f(h)},error:function(h){f(void 0,h)}})},ajax:function(a){var f=new XMLHttpRequest;a.error=a.error||function(){a.success(!1)};"jsonp"===a.datatype&&(console.error(log.error()+" ERROR: JSONP is not supported!"),
a.error(f));var h=a.url;if("boolean"===typeof a.cache&&!a.cache&&Host.useUrlParams){var e=(new Date).getTime();h+=0<h.indexOf("?")?"&r="+e:"?r="+e}e=a.method||"GET";f.onreadystatechange=function(){if(!(4>f.readyState)&&4===f.readyState)if(200!==f.status&&201!==f.status)a.error(f);else{var c=f.responseText;if("json"===a.datatype)try{c=JSON.parse(f.responseText)}catch(m){console.error("Error parsing json from "+h),c={}}"html"===a.datatype&&(c=document.createElement("div"),c.innerHTML=f.responseText);
a.success(c)}};f.ontimeout=function(c){console.error(log.error()+"timeout while getting "+h)};f.open(e,h,!0);f.timeout=a.timeout||3E4;a.headers&&a.headers.forEach(function(c){f.setRequestHeader(c.key,c.value)});var b=a.data||"";"POST"===e&&a.data&&"form"===a.datatype&&f.setRequestHeader("Content-type","application/x-www-form-urlencoded");f.send(b)}};return d}();var Storage=function(){return{get:function(d){return localStorage.getItem(d)},set:function(d,a){return localStorage.setItem(d,a)}}}();var Settings=function(){function d(){SETTINGS.keyboardTable="qwerty";SETTINGS.vubars="colour";SETTINGS.stereoSeparation=STEREOSEPARATION.BALANCED;SETTINGS.dropboxMode="rename";SETTINGS.skipFrame=1;SETTINGS.canvasId="canvas";SETTINGS.midi="disabled";UI.skipFrame(SETTINGS.skipFrame);SETTINGS.highDPI=!1;SETTINGS.showKey=!1;SETTINGS.showMidi=!1}var a={readSettings:function(){var f=Storage.get("bassoonTrackerSettings");try{f=JSON.parse(f)}catch(h){f=void 0}a.set(f)},saveSettings:function(){var f={vubars:SETTINGS.vubars,
keyboardTable:SETTINGS.keyboardTable,stereoSeparation:SETTINGS.stereoSeparation,dropboxMode:SETTINGS.dropboxMode,skipFrame:UI.getSkipFrame(),midi:SETTINGS.midi,highDPI:SETTINGS.highDPI,showKey:SETTINGS.showKey,showMidi:SETTINGS.showMidi};Storage.set("bassoonTrackerSettings",JSON.stringify(f))},reset:function(){d();a.saveSettings()},set:function(f){d();if(f){for(var h in f)if(SETTINGS.hasOwnProperty(h)&&f.hasOwnProperty(h)&&(SETTINGS[h]=f[h],"skipFrame"===h)){var e=parseInt(SETTINGS[h],10);isNaN(e)||
UI.skipFrame(e)}SETTINGS.stereoSeparation&&Audio.setStereoSeparation(SETTINGS.stereoSeparation);SETTINGS.highDPI&&UI.scaleToDevicePixelRatio(SETTINGS.highDPI)}}};return a}();var Logger=function(){var d=function(a,f){var h=UI.stats(),e="undefined"==typeof versionNumber?"dev":versionNumber;f=createSlug(f);FetchService.get("https://www.stef.be/bassoontracker/api/log/"+a+"/"+f+"/"+h.averageFps+"/"+h.skipRenderSteps+"/"+e+"/"+canvas.width+"x"+canvas.height+"/"+h.averageRenderFps+"/"+devicePixelRatio,function(b){})};return{info:function(a){d("info",a)},warn:function(a){console.warn(a);d("warn",a)},error:function(a){console.error(a);d("error",a)}}}();var Layout=function(){var d={defaultMargin:4,showAppSideBar:!1,setLayout:function(a,f){d.width=a||d.width;d.height=f||d.height;f=d.width;d.sidebarWidth=d.showAppSideBar?200:0;f-=d.sidebarWidth;d.col1W=Math.floor((f-6*d.defaultMargin-3)/5);d.col2W=2*d.col1W+d.defaultMargin;d.col3W=3*d.col1W+2*d.defaultMargin;d.col4W=4*d.col1W+3*d.defaultMargin;d.col5W=5*d.col1W+4*d.defaultMargin;d.marginLeft=Math.floor((f-d.col5W)/2);d.marginRight=f-d.marginLeft-d.col5W;d.mainLeft=d.sidebarWidth;d.mainWidth=f;d.col1X=
d.marginLeft;d.col2X=d.col1X+d.defaultMargin+d.col1W;d.col3X=d.col2X+d.defaultMargin+d.col1W;d.col4X=d.col3X+d.defaultMargin+d.col1W;d.col5X=d.col4X+d.defaultMargin+d.col1W;d.colHalfW=Math.floor(d.col1W/2);d.col31W=Math.floor((f-4*d.defaultMargin-5)/3);d.col32W=2*d.col31W+d.defaultMargin;d.col31X=d.col1X;d.col32X=d.col31X+d.defaultMargin+d.col31W;d.col33X=d.col32X+d.defaultMargin+d.col31W;d.prefered="col5";d.controlPanelHeight=40;d.controlPanelLayout="full";d.controlPanelButtonLayout="1row";d.controlPanelButtonsLeft=
d.col2X;d.controlPanelButtonsWidth=d.col3W;d.modeButtonsWidth=d.col1W;d.modeButtonsLeft=d.col5X;d.songControlWidth=d.col1W;d.TrackCountSpinboxWidth=60;d.trackWidth=d.col1W;d.trackMargin=d.defaultMargin;d.visibleTracks=d.visibleTracks||4;d.infoPanelHeight=24;d.trackControlHeight=32;d.analyserHeight=66;d.pianoHeight=200;d.trackFont=fontMed;d.useCondensedTrackFont=!1;d.maxVisibleTracks=16;945>f&&(d.maxVisibleTracks=12);725>f&&(d.maxVisibleTracks=8);512>f&&(d.maxVisibleTracks=4);d.visibleTracks>d.maxVisibleTracks?
d.setVisibleTracks(d.maxVisibleTracks):(820>f&&(d.controlPanelButtonLayout="condensed",d.modeButtonsWidth=d.col1W+d.colHalfW,d.modeButtonsLeft=d.col5X-d.colHalfW,d.songControlWidth=d.modeButtonsWidth,d.controlPanelButtonsLeft=d.col2X+d.colHalfW,d.controlPanelButtonsWidth=d.col2W),650>f&&(d.controlPanelButtonLayout="2row",d.controlPanelHeight=80,d.controlPanelButtonsLeft=d.col1X,d.controlPanelButtonsWidth=d.col5W,d.controlPanelButtonsButton=Math.floor(d.controlPanelButtonsWidth/3),d.modeButtonsLeft=
2*d.controlPanelButtonsButton-d.TrackCountSpinboxWidth,d.modeButtonsWidth=d.controlPanelButtonsButton+d.TrackCountSpinboxWidth+d.defaultMargin,d.songControlWidth=d.col2W+d.colHalfW+d.defaultMargin),620>f&&(d.prefered="col3"),800>d.height&&(d.pianoHeight=150),650>d.height&&(d.pianoHeight=100),a=d.defaultMargin*(d.visibleTracks-1),d.showSideBar=5>d.visibleTracks&&620<f,f=d.showSideBar?d.col4W:d.col5W,d.trackWidth=Math.floor((f-a)/d.visibleTracks),d.firstTrackOffsetLeft=0,125>d.trackWidth&&(d.firstTrackOffsetLeft=
18,d.trackWidth=Math.floor((f-a-d.firstTrackOffsetLeft)/d.visibleTracks)),a=Tracker.inFTMode()?100:78,d.trackWidth<a&&(d.trackFont=fontSuperCondensed,d.useCondensedTrackFont=!0))},setVisibleTracks:function(a){d.visibleTracks=a;d.setLayout();EventBus.trigger(EVENT.visibleTracksCountChange,a)}};return d}();var Yascal=function(){var d={sprites:{},getImage:function(a){return d.sprites[a]?d.sprites[a].canvas:void 0},loadImage:function(a,f){var h=new Image;h.crossOrigin="Anonymous";h.onload=function(){f&&f(h)};h.onerror=function(){console.error("XHR error while loading "+a)};h.src=a}};return d}(),Y=Yascal;Yascal.sprite=function(d){var a={};a.canvas=document.createElement("canvas");a.ctx=a.canvas.getContext("2d");if(d&&(d.width&&(a.canvas.width=d.width,a.canvas.height=d.height||d.width),d.img)){var f=a.canvas.width,h=a.canvas.height;a.ctx.drawImage(d.img,d.x||0,d.y||0,f,h,0,0,f,h)}return a};var canvas,ctx;
UI=function(){function d(K){if(!K.length)return 0;for(var X=0,C=0,L=K.length;C<L;C++)X+=K[C];return X/L}var a={},f,h,e=!1,b=[],c,m,g,k,l,n=3200,r,t=!0,p=0,z=0,y=0,B=0,A=0,E=0,U=0,Q=0,u=0,w,D=100,N=[],R=[],S,W,G=0,F=!1,J={},V=getUrlParameter("tracks");8==V&&(n=1200);16==V&&(n=1600);32<=V&&(n=3200);var O=window.performance&&performance.now?function(){return performance.now()}:Date.now;if(!window.requestAnimationFrame){var I=0;window.requestAnimationFrame=function(K,X){var C=(new Date).getTime(),L=Math.max(0,
16-(C-I));X=window.setTimeout(function(){K(C+L)},L);I=C+L;return X}}a.init=function(K){var X=Host.useUrlParams;canvas=document.getElementById("canvas");ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!1;var C=window.innerWidth,L=window.innerHeight;C>n&&(C=n);2E3<L&&(L=2E3);f=C;h=L;canvas.width=f;canvas.height=h;ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#78828F";ctx.font="20px sans-serif";ctx.textAlign="center";ctx.fillText("Loading ...",canvas.width/2,
canvas.height/2);debug&&UI.measure("Create Main Canvas");UI.Assets.preLoad(function(){debug&&UI.measure("UI sprites");console.log("UI assets loaded");q();Input.init();debug&&UI.measure("Input Init");v();debug&&UI.measure("First render");X&&"undefined"!==typeof versionNumber&&FetchService.json("package.json?ts="+(new Date).getTime(),function(x){x&&x.version&&x.version!==versionNumber&&(console.error("app needs updating"),x=localStorage.getItem("updatemessageshown")||0,x=parseInt(x,10),isNaN(x)&&(x=
0),window.reload=function(){localStorage.setItem("updatemessageshown",(new Date).getTime());window.location.reload(!0)},18E5<(new Date).getTime()-x&&(x=document.createElement("div"),x.className="message",x.innerHTML='A new version of BassoonTracker is available. Please <a href="#" onclick="reload()">refresh your browser</a>',document.body.appendChild(x)))});K&&K()})};a.initPlugin=function(K){console.log("init plugin");if(K.canvas)canvas=K.canvas;else{canvas=document.getElementById("canvas");var X=
window.innerWidth;X>n&&(X=n);2E3<X&&(X=2E3);canvas.width=X}ctx=canvas.getContext("2d");ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height);Settings.baseUrl=K.baseUrl;App.isPlugin=!0;buildNumber=Math.random();UI.Assets.preLoad(function(){console.log("UI assets loaded");q();v();Settings.readSettings();App.init();K.callback&&K.callback()})};a.setSize=function(K,X){K>n&&(K=n);2E3<X&&(X=2E3);200>X&&(X=200);if(K!==canvas.width||X!==canvas.height)ctx.clearRect(0,0,canvas.width,canvas.height),
f=K,h=X,a.scaleToDevicePixelRatio(e),a.mainPanel.setSize(K,X),r&&r.setProperties({width:K,height:X}),t=!0};a.scaleToDevicePixelRatio=function(K){e=!!K;K&&1<devicePixelRatio?(canvas.width=f*devicePixelRatio,canvas.height=h*devicePixelRatio,ctx.scale(devicePixelRatio,devicePixelRatio),ctx.imageSmoothingEnabled=!1):(canvas.width=f,canvas.height=h);canvas.style.width=f+"px";canvas.style.height=h+"px";UI.mainPanel.refresh()};var q=function(){var K=Y.getImage("font");c=BitmapFont();c.generate({image:K,
startX:1,startY:1,charWidth:6,charHeight:6,spaceWidth:6,margin:0,charsPerLine:42,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.+-_#>",onlyUpperCase:!0});window.fontSmall=c;m=BitmapFont();m.generate({image:K,startX:1,startY:110,charWidth:8,charHeight:8,spaceWidth:8,margin:1,charsPerLine:26,lineSpacing:1,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\u2191\u2193-#:.!\u00a9_?;()=/+<>&[]{}\\*%$'\"`\u00b0,",onlyUpperCase:!0});m.generateColor("green","rgba(80, 140, 0,0.9)");m.generateColor("orange","rgba(161, 82, 0,0.9)");
window.fontMed=m;g=BitmapFont();g.generate({image:K,startX:1,startY:10,charWidth:11,charHeight:11,spaceWidth:11,margin:1,charsPerLine:20,lineSpacing:3,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.,-_",onlyUpperCase:!0});window.fontBig=g;k=BitmapFont();k.generate({image:K,startX:1,startY:145,charHeight:12,spaceWidth:4,margin:1,charsPerLine:[26,26,40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890#\u00a9_-&\"'()!.,?+=*$/\\;:[]{}",charWidth:"888888883888998888888899987777757735739777757578987777777777778868864553348767888435555",
onlyUpperCase:!1,debug:!1});window.fontFT=k;l=BitmapFont();l.generate({image:K,startX:1,startY:184,charHeight:10,spaceWidth:5,margin:0,charsPerLine:[26,26,10],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",charWidth:"6666556625656666666666666655555455245365555454566555",onlyUpperCase:!1});window.fontCondensed=l;var X=BitmapFont();X.generate({image:K,startX:2,startY:208,charHeight:8,charWidth:4,spaceWidth:4,margin:0,charsPerLine:[45],lineSpacing:0,chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_.-#+><\u2191\u2193",
onlyUpperCase:!0});X.generateColor("green","rgba(80, 140, 0,0.9)");X.generateColor("orange","rgba(161, 82, 0,0.9)");window.fontSuperCondensed=X;X=BitmapFont();X.generate({image:K,startX:107,startY:68,charWidth:8,charHeight:13,spaceWidth:8,margin:0,charsPerLine:20,chars:" 0123456789-"});window.fontLed=X;X=BitmapFont();X.generate({image:K,startX:9,startY:82,charWidth:14,charHeight:22,spaceWidth:8,margin:0,charsPerLine:11,chars:" 0123456789"});window.fontLedBig=X;X=BitmapFont();X.generate({image:K,startX:1,
startY:216,charHeight:9,spaceWidth:5,margin:0,charsPerLine:[40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890():-",charWidth:"7777667736768777877778887746666666664434",onlyUpperCase:!0});window.fontDark=X;debug&&UI.measure("Generate font");UI.Assets.init();UI.mainPanel=UI.MainPanel();b.push(UI.mainPanel);debug&&UI.measure("Generate Main Panel")},v=function(K){K=!0;if(Tracker.isPlaying()){var X=Tracker.getStateAtTime(Audio.context.currentTime+.01);X&&(X.patternPos!==J.patternPos&&(Tracker.setCurrentPatternPos(X.patternPos),
J.patternPos=X.patternPos),X.songPos!==J.songPos&&(Tracker.setCurrentSongPosition(X.songPos),J.songPos=X.songPos))}p&&(z++,K=z>p);X=Audio.context?Audio.context.currentTime:0;if(K){B=O();var C=1E3/(B-A);R.push(C);20<R.length&&R.shift();60<C&&(K=!1)}K&&(z=0,A=B,EventBus.trigger(EVENT.screenRefresh),r&&r.needsRendering&&(UI.mainPanel.refresh(),t=!0),t&&(b.forEach(function(L){L.needsRendering&&L.render()}),EventBus.trigger(EVENT.screenRender),r&&(r.render(),t=!1)));X&&(y=y||X,u++,X>y+1&&(w=u/(X-y),D=
Math.min(D,w),y=X,u=0,N.push(w),20<N.length&&N.shift(),!F&&5<N.length&&(Logger.info("init "+Math.round(Q)),F=!0),EventBus.trigger(EVENT.second)));window.requestAnimationFrame(v)};a.setModalElement=function(K){r=K;Input.setFocusElement(K)};a.getModalElement=function(){return r};a.removeModalElement=function(){r&&Input.clearFocusElement();r=void 0;UI.mainPanel.refresh();t=!0};a.setSelection=function(K){W=S=K};a.getSelection=function(){return S};a.clearSelection=function(){S&&S(SELECTION.RESET)&&(S=
void 0)};a.copySelection=function(K){S&&(S(SELECTION.COPY),K&&S(SELECTION.RESET));S=void 0};a.cutSelection=function(K){S&&(S(SELECTION.CUT),K&&S(SELECTION.RESET));S=void 0};a.deleteSelection=function(){S&&S(SELECTION.DELETE);S=void 0};a.pasteSelection=function(K){!S&&W&&(S=W,S(SELECTION.POSITION));S&&(S(SELECTION.PASTE),K&&S(SELECTION.RESET));S=void 0};a.showContextMenu=function(K){EventBus.trigger(EVENT.showContextMenu,K)};a.hideContextMenu=function(){EventBus.trigger(EVENT.hideContextMenu)};a.showDialog=
function(K,X,C,L){var x=UI.modalDialog();x.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!!X,cancel:!!C,input:!!L});x.onClick=function(H){if(L){var Z=x.getElementAtPoint(H.x,H.y);if("dialoginput"===Z.name){Z.activate();return}}C?(Z=x.getElementAtPoint(H.x,H.y))&&Z.name&&("okbutton"===Z.name?"function"===typeof X&&X(x.inputValue):"function"===typeof C&&C(),x.close()):(x.close(),X&&X(x.inputValue))};x.onKeyDown=function(H){switch(H){case 13:return H=x.inputValue,
x.close(),X&&X(H),!0;case 27:return x.close(),C&&C(),!0}};x.setText(K);UI.setModalElement(x)};a.getChildren=function(){return b};a.getEventElement=function(K,X){for(var C=void 0,L=0,x=b.length;L<x;L++){var H=b[L];if(H.isVisible()&&H.containsPoint(K,X)){C=H;break}}C&&C.children&&C.children.length&&(C=C.getElementAtPoint(K,X));return C};a.getInternalPoint=function(K,X,C){for(var L=0,x=0;C.parent;)L+=C.left,x+=C.top,C=C.parent;return{x:K-L,y:X-x}};a.setLoading=function(){a.setStatus("Loading",!0);EventBus.trigger(EVENT.songLoading)};
a.setStatus=function(K,X){EventBus.trigger(EVENT.statusChange,{status:K,showSpinner:!!X})};a.setInfo=function(K,X,C){EventBus.trigger(EVENT.statusChange,{info:K,source:X,url:C})};a.stats=function(){return{fps:w,minFps:D,averageFps:d(N),averageRenderFps:d(R),fpsList:N,skipRenderSteps:p}};a.startMeasure=function(){Audio.context&&(U=E=Audio.context.currentTime)};a.measure=function(K){if(Audio.context){var X=1E3*(Audio.context.currentTime-U);U=Audio.context.currentTime;console.warn(K+": "+X)}};a.endMeasure=
function(){Audio.context&&(Q=1E3*(Audio.context.currentTime-E),debug&&console.warn("Total time: "+Q))};a.children=b;a.getAverageFps=function(){return 2<N.length?d(N):60};a.resetAverageFps=function(){var K=N.pop();N=K?[K]:[]};a.skipFrame=function(K){console.log("Setting SkipFrame to "+K);p=K;SETTINGS.skipFrame=K;EventBus.trigger(EVENT.skipFrameChanged,p)};a.getSkipFrame=function(){return p};EventBus.on(EVENT.clockEventExpired,function(){var K=O();2E3<K-G&&(Logger.warn("throttling back"),4>p?a.skipFrame(p+
1):Logger.warn("Browser can't keep up"),G=K)});return a}();UI.Assets=function(){var d={},a={};d.preLoad=function(h){function e(l){l=m+l;g&&(l+="?v="+App.buildNumber);return l}var b,c,m=Host.getBaseUrl(),g=Host.useUrlParams,k=function(){b&&c&&(b.forEach(function(l){l.img=c;Y.sprites[l.name]=Y.sprite(l)}),h&&h())};FetchService.json(e("/static/bassoontracker/skin/spritemap_v4.json"),function(l){b=l;k()});Y.loadImage(e("/static/bassoontracker/skin/spritesheet_v4.png"),function(l){c=l;k()})};d.buttonLightScale9={left:2,top:2,right:4,bottom:4};d.buttonLightHoverScale9=
{left:2,top:2,right:4,bottom:4};d.buttonDarkScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkBlueScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkRedScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkRedHoverScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkGreenScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkActiveScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkActiveBlueScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkGreenHoverScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkGreenActiveScale9=
{left:5,top:5,right:5,bottom:5};d.buttonDarkRedActiveScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkBlueActiveScale9={left:5,top:5,right:5,bottom:5};d.buttonDarkYellowActiveScale9={left:5,top:5,right:5,bottom:5};d.panelMainScale9={left:2,top:2,right:3,bottom:3};d.panelDarkScale9={left:3,top:3,right:3,bottom:2};d.panelDarkHoverScale9={left:3,top:3,right:3,bottom:2};d.panelDarkGreyScale9={left:3,top:3,right:3,bottom:2};d.panelDarkGreyBlueScale9={left:3,top:3,right:3,bottom:2};d.panelTransScale9=
{left:3,top:3,right:3,bottom:2};d.panelInsetScale9={left:2,top:2,right:2,bottom:2};d.panelDarkInsetScale9={left:2,top:2,right:2,bottom:2};d.buttonKeyScale9={left:5,top:5,right:5,bottom:5};d.buttonKeyHoverScale9={left:5,top:5,right:5,bottom:5};d.buttonKeyActiveScale9={left:5,top:5,right:5,bottom:5};var f={button20_20:{generate:function(h){var e=d.panelDarkScale9;var b=UI.button(0,0,20,20);b.setProperties({background:e,hoverBackground:d.panelDarkHoverScale9,textAlign:"center",font:window.fontMed,paddingTop:2});
if(h)a.buttonUp20_20=b;else return b}},button30_30:{generate:function(h){var e=UI.scale9Panel(0,0,30,30,d.buttonLightScale9);if(h)a.buttonUp30_30=e;else return e}},buttonLight:{generate:function(h){var e=d.buttonLightScale9;var b=UI.button();b.setProperties({background:e,hoverBackground:d.buttonLightHoverScale9,textAlign:"center",font:window.fontMed});if(h)a.buttonLight=b;else return b}},buttonDark:{generate:function(h){var e=d.buttonDarkScale9;var b=UI.button(0,0,20,20);b.setProperties({background:e,
hoverBackground:UI.Assets.buttonDarkBlueActiveScale9,activeBackground:UI.Assets.buttonDarkActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed});if(h)a.buttonDark=b;else return b}},buttonDarkBlue:{generate:function(h){var e=UI.button(0,0,20,20);e.setProperties({background:d.buttonDarkBlueScale9,activeBackground:UI.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed});if(h)a.buttonDarkBlue=e;else return e}},buttonDarkRed:{generate:function(h){var e=UI.button(0,
0,20,20);e.setProperties({background:d.buttonDarkRedScale9,hoverBackground:UI.Assets.buttonDarkRedHoverScale9,activeBackground:UI.Assets.buttonDarkRedActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed});if(h)a.buttonDarkRed=e;else return e}},buttonDarkGreen:{generate:function(h){var e=UI.button(0,0,20,20);e.setProperties({background:d.buttonDarkGreenScale9,hoverBackground:UI.Assets.buttonDarkGreenHoverScale9,activeBackground:UI.Assets.buttonDarkGreenActiveScale9,isActive:!1,textAlign:"center",
font:window.fontMed});if(h)a.buttonDarkGreen=e;else return e}},buttonKey:{generate:function(h){var e=UI.button(0,0,20,20);e.setProperties({background:d.buttonKeyScale9,hoverBackground:UI.Assets.buttonKeyHoverScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark});if(h)a.buttonKey=e;else return e}}};d.init=function(){d.buttonLightScale9.img=Y.getImage("button_light");d.buttonLightHoverScale9.img=Y.getImage("button_light_hover");d.buttonDarkScale9.img=
Y.getImage("button_inlay");d.buttonDarkBlueScale9.img=Y.getImage("button_inlay_blue");d.buttonDarkRedScale9.img=Y.getImage("button_inlay_red");d.buttonDarkRedHoverScale9.img=Y.getImage("button_inlay_red_hover");d.buttonDarkGreenScale9.img=Y.getImage("button_inlay_green");d.buttonDarkGreenHoverScale9.img=Y.getImage("button_hover_green");d.buttonDarkActiveScale9.img=Y.getImage("button_inlay_active");d.buttonDarkGreenActiveScale9.img=Y.getImage("button_inlay_green_active");d.buttonDarkRedActiveScale9.img=
Y.getImage("button_inlay_red_active");d.buttonDarkBlueActiveScale9.img=Y.getImage("button_inlay_blue_active");d.buttonDarkYellowActiveScale9.img=Y.getImage("button_inlay_yellow_active");d.panelMainScale9.img=Y.getImage("background");d.panelDarkScale9.img=Y.getImage("bar");d.panelDarkHoverScale9.img=Y.getImage("bar_hover");d.panelDarkGreyScale9.img=Y.getImage("panel_dark_greyish");d.panelDarkGreyBlueScale9.img=Y.getImage("panel_dark_blueish");d.panelTransScale9.img=Y.getImage("panel_trans");d.panelInsetScale9.img=
Y.getImage("panel_inset");d.panelDarkInsetScale9.img=Y.getImage("panel_dark");d.buttonKeyScale9.img=Y.getImage("keybutton");d.buttonKeyHoverScale9.img=Y.getImage("keybutton_hover");d.buttonKeyActiveScale9.img=Y.getImage("keybutton_highlight3");console.log("Assets init done")};d.get=function(h){var e=a[h];if(e)return e;(e=f[h])?e.isLoading?console.log("Asset "+h+" is not ready yet, still loading"):(e.isLoading=!0,e.generate(!0)):console.error("Error: asset "+h+" is not defined")};d.put=function(h,
e){a[h]=e};d.generate=function(h){if(f[h])return f[h].generate();console.error("Error: asset "+h+" is not defined")};return d}();var Input=function(){function d(){if(g.length){var B=g.shift();if(B.source)try{B.source.stop()}catch(A){}}}var a={},f=0,h={touches:[],mouseWheels:[]},e,b,c=0,m=!1,g=[],k={},l=!1,n=2,r=3,t=1,p,z=13;a.init=function(){function B(u){function w(S,W,G){h.isTouchDown=!0;var F=canvas.getBoundingClientRect();W-=F.left+window.pageXOffset;G-=F.top+window.pageYOffset;(b=UI.getModalElement())?(b.eventX=W,b.eventY=G):b=UI.getEventElement(W,G);b&&e&&e.deActivate&&e.name!==b.name&&e.deActivate(b);F=b?b.eventX:W;
var J=b?b.eventY:G;S={id:S,x:F,y:J,startX:F,startY:J,globalX:W,globalY:G,globalStartX:W,globalStartY:G,UIobject:b,isMeta:u.shiftKey||u.metaKey||u.ctrlKey||u.altKey};h.touches.push(S);if(S.UIobject){if(S.UIobject.onDragStart)S.UIobject.onDragStart(S);if(S.UIobject.onDown)S.UIobject.onDown(S)}}u.preventDefault();window.focus();!m&&"undefined"!==typeof Audio&&Audio.playSilence&&Audio.context&&"suspended"!==Audio.context.state&&(Audio.playSilence(),m=!0);if(u.touches&&0<u.touches.length)for(var D=u.changedTouches,
N=0;N<D.length;N++){var R=D[N];w(R.identifier,R.pageX,R.pageY)}else D=y("notouch"),0<=D&&h.touches.splice(D,1),w("notouch",u.pageX,u.pageY)}function A(u){function w(S,W,G){if(0<=S){var F=h.touches[S];F.globalX=W-window.pageXOffset;F.globalY=G-window.pageYOffset;F.deltaX=F.globalX-F.globalStartX;F.deltaY=F.globalY-F.globalStartY;F.x=F.startX+F.deltaX;F.y=F.startY+F.deltaY;h.touches.splice(S,1,F);h.isTouchDown&&F.UIobject&&F.UIobject.onDrag&&(F.dragX=W,F.dragY=G,F.UIobject.onDrag(F))}}u.preventDefault();
var D=canvas.getBoundingClientRect();if(u.touches&&0<u.touches.length){var N=u.changedTouches;for(u=0;u<N.length;u++){var R=N[u];w(y(R.identifier),R.pageX-D.left,R.pageY-D.top)}}else if(N=u.pageX-D.left,D=u.pageY-D.top,w(y("notouch"),N,D),h.currentMouseX=N,h.currentMouseY=D,h.mouseMoved=(new Date).getTime(),SETTINGS.useHover){if((D=UI.getEventElement(N,D))&&D.onHover)D.onHover(h);if(p&&p!=D&&p.onHoverExit)p.onHoverExit(h,D);p=D}}function E(u){function w(N){if(0<=N){var R=h.touches[N],S=R.startX-R.x,
W=R.startY-R.y;S=Math.sqrt(S*S+W*W);W=!0;if(R.UIobject){var G=R.UIobject;G.keepSelection&&(W=!1);if(8>S&&G.onClick)G.onClick(R);if(G.onTouchUp)G.onTouchUp(R)}W&&8>S&&UI.clearSelection();h.touches.splice(N,1)}}m||Audio&&Audio.checkState&&Audio.checkState();h.isTouchDown=!1;if(u&&u.touches){u=u.changedTouches;for(var D=0;D<u.length;D++)w(y(u[D].identifier))}else w(y("notouch"))}function U(u){u.preventDefault();if(h.currentMouseX){var w=UI.getEventElement(h.currentMouseX,h.currentMouseY);w&&w.onMouseWheel&&
(h.mouseWheels.unshift(u.wheelDeltaY||u.wheelDelta||-u.detail),10<h.mouseWheels.length&&h.mouseWheels.pop(),w.onMouseWheel(h))}}function Q(){App.isPlugin||(clearTimeout(c),c=setTimeout(function(){UI.setSize(window.innerWidth,window.innerHeight)},100))}canvas.addEventListener("mousedown",B,!1);canvas.addEventListener("mousemove",A,!1);canvas.addEventListener("mouseup",E,!1);canvas.addEventListener("mouseout",function(u){h.isTouchDown&&E(u)},!1);canvas.addEventListener("touchstart",B,!1);canvas.addEventListener("touchmove",
A,!1);canvas.addEventListener("touchend",E,!1);window.navigator.msPointerEnabled&&(canvas.addEventListener("MSPointerDown",B,!1),canvas.addEventListener("MSPointerMove",A,!1),canvas.addEventListener("MSPointerEnd",E,!1));canvas.addEventListener("mousewheel",U,!1);canvas.addEventListener("DOMMouseScroll",U,!1);window.addEventListener("keydown",function(u){if(0!=enableTrackerKeyboard){u.preventDefault();var w=KEYBOARDTABLE[SETTINGS.keyboardTable]||KEYBOARDTABLE.azerty,D=u.keyCode,N=u.key,R=u.shiftKey,
S=u.ctrlKey,W=u.altKey;l=u.metaKey||S||W||R;!N&&u.keyIdentifier&&(N=u.keyIdentifier,N=N.replace("U+",""),N=String.fromCharCode(parseInt(N,16)).toLowerCase());if(!(e&&e.onKeyDown&&e.onKeyDown(D,u))){switch(D){case 27:UI.clearSelection();R=Date.now();1E3>R-f?(document.getElementsByClassName("tracker")[0].style.display="none",enableTrackerKeyboard=!1):f=R;break;case 8:Tracker.isRecording()?l?(Editor.removeNote(),Tracker.moveCurrentPatternPos(-1)):(N=Editor.getCurrentTrackPosition(),0===N?Editor.putNote(0,
0):!Tracker.inFTMode()||3!==N&&4!==N?Editor.putNoteParam(N,0):Editor.putNoteParam(N,-1),Tracker.moveCurrentPatternPos(1)):(Tracker.playPatternStep(Editor.getCurrentTrackPosition()),Tracker.moveCurrentPatternPos(-1));return;case 9:u.stopPropagation();u.preventDefault();l?Editor.moveCursorPosition(-Editor.getStepsPerTrack()):Editor.moveCursorPosition(Editor.getStepsPerTrack());return;case 13:Tracker.isRecording()&&l?(Editor.insertNote(),Tracker.moveCurrentPatternPos(1)):Tracker.togglePlay();return;
case 32:Tracker.toggleRecord();return;case 33:w=Math.floor(Tracker.getPatternLength()/4);0===w&&(w=1);N=Math.floor(Tracker.getCurrentPatternPos()/w)*w;Tracker.getCurrentPatternPos()===N&&(N-=w);0>N&&(N=0);Tracker.setCurrentPatternPos(N);return;case 34:w=Math.floor(Tracker.getPatternLength()/4);0===w&&(w=1);N=Math.ceil(Tracker.getCurrentPatternPos()/w)*w;Tracker.getCurrentPatternPos()===N&&(N+=w);N>=Tracker.getPatternLength()-1&&(N=Tracker.getPatternLength()-1);Tracker.setCurrentPatternPos(N);return;
case 35:Tracker.setCurrentPatternPos(Tracker.getPatternLength()-1);return;case 36:Tracker.setCurrentPatternPos(0);return;case 37:Editor.moveCursorPosition(-1);return;case 38:Tracker.moveCurrentPatternPos(-1);return;case 39:Editor.moveCursorPosition(1);return;case 40:Tracker.moveCurrentPatternPos(1);return;case 46:Tracker.isRecording()&&(N=Editor.getCurrentTrackPosition(),0===N?Editor.putNote(0,0):Editor.putNoteParam(N,0),Tracker.moveCurrentPatternPos(1));return;case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:if(!Tracker.isRecording()){u=
D-96;1>u&&(u+=10);Tracker.setCurrentInstrumentIndex(u);return}break;case 107:Tracker.setCurrentInstrumentIndex(Tracker.getCurrentInstrumentIndex()+1);return;case 109:u=Tracker.getCurrentInstrumentIndex();1<u&&Tracker.setCurrentInstrumentIndex(u-1);return;case 112:case 113:case 114:case 115:case 116:case 117:case 118:a.setCurrentOctave(D-111);return;case 119:case 120:case 121:case 122:case 123:return;case 187:Tracker.setCurrentInstrumentIndex(Tracker.getCurrentInstrumentIndex()+1);return;case 189:u=
Tracker.getCurrentInstrumentIndex();1<u&&Tracker.setCurrentInstrumentIndex(u-1);return;case 221:return}if(N&&40<D&&230>D)if(l&&65<=D&&90>=D)switch(u.stopPropagation(),u.preventDefault(),D){case 65:EventBus.trigger(EVENT.commandSelectAll);break;case 67:UI.copySelection(!0);break;case 86:UI.pasteSelection(!0);break;case 88:UI.cutSelection(!0);break;case 89:EventBus.trigger(EVENT.commandRedo);break;case 90:EventBus.trigger(EVENT.commandUndo)}else u=-1,w=w[N],"number"===typeof w&&(u=12*n+w,0===w&&(u=
0)),a.handleNoteOn(u,N)}}},!1);window.addEventListener("keyup",function(u){if(0!=enableTrackerKeyboard){var w=u.key;!w&&u.keyIdentifier&&(w=u.keyIdentifier,w=w.replace("U+",""),w=String.fromCharCode(parseInt(w,16)).toLowerCase());u=u.keyCode;if(16===u||17===u||18===u||91===u||93===u)l=!1;if(w&&40<u&&200>u&&(u=(KEYBOARDTABLE[SETTINGS.keyboardTable]||KEYBOARDTABLE.azerty)[w],"number"===typeof u))return a.handleNoteOff(12*n+u)}},!1);canvas.addEventListener("dragenter",function(u){u.stopPropagation();
u.preventDefault()},!1);canvas.addEventListener("dragover",function(u){u.stopPropagation();u.preventDefault()},!1);canvas.addEventListener("drop",function(u){u.stopPropagation();u.preventDefault();Tracker.handleUpload(u.dataTransfer.files)},!1);window.addEventListener("paste",function(u){UI.pasteSelection(!0)},!1);window.addEventListener("copy",function(u){UI.copySelection(!0)},!1);window.addEventListener("cut",function(u){console.error("cut");UI.cutSelection(!0)},!1);window.addEventListener("undo",
function(u){console.error("undo")},!1);window.addEventListener("delete",function(u){console.error("delete")},!1);App.isPlugin||window.addEventListener("resize",Q,!1);Q()};var y=function(B){for(var A=0;A<h.touches.length;A++)if(h.touches[A].id===B)return A;return-1};a.setFocusElement=function(B){var A=B.name||B.type;if(e){if((e.name||e.type)===A){console.log(A+" already has focus");return}e.deActivate&&e.deActivate()}e=B;A?console.log("setting focus to "+A):console.warn("Warning: setting focus to an unnamed element can cause unexpected results")};
a.clearFocusElement=function(B){if(B){B.name||console.warn("Please specify a name for the target object when removing focus");var A=B.name||B.type;A&&console.log("removing focus from "+A);B.deActivate&&B.deActivate();e&&e.name===B.name&&(e=void 0)}else e&&e.deActivate&&e.deActivate(),e=void 0};a.getFocusElement=function(){return e};a.clearInputNotes=function(){for(;g.length;)d()};a.getCurrentOctave=function(){return n};a.setCurrentOctave=function(B){B<=r&&B>=t&&(n=B,EventBus.trigger(EVENT.octaveChanged,
n))};a.handleNoteOn=function(B,A,E,U){var Q=!0,u;if(0<=B){z=B;UI.clearSelection();var w=Math.floor((B-1)/12)+1;if(u=OCTAVENOTES[(B-1)%12+1])if(Tracker.inFTMode())if("OFF"===u.name){var D={period:1,index:0};Q=!1}else(w=FTNotes[B])&&(D={period:w.period,index:B});else D=NOTEPERIOD[u.name+(w-1)]}if(Tracker.isRecording())if(0<Editor.getCurrentTrackPosition()){Q=!1;w=/[0-9A-Fa-f]/g;u=-1;A=A||"";w.test(A)?u=parseInt(A,16):Tracker.inFTMode()&&5===Editor.getCurrentTrackPosition()&&(w=/[0-9A-Za-z]/g,w.test(A)&&
(u=parseInt(A,36)));if(Tracker.inFTMode()&&3===Editor.getCurrentTrackPosition())switch(u=-1,A){case "0":u=0;break;case "1":u=1;break;case "2":u=2;break;case "3":u=3;break;case "4":u=4;break;case "-":u=5;break;case "+":u=6;break;case "d":case "D":u=7;break;case "u":case "U":u=8;break;case "s":case "S":u=9;break;case "v":case "V":u=10;break;case "p":case "P":u=11;break;case "<":u=12;break;case ">":u=13;break;case "M":u=14}255<u&&(u=-1);0<=u&&(Editor.putNoteParam(Editor.getCurrentTrackPosition(),u),
Tracker.moveCurrentPatternPos(1))}else{if(k[B])return;D&&(Editor.putNote(Tracker.getCurrentInstrumentIndex(),D.period,D.index,U),Tracker.isPlaying()||Tracker.moveCurrentPatternPos(1))}Q&&D&&!k[B]&&(A=Tracker.getCurrentInstrument())&&(D.index&&(A.setSampleForNoteIndex(D.index),A.sample.relativeNote&&(D.index+=A.sample.relativeNote,Q=FTNotes[D.index]))&&(D.period=Q.period),Audio.checkState(),Q=void 0,E&&(Q={offset:{value:E}}),"number"===typeof U&&(U=100*U/64),k[B]=A.play(D.index,D.period,U,void 0,Q),
k[B].instrument=A,k[B].isKey=!0,g.push(k[B]),E=k[B],E.scheduled&&E.scheduled.vibrato&&(U=A.scheduleAutoVibrato(E,2),E.scheduled.vibrato+=U),64<g.length&&d(),EventBus.trigger(EVENT.pianoNoteOn,B))};a.handleNoteOff=function(B,A){if(!SETTINGS.sustainKeyboardNotes&&k[B]&&k[B].source&&Audio.context){EventBus.trigger(EVENT.pianoNoteOff,B);try{k[B].instrument?k[B].instrument.noteOff(Audio.context.currentTime,k[B]):k[B].source.stop()}catch(E){}}k[B]=!1;A&&Tracker.inFTMode()&&Tracker.isRecording()&&Tracker.isPlaying()&&
(Editor.putNoteParam(5,20),Editor.putNoteParam(7,1))};a.isMetaKeyDown=function(){return l};a.getPrevIndex=function(){return z};EventBus.on(EVENT.second,function(){if(Audio.context){var B=Audio.context.currentTime;g.forEach(function(A){if(A&&A.time&&A.scheduled){if(A.scheduled.volume&&B+2>=A.scheduled.volume&&A.instrument){var E=A.instrument.scheduleEnvelopeLoop(A.volumeEnvelope,A.scheduled.volume,2);A.scheduled.volume+=E}A.scheduled.panning&&B+2>=A.scheduled.panning&&A.instrument&&(E=A.instrument.scheduleEnvelopeLoop(A.panningEnvelope,
A.scheduled.panning,2),A.scheduled.panning+=E);A.scheduled.vibrato&&B+2>=A.scheduled.vibrato&&A.instrument&&(E=A.instrument.scheduleAutoVibrato(A,2),A.scheduled.vibrato+=E)}})}});EventBus.on(EVENT.trackerModeChanged,function(B){Tracker.inFTMode()?(r=7,t=0,a.setCurrentOctave(n+2)):(r=3,t=1,a.setCurrentOctave(Math.min(Math.max(n-2,t),r)))});return a}();UI.ticker=function(){var d={},a,f,h,e,b,c,m=0,g=0,k=!1;d.onEachTick2=function(l,n){b=0;h=n||0;k=(a=l)||f};d.onEachTick4=function(l,n){c=0;e=n||0;f=l;k=a||f};EventBus.on(EVENT.screenRefresh,function(){k&&(m=1-m)&&(g=1-g,a&&(b++,b>h&&a()),g&&f&&(c++,c>e&&f()))});return d}();var StateManager=function(){var d={},a={undo:[],redo:[]},f;d.registerEdit=function(h){var e=!0;if(!f){if(a.undo.length)switch(h.type){case EDITACTION.VALUE:var b=a.undo[a.undo.length-1];b&&b.type===h.type&&b.id===h.id?(e=!1,b.to=h.to,console.log("Ignoring sequential Undo, to: "+h.to)):console.log("Add Value Undo")}e&&(a.undo.push(h),100<a.undo.length&&a.undo.shift(),a.redo=[])}};d.undo=function(){if(a.undo.length){var h=a.undo.pop();f=!0;h.instrument&&h.instrument!==Tracker.getCurrentInstrumentIndex()&&
Tracker.setCurrentInstrumentIndex(h.instrument);switch(h.type){case EDITACTION.NOTE:case EDITACTION.RANGE:case EDITACTION.TRACK:case EDITACTION.PATTERN:var e=Tracker.getSong().patterns[h.id];h.id!==Tracker.getCurrentPattern()&&Tracker.setCurrentPattern(h.id);h.data.forEach(function(b){e&&(e[b.position.row][b.position.track]||new Note).populate(b.from)});EventBus.trigger(EVENT.patternChange,h.id);break;case EDITACTION.VALUE:h.target.setValue(h.from);break;case EDITACTION.DATA:h.target===EDITACTION.SAMPLE&&
(h.undo=!0,h.redo=!1,EventBus.trigger(EVENT.showView,"sample"),EventBus.trigger(EVENT.commandProcessSample,h));break;default:console.warn("Unknown UNDO action"),console.warn(h)}a.redo.push(h);f=!1;h.name&&UI.setStatus("Undo "+h.name)}};d.redo=function(){if(a.redo.length){var h=a.redo.pop();f=!0;h.instrument&&h.instrument!==Tracker.getCurrentInstrumentIndex()&&Tracker.setCurrentInstrumentIndex(h.instrument);switch(h.type){case EDITACTION.NOTE:case EDITACTION.RANGE:case EDITACTION.TRACK:case EDITACTION.PATTERN:var e=
Tracker.getSong().patterns[h.id];h.id!==Tracker.getCurrentPattern()&&Tracker.setCurrentPattern(h.id);h.data.forEach(function(b){if(e){var c=e[b.position.row][b.position.track]||new Note;b.to?c.populate(b.to):c.clear()}});EventBus.trigger(EVENT.patternChange,h.id);break;case EDITACTION.VALUE:h.target.setValue(h.to);break;case EDITACTION.DATA:h.target===EDITACTION.SAMPLE&&(h.undo=!1,h.redo=!0,EventBus.trigger(EVENT.showView,"sample"),EventBus.trigger(EVENT.commandProcessSample,h));break;default:console.warn("Unknown UNDO action"),
console.warn(h)}a.undo.push(h);f=!1;h.name&&UI.setStatus("Redo "+h.name)}};d.createNoteUndo=function(h,e,b,c){return{target:EDITACTION.PATTERN,type:EDITACTION.NOTE,id:h,data:[{position:{track:e,row:b},from:c.duplicate()}]}};d.createTrackUndo=function(h){return{target:EDITACTION.PATTERN,type:EDITACTION.TRACK,id:h,data:[]}};d.createPatternUndo=function(h){return{target:EDITACTION.PATTERN,type:EDITACTION.PATTERN,id:h,data:[]}};d.createRangeUndo=function(h){return{target:EDITACTION.PATTERN,type:EDITACTION.RANGE,
id:h,data:[]}};d.createValueUndo=function(h){return{target:h,type:EDITACTION.VALUE,id:h.name,from:h.getPrevValue(),to:h.getValue()}};d.createSampleUndo=function(h,e,b){return{target:EDITACTION.SAMPLE,type:EDITACTION.DATA,id:"sample"+Tracker.getCurrentInstrumentIndex(),instrument:Tracker.getCurrentInstrumentIndex(),from:e||0,to:b||0,action:h}};d.addNote=function(h,e,b,c){e={position:{track:e,row:b},from:c?c.duplicate():{}};h.data.push(e);return e};d.getHistory=function(){return a};d.clear=function(){a=
{undo:[],redo:[]}};d.lock=function(){f=!0};d.unLock=function(){f=!1};d.canUndo=function(){return 0<a.undo.length};d.canRedo=function(){return 0<a.redo.length};d.getUndoLabel=function(){var h="";a.undo.length&&(h=a.undo[a.undo.length-1].name||"");return"Undo "+h};d.getRedoLabel=function(){var h="";a.redo.length&&(h=a.redo[a.redo.length-1].name||"");return"Redo "+h};EventBus.on(EVENT.commandUndo,d.undo);EventBus.on(EVENT.commandRedo,d.redo);return d}();UI.element=function(d,a,f,h){var e={};e.left=d||0;e.top=a||0;e.width=f||20;e.height=h||20;e.visible=!0;e.needsRendering=!0;e.parentCtx=ctx;e.canvas=document.createElement("canvas");e.canvas.width=f;e.canvas.height=h;e.ctx=e.canvas.getContext("2d");e.children=[];e.hide=function(){e.visible=!1;if(e.onHide)e.onHide()};e.show=function(b,c){e.visible=!0;b&&e.refresh(c);if(e.onShow)e.onShow()};e.toggle=function(b){"boolean"===typeof b?b?e.show():e.hide():e.visible?e.hide():e.show()};e.isVisible=function(){for(var b=
e.visible,c=e.parent;b&&c;)b=c.visible,c=c.parent;return b};e.containsPoint=function(b,c){var m=this.left+this.width,g=this.top,k=this.top+this.height;return b>=this.left&&b<=m&&c>=g&&c<=k};e.getElementAtPoint=function(b,c){b-=e.left+(e.scrollOffsetX||0);c-=e.top+(e.scrollOffsetY||0);e.scaleX&&(b/=e.scaleX);e.scaleY&&(c/=e.scaleY);for(var m,g=e.children.length-1;0<=g;g--){var k=e.children[g];if(k.isVisible()&&!k.ignoreEvents&&k.containsPoint(b,c)){m=k;break}}m?(g=m.getElementAtPoint(b,c))?m=g:(m.eventX=
b,m.eventY=c):(m=e,m.eventX=b,m.eventY=c);return m};e.setParent=function(b){if(e.parent=b)e.parentCtx=b.ctx};e.addChild=function(b){b.setParent(e);b.zIndex=b.zIndex||e.children.length;e.children.push(b)};e.getChild=function(b){for(var c=e.children.length,m;c;){if((m=e.children[c])&&m.name&&m.name==b)return m;c--}};e.refresh=function(b){e.needsRendering=!0;if(b){console.error("refresh children "+e.name);b=e.children.length;for(var c;b;)(c=e.children[b])&&c.refresh(),b--}this.visible&&e.parent&&e.parent.refresh&&
e.parent.refresh()};e.setSize=function(b,c){e.width=Math.max(b,1);e.height=Math.max(c,1);e.canvas.width=e.width;e.canvas.height=e.height;if(e.onResize)e.onResize();e.refresh()};e.setPosition=function(b,c){e.left=b;e.top=c;e.refresh()};e.setDimensions=function(b){if("boolean"===typeof b.visible?b.visible:1)e.setProperties?e.setProperties(b):(e.setPosition(b.left,b.top),e.setSize(b.width,b.height))};e.clearCanvas=function(){e.ctx.clearRect(0,0,e.width,e.height)};return e};UI.panel=function(d,a,f,h){var e=UI.element(d,a,f,h);e.type="panel";var b="left top width height name type zIndex backgroundColor borderColor".split(" ");e.setProperties=function(c){b.forEach(function(m){"undefined"!=typeof c[m]&&(e[m]=c[m])});e.setSize(e.width,e.height);e.setPosition(e.left,e.top);e.setLayout&&e.setLayout(e.left,e.top,e.width,e.height)};e.render=function(c){if(e.isVisible()){c=!!c;this.needsRendering&&(e.renderOverride?e.renderOverride():(e.clearCanvas(),e.backgroundColor&&(e.ctx.fillStyle=
e.backgroundColor,e.ctx.fillRect(0,0,e.width,e.height)),e.borderColor&&(e.ctx.fillStyle=e.borderColor,e.ctx.rect(0,0,e.width,e.height),e.ctx.stroke()),this.children.forEach(function(m){m.render()}),e.renderInternal&&e.renderInternal()));this.needsRendering=!1;if(c)return e.canvas;e.parentCtx.drawImage(e.canvas,e.left,e.top,e.width,e.height)}};e.onClick=function(){};e.sortZIndex=function(){this.children.sort(function(c,m){return c.zIndex==m.zIndex?0:c.zIndex>m.zIndex||-1})};return e};UI.image=function(d,a,f,h,e){var b=UI.element(d,a,f||14,h||14,!0),c=["left","top","width","height","name"];b.setProperties=function(g){c.forEach(function(k){"undefined"!=typeof g[k]&&(b[k]=g[k])});b.setSize(b.width,b.height);b.setPosition(b.left,b.top)};var m=Y.getImage(e);b.render=function(g){g=!!g;if(b.isVisible()){if(this.needsRendering&&(b.clearCanvas(),m))switch(b.scale){case "stretch":b.ctx.drawImage(m,0,0,b.width,b.height);break;default:var k=b.width-m.width>>1,l=b.height-m.height>>1;"top"===
b.verticalAlign&&(l=0);"right"===b.horizintalAlign&&(k=b.width-m.width);b.ctx.drawImage(m,k,l)}this.needsRendering=!1;if(g)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)}};return b};UI.button=function(d,a,f,h,e){var b=UI.element(d,a,f,h);b.type="button";b.isActive=!1;var c=e||"",m,g,k,l,n,r,t,p,z="left",y=0,B=0,A=10,E=!0,U="left top width height name type image backgroundImage background active hoverBackground hoverImage activeBackground activeImage font label textAlign paddingTop paddingTopActive paddingLeft checkbox radio".split(" ");b.setProperties=function(Q){U.forEach(function(u){if("undefined"!=typeof Q[u])switch(u){case "label":c=Q[u];break;case "font":p=Q[u];break;case "textAlign":z=
Q[u];break;case "paddingTop":y=parseInt(Q[u]);break;case "paddingTopActive":B=parseInt(Q[u]);break;case "paddingLeft":A=parseInt(Q[u]);break;case "image":m=Q[u];break;case "backgroundImage":g=Q[u];break;case "activeImage":r=Q[u];break;case "hoverImage":t=Q[u];E=!0;break;case "background":Q[u].img&&(g=void 0,k=UI.scale9Panel(0,0,0,0,Q[u]),k.setParent(b));break;case "activeBackground":Q[u].img&&(l=UI.scale9Panel(0,0,0,0,Q[u]),l.setParent(b));break;case "hoverBackground":Q[u].img&&(n=UI.scale9Panel(0,
0,0,0,Q[u]),n.setParent(b));E=!0;break;default:b[u]=Q[u]}});k&&k.setSize(b.width,b.height);l&&l.setSize(b.width,b.height);n&&n.setSize(b.width,b.height);b.setSize(b.width,b.height);b.setPosition(b.left,b.top);Q.labels&&(b.onResize=function(){var u=c;Q.labels.forEach(function(w){b.width>=w.width&&(c=w.label)});u!==c&&b.refresh()})};b.setBackgroundImage=function(Q){g=Q;b.refresh()};b.setFont=function(Q){p=Q;b.refresh()};b.setLabel=function(Q){c=Q;b.refresh()};b.toggleActive=function(){b.isActive=!b.isActive;
b.refresh()};b.setActive=function(Q){"undefined"==typeof Q&&(Q=!0);b.isActive=!!Q;b.refresh()};b.setDisabled=function(Q){"undefined"==typeof Q&&(Q=!0);if(b.isDisabled=Q)b.isActive=!1;b.refresh()};b.onHover=function(Q){E&&!b.isActive&&(b.isHover=!0,b.refresh())};b.onHoverExit=function(){E&&b.isHover&&(b.isHover=!1,b.refresh())};b.render=function(Q){if(b.isVisible()){if(b.needsRendering){Q=!!Q;if(g)b.ctx.drawImage(g,0,0,b.width,b.height);else if(k)if(b.isActive&&l){if(l.render(),r){var u=Math.floor((b.height-
r.height)/2),w=Math.floor((b.width-r.width)/2);b.ctx.drawImage(r,w,u)}}else{var D=m;b.isHover&&t&&(D=t);b.isHover&&n?n.render():k.render();D&&(u=Math.floor((b.height-D.height)/2),w=Math.floor((b.width-D.width)/2),b.ctx.drawImage(D,w,u))}else b.ctx.fillStyle="grey",b.ctx.fillRect(0,0,b.width,b.height),b.ctx.fillStyle="black",b.ctx.rect(0,0,b.width,b.height),b.ctx.stroke();c&&(u=Math.floor((b.height-10)/2)+(b.isActive?B:y),w=A,p?("center"===z&&(w=8*c.length,p.fixedWidth||(w=p.getTextWidth(c,0)),w=Math.floor((b.width-
w)/2)),"right"===z&&(w=8*c.length,p.fixedWidth||(w=p.getTextWidth(c,0)),w=b.width-w-5),p.write(b.ctx,c,w,u,0)):(b.ctx.fillStyle="white",b.ctx.fillText(c,w,u)));b.isDisabled&&(b.ctx.fillStyle="rgba(34, 49, 85, 0.6)",b.ctx.fillRect(0,0,b.width,b.height));b.renderInternal&&b.renderInternal()}b.needsRendering=!1;if(Q)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)}};return b};UI.checkboxbutton=function(d){var a=UI.button(0,0,20,20);d=d||{};a.setProperties({background:d.background||UI.Assets.buttonDarkBlueScale9,hoverBackground:d.hoverBackground||UI.Assets.buttonDarkBlueActiveScale9,activeBackground:d.activeBackground||UI.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"left",paddingLeft:30,font:d.font||window.fontFT,label:d.label||"",labels:d.labels||void 0,checkbox:d.checkbox||!1});a.renderInternal=function(){if(a.checkbox)var f=a.isActive?Y.getImage("checkbox_on"):
Y.getImage("checkbox_off"),h=7;else f=a.isActive?Y.getImage("radio_active"):Y.getImage("radio_inactive"),h=5;a.ctx.drawImage(f,8,Math.floor(a.height/2)-h)};a.onDown=function(){a.toggleActive();d.onDown&&d.onDown.bind(a).call()};return a};UI.label=function(d){var a=UI.element();a.type="label";var f="",h,e="left",b=0,c="left top width height name font label textAlign paddingTop".split(" ");a.setProperties=function(m){c.forEach(function(g){if("undefined"!=typeof m[g])switch(g){case "label":f=m[g];break;case "font":h=m[g];break;case "textAlign":e=m[g];break;case "paddingTop":b=parseInt(m[g]);break;default:a[g]=m[g]}});a.setSize(a.width,a.height);a.setPosition(a.left,a.top);m.labels&&(a.onResize=function(){var g=f;m.labels.forEach(function(k){a.width>=
k.width&&(f=k.label)});g!==f&&a.refresh()})};a.setFont=function(m){h=m;a.refresh()};a.getFont=function(){return h};a.setLabel=function(m){f=m;a.refresh()};a.render=function(m){if(a.isVisible()){if(a.needsRendering&&(m=!!m,a.clearCanvas(),f)){var g=Math.floor((a.height-10)/2)+b,k=10;h?("center"==e&&(k=h.getTextWidth(f,0),k=Math.floor((a.width-k)/2)),"right"==e&&(k=h.getTextWidth(f,0),k=Math.floor(a.width-k)-10),h.write(a.ctx,f,k,g,0)):(a.ctx.fillStyle="white",a.ctx.fillText(f,k,g))}a.needsRendering=
!1;if(m)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}};d&&a.setProperties(d);return a};UI.inputbox=function(d){var a=UI.element(),f="left top width height name type onChange onSubmit backgroundImage trackUndo undoLabel undoInstrument".split(" "),h="",e="",b,c,m,g="panel_dark";a.setProperties=function(n){f.forEach(function(r){"undefined"!=typeof n[r]&&(a[r]=n[r])});a.setSize(a.width,a.height);a.setPosition(a.left,a.top);k&&k.setSize(a.width,a.height);n.value&&(h=n.value);n.backgroundImage&&(g=n.backgroundImage)};d&&a.setProperties(d);var k=UI.scale9Panel(0,0,a.width,a.height,{img:Y.getImage(g),
left:3,top:3,right:2,bottom:2});k.ignoreEvents=!0;a.addChild(k);a.render=function(n){n=!!n;if(a.isVisible()){if(this.needsRendering){k.render();var r=0;h&&fontMed&&(r=10,fontMed.write(a.ctx,h,r,6,0));c&&(a.ctx.fillStyle="rgba(255,255,255,0.7)",a.ctx.fillRect(r+9*m+8,4,2,a.height-8))}this.needsRendering=!1;if(n)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)}};a.setValue=function(n,r){n!==h&&(e=h);h=n;a.refresh();!r&&a.onChange&&(a.trackUndo&&(n=StateManager.createValueUndo(a),
n.name=a.undoLabel||"Change "+a.name,a.undoInstrument&&(n.instrument=Tracker.getCurrentInstrumentIndex(),n.id+=n.instrument),StateManager.registerEdit(n)),a.onChange(h))};a.getValue=function(){return h};a.getPrevValue=function(){return e};a.getItemAtPosition=function(n,r){r-=startY;n=Math.floor(r/lineHeight)+visibleIndex;if(0<=n&&n<items.length)return items[n]};a.onClick=function(){b||a.activate()};a.activate=function(){b||(m=h?h.length-1:-1,b=!0,Input.setFocusElement(a),l())};a.deActivate=function(n){if(b&&
(b=c=!1,a.refresh(),Input.clearFocusElement(),n&&a.onSubmit))a.onSubmit(h)};a.onKeyDown=function(n,r){var t=!1;switch(n){case 8:h&&0<=m&&(a.setValue(h.substr(0,m)+h.substr(m+1)),m--);t=!0;break;case 9:case 13:case 27:a.deActivate(13===n);t=!0;break;case 37:0<=m&&m--;a.refresh();t=!0;break;case 39:h&&(m++,m=Math.min(m,h.length-1),a.refresh());t=!0;break;case 46:h&&m<h.length-1&&a.setValue(h.substr(0,m+1)+h.substr(m+2));t=!0;break;case 89:case 90:if(Input.isMetaKeyDown()){a.deActivate();return}}!t&&
31<n&&(n=r.key,1===n.length&&n.match(/[a-z0-9\._:\- #]/i)&&(a.setValue(h.substr(0,m+1)+n+h.substr(m+1)),m++),t=!0);return t};var l=function(){b&&(c=!c,a.refresh(),setTimeout(l,300))};return a};UI.listbox=function(d,a,f,h){function e(){var u=l.length;r=Math.floor(c.height/18);c.centerSelection&&(r=1);var w=18,D=c.height-4-32,N=D;p=0;u>r&&(N=Math.floor(r/u*D),12>N&&(N=12),p=(D-N)/(u-r));n&&p&&(w=Math.floor(18+p*n));Q.setProperties({left:c.width-18,top:w,width:16,height:N})}function b(){var u=l.length-1;c.centerSelection||(u=l.length-r);0>u&&(u=0);return u}var c=UI.element(d,a,f,h,!0),m=c.selectedIndex=0,g=window.fontMed,k=window.fontSmall,l=[],n=0,r=0,t=10,p=0,z,y,B="left top width height name type onChange selectedIndex centerSelection".split(" ");
c.setProperties=function(u){B.forEach(function(w){"undefined"!=typeof u[w]&&(c[w]=u[w])});"undefined"!=typeof u.font&&(g=u.font);c.setSize(c.width,c.height);c.setPosition(c.left,c.top);A.setSize(c.width,c.height);e();E.setProperties({left:c.width-18,top:2,width:16,height:16,label:"\u2191"});U.setProperties({left:c.width-18,top:c.height-19,width:16,height:16,label:"\u2193"});c.centerSelection&&(t=Math.ceil((c.height-18)/2))};c.setSelectedIndex=function(u,w){c.selectedIndex=u;c.centerSelection&&(n=
c.selectedIndex);e();c.refresh();if(!w&&c.onChange&&m!=c.selectedIndex)c.onChange();m=c.selectedIndex};c.getSelectedIndex=function(){return c.selectedIndex};var A=UI.scale9Panel(0,0,c.width,c.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});A.ignoreEvents=!0;c.addChild(A);var E=UI.Assets.generate("button20_20");c.addChild(E);E.onClick=function(){c.navigateUp()};var U=UI.Assets.generate("button20_20");c.addChild(U);U.onClick=function(){c.navigateDown()};var Q=UI.scale9Panel(f-28,
18,16,h-3,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});Q.onDragStart=function(){Q.startDragIndex=n};Q.onDrag=function(u){l.length>r&&p&&(n=Math.floor(Q.startDragIndex+u.deltaY/p),n=Math.min(n,b()),n=Math.max(n,0),c.centerSelection?c.setSelectedIndex(n):e())};c.addChild(Q);c.navigateUp=function(){0<n&&(n--,e());c.centerSelection?c.setSelectedIndex(n):c.refresh()};c.navigateDown=function(){n<b()&&(n++,e());c.centerSelection?c.setSelectedIndex(n):c.refresh()};c.render=function(u){u=!!u;if(c.isVisible()){if(this.needsRendering){A.render();
for(var w=Y.getImage("line_hor"),D=0,N=l.length;D<N;D++){var R=l[D],S=10,W=6,G=t+18*(D-n);if(0<G&&G<c.height){var F=c.ctx,J=G,V=G>=c.height-18;if(V)if(F=c.height-G+1,1<F){var O=document.createElement("canvas");O.width=c.width-2;O.height=F;F=O.getContext("2d");J=4;W=6}else F=void 0;if(F){z+n===D&&(F.fillStyle="rgba(110,130,220,0.07)",F.fillRect(0,J-W,c.width-2,18));c.selectedIndex===D&&(F.fillStyle="rgba(110,130,220,0.15)",F.fillRect(0,J-W,c.width-2,18));R.level&&(S+=10*R.level);R.icon&&(F.drawImage(R.icon,
S,J-2),S+=R.icon.width+4);W=R.label;if(g){if(R.info){var I=6*R.info.length+20;k.write(F,R.info,c.width-I,J,0);W=W.substr(0,Math.floor((c.width-I-S-26)/g.charWidth))}g.write(F,W,S,J,0)}G+=11;J+=11;w&&F.drawImage(w,0,J,c.width-2,2);V&&c.ctx.drawImage(O,0,G-11-4)}}}Q.render();E.render();U.render()}this.needsRendering=!1;if(u)return c.canvas;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)}};c.setItems=function(u){l=u;n=Math.min(n,b());e();c.refresh()};c.getItems=function(){return l};c.getItemAtPosition=
function(u,w){w-=t;u=Math.floor(w/18)+n;if(0<=u&&u<l.length)return l[u]};c.insertItemAfterIndex=function(u,w,D){};c.onMouseWheel=function(u){0<u.mouseWheels[0]?c.navigateUp():c.navigateDown()};c.onDragStart=function(u){c.startDragIndex=n};c.onDrag=function(u){l.length>r&&(n=c.startDragIndex-Math.round(u.deltaY/18),n=Math.max(n,0),n=Math.min(n,b()),c.centerSelection?c.setSelectedIndex(n):e())};c.onHover=function(u){u=Math.floor((c.eventY-t)/18);u!==y&&(y=z=u,c.refresh())};c.onHoverExit=function(){z&&
(y=z=void 0,c.refresh())};return c};UI.radioGroup=function(d,a,f,h){var e=UI.element(d,a,f,h,!0),b=[],c,m="small",g="right",k=-3,l=13,n,r,t=["left","top","width","height","name"];e.setProperties=function(p){t.forEach(function(z){"undefined"!=typeof p[z]&&(e[z]=p[z])});e.setSize(e.width,e.height);e.setPosition(e.left,e.top);p.align&&(g=p.align);p.size&&(m=p.size);p.divider&&(n=p.divider);p.highLightSelection&&(r=!0)};e.onClick=function(p){e.setSelectedIndex(Math.floor((e.eventY-0+k)/l))};e.setSelectedIndex=function(p,z){p=Math.min(p,
b.length-1);for(var y=0,B=b.length;y<B;y++)b[y].active=y==p;e.selectedIndex=p;e.refresh();if(!z&&e.onChange&&c!=e.selectedIndex)e.onChange(e.selectedIndex);c=e.selectedIndex};e.getSelectedIndex=function(){return e.selectedIndex};e.getSelectedItem=function(){return b[e.selectedIndex]};e.render=function(p){p=!!p;if(e.isVisible()){if(this.needsRendering){e.clearCanvas();var z=Y.getImage("radio_active"),y=Y.getImage("radio_inactive");l=Math.floor(e.height/b.length);var B=fontSmall,A=5,E=e.width-15;k=
-3;"med"===m&&(z=Y.getImage("radio_big_active"),y=Y.getImage("radio_big_inactive"),k=-2,E=e.width-20,B=fontMed);var U=Math.floor((l-B.charHeight)/2);"left"===g&&(A=30,E=5);for(var Q=Y.getImage("line_hor"),u=0,w=b.length;u<w;u++){var D=b[u],N=u*l,R=N+U;"line"==n&&0<u&&e.ctx.drawImage(Q,0,N,e.width,2);if(B){var S=D.label;if("right"===g&&(A=E-B.getTextWidth(D.label,0)-4,0>A&&D.labels)){var W=E-4;D.labels.forEach(function(G){G.width<=W&&(S=G.label)});A=E-B.getTextWidth(S,0)-4}B.write(e.ctx,S,A,R,0)}D.active?
(r&&(e.ctx.fillStyle="rgba(100,100,255,0.1",e.ctx.fillRect(0,N,e.width-2,l)),e.ctx.drawImage(z,E,R+k)):e.ctx.drawImage(y,E,R+k)}}this.needsRendering=!1;if(p)return e.canvas;e.parentCtx.drawImage(e.canvas,e.left,e.top,e.width,e.height)}};e.setItems=function(p){e.selectedIndex=void 0;b=p;p=0;for(var z=b.length;p<z;p++)b[p].active&&(e.selectedIndex=p);e.refresh()};e.getItemAtPosition=function(p,z){p=Math.floor((z-0)/l)+visibleIndex;if(0<=p&&p<b.length)return b[p].index=p,b[p]};return e};UI.checkbox=function(d,a,f,h){var e=UI.element(d,a,f||14,h||14,!0),b="left top width height name type checked".split(" ");e.setProperties=function(c){b.forEach(function(m){"undefined"!=typeof c[m]&&(e[m]=c[m])});e.setSize(e.width,e.height);e.setPosition(e.left,e.top)};e.setState=function(c,m){e.checked=c;e.refresh();if(e.onToggle&&!m)e.onToggle(e.checked)};e.onClick=function(c){e.setState(!e.checked)};e.check=function(){e.setState(!0)};e.unCheck=function(){e.setState(!1)};e.toggle=function(){e.setState(!e.checked)};
e.render=function(c){c=!!c;if(e.isVisible()){if(this.needsRendering){e.clearCanvas();var m=e.checked?Y.getImage("checkbox_on"):Y.getImage("checkbox_off");e.ctx.drawImage(m,0,0)}this.needsRendering=!1;if(c)return e.canvas;e.parentCtx.drawImage(e.canvas,e.left,e.top,e.width,e.height)}};return e};UI.numberDisplay=function(d){function a(u){U.forEach(function(w){if("undefined"!=typeof u[w])switch(w){case "value":c=u[w];break;case "onChange":p=u[w];break;case "min":g=u[w];break;case "max":k=u[w];break;case "step":l=u[w];break;case "size":z=u[w];break;case "autoPadding":B=!!u[w];break;default:b[w]=u[w]}});y="big"===z?window.fontLedBig:window.fontLed;E=A[z]}function f(){for(var u=""+c;u.length<b.padLength;)u=" "+u;return u}function h(u){r=u;u=f().length;var w=u-(""+c).length;r>u&&(r=u);r<w&&(r=
w);b.refresh()}function e(u){var w=f().split("");w.splice(r+u,1);u=parseInt(w.join("").trim());isNaN(u)&&(u=0);b.updateValue(u)}var b=UI.element();b.type="numberDisplay";b.isActive=!1;b.isDisabled=!1;b.padLength=4;var c=0,m=0,g=0,k=100,l=1,n,r=0,t,p,z="medium",y,B=!1,A={small:{x:4,y:3,c:0},medium:{x:6,y:7,c:0},big:{x:7,y:4,c:-2}},E=A.medium,U="left top width height name value onChange min max step padLength size autoPadding trackUndo undoLabel undoInstrument".split(" ");d&&a(d);b.setProperties=function(u){a(u);
b.setSize(b.width,b.height);b.setPosition(b.left,b.top);9999<k&&5>b.padLength&&(b.padLength=5)};b.setValue=function(u,w){u!==c&&(m=c);c=u;b.refresh();!w&&p&&(b.trackUndo&&(u=StateManager.createValueUndo(b),u.name=b.undoLabel||"Change "+b.name,b.undoInstrument&&(u.instrument=Tracker.getCurrentInstrumentIndex(),u.id+=u.instrument),StateManager.registerEdit(u)),p(c))};b.updateValue=function(u){u>k&&(u=k);u<g&&(u=g);b.setValue(u)};b.getValue=function(){return c};b.getPrevValue=function(){return m};b.setDisabled=
function(u){"undefined"==typeof u&&(u=!0);if(b.isDisabled=u)b.isActive=!1;b.refresh()};b.setFocus=function(u){(n=!!u)?(Input.setFocusElement(b),r=f().length,Q()):Input.clearFocusElement();b.refresh()};b.togglFocus=function(){b.setFocus(!n)};b.setMax=function(u,w){k=u;!w&&c>k&&b.setValue(k)};b.setMin=function(u){g=u;c<g&&b.setValue(g)};b.onClick=function(){b.isDisabled||p&&b.togglFocus()};b.onMouseWheel=function(u){b.isDisabled||p&&(0<u.mouseWheels[0]?b.updateValue(c+l):b.updateValue(c-l))};b.onKeyDown=
function(u,w){u=w.key;switch(w.keyCode){case 8:e(-1);break;case 9:case 13:case 27:Input.clearFocusElement();break;case 37:h(r-1);break;case 38:b.updateValue(c+1);break;case 39:h(r+1);break;case 40:b.updateValue(c-1);break;case 46:e(0)}switch(u){case "0":case "1":case "2":case "3":case "4":case "5":case "6":case "7":case "8":case "9":case "-":w=f().split(""),w.splice(r,0,u),w=parseInt(w.join("").trim()),isNaN(w)&&(w=0),b.updateValue(w)}return!0};b.onResize=function(){B&&(b.padLength=Math.floor(b.width/
8)-1)};b.activate=function(){n=!0;r=f().length;t=!0;Q()};b.deActivate=function(){n&&(t=n=!1,b.refresh(),Input.clearFocusElement())};b.render=function(u){if(b.isVisible()){var w=n?"panel_inset_dark_active":"panel_inset_dark_inactive";if(b.needsRendering){u=!!u;b.ctx.clearRect(0,0,b.width,b.height);var D=b.paddingLeft||0,N=b.paddingTop||0,R=b.width-D-(b.paddingRight||0),S=b.height-N-(b.paddingBottom||0);b.ctx.drawImage(Y.getImage(w),D,N,R,S);y&&(D+=E.x,N=E.y,y.write(b.ctx,f(),D,N,0),t&&(b.ctx.fillStyle=
"rgba(255,201,65,0.7)",b.ctx.fillRect(D+r*y.charWidth+E.c,N,2,y.charHeight)));b.renderInternal&&b.renderInternal();b.isDisabled&&(b.ctx.fillStyle="rgba(34, 49, 85, 0.6)",b.ctx.fillRect(0,0,b.width,b.height))}b.needsRendering=!1;if(u)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)}};var Q=function(){n?(t=!t,setTimeout(Q,300)):t=!1;b.refresh()};return b};UI.modalDialog=function(d){var a=UI.element(),f="",h,e="left top width height name ok cancel input".split(" ");a.setProperties=function(g){e.forEach(function(n){"undefined"!==typeof g[n]&&(a[n]=g[n])});a.setSize(a.width,a.height);a.setPosition(a.left,a.top);var k=200;a.height<k&&(k=a.height-20);var l=Math.max(Math.floor(a.width/2),380);b.setSize(l,k);b.setPosition(Math.floor((a.width-l)/2),Math.floor((a.height-k)/2));a.cancel?(c.setPosition(b.left+Math.floor(b.width/2)-110,b.top+b.height-40),m.setPosition(b.left+
Math.floor(b.width/2)+10,b.top+b.height-40)):c.setPosition(b.left+Math.floor(b.width/2)-50,b.top+b.height-40);a.input&&(h||(h=UI.inputbox({name:"dialoginput",width:200,height:28,value:"",onChange:function(){a.inputValue=h.getValue()},onSubmit:function(n){a.inputValue=n;a.onKeyDown(13)}}),a.addChild(h),setTimeout(function(){h.activate()},0)),h.setProperties({left:b.left+50,top:b.top+b.height-80,width:b.width-100,height:28}))};var b=UI.scale9Panel(0,0,Math.floor(a.width/2),200,UI.Assets.panelMainScale9);
b.ignoreEvents=!0;a.addChild(b);var c=UI.Assets.generate("buttonLight");c.setProperties({name:"okbutton",label:"OK",width:100,height:28});a.addChild(c);var m=UI.Assets.generate("buttonLight");m.setProperties({name:"cancelbutton",label:"Cancel",width:100,height:28});a.addChild(m);a.onKeyDown=function(g){switch(g){case 13:return a.close(),!0}};a.render=function(g){g=!!g;if(this.needsRendering){a.clearCanvas();a.ctx.fillStyle="rgba(0,0,0,0.6)";a.ctx.fillRect(0,0,a.width,a.height);b.render();if(f){var k=
f.split("/"),l=b.top+20,n=b.width-20;k.forEach(function(r){if(fontFT){var t=fontFT.getTextWidth(r,0);t=b.left+10+Math.floor((n-t)/2);fontFT.write(a.ctx,r,t,l,0)}l+=12})}a.ok&&c.render();a.cancel&&m.render();h&&h.render()}this.needsRendering=!1;if(g)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)};a.setText=function(g){f=g};a.getText=function(){return f};a.close=function(){a.hide();if(a.onClose)a.onClose();UI.removeModalElement();a=null};return a};UI.scale9Panel=function(d,a,f,h,e){var b=UI.element(d,a,f,h,!0);b.type="scale9";e.scale=e.scale||"stretch";b.setProperties=function(c){var m="left top width height name type".split(" ");if(!c){var g={};m.forEach(function(k){g[k]=b[k]});return g}m.forEach(function(k){"undefined"!=typeof c[k]&&(b[k]=c[k])});"undefined"!==typeof c.img&&(e.img=c.img);"undefined"!==typeof c.scale&&(e.scale=c.scale);"undefined"!==typeof c.imgTop&&(e.top=c.imgTop);"undefined"!==typeof c.imgBottom&&(e.bottom=c.imgBottom);
"undefined"!==typeof c.imgLeft&&(e.left=c.imgLeft);"undefined"!==typeof c.imgRight&&(e.right=c.imgRight);b.setSize(b.width,b.height);b.setPosition(b.left,b.top)};b.render=function(c){c=!!c;if(b.isVisible()){if(b.needsRendering){var m=e.img;if(m){var g=m.width-e.left-e.right,k=m.height-e.top-e.bottom,l=b.width-e.left-e.right,n=b.height-e.top-e.bottom;b.clearCanvas();e.top&&e.left&&b.ctx.drawImage(m,0,0,e.left,e.top,0,0,e.left,e.top);e.top&&b.ctx.drawImage(m,e.left,0,g,e.top,e.left,0,l,e.top);e.top&&
e.right&&b.ctx.drawImage(m,e.left+g,0,e.right,e.top,e.left+l,0,e.right,e.top);e.left&&b.ctx.drawImage(m,0,e.top,e.left,k,0,e.top,e.left,n);"stretch"===e.scale&&b.ctx.drawImage(m,e.left,e.top,g,k,e.left,e.top,l,n);if("repeatX"===e.scale)for(var r=e.left,t=e.left+l,p;r<t;)p=g,r+p>t&&(p=t-r),b.ctx.drawImage(m,e.left,e.top,p,k,r,e.top,p,k),r+=p;if("repeatY"===e.scale)for(r=e.top,t=e.top+n;r<t;)p=k,r+p>t&&(p=t-r),b.ctx.drawImage(m,e.left,e.top,g,p,e.left,r,g,p),r+=p;e.right&&b.ctx.drawImage(m,e.left+g,
e.top,e.right,k,e.left+l,e.top,e.right,n);e.bottom&&e.left&&b.ctx.drawImage(m,0,e.top+k,e.left,e.bottom,0,e.top+n,e.left,e.bottom);e.bottom&&b.ctx.drawImage(m,e.left,e.top+k,g,e.bottom,e.left,e.top+n,l,e.bottom);e.bottom&&e.right&&b.ctx.drawImage(m,e.left+g,e.top+k,e.right,e.bottom,e.left+l,e.top+n,e.right,e.bottom)}}b.needsRendering=!1;if(c)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top)}};return b};var BitmapFont=function(){var d={},a,f=[],h,e,b,c=!1;d.generate=function(m){var g=m.image,k=m.startX,l=m.startY;a=m.charWidth;var n=m.charHeight;b=m.spaceWidth||8;var r=m.margin,t=m.lineSpacing||0,p=m.charsPerLine,z=m.chars||"ABCDEFGHIJKLMNOPQRSTUVWXYZ";c=m.onlyUpperCase;d.fontArray=[];d.colors={};e=r;h=n;d.fixedWidth=!0;d.charHeight=n;"number"!==typeof a&&(d.fixedWidth=!1,"string"===typeof a&&(a=a.split(""),a.forEach(function(R,S){a[S]=parseInt(R)})));d.charWidth=a;m=k;for(var y=l,B=0,A=0,E=0,U=
z.length;E<=U;E++){var Q=document.createElement("canvas");var u=d.fixedWidth?a:a[E];u=u||1;Q.width=u;Q.height=n;var w=Q.getContext("2d");if(d.fixedWidth)var D=k+E%p*(u+r),N=l+Math.floor(E/p)*(n+t);else D=m,N=y,m+=u+r,A++,A>=p[B]&&(B++,A=0,m=k,y+=h+t);w.drawImage(g,D,N,u,n,0,0,u,n);w=z.charCodeAt(E);d.fontArray[w]=Q;f[w]=u}};d.generateColor=function(m,g){m=m||"green";g=g||"rgba(107, 161, 65,0.9)";var k=[];d.fontArray.forEach(function(l,n){var r=document.createElement("canvas"),t=document.createElement("canvas");
r.width=l.width;r.height=l.height;t.width=l.width;t.height=l.height;var p=r.getContext("2d"),z=t.getContext("2d");z.fillStyle=g;z.fillRect(0,0,16,16);z.globalCompositeOperation="destination-atop";z.drawImage(l,0,0);p.drawImage(t,0,0);p.globalCompositeOperation="darken";p.drawImage(l,0,0);k[n]=r});d.colors[m]=k};d.getTextWidth=function(m,g){c&&(m=m.toUpperCase());g=g||e;for(var k=0,l=0,n=m.length;l<n;l++){var r=m.charCodeAt(l);k+=(f[r]||b)+g}return k};d.write=function(m,g,k,l,n,r,t,p,z){c&&(g=g.toUpperCase());
r=d.colors[r]||d.fontArray;n=n||e;l=l||0;k=k||0;t=0;for(p=g.length;t<p;t++){z=g.charCodeAt(t);var y=r[z],B=f[z];B||(32!==z&&console.warn("no font for char "+z),B=b);y&&m.drawImage(y,k,l,B,h);k+=B+n}};return d};UI.knob=function(d){var a=UI.element();a.type="knob";var f="",h=50,e=h,b="left top width height name font label textAlign paddingTop disabled".split(" "),c=Y.getImage("knob_back"),m=Y.getImage("knob_back_inactive"),g=Y.getImage("knob_front");a.width=c.width+32;a.height=c.height+32;a.setSize(a.width,a.height);a.setProperties=function(k){b.forEach(function(l){if("undefined"!=typeof k[l])switch(l){case "label":f=k[l];break;case "font":break;case "textAlign":break;case "paddingTop":parseInt(k[l]);break;
case "disabled":a.isDisabled=!!k[l];default:a[l]=k[l]}});a.setSize(a.width,a.height);a.setPosition(a.left,a.top)};a.setFont=function(k){a.refresh()};a.setLabel=function(k){f=k;a.refresh()};a.getLabel=function(){return f};a.setValue=function(k){a.refresh()};a.getValue=function(){return h};a.render=function(k){if(a.needsRendering){k=!!k;a.clearCanvas();var l=.8*c.width,n=.8*c.height,r=l/2,t=n/2;a.ctx.save();a.ctx.translate(16+r,16+t);a.ctx.drawImage(a.isDisabled?m:c,-r,-t,l,n);var p=-230*Math.PI/180,
z=(-230+h/100*280)*Math.PI/180;a.ctx.fillStyle=a.isDisabled?"rgba(170,170,170,0.5)":"rgba(130,200,255,0.5)";a.ctx.beginPath();a.ctx.arc(0,0,30,p,z,!1);a.ctx.arc(0,0,25,z,p,!0);a.ctx.fill();a.ctx.rotate((h/100*320-160)*Math.PI/180);a.ctx.drawImage(g,-r,-t,l,n);a.ctx.restore();f&&fontSmall.write(a.ctx,f,16+r-3*f.length,n+16+4)}a.needsRendering=!1;if(k)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)};a.onDragStart=function(){e=h};a.onDrag=function(k){if(!a.isDisabled&&(h=
e+k.deltaY,h=Math.max(h,0),h=Math.min(h,100),a.refresh(),a.onChange))a.onChange(h)};a.onClick=function(k){3>Math.abs(k.x-k.startX)&&3>Math.abs(k.y-k.startY)&&a.toggleDisabled()};a.toggleDisabled=function(){a.isDisabled=!a.isDisabled;if(a.onToggle)a.onToggle(!a.isDisabled);a.refresh()};return a};UI.rangeSlider=function(d){var a=UI.element();a.type="rangeslider";var f="left top width height name onChange".split(" "),h=Y.getImage("slider_knob"),e=Y.getImage("slider_knob_vert"),b=Y.getImage("slider_back"),c=Y.getImage("slider_back_vert"),m=!1,g=0,k=UI.scale9Panel(0,0,0,0,{img:b,left:4,right:4,top:0,bottom:0,scale:"repeatX"});a.addChild(k);k.ignoreEvents=!0;var l=0,n=0,r=0,t=0,p=0,z=100,y=0;a.setProperties=function(B){f.forEach(function(A){"undefined"!=typeof B[A]&&(a[A]=B[A])});a.setSize(a.width,
a.height);a.setPosition(a.left,a.top);"undefined"!==typeof B.min&&(p=B.min);"undefined"!==typeof B.max&&(z=B.max);"undefined"!==typeof B.value&&a.setValue(B.value,!0);"undefined"!==typeof B.vertical&&(m=!!B.vertical,k.setProperties({img:c,imgLeft:0,imgRight:0,imgTop:4,imgBottom:4,scale:"repeatY"}))};a.getValue=function(){return y};a.setValue=function(B,A){B>z&&(B=z);B<p&&(B=p);var E=!A&&y!==B;y=B;m?n=g*(1-(B-p)/(z-p)):l=(a.width-h.width)*B/z;a.refresh();if(E&&!A&&a.onChange)a.onChange(y)};a.setMax=
function(B,A){z=B;!A&&y>z&&a.setValue(z)};a.setMin=function(B,A){p=B;!A&&y<p&&a.setValue(p)};a.render=function(B){if(a.needsRendering){B=!!B;a.clearCanvas();var A=Math.floor(a.width/2)+3,E=a.height;0>p&&(E=Math.floor(E/2));a.ctx.fillStyle="rgba(255,255,255,0.1";a.ctx.beginPath();a.ctx.moveTo(A,E);a.ctx.lineTo(A,2);a.ctx.lineTo(A+6,2);a.ctx.fill();0>p?(a.ctx.beginPath(),a.ctx.moveTo(A-6,E),a.ctx.lineTo(A-6,a.height),a.ctx.lineTo(A-6-6,a.height)):(a.ctx.beginPath(),a.ctx.moveTo(A-6,E),a.ctx.lineTo(A-
6,2),a.ctx.lineTo(A-6-6,2));a.ctx.fill();k.render();m?a.ctx.drawImage(e,-1,n,e.width,e.height):a.ctx.drawImage(h,l,-1,h.width,h.height)}a.needsRendering=!1;if(B)return a.canvas;a.parentCtx.drawImage(a.canvas,a.left,a.top,a.width,a.height)};a.onResize=function(){g=a.height-e.height+3;k.setSize(a.width,a.height);a.setValue(y,!0)};a.onDragStart=function(){r=l;t=n};a.onDrag=function(B){m?(B=B.deltaY,n=t+B,0>n&&(n=0),n>g&&(n=g),g>h.height?(B=z-p,y=B-Math.round(B*n/g)+p):y=z):(B=B.deltaX,l=r+B,0>l&&(l=
0),B=a.width-h.width,l>B&&(l=B),y=B>h.width?Math.round(z*l/B):0);a.refresh();if(a.onChange)a.onChange(y)};d&&a.setProperties(d);return a};UI.menu=function(d,a,f,h,e){function b(p){if(m&&m.length)for(var z=0,y=m.length;z<y;z++){var B=m[z];if(p>=B.startX-12&&p<=B.startX+B.width+12)return z}return-1}var c=UI.element(d,a,f,h);c.keepSelection=!0;var m,g="left top width height name type background layout".split(" "),k,l=[],n,r,t;c.setProperties=function(p){g.forEach(function(z){"undefined"!=typeof p[z]&&(c[z]=p[z])});p.background&&(k=UI.scale9Panel(0,0,c.width,c.height,p.background),k.ignoreEvents=!0,c.addChild(k));c.setSize(c.width,c.height);
c.setPosition(c.left,c.top)};c.onClick=function(p){if(Host.showInternalMenu){var z=b(p.x);m.forEach(function(B,A){A!==z&&B.subMenu&&B.subMenu.hide()});if(!(0>z)){var y=m[z];n=void 0;Input.setFocusElement(c);y.subMenu&&(y.subMenu.setPosition((y.startX||0)+(p.globalX-p.x),c.height),y.subMenu.toggle(),y.subMenu.parent.refresh(),y.subMenu.isVisible()&&(n=z));y.command&&EventBus.trigger(EVENT.command,y.command)}}};c.onHover=function(p){Host.showInternalMenu&&(p=b(c.eventX),p!==t&&(t=r=p,c.refresh()),0>
p||0<=n&&n!==p&&c.activateSubmenu(p))};c.onHoverExit=function(){r&&(t=r=void 0,c.refresh())};c.onKeyDown=function(p){switch(p){case 13:if(p=c.getActiveSubItem())if(p.item.subMenu&&p.item.subMenu.isVisible()&&0<=p.item.subMenu.getSelectedIndex()){var z=p.item.subMenu.getSelectedIndex();(z=p.item.subMenu.getItems()[z])&&p.item.subMenu.executeItem(z)}else p.menu.executeItem(p.item);z=!0;break;case 27:c.deActivate();z=!0;break;case 37:0<=n&&((p=c.getActiveSubItem())&&p.item.subMenu&&p.item.subMenu.isVisible()?
p.menu.deActivateSubmenu():c.activateSubmenu(Math.max(n-1,0)));z=!0;break;case 39:0<=n&&((p=c.getActiveSubItem())&&p.item.subMenu&&!p.item.subMenu.isVisible()?p.menu.activateSubmenu(p.item):c.activateSubmenu(Math.min(n+1,m.length-1)));z=!0;break;case 38:0<=n&&((p=c.getActiveSubItem())&&p.item.subMenu&&p.item.subMenu.isVisible()?p.item.subMenu.setSelectedIndex(p.item.subMenu.getSelectedIndex()-1):(p=m[n])&&p.subMenu&&p.subMenu.setSelectedIndex(p.subMenu.getSelectedIndex()-1));z=!0;break;case 40:0<=
n&&((p=c.getActiveSubItem())&&p.item.subMenu&&p.item.subMenu.isVisible()?p.item.subMenu.setSelectedIndex(p.item.subMenu.getSelectedIndex()+1):(p=m[n])&&p.subMenu&&p.subMenu.setSelectedIndex(p.subMenu.getSelectedIndex()+1)),z=!0}return z};c.deActivate=function(p){if(0<=n){var z=m[n];!z||!z.subMenu||p&&"submenu"===p.type&&p.mainMenu&&p.mainMenu.name===c.name||(z.subMenu.hide(),n=void 0,c.refresh(),Input.clearFocusElement())}};c.activateSubmenu=function(p){if(p!==n){n=p;m.forEach(function(y,B){B!==n&&
y.subMenu&&y.subMenu.hide()});var z=m[p];z&&z.subMenu&&(n=p,z.subMenu.setPosition((z.startX||0)+c.left,c.height),z.subMenu.toggle(),z.subMenu.parent.refresh())}};c.getActiveSubItem=function(){if(0<=n){var p=m[n];if(p&&p.subMenu){var z=p.subMenu.getSelectedIndex();if(0<=z)return{menu:p.subMenu,item:p.subMenu.getItems()[z]}}}};c.render=function(p){if(c.isVisible()){p=!!p;if(this.needsRendering){var z=10;c.clearCanvas();k&&k.render();l.length?l.forEach(function(y){y.render()}):m&&m.forEach(function(y,
B){var A=9*y.label.length;y.startX=z;y.width=A;B===r&&(c.ctx.fillStyle="rgba(179,195,243,0.1)",c.ctx.fillRect(z-12,0,A+20,30));fontMed.write(c.ctx,y.label,z,10);z+=A+24})}this.needsRendering=!1;if(p)return c.canvas;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)}};c.setItems=function(p){m=p;e=e||c.parent;l=[];var z={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},y=3,B=3;m.forEach(function(A,
E){if("buttons"===c.layout){var U=UI.button(y,B,60,18);y+=60;1===E&&(y=3,B+=18);U.setProperties(z);U.setLabel(A.label);A.onClick&&(U.onClick=function(){A.onClick()});l.push(U);c.addChild(U)}A.subItems&&(E=UI.submenu(),E.setProperties({background:UI.Assets.buttonLightScale9}),E.hide(),E.setItems(A.subItems),E.zIndex=200,e.addChild(E),E.mainMenu=c,A.subMenu=E)});c.zIndex=9;c.refresh()};c.getItems=function(){return m};return c};UI.submenu=function(d,a,f,h){function e(t){return"function"===typeof t.disabled?t.disabled():!!t.disabled}function b(t){return"function"===typeof t.label?t.label():t.label}var c=UI.element(d,a,f,h);c.type="submenu";var m,g="left top width height name type".split(" "),k,l,n,r;c.setProperties=function(t){g.forEach(function(p){"undefined"!=typeof t[p]&&(c[p]=t[p])});t.background&&(k=UI.scale9Panel(0,0,c.width,c.height,t.background),k.ignoreEvents=!0,c.addChild(k));c.setSize(c.width,c.height);c.setPosition(c.left,
c.top)};c.onHover=function(t){t=Math.floor(c.eventY/26);t!==n&&c.setSelectedIndex(t)};c.onHoverExit=function(){l&&(n=l=void 0,c.refresh())};c.onShow=function(){n=l=0};c.onHide=function(){r&&(r.subMenu.hide(),r=void 0)};c.setSelectedIndex=function(t){l=Math.min(t,m.length-1);0>l&&(l=0);n=l;t=m[l];t.subItems?c.activateSubmenu(t):r&&(r.subMenu.hide(),r=void 0);c.refresh()};c.getSelectedIndex=function(){return"undefined"!==typeof l?l:-1};c.onClick=function(t){m&&m.length&&c.executeItem(m[Math.floor(c.eventY/
26)])};c.executeItem=function(t){!e(t)&&t&&(t.command?(c.hide(),c.parent.refresh(),c.mainMenu&&c.mainMenu.deActivate(),EventBus.trigger(EVENT.command,t.command)):t.subItems&&c.toggleSubmenu(t))};c.activateSubmenu=function(t){if(!t.subMenu){var p=UI.submenu();p.setProperties({background:UI.Assets.buttonLightScale9});p.hide();p.setItems(t.subItems);p.zIndex=300;c.parent.addChild(p);p.mainMenu=c.mainMenu;t.subMenu=p}p=c.left+c.width-20;p+t.subMenu.width>UI.mainPanel.width&&(p=UI.mainPanel.width-t.subMenu.width);
t.subMenu.setPosition(p,c.top+26*t.index);t.subMenu.show();r=t;c.refresh()};c.deActivateSubmenu=function(){r&&(r.subMenu.hide(),r=void 0,c.refresh())};c.toggleSubmenu=function(t){t.subMenu&&t.subMenu.isVisible()?c.deActivateSubmenu():c.activateSubmenu(t)};c.render=function(t){if(c.isVisible()){t=!!t;if(this.needsRendering){c.clearCanvas();k&&k.render();for(var p=Y.getImage("line_hor"),z=0,y=c.width-3,B=m.length-1,A=0;A<=B;A++){var E=m[A],U=e(E);A!==l||U||(c.ctx.fillStyle="rgba(255,255,255,0.2)",c.ctx.fillRect(0,
z,y,26));E.label&&fontFT.write(c.ctx,b(E),9,z+9);E.subItems&&fontMed.write(c.ctx,">",c.width-16,z+9+2);U&&(c.ctx.fillStyle="rgba(88,105,129,0.6)",c.ctx.fillRect(0,z,y,26));z+=26;A<B&&c.ctx.drawImage(p,0,z,y,2)}}this.needsRendering=!1;if(t)return c.canvas;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)}};c.setItems=function(t){m=t;var p=50;m.forEach(function(z,y){var B=z.label?9*b(z).length:0;p=Math.max(p,B+24);z.index=y});c.setSize(p,26*m.length+4);k&&k.setSize(c.width,c.height);r=n=
l=void 0;c.refresh()};c.getItems=function(){return m};return c};UI.animsprite=function(d,a,f,h,e,b){f=f||14;h=h||14;var c=UI.element(d,a,f,h,!0),m=["left","top","width","height","name"];c.setProperties=function(l){m.forEach(function(n){"undefined"!=typeof l[n]&&(c[n]=l[n])});c.setSize(c.width,c.height);c.setPosition(c.left,c.top)};var g=Y.getImage(e),k=0;c.onShow=function(){UI.ticker.onEachTick2(function(){k++;k>=b&&(k=0);c.refresh()},0)};c.onHide=function(){UI.ticker.onEachTick2()};c.render=function(l){l=!!l;this.needsRendering&&(c.clearCanvas(),c.ctx.drawImage(g,
k*f,0,f,h,0,0,f,h));this.needsRendering=!1;if(l)return c.canvas;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)};return c};UI.app_songPatternList=function(d){function a(k){k=""+k;2>k.length&&(k="0"+k);return k}var f=UI.panel(),h=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);f.addChild(h);var e=UI.listbox();e.setItems([{label:"01:00",data:1}]);e.onClick=function(){var k=e.getItemAtPosition(e.eventX,e.eventY);if(k){var l=k.index;k!==e.getSelectedIndex()&&e.setSelectedIndex(l)}};f.addChild(e);var b=UI.Assets.generate("button20_20");b.setLabel("\u2191");b.onDown=function(){var k=e.getSelectedIndex(),l=Tracker.getSong().patternTable[k];
l++;Tracker.updatePatternTable(k,l);UI.ticker.onEachTick4(function(){var n=e.getSelectedIndex(),r=Tracker.getSong().patternTable[n];r++;Tracker.updatePatternTable(n,r)},5)};b.onTouchUp=function(){UI.ticker.onEachTick4()};f.addChild(b);var c=UI.Assets.generate("button20_20");c.setLabel("\u2193");c.onDown=function(){var k=e.getSelectedIndex(),l=Tracker.getSong().patternTable[k];0<l&&l--;Tracker.updatePatternTable(k,l);UI.ticker.onEachTick4(function(){var n=e.getSelectedIndex(),r=Tracker.getSong().patternTable[n];
0<r&&r--;Tracker.updatePatternTable(n,r)},5)};c.onTouchUp=function(){UI.ticker.onEachTick4()};f.addChild(c);var m=UI.Assets.generate("button20_20");m.setLabel("Ins");m.onDown=function(){var k=e.getSelectedIndex();Editor.addToPatternTable(k)};m.setProperties({width:40,height:20});f.addChild(m);var g=UI.Assets.generate("button20_20");g.setLabel("Del");g.onDown=function(){var k=e.getSelectedIndex();Editor.removeFromPatternTable(k)};g.setProperties({width:40,height:20});f.addChild(g);f.onResize=function(){h.setSize(f.width,
f.height);e.setProperties({left:0,top:0,width:f.width-42,height:f.height,centerSelection:!0,onChange:function(){Tracker.setCurrentSongPosition(e.getSelectedIndex(),!0)}});c.setPosition(f.width-22,Math.floor(f.height/2)-10);b.setPosition(f.width-42,c.top);m.setPosition(b.left,b.top-22);g.setPosition(b.left,b.top+22)};EventBus.on(EVENT.patternTableChange,function(k){f.setPatternTable(Tracker.getSong().patternTable)});f.setPatternTable=function(k){for(var l=[],n=0,r=Tracker.getSong().length;n<r;n++){var t=
k[n];l.push({label:a(n+1)+":"+a(t),data:t,index:n})}e.setItems(l)};EventBus.on(EVENT.songLoaded,function(k){f.setPatternTable(k.patternTable)});EventBus.on(EVENT.songPositionChange,function(k){e.setSelectedIndex(k,!0)});return f};UI.pattern_sidebar=function(){var d=UI.panel();d.setProperties({name:"sideButtonPanel"});var a=UI.label();a.setProperties({label:"DEMOSONGS:",font:fontFT});for(var f=[],h=[],e=0;e<h.length;e++){var b=h[e],c=UI.button();c.info=b;c.onClick=b.onClick;f[e]=c;d.addChild(c)}var m=UI.button();m.setProperties({label:"",textAlign:"center",background:UI.Assets.buttonLightScale9,hoverBackground:UI.Assets.buttonLightHoverScale9,image:Y.getImage("piano"),font:window.fontMed});m.onClick=function(){App.doCommand(COMMAND.togglePiano)};
d.addChild(m);var g=UI.button();g.setProperties({label:"",textAlign:"center",background:UI.Assets.buttonLightScale9,hoverBackground:UI.Assets.buttonLightHoverScale9,image:Y.getImage("nibbles")});g.onClick=function(){App.doCommand(COMMAND.nibbles)};d.addChild(g);d.onResize=function(){a.setSize(d.width,Layout.trackControlHeight);m.setProperties({left:0,top:d.height-30,width:d.width,height:30});g.setProperties({left:0,top:d.height-30-30,width:d.width,height:30});var k=h.length;for(e=0;e<k;e++){var l=
f[e],n=30*e+a.height,r=0;n>g.top-30&&(r=-500);var t=UI.Assets.buttonLightScale9,p=UI.Assets.buttonLightHoverScale9;e>k-3&&(t=UI.Assets.panelDarkScale9,p=UI.Assets.panelDarkHoverScale9);l.setProperties({left:r,top:n,width:d.width,height:30,label:l.info.label,textAlign:"left",background:t,hoverBackground:p,font:window.fontFT})}};d.onResize();return d};UI.app_sidebar=function(){function d(p){var z=l[p];z&&(k.setSelectedIndex(p),n=p,r=!0,Tracker.autoPlay=!0,Tracker.load(z.url))}function a(){r&&(n++,n>=l.length&&(n=0),Tracker.stop(),d(n))}var f=UI.panel(0,0,200,200);f.setProperties({name:"sideBar"});var h=UI.scale9Panel(0,0,f.width,f.height,{img:Y.getImage("background"),left:3,top:3,right:4,bottom:4});h.ignoreEvents=!0;f.addChild(h);var e=UI.label();e.setProperties({label:"Playlist:",font:fontFT});f.addChild(e);var b=UI.Assets.generate("buttonKey");
f.addChild(b);b.onClick=function(){App.doCommand(COMMAND.toggleAppSideBar)};var c=UI.Assets.generate("buttonKey");c.setLabel("Next");c.onClick=function(){a()};var m=UI.Assets.generate("buttonKey");m.setLabel("Toggle UI");m.onClick=function(){};var g=UI.scale9Panel(0,0,f.width,f.height,{img:Y.getImage("background"),left:3,top:3,right:4,bottom:4});g.ignoreEvents=!0;f.addChild(g);f.addChild(c);f.addChild(m);var k=UI.listbox(2,50,100,100);k.setProperties({font:window.fontFT});f.addChild(k);var l=[{label:"Demomusic",
url:"demomods/demomusic.mod"},{label:"Stardust Memories",url:"demomods/StardustMemories.mod"},{label:"Space Debry",url:"demomods/spacedeb.mod"}],n=0,r=!1;k.onChange=function(p){};k.onClick=function(){var p=k.getItemAtPosition(k.eventX,k.eventY);p&&p.url&&d(p.index)};f.onResize=function(){h.setSize(f.width,f.height);b.setPosition(f.width-22,2);e.setSize(f.width,Layout.trackControlHeight);g.setPosition(2,32);g.setSize(f.width-4,54);c.setPosition(8,36);c.setProperties({width:50>f.width?20:100});c.setLabel(50>
f.width?">":"Next");m.setPosition(8,56);m.setProperties({width:50>f.width?20:100});m.setLabel(50>f.width?"-":"Toggle UI");k.setProperties({left:2,top:88,width:f.width-4,height:f.height-88-Layout.defaultMargin});50>f.width?(e.hide(),g.hide(),k.hide(),c.setPosition(2,36)):(e.show(),g.show(),k.show())};EventBus.on(EVENT.songEnd,function(){a()});f.onResize();var t=Host.getBaseUrl()+"demomods/Playlist/";FetchService.get(t+"list.txt",function(p){p=p.split("\n");p.forEach(function(z){z&&l.push({label:z,
url:t+z})});l.forEach(function(z,y){z.index=y});n=0;r=!1;k.setItems(l)});return f};UI.app_panelContainer=function(d){var a=UI.panel(0,0,canvas.width,d,!0),f=UI.scale9Panel(0,0,a.width,a.height,UI.Assets.panelMainScale9);f.ignoreEvents=!0;a.addChild(f);a.onResize=function(){f.setSize(a.width,a.height);if(a.onPanelResize)a.onPanelResize()};return a};UI.app_menu=function(d){function a(k){k.setState(!0);clearTimeout(k.timeout);k.timeout=setTimeout(function(){k.setState(!1)},100)}var f=UI.app_panelContainer(32),h=UI.scale9Panel(5,0,20,26,{img:Y.getImage("menu"),left:4,top:0,right:40,bottom:0});f.addChild(h);d=UI.menu(5,0,f.width,26,d);d.name="MainMenu";f.addChild(d);d.setItems([{label:"File",subItems:[{label:"New",command:COMMAND.newFile},{label:"Load Module",command:COMMAND.openFile},{label:"Save Module",command:COMMAND.saveFile},{label:"Open Random MOD Song",
command:COMMAND.randomSong},{label:"Open Random XM Song",command:COMMAND.randomSongXM}]},{label:"Edit",subItems:[{label:function(){return StateManager.getUndoLabel()},command:COMMAND.undo,disabled:function(){return!StateManager.canUndo()}},{label:function(){return StateManager.getRedoLabel()},command:COMMAND.redo,disabled:function(){return!StateManager.canRedo()}},{label:"Cut",command:COMMAND.cut},{label:"Copy",command:COMMAND.copy},{label:"Clear",subItems:[{label:"Clear Track",command:COMMAND.clearTrack},
{label:"Clear Pattern",command:COMMAND.clearPattern},{label:"Clear Song",command:COMMAND.clearSong},{label:"Clear Instruments",command:COMMAND.clearInstruments}]},{label:"Paste",command:COMMAND.paste},{label:"Render Pattern 2 Sample",command:COMMAND.pattern2Sample}]},{label:"View",subItems:[{label:"Main",command:COMMAND.showMain},{label:"Options",command:COMMAND.showOptions},{label:"File Operations",command:COMMAND.showFileOperations},{label:"Sample Editor",command:COMMAND.showSampleEditor},{label:"Piano",
command:COMMAND.togglePiano},{label:"Nibbles",command:COMMAND.nibbles},{label:"Performance stats",command:COMMAND.showStats}]},{label:"Help",subItems:[{label:"About",command:COMMAND.showAbout},{label:"Documentation",command:COMMAND.showHelp},{label:"Sourcecode on Github",command:COMMAND.showGithub}]}]);var e=UI.vumeter();e.connect(Audio.cutOffVolume);window.vumeter=e;var b=UI.label({font:fontSmall,label:"Key"});b.ignoreEvents=!0;var c=UI.checkbox(0,0,13,13);c.ignoreEvents=!0;var m=UI.label({font:fontSmall,
label:"Midi"});m.ignoreEvents=!0;var g=UI.checkbox(0,0,13,13);g.ignoreEvents=!0;f.addChild(b);f.addChild(c);f.addChild(m);f.addChild(g);f.onPanelResize=function(){var k=Math.max(Layout.col2W,250);Host.showInternalMenu||(h.hide(),k=0);var l=Layout.col5W-k;if(SETTINGS.showKey||SETTINGS.showMidi)l-=50;var n=Layout.marginLeft+k+Layout.defaultMargin+Layout.mainLeft;f.left=Layout.mainLeft;k&&h.setDimensions({left:Layout.marginLeft,top:0,height:26,width:k});e.setProperties({width:l,left:n});b.setProperties({top:4,
left:f.width-56,width:40,height:20});c.setProperties({top:4,left:f.width-20});SETTINGS.showKey?(b.show(),c.show()):(b.hide(),c.hide());SETTINGS.showMidi?(m.setProperties({top:14,left:b.left,width:b.width,height:b.height}),g.setProperties({top:16,left:c.left}),m.show(),g.show()):(m.hide(),g.hide())};f.renderInternal=function(){SETTINGS.showMidi&&!Midi.isEnabled()&&(f.ctx.fillStyle="rgba(34, 49, 85, 0.5)",f.ctx.fillRect(m.left,g.top,50,g.height))};f.onPanelResize();EventBus.on(EVENT.menuLayoutChanged,
function(){f.onPanelResize()});EventBus.on(EVENT.pianoNoteOn,function(){SETTINGS.showKey&&a(c)});EventBus.on(EVENT.midiIn,function(){SETTINGS.showMidi&&a(g)});return f};UI.app_mainPanel=function(){function d(){e="patterndata";b=UI.radioGroup();b.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0,zIndex:1});b.setItems([{label:"About",active:!1},{label:"Song data",labels:[{width:30,label:"song"}],active:!1},{label:"Pattern data",labels:[{width:40,label:"pattern"}],active:!0},{label:"Instruments",labels:[{width:30,label:"Instr"}],active:!1}]);b.onChange=function(w){e="about";1===w&&(e="songdata");2===w&&(e="patterndata");3===w&&(e="instruments");
f.onPanelResize()};f.addChild(b);f.sortZIndex()}function a(){m.show();g.show();k.show();U.show();y.show();A.show();l.show();n.show();B.show();z.show();E.show();t.show();p.show();"col3"===Layout.prefered?b&&b.show():b&&b.hide()}var f=UI.app_panelContainer(160),h="",e="",b,c,m=UI.button();m.setProperties({background:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.buttonDarkScale9,image:Y.getImage("logo_grey_70"),activeImage:Y.getImage("logo_colour_70")});m.onDown=function(){m.toggleActive()};
f.addChild(m);var g=UI.button();g.setProperties({background:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.panelInsetScale9,image:Y.getImage("tracker"),activeImage:function(){var w=Y.getImage("steffest"),D="undefined"==typeof versionNumber?"dev":versionNumber;0<D.indexOf(".")&&(D=D.split("."),D=D[0]+"."+D[1]);D="Version "+D;var N=w.getContext("2d");fontSmall.write(N,D,44,4);fontSmall.write(N,"By",44,13);return w}()});g.onDown=function(){g.toggleActive()};f.addChild(g);var k=UI.inputbox({name:"modName",
trackUndo:!0,onChange:function(w){Tracker.getSong().title=w;UI.setInfo(w)}});f.addChild(k);var l=UI.listbox();l.setItems([{label:"loading ...",data:1}]);f.addChild(l);l.onClick=function(w){Input.setFocusElement(l);(w=l.getItemAtPosition(l.eventX,l.eventY))&&Tracker.setCurrentInstrumentIndex(w.data)};var n=UI.app_songPatternList();f.addChild(n);var r=window.fontFT,t=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);f.addChild(t);var p=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);f.addChild(p);
var z=UI.spinBox();z.setProperties({name:"Pattern",label:"Pattern",labels:[{width:10,label:"Pat."},{width:140,label:"Pattern"}],value:0,max:100,min:0,font:r,onChange:function(w){Tracker.setCurrentPattern(w)}});f.addChild(z);var y=UI.spinBox({name:"Instrument",label:"Instrument",labels:[{width:10,label:"Ins."},{width:123,label:"Instr"},{width:160,label:"Instrument"}],value:1,max:31,min:1,font:r,onChange:function(w){Tracker.setCurrentInstrumentIndex(w)}});f.addChild(y);var B=UI.spinBox({name:"SongLength",
label:"Song length",labels:[{width:10,label:"Len."},{width:138,label:"Length"},{width:156,label:"Song len"},{width:178,label:"Song length"}],value:1,max:200,min:1,font:r,trackUndo:!0,undoLabel:"Change Song length",onChange:function(w){var D=Tracker.getSong().length;D>w?Editor.removeFromPatternTable():D<w&&Editor.addToPatternTable()}});f.addChild(B);var A=UI.spinBox({name:"SongRepeat",label:"Song repeat",labels:[{width:10,label:"Rep."},{width:138,label:"Repeat"},{width:156,label:"Song rep"},{width:178,
label:"Song repeat"}],value:1,max:200,min:1,font:r,onChange:function(w){Tracker.getSong().restartPosition=w}});f.addChild(A);var E=UI.spinBox({name:"PatternLength",label:"Pattern length",labels:[{width:10,label:"Plen"},{width:138,label:"Pat len"},{width:166,label:"Pattern len"},{width:188,label:"Pattern length"}],value:64,max:128,min:1,font:r,trackUndo:!0,undoLabel:"Change Pattern length",onChange:function(w){Tracker.setPatternLength(w)}});f.addChild(E);var U=UI.spinBox({name:"BPMLength",label:"BPM",
value:1,max:400,min:1,font:r,trackUndo:!0,undoLabel:"Change Song Tempo",onChange:function(w){Tracker.setBPM(w)}});f.addChild(U);var Q=UI.DiskOperations();Q.setProperties({name:"diskoperations",zIndex:100});f.addChild(Q);UI.diskOperations=Q;var u=UI.OptionsPanel();u.setProperties({name:"options",zIndex:100});f.addChild(u);f.onPanelResize=function(){var w=Layout.defaultMargin,D=20+2*w,N=50+w+w,R=f.height-50-4*w,S=28,W=Layout.col1W-2;"col3"===Layout.prefered?(b||d(),R=f.height-2*w,N=w,W=Layout.col32W-
2,S=28,h?b.hide():b.show(),b.setDimensions({left:Layout.col31X,width:Layout.col31W,top:w,height:R,visible:!0}),k.setDimensions({left:Layout.col32X,width:Layout.col32W,top:w,height:20}),l.setDimensions({left:Layout.col32X,width:Layout.col32W,top:D,height:f.height-D-2*w}),w={left:Layout.col32X,width:Layout.col32W,top:N,height:R},n.setDimensions(w),t.setDimensions(w),p.setDimensions(w),m.setDimensions({left:Layout.col32X,width:Layout.col32W,top:N,height:Math.floor(R/2)}),g.setDimensions({left:Layout.col32X,
width:Layout.col32W,top:Math.floor(R/2)+1,height:Math.floor(R/2)}),N=Layout.col32X,U.setDimensions({left:N,top:t.top+3,width:W,height:S}),B.setDimensions({left:N,top:t.top+3+S,width:W,height:S}),A.setDimensions({left:N,top:t.top+3+2*S,width:W,height:S}),A.hide(),z.setDimensions({left:N,top:t.top+3+2*S,width:W,height:S}),E.setDimensions({left:N,top:t.top+3+3*S,width:W,height:S}),y.setDimensions({left:N,top:t.top+3+4*S,width:W,height:S}),h||(m.toggle("about"===e),g.toggle("about"===e),k.toggle("instruments"===
e),l.toggle("instruments"===e),n.toggle("songdata"===e),t.toggle("patterndata"===e),U.toggle("patterndata"===e),B.toggle("patterndata"===e),z.toggle("patterndata"===e),E.toggle("patterndata"===e),y.toggle("patterndata"===e)),p.hide()):(b&&b.hide(),h||a(),m.setDimensions({left:Layout.col1X,top:w,width:Layout.col2W,height:50}),g.setDimensions({left:Layout.col3X,top:w,width:Layout.col1W,height:50}),k.setDimensions({left:Layout.col4X,width:Layout.col2W,top:w,height:20}),l.setDimensions({left:Layout.col4X,
width:Layout.col2W,top:D,height:f.height-D-2*w}),n.setDimensions({left:Layout.col1X,width:Layout.col1W,top:N,height:R}),t.setDimensions({left:Layout.col2X,width:Layout.col1W,top:N,height:R}),p.setDimensions({left:Layout.col3X,width:Layout.col1W,top:N,height:R}),U.setDimensions({left:Layout.col2X,top:t.top+3,width:W,height:S}),B.setDimensions({left:Layout.col2X,top:t.top+3+S,width:W,height:S}),A.setDimensions({left:Layout.col2X,top:t.top+3+2*S,width:W,height:S}),z.setDimensions({left:Layout.col3X,
top:t.top+3,width:W,height:S}),E.setDimensions({left:Layout.col3X,top:t.top+3+S,width:W,height:S}),y.setDimensions({left:Layout.col3X,top:t.top+3+2*S,width:W,height:S}));Q.setSize(f.width,f.height);u.setSize(f.width,f.height);c&&c.setSize(f.width,f.height)};f.onPanelResize();f.getCurrentView=function(){return h};EventBus.on(EVENT.songLoading,function(){k.setValue("Loading ...",!0)});EventBus.on(EVENT.songPropertyChange,function(w){k.setValue(w.title,!0);B.setValue(w.length,!0);y.setMax(Tracker.getMaxInstruments(),
!0);A.setMax(w.length,!0);w.restartPosition&&w.restartPosition>w.length&&(w.restartPosition=w.length);A.setValue(w.restartPosition||1,!0)});EventBus.on(EVENT.songBPMChange,function(w){U.setValue(w,!0)});EventBus.on(EVENT.instrumentChange,function(w){l.setSelectedIndex(w-1);y.setValue(w,!0)});EventBus.on(EVENT.instrumentNameChange,function(w){var D=Tracker.getInstrument(w);if(D)for(var N=l.getItems(),R=0,S=N.length;R<S;R++)if(N[R].data==w){N[R].label=w+" "+D.name;EventBus.trigger(EVENT.instrumentListChange,
N);break}});EventBus.on(EVENT.instrumentListChange,function(w){l.setItems(w)});EventBus.on(EVENT.patternChange,function(w){z.setValue(w,!0);E.setValue(Tracker.getPatternLength(),!0)});EventBus.on(EVENT.trackerModeChanged,function(w){E.setDisabled(w===TRACKERMODE.PROTRACKER);y.setMax(Tracker.getMaxInstruments())});EventBus.on(EVENT.pluginRenderHook,function(w){w.target&&"main"===w.target&&(c?c.children=[]:(c=UI.panel(0,0,f.width,f.height),f.addChild(c)),c.renderOverride=w.render,c.renderInternal=w.renderInternal,
w.setRenderTarget&&w.setRenderTarget(c),Q.hide(),u.hide(),m.hide(),g.hide(),k.hide(),U.hide(),y.hide(),A.hide(),l.hide(),n.hide(),B.hide(),z.hide(),E.hide(),t.hide(),p.hide(),b&&b.hide(),h="custom",c.show(),f.refresh())});EventBus.on(EVENT.showView,function(w){switch(w){case "diskop_load":case "diskop_save":case "diskop_samples_load":case "diskop_modules_load":case "diskop_samples_save":case "diskop_modules_save":c&&c.hide();Q.setView(w);Q.show();u.hide();h=w;f.refresh();break;case "options":c&&c.hide();
Q.hide();u.show(!0);h=w;f.refresh();break;case "topmain":case "main":c&&c.hide(),Q.hide(),u.hide(),h="",a(),f.refresh()}});return f};UI.app_controlPanel=function(){var d=UI.app_panelContainer(40),a=UI.app_songControl();d.addChild(a);var f=UI.checkboxbutton({label:"File",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"diskop_load":"topmain")}}),h=UI.checkboxbutton({label:"Options",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"options":"topmain")}}),e=UI.checkboxbutton({label:"Sample Edit",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"sample":"bottommain")}});d.addChild(f);d.addChild(h);
d.addChild(e);var b={background:UI.Assets.buttonKeyScale9,hoverBackground:UI.Assets.buttonKeyHoverScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},c=UI.button(),m=UI.button();c.setProperties(b);c.setLabel("mod");c.onDown=function(){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER)};d.addChild(c);m.setProperties(b);m.setLabel("XM");m.onDown=function(){Tracker.setTrackerMode(TRACKERMODE.FASTTRACKER)};d.addChild(m);var g=[4,
8,12,16],k=[];g.forEach(function(t){k.push(UI.button())});k.forEach(function(t,p){t.setProperties(b);t.setLabel(""+g[p]);t.index=p;t.onDown=function(){if(!this.isDisabled){var z=this.index;k.forEach(function(y,B){y.setActive(B===z)});Layout.setVisibleTracks(g[z])}};d.addChild(t)});var l=UI.label();l.setProperties({label:"Mode",labels:[{width:20,label:""},{width:78,label:"M"},{width:84,label:"Md"},{width:100,label:"Mode"}],font:fontSmall,width:100,height:20,textAlign:"right"});l.ignoreEvents=!0;d.addChild(l);
var n=UI.label();n.setProperties({label:"Display",labels:[{width:10,label:""},{width:78,label:"t"},{width:84,label:"tr"},{width:100,label:"trck"},{width:120,label:"Display"}],font:fontSmall,width:100,height:20,textAlign:"right"});n.ignoreEvents=!0;d.addChild(n);var r=UI.spinBox();r.setProperties({name:"Pattern",value:Tracker.getTrackCount(),max:32,min:2,size:"big",padLength:2,trackUndo:!0,undoLabel:"Change Track count",onChange:function(t){Tracker.setTrackCount(t)}});d.addChild(r);d.onPanelResize=
function(){d.innerHeight=d.height-2*Layout.defaultMargin;var t=Layout.defaultMargin,p=Layout.defaultMargin;if("2row"===Layout.controlPanelButtonLayout){var z=Math.floor((d.innerHeight-Layout.defaultMargin)/2);p=d.height-z-Layout.defaultMargin;d.innerHeight=z}a.setProperties({left:Layout.col1X,top:t,width:Layout.songControlWidth,height:d.innerHeight,songPatternSelector:"small"});z=Layout.col1W-60;z=Math.max(z,120);var y=Math.floor((Layout.col1W-z)/2),B=Layout.col4X+y,A="Sample Edit";"1row"!==Layout.controlPanelButtonLayout&&
(z=Math.floor(Layout.controlPanelButtonsWidth/3),y=0,B=Layout.controlPanelButtonsLeft+2*z,A="Sample");var E=d.innerHeight;f.setProperties({left:Layout.controlPanelButtonsLeft+1.5*y,top:p,width:z,height:E});h.setProperties({left:f.left+z+y,top:p,width:z,height:E});e.setProperties({left:B,top:p,width:z,height:E,label:A});c.setProperties({left:Layout.modeButtonsLeft+(Layout.modeButtonsWidth-101),top:t,width:51,height:16});m.setProperties({left:c.left+c.width-1,top:c.top,width:c.width,height:c.height});
var U=c.left;k.forEach(function(Q,u){Q.setProperties({left:U,top:c.top+c.height,width:26,height:c.height});U+=Q.width-1;Q.setActive(g[u]===Layout.visibleTracks);Q.setDisabled(g[u]>Layout.maxVisibleTracks)});l.setProperties({left:Layout.modeButtonsLeft,top:t+1,width:Layout.modeButtonsWidth-94,height:20});n.setProperties({left:l.left,top:l.top+c.height,width:l.width,height:l.height});r.setProperties({left:Layout.modeButtonsLeft,top:t,width:Layout.TrackCountSpinboxWidth,height:d.innerHeight})};d.onPanelResize();
d.renderInternal=function(){"2row"!==Layout.controlPanelButtonLayout&&(d.ctx.drawImage(Y.getImage("line_ver"),Layout.controlPanelButtonsLeft-2,0,2,d.height-1),d.ctx.drawImage(Y.getImage("line_ver"),Layout.modeButtonsLeft-2,0,2,d.height-1),"condensed"!==Layout.controlPanelButtonLayout&&(d.ctx.drawImage(Y.getImage("line_ver"),Layout.col4X-2,0,2,d.height-1),d.ctx.translate(.5,.5),d.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",d.ctx.lineWidth=1,d.ctx.beginPath(),d.ctx.moveTo(Layout.col2X+10,10),d.ctx.lineTo(Layout.col2X+
10,20),d.ctx.lineTo(Layout.col4X-14,20),d.ctx.lineTo(Layout.col4X-14,10),d.ctx.moveTo(Layout.col4X+10,30),d.ctx.lineTo(Layout.col4X+10,20),d.ctx.lineTo(Layout.col5X-14,20),d.ctx.lineTo(Layout.col5X-14,30),d.ctx.stroke(),d.ctx.setTransform(1,0,0,1,0,0),f.render(),h.render(),e.render()))};EventBus.on(EVENT.showView,function(t){switch(t){case "diskop_load":case "diskop_save":case "diskop_samples_load":case "diskop_modules_load":case "diskop_samples_save":case "diskop_modules_save":f.setActive(!0);h.setActive(!1);
break;case "options":f.setActive(!1);h.setActive(!0);break;case "topmain":f.setActive(!1);h.setActive(!1);break;case "main":f.setActive(!1);h.setActive(!1);e.setActive(!1);break;case "bottommain":e.setActive(!1);break;case "sample":e.setActive(!0)}});EventBus.on(EVENT.trackerModeChanged,function(t){c.setActive(t===TRACKERMODE.PROTRACKER);m.setActive(t===TRACKERMODE.FASTTRACKER);Layout.setLayout()});EventBus.on(EVENT.trackCountChange,function(t){r.setValue(t,!0)});EventBus.on(EVENT.songLoaded,function(t){t=
t.channels;12<t&&16>t&&(t=16);8<t&&12>t&&(t=12);4<t&&8>t&&(t=8);t=Math.min(t,Layout.maxVisibleTracks);Layout.setVisibleTracks(t);d.onPanelResize()});return d};UI.app_patternPanel=function(){function d(){var p=r.getStartTrack(),z=Math.min(p+Layout.visibleTracks,Tracker.getTrackCount()),y=!(Layout.expandSampleViewHeight&&"sample"===c);for(f=0;f<h.length;f++)f>=p&&f<z?h[f].setProperties({track:f,left:b+(Layout.trackWidth+Layout.trackMargin)*(f-p),top:Layout.defaultMargin+Layout.infoPanelHeight+Layout.analyserHeight,width:Layout.trackWidth,height:Layout.trackControlHeight,visible:y}):h[f].setProperties({track:f,top:-100,visible:!1})}var a=UI.app_panelContainer(80),
f,h=[],e,b,c="main",m=UI.editPanel();a.addChild(m);var g=UI.InfoPanel();a.addChild(g);for(f=0;f<Tracker.getTrackCount();f++)h[f]=UI.trackControl(),a.addChild(h[f]);var k=UI.visualiser();k.connect(Audio.cutOffVolume);k.name="mainAnalyser";var l=UI.element();l.render=function(){};l.onClick=function(p){k.onClick(p)};a.addChild(l);var n=UI.pattern_sidebar();a.addChild(n);var r=UI.app_patternView();r.setProperties({name:"patternViewPanel"});a.addChild(r);var t=UI.SampleView();t.setProperties({name:"sampleViewPanel"});
a.addChild(t);a.onPanelResize=function(){Layout.showSideBar?"main"===c&&(n.show(),m.show()):(n.hide(),m.hide());var p=Layout.infoPanelHeight+Layout.trackControlHeight+Layout.analyserHeight+2*Layout.defaultMargin,z=a.height-p-Layout.defaultMargin;Layout.expandSampleViewHeight=280>z;Layout.expandSampleViewHeight&&"sample"===c?(k.hide(),m.hide()):(k.show(),Layout.showSideBar&&m.show());e=Layout.showSideBar?Layout.col2X:Layout.col1X;var y=Layout.showSideBar?Layout.col4W:Layout.col5W;b=e+Layout.firstTrackOffsetLeft;
m.setDimensions({left:Layout.col1X,top:Layout.defaultMargin,width:Layout.col1W,height:Layout.infoPanelHeight+Layout.analyserHeight});g.setDimensions({left:Layout.showSideBar?Layout.col2X:Layout.col1X,top:0,width:Layout.showSideBar?Layout.col4W:Layout.col5W,height:Layout.infoPanelHeight});r.setDimensions({left:e,top:p,width:y,height:z});n.setDimensions({left:Layout.col1X,top:r.top-Layout.trackControlHeight,width:Layout.col1W,height:z+Layout.trackControlHeight});k.setProperties({left:b+Layout.mainLeft,
top:a.top+Layout.infoPanelHeight+3,width:y-Layout.firstTrackOffsetLeft,height:Layout.analyserHeight});l.setDimensions({left:k.left-Layout.mainLeft,top:Layout.infoPanelHeight+3,width:k.width,height:k.height});t.setProperties({left:0,top:Layout.expandSampleViewHeight?Layout.infoPanelHeight:p,width:a.width,height:Layout.expandSampleViewHeight?a.height-Layout.infoPanelHeight-Layout.defaultMargin-3:z});d()};a.onPanelResize();EventBus.on(EVENT.patternChange,function(){r.refresh()});EventBus.on(EVENT.patternPosChange,
function(){r.refresh()});EventBus.on(EVENT.cursorPositionChange,function(){r.refresh()});EventBus.on(EVENT.recordingChange,function(){r.refresh()});EventBus.on(EVENT.trackStateChange,function(p){if("undefined"!=typeof p.track)if(p.solo)for(f=0;f<Tracker.getTrackCount();f++)f!=p.track&&h[f].setProperties({mute:!0});else if(p.wasSolo)for(f=0;f<Tracker.getTrackCount();f++)f!=p.track&&h[f].setProperties({mute:!1})});EventBus.on(EVENT.trackCountChange,function(p){a.visibleTracks=Math.min(4,p);for(f=h.length;f<
p;f++)h[f]=UI.trackControl(),h[f].setProperties({track:f,top:-200}),a.addChild(h[f]);d();a.refresh()});EventBus.on(EVENT.patternHorizontalScrollChange,function(){d()});EventBus.on(EVENT.showView,function(p){switch(p){case "sample":t.show();r.hide();n.hide();Layout.expandSampleViewHeight&&(k.hide(),m.hide());c=p;a.onPanelResize();a.refresh();break;case "bottommain":case "main":t.hide(),r.show(),k.show(),Layout.showSideBar&&(n.show(),m.show()),c="main",a.onPanelResize(),a.refresh()}});EventBus.on(EVENT.visibleTracksCountChange,
function(p){Layout.showSideBar?"main"===c&&(n.show(),m.show()):(n.hide(),m.hide());a.onResize()});return a};UI.MainPanel=function(){var d=UI.panel(0,0,canvas.width,canvas.height,!0);d.setProperties({backgroundColor:"#071028"});d.name="mainPanel";var a={},f=UI.app_menu(d);d.addChild(f);var h=UI.app_mainPanel();d.addChild(h);var e=UI.app_controlPanel();d.addChild(e);var b=UI.app_patternPanel();d.addChild(b);var c=UI.app_sidebar();Layout.showAppSideBar&&d.addChild(c);var m=UI.app_pianoView();m.hide();d.addChild(m);d.createContextMenu=function(g){var k=a[g.name];k||(k=UI.menu(100,100,128,42,d),k.zIndex=100,
k.setProperties({background:UI.Assets.panelMainScale9,layout:"buttons"}),k.setItems(g.items),k.hide(),d.addChild(k),a[g.name]=k);return k};d.onResize=function(){Layout.setLayout(d.width,d.height);f.setSize(Layout.mainWidth,f.height);var g=f.height;h.setSize(Layout.mainWidth,h.height);h.setPosition(Layout.mainLeft,g);g+=h.height;e.setSize(Layout.mainWidth,Layout.controlPanelHeight);e.setPosition(Layout.mainLeft,g);g+=e.height;var k=d.height-g;m.isVisible()&&(m.setSize(Layout.mainWidth,Layout.pianoHeight),
m.setPosition(Layout.mainLeft,d.height-m.height),k-=m.height);b.setPosition(Layout.mainLeft,g);b.setSize(Layout.mainWidth,k);c.setPosition(0,0);c.setSize(Layout.sidebarWidth,d.height)};d.sortZIndex();d.onResize();EventBus.on(EVENT.toggleView,function(g){if("piano"===g){m.toggle();var k=d.height-b.top;m.isVisible()&&(m.setSize(Layout.mainWidth,Layout.pianoHeight),m.setPosition(Layout.mainLeft,d.height-m.height),k-=m.height);b.setSize(Layout.mainWidth,k)}"sidebar"===g&&(Layout.showAppSideBar=!Layout.showAppSideBar,
Layout.setLayout(),d.onResize())});EventBus.on(EVENT.showContextMenu,function(g){var k=d.createContextMenu(g),l=g.x;l+k.width>Layout.mainWidth&&(l=Layout.mainWidth-k.width);k.setPosition(l,g.y-k.height-2);k.show();d.refresh()});EventBus.on(EVENT.hideContextMenu,function(){for(var g in a)a[g].hide();d.refresh()});return d};UI.app_patternView=function(d,a,f,h){var e;function b(x,H,Z){var T=Tracker.inFTMode()?"i"+x.index+"."+Q.charWidth:"p"+x.period+"."+Q.charWidth;if(!D[T]){var M=document.createElement("canvas");M.height=13;M.width=3*Q.charWidth+2;var aa=M.getContext("2d");if(Tracker.inFTMode())if(x.index){var P=FTNotes[x.index];97===x.index&&(P=FTNotes[NOTEOFF]);var ca=P?P.name:"???"}else if(ca="---",P=FTPeriods[x.period]){if(P=FTNotes[P])ca=P.name}else 0<x.period&&console.error("no basenote for "+x.period);else ca=
(P=periodNoteTable[x.period])?P.name:"---";Q.write(aa,ca,0,0,0);D[T]=M}p.ctx.drawImage(D[T],H,Z)}function c(x,H,Z){H+=3*Q.charWidth+4;var T="n"+x.instrument+"."+(u?x.volumeEffect:"")+"."+x.effect+"."+x.param+"."+Q.charWidth;if(!N[T]){var M=document.createElement("canvas");M.height=13;M.width=7*Q.charWidth+10;var aa=M.getContext("2d"),P=k(x.instrument,2,"0");"00"==P&&(P="..");var ca=0;Q.write(aa,P,ca,0,0,"green");if(u){ca+=2*Q.charWidth+4;var ba=x.volumeEffect||0;ba&&(ba-=16);80>ba?P=k(ba,2,"0"):(P=
(ba>>4).toString(16).toUpperCase(),ba=(ba&15).toString(16).toUpperCase(),P={5:"-",6:"+",7:"\u2193",8:"\u2191",9:"S",A:"V",B:"P",C:"<",D:">",E:"M"}[P]||P,P+=ba);x.volumeEffect||(P="..");Q.write(aa,P,ca,0,0)}ca+=2*Q.charWidth+4;P=15<x.effect?h=x.effect.toString(36).toUpperCase():k(x.effect);P+=k(x.param,2,"0");"000"===P&&(P="...");Q.write(aa,P,ca,0,0,"orange");N[T]=M}p.ctx.drawImage(N[T],H,Z)}function m(x,H,Z,T,M){if(Tracker.isPlaying()&&x&&x.period&&X[T]!==M){var aa=100;12===x.effect?aa=100*x.param/
64:(x=Tracker.getInstrument(x.instrument))&&(aa=100*x.sample.volume/64);K[T]=aa;X[T]=M}K[T]&&(w=!0,M=K[T]*L/100,aa=100*M/L,"colour"===SETTINGS.vubars?(x=Y.getImage("vubar"),p.ctx.drawImage(x,0,100-aa,26,aa,H,Z-M,10,M)):"trans"===SETTINGS.vubars&&(p.ctx.fillStyle="rgba(120,190,255,0.3)",p.ctx.fillRect(H,Z-M,10,M)),K[T]-=C,0>K[T]&&(K[T]=0))}function g(x,H,Z){var T=""+x;10>x&&(T="0"+T);var M=T+"."+Q.charWidth;if(!R[M]){var aa=document.createElement("canvas");aa.height=13;aa.width=3*Q.charWidth;var P=
aa.getContext("2d"),ca=!1;0===x%4&&(ca="orange");Q.write(P,T,0,0,0,ca);R[M]=aa}p.ctx.drawImage(R[M],H,Z)}function k(x,H,Z){h=x.toString(16).toUpperCase();if(H&&h.length<H)for(Z=Z||"0";h.length<H;)h=Z+h;return h}function l(){var x=Tracker.getCurrentPatternPos()||0;if(z){var H=1,Z=p.height-2,T=Z;A=0;1<U&&(T=Math.floor(z/U*Z),12>T&&(T=12),A=(Z-T)/(U-1));x&&A&&(H=Math.floor(1+A*x));O.setProperties({left:p.width-16,top:H,width:16,height:T})}}function n(){var x=p.width,H=Math.floor(x/Tracker.getTrackCount()*
y);x=(x-H)/(Tracker.getTrackCount()-y);var Z=p.height-20;y>=Tracker.getTrackCount()&&(Z=-200);I.setProperties({top:Z,width:H,left:0+Math.floor(E*x)})}function r(){e=[S.start[0],S.start[1]];W=[S.end[0],S.end[1]];for(var x=0;2>x;x++)S.start[x]>S.end[x]&&(e[x]=S.end[x],W[x]=S.start[x])}function t(x){F?(S.end=[Tracker.getCurrentPatternPos(),Editor.getCurrentTrack()],r()):(S.start=[x.prev||0,Editor.getCurrentTrack()],S.end=[x.current,Editor.getCurrentTrack()],S.top=S.left=1E5,r(),F=!0,p.showSelectionUI());
p.refresh()}var p=UI.panel(d,a,f,h),z=0,y=8,B=0,A=0,E=0,U,Q,u,w,D={},N={},R={},S={};var W=e=void 0;var G=[],F=!1,J,V,O=UI.scale9Panel(f-28,18,16,h-3,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});O.onDragStart=function(){Tracker.isPlaying()||(O.startDragIndex=Tracker.getCurrentPatternPos())};O.onDrag=function(x){!Tracker.isPlaying()&&z&&A&&(x=Math.floor(O.startDragIndex+x.deltaY/A),x=Math.min(x,U-1),x=Math.max(x,0),Tracker.setCurrentPatternPos(x))};p.addChild(O);l();var I=UI.scale9Panel(f-
28,18,16,16,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});I.onDragStart=function(){I.startDragIndex=E};I.onDrag=function(x){var H=Tracker.getTrackCount()-y;p.setHorizontalScroll(I.startDragIndex+Math.floor(x.deltaX/((p.width-I.width)/H)));p.onResize()};p.addChild(I);var q=[];d=0;for(a=Tracker.getTrackCount();d<a;d++){var v=UI.fxPanel(d);q.push(v);p.addChild(v)}var K=[],X=[],C=5,L=70;p.setHorizontalScroll=function(x){var H=Tracker.getTrackCount()-y;x!=E&&0<=x&&x<=H&&(E=x,EventBus.trigger(EVENT.patternHorizontalScrollChange,
E),n())};p.onResize=function(){J=Layout.firstTrackOffsetLeft;V=Layout.trackMargin;y=Layout.visibleTracks;var x=p.height;y<Tracker.getTrackCount()&&(x-=24);for(var H=0;H<y;H++)(v=q[E+H])&&v.visible&&(v.setPosition(J+H*(Layout.trackWidth+V),0),v.setSize(Layout.trackWidth,x),v.setLayout(),v.show())};p.render=function(){if(p.isVisible()){if(this.needsRendering){p.clearCanvas();var x=Tracker.getCurrentPattern()||0,H=Tracker.getCurrentPatternPos()||0,Z=Tracker.getSong();if(!Z)return;Q=Layout.trackFont;
U=Tracker.getPatternLength();var T=y<Tracker.getTrackCount(),M=p.height-30,aa=(u=Tracker.inFTMode())?92:72,P=9,ca=28;Layout.useCondensedTrackFont&&(aa=u?46:36,P=5,ca=15);var ba=10,da=Math.floor((Layout.trackWidth-aa)/2)+ba,oa=!1;J&&(da=ba=0,oa=!0);T&&(M-=24);z=Math.ceil(M/13);0==z%2&&z--;var ia=Math.floor(z/2),la=H-ia,qa=la+z;B=Math.floor((M+15)/2);M=B-13*ia+4;var ja=B,pa=B+15,na=cachedAssets.darkPanel;!na&&Y.getImage("panel_dark")&&(ia=UI.scale9Panel(0,0,Layout.trackWidth,ja,{img:Y.getImage("panel_dark"),
left:3,top:3,right:2,bottom:2}),cachedAssets.darkPanel=ia.render(!0),na=cachedAssets.darkPanel);ia=[];w=!1;L>ja&&(L=ja,C=L/10);for(var ha=0;ha<y;ha++){var ea=E+ha;ia[ea]=!(q[ea]&&q[ea].visible);if(ia[ea]){var ma=J+ha*(Layout.trackWidth+V);p.ctx.drawImage(na,ma,0,Layout.trackWidth,ja);p.ctx.drawImage(na,ma,pa,Layout.trackWidth,ja);q[ea]&&(q[ea].left=ma)}}if(Z=Z.patterns[x])for(Tracker.isRecording()?p.ctx.fillStyle="#A50B0F":p.ctx.fillStyle="#202E58",p.ctx.fillRect(0,B,p.width-0,15),ha=Editor.getCurrentTrackPosition(),
ea=P,oa?(ma=J+(Editor.getCurrentTrack()-E)*(Layout.trackWidth+V),ma=ma+Math.floor((Layout.trackWidth-aa)/2)+ha*ea-1):ma=J+da+(Editor.getCurrentTrack()-E)*Layout.trackWidth+ha*ea-1,0<ha?(ma+=2*ea+1,2<ha&&(ma+=2),4<ha&&u&&(ma+=2)):ea=ca,p.ctx.fillStyle="rgba(220,220,220,.3)",p.ctx.fillRect(ma,B,ea,15),p.ctx.fillStyle="rgba(200,150,70,.3)",ca=8*Q.charWidth+14,u&&(ca+=2*Q.charWidth+2),ha=la;ha<qa;ha++)if(0<=ha&&ha<Tracker.getPatternLength()){P=Z[ha];ja=M+13*(ha-la);pa=!0;ja<B&&(ja-=3,pa=!1);ja>B+13&&
(ja+=3,pa=!1);g(ha,ba,ja);pa&&(g(ha,ba,ja),g(ha,ba,ja));for(na=0;na<y;na++)if(ea=na+E,ia[ea]&&ea<Tracker.getTrackCount()){var fa=P[ea]||Note();oa?(ma=J+na*(Layout.trackWidth+V),ma+=Layout.trackWidth-aa>>1):ma=J+da+na*Layout.trackWidth;F&&ha>=e[0]&&ha<=W[0]&&ea>=e[1]&&ea<=W[1]&&(S.top=Math.min(S.top,ja-2),S.left=Math.min(S.left,ma-2),p.ctx.fillRect(ma-2,ja-2,ca,13));pa&&(b(fa,ma,ja),b(fa,ma,ja),(Tracker.isPlaying()||K[na]&&"none"!==SETTINGS.vubars)&&m(fa,ma-12,B,na,x+"."+H));b(fa,ma,ja);c(fa,ma,ja)}w&&
setTimeout(function(){p.refresh()},20)}for(na=0;na<y;na++)ea=na+E,ia[ea]||q[ea].render();l();O.render();T&&(n(),I.render());for(na=0;na<y;na++)ea=na+E,ia[ea]&&(ma=J+na*(Layout.trackWidth+V)+2,Q.write(p.ctx,""+(ea+1),ma,2,0,void 0))}this.needsRendering=!1;p.parentCtx.drawImage(p.canvas,p.left,p.top,p.width,p.height)}};p.onMouseWheel=function(x){if(!Tracker.isPlaying()){var H=Tracker.getCurrentPatternPos();0<x.mouseWheels[0]?H&&Tracker.moveCurrentPatternPos(-1):H<U-1&&Tracker.moveCurrentPatternPos(1)}};
p.onDragStart=function(x){I.startDragIndex=E;if(!Tracker.isPlaying()&&(p.startDragPos=Tracker.getCurrentPatternPos(),x.isMeta||Tracker.isRecording())){var H=Math.floor((x.x-Layout.firstTrackOffsetLeft)/(Layout.trackWidth+Layout.trackMargin)),Z=Editor.getStepsPerTrack();Editor.setCurrentCursorPosition((E+H)*Z);UI.clearSelection();p.startDragTrackX=H*(Layout.trackWidth+Layout.trackMargin)+Layout.firstTrackOffsetLeft;x=Math.floor((x.y-B)/13);S.start=[Tracker.getCurrentPatternPos()+x,Editor.getCurrentTrack()];
S.end=S.start;S.top=S.left=1E5;p.refresh()}};p.onDrag=function(x){if(y<Tracker.getTrackCount()&&!x.isMeta&&!Tracker.isRecording()){var H=Tracker.getTrackCount()-y,Z=x.deltaX;p.setHorizontalScroll(I.startDragIndex-Math.floor(Z/((p.width-I.width)/H)))}Tracker.isPlaying()||(Z=Math.round(x.deltaY/13),Z=p.startDragPos-Z,Z=Math.max(Z,0),Z=Math.min(Z,U-1),x.isMeta||Tracker.isRecording()?(F=!0,Z=Math.floor(x.deltaY/13),x=Math.floor(x.deltaX/Layout.trackWidth),S.end=[S.start[0]+Z,Editor.getCurrentTrack()+
x],r(),p.refresh()):Tracker.setCurrentPatternPos(Z))};p.onTouchUp=function(){F&&p.showSelectionUI()};p.onClick=function(x){x=Math.floor((x.x-Layout.firstTrackOffsetLeft)/(Layout.trackWidth+Layout.trackMargin));var H=Editor.getStepsPerTrack();Editor.setCurrentCursorPosition((E+x)*H)};p.getStartTrack=function(){return E};p.processSelection=function(x){if(p.isVisible())switch(x){case SELECTION.RESET:return F=!1,UI.hideContextMenu(),p.refresh(),!0;case SELECTION.CLEAR:var H=Tracker.getCurrentPatternData();
if(H&&F){var Z=StateManager.createRangeUndo(Tracker.getCurrentPattern());Z.name="Clear Selection";for(var T=e[0];T<=W[0];T++)for(var M=H[T],aa=e[1];aa<=W[1];aa++){var P=M[aa];P&&(StateManager.addNote(Z,aa,T,P),P.clear())}}StateManager.registerEdit(Z);p.refresh();break;case SELECTION.COPY:case SELECTION.CUT:G=[];if((H=Tracker.getCurrentPatternData())&&F)for(T=e[0];T<=W[0];T++)if(M=H[T]){var ca=[];for(aa=e[1];aa<=W[1];aa++)P=M[aa]||new Note,ca.push(P.duplicate());G.push(ca)}if(x===SELECTION.CUT&&F){Z=
StateManager.createRangeUndo(Tracker.getCurrentPattern());Z.name="Cut Selection";for(T=e[0];T<=W[0];T++)if(M=H[T])for(aa=e[1];aa<=W[1];aa++)P=M[aa],StateManager.addNote(Z,aa,T,P),P&&P.clear();StateManager.registerEdit(Z)}p.refresh();break;case SELECTION.PASTE:if((H=Tracker.getCurrentPatternData())&&F&&G.length){Z=StateManager.createRangeUndo(Tracker.getCurrentPattern());Z.name="Paste Selection";for(T=0;T<G.length;T++)if(M=H[e[0]+T],ca=G[T],M)for(aa=0;aa<ca.length;aa++)x=e[1]+aa,P=M[x],!P&&x<Tracker.getTrackCount()&&
(P=new Note,M[x]=P),P&&(StateManager.addNote(Z,x,e[0]+T,P),P.populate(ca[aa]));StateManager.registerEdit(Z)}p.refresh();break;case SELECTION.POSITION:S.start=S.end=[Tracker.getCurrentPatternPos(),Editor.getCurrentTrack()],r(),F=!0,p.refresh()}};p.showSelectionUI=function(){UI.setSelection(p.processSelection);UI.showContextMenu({name:"patternActions",items:[{label:"Clear",onClick:function(){p.processSelection(SELECTION.CLEAR)}},{label:"Cut",onClick:function(){p.processSelection(SELECTION.CUT)}},{label:"Copy",
onClick:function(){p.processSelection(SELECTION.COPY)}},{label:"Paste",onClick:function(){p.processSelection(SELECTION.PASTE)}}],x:S.left+p.left+p.parent.left,y:S.top+p.top+p.parent.top})};EventBus.on(EVENT.patternPosChange,function(x){Input.isMetaKeyDown()&&!Tracker.isPlaying()&&t(x)});EventBus.on(EVENT.cursorPositionChange,function(x){Input.isMetaKeyDown()&&!Tracker.isPlaying()&&t({current:Tracker.getCurrentPatternPos(),prev:Tracker.getCurrentPatternPos()})});EventBus.on(EVENT.trackCountChange,
function(x){y<x&&(y=x);E=Math.min(E,x-y);E=Math.max(E,0);for(var H=q.length;H<x;H++){var Z=UI.fxPanel(H);q.push(Z);p.addChild(Z)}p.onResize();p.refresh()});EventBus.on(EVENT.songLoaded,function(){p.setHorizontalScroll(0)});EventBus.on(EVENT.visibleTracksCountChange,function(){E=0;p.onResize();p.refresh()});EventBus.on(EVENT.trackerModeChanged,function(){p.refresh()});EventBus.on(EVENT.fxPanelToggle,function(x){v=q[x];v.visible?v.hide():(x=p.height,y<Tracker.getTrackCount()&&(x-=24),v.setPosition(v.left,
0),v.setSize(Layout.trackWidth,x),v.setLayout(),v.show());p.refresh()});EventBus.on(EVENT.skipFrameChanged,function(x){C=5*(x+1)});EventBus.on(EVENT.commandSelectAll,function(){p.isVisible()&&(UI.clearSelection(),S.start=[0,Editor.getCurrentTrack()],S.end=[Tracker.getCurrentPatternData().length-1,Editor.getCurrentTrack()],r(),F=!0,S.top=S.left=1E5,p.showSelectionUI(),p.refresh())});return p};UI.fxPanel=function(d){function a(r,t){if(n&&!r.isDisabled)switch(r.getLabel()){case "volume":n.volumeValue(t);break;case "panning":n.panningValue((t-50)/50);break;case "high":n.highValue(t/100);break;case "mid":n.midValue(t/100);break;case "low":n.lowValue(t/100);break;case "lowPass":n.lowPassFrequencyValue(t/100);break;case "reverb":n.reverbValue(t);break;case "distortion":n.distortionValue(t);break;case "delay":n.delayValue(t);break;case "compression":n.compressionValue(t)}}var f=UI.panel();f.hide();
d=d||0;var h=UI.scale9Panel(0,0,20,20,UI.Assets.buttonDarkScale9);h.ignoreEvents=!0;f.addChild(h);for(var e="volume panning high mid low lowPass distortion compression delay reverb".split(" "),b=0,c=10,m=[],g=0,k=e.length;g<k;g++){var l=UI.knob();l.setProperties({top:b,left:c,label:e[g],disabled:1<g});l.onChange=function(r){a(this,r)};l.onToggle=function(r){if(n){var t=this.getLabel();n.setState(t,r)}a(this,this.getValue())};f.addChild(l);m.push(l);0==g%2?c+=70:(c=10,b+=70)}var n;Audio.filterChains&&
(n=Audio.filterChains[d]);f.setLayout=function(){if(UI.mainPanel){h.setSize(f.width,f.height);var r=Math.max(1,Math.floor(f.width/70)),t=Math.floor((f.width-70*r)/2),p=Math.floor((f.width-2*t)/r),z=0;m.forEach(function(y,B){B%=r;y.setPosition(B*p+t,z);B===r-1&&(z+=70)})}};return f};UI.SampleView=function(){function d(q){var v=Tracker.getCurrentInstrument();if(v)if(16===q)v.sample.bits=16,k.setActive(!1),l.setActive(!0);else{q=0;for(var K=v.sample.data.length;q<K;q++)v.sample.data[q]=Math.round(127*v.sample.data[q])/127;v.sample.bits=8;k.setActive(!0);l.setActive(!1)}}function a(q){"loop"===q?(u.show(),U.show(),E.show(),w.hide(),D.hide(),N.hide(),V.setActive(),I.setActive(!1),R.forEach(function(v){v.hide()})):(u.hide(),U.hide(),E.hide(),w.show(),D.show(),N.show(),V.setActive(!1),
I.setActive(),R.forEach(function(v){v.show()}));h.onResize()}function f(q){R.forEach(function(K,X){K.setActive(q===X)});var v=Tracker.getCurrentInstrument();v&&(v.vibrato.type=q)}var h=UI.panel();h.name="SampleView";h.hide();var e,b=window.fontMed;b=window.fontCondensed;var c=UI.inputbox({name:"instrumentName",height:20,trackUndo:!0,undoInstrument:!0,onChange:function(q){if(e){var v=Tracker.getInstrument(e);v&&(v.name=q);EventBus.trigger(EVENT.instrumentNameChange,e)}}});h.addChild(c);var m=UI.Assets.generate("button20_20");
m.setLabel("x");m.onClick=function(){App.doCommand(COMMAND.showBottomMain)};h.addChild(m);var g={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},k=UI.button(),l=UI.button();k.setProperties(g);k.setLabel("8");k.setActive(!0);k.onDown=function(){d(8)};h.addChild(k);l.setProperties(g);l.setLabel("16");l.onDown=function(){d(16)};h.addChild(l);var n=UI.WaveForm();h.addChild(n);n.onMouseWheel=function(q){0<
q.mouseWheels[0]?n.zoom(1.01):n.zoom(.99)};var r=UI.EnvelopePanel("volume");h.addChild(r);var t=UI.EnvelopePanel("panning");h.addChild(t);var p=new UI.panel;p.setProperties({name:"instrumentSideButtonPanel"});var z=UI.spinBox({name:"Instrument",label:"",value:1,max:64,padLength:2,min:1,font:b,onChange:function(q){Tracker.setCurrentInstrumentIndex(q)}});h.addChild(z);var y=UI.sliderBox({name:"Volume",label:"Volume",font:b,height:200,width:40,value:64,max:64,min:0,step:1,vertical:!0,trackUndo:!0,undoInstrument:!0,
onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.sample.volume=q)}});p.addChild(y);var B=UI.sliderBox({name:"Finetune",label:"Finetune",font:b,value:0,max:7,min:-8,step:1,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();v&&v.setFineTune(q)}});p.addChild(B);var A=UI.sliderBox({name:"Panning",label:"Panning",font:b,value:0,max:127,min:-127,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();
v&&(v.panning=q,v.sample.panning=q)}});p.addChild(A);var E=UI.spinBox({name:"Repeat",label:"Start",value:0,max:65535,min:0,step:2,font:b,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.sample.loop.length+q>v.sample.length&&(q=v.sample.length-v.sample.loop.length,E.setValue(q,!0)),v.sample.loop.start=q);n.refresh()}});p.addChild(E);var U=UI.spinBox({name:"Repeat Length",label:"Length",value:0,max:65535,min:0,step:2,font:b,trackUndo:!0,undoInstrument:!0,
onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.sample.loop.start+q>v.sample.length&&(q=v.sample.length-v.sample.loop.start,U.setValue(q,!0)),v.sample.loop.length=q);EventBus.trigger(EVENT.samplePropertyChange,{interal_loopLength:q});n.refresh()}});p.addChild(U);var Q=UI.sliderBox({name:"Fadeout",label:"Fadeout",value:0,max:4095,min:0,step:1,font:b,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.fadeout=q)}});p.addChild(Q);
var u=UI.spinBox({name:"relativeNote",label:"RelativeNote",value:0,max:128,min:-127,step:1,font:b,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.sample.relativeNote=q)}});p.addChild(u);var w=UI.spinBox({name:"vibratoSpeed",label:"Vib Speed",value:0,max:63,min:0,step:1,font:b,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.vibrato.rate=q)}});p.addChild(w);w.hide();var D=UI.spinBox({name:"vibratoDepth",label:"Vib Depth",
value:0,max:15,min:0,step:1,font:b,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.vibrato.depth=q)}});p.addChild(D);D.hide();var N=UI.spinBox({name:"vibratoSweep",label:"Vib Sweep",value:0,max:255,min:0,step:1,font:b,trackUndo:!0,undoInstrument:!0,onChange:function(q){var v=Tracker.getCurrentInstrument();v&&(v.vibrato.sweep=q)}});p.addChild(N);N.hide();var R=[];["sin","square","saw","saw_inverse"].forEach(function(q,v){var K=UI.button();K.setProperties({background:UI.Assets.buttonKeyScale9,
activeBackground:UI.Assets.buttonKeyActiveScale9,image:Y.getImage("wave_"+q),activeImage:Y.getImage("wave_"+q),isActive:!1});K.onDown=function(){f(v)};K.hide();p.addChild(K);R.push(K)});f(0);h.addChild(p);var S=[];[{label:"Load",onClick:function(){EventBus.trigger(EVENT.showView,"diskop_samples_load")}},{label:"Play",onDown:function(){Input.handleNoteOn(Input.getPrevIndex())},onUp:function(){Input.handleNoteOff(Input.getPrevIndex());Input.clearInputNotes();n.stop()}},{label:"Range",onDown:function(){n.playSection("range")},
onUp:function(){Input.handleNoteOff(Input.getPrevIndex());Input.clearInputNotes();n.stop()}},{label:"Loop",onDown:function(){n.playSection("loop")},onUp:function(){Input.handleNoteOff(Input.getPrevIndex());Input.clearInputNotes();n.stop()}},{label:"Stop",onClick:function(){Input.clearInputNotes();n.stop()}},{label:"More",onClick:function(){W.toggle();G.toggle();F.toggle();J.toggle();r.toggle();t.toggle();h.refresh()}}].forEach(function(q){var v=UI.Assets.generate("buttonLight");v.setLabel(q.label);
v.onClick=q.onClick;v.onDown=q.onDown;v.onTouchUp=q.onUp;h.addChild(v);S.push(v)});var W=UI.buttonGroup("Display",[{label:"Zoom In",width:62,onClick:function(){n.zoom(2)}},{label:"Out",width:38,onClick:function(){n.zoom(.5)}},{label:"All",width:50,onClick:function(){n.zoom(1)}},{value:0,width:50,type:"number",onSamplePropertyChange:function(q,v){"undefined"!==typeof v.sampleLength&&q.setValue(v.sampleLength)}},{label:"Loop",width:50,onClick:function(){n.zoom("loop")}},{value:0,width:50,type:"number",
onSamplePropertyChange:function(q,v){"undefined"!==typeof v.loopLength&&q.setValue(v.loopLength);"undefined"!==typeof v.interal_loopLength&&q.setValue(v.interal_loopLength)}},{label:"Range",width:50,onClick:function(){n.zoom("range")}},{value:"0",width:50,type:"number",onSamplePropertyChange:function(q,v){"undefined"!==typeof v.rangeLength&&q.setValue(v.rangeLength)}}]),G=UI.buttonGroup("Select",[{label:"[",width:15,onClick:function(){n.select("start")}},{label:"All",width:70,onClick:function(){n.select("all")}},
{label:"]",width:15,onClick:function(){n.select("end")}},{label:"None",width:50,onClick:function(){n.select("none")}},{label:"Loop",width:50,onClick:function(){n.select("loop")}},{label:"Cut",width:50,onClick:function(){UI.cutSelection()}},{label:"Copy",width:50,onClick:function(){UI.copySelection()}},{label:"Paste",onClick:function(){UI.pasteSelection()}}]),F=UI.buttonGroup("Edit",[{label:"Reverse",onClick:function(){n.reverse()}},{label:"Invert",onClick:function(){n.invert()}},{label:"Upsample",
onClick:function(){n.resample("up")}},{label:"DownSample",onClick:function(){n.resample("down")}}]),J=UI.buttonGroup("Volume",[{label:"Maximize",onClick:function(){n.adjustVolume("max")}},{label:"Fade In",width:62,onClick:function(){n.adjustVolume("fadein")}},{label:"Out",width:38,onClick:function(){n.adjustVolume("fadeout")}},{label:"-5%",width:50,onClick:function(){n.adjustVolume(-5)}},{label:"+5%",width:50,onClick:function(){n.adjustVolume(5)}},{label:"-10%",width:50,onClick:function(){n.adjustVolume(-10)}},
{label:"+10%",width:50,onClick:function(){n.adjustVolume(10)}}]);h.addChild(W);h.addChild(G);h.addChild(F);h.addChild(J);var V=UI.button();V.setProperties({background:UI.Assets.panelDarkGreyScale9,activeBackground:UI.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Loop",font:fontSmall,paddingTop:2,paddingTopActive:2,paddingLeft:20});V.onDown=function(){a("loop")};h.addChild(V);var O=UI.checkbox();O.onToggle=function(q){var v=Tracker.getInstrument(e);v&&(v.sample.loop.enabled=q);E.setDisabled(!q);
U.setDisabled(!q);n.refresh()};h.addChild(O);var I=UI.button();I.setProperties({background:UI.Assets.panelDarkGreyScale9,activeBackground:UI.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Vibrato",font:fontSmall,paddingTop:2,paddingTopActive:2});I.onDown=function(){a("vibrato")};h.addChild(I);h.onShow=function(){Input.setFocusElement(h);h.onResize()};h.onKeyDown=function(q,v){if(h.visible)switch(q){case 37:return n.scroll(-1),!0;case 39:return n.scroll(1),!0;case 46:return UI.deleteSelection(),
!0}};h.onResize=function(){if(h.isVisible()){h.clearCanvas();var q=p.height-130-10,v=Math.ceil(p.width/4),K=0,X=2*v;170>p.width&&(v=Math.ceil(p.width/2),K=q=Math.floor(q/2),X=0);n.setPosition(Layout.col2X,20+Layout.defaultMargin+8);n.setSize(Layout.col4W,h.height-n.top-130-28-8);r.setPosition(Layout.col2X,n.top+n.height+Layout.defaultMargin+30);r.setSize(Layout.col2W,130);t.setPosition(Layout.col4X,r.top);t.setSize(Layout.col2W,130);F.setSize(Layout.col1W,130);W.setSize(Layout.col1W,130);G.setSize(Layout.col1W,
130);J.setSize(Layout.col1W,130);W.setPosition(Layout.col2X,n.top+n.height+Layout.defaultMargin+30);G.setPosition(Layout.col3X,W.top);F.setPosition(Layout.col4X,W.top);J.setPosition(Layout.col5X,W.top);var C=0,L=100;Tracker.inFTMode()&&(C=40,L=0);c.setProperties({top:Layout.defaultMargin,left:Layout.col2X+71,width:Layout.col4W-71-25-Layout.defaultMargin-C});m.setProperties({top:Layout.defaultMargin,left:c.left+c.width+Layout.defaultMargin+C});k.setProperties({top:Layout.defaultMargin,width:20,height:20,
left:c.left+c.width+Layout.defaultMargin-2+L});l.setProperties({top:Layout.defaultMargin,width:20,height:20,left:c.left+c.width+Layout.defaultMargin+18+L});p.setProperties({left:0,top:0,width:Layout.col1W,height:h.height});z.setProperties({left:Layout.col2X,top:1,width:68,height:28});y.setProperties({left:0,top:0,width:v,height:q});B.setProperties({left:v,top:0,width:v,height:q});Q.setProperties({left:X,top:K,width:v,height:q});A.setProperties({left:X+v,top:K,width:v,height:q});var x=n.top+n.height+
Layout.defaultMargin,H=Layout.col4W/S.length;S.forEach(function(M,aa){M.setProperties({width:H,height:28,left:Layout.col2X+H*aa,top:x})});V.setProperties({width:Layout.col1W/2,height:18,left:2,top:r.top});O.setPosition(V.left+2,V.top+2);I.setProperties({width:V.width,height:V.height,left:V.left+V.width,top:V.top});E.setProperties({left:0,top:V.top+24,width:Layout.col1W,height:34});U.setProperties({left:0,top:V.top+24+34,width:Layout.col1W,height:34});u.setProperties({left:0,top:V.top+24+68,width:Layout.col1W,
height:34});w.setProperties({left:0,top:I.top+22,width:Layout.col1W,height:30});D.setProperties({left:0,top:I.top+22+30,width:Layout.col1W,height:30});N.setProperties({left:0,top:I.top+22+60,width:Layout.col1W,height:30});var Z=Math.floor((Layout.col1W-4)/4),T=Layout.col1W-4*Z;R.forEach(function(M,aa){M.setProperties({left:T+aa*Z,top:I.top+22+90,width:Z,height:17})})}};EventBus.on(EVENT.instrumentChange,function(q){e=q;z.setValue(q,!0);(q=Tracker.getInstrument(q))?(c.setValue(q.name,!0),B.setValue(q.getFineTune(),
!0),Q.setValue(q.fadeout||0,!0),w.setValue(q.vibrato.rate||0,!0),D.setValue(q.vibrato.depth||0,!0),N.setValue(q.vibrato.sweep||0,!0),f(q.vibrato.type||0),q.sample&&(E.setMax(q.sample.length,!0),U.setMax(q.sample.length,!0),y.setValue(q.sample.volume,!0),A.setValue(q.sample.panning||0,!0),E.setValue(q.sample.loop.start,!0),U.setValue(q.sample.loop.length,!0),u.setValue(q.sample.relativeNote,!0),O.setState(q.sample.loop.enabled,!0),8===q.sample.bits?(k.setActive(!0),l.setActive(!1)):(k.setActive(!1),
l.setActive(!0))),n.setInstrument(q),r.setInstrument(q),t.setInstrument(q)):(n.setInstrument(),r.setInstrument(),t.setInstrument(),c.setValue("",!0),y.setValue(0,!0),A.setValue(0,!0),B.setValue(0,!0),E.setValue(0,!0),U.setValue(0,!0),u.setValue(0,!0),Q.setValue(0,!0))});EventBus.on(EVENT.samplePlay,function(q){h.visible&&q&&q.instrumentIndex===e&&n.play(q.startPeriod,q.effects&&q.effects.offset?q.effects.offset.value:0)});EventBus.on(EVENT.songPropertyChange,function(q){z.setMax(q.instruments.length-
1)});EventBus.on(EVENT.trackerModeChanged,function(q){B.setMax(q===TRACKERMODE.PROTRACKER?7:127,!0);B.setMin(q===TRACKERMODE.PROTRACKER?-8:-128,!0);var v=Tracker.getInstrument(e);v&&B.setValue(v.getFineTune(),!0);r.setDisabled(!Tracker.inFTMode());t.setDisabled(!Tracker.inFTMode());u.setDisabled(!Tracker.inFTMode());w.setDisabled(!Tracker.inFTMode());D.setDisabled(!Tracker.inFTMode());N.setDisabled(!Tracker.inFTMode());Q.setDisabled(!Tracker.inFTMode());A.setDisabled(!Tracker.inFTMode());z.setMax(Tracker.getMaxInstruments());
q===TRACKERMODE.PROTRACKER?(E.setProperties({step:2}),U.setProperties({step:2}),v&&(v.sample.loop.start=2*Math.floor(v.sample.loop.start/2),v.sample.loop.length=2*Math.floor(v.sample.loop.length/2),E.setValue(v.sample.loop.start,!0),U.setValue(v.sample.loop.length,!0)),a("loop")):(E.setProperties({step:1}),U.setProperties({step:1}));h.onResize()});EventBus.on(EVENT.samplePropertyChange,function(q){Tracker.getInstrument(e)&&("undefined"!==typeof q.loopStart&&E.setValue(q.loopStart,q.internal),"undefined"!==
typeof q.loopLength&&U.setValue(q.loopLength,q.internal))});EventBus.on(EVENT.sampleIndexChange,function(q){h.visible&&q===e&&(Tracker.getInstrument(e),EventBus.trigger(EVENT.instrumentChange,e))});return h};UI.DiskOperations=function(){function d(W,G){R.setSelectedIndex(G);r=G;W.isExpanded?(W.isExpanded=!1,a.refreshList()):(W.isExpanded=!0,W.children.length?a.refreshList():(console.log("load children from "+W.url),W.children=[{title:"loading ..."}],a.refreshList(),p?p.get(W.url,function(F){t(W,F)}):FetchService.json(W.url,function(F){t(W,F)})))}var a=UI.panel();a.hide();var f="load",h="modules",e="",b=[],c=[],m=[],g=[],k=[],l=[],n=0,r=0,t=function(){},p,z=UI.scale9Panel(0,0,20,20,UI.Assets.panelMainScale9);
z.ignoreEvents=!0;a.addChild(z);var y=UI.DiskOperationActions();a.addChild(y);var B=UI.DiskOperationType();a.addChild(B);var A=UI.DiskOperationTargets();a.addChild(A);var E=UI.DiskOperationSave();a.addChild(E);var U={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1,height:18,width:50},Q=UI.button(),u=UI.button();u.setActive(!0);Q.setProperties(U);Q.setLabel("Save");Q.onDown=function(){y.setSelectedIndex(1)};
a.addChild(Q);u.setProperties(U);u.setLabel("Load");u.onDown=function(){y.setSelectedIndex(0)};a.addChild(u);var w=UI.label({label:"Load module",font:fontMed});a.addChild(w);var D=UI.Assets.generate("button20_20");D.setLabel("x");D.onClick=function(){App.doCommand(COMMAND.showTopMain)};a.addChild(D);var N=UI.Assets.generate("buttonKey");N.setLabel("browse");N.onClick=function(){var W=document.createElement("input");W.type="file";W.onchange=function(G){Tracker.handleUpload(G.target.files)};W.click()};
a.addChild(N);N.hide();var R=UI.listbox();a.addChild(R);var S=UI.button();S.setProperties({background:UI.Assets.buttonDarkActiveScale9,image:Y.getImage("dropzone"),font:fontSmall,textAlign:"center"});S.onClick=N.onClick;a.addChild(S);S.hide();a.onShow=function(){a.onResize()};a.onResize=function(){a.isVisible()&&(a.clearCanvas(),z.setProperties({left:0,top:0,height:a.height,width:a.width}),D.setProperties({top:3,width:20,heigth:18,left:a.width-30}),N.setProperties({top:D.top+2,width:55,height:18,
left:D.left-60}),730<=a.width?(y.show(),w.show(),u.hide(),Q.hide(),y.setProperties({top:5,left:Layout.col1X,width:Layout.col1W,height:a.height-10}),B.setProperties({top:5,left:Layout.col2X,width:Layout.col1W,height:a.height-10}),A.setProperties({top:5,left:Layout.col3X,width:Layout.col1W,height:a.height-10}),w.setProperties({left:Layout.col4X,top:5,height:20,width:Layout.col2W}),R.setProperties({left:Layout.col4X,width:Layout.col2W,top:24,height:a.height-24-5})):(y.hide(),w.hide(),u.show(),Q.show(),
u.setProperties({top:5,left:Layout.col3X}),Q.setProperties({top:5,left:Layout.col3X+50}),B.setProperties({top:5,left:Layout.defaultMargin,width:Layout.col2W,height:a.height/2-5-16}),A.setProperties({top:a.height/2-16,left:Layout.defaultMargin,width:Layout.col2W,height:a.height/2+16}),R.setProperties({left:Layout.col3X,width:Layout.col3W,top:24,height:a.height-24-5})),"save"===f?(E.setProperties({left:R.left,width:R.width,top:R.top,height:R.height}),R.hide(),E.show()):(R.show(),E.hide()),S.setProperties({left:R.left,
width:R.width,top:R.top,height:R.height}))};a.setView=function(W){e=W;a.refreshList("samples"===e?"samples":"");0<W.indexOf("_save")&&y.setSelectedIndex(1);0<W.indexOf("_load")&&y.setSelectedIndex(0);0<W.indexOf("_samples")&&B.setType(1);0<W.indexOf("_modules")&&B.setType(0)};a.refreshList=function(W){function G(O,I){O.forEach(function(q){var v;q.icon&&(v=Y.getImage(q.icon));v||="modules"===h?Y.getImage("module"):Y.getImage("sample");q.children&&(v=Y.getImage("disk"));J.push({label:q.title,data:q,
level:I,index:V,icon:v,info:q.info});b[V]=q;V++;q.children&&q.children.length&&q.isExpanded&&G(q.children,I+1)})}function F(O,I){b=[];V=0;I=I||0;G(O,0);R.setItems(J);R.setSelectedIndex(I)}if("save"!==f){var J=[],V=0;h!==W&&R.setSelectedIndex(0,!0);h=W||h;"local"==h?(R.hide(),S.show(),N.show()):(R.show(),"bassoon"==h&&(h=B.getType()));switch(h){case "modules":p=!1;w.setLabel("Load Module");R.onClick=function(O){if((O=R.getItemAtPosition(R.eventX,R.eventY))&&O.data){var I=O.index;O=b[I];O.children?
d(O,I):(R.setSelectedIndex(I),Tracker.load(O.url),App.doCommand(COMMAND.showTopMain))}};c.length?F(c,r):FetchService.json(Host.getBaseUrl()+"data/modules.json",function(O){O&&O.modules&&(c=O.modules,F(c,r))});break;case "modarchive":p=ModArchive;w.setLabel("Browse Modarchive");R.onClick=function(O){if((O=R.getItemAtPosition(R.eventX,R.eventY))&&O.data){var I=O.index;O=b[I];O.children?d(O,I):(R.setSelectedIndex(I),Tracker.load(O.url),App.doCommand(COMMAND.showTopMain))}};t=function(O,I){I&&I.length?
"... load more ..."==O.title&&O.parent?(O=O.parent,I.forEach(function(q){q.parent=O}),O.children.pop(),O.children=O.children.concat(I)):(I.forEach(function(q){q.parent=O}),O.children=I):(O.children=[{title:"error loading data"}],console.error("this does not seem to be a valid modArchive API response"));a.refreshList()};g.length?F(g,0):(R.setItems([{label:"loading ..."}]),FetchService.json(Host.getBaseUrl()+"data/modarchive.json",function(O){O&&O.modarchive&&(g=O.modarchive,F(g,0))}));break;case "modulespl":p=
ModulesPl;w.setLabel("Browse Modules.pl");R.onClick=function(O){if((O=R.getItemAtPosition(R.eventX,R.eventY))&&O.data){var I=O.index;O=b[I];O.children?d(O,I):(R.setSelectedIndex(I),Tracker.load(O.url),App.doCommand(COMMAND.showTopMain))}};t=function(O,I){I&&I.length?"... load more ..."==O.title&&O.parent?(O=O.parent,I.forEach(function(q){q.parent=O}),O.children.pop(),O.children=O.children.concat(I)):(I.forEach(function(q){q.parent=O}),O.children=I):(O.children=[{title:"error loading data"}],console.error("this does not seem to be a valid modArchive API response"));
a.refreshList()};k.length?F(k,0):(R.setItems([{label:"loading ..."}]),FetchService.json(Host.getBaseUrl()+"data/modulespl.json",function(O){O&&O.modulespl&&(k=O.modulespl,F(k,0))}));break;case "dropbox":p=Dropbox;w.setLabel("Browse Your Dropbox");UI.setStatus("Contacting Dropbox",!0);R.setItems([{label:"loading ..."}]);R.onClick=function(O){var I=R.getItemAtPosition(R.eventX,R.eventY);I&&I.data&&(O=I.index,I=b[O],I.children?d(I,O):(R.setSelectedIndex(O),UI.setInfo(I.title),UI.setStatus("Loading from Dropbox",
!0),Dropbox.getFile(I,function(q){var v=new FileReader;v.onload=function(){Tracker.processFile(v.result,I.title,function(K){UI.setStatus("Ready")})};v.readAsArrayBuffer(q)})))};t=function(O,I){I&&I.length?(I.forEach(function(q){q.parent=O}),O.children=I):(O.children=[{title:"error loading data"}],console.error("this does not seem to be a valid dropbox API response"));a.refreshList()};l.length?F(l,0):Dropbox.checkConnected(function(O){O?Dropbox.list("",function(I){UI.setStatus("");l=I;F(I,0)}):(console.log("Dropbox not connected"),
Dropbox.showConnectDialog())});break;case "samples":p=!1;w.setLabel("Load Sample to slot "+Tracker.getCurrentInstrumentIndex());R.onClick=function(O){var I=R.getItemAtPosition(R.eventX,R.eventY);I&&I.data&&(O=I.index,I=b[O],I.children?(R.setSelectedIndex(O),n=O,I.isExpanded?(I.isExpanded=!1,a.refreshList()):(I.isExpanded=!0,I.children.length?a.refreshList():FetchService.json(I.url,function(q){q&&q.samples&&(I.children=q.samples,a.refreshList())}))):(R.setSelectedIndex(O),Tracker.load(I.url)))};t=
function(O,I){I&&I.samples&&(O.children=I.samples,a.refreshList())};m.length?F(m,n):FetchService.json(Host.getBaseUrl()+"data/samples.json",function(O){O&&O.samples&&(m=O.samples,F(m,n))});break;case "local":p=!1,w.setLabel("Upload files")}}};a.playRandomSong=function(W){UI.setStatus("Fetching random song",!0);UI.setInfo("");FetchService.json("https://www.stef.be/bassoontracker/api/random"+(W||""),function(G){G&&G.modarchive&&G.modarchive.module?Tracker.load(G.modarchive.module.url):console.error("this does not seem to be a valid modArchive API response")})};
EventBus.on(EVENT.diskOperationTargetChange,function(W){var G=y.getAction();W&&W.target&&(W=W.target);W&&W.fileType&&(W.fileType===FILETYPE.module&&(W="modules"),W.fileType===FILETYPE.sample&&(W="samples"));"undefined"===typeof W&&(W=A.getTarget());console.log(W);"save"===G?(f="save",h=B.getType(),G="Export Module","samples"===h&&(G="Export Sample"),w.setLabel(G),u.isActive&&u.setActive(!1),Q.isActive||Q.setActive(!0),S.hide(),N.hide(),a.onResize(),"dropbox"===W&&Dropbox.checkConnected(function(F){F||
Dropbox.showConnectDialog()})):(f="load",a.refreshList(W),u.isActive||u.setActive(!0),Q.isActive&&Q.setActive(!1))});EventBus.on(EVENT.instrumentChange,function(W){a.isVisible()&&"samples"==h&&w.setLabel("Load Sample to slot "+Tracker.getCurrentInstrumentIndex())});return a};UI.DiskOperationActions=function(){var d=UI.panel(),a=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);a.ignoreEvents=!0;d.addChild(a);var f=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);f.ignoreEvents=!0;d.addChild(f);var h=UI.label({label:"Action",font:fontSmall});d.addChild(h);var e=UI.radioGroup();e.setProperties({align:"right",size:"med",divider:"line",type:"buttons",highLightSelection:!0});e.setItems([{label:"load",active:!0},{label:"save",active:!1}]);e.onChange=function(b){EventBus.trigger(EVENT.diskOperationActionChange,
this.getSelectedItem())};d.addChild(e);d.setLayout=function(){var b=d.width-2,c=70;100>d.height&&(c=d.height-20);UI.mainPanel&&(d.clearCanvas(),a.setProperties({left:0,top:0,height:d.height,width:d.width}),f.setProperties({left:1,top:1,height:16,width:b}),h.setProperties({left:-1,top:3,height:16,width:b}),e.setProperties({left:4,width:b-4,height:c,top:18}))};d.getAction=function(){var b="load";1==e.getSelectedIndex()&&(b="save");return b};d.setSelectedIndex=function(b){e.setSelectedIndex(b)};return d};UI.DiskOperationType=function(){var d=UI.panel(),a=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);a.ignoreEvents=!0;d.addChild(a);var f=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);f.ignoreEvents=!0;d.addChild(f);var h=UI.label({label:"Type",font:fontSmall});d.addChild(h);var e=UI.radioGroup();e.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0});e.setItems([{label:"module",active:!0,fileType:FILETYPE.module},{label:"sample",active:!1,fileType:FILETYPE.sample}]);
e.onChange=function(b){EventBus.trigger(EVENT.diskOperationTargetChange,this.getSelectedItem())};d.addChild(e);d.setLayout=function(){var b=d.width-2,c=70;100>d.height&&(c=d.height-20);UI.mainPanel&&(d.clearCanvas(),a.setProperties({left:0,top:0,height:d.height,width:d.width}),f.setProperties({left:1,top:1,height:16,width:b}),h.setProperties({left:-1,top:3,height:16,width:b}),e.setProperties({left:4,width:b-4,height:c,top:18}))};d.getType=function(){var b=e.getSelectedIndex(),c="modules";1==b&&(c=
"samples");2==b&&(c="patterns");return c};d.setType=function(b){e.setSelectedIndex(b)};return d};UI.DiskOperationTargets=function(){function d(n,r){var t=n.findIndex(function(p){return p.target===r});0<=t&&n.splice(t,1)}var a=UI.panel(),f=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);f.ignoreEvents=!0;a.addChild(f);var h=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);h.ignoreEvents=!0;a.addChild(h);var e=UI.label({label:"From",font:fontSmall});a.addChild(e);var b=[{label:"local:",target:"local",active:!0}],c=[{label:"local:",target:"local",active:!0}],m=[{label:"local:",target:"local",
active:!0},{label:"Dropbox:",target:"dropbox"}];Host.useDropbox||(d(b,"dropbox"),d(c,"dropbox"),d(m,"dropbox"));var g=b,k="load",l=UI.radioGroup();l.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0});l.setItems(b);l.onChange=function(n){EventBus.trigger(EVENT.diskOperationTargetChange,this.getSelectedItem())};a.addChild(l);a.setLayout=function(){var n=a.width-3;UI.mainPanel&&(a.clearCanvas(),f.setProperties({left:0,top:0,height:a.height,width:a.width}),h.setProperties({left:2,
top:1,height:16,width:n}),e.setProperties({left:-1,top:3,height:16,width:n}),l.setProperties({width:n,height:a.height-18-2,left:2,top:18}))};a.getTarget=function(){return"bassoon"};EventBus.on(EVENT.diskOperationTargetChange,function(n){n&&n.fileType&&("save"===k?l.setItems(m):(n.fileType===FILETYPE.module&&(g=b),n.fileType===FILETYPE.sample&&(g=c),l.setItems(g)),l.setSelectedIndex(0))});EventBus.on(EVENT.diskOperationActionChange,function(n){"save"===n.label?(e.setLabel("To"),k="save",l.setItems(m)):
(e.setLabel("From"),k="load",l.setItems(g));EventBus.trigger(EVENT.diskOperationTargetChange,l.getSelectedItem())});EventBus.on(EVENT.dropboxConnectCancel,function(){l.setSelectedIndex(0)});return a};UI.DiskOperationSave=function(){function d(){var r=f,t=f.lastIndexOf("."),p="";0<=t&&(r=f.substr(0,t),p=f.substr(t));(t=k.getSelectedItem())&&t.extention&&(p=t.extention);".mod"===p&&Tracker.inFTMode()&&(p=".xm");n.setValue(r+p)}var a=UI.panel(),f,h=FILETYPE.module,e=FILETYPE.module,b=MODULETYPE.mod,c="local",m=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);m.ignoreEvents=!0;a.addChild(m);var g={};g[FILETYPE.module]=[{label:"module",active:!0,extention:".mod",fileType:FILETYPE.module},{label:"wav",
active:!1,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.WAVE_PCM},{label:"mp3",active:!1,extention:".mp3",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.MP3}];g[FILETYPE.sample]=[{label:"wav 16 bit",active:!1,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RIFF_16BIT},{label:"wav 8 bit",active:!0,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RIFF_8BIT},{label:"RAW 8 bit",active:!1,extention:".sample",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RAW_8BIT}];
var k=UI.radioGroup();k.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0});k.setItems(g[FILETYPE.module]);k.onChange=function(r){h=(r=this.getSelectedItem())&&r.fileType?r.fileType:FILETYPE.module;b=r&&r.fileFormat?r.fileFormat:MODULETYPE.mod;d()};a.addChild(k);var l=UI.button();l.setProperties({label:"Export",textAlign:"center",background:UI.Assets.buttonLightScale9,font:window.fontMed});l.onClick=function(){e==FILETYPE.module&&(h==FILETYPE.module&&Editor.save(f,c),h==
FILETYPE.sample&&BassoonProvider.renderFile(f,b===SAMPLETYPE.MP3));if(e==FILETYPE.sample){var r=Tracker.getCurrentInstrument().sample;if(r){console.error(b);if(b===SAMPLETYPE.RAW_8BIT){var t=new ArrayBuffer(r.length);t=new BinaryStream(t,!0);t.clear(2);for(i=0;i<r.length-2;i++){var p=r.data[i]||0;t.writeByte(Math.round(127*p))}}else t=encodeRIFFsample(r.data,b===SAMPLETYPE.RIFF_16BIT?16:8);t=new Blob([t.buffer],{type:"application/octet-stream"});"dropbox"===c?Dropbox.putFile("/"+f,t):saveAs(t,f);
console.error("write sample with "+r.length+" length")}}};a.addChild(l);var n=UI.inputbox({name:"fileNameInput",height:20,onChange:function(r){f=r},backgroundImage:"panel_mid"});a.addChild(n);a.setLayout=function(){var r=a.width-2;UI.mainPanel&&(a.clearCanvas(),m.setProperties({left:0,top:0,height:a.height,width:a.width}),n.setProperties({left:4,width:r-6,top:4}),l.setProperties({left:2,width:r,height:28,top:a.height-27}),k.setProperties({left:4,width:r-4,height:a.height-l.height-30,top:30}))};EventBus.on(EVENT.songPropertyChange,
function(r){f=r.filename||"";d()});EventBus.on(EVENT.diskOperationTargetChange,function(r){c=r;c.target&&(c=c.target);r&&r.fileType&&(e=r.fileType,e==FILETYPE.sample&&(f=Tracker.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")),e==FILETYPE.module&&(f=Tracker.getFileName()),g[e]&&(k.setItems(g[e]),k.onChange()))});EventBus.on(EVENT.instrumentChange,function(r){a.isVisible()&&e==FILETYPE.sample&&(f=Tracker.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")||"Sample-"+Tracker.getCurrentInstrumentIndex(),
d())});EventBus.on(EVENT.trackerModeChanged,function(r){a.isVisible()&&e==FILETYPE.module&&(f=Tracker.getSong().filename||"",d())});return a};UI.OptionsPanel=function(){var d=UI.panel();d.hide();var a=UI.scale9Panel(0,0,20,20,UI.Assets.panelMainScale9);a.ignoreEvents=!0;d.addChild(a);var f=UI.label({label:"Options:",font:fontMed,left:5,height:18,top:9,width:200});d.addChild(f);var h=UI.Assets.generate("button20_20");h.setLabel("x");h.onClick=function(){App.doCommand(COMMAND.showTopMain)};d.addChild(h);var e=[{label:"VU bars",values:["NONE","COLOURS: AMIGA","TRANSPARENT"],valueLabels:{"COLOURS: AMIGA":[{width:56,label:"AMIGA"},{width:110,
label:"COLOURS: AMIGA"}]},setValue:function(b){SETTINGS.vubars=0===b?"none":2===b?"trans":"colour";Settings.saveSettings()},getValue:function(){var b=1;"none"===SETTINGS.vubars&&(b=0);"trans"===SETTINGS.vubars&&(b=2);return b}},{label:"Stereo",values:["Hard: Amiga","Balanced","None: mono"],setValue:function(b){0===b?Audio.setStereoSeparation(STEREOSEPARATION.FULL):2===b?Audio.setStereoSeparation(STEREOSEPARATION.NONE):Audio.setStereoSeparation(STEREOSEPARATION.BALANCED);Settings.saveSettings()},getValue:function(){var b=
1;SETTINGS.stereoSeparation===STEREOSEPARATION.NONE&&(b=2);SETTINGS.stereoSeparation===STEREOSEPARATION.FULL&&(b=0);return b}},{label:"Keyboard Layout",labels:[{width:56,label:"Keyboard"},{width:110,label:"Keyboard Layout"}],values:["QWERTY","AZERTY","QWERTZ","Dvorak"],setValue:function(b){SETTINGS.keyboardTable=0===b?"qwerty":1===b?"azerty":2===b?"qwertz":"dvorak";Settings.saveSettings()},getValue:function(){var b=0;"azerty"===SETTINGS.keyboardTable&&(b=1);"qwertz"===SETTINGS.keyboardTable&&(b=2);
"dvorak"===SETTINGS.keyboardTable&&(b=3);return b},checkBoxes:[{label:"Show Key Input",labels:[{width:60,label:"Show"},{width:100,label:"Show Key"},{width:150,label:"Show Key Input"}],getValue:function(){return SETTINGS.showKey},handler:function(b){SETTINGS.showKey=b;Settings.saveSettings();EventBus.trigger(EVENT.menuLayoutChanged)}}]},{label:"Screen refresh",labels:[{width:56,label:"Screen"},{width:100,label:"Screen refresh"}],values:["Smooth","Normal","Economical","Low CPU"],setValue:function(b){UI.skipFrame(b);
Settings.saveSettings()},getValue:function(){return UI.getSkipFrame()},checkBoxes:[{label:"Optimize High DPI",labels:[{width:60,label:"H-DPI"},{width:100,label:"High DPI"},{width:155,label:"Optimize High DPI"}],getValue:function(){return SETTINGS.highDPI},handler:function(b){SETTINGS.highDPI=b;Settings.saveSettings();UI.scaleToDevicePixelRatio(b)}}]},{label:"Frequency table",labels:[{width:56,label:"Frequency"},{width:110,label:"Frequency table"}],values:["Linear","Amiga periods"],valueLabels:{"Amiga periods":[{width:56,
label:"AMIGA"},{width:110,label:"Amiga periods"}]},setValue:function(b){Tracker.useLinearFrequency=0===b},getValue:function(){return Tracker.useLinearFrequency?0:1}},{label:"Dropbox: existing file",labels:[{width:20,label:"Dropbox"},{width:80,label:"Dropbox save"},{width:160,label:"Dropbox existing file"}],values:["Rename","Overwrite"],setValue:function(b){SETTINGS.dropboxMode=0===b?"rename":"overwrite";Settings.saveSettings()},getValue:function(){var b=0;"overwrite"===SETTINGS.dropboxMode&&(b=1);
return b}},{label:"Midi-in",labels:[{width:20,label:"Midi"},{width:80,label:"Midi-in"}],values:["Disabled","Enabled Note","Enabled Note-Volume"],valueLabels:{"Enabled Note":[{width:80,label:"Note"},{width:150,label:"Enabled Note"}],"Enabled Note-Volume":[{width:80,label:"Note-Volume"},{width:150,label:"Enabled Note-Volume"}]},setValue:function(b){0===b?(SETTINGS.midi="disabled",Midi.disable()):(SETTINGS.midi=1===b?"enabled-note":"enabled",Midi.enable());Settings.saveSettings()},getValue:function(){var b=
0;"enabled-note"===SETTINGS.midi&&(b=1);"enabled"===SETTINGS.midi&&(b=2);return b},checkBoxes:[{label:"Show Midi Input",labels:[{width:60,label:"Show"},{width:100,label:"Show Midi"},{width:150,label:"Show Midi Input"}],getValue:function(){return SETTINGS.showMidi},handler:function(b){SETTINGS.showMidi=b;Settings.saveSettings();EventBus.trigger(EVENT.menuLayoutChanged)}}]}];e.forEach(function(b){var c=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);c.ignoreEvents=!0;d.addChild(c);var m=UI.label();
m.setProperties({label:b.label,labels:b.labels,font:fontSmall,textAlign:"center"});d.addChild(m);b.labelBox=c;b.label=m;c=[];b.getValue();for(m=0;m<b.values.length;m++){var g=b.values[m];if(g){var k=UI.Assets.generate("buttonKey");b.valueLabels&&b.valueLabels[g]?k.setProperties({label:g,labels:b.valueLabels[g]}):k.setProperties({label:g});k.index=m;k.option=b;k.onClick=function(){this.isDisabled||activateOption(this)}}d.addChild(k);c.push(k)}b.buttons=c;if(b.checkBoxes){var l=b.checkBoxes[0],n=UI.checkboxbutton({background:UI.Assets.panelDarkInsetScale9,
hoverBackground:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.panelDarkInsetScale9,label:l.label,labels:l.labels,checkbox:!0});n.getValue=l.getValue;d.addChild(n);n.onClick=function(){l.handler(n.isActive)};b.checkBox=n}});activateOption=function(b){var c=b.option;c.buttons.forEach(function(m){m.setActive(!1)});b.setActive(!0);c.setValue(b.index)};d.onShow=function(){d.onResize()};d.onResize=function(){if(d.isVisible()){d.clearCanvas();a.setProperties({left:0,top:0,height:d.height,width:d.width});
h.setProperties({top:5,left:d.width-30});var b=[27,103],c=20,m=20,g=0,k=0,l=!1,n=e.length,r=e.length;600>d.width&&(l=!0,b=[27,103],m=c=18,r=4);var t=Math.floor((d.width-Layout.defaultMargin*(r+1))/r);e.forEach(function(p,z){var y=Layout.defaultMargin+g*(t+Layout.defaultMargin),B=b[k];z>=n&&(y=d.width+100);p.labelBox.setProperties({top:B,width:t,height:c,left:y});p.label.setProperties({top:B+3,_width:Layout.col31W,width:t,height:c,left:y+2});z=p.getValue();for(var A=0;A<p.buttons.length;A++){var E=
p.buttons[A];E.setProperties({top:B+A*m+c,height:m,width:t,left:y});E.setActive(A===z)}p.checkBox&&(p.checkBox.setProperties({top:d.height-m-7,height:m+4,width:t,left:y}),p.checkBox.setActive(p.checkBox.getValue()));g++;l&&4<=g&&(g=0,k++)})}};EventBus.on(EVENT.songPropertyChange,function(){if(d.isVisible())d.onResize()});EventBus.on(EVENT.trackerModeChanged,function(){var b=e[4];b.buttons&&b.buttons.length&&b.buttons.forEach(function(c){c.setDisabled(!Tracker.inFTMode())});b=e[1];b.buttons&&b.buttons.length&&
b.buttons.forEach(function(c){c.setDisabled(Tracker.inFTMode())});if(d.isVisible())d.onResize()});return d};UI.app_pianoView=function(){var d=UI.app_panelContainer(200);d.name="pianoViewPanel";var a=[],f,h=[0,2,4,5,7,9,11],e=[-1,1,0,3,0,-1,0,6,0,8,0,10,0,-1],b=Y.getImage("pianokey_white"),c=Y.getImage("pianokey_white_down"),m=Y.getImage("pianokey_black"),g=Y.getImage("pianokey_black_down"),k=0,l,n=3,r=1,t=UI.Assets.generate("button20_20");t.setLabel("x");t.onClick=function(){App.doCommand(COMMAND.togglePiano)};d.addChild(t);var p=UI.spinBox();p.setProperties({name:"Octave",label:"Octave",value:1,max:n,
min:r,left:4,top:2,height:28,width:150,font:window.fontMed,onChange:function(y){Input.setCurrentOctave(y)}});d.addChild(p);d.onShow=function(){d.onPanelResize()};d.onPanelResize=function(){d.innerHeight=d.height-2*Layout.defaultMargin;t.setProperties({top:4,left:d.width-24})};d.onPanelResize();EventBus.on(EVENT.pianoNoteOn,function(y){d.isVisible()&&(a[y]=!0,d.refresh())});EventBus.on(EVENT.pianoNoteOff,function(y){d.isVisible()&&(a[y]=!1,d.refresh())});var z=function(y,B){var A=-1,E=y%420;y=Math.floor(y/
420);0<=B&&(B>k+30?(E=Math.floor(E/60),A=h[E]+12*y):(B=Math.floor((E-15)/30),0>B&&(B=0),12<B&&(B=12),0===B%2?A=h[B/2]:(A=e[B],0>A&&(E=Math.floor(E/60),A=h[E])),A+=12*y));return A+1};d.onDown=function(y){(y=z(y.x,y.y))&&y!==f&&(Input.handleNoteOn(y+12*l),f&&Input.handleNoteOff(f+12*l),f=y)};d.onTouchUp=function(y){(y=z(y.x,y.y))||(y=f);y&&(Input.handleNoteOff(y+12*l),f=void 0);f&&Input.handleNoteOff(f+12*l);f=void 0};d.onDrag=function(y){(y=z(y.x,y.y))&&y!==f&&(Input.handleNoteOn(y+12*l),f&&Input.handleNoteOff(f+
12*l),f=y)};d.renderInternal=function(y){if(d.isVisible()){y=!!y;if(this.needsRendering){for(var B=d.height-30,A=0,E=0;A<d.width;){var U=Math.floor(E/7),Q=E%7;U=12*(l+U)+h[Q]+1;d.ctx.drawImage(a[U]?c:b,A,30,64,B);E++;A+=60}k=Math.floor(B/1.7);B=38;for(A=E=0;B<d.width;)U=Math.floor(E/7),Q=E%7,2!==Q&&6!==Q&&(U=12*(l+U)+e[2*Q+1]+1,d.ctx.drawImage(a[U]?g:m,B,30,48,k),A++),E++,B+=60}this.needsRendering=!1;if(y)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top,d.width,d.height)}};EventBus.on(EVENT.octaveChanged,
function(y){l=y;p.setValue(l,!0)});EventBus.on(EVENT.trackerModeChanged,function(y){n=Tracker.inFTMode()?7:3;r=Tracker.inFTMode()?0:1;p.setMax(n,!0);p.setMin(r,!0)});return d};UI.WaveForm=function(){function d(q){var v=g.sample.loop.start||0;if(q===J.loopStart){if(v<D||v>N)return-10;R=N-D;q=Math.floor((v-D)/R*c.width);return Math.max(5<D?0:5,q)}q=v+g.sample.loop.length;if(q<D||q>N)return-10;q=Math.floor((q-D)/R*c.width);return Math.min(q,c.width-(N>t-6?6:0))}function a(q){if(q===J.rangeStart){if(y<D||y>N)return-10;R=N-D;q=Math.floor((y-D)/R*c.width);return Math.max(5<D?0:5,q)}q=y+A;if(q<D||q>N)return-10;q=Math.floor((q-D)/R*c.width);return Math.min(q,c.width-(N>t-6?6:0))}
function f(q){var v={};A?(v.tail=m.slice(y+A),v.range=m.slice(y,y+A),v.head=m.slice(0,y)):q?(v.range=[],v.tail=m.slice(y),v.head=m.slice(0,y)):(v.tail=[],v.range=m.slice(0,m.length),v.head=[]);return v}function h(q){m=q.head.concat(q.range).concat(q.tail);g.sample.data=m;g.sample.length=m.length;W=!0;EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex());W=!1;V.refresh();c.refresh()}function e(){var q=g.sample.loop.start,v=g.sample.loop.length,K=g.sample.length;0>q&&(q=0);0>
v&&(v=0);q+v>K&&(q>K&&(q=K),v=K-q);if(q!==g.sample.loop.start||v!==g.sample.loop.length)g.sample.loop.start=q,g.sample.loop.length=v,W=!0,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),W=!1,V.refresh(),c.refresh()}function b(q){if(q.loopStart||q.loopLength)g.sample.loop.start=q.loopStart||0,g.sample.loop.length=q.loopLength||0,W=!0,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),W=!1}var c=UI.element();c.name="Waveform";var m,g,k,l,n,r,t,
p,z,y=-1,B=-1,A=0,E=0,U=0,Q=0,u=!1,w=1,D=0,N=0,R=0,S,W,G=[],F=0,J={loopStart:1,loopEnd:2,rangeStart:3,rangeEnd:4},V=UI.element(),O=UI.scale9Panel(0,0,c.width,c.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});O.ignoreEvents=!0;var I=UI.scale9Panel(1,0,100,18,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});I.onDragStart=function(){I.startDragIndex=D;I.startLeft=I.left};I.onDrag=function(q){q=I.startLeft+q.deltaX;var v=c.width-I.width-1;q=Math.max(q,1);q=Math.min(q,v);I.setPosition(q,
I.top);R=N-D;D=Math.floor(q/(v-1)*(t-R));N=D+R;V.refresh()};c.addChild(I);EventBus.on(EVENT.screenRefresh,function(){(k||l)&&c.isVisible()&&c.refresh()});c.scroll=function(q){q=I.left+q;var v=c.width-I.width-1;q=Math.max(q,1);q=Math.min(q,v);I.setPosition(q,I.top);R=N-D;D=Math.floor(q/(v-1)*(t-R));N=D+R;V.refresh()};c.onDragStart=function(q){var v=q.startX;if(g.sample.loop.enabled){var K=d(J.loopEnd);if(5>Math.abs(v-K)){E=J.loopEnd;Q=g.sample.loop.length;return}K=d(J.loopStart);if(5>Math.abs(v-K)){E=
J.loopStart;Q=g.sample.loop.start;return}}if(A&&(K=a(J.rangeEnd),5>Math.abs(v-K))){E=J.rangeEnd;Q=A;return}if(0<=y&&(K=a(J.rangeStart),5>Math.abs(v-K))){E=J.rangeStart;Q=y;return}l=!0;p=z=q.startX;y=B=Math.round(D+g.sample.length/c.width/w*p);A=0;EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:A})};c.onDrag=function(q){var v=g.sample.length/c.width/w;!E||E!==J.loopStart&&E!==J.loopEnd?!E||E!==J.rangeStart&&E!==J.rangeEnd?(z=q.x,B=Math.round(D+z*v),B=Math.max(B,0),A=B-y,EventBus.trigger(EVENT.samplePropertyChange,
{rangeLength:Math.abs(A)})):(U=E,q=q.deltaX,v=Q+Math.round(v*q),E===J.rangeStart?(v=Math.min(v,t-2),y=v=Math.max(v,0),y+A>t&&(A=t-y)):(v=Math.max(v,2),A=v=Math.min(v,t-y)),EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:A}),c.refresh()):(U=E,q=q.deltaX,v=Q+Math.round(v*q),Tracker.inFTMode()||(v-=v%2),q={},E===J.loopStart?(v=Math.min(v,t-2),v=Math.max(v,0),q.loopStart=v,q.loopStart+g.sample.loop.length>t&&(q.loopLength=t-q.loopStart)):(v=Math.max(v,2),v=Math.min(v,t-g.sample.loop.start),q.loopLength=
v),EventBus.trigger(EVENT.samplePropertyChange,q),c.refresh())};c.onTouchUp=function(q){l&&y>B&&(A=y-B,y=B,B=y+A,c.refresh());l=!1;E=0;u=!1;A&&UI.setSelection(c.processSelection)};c.onDown=function(q){u=!0};c.onHover=function(q){if(!l&&!E&&!u){q=U;u||(U=0);var v=c.eventX;if(0<=y&&(K=a(J.rangeStart),5>Math.abs(v-K))){U=J.rangeStart;q!==U&&c.refresh();return}if(0<=B){var K=a(J.rangeEnd);if(5>Math.abs(v-K)){U=J.rangeEnd;q!==U&&c.refresh();return}}if(g.sample.loop.enabled){K=d(J.loopEnd);if(5>Math.abs(v-
K)){U=J.loopEnd;q!==U&&c.refresh();return}K=d(J.loopStart);if(5>Math.abs(v-K)){U=J.loopStart;q!==U&&c.refresh();return}}q!==U&&c.refresh()}};c.onResize=function(){V.setPosition(0,0);V.setSize(c.width,c.height);I.setPosition(I.left,c.height-18);1<w&&I.setSize(Math.floor(c.width/w),18)};c.setInstrument=function(q){(g=q)?(m=g.sample.data,t=m.length):(m=void 0,t=0);EventBus.trigger(EVENT.samplePropertyChange,{sampleLength:t,loopLength:q?q.sample.loop.length:0,internal:!0});W||(k=!1,c.zoom(1),B=y=-1,A=
0,c.refresh())};c.play=function(q,v){1<w||(F=v||0,k=!0,n=(new Date).getTime(),r=Audio.getSampleRateForPeriod(q),c.refresh())};c.playSection=function(q){"range"===q&&Input.handleNoteOn(Input.getPrevIndex(),void 0,y);"loop"===q&&Input.handleNoteOn(Input.getPrevIndex(),void 0,g.sample.loop.start)};c.stop=function(){k=!1;c.refresh()};c.zoom=function(q){var v=!1;"range"===q&&(A?(D=y,R=A,N=D+R,w=t/R,v=c.width/w,v=c.width-v-2,I.setPosition(Math.floor(D/(t-R)*v),I.top),v=!0):q=1);"loop"===q&&(g.sample.loop.enabled&&
(D=g.sample.loop.start,R=g.sample.loop.length,N=D+R,w=t/R,v=c.width/w,v=c.width-v-2,I.setPosition(Math.floor(D/(t-R)*v),I.top)),v=!0);if(1===q||1===w)w=1,D=0;v||(w*=q,w=Math.max(w,1),R=Math.floor(t/w),N=D+R);I.setSize(Math.floor(c.width/w),18);(S=1<w)&&N>t&&(D=t-R,N=t,I.setPosition(c.width-I.width-1,I.top));V.refresh();c.refresh()};c.select=function(q,v,K){switch(q){case "all":y=0;A=B=m.length;c.refresh();break;case "none":B=y=-1;A=0;c.refresh();break;case "loop":2<g.sample.loop.length&&(y=g.sample.loop.start,
A=g.sample.loop.length,B=y+A,c.refresh());break;case "start":y=0;A=B-y;c.refresh();break;case "end":B=m.length;A=B-y;c.refresh();break;case "range":y=v,A=K,B=y+A,c.refresh()}EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:A});UI.setSelection(c.processSelection)};c.render=function(){if(this.needsRendering){if(V.needsRendering){console.log("updating wave");V.clearCanvas();V.ctx.fillStyle="rgb(13, 19, 27)";V.ctx.fillRect(0,0,c.width,c.height);V.ctx.strokeStyle="rgba(120, 255, 50, 0.5)";O.width!==
c.width&&O.setSize(c.width,c.height);V.ctx.drawImage(O.render(!0),0,0,c.width,c.height);if(m&&m.length&&c.width){1===w&&(D=0,N=t);R=N-D;var q=R/c.width,v=c.height/2;V.ctx.beginPath();for(var K=c.height/2-2,X=0;X<c.width;X++){var C=Math.floor(X*q);C=m[D+C]*-K;0===X?V.ctx.moveTo(X,v+C):V.ctx.lineTo(X,v+C)}V.ctx.stroke()}V.needsRendering=!1}c.ctx.drawImage(V.canvas,0,0);k&&t&&(q=(new Date).getTime()-n,C=F+r*q/1E3,g.sample.loop.enabled&&C>g.sample.loop.start?(C=g.sample.loop.start+(C-g.sample.loop.start)%
g.sample.loop.length,q=C/t*c.width,c.ctx.fillStyle="rgb(241, 162, 71)",c.ctx.fillRect(q,0,1,c.height)):C>t?k=!1:(q=C/t*c.width,c.ctx.fillStyle="rgb(241, 162, 71)",c.ctx.fillRect(q,0,1,c.height)));if(2<g.sample.loop.length||g.sample.loop.enabled)q=g.sample.loop.enabled?"rgb(241, 220, 71)":"rgba(150, 150, 150,0.7)",c.ctx.fillStyle=q,U===J.loopStart&&(c.ctx.fillStyle="white"),v=d(J.loopStart),c.ctx.fillRect(v,0,1,c.height-1),c.ctx.fillRect(v-4,0,4,10),c.ctx.fillStyle=q,U===J.loopEnd&&(c.ctx.fillStyle=
"white"),v=d(J.loopEnd),c.ctx.fillRect(v,0,1,c.height-1),c.ctx.fillRect(v+1,0,4,10);v=q=-1;0<=B&&(c.ctx.fillStyle="rgb(241, 131, 71)",U===J.rangeEnd&&(c.ctx.fillStyle="white"),v=a(J.rangeEnd),c.ctx.fillRect(v,0,1,c.height-1),c.ctx.fillRect(v+1,11,4,10));0<=y&&(y<D?q=0:(c.ctx.fillStyle="rgb(241, 131, 71)",U===J.rangeStart&&(c.ctx.fillStyle="white"),q=a(J.rangeStart),c.ctx.fillRect(q,0,1,c.height-1),c.ctx.fillRect(q-4,11,4,10)),y+A<D&&(q=v=-1));q!==v&&(0<=q&&(v=Math.min(v,c.width),0>=v&&(v=c.width)),
c.ctx.fillStyle="rgba(241, 162, 71,0.1)",c.ctx.fillRect(q,0,v-q,c.height));S&&I.render()}this.needsRendering=!1;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)};c.adjustVolume=function(q){var v=f(),K,X,C=!1,L=StateManager.createSampleUndo(SELECTION.REPLACE,y,A);L.data=v.range.slice(0);L.name="Adjust Volume";if("max"===q){var x=K=0;var H=0;for(X=v.range.length;H<X;H++)K=Math.min(K,v.range[H]),x=Math.max(x,v.range[H]);K=1/Math.max(x,-K);if(1<K){H=0;for(X=v.range.length;H<X;H++)v.range[H]*=
K;C=!0}}if("fadein"===q){H=0;for(X=v.range.length-1;H<=X;H++)K=H/X,v.range[H]*=K;C=!0}if("fadeout"===q){H=0;for(X=v.range.length-1;H<=X;H++)K=1-H/X,v.range[H]*=K;C=!0}if(!C){if("number"===typeof q)for(K=1+1/q,H=0,X=v.range.length-1;H<=X;H++)v.range[H]=Math.min(Math.max(v.range[H]*K,-1),1);C=!0}C&&(L.dataTo=v.range.slice(0),StateManager.registerEdit(L),h(v))};c.reverse=function(){var q=f(),v=StateManager.createSampleUndo(SELECTION.REPLACE,y,A);v.data=q.range.slice(0);v.name="Reverse Sample";q.range=
q.range.reverse();v.dataTo=q.range.slice(0);StateManager.registerEdit(v);h(q)};c.invert=function(){var q=f(),v=StateManager.createSampleUndo(SELECTION.REPLACE,y,A);v.data=q.range.slice(0);v.name="Reverse Sample";for(var K=0,X=q.range.length-1;K<=X;K++)q.range[K]=-q.range[K];v.dataTo=q.range.slice(0);StateManager.registerEdit(v);h(q)};c.resample=function(q){var v=f(),K=[],X=StateManager.createSampleUndo(SELECTION.REPLACE,y,A);X.data=v.range.slice(0);X.name="Resample Sample";X.loopStart=g.sample.loop.start;
X.loopLength=g.sample.loop.length;if("up"===q){q=0;for(var C=v.range.length;q<C;q++)K.push(v.range[q]),K.push(v.range[q]);g.sample.loop.start=Math.floor(2*g.sample.loop.start);g.sample.loop.length=Math.floor(2*g.sample.loop.length);y*=2;A*=2}else{q=0;for(C=v.range.length;q<C;q+=2)K.push(v.range[q]);g.sample.loop.start=Math.floor(g.sample.loop.start/2);g.sample.loop.length=Math.floor(g.sample.loop.length/2);y=Math.floor(y/2);A=Math.floor(A/2)}B=y+A;Tracker.inFTMode()||(g.sample.loop.start-=g.sample.loop.start%
2,g.sample.loop.length-=g.sample.loop.length%2);v.range=K;X.dataTo=K.slice(0);StateManager.registerEdit(X);h(v)};c.processSelection=function(q){if(c.isVisible())switch(q){case SELECTION.RESET:return!1;case SELECTION.CLEAR:c.adjustVolume(0);break;case SELECTION.COPY:case SELECTION.CUT:if(0<A){var v=f();G=v.range.slice(0);q===SELECTION.CUT&&(q=StateManager.createSampleUndo(SELECTION.CUT,y,A),q.data=v.range.slice(0),q.name="cut sample",q.loopStart=g.sample.loop.start,q.loopLength=g.sample.loop.length,
StateManager.registerEdit(q),v.range=[],h(v),e(),A=0,B=y+A,EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:A}),c.refresh())}break;case SELECTION.DELETE:0<A&&(v=f(),v.range=[],h(v),A=0,B=y+A,EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:A}),c.refresh());break;case SELECTION.PASTE:v=f(!0),0>y&&(y=m.length),q=StateManager.createSampleUndo(SELECTION.PASTE,y,G.length),q.name="paste sample",q.data=v.range.slice(0),q.dataTo=G.slice(0),q.loopStart=g.sample.loop.start,q.loopLength=g.sample.loop.length,
StateManager.registerEdit(q),0<=y?v.range=G:v.tail=v.tail.concat(G),h(v),e(),setTimeout(function(){c.select("range",y,G.length)},10)}};EventBus.on(EVENT.commandSelectAll,function(){c.isVisible()&&c.select("all")});EventBus.on(EVENT.commandProcessSample,function(q){if(c.isVisible()){if(q.undo)switch(q.action){case SELECTION.CUT:c.select("range",q.from,0);var v=f(!0);v.range=q.data;h(v);b(q);c.select("range",q.from,q.data.length);break;case SELECTION.PASTE:c.select("range",q.from,q.to);v=f(!0);v.range=
q.data;h(v);b(q);c.select("range",q.from,q.data.length);break;case SELECTION.REPLACE:c.select("range",q.from,q.to),v=f(),v.range=q.data,h(v),q.to&&c.select("range",q.from,q.data.length)}if(q.redo)switch(q.action){case SELECTION.CUT:c.select("range",q.from,q.data.length);v=f();v.range=[];h(v);c.select("range",q.from,0);break;case SELECTION.PASTE:c.select("range",q.from,q.data.length||0);v=f(!0);v.range=q.dataTo;h(v);e();c.select("range",q.from,q.dataTo.length);break;case SELECTION.REPLACE:c.select("range",
q.from,q.to),v=f(),v.range=q.dataTo,h(v),q.to&&c.select("range",q.from,q.data.length)}}});return c};UI.Envelope=function(d){var a,f,h,e,b=UI.element();b.type=d;var c=UI.scale9Panel(0,0,b.width,b.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});c.ignoreEvents=!0;var m,g,k,l=-1,n,r,t;b.onResize=function(){r=b.width/324;t=b.height/64};b.onHover=function(p){if(!g&&(l=-1,k=void 0,m&&m.enabled)){p=Math.round(b.eventX/r);for(var z=Math.round((b.height-b.eventY)/t),y=0,B=m.count;y<B;y++){var A=m.points[y]||[0,0];if(6>Math.abs(p-A[0])&&6>Math.abs(z-A[1])){l=y;k={p:m.points[y],minY:0,
maxY:64};0===y?(k.minX=0,k.maxX=0):(k.minX=m.points[y-1][0],k.maxX=324,y<m.count-1&&(k.maxX=m.points[y+1][0]));break}}n!==l&&(n=l,b.refresh())}};b.onDragStart=function(p){k&&(a=k.p[0],f=k.p[1],e=h=void 0,g=!0)};b.onDrag=function(p){if(g){h=p.deltaX/r;e=p.deltaY/t;p=a+h;p=Math.min(k.maxX,p);p=Math.max(k.minX,p);var z=f-e;z=Math.min(k.maxY,z);z=Math.max(k.minY,z);k.p[0]=p;k.p[1]=z;b.refresh()}};b.onTouchUp=function(p){g=!1};b.setInstrument=function(p){m=p?p[b.type+"Envelope"]:void 0;b.refresh()};b.render=
function(){if(this.needsRendering&&(c.width!==b.width&&c.setSize(b.width,b.height),b.ctx.drawImage(c.render(!0),0,0,b.width,b.height),b.ctx.lineWidth=1,"panning"===b.type&&(b.ctx.strokeStyle="#4a7c92",b.ctx.setLineDash([1,2]),A=Math.floor(b.height/2),b.ctx.beginPath(),b.ctx.moveTo(0,A),b.ctx.lineTo(b.width,A),b.ctx.stroke()),m&&m.count)){var p=b.width/324,z=b.height/64;b.ctx.strokeStyle=m.enabled?"rgba(120, 255, 50, 0.5)":"rgba(120, 120, 180, 0.5)";b.ctx.beginPath();b.ctx.setLineDash([]);for(var y=
0;y<m.count;y++)if(A=m.points[y]){var B=A[0]*p,A=b.height-A[1]*z,E=4,U=m.enabled?"#D2861B":"#546888";y===l&&(E=6,U="#FFFFFF");b.ctx.fillStyle=U;0===y?b.ctx.moveTo(B,A):b.ctx.lineTo(B,A);U=E/2;b.ctx.fillRect(B-U,A-U,E,E)}b.ctx.stroke();if(m.enabled){function Q(u){b.ctx.beginPath();b.ctx.moveTo(u,0);b.ctx.lineTo(u,b.height);b.ctx.stroke()}m.sustain&&(z=m.points[m.sustainPoint||0])&&(b.ctx.strokeStyle="#67b6d2",b.ctx.setLineDash([1,2]),Q(z[0]*p));m.loop&&(b.ctx.strokeStyle="#d2b637",b.ctx.setLineDash([1,
2]),z=m.points[m.loopStartPoint||0],y=m.points[m.loopEndPoint||0],z&&Q(z[0]*p),y&&Q(y[0]*p))}}this.needsRendering=!1;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)};return b};UI.EnvelopePanel=function(d){var a=UI.panel();a.type=d;var f,h=!1,e=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);e.ignoreEvents=!0;a.addChild(e);var b=UI.label({label:d+" Envelope",font:fontSmall});b.onClick=function(){c.toggle()};a.addChild(b);var c=UI.checkbox();c.onToggle=function(E){f&&(f.enabled=E,k.refresh())};a.addChild(c);var m=UI.Assets.generate("button20_20");m.onDown=function(){if(f.enabled){if(f.points.length>f.count){var E=f.points[f.count-1]||[0,0],U=f.points[f.count];320>
E[0]+10&&(U[0]<=E[0]&&(U[0]=E[0]+10),f.count++)}else E=f.points[f.points.length-1],320>E[0]+10&&(f.points.push([E[0]+10,32]),f.count=f.points.length);k.refresh()}};m.setProperties({label:"+",width:18,height:18});a.addChild(m);var g=UI.Assets.generate("button20_20");g.onDown=function(){f.enabled&&(2<f.count&&(f.count--,a.checkMax()),k.refresh())};g.setProperties({label:"-",width:18,height:18});a.addChild(g);var k=UI.Envelope(d);a.addChild(k);var l=UI.panel(0,0,20,20),n=UI.checkbox(),r=UI.checkbox(),
t=UI.spinBox(),p=UI.spinBox(),z=UI.spinBox();n.onToggle=function(E){t.setDisabled(!E);f.sustain=E;k.refresh()};r.onToggle=function(E){p.setDisabled(!E);z.setDisabled(!E);f.loop=E;k.refresh()};t.setProperties({label:" ",name:a.type+" envelope sustain",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontFT,trackUndo:!0,undoInstrument:!0,onChange:function(E){f.sustainPoint=E;a.checkMax();k.refresh()}});p.setProperties({label:"From",name:a.type+" envelope loop from",value:0,max:100,min:0,padLength:2,
disabled:!0,font:window.fontSmall,trackUndo:!0,undoInstrument:!0,onChange:function(E){f.loopStartPoint=E;a.checkMax();k.refresh()}});z.setProperties({label:"To",name:a.type+" envelope loop to",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,trackUndo:!0,undoInstrument:!0,onChange:function(E){f.loopEndPoint=E;a.checkMax();k.refresh()}});var y=UI.scale9Panel(0,0,l.width,l.height,UI.Assets.panelMainScale9);y.ignoreEvents=!0;l.addChild(y);l.addChild(t);l.addChild(p);l.addChild(z);
var B=UI.label({label:"Sustain",font:fontSmall,width:60});l.addChild(B);var A=UI.label({label:"Loop",font:fontSmall,width:60});l.addChild(A);l.addChild(n);l.addChild(r);a.addChild(l);a.setInstrument=function(E){E&&(f=E[d+"Envelope"],k.setInstrument(E),c.setState(f&&f.enabled),n.setState(f&&f.sustain),r.setState(f&&f.loop),t.setValue(f.sustainPoint||0,!0),p.setValue(f.loopStartPoint||0,!0),z.setValue(f.loopEndPoint||0,!0))};a.setDisabled=function(E){h=E;a.ignoreEvents=h;a.refresh()};a.onResize=function(){l.setSize(120,
a.height);var E=l.width;e.setSize(a.width-E-36,18);b.setSize(a.width-E,20);c.setPosition(2,2);b.setPosition(12,2);k.setPosition(0,20);k.setSize(a.width-E+1,a.height-22);y.setSize(l.width,l.height);l.setPosition(a.width-l.width,0);n.setPosition(4,4);B.setPosition(14,4);t.setProperties({left:10,top:20,width:100,height:28});r.setPosition(5,50);A.setPosition(14,50);p.setProperties({left:10,top:70,width:100,height:28});z.setProperties({left:10,top:98,width:100,height:28});m.setPosition(e.width,e.top);
g.setPosition(e.width+18,e.top)};a.renderInternal=function(){h&&(a.ctx.fillStyle="rgba(34, 49, 85, 0.4)",a.ctx.fillRect(0,0,a.width,a.height))};a.checkMax=function(){f.count&&(f.sustainPoint>=f.count&&t.setValue(f.count-1),f.loopStartPoint>=f.count&&p.setValue(f.count-1),f.loopEndPoint>=f.count&&z.setValue(f.count-1))};return a};UI.visualiser=function(){function d(){k=[];var n=Tracker.getTrackCount(),r=a.height;4<Tracker.getTrackCount()&&(n=Math.ceil(Tracker.getTrackCount()/2),r=a.height/2);for(var t=a.width/n,p=0;p<Tracker.getTrackCount();p++){var z=p*t,y=0;p>=n&&(z=(p-n)*t,y=a.height-r);k[p]={left:Math.floor(z),top:Math.floor(y),width:Math.floor(t),height:Math.floor(r),lineLeft:Math.ceil(z+t/70),lineWidth:Math.floor(t-t/30)}}}var a=UI.panel(),f=["wave","spectrum","tracks"],h=2,e=f[h],b,c,m=[],g=[],k=[],l=256;a.ctx.fillStyle=
"black";a.ctx.lineWidth=2;a.ctx.strokeStyle="rgba(120, 255, 50, 0.5)";a.init=function(){if(Audio.context){b=Audio.context.createAnalyser();b.minDecibels=-90;b.maxDecibels=-10;b.smoothingTimeConstant=.85;function r(){var t=Audio.context.createAnalyser();t.smoothingTimeConstant=0;t.fftSize=l;m.push(t)}for(var n=0;n<Tracker.getTrackCount();n++)r();d()}c=Y.getImage("oscilloscope");EventBus.on(EVENT.filterChainCountChange,function(r){for(var t=m.length;t<r;t++)addAnalyser();d();a.connect()});EventBus.on(EVENT.trackStateChange,
function(r){"undefined"!==typeof r.track&&(g[r.track]=r.mute)});a.needsRendering=!0};a.connect=function(n){if(Audio.context)for(n&&n.connect(b),n=0;n<Tracker.getTrackCount();n++)Audio.filterChains[n].output().connect(m[n])};a.nextMode=function(){h++;h>=f.length&&(h=0);e=f[h];console.log("setting visualiser to mode "+e)};a.render=function(){if(Audio.context&&a.isVisible()){a.ctx.clearRect(0,0,a.width,a.height);a.ctx.lineWidth=2;a.ctx.strokeStyle="rgba(120, 255, 50, 0.5)";for(var n=!Audio.cutOff,r,
t,p=0;p<Tracker.getTrackCount();p++){var z=m[p],y=k[p],B=g[p];a.ctx.drawImage(c,y.left,y.top,y.width,y.height);if(z){a.ctx.beginPath();var A=y.lineLeft,E=y.lineWidth;if(n&&!B){z.fftSize=l;r=z.fftSize;t=new Uint8Array(r);z.getByteTimeDomainData(t);E/=r;for(var U=0;U<r;U++)z=t[U]/128*y.height/2+y.top,0===U?a.ctx.moveTo(A,z):a.ctx.lineTo(A,z),A+=E}else z=y.height/2+y.top,a.ctx.moveTo(A,z),a.ctx.lineTo(A+E-1,z);a.ctx.stroke();B&&(a.ctx.fillStyle="rgba(34, 49, 85, 0.5)",a.ctx.fillRect(y.left,y.top,y.width,
y.height))}}ctx.drawImage(a.canvas,a.left,a.top)}};a.init();a.onResize=function(){d()};EventBus.on(EVENT.screenRender,function(){a.render()});EventBus.on(EVENT.second,function(){Tracker.isPlaying()&&32>UI.getAverageFps()&&32<l&&(l>>=1,l=Math.max(l,32),UI.resetAverageFps(),console.warn("Low framerate, setting analyser FFT size to "+l))});a.onClick=function(n){if("tracks"===e)for(var r=0;r<Tracker.getTrackCount();r++){var t=k[r],p=n.x,z=n.y;if(p>t.left&&p<t.left+t.width&&z>t.top&&z<t.top+t.height){EventBus.trigger(EVENT.trackScopeClick,
r);break}}};return a};UI.vumeter=function(){function d(){k.width=l.width=g;k.height=l.height=6;var E=Math.floor(g/12);n.clearRect(0,0,k.width,k.height);r.clearRect(0,0,l.width,l.height);for(var U=0;U<E;U++){var Q=t,u=p;U>=E/3&&(Q=z,u=y);U>=E/1.5&&(Q=B,u=A);n.drawImage(Q,12*U,0,10,6);r.drawImage(u,12*U,0,10,6)}f.ctx.fillStyle="#253352"}function a(E){for(var U=E.length,Q=128,u=128,w=0;w<U;w++){var D=E[w];D<Q?Q=D:D>u&&(u=D)}return(u-Q)/255}var f=UI.panel();f.left=400;f.top=9;var h;if(Audio.context){var e=Audio.context.createAnalyser();
e.minDecibels=-90;e.maxDecibels=-10;e.smoothingTimeConstant=.85;var b=Audio.context.createAnalyser();b.minDecibels=-90;b.maxDecibels=-10;b.smoothingTimeConstant=.85;e.fftSize=32;b.fftSize=32;var c=e.fftSize;var m=new Uint8Array(c)}var g=500,k=document.createElement("canvas"),l=document.createElement("canvas"),n=k.getContext("2d"),r=l.getContext("2d"),t=Y.getImage("vu_green"),p=Y.getImage("vu_green_active"),z=Y.getImage("vu_yellow"),y=Y.getImage("vu_yellow_active"),B=Y.getImage("vu_red"),A=Y.getImage("vu_red_active");
f.setSize(g,16);d();f.needsRendering=!0;f.connect=function(E){if(Audio.context){var U=Audio.context.createChannelSplitter(2);E.connect(U);U.connect(e,0);U.connect(b,1);h=!0}};f.setProperties=function(E){g=E.width;f.left=E.left;f.setSize(g,16);d()};f.render=function(){if(h){e.getByteTimeDomainData(m);var E=a(m)*(Math.E-1);b.getByteTimeDomainData(m);var U=a(m)*(Math.E-1);f.ctx.fillRect(0,0,f.width,f.height);f.ctx.drawImage(k,0,0);f.ctx.drawImage(k,0,10);E=Math.min(Math.floor(E*g),g);U=Math.min(Math.floor(U*
g),g);E&&f.ctx.drawImage(l,0,0,E,6,0,0,E,6);U&&f.ctx.drawImage(l,0,0,U,6,0,10,U,6);ctx.drawImage(f.canvas,f.left,f.top)}};EventBus.on(EVENT.screenRender,function(){f.render()});return f};UI.spinBox=function(d){function a(n){"undefined"!=typeof n.size&&(h=n.size);"undefined"!=typeof n.label&&(e=n.label);"undefined"!=typeof n.labels&&(b=n.labels);"undefined"!=typeof n.font&&(c=n.font);"undefined"!=typeof n.step&&(m=n.step)}var f=UI.numberDisplay(d);f.type="spinBox";var h="medium",e="",b,c,m=1;d&&a(d);var g=UI.Assets.generate("button20_20");g.onDown=function(){f.isDisabled||(f.updateValue(f.getValue()-m),UI.ticker.onEachTick4(function(){f.updateValue(f.getValue()-m)},10))};g.onTouchUp=
function(){UI.ticker.onEachTick4()};g.setProperties({name:"buttonDown",label:"\u2193"});f.addChild(g);var k=UI.Assets.generate("button20_20");k.onDown=function(){f.isDisabled||(f.updateValue(f.getValue()+m),UI.ticker.onEachTick4(function(){f.updateValue(f.getValue()+m)},10))};k.onTouchUp=function(){UI.ticker.onEachTick4()};k.setProperties({name:"buttonUp",label:"\u2191"});f.addChild(k);var l=f.setProperties;f.setProperties=function(n){a(n);l&&l(n)};f.renderInternal=function(){e&&(c?c.write(f.ctx,
e,6,11,0):(f.ctx.fillStyle="white",f.ctx.fillText(e,10,10)));k.render();g.render()};f.onResize=function(){b&&b.forEach(function(n){f.width>=n.width&&(e=n.label)});"big"===h?(k.setProperties({left:f.width-g.width,height:Math.floor(f.height/2),top:0}),g.setProperties({left:k.left,height:k.height,top:f.height-k.height}),f.paddingLeft=2,f.paddingRight=k.width,f.paddingBottom=-1,f.paddingTop=-1):(g.setProperties({left:f.width-g.width,top:3}),k.setProperties({left:f.width-k.width-g.width,top:3}),f.paddingLeft=
k.left-8*f.padLength-10-4,f.paddingRight=k.width+g.width+1,f.paddingBottom=f.height-k.height-8)};return f};UI.sliderBox=function(d){function a(w){U.forEach(function(D){if("undefined"!=typeof w[D])switch(D){case "label":h=w[D];break;case "value":b=e=w[D];break;case "min":c=w[D];break;case "max":m=w[D];break;case "step":break;case "onChange":l=w[D];break;case "font":g=w[D];break;case "vertical":n=!!w[D];Q&&Q.setProperties({vertical:n});break;default:f[D]=w[D]}})}var f=UI.element();f.type="sliderBox";var h="",e=0,b=0,c=0,m=100,g,k=4,l,n,r=0,t=0,p=0,z=0,y=10,B=10,A=!1,E=Y.getImage("line_ver");var U="left top width height name label value onChange min max step vertical font trackUndo undoLabel undoInstrument".split(" ");
d&&a(d);9999<m&&(k=5);var Q=UI.rangeSlider({min:c,max:m,height:20,width:20,vertical:!!n,onChange:function(w){w!==e&&f.setValue(w)}});f.addChild(Q);var u=UI.numberDisplay({min:c,max:m,padLength:4,size:"small",onChange:function(w){w!==e&&f.setValue(w)}});u.paddingBottom=-1;f.addChild(u);f.setProperties=function(w){a(w);f.setSize(f.width,f.height);f.setPosition(f.left,f.top)};f.setValue=function(w,D){w!==e&&(b=e);e=w;Q.setValue(e,D);u.setValue(e,D);f.refresh();!D&&l&&(f.trackUndo&&(w=StateManager.createValueUndo(f),
w.name=f.undoLabel||"Change "+f.name,f.undoInstrument&&(w.instrument=Tracker.getCurrentInstrumentIndex(),w.id+=w.instrument),StateManager.registerEdit(w)),l(e))};f.getValue=function(){return e};f.getPrevValue=function(){return b};f.setMax=function(w,D){m=w;!D&&e>m&&f.setValue(m);Q.setMax(m,D);u.setMax(m,D)};f.setMin=function(w,D){c=w;!D&&e<c&&f.setValue(c);Q.setMin(c,D);u.setMin(c,D)};f.setDisabled=function(w){A=w;f.refresh();f.ignoreEvents=A};f.render=function(w){w=!!w;f.needsRendering&&(f.clearCanvas(),
Q.render(),u.render(),g?g.write(f.ctx,h,r,t,0):(f.ctx.fillStyle="white",f.ctx.fillText(h,r,t)),n&&f.ctx.drawImage(E,f.width-2,0,2,f.height),A&&(f.ctx.fillStyle="rgba(34, 49, 85, 0.6)",f.ctx.fillRect(1,0,f.width-1,f.height)));f.needsRendering=!1;if(w)return f.canvas;f.parentCtx.drawImage(f.canvas,f.left,f.top,f.width,f.height)};f.onMouseWheel=function(w){0<w.mouseWheels[0]?(e++,e>m&&(e=m)):(e--,e<c&&(e=c));f.setValue(e)};Q.onMouseWheel=f.onMouseWheel;f.onResize=function(){y=40;B=20;5==k&&(y=48,p-=
8);n?(Q.setSize(20,f.height-36),Q.setPosition(Math.floor((f.width-20)/2),0),p=Math.floor((f.width-40)/2),z=f.height-32,r=Math.floor((f.width-g.getTextWidth(h,0))/2),t=f.height-10):(Q.setSize(f.width,20),Q.setPosition(0,f.height-20),p=f.width-40,z=2);u.setSize(y,B);u.setPosition(p,z)};return f};UI.editPanel=function(d,a,f,h,e){var b=UI.element(d,a,f,h,e);b.type="EditPanel";var c=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);b.addChild(c);d=["clear","copy","paste"];var m=[];for(a=0;6>a;a++)f=UI.Assets.generate("buttonDark"),f.index=a,f.onClick=function(){switch(this.index){case 0:Editor.clearTrack();UI.setStatus("Track cleared");break;case 1:Editor.clearPattern();UI.setStatus("Pattern cleared");break;case 2:Editor.copyTrack();UI.setStatus("Track copied");break;case 3:Editor.copyPattern();
UI.setStatus("Pattern copied");break;case 4:UI.setStatus(Editor.pasteTrack()?"Track pasted":"Nothing to paste!");break;case 5:UI.setStatus(Editor.pastePattern()?"Pattern pasted":"Nothing to paste!")}},f.setProperties({label:"  "+d[Math.floor(a/2)],font:fontSmall,textAlign:"center",paddingTop:3}),b.addChild(f),m.push(f);var g="left top width height name type".split(" ");b.setProperties=function(k){g.forEach(function(r){"undefined"!=typeof k[r]&&(b[r]=k[r])});b.setSize(b.width,b.height);b.setPosition(b.left,
b.top);c.setSize(b.width,b.height);for(var l=Math.floor(b.width/2)-2,n=0;6>n;n++)m[n].setProperties({left:n%2*l+2,width:l,top:25+21*Math.floor(n/2),height:21})};b.render=function(k){k=!!k;if(b.needsRendering){if(!b.isVisible())return;b.clearCanvas();c.render();window.fontMed.write(b.ctx,"\u2193Track",6,11,0);window.fontMed.write(b.ctx,"\u2193Pattern",m[1].left+6,11,0);for(var l=0;6>l;l++)m[l].render()}b.needsRendering=!1;if(k)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)};
return b};UI.app_songControl=function(d,a,f,h,e){var b=UI.element(d,a,f,h,e);b.type="songControl";var c=UI.radioGroup();c.setItems([{label:"song",active:!0},{label:"pattern",labels:[{width:10,label:"p"},{width:20,label:"pat"}],active:!1}]);c.onChange=function(r){0==r?Tracker.setPlayType(PLAYTYPE.song):Tracker.setPlayType(PLAYTYPE.pattern)};b.addChild(c);var m=UI.Assets.generate("buttonDarkGreen");m.setProperties({image:Y.getImage("play_green"),hoverImage:Y.getImage("play_green_hover"),activeImage:Y.getImage("play_active_red"),
activeBackground:UI.Assets.buttonDarkRedActiveScale9});m.onClick=function(){m.toggleActive();Tracker.isPlaying()?Tracker.stop():Tracker.getPlayType()==PLAYTYPE.song?Tracker.playSong():Tracker.playPattern()};m.setProperties({name:"buttonPlay"});b.addChild(m);var g=UI.Assets.generate("buttonDarkRed");g.setProperties({image:Y.getImage("record"),hoverImage:Y.getImage("record_hover"),activeImage:Y.getImage("record_active")});g.onClick=function(){Tracker.toggleRecord()};g.setProperties({name:"buttonRecord"});
b.addChild(g);var k=UI.Assets.generate("buttonDark");k.onClick=function(){Tracker.playSong()};k.setProperties({label:"Song"});b.addChild(k);var l=UI.Assets.generate("buttonDark");l.onClick=function(){Tracker.playPattern()};l.setProperties({label:"Pattern"});b.addChild(l);EventBus.on(EVENT.recordingChange,function(r){g.setActive(r)});EventBus.on(EVENT.playingChange,function(r){m.setActive(r)});EventBus.on(EVENT.playTypeChange,function(r){r==PLAYTYPE.song?c.setSelectedIndex(0,!0):c.setSelectedIndex(1,
!0)});var n="left top width height name type songPatternSelector".split(" ");b.setProperties=function(r){n.forEach(function(p){"undefined"!=typeof r[p]&&(b[p]=r[p])});b.setSize(b.width,b.height);b.setPosition(b.left,b.top);var t=Math.floor(b.width/3);c.setProperties({left:0,width:t,top:0,height:b.height,align:"right"});m.setProperties({left:t,width:t,top:0,height:b.height});g.setProperties({left:2*t,width:t,top:0,height:b.height});"big"==b.songPatternSelector&&(c.left=-500,t=Math.floor(b.width/4)+
1,m.setProperties({left:0,width:t}),g.setProperties({left:t,width:t}),k.setProperties({left:2*t,width:t,top:0,height:b.height}),l.setProperties({left:3*t,width:t,top:0,height:b.height}))};b.render=function(r){r=!!r;b.needsRendering&&(b.clearCanvas(),"small"==b.songPatternSelector&&c.render(),m.render(),g.render(),"big"==b.songPatternSelector&&(k.render(),l.render()));b.needsRendering=!1;if(r)return b.canvas;b.parentCtx.drawImage(b.canvas,b.left,b.top,b.width,b.height)};return b};UI.trackControl=function(d,a,f,h,e){function b(k){EventBus.trigger(EVENT.trackStateChange,{track:c.track,solo:m.solo.isActive,mute:m.mute.isActive,wasSolo:k})}var c=UI.element(d,a,f,h,e);c.type="trackControl";c.track=0;var m={};m.solo=UI.Assets.generate("buttonDark");m.solo.setProperties({activeImage:Y.getImage("solo.png"),activeBackground:UI.Assets.buttonDarkGreenActiveScale9});m.solo.onClick=function(){var k=m.solo.isActive;m.solo.toggleActive();m.mute.isActive&&m.mute.toggleActive();b(k)};m.solo.setProperties({name:"buttonSolo",
label:"S"});c.addChild(m.solo);m.mute=UI.Assets.generate("buttonDark");m.mute.setProperties({activeImage:Y.getImage("mute"),activeBackground:UI.Assets.buttonDarkRedActiveScale9});m.mute.onClick=function(){m.mute.toggleActive();m.solo.isActive&&m.solo.toggleActive();b()};m.mute.setProperties({name:"buttonMute",label:"M"});c.addChild(m.mute);m.fx=UI.Assets.generate("buttonDark");m.fx.onClick=function(){m.fx.toggleActive();EventBus.trigger(EVENT.fxPanelToggle,c.track)};m.fx.setProperties({name:"buttonFX",
label:"FX"});c.addChild(m.fx);var g="left top width height name type track solo mute visible".split(" ");c.setProperties=function(k){g.forEach(function(n){if("undefined"!=typeof k[n])switch(n){case "solo":m.mute.isActive&&m.mute.setActive(!1);m.solo.setActive(k[n]);b();break;case "mute":m.solo.isActive&&m.solo.setActive(!1);m.mute.setActive(k[n]);b();break;default:c[n]=k[n]}});c.setSize(c.width,c.height);c.setPosition(c.left,c.top);var l=Math.floor(c.width/3)+1;m.solo.setProperties({left:0,width:l,
top:0,height:c.height});m.mute.setProperties({left:l-1,width:l,top:0,height:c.height});m.fx.setProperties({left:2*l-2,width:l,top:0,height:c.height})};c.render=function(k){if(c.isVisible()){k=!!k;c.needsRendering&&(c.clearCanvas(),c.ctx.fillStyle="white",c.ctx.fillText("",10,10),m.solo.render(),m.mute.render(),m.fx.render());c.needsRendering=!1;if(k)return c.canvas;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)}};EventBus.on(EVENT.trackScopeClick,function(k){if(k===c.track)m.mute.onClick()});
return c};UI.buttonGroup=function(d,a){var f=UI.panel();f.hide();var h=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);h.ignoreEvents=!0;f.addChild(h);d=UI.label({label:d,font:fontSmall,width:60,top:1});f.addChild(d);var e=[];a.forEach(function(b){if("number"===b.type){var c=UI.numberDisplay({autoPadding:!0});c.setValue(b.value)}else c=UI.Assets.generate("buttonLight"),c.setLabel(b.label),c.onClick=b.onClick;c.widthParam=b.width||100;f.addChild(c);e.push(c);if(b.onSamplePropertyChange)EventBus.on(EVENT.samplePropertyChange,
function(m){b.onSamplePropertyChange(c,m)})});f.onResize=function(){h.setSize(f.width,18);var b=20,c=(f.height-b-2)/4,m=f.width,g=0;e.forEach(function(k,l){k.setProperties({width:Math.floor(m*k.widthParam/100),height:c,left:Math.floor(g*m/100),top:b});g+=k.widthParam;95<g&&(g=0,b+=c)})};return f};UI.InfoPanel=function(){var d=UI.element(),a="",f="",h,e=UI.Assets.generate("buttonDark");e.setLabel("More info ");e.onClick=function(){h&&window.open(h)};d.addChild(e);var b=UI.animsprite(5,7,20,18,"boing",11);d.addChild(b);b.hide();EventBus.on(EVENT.statusChange,function(m){m&&("undefined"!==typeof m.status&&(f=m.status),"undefined"!==typeof m.info&&(a=m.info,h=m.url),"undefined"!==typeof m.showSpinner&&b.toggle(!!m.showSpinner));d.refresh()});var c="left top width height name type zIndex".split(" ");
d.setProperties=function(m){c.forEach(function(g){"undefined"!==typeof m[g]&&(d[g]=m[g])});d.setSize(d.width,d.height);d.setPosition(d.left,d.top);d.setLayout&&d.setLayout(d.left,d.top,d.width,d.height)};d.setLayout=function(){var m=Layout.col1W,g="More Info";100>m&&(g="info");45>m&&(g="i");e.setProperties({width:Layout.col1W,height:24,top:2,left:Layout.col5X-2-d.left,label:g,font:fontFT})};d.render=function(m){if(d.isVisible()){m=!!m;if(this.needsRendering){d.clearCanvas();h&&e.render();var g=a;
f&&(g=f+": "+g);var k=6;b.isVisible()&&(b.render(),k+=20);window.fontFT.write(d.ctx,g,k,11,0)}this.needsRendering=!1;if(m)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top,d.width,d.height)}};return d};var ModArchive=function(){function d(l){g.length?l&&l(g):f("genres",function(n){if(n){var r={};n.forEach(function(t){console.log(t);if(t.parent){var p={title:t.name,count:t.count,info:t.count+" >",children:[],url:"genre/"+t.id};r[t.parent]||(r[t.parent]=[]);r[t.parent].push(p)}});n.forEach(function(t){if(!t.parent){t={title:t.name,children:r[t.id]||[]};var p=0;t.children.forEach(function(z){p+=z.count});t.info=p+" >";g.push(t)}})}l&&l(g)})}function a(l){k.length?l&&l(k):f("artists",function(n){n&&
n.forEach(function(r){k.push({title:r.handle,children:[],info:r.count+" >",url:"artist/"+r.id})});l&&l(k)})}function f(l,n){console.log("load from api "+m+l);FetchService.json(m+l,function(r){n(r)})}function h(l,n){console.log("load from api "+m+l);FetchService.json("https://www.stef.be/bassoontracker/api/"+l,function(r){r&&r.modarchive&&(r=r.modarchive);n(r)})}function e(l){var n=[];l&&l.forEach(function(r){n.push({title:r.title||"---",url:"https://api.modarchive.org/downloads.php?moduleid="+r.id,
icon:r.format,info:formatFileSize(r.size)})});return n}function b(l,n){var r=[];if(l){if(l.module){var t=l.module;t.forEach?t.forEach(function(z){r.push({title:z.songtitle||"---",url:z.url,icon:"mod"})}):r.push({title:t.songtitle||"---",url:t.url,icon:"mod"})}if(l.totalpages&&(l=parseInt(l.totalpages),1<l)){t=n[0]+"/";var p=parseInt(n[1]||1);isNaN(p)&&(p=1);if("artist/"==t||"genre/"==t)t+=n[1]+"/",p=parseInt(n[2]||1),isNaN(p)&&(p=1);l>p&&r.push({title:"... load more ...",children:[],url:t+(p+1)})}}return r}
var c={},m="http://localhost:3000/";m="https://www.stef.be/bassoontracker/api/ma/";var g=[],k=[];c.get=function(l,n){var r=l.split("/");l=r[0];var t=r[1]||"",p=r[2]||"";switch(l){case "genres":d(n);break;case "artists":a(n);break;case "genre":f("genre/"+t,function(z){n(e(z))});break;case "toprating":h("toprating/"+(t||1),function(z){n(b(z,r))});break;case "topreview":h("topreview/"+(t||1),function(z){n(b(z,r))});break;case "artist":l="artist/"+t;p&&(l+="/"+p);f(l,function(z){n(e(z,r))});break;default:n([])}};
return c}();var ModulesPl=function(){function d(g){m.length?g&&g(m):h("artists",function(k){k&&k.forEach(function(l){console.log(l);m.push({title:l.handle,info:l.count+" >",url:"artist/"+l.id,children:[]})});g&&g(m)})}function a(g){c.length?g&&g(c):h("genres",function(k){k&&k.forEach(function(l){c.push({title:l.name,url:"genre/"+l.name,children:[],info:l.count+" >"})});g&&g(c)})}function f(g,k,l){g="genre/"+g;k&&(k=parseInt(k),g+="/"+k);h(g,function(n){l(e(n))})}function h(g,k){console.log("load from api https://www.stef.be/bassoontracker/api/mpl/"+
g);FetchService.json("https://www.stef.be/bassoontracker/api/mpl/"+g,function(l){k(l)})}function e(g,k){var l=[];g&&g.forEach(function(n){var r=formatFileSize(n.size),t=n.title||"---";k&&(t=n[k]+": "+t);l.push({title:t,url:"https://www.stef.be/bassoontracker/api/modules.pl/"+n.id,info:r,icon:n.format})});return l}var b={},c=[],m=[];b.get=function(g,k){var l=g.split("/");g=l[0];var n=l[1]||"";l=l[2]||"";switch(g){case "genres":a(k);break;case "genre":f(n,l,k);break;case "toprating":h("toprating/"+
(n||1),function(r){k(e(r,"rate"))});break;case "topscore":h("topscore/"+(n||1),function(r){k(e(r,"score"))});break;case "artists":d(k);break;case "artist":g="artist/"+n;l&&(g+="/"+l);h(g,function(r){k(e(r))});break;default:k([])}};return b}();var Dropbox=function(){var d={isConnected:!1,checkConnected:function(a){d.isConnected&&a&&a(!0);dropboxService.getAccessToken()?dropboxService("users/get_current_account",void 0,{onComplete:function(f){f&&f.account_id&&(d.isConnected=!0,a&&a(!0))},onError:function(){a&&a(!1)}}):a&&a(!1)},showConnectDialog:function(){var a=UI.modalDialog();a.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0,cancel:!0});a.onClick=function(f){(f=a.getElementAtPoint(f.x,f.y))&&f.name&&
(UI.setStatus(""),"okbutton"===f.name?Dropbox.authenticate():(a.close(),EventBus.trigger(EVENT.dropboxConnectCancel)))};a.setText("DROPBOX ://BassoonTracker is not yet connected to DropBox//Do you want to do that now?//(BassoonTracker will only have access/to its own BassoonTracker folder)");UI.setModalElement(a)},authenticate:function(){dropboxService.clearAccessToken();dropboxService.authenticate({client_id:"ukk9z4f0nd1xa13",redirect_uri:"https://www.stef.be/bassoontracker/auth/dropbox.html"},{onComplete:function(a){console.log("ok!");
console.log(a)},onError:function(a){console.error("not OK!");console.log(a)}})},list:function(a,f){dropboxService("files/list_folder",{path:a},function(h){var e=[];h.entries.forEach(function(b){b[".tag"]&&"folder"===b[".tag"]?e.push({title:b.name,url:b.path_lower,children:[]}):e.push({title:b.name+" ("+(Math.floor(b.size/1E3)+"kb)")||"---",url:b.id,path:b.path_display})});f(e)})},get:function(a,f){d.list(a,f)},getFile:function(a,f){dropboxService("files/download",{path:a.url},function(h,e,b){console.log(h);
console.log(e);console.log(b);f(e)})},putFile:function(a,f,h){a={path:a};"overwrite"===SETTINGS.dropboxMode?a.mode="overwrite":(a.mode="add",a.autorename=!0);dropboxService("files/upload",a,f,{onComplete:function(e,b,c){console.log(e);console.log(b);console.log(c);h&&h(e)},onError:function(e,b,c){h&&h(!1)}})}};return d}();var BassoonProvider=function(){function d(h,e,b){if(b){var c=!1,m=e.lastIndexOf(".");0<=m&&(c=e.substr(m+1).toLowerCase()===b.toLowerCase());c||(e+="."+b)}console.log("Downloading "+h+" as "+e);UI.setStatus("Downloading ...");f=!1;setTimeout(function(){UI.setStatus("")},3E3);document.location.href="https://www.stef.be/bassoontracker/api/storage/"+h+"?dl=1&name="+e}var a={},f=!1;a.putFile=function(){Editor.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(h){Tracker.getFileName();
FetchService.sendBinary("https://www.stef.be/bassoontracker/api/storage/put/",h.buffer,function(e){console.error(e)})})};a.renderFile=function(h,e){if(f)console.error("already processing ...");else{f=!0;var b="https://www.stef.be/bassoontracker/api/storage/render/"+(Tracker.inFTMode()?"xm":"mod");h=h||Tracker.getFileName();UI.setStatus("saving file ...",!0);Logger.info("Rendering "+h);Editor.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(c){FetchService.sendBinary(b,c.buffer,
function(m){if("error"===m)console.error("error saving file"),UI.setStatus("error saving file"),f=!1;else{var g=m;console.log(g+": converting file ...");UI.setStatus("rendering file ...",!0);b="https://www.stef.be/bassoontracker/api/storage/convert/"+g;FetchService.sendBinary(b,c.buffer,function(k){"error"===k?(console.error("error converting file"),UI.setStatus("Error rendering file ..."),f=!1):(g=k,e?(console.log(g+": converting to mp3"),UI.setStatus("Converting file to mp3...",!0),b="https://www.stef.be/bassoontracker/api/storage/wavtomp3/"+
g,FetchService.sendBinary(b,c.buffer,function(l){console.error(l);"error"===l?(console.error("error converting file to mp3"),UI.setStatus("Error converting file to mp3..."),f=!1):d(l,h,"mp3")})):d(g,h,"wav"))})}})})}};a.proxyUrl=function(h){return"https://www.stef.be/bassoontracker/api/proxy?"+encodeURIComponent(h)};return a}();var FileDetector=function(){var d={},a={name:"PROTRACKER",isMod:!0,loader:function(){return ProTracker()}},f={name:"SOUNDTRACKER",isMod:!0,loader:function(){return SoundTracker()}},h={name:"FASTTRACKER",isMod:!0,loader:function(){return FastTracker()}},e={name:"SAMPLE",isSample:!0},b={name:"ZIP"};d.detect=function(c,m){var g=c.length,k="";k=c.readString(17,0);if("Extended Module: "==k)return h;1100<g&&(k=c.readString(4,1080));console.log("Format ID: "+k);if("M.K."==k||"M!K!"==k||"M&K!"==k||"FLT4"==
k||"2CHN"==k||"3CHN"==k||"5CHN"==k||"6CHN"==k||"7CHN"==k||"8CHN"==k||"9CHN"==k||"10CH"==k||"11CH"==k||"12CH"==k||"13CH"==k||"14CH"==k||"15CH"==k||"16CH"==k||"18CH"==k||"20CH"==k||"22CH"==k||"24CH"==k||"26CH"==k||"28CH"==k||"30CH"==k||"32CH"==k)return a;k="";m&&4<m.length&&(k=m.substr(m.length-4));k=k.toLowerCase();return".wav"==k||".mp3"==k||".iff"==k||"flac"==k||".ogg"==k||"opus"==k?e:".zip"==k||"PK"==c.readString(2,0)?b:m&&0<=m.indexOf(".")&&1624<g&&function(){console.log("Checking for old 15 instrument soundtracker format");
c.goto(0);for(var l=0;20>l;l++)if(!(128>c.readByte()))return!1;console.log("First 20 chars are ascii, checking Samples");for(var n=0,r=0,t=0;15>t;t++){for(l=0;22>l;l++)if(!(128>c.readByte()))return!1;c.jump(-22);"st-"==c.readString(22).toLowerCase().substr(0,3)&&(r+=10);if(20<r)return!0;n+=c.readWord();c.jump(6)}return 2*n+1624>g?!1:!0}()?f:e};return d}();var ProTracker=function(){return{load:function(d,a){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER,!0);Tracker.useLinearFrequency=!1;Tracker.clearInstruments(31);a={patterns:[],restartPosition:1};var f=4;a.typeId=d.readString(4,1080);a.title=d.readString(20,0);"2CHN"===a.typeId&&(f=2);"3CHN"===a.typeId&&(f=3);"5CHN"===a.typeId&&(f=5);"6CHN"===a.typeId&&(f=6);"7CHN"===a.typeId&&(f=7);"8CHN"===a.typeId&&(f=8);"9CHN"===a.typeId&&(f=9);"10CH"===a.typeId&&(f=10);"11CH"===a.typeId&&(f=11);"12CH"===a.typeId&&
(f=12);"13CH"===a.typeId&&(f=13);"14CH"===a.typeId&&(f=14);"15CH"===a.typeId&&(f=15);"16CH"===a.typeId&&(f=16);"18CH"===a.typeId&&(f=18);"20CH"===a.typeId&&(f=20);"22CH"===a.typeId&&(f=22);"24CH"===a.typeId&&(f=24);"26CH"===a.typeId&&(f=26);"28CH"===a.typeId&&(f=28);"30CH"===a.typeId&&(f=30);"32CH"===a.typeId&&(f=32);a.channels=f;var h=0;for(m=1;31>=m;++m){var e=d.readString(22),b=d.readWord(),c=Instrument();c.name=e;c.sample.length=c.sample.realLen=b<<1;e=d.readUbyte();16<e&&(e%=16);7<e&&(e-=16);
c.setFineTune(e);c.sample.volume=d.readUbyte();c.sample.loop.start=d.readWord()<<1;c.sample.loop.length=d.readWord()<<1;c.sample.loop.enabled=2<c.sample.loop.length;c.sample.loop.type=LOOPTYPE.FORWARD;c.pointer=h;h+=c.sample.length;c.setSampleIndex(0);Tracker.setInstrument(m,c)}a.instruments=Tracker.getInstruments();d.goto(950);a.length=d.readUbyte();d.jump(1);h=[];for(var m=c=0;128>m;++m)h[m]=d.readUbyte(),h[m]>c&&(c=h[m]);a.patternTable=h;d.goto(1084);for(m=0;m<=c;++m){h=[];for(e=0;64>e;e++){b=
[];var g;for(g=0;g<f;g++){var k=Note(),l=d.readUint();k.setPeriod(l>>16&4095);k.effect=l>>8&15;k.instrument=l>>24&240|l>>12&15;k.param=l&255;b.push(k)}for(g=f;g<Tracker.getTrackCount();g++)b.push(Note());h.push(b)}a.patterns.push(h)}f=[];for(m=1;31>=m;m++)if(c=Tracker.getInstrument(m)){console.log("Reading sample from 0x"+d.index+" with length of "+c.sample.length+" bytes and repeat length of "+c.sample.loop.length);h=c.sample.length;2<c.sample.loop.length&&SETTINGS.unrollShortLoops&&1E3>c.sample.loop.length&&
(h=Math.min(h,c.sample.loop.start+c.sample.loop.length),c.sample.length=h);for(j=0;j<h;j++)e=d.readByte(),2>j&&(e=0),c.sample.data.push(e/127);if((SETTINGS.unrollShortLoops||SETTINGS.unrollLoops)&&2<c.sample.loop.length){h=Math.ceil(4E4/c.sample.loop.length)+1;SETTINGS.unrollLoops||(h=0);e=!1;b=0;SETTINGS.unrollShortLoops&&1600>c.sample.loop.length&&(h=Math.floor(1E3/c.sample.loop.length),e=!0);for(g=0;g<h;g++){k=c.sample.loop.start;l=k+c.sample.loop.length;for(j=k;j<l;j++)c.sample.data.push(c.sample.data[j]);
b+=c.sample.loop.length}e&&b&&(c.sample.loop.length+=b,c.sample.length+=b)}f.push({label:m+" "+c.name,data:m})}EventBus.trigger(EVENT.instrumentListChange,f);return a},write:function(d){var a=Tracker.getSong(),f=Tracker.getInstruments(),h=Tracker.getTrackCount(),e=Tracker.getPatternLength(),b=0;for(g=0;128>g;g++){var c=a.patternTable[g]||0;b=Math.max(b,c)}var m=1084+256*(b+1)*h;32<Tracker.getInstruments().length&&UI.showDialog("WARNING !!!//This file has more than 31 instruments.//Only the first 31 instruments will be included.");
var g;for(g=1;31>=g;g++)if(c=f[g])c.setSampleIndex(0),m+=c.sample.length;g=new ArrayBuffer(m);m=new BinaryStream(g,!0);m.writeStringSection(a.title,20);for(g=1;31>=g;g++)(c=f[g])?(c.sample.length=Math.min(c.sample.length,131070),m.writeStringSection(c.name,22),m.writeWord(c.sample.length>>1),m.writeUByte(c.sample.finetune),m.writeUByte(c.sample.volume),m.writeWord(c.sample.loop.start>>1),m.writeWord(c.sample.loop.length>>1)):m.clear(30);m.writeUByte(a.length);m.writeUByte(127);for(g=0;128>g;g++)c=
a.patternTable[g]||0,m.writeUByte(c);m.writeString(8==h?"8CHN":"M.K.");for(g=0;g<=b;g++){c=a.patterns[g];for(var k=0;k<e;k++)for(var l=c[k],n=0;n<h;n++)if(l){var r=l[n],t=0,p=r.instrument;15<p&&(t=16,p=r.instrument-16);m.writeUint((t<<24)+(r.period<<16)+(p<<12)+(r.effect<<8)+r.param)}else m.writeUint(0)}for(g=1;31>=g;g++)if((c=f[g])&&c.sample.data&&c.sample.length){for(h=0;h<c.sample.length;h++)a=c.sample.data[h]||0,m.writeByte(Math.round(127*a));console.log("write instrument with "+c.sample.length+
" length")}d&&d(m)}}};var SoundTracker=function(){return{load:function(d,a){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER,!0);Tracker.useLinearFrequency=!1;Tracker.clearInstruments(15);a={patterns:[],restartPosition:1,typeId:"ST",channels:4};a.title=d.readString(20,0);var f=0;for(c=1;15>=c;++c){var h=d.readString(22),e=d.readWord(),b=Instrument();b.name=h;b.sample.length=b.realLen=e<<1;b.sample.volume=d.readWord();b.setFineTune(0);b.sample.loop.start=d.readWord();b.sample.loop.length=d.readWord()<<1;b.sample.loop.enabled=
2<b.sample.loop.length;b.sample.loop.type=LOOPTYPE.FORWARD;b.pointer=f;f+=b.sample.length;b.setSampleIndex(0);Tracker.setInstrument(c,b)}a.instruments=Tracker.getInstruments();d.goto(470);a.length=d.readUbyte();a.speed=d.readUbyte();f=[];for(var c=b=0;128>c;++c)f[c]=d.readUbyte(),f[c]>b&&(b=f[c]);a.patternTable=f;d.goto(600);for(c=0;c<=b;++c){f=[];for(h=0;64>h;h++){e=[];var m;for(m=0;4>m;m++){var g={},k=d.readUint();g.period=k>>16&4095;g.effect=k>>8&15;g.instrument=k>>24&240|k>>12&15;g.param=k&255;
e.push(g)}for(m=4;m<Tracker.getTrackCount();m++)e.push({note:0,effect:0,instrument:0,param:0});f.push(e)}a.patterns.push(f)}f=[];for(c=1;15>=c;c++)if(b=Tracker.getInstrument(c)){console.log("Reading sample from 0x"+d.index+" with length of "+b.sample.length+" bytes and repeat length of "+b.sample.loop.length);h=b.sample.length;for(j=0;j<h;j++)e=d.readByte(),2>j&&(e=0),b.sample.data.push(e/127);f.push({label:c+" "+b.name,data:c})}EventBus.trigger(EVENT.instrumentListChange,f);return a}}};var FastTracker=function(){var d={load:function(a,f){console.log("loading FastTracker");Tracker.setTrackerMode(TRACKERMODE.FASTTRACKER,!0);Tracker.clearInstruments(1);var h={patterns:[],instruments:[]};a.litteEndian=!0;a.goto(17);h.title=a.readString(20);a.jump(1);var e=a.readString(20);var b=a.readByte();b=a.readByte()+"."+b;var c=a.readDWord();var m=a.readWord();var g=a.readWord();var k=a.readWord();var l=a.readWord();f=a.readWord();var n=a.readWord();Tracker.useLinearFrequency=1===n%2?!0:!1;n=
a.readWord();var r=a.readWord();console.log("File was made in "+e+" version "+b);b=[];var t=0;for(e=0;e<m;++e)b[e]=a.readUbyte(),t<b[e]&&(t=b[e]);h.patternTable=b;h.length=m;h.channels=k;h.restartPosition=g+1;c=60+c;a.goto(c);for(e=0;e<l;e++){m=[];t=a.readDWord();a.readUbyte();g=a.readWord();b=a.readWord();c+=t;a.goto(c);for(t=0;t<g;t++){var p=[],z;for(z=0;z<k;z++){var y=Note(),B=a.readUbyte();B&128?(B&1&&y.setIndex(a.readUbyte()),B&2&&(y.instrument=a.readUbyte()),B&4&&(y.volumeEffect=a.readUbyte()),
B&8&&(y.effect=a.readUbyte()),B&16&&(y.param=a.readUbyte())):(y.setIndex(B),y.instrument=a.readUbyte(),y.volumeEffect=a.readUbyte(),y.effect=a.readUbyte(),y.param=a.readUbyte());p.push(y)}m.push(p)}c+=b;a.goto(c);h.patterns.push(m)}k=[];for(e=1;e<=f;++e){l=Instrument();try{if(l.filePosition=a.index,l.headerSize=a.readDWord(),l.name=a.readString(22),l.type=a.readUbyte(),l.numberOfSamples=a.readWord(),l.samples=[],l.sampleHeaderSize=0,0<l.numberOfSamples){l.sampleHeaderSize=a.readDWord();l.sampleHeaderSize=
Math.max(l.sampleHeaderSize,40);200<l.sampleHeaderSize&&(l.sampleHeaderSize=40);for(var A=0;96>A;A++)l.sampleNumberForNotes.push(a.readUbyte());for(A=0;24>A;A++)l.volumeEnvelope.raw.push(a.readWord());for(A=0;24>A;A++)l.panningEnvelope.raw.push(a.readWord());l.volumeEnvelope.count=a.readUbyte();l.panningEnvelope.count=a.readUbyte();l.volumeEnvelope.sustainPoint=a.readUbyte();l.volumeEnvelope.loopStartPoint=a.readUbyte();l.volumeEnvelope.loopEndPoint=a.readUbyte();l.panningEnvelope.sustainPoint=a.readUbyte();
l.panningEnvelope.loopStartPoint=a.readUbyte();l.panningEnvelope.loopEndPoint=a.readUbyte();l.volumeEnvelope.type=a.readUbyte();l.panningEnvelope.type=a.readUbyte();l.vibrato.type=a.readUbyte();l.vibrato.sweep=a.readUbyte();l.vibrato.depth=Math.min(a.readUbyte(),15);l.vibrato.rate=a.readUbyte();l.fadeout=a.readWord();l.reserved=a.readWord();function E(U){U.points=[];for(A=0;12>A;A++)U.points.push(U.raw.slice(2*A,2*A+2));U.type&1&&(U.enabled=!0);U.type&2&&(U.sustain=!0);U.type&4&&(U.loop=!0);return U}
l.volumeEnvelope=E(l.volumeEnvelope);l.panningEnvelope=E(l.panningEnvelope)}}catch(E){console.error("error",E)}c+=l.headerSize;a.goto(c);if(0===l.numberOfSamples)m=Sample(),l.samples.push(m);else{if(a.isEOF(1)){console.error("seek past EOF");console.error(l);break}for(g=0;g<l.numberOfSamples;g++)m=Sample(),m.length=a.readDWord(),m.loop.start=a.readDWord(),m.loop.length=a.readDWord(),m.volume=a.readUbyte(),m.finetuneX=a.readByte(),m.type=a.readUbyte(),m.panning=a.readUbyte()-128,m.relativeNote=a.readByte(),
m.reserved=a.readByte(),m.name=a.readString(22),m.bits=8,l.samples.push(m),c+=l.sampleHeaderSize,a.goto(c);for(g=0;g<l.numberOfSamples;g++)if(m=l.samples[g],m.length){c+=m.length;m.type&16&&(m.bits=16,m.type^=16,m.length>>=1,m.loop.start>>=1,m.loop.length>>=1);m.loop.type=m.type||0;m.loop.enabled=!!m.loop.type;console.log("Reading sample from 0x"+a.index+" with length of "+m.length+(16===m.bits?" words":" bytes")+" and repeat length of "+m.loop.length);b=m.length;t=0;if(16===m.bits)for(p=0;p<b;p++)z=
a.readShort()+t,-32768>z?z+=65536:32767<z&&(z-=65536),t=z,m.data.push(z/32768);else for(p=0;p<b;p++)z=a.readByte()+t,-128>z?z+=256:127<z&&(z-=256),t=z,m.data.push(z/127);m.loop.type===LOOPTYPE.PINGPONG&&(b=m.data.slice(m.loop.start,m.loop.start+m.loop.length),m.data=m.data.slice(0,m.loop.start+m.loop.length),m.data=m.data.concat(b.reverse()),m.loop.length*=2,m.length=m.loop.start+m.loop.length);a.goto(c)}}l.setSampleIndex(0);Tracker.setInstrument(e,l);k.push({label:e+" "+l.name,data:e})}EventBus.trigger(EVENT.instrumentListChange,
k);h.instruments=Tracker.getInstruments();Tracker.setBPM(r);Tracker.setAmigaSpeed(n);d.validate(h);return h},write:function(a){var f=Tracker.getSong(),h=Tracker.getInstruments(),e=Tracker.getTrackCount(),b="undefined"===typeof versionNumber?"dev":versionNumber,c=0;for(k=0;128>k;k++)c=Math.max(c,f.patternTable[k]||0);var m=336;for(k=0;k<=c;k++)f.patterns[k]&&(m+=9+f.patterns[k].length*e*5);for(k=1;k<h.length;k++){var g=h[k];g&&g.hasSamples()?g.samples.forEach(function(z){var y=z.length;16===z.bits&&
(y*=2);m+=283+y}):m+=29}var k;k=new ArrayBuffer(m);var l=new BinaryStream(k,!1);l.writeStringSection("Extended Module: ",17);l.writeStringSection(f.title,20);l.writeByte(26);l.writeStringSection("BassoonTracker "+b,20);l.writeByte(4);l.writeByte(1);l.writeDWord(276);l.writeWord(f.length);l.writeWord(0);l.writeWord(Tracker.getTrackCount());l.writeWord(c+1);l.writeWord(h.length-1);l.writeWord(Tracker.useLinearFrequency?1:0);l.writeWord(Tracker.getAmigaSpeed());l.writeWord(Tracker.getBPM());for(k=0;256>
k;k++)l.writeUByte(f.patternTable[k]||0);for(k=0;k<=c;k++){g=f.patterns[k];var n=b=0;g&&(b=g.length,n=b*e*5);l.writeDWord(9);l.writeUByte(0);l.writeWord(b);l.writeWord(n);if(g)for(n=0,b=g.length;n<b;n++)for(var r=g[n],t=0;t<e;t++){var p=r[t]||{};l.writeUByte(p.index||0);l.writeUByte(p.instrument||0);l.writeUByte(p.volumeEffect||0);l.writeUByte(p.effect||0);l.writeUByte(p.param||0)}}for(k=1;k<h.length;k++)if((g=h[k])&&g.hasSamples()){g.numberOfSamples=g.samples.length;l.writeDWord(243);l.writeStringSection(g.name,
22);l.writeUByte(0);l.writeWord(g.numberOfSamples);b=(g.volumeEnvelope.enabled?1:0)+(g.volumeEnvelope.sustain?2:0)+(g.volumeEnvelope.loop?4:0);f=(g.panningEnvelope.enabled?1:0)+(g.panningEnvelope.sustain?2:0)+(g.panningEnvelope.loop?4:0);l.writeDWord(40);for(c=0;96>c;c++)l.writeUByte(g.sampleNumberForNotes[c]||0);for(c=0;12>c;c++)e=g.volumeEnvelope.points[c]||[0,0],l.writeWord(e[0]),l.writeWord(e[1]);for(c=0;12>c;c++)e=g.panningEnvelope.points[c]||[0,0],l.writeWord(e[0]),l.writeWord(e[1]);l.writeUByte(g.volumeEnvelope.count||
0);l.writeUByte(g.panningEnvelope.count||0);l.writeUByte(g.volumeEnvelope.sustainPoint||0);l.writeUByte(g.volumeEnvelope.loopStartPoint||0);l.writeUByte(g.volumeEnvelope.loopEndPoint||0);l.writeUByte(g.panningEnvelope.sustainPoint||0);l.writeUByte(g.panningEnvelope.loopStartPoint||0);l.writeUByte(g.panningEnvelope.loopEndPoint||0);l.writeUByte(b);l.writeUByte(f);l.writeUByte(g.vibrato.type||0);l.writeUByte(g.vibrato.sweep||0);l.writeUByte(g.vibrato.depth||0);l.writeUByte(g.vibrato.rate||0);l.writeWord(g.fadeout||
0);l.writeWord(0);for(f=0;f<g.numberOfSamples;f++)e=g.samples[f],b=0,2<e.loop.length&&e.loop.enabled&&(b=1),c=e.length,n=e.loop.start,r=e.loop.length,16===e.bits&&(b+=16,c*=2,n*=2,r*=2),l.writeDWord(c),l.writeDWord(n),l.writeDWord(r),l.writeUByte(e.volume),l.writeByte(e.finetuneX),l.writeUByte(b),l.writeUByte((e.panning||0)+128),l.writeUByte(e.relativeNote||0),l.writeUByte(0),l.writeStringSection(e.name||"",22);for(f=0;f<g.numberOfSamples;f++)if(e=g.samples[f],t=r=0,16===e.bits)for(c=0,b=e.length;c<
b;c++)n=Math.round(32768*e.data[c]),r=n-t,t=n,-32768>r?r+=65536:32767<r&&(r-=65536),l.writeWord(r);else for(c=0,b=e.length;c<b;c++)n=Math.round(127*e.data[c]),r=n-t,t=n,-128>r?r+=256:127<r&&(r-=256),l.writeByte(r)}else l.writeDWord(29),l.writeStringSection(g?g.name:"",22),l.writeUByte(0),l.writeWord(0);a&&a(l)},validate:function(a){function f(h,e){var b=!0;if(h.points&&h.points[0])if(0===h.points[0][0])for(var c=0,m=1;m<h.count;m++){var g=h.points[m];g&&g[0]>c?c=g[0]:b=!1}else b=!1;else b=!1;if(b)return h;
console.warn("Invalid envelope, resetting to default");return"volume"===e?{raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6}:{raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5}}a.instruments.forEach(function(h){h.volumeEnvelope=f(h.volumeEnvelope,"volume");h.panningEnvelope=f(h.panningEnvelope,"panning");for(var e=h.samples.length-1,b=0,c=h.sampleNumberForNotes.length;b<c;b++)h.sampleNumberForNotes[b]=Math.min(h.sampleNumberForNotes[b],e)})}};
return d};(function(d){function a(){this.crc=-1}function f(){}function h(G,F,J){if(0>F||0>J||F+J>G.size)throw new RangeError("offset:"+F+", length:"+J+", size:"+G.size);if(G.slice)return G.slice(F,F+J);if(G.webkitSlice)return G.webkitSlice(F,F+J);if(G.mozSlice)return G.mozSlice(F,F+J);if(G.msSlice)return G.msSlice(F,F+J)}function e(G,F){G=new ArrayBuffer(G);var J=new Uint8Array(G);F&&J.set(F,0);return{buffer:G,array:J,view:new DataView(G)}}function b(){}function c(G){var F=this,J;F.size=0;F.init=function(V,
O){var I=new Blob([G],{type:"text/plain"});J=new g(I);J.init(function(){F.size=J.size;V()},O)};F.readUint8Array=function(V,O,I,q){J.readUint8Array(V,O,I,q)}}function m(G){var F=this,J;F.size=0;F.init=function(V){for(var O=G.length;"="==G.charAt(O-1);)O--;J=G.indexOf(",")+1;F.size=Math.floor(.75*(O-J));V()};F.readUint8Array=function(V,O,I){var q=e(O),v=4*Math.floor(V/3),K=d.atob(G.substring(v+J,4*Math.ceil((V+O)/3)+J));for(V=v=V-3*Math.floor(v/4);V<v+O;V++)q.array[V-v]=K.charCodeAt(V);I(q.array)}}
function g(G){var F=this;F.size=0;F.init=function(J){F.size=G.size;J()};F.readUint8Array=function(J,V,O,I){var q=new FileReader;q.onload=function(v){O(new Uint8Array(v.target.result))};q.onerror=I;try{q.readAsArrayBuffer(h(G,J,V))}catch(v){I(v)}}}function k(G){var F=this;F.size=0;F.init=function(J,V){F.size=G.byteLength;J()};F.readUint8Array=function(J,V,O,I){O(new Uint8Array(G.slice(J,J+V)))}}function l(){}function n(G){var F;this.init=function(J){F=new Blob([],{type:"text/plain"});J()};this.writeUint8Array=
function(J,V){F=new Blob([F,S?J:J.buffer],{type:"text/plain"});V()};this.getData=function(J,V){var O=new FileReader;O.onload=function(I){J(I.target.result)};O.onerror=V;O.readAsText(F,G)}}function r(G){var F="",J="";this.init=function(V){F+="data:"+(G||"")+";base64,";V()};this.writeUint8Array=function(V,O){var I,q=J.length,v=J;J="";for(I=0;I<3*Math.floor((q+V.length)/3)-q;I++)v+=String.fromCharCode(V[I]);for(;I<V.length;I++)J+=String.fromCharCode(V[I]);2<v.length?F+=d.btoa(v):J=v;O()};this.getData=
function(V){V(F+d.btoa(J))}}function t(G){var F;this.init=function(J){F=new Blob([],{type:G});J()};this.writeUint8Array=function(J,V){F=new Blob([F,S?J:J.buffer],{type:G});V()};this.getData=function(J){J(F)}}function p(){var G;this.init=function(F,J){G=new Uint8Array;F()};this.writeUint8Array=function(F,J,V){V=new Uint8Array(G.length+F.length);V.set(G);V.set(F,G.length);G=V;J()};this.getData=function(F){F(G.buffer)}}function z(G,F,J,V,O,I,q,v,K,X){function C(){G.removeEventListener("message",L,!1);
v(aa,M)}function L(P){P=P.data;var ca=P.data,ba=P.error;if(ba)ba.toString=function(){return"Error: "+this.message},K(ba);else if(P.sn===T)switch("number"===typeof P.codecTime&&(G.codecTime+=P.codecTime),"number"===typeof P.crcTime&&(G.crcTime+=P.crcTime),P.type){case "append":ca?(aa+=ca.length,V.writeUint8Array(ca,function(){x()},X)):x();break;case "flush":M=P.crc;ca?(aa+=ca.length,V.writeUint8Array(ca,function(){C()},X)):C();break;case "progress":q&&q(Z+P.loaded,I);break;case "importScripts":case "newTask":case "echo":break;
default:console.warn("zip.js:launchWorkerProcess: unknown message: ",P)}}function x(){Z=524288*H;Z<=I?J.readUint8Array(O+Z,Math.min(524288,I-Z),function(P){q&&q(Z,I);var ca=0===Z?F:{sn:T};ca.type="append";ca.data=P;try{G.postMessage(ca,[P.buffer])}catch(ba){G.postMessage(ca)}H++},K):G.postMessage({sn:T,type:"flush"})}var H=0,Z,T=F.sn,M;var aa=0;G.addEventListener("message",L,!1);x()}function y(G,F,J,V,O,I,q,v,K,X){function C(){x=524288*L;if(x<O)F.readUint8Array(V+x,Math.min(524288,O-x),function(P){try{var ca=
G.append(P,function(ba){q&&q(x+ba,O)})}catch(ba){K(ba);return}ca?(H+=ca.length,J.writeUint8Array(ca,function(){L++;setTimeout(C,1)},X),T&&M.append(ca)):(L++,setTimeout(C,1));Z&&M.append(P);q&&q(x,O)},K);else{try{var aa=G.flush()}catch(P){K(P);return}aa?(T&&M.append(aa),H+=aa.length,J.writeUint8Array(aa,function(){v(H,M.get())},X)):v(H,M.get())}}var L=0,x,H=0,Z="input"===I,T="output"===I,M=new a;C()}function B(G,F,J,V,O,I,q,v,K,X,C){d.zip.useWebWorkers&&q?z(G,{sn:F,codecClass:"NOOP",crcType:"input"},
J,V,O,I,K,v,X,C):y(new f,J,V,O,I,"input",K,v,X,C)}function A(G){var F,J="",V="\u00c7\u00fc\u00e9\u00e2\u00e4\u00e0\u00e5\u00e7\u00ea\u00eb\u00e8\u00ef\u00ee\u00ec\u00c4\u00c5\u00c9\u00e6\u00c6\u00f4\u00f6\u00f2\u00fb\u00f9\u00ff\u00d6\u00dc\u00f8\u00a3\u00d8\u00d7\u0192\u00e1\u00ed\u00f3\u00fa\u00f1\u00d1\u00aa\u00ba\u00bf\u00ae\u00ac\u00bd\u00bc\u00a1\u00ab\u00bb___\u00a6\u00a6\u00c1\u00c2\u00c0\u00a9\u00a6\u00a6++\u00a2\u00a5++--+-+\u00e3\u00c3++--\u00a6-+\u00a4\u00f0\u00d0\u00ca\u00cb\u00c8i\u00cd\u00ce\u00cf++__\u00a6\u00cc_\u00d3\u00df\u00d4\u00d2\u00f5\u00d5\u00b5\u00fe\u00de\u00da\u00db\u00d9\u00fd\u00dd\u00af\u00b4\u00ad\u00b1_\u00be\u00b6\u00a7\u00f7\u00b8\u00b0\u00a8\u00b7\u00b9\u00b3\u00b2_ ".split("");
for(F=0;F<G.length;F++){var O=G.charCodeAt(F)&255;J=127<O?J+V[O-128]:J+String.fromCharCode(O)}return J}function E(G){var F,J="";for(F=0;F<G.length;F++)J+=String.fromCharCode(G[F]);return J}function U(G,F,J,V,O){G.version=F.view.getUint16(J,!0);G.bitFlag=F.view.getUint16(J+2,!0);G.compressionMethod=F.view.getUint16(J+4,!0);G.lastModDateRaw=F.view.getUint32(J+6,!0);a:{var I=G.lastModDateRaw,q=(I&4294901760)>>16;I&=65535;try{var v=new Date(1980+((q&65024)>>9),((q&480)>>5)-1,q&31,(I&63488)>>11,(I&2016)>>
5,2*(I&31),0);break a}catch(K){}v=void 0}G.lastModDate=v;if(1===(G.bitFlag&1))O("File contains encrypted entry.");else{if(V||8!=(G.bitFlag&8))G.crc32=F.view.getUint32(J+10,!0),G.compressedSize=F.view.getUint32(J+14,!0),G.uncompressedSize=F.view.getUint32(J+18,!0);4294967295===G.compressedSize||4294967295===G.uncompressedSize?O("File is using Zip64 (4gb+ file size)."):(G.filenameLength=F.view.getUint16(J+22,!0),G.extraFieldLength=F.view.getUint16(J+24,!0))}}function Q(G,F,J){function V(){}function O(v){function K(X,
C){G.readUint8Array(G.size-X,X,function(L){for(var x=L.length-22;0<=x;x--)if(80===L[x]&&75===L[x+1]&&5===L[x+2]&&6===L[x+3]){v(new DataView(L.buffer,x,22));return}C()},function(){J("Error while reading zip file.")})}22>G.size?J("File format is not recognized."):K(22,function(){K(Math.min(65558,G.size),function(){J("File format is not recognized.")})})}var I=0;V.prototype.getData=function(v,K,X,C){function L(M){var aa=e(4);aa.view.setUint32(0,M);return T.crc32==aa.view.getUint32(0)}function x(M,aa){C&&
!L(aa)?J("CRC failed."):v.getData(function(P){K(P)})}function H(M){J(M||"Error while reading file data.")}function Z(M){J(M||"Error while writing file data.")}var T=this;G.readUint8Array(T.offset,30,function(M){M=e(M.length,M);if(1347093252!=M.view.getUint32(0))J("File format is not recognized.");else{U(T,M,4,!1,J);var aa=T.offset+30+T.filenameLength+T.extraFieldLength;v.init(function(){if(0===T.compressionMethod)B(T._worker,I++,G,v,aa,T.compressedSize,C,x,X,H,Z);else{var P=I++,ca=T.compressedSize,
ba=C?"output":"none";d.zip.useWebWorkers?z(T._worker,{sn:P,codecClass:"Inflater",crcType:ba},G,v,aa,ca,X,x,H,Z):y(new d.zip.Inflater,G,v,aa,ca,ba,X,x,H,Z)}},Z)}},H)};var q={getEntries:function(v){var K=this._worker;O(function(X){var C=X.getUint32(16,!0);var L=X.getUint16(8,!0);0>C||C>=G.size?J("File format is not recognized."):G.readUint8Array(C,G.size-C,function(x){var H=0,Z=[],T=e(x.length,x);for(x=0;x<L;x++){var M=new V;M._worker=K;if(1347092738!=T.view.getUint32(H)){J("File format is not recognized.");
return}U(M,T,H+6,!0,J);M.commentLength=T.view.getUint16(H+32,!0);M.directory=16==(T.view.getUint8(H+38)&16);M.offset=T.view.getUint32(H+42,!0);var aa=E(T.array.subarray(H+46,H+46+M.filenameLength));M.filename=2048===(M.bitFlag&2048)?decodeURIComponent(escape(aa)):A(aa);M.directory||"/"!=M.filename.charAt(M.filename.length-1)||(M.directory=!0);aa=E(T.array.subarray(H+46+M.filenameLength+M.extraFieldLength,H+46+M.filenameLength+M.extraFieldLength+M.commentLength));M.comment=2048===(M.bitFlag&2048)?
decodeURIComponent(escape(aa)):A(aa);Z.push(M);H+=46+M.filenameLength+M.extraFieldLength+M.commentLength}v(Z)},function(){J("Error while reading zip file.")})})},close:function(v){this._worker&&(this._worker.terminate(),this._worker=null);v&&v()},_worker:null};d.zip.useWebWorkers?N("inflater",function(v){q._worker=v;F(q)},function(v){J(v)}):F(q)}function u(G){var F,J=[];for(F=0;F<G.length;F++)J.push(G.charCodeAt(F));return J}function w(G,F,J,V){function O(L){J(L||"Error while writing zip file.")}
function I(L){J(L||"Error while reading file data.")}var q={},v=[],K=0,X=0,C={add:function(L,x,H,Z,T){function M(ia){da=T.lastModDate||new Date;ca=e(26);q[L]={headerArray:ca.array,directory:T.directory,filename:ba,offset:K,comment:u(unescape(encodeURIComponent(T.comment||"")))};ca.view.setUint32(0,335546376);T.version&&ca.view.setUint8(0,T.version);V||0===T.level||T.directory||ca.view.setUint16(4,2048);ca.view.setUint16(6,(da.getHours()<<6|da.getMinutes())<<5|da.getSeconds()/2,!0);ca.view.setUint16(8,
(da.getFullYear()-1980<<4|da.getMonth()+1)<<5|da.getDate(),!0);ca.view.setUint16(22,ba.length,!0);var la=e(30+ba.length);la.view.setUint32(0,1347093252);la.array.set(ca.array,4);la.array.set(ba,30);K+=la.array.length;G.writeUint8Array(la.array,ia,O)}function aa(ia,la){var qa=e(16);K+=ia||0;qa.view.setUint32(0,1347094280);"undefined"!=typeof la&&(ca.view.setUint32(10,la,!0),qa.view.setUint32(4,la,!0));x&&(qa.view.setUint32(8,ia,!0),ca.view.setUint32(14,ia,!0),qa.view.setUint32(12,x.size,!0),ca.view.setUint32(18,
x.size,!0));G.writeUint8Array(qa.array,function(){K+=16;H()},O)}function P(){T=T||{};L=L.trim();T.directory&&"/"!=L.charAt(L.length-1)&&(L+="/");q.hasOwnProperty(L)?J("File already exists."):(ba=u(unescape(encodeURIComponent(L))),v.push(L),M(function(){if(x)if(V||0===T.level)B(oa,X++,x,G,0,x.size,!0,aa,Z,I,O);else{var ia=X++;d.zip.useWebWorkers?z(oa,{sn:ia,options:{level:T.level},codecClass:"Deflater",crcType:"input"},x,G,0,x.size,Z,aa,I,O):y(new d.zip.Deflater,x,G,0,x.size,"input",Z,aa,I,O)}else aa()},
O))}var ca,ba,da,oa=this._worker;x?x.init(P,I):P()},close:function(L){this._worker&&(this._worker.terminate(),this._worker=null);var x=0,H=0,Z;for(Z=0;Z<v.length;Z++){var T=q[v[Z]];x+=46+T.filename.length+T.comment.length}var M=e(x+22);for(Z=0;Z<v.length;Z++)T=q[v[Z]],M.view.setUint32(H,1347092738),M.view.setUint16(H+4,5120),M.array.set(T.headerArray,H+6),M.view.setUint16(H+32,T.comment.length,!0),T.directory&&M.view.setUint8(H+38,16),M.view.setUint32(H+42,T.offset,!0),M.array.set(T.filename,H+46),
M.array.set(T.comment,H+46+T.filename.length),H+=46+T.filename.length+T.comment.length;M.view.setUint32(H,1347093766);M.view.setUint16(H+8,v.length,!0);M.view.setUint16(H+10,v.length,!0);M.view.setUint32(H+12,x,!0);M.view.setUint32(H+16,K,!0);G.writeUint8Array(M.array,function(){G.getData(L)},O)},_worker:null};d.zip.useWebWorkers?N("deflater",function(L){C._worker=L;F(C)},function(L){J(L)}):F(C)}function D(G){var F=document.createElement("a");return G.map(function(J){F.href=J;return F.href})}function N(G,
F,J){function V(v){v=v.data;v.error?(q.terminate(),J(v.error)):"importScripts"===v.type&&(q.removeEventListener("message",V),q.removeEventListener("error",O),F(q))}function O(v){q.terminate();J(v)}if(null!==d.zip.workerScripts&&null!==d.zip.workerScriptsPath)J(Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));else{if(d.zip.workerScripts){var I=d.zip.workerScripts[G];if(!Array.isArray(I)){J(Error("zip.workerScripts."+G+" is not an array!"));return}I=D(I)}else I=W[G].slice(0),
I[0]=(d.zip.workerScriptsPath||"")+I[0];var q=new Worker(I[0]);q.codecTime=q.crcTime=0;q.postMessage({type:"importScripts",scripts:I.slice(1)});q.addEventListener("message",V);q.addEventListener("error",O)}}function R(G){console.error(G)}try{var S=0===(new Blob([new DataView(new ArrayBuffer(0))])).size}catch(G){}a.prototype.append=function(G){for(var F=this.crc|0,J=this.table,V=0,O=G.length|0;V<O;V++)F=F>>>8^J[(F^G[V])&255];this.crc=F};a.prototype.get=function(){return~this.crc};a.prototype.table=
function(){var G,F,J=[];for(G=0;256>G;G++){var V=G;for(F=0;8>F;F++)V=V&1?V>>>1^3988292384:V>>>1;J[G]=V}return J}();f.prototype.append=function(G,F){return G};f.prototype.flush=function(){};c.prototype=new b;c.prototype.constructor=c;m.prototype=new b;m.prototype.constructor=m;g.prototype=new b;g.prototype.constructor=g;k.prototype=new b;k.prototype.constructor=k;l.prototype.getData=function(G){G(this.data)};n.prototype=new l;n.prototype.constructor=n;r.prototype=new l;r.prototype.constructor=r;t.prototype=
new l;t.prototype.constructor=t;p.prototype=new l;p.prototype.constructor=p;var W={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};d.zip={Reader:b,Writer:l,BlobReader:g,ArrayBufferReader:k,Data64URIReader:m,TextReader:c,BlobWriter:t,ArrayBufferWriter:p,Data64URIWriter:r,TextWriter:n,createReader:function(G,F,J){J=J||R;G.init(function(){Q(G,F,J)},J)},createWriter:function(G,F,J,V){J=J||R;V=!!V;G.init(function(){w(G,F,J,V)},J)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}})(this);var Plugin=function(){var d={},a={Nibbles:["script/plugins/games/nibbles/nibbles.js","script/plugins/games/nibbles/logo.png","script/plugins/games/nibbles/levels.png","script/plugins/games/nibbles/player1.png"],Generator:["script/plugins/apps/generator/generator.js","script/plugins/apps/generator/sin.png","script/plugins/apps/generator/logo.png"]},f={};d.register=function(h){console.log("register");console.log(h);f[h.name]=h};d.load=function(h,e){var b=h.name||h;if("object"===typeof window[b])console.log("Plugin "+
b+" already loaded"),e&&e();else if("string"===typeof h&&(h={name:h,src:a[h]}),b=f[h.name])b.loading?console.warn("Plugin already being loaded"):(console.log("Plugin already loaded"),e&&e());else{var c=function(l){l&&"load"===l.type||console.error("Error loading resource",l);k++;if(k>=g){h.loaded=!0;console.log("loaded",h);if(h.onLoad)h.onLoad();e&&e()}},m=function(l){Y.loadImage(Host.getRemoteUrl()+l,function(n){var r=l.split("/").pop().split(".")[0];Y.sprites[h.name+"."+r]=Y.sprite({img:n,width:n.width,
height:n.height});c({type:"load"})})};if(h.src){console.log("loading Plugin "+h.name+" with "+h.src.length+" source files");h.loading=!0;var g=h.src.length;var k=0;h.src.forEach(function(l){switch(l.split(".").pop().toLowerCase()){case "js":var n=document.createElement("script");n.type="application/javascript";n.src=Host.getRemoteUrl()+l;n.addEventListener("error",c,!1);n.addEventListener("load",c,!1);document.getElementsByTagName("head")[0].appendChild(n);break;case "png":m(l);break;default:console.warn("Warning, unknown loader for "+
l),c(l)}})}else console.warn("Can't load plugin "+h.name+": no source files"),e&&e()}};return d}();
